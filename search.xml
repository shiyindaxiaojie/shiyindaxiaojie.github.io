<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Log4j2 异常堆栈存储优化</title>
      <link href="/2025/03/15/log4j2/Log4j2%20%E5%BC%82%E5%B8%B8%E5%A0%86%E6%A0%88%E5%AD%98%E5%82%A8%E4%BC%98%E5%8C%96/"/>
      <url>/2025/03/15/log4j2/Log4j2%20%E5%BC%82%E5%B8%B8%E5%A0%86%E6%A0%88%E5%AD%98%E5%82%A8%E4%BC%98%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>在微服务架构中，日志的完整性和可读性是排查问题的关键。传统日志框架（如Log4j2）默认会输出异常的全部堆栈信息，但在高并发或复杂调用链路场景下，这会导致以下问题：</p><ol><li>日志冗余：一次请求产生的完整堆栈可能包含数百行，增加存储和分析成本；</li><li>信息过载：开发人员需手动筛选关键堆栈节点，一般只关注最底部的 <code>Cause By</code>，影响排查效率；</li><li>线程安全：异步线程池中，堆栈信息可能因线程复用而断裂。</li></ol><p>因此，需要一个 log4j2 插件来解决这些问题。</p><h1>目标</h1><p>设计一个轻量级插件，实现异常堆栈倒排，压缩日志内容，零侵入配置。</p><h1>实现</h1><p>使用 Log4j2 插件提供的扩展点 <code>LogEventPatternConverter</code> 进行实现。</p><h2 id="倒排堆栈">倒排堆栈</h2><p>在 <code>LogEventPatternConverter</code> 提供的 <code>format</code> 方法扩展格式化日志输出。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">format</span><span class="params">(LogEvent event, StringBuilder output)</span> &#123;</span><br><span class="line">  <span class="type">Throwable</span> <span class="variable">throwable</span> <span class="operator">=</span> event.getThrown();</span><br><span class="line">  <span class="keyword">if</span> (throwable != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">ForwardCounter</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForwardCounter</span>();</span><br><span class="line">    output.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    recursiveReversePrint(throwable, output, counter); <span class="comment">// 倒排</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">recursiveReversePrint</span><span class="params">(Throwable throwable, StringBuilder output,</span></span><br><span class="line"><span class="params">                    ForwardCounter counter)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (throwable == <span class="literal">null</span> || counter.value &gt;= causeDepth) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (throwable.getCause() != <span class="literal">null</span>) &#123;</span><br><span class="line">    recursiveReversePrint(throwable.getCause(), output, counter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (counter.value++ &lt; causeDepth) &#123;</span><br><span class="line">    printSingleStack(throwable, output);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printSingleStack</span><span class="params">(Throwable throwable, StringBuilder output)</span> &#123;</span><br><span class="line">  output.append(reduceClassName(throwable.getClass().getName()))</span><br><span class="line">    .append(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">    .append(throwable.getMessage())</span><br><span class="line">    .append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  StackTraceElement[] stack = throwable.getStackTrace();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; Math.min(stackDepth, stack.length); i++) &#123;</span><br><span class="line">    output.append(<span class="string">&quot;\tat &quot;</span>)</span><br><span class="line">      .append(formatStackElement(stack[i])) <span class="comment">// 压缩堆栈信息，下文会提及到</span></span><br><span class="line">      .append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stack.length &gt; stackDepth) &#123;</span><br><span class="line">    output.append(<span class="string">&quot;\t... &quot;</span>).append(stack.length - stackDepth)</span><br><span class="line">      .append(<span class="string">&quot; more\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="压缩内容">压缩内容</h2><p>将 package 进行压缩，截取首字母，例如 <code>org.ylzl.framework.extension</code> 压缩为 <code>o.y.f.e</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">formatStackElement</span><span class="params">(StackTraceElement element)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> reduceClassName(element.getClassName()) +</span><br><span class="line">    <span class="string">&quot;#&quot;</span> + element.getMethodName() +</span><br><span class="line">    <span class="string">&quot;:&quot;</span> + element.getLineNumber();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">reduceClassName</span><span class="params">(String className)</span> &#123;</span><br><span class="line">  String[] parts = className.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line">  <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parts.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">    sb.append(parts[i].charAt(<span class="number">0</span>)).append(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sb.append(parts[parts.length - <span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完整的代码如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Plugin(name = &quot;StackTraceConverter&quot;, category = PatternConverter.CATEGORY)</span></span><br><span class="line"><span class="meta">@ConverterKeys(&#123;&quot;st&quot;, &quot;stacktrace&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StackTraceConverter</span> <span class="keyword">extends</span> <span class="title class_">LogEventPatternConverter</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CAUSE_DEPTH</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_STACK_DEPTH</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Cause by 深度 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> causeDepth;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 堆栈深度 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> stackDepth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">StackTraceConverter</span><span class="params">(<span class="type">int</span> causeDepth, <span class="type">int</span> stackDepth)</span> &#123;</span><br><span class="line"><span class="built_in">super</span>(<span class="string">&quot;StackTrace&quot;</span>, <span class="string">&quot;stacktrace&quot;</span>);</span><br><span class="line"><span class="built_in">this</span>.causeDepth = causeDepth &gt; <span class="number">0</span> ? causeDepth : DEFAULT_CAUSE_DEPTH;</span><br><span class="line"><span class="built_in">this</span>.stackDepth = stackDepth &gt; <span class="number">0</span> ? stackDepth : DEFAULT_STACK_DEPTH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> StackTraceConverter <span class="title function_">newInstance</span><span class="params">(String[] options)</span> &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">causeDepth</span> <span class="operator">=</span> parseOption(options, <span class="number">0</span>, DEFAULT_CAUSE_DEPTH);</span><br><span class="line"><span class="type">int</span> <span class="variable">stackDepth</span> <span class="operator">=</span> parseOption(options, <span class="number">1</span>, DEFAULT_STACK_DEPTH);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StackTraceConverter</span>(causeDepth, stackDepth);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">parseOption</span><span class="params">(String[] options, <span class="type">int</span> index, <span class="type">int</span> defaultValue)</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (options != <span class="literal">null</span> &amp;&amp; options.length &gt; index) &#123;</span><br><span class="line"><span class="keyword">return</span> Integer.parseInt(options[index]);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (NumberFormatException ignored) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> defaultValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">format</span><span class="params">(LogEvent event, StringBuilder output)</span> &#123;</span><br><span class="line"><span class="type">Throwable</span> <span class="variable">throwable</span> <span class="operator">=</span> event.getThrown();</span><br><span class="line"><span class="keyword">if</span> (throwable != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="type">ForwardCounter</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForwardCounter</span>();</span><br><span class="line">output.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">recursiveReversePrint(throwable, output, counter);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">recursiveReversePrint</span><span class="params">(Throwable throwable, StringBuilder output,</span></span><br><span class="line"><span class="params">   ForwardCounter counter)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (throwable == <span class="literal">null</span> || counter.value &gt;= causeDepth) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (throwable.getCause() != <span class="literal">null</span>) &#123;</span><br><span class="line">recursiveReversePrint(throwable.getCause(), output, counter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (counter.value++ &lt; causeDepth) &#123;</span><br><span class="line">printSingleStack(throwable, output);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printSingleStack</span><span class="params">(Throwable throwable, StringBuilder output)</span> &#123;</span><br><span class="line">output.append(reduceClassName(throwable.getClass().getName()))</span><br><span class="line">.append(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">.append(throwable.getMessage())</span><br><span class="line">.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">StackTraceElement[] stack = throwable.getStackTrace();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; Math.min(stackDepth, stack.length); i++) &#123;</span><br><span class="line">output.append(<span class="string">&quot;\tat &quot;</span>)</span><br><span class="line">.append(formatStackElement(stack[i]))</span><br><span class="line">.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (stack.length &gt; stackDepth) &#123;</span><br><span class="line">output.append(<span class="string">&quot;\t... &quot;</span>).append(stack.length - stackDepth)</span><br><span class="line">.append(<span class="string">&quot; more\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">formatStackElement</span><span class="params">(StackTraceElement element)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> reduceClassName(element.getClassName()) +</span><br><span class="line"><span class="string">&quot;#&quot;</span> + element.getMethodName() +</span><br><span class="line"><span class="string">&quot;:&quot;</span> + element.getLineNumber();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">reduceClassName</span><span class="params">(String className)</span> &#123;</span><br><span class="line">String[] parts = className.split(<span class="string">&quot;\\.&quot;</span>);</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parts.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">sb.append(parts[i].charAt(<span class="number">0</span>)).append(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">sb.append(parts[parts.length - <span class="number">1</span>]);</span><br><span class="line"><span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ForwardCounter</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中，<code>@ConverterKeys(&#123;&quot;st&quot;, &quot;stacktrace&quot;&#125;)</code> 这一行用于配置 log4j2 配置文件的占位符。例如，我们的 log4j2.yml 文件如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Configuration:</span></span><br><span class="line">  <span class="attr">status:</span> <span class="string">WARN</span></span><br><span class="line">  <span class="attr">monitorInterval:</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">Properties:</span></span><br><span class="line">    <span class="attr">Property:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APP_NAME</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">$$&#123;spring:spring.application.name:-eden-demo-cola&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROFILES</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">$$&#123;spring:spring.profiles.active&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_PATH</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">$$&#123;spring:logging.file.path:-/app/logs&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_PATTERN</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; %-5level [$&#123;PROFILES&#125;] [%t] [%X&#123;traceId&#125;] %msg%n%throwable&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">Appenders:</span></span><br><span class="line">    <span class="attr">Console:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">STDOUT</span></span><br><span class="line">      <span class="attr">target:</span> <span class="string">SYSTEM_OUT</span></span><br><span class="line">      <span class="attr">PatternLayout:</span></span><br><span class="line">        <span class="attr">pattern:</span> <span class="string">$&#123;LOG_PATTERN&#125;</span></span><br><span class="line">      <span class="attr">Filters:</span></span><br><span class="line">        <span class="attr">ThresholdFilter:</span></span><br><span class="line">          <span class="attr">level:</span> <span class="string">INFO</span></span><br><span class="line">          <span class="attr">onMatch:</span> <span class="string">ACCEPT</span></span><br><span class="line">          <span class="attr">onMismatch:</span> <span class="string">DENY</span></span><br><span class="line">        <span class="attr">BurstFilter:</span></span><br><span class="line">          <span class="attr">level:</span> <span class="string">INFO</span></span><br><span class="line">          <span class="attr">rate:</span> <span class="number">1000</span></span><br><span class="line">          <span class="attr">maxBurst:</span> <span class="number">10000</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">Loggers:</span></span><br><span class="line">    <span class="attr">Root:</span></span><br><span class="line">      <span class="attr">level:</span> <span class="string">INFO</span></span><br><span class="line">      <span class="attr">includeLocation:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">AppenderRef:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">ref:</span> <span class="string">STDOUT</span></span><br></pre></td></tr></table></figure><p>我们只需要把 <code>%throwable</code> 替换为 <code>%stacktrace&#123;3,5&#125;</code>，表示对象的堆栈进行倒排，Cause 深度为 3，栈的深度为 5。</p><h2 id="效果验证">效果验证</h2><p>笔者在 log4j2.yaml 的 pattern 设置了 <code>before%n%throwable%nafter%n%stacktrace&#123;3,5&#125;</code>，将默认的 <code>%throwable</code> 和优化后的 <code>%stacktrace&#123;3,5&#125;</code> 进行对比，如下。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/log4j2/log4j2-stacktrace.png" alt=""></p><p>好了，发起一次不正常的请求测试日志输出情况。</p><p>优化前的 <code>%throwable</code> 日志输出如下，累计 193 行。</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">org.mybatis.spring.MyBatisSystemException: nested exception is org.apache.ibatis.exceptions.PersistenceException: </span><br><span class="line">### Error updating database.  Cause: java.lang.RuntimeException: java.lang.reflect.InvocationTargetException</span><br><span class="line">### The error may involve org.ylzl.eden.demo.infrastructure.user.database.UserMapper.insert-Inline</span><br><span class="line">### The error occurred while setting parameters</span><br><span class="line">### SQL: INSERT INTO demo_user  ( id, login,  email )  VALUES (  ?, ?,  ?  )</span><br><span class="line">### Cause: java.lang.RuntimeException: java.lang.reflect.InvocationTargetException</span><br><span class="line">at org.mybatis.spring.MyBatisExceptionTranslator.translateExceptionIfPossible(MyBatisExceptionTranslator.java:97)</span><br><span class="line">at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:439)</span><br><span class="line">at com.sun.proxy.$Proxy148.insert(Unknown Source)</span><br><span class="line">at org.mybatis.spring.SqlSessionTemplate.insert(SqlSessionTemplate.java:272)</span><br><span class="line">at com.baomidou.mybatisplus.core.override.MybatisMapperMethod.execute(MybatisMapperMethod.java:59)</span><br><span class="line">at com.baomidou.mybatisplus.core.override.MybatisMapperProxy$PlainMethodInvoker.invoke(MybatisMapperProxy.java:152)</span><br><span class="line">at com.baomidou.mybatisplus.core.override.MybatisMapperProxy.invoke(MybatisMapperProxy.java:89)</span><br><span class="line">at com.sun.proxy.$Proxy149.insert(Unknown Source)</span><br><span class="line">at org.ylzl.eden.demo.infrastructure.user.gateway.UserGatewayImpl.save(UserGatewayImpl.java:49)</span><br><span class="line">at org.ylzl.eden.demo.infrastructure.user.gateway.UserGatewayImpl$$FastClassBySpringCGLIB$$d8b0b6f3.invoke(&lt;generated&gt;)</span><br><span class="line">at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:783)</span><br><span class="line">at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:753)</span><br><span class="line">at org.springframework.dao.support.PersistenceExceptionTranslationInterceptor.invoke(PersistenceExceptionTranslationInterceptor.java:137)</span><br><span class="line">at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:753)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:698)</span><br><span class="line">at org.ylzl.eden.demo.infrastructure.user.gateway.UserGatewayImpl$$EnhancerBySpringCGLIB$$f587547c.save(&lt;generated&gt;)</span><br><span class="line">at org.ylzl.eden.demo.app.user.executor.command.UserAddCmdExe.execute(UserAddCmdExe.java:45)</span><br><span class="line">at org.ylzl.eden.demo.app.user.service.UserServiceImpl.createUser(UserServiceImpl.java:69)</span><br><span class="line">at org.ylzl.eden.demo.app.user.service.UserServiceImpl$$FastClassBySpringCGLIB$$f054739f.invoke(&lt;generated&gt;)</span><br><span class="line">at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:783)</span><br><span class="line">at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:753)</span><br><span class="line">at org.springframework.transaction.interceptor.TransactionInterceptor$1.proceedWithInvocation(TransactionInterceptor.java:123)</span><br><span class="line">at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:388)</span><br><span class="line">at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:119)</span><br><span class="line">at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:753)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:698)</span><br><span class="line">at org.ylzl.eden.demo.app.user.service.UserServiceImpl$$EnhancerBySpringCGLIB$$ab23bab3.createUser(&lt;generated&gt;)</span><br><span class="line">at org.ylzl.eden.demo.adapter.user.web.UserController.createUser(UserController.java:58)</span><br><span class="line">at org.ylzl.eden.demo.adapter.user.web.UserController$$FastClassBySpringCGLIB$$3ab5b0e1.invoke(&lt;generated&gt;)</span><br><span class="line">at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:218)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.invokeJoinpoint(CglibAopProxy.java:783)</span><br><span class="line">at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:753)</span><br><span class="line">at org.ylzl.eden.spring.framework.logging.access.aop.AccessLogInterceptor.invoke(AccessLogInterceptor.java:66)</span><br><span class="line">at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:753)</span><br><span class="line">at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:97)</span><br><span class="line">at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:186)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$CglibMethodInvocation.proceed(CglibAopProxy.java:753)</span><br><span class="line">at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:698)</span><br><span class="line">at org.ylzl.eden.demo.adapter.user.web.UserController$$EnhancerBySpringCGLIB$$64eb74d9.createUser(&lt;generated&gt;)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:205)</span><br><span class="line">at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:150)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:117)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:895)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:808)</span><br><span class="line">at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1067)</span><br><span class="line">at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:963)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1006)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:909)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:517)</span><br><span class="line">at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:883)</span><br><span class="line">at javax.servlet.http.HttpServlet.service(HttpServlet.java:584)</span><br><span class="line">at io.undertow.servlet.handlers.ServletHandler.handleRequest(ServletHandler.java:74)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:129)</span><br><span class="line">at org.ylzl.eden.spring.framework.logging.bootstrap.filter.BootstrapLogHttpFilter.doFilter(BootstrapLogHttpFilter.java:70)</span><br><span class="line">at javax.servlet.http.HttpFilter.doFilter(HttpFilter.java:97)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)</span><br><span class="line">at org.ylzl.eden.spring.integration.cat.integration.web.HttpCatFilter.logTransaction(HttpCatFilter.java:167)</span><br><span class="line">at org.ylzl.eden.spring.integration.cat.integration.web.HttpCatFilter.doFilter(HttpCatFilter.java:143)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)</span><br><span class="line">at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)</span><br><span class="line">at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)</span><br><span class="line">at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:97)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)</span><br><span class="line">at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)</span><br><span class="line">at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)</span><br><span class="line">at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)</span><br><span class="line">at io.undertow.servlet.handlers.FilterHandler.handleRequest(FilterHandler.java:84)</span><br><span class="line">at io.undertow.servlet.handlers.security.ServletSecurityRoleHandler.handleRequest(ServletSecurityRoleHandler.java:62)</span><br><span class="line">at io.undertow.servlet.handlers.ServletChain$1.handleRequest(ServletChain.java:68)</span><br><span class="line">at io.undertow.servlet.handlers.ServletDispatchingHandler.handleRequest(ServletDispatchingHandler.java:36)</span><br><span class="line">at io.undertow.servlet.handlers.RedirectDirHandler.handleRequest(RedirectDirHandler.java:68)</span><br><span class="line">at io.undertow.servlet.handlers.security.SSLInformationAssociationHandler.handleRequest(SSLInformationAssociationHandler.java:117)</span><br><span class="line">at io.undertow.servlet.handlers.security.ServletAuthenticationCallHandler.handleRequest(ServletAuthenticationCallHandler.java:57)</span><br><span class="line">at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)</span><br><span class="line">at io.undertow.security.handlers.AbstractConfidentialityHandler.handleRequest(AbstractConfidentialityHandler.java:46)</span><br><span class="line">at io.undertow.servlet.handlers.security.ServletConfidentialityConstraintHandler.handleRequest(ServletConfidentialityConstraintHandler.java:64)</span><br><span class="line">at io.undertow.security.handlers.AuthenticationMechanismsHandler.handleRequest(AuthenticationMechanismsHandler.java:60)</span><br><span class="line">at io.undertow.servlet.handlers.security.CachedAuthenticatedSessionHandler.handleRequest(CachedAuthenticatedSessionHandler.java:77)</span><br><span class="line">at io.undertow.security.handlers.AbstractSecurityContextAssociationHandler.handleRequest(AbstractSecurityContextAssociationHandler.java:43)</span><br><span class="line">at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)</span><br><span class="line">at io.undertow.servlet.handlers.SendErrorPageHandler.handleRequest(SendErrorPageHandler.java:52)</span><br><span class="line">at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler.handleFirstRequest(ServletInitialHandler.java:280)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler.access$100(ServletInitialHandler.java:79)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler$2.call(ServletInitialHandler.java:134)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler$2.call(ServletInitialHandler.java:131)</span><br><span class="line">at io.undertow.servlet.core.ServletRequestContextThreadSetupAction$1.call(ServletRequestContextThreadSetupAction.java:48)</span><br><span class="line">at io.undertow.servlet.core.ContextClassLoaderSetupAction$1.call(ContextClassLoaderSetupAction.java:43)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler.dispatchRequest(ServletInitialHandler.java:260)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler.access$000(ServletInitialHandler.java:79)</span><br><span class="line">at io.undertow.servlet.handlers.ServletInitialHandler$1.handleRequest(ServletInitialHandler.java:100)</span><br><span class="line">at io.undertow.server.Connectors.executeRootHandler(Connectors.java:387)</span><br><span class="line">at io.undertow.server.HttpServerExchange$1.run(HttpServerExchange.java:852)</span><br><span class="line">at org.jboss.threads.ContextClassLoaderSavingRunnable.run(ContextClassLoaderSavingRunnable.java:35)</span><br><span class="line">at org.jboss.threads.EnhancedQueueExecutor.safeRun(EnhancedQueueExecutor.java:2019)</span><br><span class="line">at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.doRunTask(EnhancedQueueExecutor.java:1558)</span><br><span class="line">at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1449)</span><br><span class="line">at org.xnio.XnioWorker$WorkerThreadFactory$1$1.run(XnioWorker.java:1280)</span><br><span class="line">at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">Caused by: org.apache.ibatis.exceptions.PersistenceException: </span><br><span class="line">### Error updating database.  Cause: java.lang.RuntimeException: java.lang.reflect.InvocationTargetException</span><br><span class="line">### The error may involve org.ylzl.eden.demo.infrastructure.user.database.UserMapper.insert-Inline</span><br><span class="line">### The error occurred while setting parameters</span><br><span class="line">### SQL: INSERT INTO demo_user  ( id, login,  email )  VALUES (  ?, ?,  ?  )</span><br><span class="line">### Cause: java.lang.RuntimeException: java.lang.reflect.InvocationTargetException</span><br><span class="line">at org.apache.ibatis.exceptions.ExceptionFactory.wrapException(ExceptionFactory.java:30)</span><br><span class="line">at org.apache.ibatis.session.defaults.DefaultSqlSession.update(DefaultSqlSession.java:199)</span><br><span class="line">at org.apache.ibatis.session.defaults.DefaultSqlSession.insert(DefaultSqlSession.java:184)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:425)</span><br><span class="line">... 121 more</span><br><span class="line">Caused by: java.lang.RuntimeException: java.lang.reflect.InvocationTargetException</span><br><span class="line">at org.ylzl.eden.spring.integration.cat.integration.mybatis.MybatisCatInterceptor.intercept(MybatisCatInterceptor.java:70)</span><br><span class="line">at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:59)</span><br><span class="line">at com.sun.proxy.$Proxy185.update(Unknown Source)</span><br><span class="line">at org.apache.ibatis.session.defaults.DefaultSqlSession.update(DefaultSqlSession.java:197)</span><br><span class="line">... 127 more</span><br><span class="line">Caused by: java.lang.reflect.InvocationTargetException</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">at org.apache.ibatis.plugin.Invocation.proceed(Invocation.java:61)</span><br><span class="line">at org.ylzl.eden.spring.integration.cat.integration.mybatis.MybatisCatInterceptor.intercept(MybatisCatInterceptor.java:64)</span><br><span class="line">... 130 more</span><br><span class="line">Caused by: org.h2.jdbc.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: &quot;PRIMARY KEY ON PUBLIC.DEMO_USER(ID) [1, &#x27;admin&#x27;, &#x27;&#123;bcrypt&#125;$2a$10$gSAhZrxMllrbgj/kkK9UceBPpChGWJA7SYIb1Mqo.n5aNLq1/oRrC&#x27;, &#x27;1813******@qq.com|FCBD1399F72052DCB729247191079CFC&#x27;, TRUE, FALSE, &#x27;zh-cn&#x27;, NULL, NULL, NULL, &#x27;system&#x27;, TIMESTAMP &#x27;2025-03-19 17:07:31.328&#x27;, &#x27;system&#x27;, NULL]&quot;; SQL statement:</span><br><span class="line">INSERT INTO demo_user  ( id, login,  email )  VALUES (  ?, ?,  ?  ) [23505-200]</span><br><span class="line">at org.h2.message.DbException.getJdbcSQLException(DbException.java:459)</span><br><span class="line">at org.h2.message.DbException.getJdbcSQLException(DbException.java:429)</span><br><span class="line">at org.h2.message.DbException.get(DbException.java:205)</span><br><span class="line">at org.h2.message.DbException.get(DbException.java:181)</span><br><span class="line">at org.h2.mvstore.db.MVPrimaryIndex.add(MVPrimaryIndex.java:127)</span><br><span class="line">at org.h2.mvstore.db.MVTable.addRow(MVTable.java:531)</span><br><span class="line">at org.h2.command.dml.Insert.insertRows(Insert.java:195)</span><br><span class="line">at org.h2.command.dml.Insert.update(Insert.java:151)</span><br><span class="line">at org.h2.command.CommandContainer.update(CommandContainer.java:198)</span><br><span class="line">at org.h2.command.Command.executeUpdate(Command.java:251)</span><br><span class="line">at org.h2.jdbc.JdbcPreparedStatement.execute(JdbcPreparedStatement.java:240)</span><br><span class="line">at com.zaxxer.hikari.pool.ProxyPreparedStatement.execute(ProxyPreparedStatement.java:44)</span><br><span class="line">at com.zaxxer.hikari.pool.HikariProxyPreparedStatement.execute(HikariProxyPreparedStatement.java)</span><br><span class="line">at org.apache.ibatis.executor.statement.PreparedStatementHandler.update(PreparedStatementHandler.java:48)</span><br><span class="line">at org.apache.ibatis.executor.statement.RoutingStatementHandler.update(RoutingStatementHandler.java:75)</span><br><span class="line">at org.apache.ibatis.executor.SimpleExecutor.doUpdate(SimpleExecutor.java:50)</span><br><span class="line">at org.apache.ibatis.executor.BaseExecutor.update(BaseExecutor.java:117)</span><br><span class="line">at org.apache.ibatis.executor.CachingExecutor.update(CachingExecutor.java:76)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:61)</span><br><span class="line">at com.sun.proxy.$Proxy185.update(Unknown Source)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:498)</span><br><span class="line">at org.apache.ibatis.plugin.Invocation.proceed(Invocation.java:61)</span><br><span class="line">at org.ylzl.eden.spring.data.mybatis.plugin.MybatisSqlLogInterceptor.intercept(MybatisSqlLogInterceptor.java:64)</span><br><span class="line">at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:59)</span><br><span class="line">at com.sun.proxy.$Proxy185.update(Unknown Source)</span><br><span class="line">... 136 more</span><br></pre></td></tr></table></figure><p>优化后的 <code>%%stacktrace&#123;3,5&#125;</code> 日志输出如下，累计 22 行。基于倒排的优势，在前面几行，我们马上就能定位到 Cause by 原因了。</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">o.h.j.JdbcSQLIntegrityConstraintViolationException: Unique index or primary key violation: &quot;PRIMARY KEY ON PUBLIC.DEMO_USER(ID) [1, &#x27;admin&#x27;, &#x27;&#123;bcrypt&#125;$2a$10$gSAhZrxMllrbgj/kkK9UceBPpChGWJA7SYIb1Mqo.n5aNLq1/oRrC&#x27;, &#x27;1813******@qq.com|FCBD1399F72052DCB729247191079CFC&#x27;, TRUE, FALSE, &#x27;zh-cn&#x27;, NULL, NULL, NULL, &#x27;system&#x27;, TIMESTAMP &#x27;2025-03-19 17:07:31.328&#x27;, &#x27;system&#x27;, NULL]&quot;; SQL statement:</span><br><span class="line">INSERT INTO demo_user  ( id, login,  email )  VALUES (  ?, ?,  ?  ) [23505-200]</span><br><span class="line">at o.h.m.DbException#getJdbcSQLException:459</span><br><span class="line">at o.h.m.DbException#getJdbcSQLException:429</span><br><span class="line">at o.h.m.DbException#get:205</span><br><span class="line">at o.h.m.DbException#get:181</span><br><span class="line">at o.h.m.d.MVPrimaryIndex#add:127</span><br><span class="line">... 163 more</span><br><span class="line">j.l.r.InvocationTargetException: null</span><br><span class="line">at s.r.NativeMethodAccessorImpl#invoke0:-2</span><br><span class="line">at s.r.NativeMethodAccessorImpl#invoke:62</span><br><span class="line">at s.r.DelegatingMethodAccessorImpl#invoke:43</span><br><span class="line">at j.l.r.Method#invoke:498</span><br><span class="line">at o.a.i.p.Invocation#proceed:61</span><br><span class="line">... 131 more</span><br><span class="line">j.l.RuntimeException: java.lang.reflect.InvocationTargetException</span><br><span class="line">at o.y.e.s.i.c.i.m.MybatisCatInterceptor#intercept:70</span><br><span class="line">at o.a.i.p.Plugin#invoke:59</span><br><span class="line">at c.s.p.$Proxy185#update:-1</span><br><span class="line">at o.a.i.s.d.DefaultSqlSession#update:197</span><br><span class="line">at o.a.i.s.d.DefaultSqlSession#insert:184</span><br><span class="line">... 126 more</span><br></pre></td></tr></table></figure><p>我们发起 1W QPS 的压测，来比较下体积的变化。</p><h1>产出</h1><p>对存储占用降低，对业务零侵入，研发团队只需要在 log4j2.yml 引入相关日志插件就可以完成日志脱敏。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-framework">eden-spring-framework</a> 的 <code>StackTraceConverter</code> 类。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 扩展点 </tag>
            
            <tag> Log4j2 </tag>
            
            <tag> 降本增效 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jenkins 密码策略合规优化</title>
      <link href="/2025/03/09/devops/Jenkins%20%E5%AF%86%E7%A0%81%E7%AD%96%E7%95%A5%E5%90%88%E8%A7%84%E4%BC%98%E5%8C%96/"/>
      <url>/2025/03/09/devops/Jenkins%20%E5%AF%86%E7%A0%81%E7%AD%96%E7%95%A5%E5%90%88%E8%A7%84%E4%BC%98%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>因 SOX 项目审计，检查到我们使用 Jenkins 开源版本作为发版工具，但 Jenkins 的密码策略不符合基本的安全要求，例如密码长度不能小于 8 个字符，需要包含大小写字母、数字和特殊字符，需要进行整改。</p><h1>目标</h1><p>选择正确的方案，满足 Jenkins 的密码策略要求。</p><h1>实现</h1><h2 id="使用-2FA-双因素认证插件">使用 2FA 双因素认证插件</h2><p>在 Jenkins 插件管理搜索 <a href="https://github.com/jenkinsci/miniorange-two-factor-plugin">MFA</a> 安装。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/marketplace-2fa.png" alt=""></p><p>插件安全完成后，在系统管理出现新的选项 <code>2FA Global  Configurations</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/open-2fa-configuration.png" alt=""></p><p>在配置里面勾选 <code>Enable 2FA for all users</code> 和 <code>Mobile Authenticator</code> 表示对所有用户开启 2FA 认证。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/set-2fa-config.png" alt=""></p><p>接下来我们进行测试，进入登录页面。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/login-page.png" alt=""></p><p>输入用户和密码后，弹出二维码，手机下载 Authenticator 软件，扫码。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/authenticator-code.png" alt=""></p><p>输入 6 位动态验证码</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/enter-verification-code.png" alt=""></p><p>登陆成功。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/authen-success.png" alt=""></p><p>一个验证码只能被一个手机APP绑定，更换APP设备需要管理员从系统管理 reset 重置二维码绑定。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/allow-user-reset-2fa.png" alt=""></p><p>整个流程下来，使用 2FA 双因素认证插件是没有问题的，但是，这个插件是收费的，并且对 Jenkins 版本有要求，笔者公司的 Jenkins 版本为 2.356，没办法安装。</p><h2 id="基于-Jenkins-官方源码二次开发">基于 Jenkins 官方源码二次开发</h2><p>直接 git clone 官方源码，找到设置密码的代码位置。</p><p>修改后台代码，路径：<code>hudson.security.HudsonPrivateSecurityRealm</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HudsonPrivateSecurityRealm</span> <span class="keyword">extends</span> <span class="title class_">AbstractPasswordBasedSecurityRealm</span> <span class="keyword">implements</span> <span class="title class_">ModelObject</span>, AccessControlled &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="meta">@Extension</span> <span class="meta">@Symbol(&quot;password&quot;)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DescriptorImpl</span> <span class="keyword">extends</span> <span class="title class_">UserPropertyDescriptor</span> &#123;</span><br><span class="line">            <span class="meta">@NonNull</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getDisplayName</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> Messages.HudsonPrivateSecurityRealm_Details_DisplayName();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Details <span class="title function_">newInstance</span><span class="params">(StaplerRequest req, JSONObject formData)</span> <span class="keyword">throws</span> FormException &#123;</span><br><span class="line">                <span class="keyword">if</span> (req == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Should never happen, see newInstance() Javadoc</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FormException</span>(<span class="string">&quot;Stapler request is missing in the call&quot;</span>, <span class="string">&quot;staplerRequest&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">String</span> <span class="variable">pwd</span> <span class="operator">=</span> Util.fixEmpty(req.getParameter(<span class="string">&quot;user.password&quot;</span>));</span><br><span class="line">                <span class="type">String</span> <span class="variable">pwd2</span> <span class="operator">=</span> Util.fixEmpty(req.getParameter(<span class="string">&quot;user.password2&quot;</span>));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (pwd == <span class="literal">null</span> || pwd2 == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// one of the fields is empty</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FormException</span>(<span class="string">&quot;Please confirm the password by typing it twice&quot;</span>, <span class="string">&quot;user.password2&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// will be null if it wasn&#x27;t encrypted</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> Protector.unprotect(pwd);</span><br><span class="line">                <span class="type">String</span> <span class="variable">data2</span> <span class="operator">=</span> Protector.unprotect(pwd2);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (data == <span class="literal">null</span> != (data2 == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    <span class="comment">// Require that both values are protected or unprotected; do not allow user to change just one text field</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FormException</span>(<span class="string">&quot;Please confirm the password by typing it twice&quot;</span>, <span class="string">&quot;user.password2&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (data != <span class="literal">null</span> <span class="comment">/* &amp;&amp; data2 != null */</span> &amp;&amp; !MessageDigest.isEqual(data.getBytes(StandardCharsets.UTF_8), data2.getBytes(StandardCharsets.UTF_8))) &#123;</span><br><span class="line">                    <span class="comment">// passwords are different encrypted values</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FormException</span>(<span class="string">&quot;Please confirm the password by typing it twice&quot;</span>, <span class="string">&quot;user.password2&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (data == <span class="literal">null</span> <span class="comment">/* &amp;&amp; data2 == null */</span> &amp;&amp; !pwd.equals(pwd2)) &#123;</span><br><span class="line">                    <span class="comment">// passwords are different plain values</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FormException</span>(<span class="string">&quot;Please confirm the password by typing it twice&quot;</span>, <span class="string">&quot;user.password2&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/********** 新增密码复杂度 start **********/</span></span><br><span class="line">                <span class="comment">// Validate password complexity</span></span><br><span class="line">                <span class="keyword">if</span> (pwd.length() &lt; <span class="number">8</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FormException</span>(<span class="string">&quot;Password must be at least 8 characters long&quot;</span>, <span class="string">&quot;user.password&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check if it contains at least one lowercase letter</span></span><br><span class="line">                <span class="keyword">if</span> (!pwd.matches(<span class="string">&quot;.*[a-z].*&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FormException</span>(<span class="string">&quot;Password must contain at least one lowercase letter&quot;</span>, <span class="string">&quot;user.password&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check if it contains at least one uppercase letter</span></span><br><span class="line">                <span class="keyword">if</span> (!pwd.matches(<span class="string">&quot;.*[A-Z].*&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FormException</span>(<span class="string">&quot;Password must contain at least one uppercase letter&quot;</span>, <span class="string">&quot;user.password&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check if it contains at least one digit</span></span><br><span class="line">                <span class="keyword">if</span> (!pwd.matches(<span class="string">&quot;.*[0-9].*&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FormException</span>(<span class="string">&quot;Password must contain at least one digit&quot;</span>, <span class="string">&quot;user.password&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check if it contains at least one special character (common set)</span></span><br><span class="line">                <span class="keyword">if</span> (!pwd.matches(<span class="string">&quot;.*[!@#$%^&amp;*(),.?\&quot;:&#123;&#125;|&lt;&gt;].*&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FormException</span>(<span class="string">&quot;Password must contain at least one special character (e.g., !@#$%^&amp;*()-_=+[]&#123;&#125;|;:&#x27;\&quot;,.&lt;&gt;?/)&quot;</span>, <span class="string">&quot;user.password&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/********** 新增密码复杂度 end **********/</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (data != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> Stapler.getCurrentRequest().getSession().getId() + <span class="string">&#x27;:&#x27;</span>;</span><br><span class="line">                    <span class="keyword">if</span> (data.startsWith(prefix)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Details.fromHashedPassword(data.substring(prefix.length()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> Util.getNearestAncestorOfTypeOrThrow(req, User.class);</span><br><span class="line">                <span class="comment">// the UserSeedProperty is not touched by the configure page</span></span><br><span class="line">                <span class="type">UserSeedProperty</span> <span class="variable">userSeedProperty</span> <span class="operator">=</span> user.getProperty(UserSeedProperty.class);</span><br><span class="line">                <span class="keyword">if</span> (userSeedProperty != <span class="literal">null</span>) &#123;</span><br><span class="line">                    userSeedProperty.renewSeed();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> Details.fromPlainPassword(Util.fixNull(pwd));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="comment">// this feature is only when HudsonPrivateSecurityRealm is enabled</span></span><br><span class="line">                <span class="keyword">return</span> Jenkins.get().getSecurityRealm() <span class="keyword">instanceof</span> HudsonPrivateSecurityRealm;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> UserProperty <span class="title function_">newInstance</span><span class="params">(User user)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改页面代码，路径：<code>core/src/main/resources/hudson/security/HudsonPrivateSecurityRealm/Details/config.jelly</code>。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?jelly escape-by-default=&#x27;true&#x27;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">j:jelly</span> <span class="attr">xmlns:j</span>=<span class="string">&quot;jelly:core&quot;</span> <span class="attr">xmlns:x</span>=<span class="string">&quot;jelly:xml&quot;</span> <span class="attr">xmlns:f</span>=<span class="string">&quot;/lib/form&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">f:entry</span> <span class="attr">title</span>=<span class="string">&quot;$&#123;%Password&#125;:&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> <span class="attr">class</span>=<span class="string">&quot;jenkins-input&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user.password&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;instance.protectedPassword&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;passwordHint&quot;</span> <span class="attr">style</span>=<span class="string">&quot;color:red;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">f:entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">f:entry</span> <span class="attr">title</span>=<span class="string">&quot;$&#123;%Confirm Password&#125;:&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;password2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;jenkins-input&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user.password2&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;instance.protectedPassword&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">&quot;confirmPasswordHint&quot;</span> <span class="attr">style</span>=<span class="string">&quot;color:red;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">f:entry</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 新增密码复杂度校验 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// &lt;![CDATA[</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;password&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;input&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> password = <span class="variable language_">this</span>.<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> hintElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;passwordHint&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> result = <span class="title function_">checkPasswordStrength</span>(password);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (result) &#123;</span></span><br><span class="line"><span class="language-javascript">                hintElement.<span class="property">textContent</span> = result;</span></span><br><span class="line"><span class="language-javascript">                hintElement.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;inline&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                hintElement.<span class="property">textContent</span> = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                hintElement.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">function</span> <span class="title function_">checkPasswordStrength</span>(<span class="params">password</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// Check password length</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (password.<span class="property">length</span> &lt; <span class="number">8</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="string">&quot;Password must be at least 8 characters long&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// Check for at least one uppercase letter</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!<span class="regexp">/[A-Z]/</span>.<span class="title function_">test</span>(password)) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="string">&quot;Password must contain at least one uppercase letter&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// Check for at least one lowercase letter</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!<span class="regexp">/[a-z]/</span>.<span class="title function_">test</span>(password)) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="string">&quot;Password must contain at least one lowercase letter&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// Check for at least one digit</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!<span class="regexp">/\d/</span>.<span class="title function_">test</span>(password)) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="string">&quot;Password must contain at least one digit&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// Check for at least one special character (common set)</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (!<span class="regexp">/[!@#$%^&amp;*()\-_=+$$&#123;&#125;|;:&#x27;,.&lt;&gt;?/\\]/</span>.<span class="title function_">test</span>(password)) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="string">&quot;Password must contain at least one special character (e.g., !@#$%^&amp;*()-_=+[]&#123;&#125;|;:&#x27;\&quot;,.&lt;&gt;?/)&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// Password meets all criteria</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// Password is valid</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;password2&#x27;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;input&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> password = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;password&#x27;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> confirmPassword = <span class="variable language_">this</span>.<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> hintElement = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;confirmPasswordHint&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span> (password !== confirmPassword) &#123;</span></span><br><span class="line"><span class="language-javascript">                hintElement.<span class="property">textContent</span> = <span class="string">&quot;Please confirm the password by typing it twice&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">                hintElement.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;inline&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                hintElement.<span class="property">textContent</span> = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">                hintElement.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// ]]&gt;</span></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">j:jelly</span>&gt;</span></span><br></pre></td></tr></table></figure><p>官方源码并没有 Dockerfile 文件，笔者从 Jenkins 镜像反向查到对应的 Docker 源码：<a href="https://github.com/jenkinsci/docker/blob/2.410/11/centos/centos7/hotspot/Dockerfile%E3%80%82">https://github.com/jenkinsci/docker/blob/2.410/11/centos/centos7/hotspot/Dockerfile。</a></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> eclipse-temurin:<span class="number">11.0</span>.<span class="number">19</span>_7-jdk-centos7 as jre-build</span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate smaller java runtime without unneeded files</span></span><br><span class="line"><span class="comment"># for now we include the full module path to maintain compatibility</span></span><br><span class="line"><span class="comment"># while still saving space (approx 200mb from the full distribution)</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> jlink \</span></span><br><span class="line"><span class="language-bash">         --add-modules ALL-MODULE-PATH \</span></span><br><span class="line"><span class="language-bash">         --no-man-pages \</span></span><br><span class="line"><span class="language-bash">         --compress=2 \</span></span><br><span class="line"><span class="language-bash">         --output /javaruntime</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> centos:centos7.<span class="number">9.2009</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -e <span class="string">&#x27;s|^mirrorlist=|#mirrorlist=|g&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">        -e <span class="string">&#x27;s|^#baseurl=http://mirror.centos.org|baseurl=https://mirrors.aliyun.com|g&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">        -i.bak /etc/yum.repos.d/CentOS-Base.repo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum install -y \</span></span><br><span class="line"><span class="language-bash">    curl \</span></span><br><span class="line"><span class="language-bash">    fontconfig \</span></span><br><span class="line"><span class="language-bash">    freetype \</span></span><br><span class="line"><span class="language-bash">    git \</span></span><br><span class="line"><span class="language-bash">    unzip \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">which</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; yum clean all</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.rpm.sh -o /tmp/script.rpm.sh \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; bash /tmp/script.rpm.sh \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">rm</span> -f /tmp/script.rpm.sh \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; yum install -y \</span></span><br><span class="line"><span class="language-bash">    git-lfs \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; yum clean all \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; git lfs install</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> LANG=<span class="string">&#x27;en_US.UTF-8&#x27;</span> LANGUAGE=<span class="string">&#x27;en_US:en&#x27;</span> LC_ALL=<span class="string">&#x27;en_US.UTF-8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> TARGETARCH</span><br><span class="line"><span class="keyword">ARG</span> COMMIT_SHA</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> <span class="keyword">user</span>=jenkins</span><br><span class="line"><span class="keyword">ARG</span> group=jenkins</span><br><span class="line"><span class="keyword">ARG</span> uid=<span class="number">1000</span></span><br><span class="line"><span class="keyword">ARG</span> gid=<span class="number">1000</span></span><br><span class="line"><span class="keyword">ARG</span> http_port=<span class="number">8080</span></span><br><span class="line"><span class="keyword">ARG</span> agent_port=<span class="number">50000</span></span><br><span class="line"><span class="keyword">ARG</span> JENKINS_HOME=/var/jenkins_home</span><br><span class="line"><span class="keyword">ARG</span> REF=/usr/share/jenkins/ref</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JENKINS_HOME $JENKINS_HOME</span><br><span class="line"><span class="keyword">ENV</span> JENKINS_SLAVE_AGENT_PORT $&#123;agent_port&#125;</span><br><span class="line"><span class="keyword">ENV</span> REF $REF</span><br><span class="line"></span><br><span class="line"><span class="comment"># Jenkins is run with user `jenkins`, uid = 1000</span></span><br><span class="line"><span class="comment"># If you bind mount a volume from the host or a data container,</span></span><br><span class="line"><span class="comment"># ensure you use the same uid</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p <span class="variable">$JENKINS_HOME</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">chown</span> <span class="variable">$&#123;uid&#125;</span>:<span class="variable">$&#123;gid&#125;</span> <span class="variable">$JENKINS_HOME</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; groupadd -g <span class="variable">$&#123;gid&#125;</span> <span class="variable">$&#123;group&#125;</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; useradd -N -d <span class="string">&quot;<span class="variable">$JENKINS_HOME</span>&quot;</span> -u <span class="variable">$&#123;uid&#125;</span> -g <span class="variable">$&#123;gid&#125;</span> -l -m -s /bin/bash <span class="variable">$&#123;user&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Jenkins home directory is a volume, so configuration and build history</span></span><br><span class="line"><span class="comment"># can be persisted and survive image upgrades</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> <span class="variable">$JENKINS_HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $REF (defaults to `/usr/share/jenkins/ref/`) contains all reference configuration we want</span></span><br><span class="line"><span class="comment"># to set on a fresh new installation. Use it to bundle additional plugins</span></span><br><span class="line"><span class="comment"># or config file with your custom jenkins Docker image.</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p <span class="variable">$&#123;REF&#125;</span>/init.groovy.d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use tini as subreaper in Docker container to adopt zombie processes</span></span><br><span class="line"><span class="keyword">ARG</span> TINI_VERSION=v0.<span class="number">19.0</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ../tini_pub.gpg <span class="string">&quot;<span class="variable">$&#123;JENKINS_HOME&#125;</span>/tini_pub.gpg&quot;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -fsSL <span class="string">&quot;https://github.com/krallin/tini/releases/download/<span class="variable">$&#123;TINI_VERSION&#125;</span>/tini-static-<span class="variable">$&#123;TARGETARCH&#125;</span>&quot;</span> -o /sbin/tini \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; curl -fsSL <span class="string">&quot;https://github.com/krallin/tini/releases/download/<span class="variable">$&#123;TINI_VERSION&#125;</span>/tini-static-<span class="variable">$&#123;TARGETARCH&#125;</span>.asc&quot;</span> -o /sbin/tini.asc \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; gpg --no-tty --import <span class="string">&quot;<span class="variable">$&#123;JENKINS_HOME&#125;</span>/tini_pub.gpg&quot;</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; gpg --verify /sbin/tini.asc \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">rm</span> -rf /sbin/tini.asc /root/.gnupg \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">chmod</span> +x /sbin/tini</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># jenkins version being bundled in this docker image</span></span><br><span class="line"><span class="keyword">ARG</span> JENKINS_VERSION</span><br><span class="line"><span class="keyword">ENV</span> JENKINS_VERSION $&#123;JENKINS_VERSION:-<span class="number">2.356</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># jenkins.war checksum, download will be validated using it</span></span><br><span class="line"><span class="comment">#ARG JENKINS_SHA=1163c4554dc93439c5eef02b06a8d74f98ca920bbc012c2b8a089d414cfa8075</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Can be used to customize where jenkins.war get downloaded from</span></span><br><span class="line"><span class="comment">#ARG JENKINS_URL=https://repo.jenkins-ci.org/public/org/jenkins-ci/main/jenkins-war/$&#123;JENKINS_VERSION&#125;/jenkins-war-$&#123;JENKINS_VERSION&#125;.war</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># could use ADD but this one does not check Last-Modified header neither does it allow to control checksum</span></span><br><span class="line"><span class="comment"># see https://github.com/docker/docker/issues/8331</span></span><br><span class="line"><span class="comment">#RUN curl -fsSL $&#123;JENKINS_URL&#125; -o /usr/share/jenkins/jenkins.war \</span></span><br><span class="line"><span class="comment">#  &amp;&amp; echo &quot;$&#123;JENKINS_SHA&#125;  /usr/share/jenkins/jenkins.war&quot; &gt;/tmp/jenkins_sha \</span></span><br><span class="line"><span class="comment">#  &amp;&amp; sha256sum -c --strict /tmp/jenkins_sha \</span></span><br><span class="line"><span class="comment">#  &amp;&amp; rm -f /tmp/jenkins_sha</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> war/target/jenkins.war /usr/share/jenkins/jenkins.war</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JENKINS_UC https://updates.jenkins.io</span><br><span class="line"><span class="keyword">ENV</span> JENKINS_UC_EXPERIMENTAL=https://updates.jenkins.io/experimental</span><br><span class="line"><span class="keyword">ENV</span> JENKINS_INCREMENTALS_REPO_MIRROR=https://repo.jenkins-ci.org/incrementals</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> -R <span class="variable">$&#123;user&#125;</span> <span class="string">&quot;<span class="variable">$JENKINS_HOME</span>&quot;</span> <span class="string">&quot;<span class="variable">$REF</span>&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> PLUGIN_CLI_VERSION=<span class="number">2.12</span>.<span class="number">11</span></span><br><span class="line"><span class="keyword">ARG</span> PLUGIN_CLI_URL=https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/$&#123;PLUGIN_CLI_VERSION&#125;/jenkins-plugin-manager-$&#123;PLUGIN_CLI_VERSION&#125;.jar</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -fsSL <span class="variable">$&#123;PLUGIN_CLI_URL&#125;</span> -o /opt/jenkins-plugin-manager.jar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for main web interface:</span></span><br><span class="line"><span class="keyword">EXPOSE</span> $&#123;http_port&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># will be used by attached agents:</span></span><br><span class="line"><span class="keyword">EXPOSE</span> $&#123;agent_port&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> COPY_REFERENCE_FILE_LOG $JENKINS_HOME/copy_reference_file.log</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME=/opt/java/openjdk</span><br><span class="line"><span class="keyword">ENV</span> PATH <span class="string">&quot;$&#123;JAVA_HOME&#125;/bin:$&#123;PATH&#125;&quot;</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=jre-build /javaruntime <span class="variable">$JAVA_HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ../jenkins-support /usr/local/bin/jenkins-support</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ../jenkins.sh /usr/local/bin/jenkins.sh</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ../jenkins-plugin-cli.sh /bin/jenkins-plugin-cli</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /usr/local/bin/jenkins-support \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chmod</span> +x /usr/local/bin/jenkins.sh \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chmod</span> +x /bin/jenkins-plugin-cli</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> $&#123;<span class="keyword">user</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/sbin/tini&quot;</span>, <span class="string">&quot;--&quot;</span>, <span class="string">&quot;/usr/local/bin/jenkins.sh&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># metadata labels</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.vendor=<span class="string">&quot;Jenkins project&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.title=<span class="string">&quot;Official Jenkins Docker image&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.description=<span class="string">&quot;The Jenkins Continuous Integration and Delivery server&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.version=<span class="string">&quot;<span class="variable">$&#123;JENKINS_VERSION&#125;</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.url=<span class="string">&quot;https://www.jenkins.io/&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.source=<span class="string">&quot;https://github.com/jenkinsci/docker&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.revision=<span class="string">&quot;<span class="variable">$&#123;COMMIT_SHA&#125;</span>&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    org.opencontainers.image.licenses=<span class="string">&quot;MIT&quot;</span></span></span><br></pre></td></tr></table></figure><p>构建镜像的问题解决了，直接部署升级测试，效果如下。</p><p>密码长度校验：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/check-password-length.png" alt=""></p><p>小写字母校验：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/check-password-lowercase-letter.png" alt=""></p><p>大写字母校验：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/check-password-uppercase-letter.png" alt=""></p><p>特殊字符校验：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/jenkins/check-password-special-character.png" alt=""></p><p>验证通过，笔者也把修改完的 Jenkins 镜像上传到了 Docker Hub，地址为：<a href="https://hub.docker.com/r/shiyindaxiaojie/jenkins">https://hub.docker.com/r/shiyindaxiaojie/jenkins</a>。如果您对版本有要求，可以按上述的步骤自行编译镜像。</p><h1>产出</h1><p>Jenkins 是最常用的版本发布工具，有些企业在安全审计层面，规定 Jenkins 需要满足基本的密码策略要求，我们可以选择 2FA 双因素插件或者二次开发解决。前者需要一定费用，并且不支持低版本，后者只需要小小的改动就能解决。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/jenkins/tree/feature">jenkins</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 二次开发 </tag>
            
            <tag> Jenkins </tag>
            
            <tag> 持续集成 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KubeVela 云原生应用交付实践</title>
      <link href="/2025/01/03/devops/KubeVela%20%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E5%AE%9E%E8%B7%B5/"/>
      <url>/2025/01/03/devops/KubeVela%20%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>KubeVela 是一个开箱即用的现代化应用交付与管理平台，通过<strong>开放应用模型</strong>（OAM）来作为应用交付的顶层抽象，采用声明式的方式描述应用交付全流程，自动化的集成 CI/CD 及 GitOps 体系，通过 CUE 轻松扩展、复用或重新编写交付过程。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-overview.png" alt=""></p><p>在公司内部，笔者使用 CODING 平台搭建生产环境的 CI/CD 流程，基于 Orbit 落地了 OAM 发布方案。由于 CODING 商业化调整，Orbit 只有旗舰版才能使用。因此，笔者准备调研 KubeVela 是否能平替 CODING。</p><h1>目标</h1><p>验证 KubeVela 是否能实现 Orbit 的 CI/CD 流程，并给出对 KubeVela 的评价。</p><h1>部署</h1><p>在现有的 Kubernetes 集群搭建 KubeVela，使用官方提供的 Helm 脚本部署，代码片段如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add kubevela https://kubevela.github.io/charts</span><br><span class="line"></span><br><span class="line">helm upgrade --install --create-namespace -n vela-system kubevela kubevela/vela-core --<span class="built_in">wait</span></span><br></pre></td></tr></table></figure><p>安装 KubeVela CLI，用于管理集群和应用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Linux</span></span><br><span class="line">curl -fsSl https://kubevela.io/script/install.sh | bash</span><br><span class="line"><span class="comment"># Windows</span></span><br><span class="line">powershell -Command <span class="string">&quot;iwr -useb https://kubevela.net/script/install.ps1 | iex&quot;</span></span><br></pre></td></tr></table></figure><p>安装 KubeVela 核心组件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; vela version</span><br><span class="line">CLI Version: 1.8.2</span><br><span class="line">Core Version:</span><br><span class="line">GitRevision: git-360f69be</span><br><span class="line">GolangVersion: go1.19.9</span><br><span class="line"></span><br><span class="line">&gt; vela install</span><br><span class="line">Check Requirements ...</span><br><span class="line">Installing KubeVela Core ...</span><br><span class="line">Helm Chart used <span class="keyword">for</span> KubeVela control plane installation: https://charts.kubevela.net/core/vela-core-1.8.2.tgz</span><br><span class="line"></span><br><span class="line">Existing KubeVela installation found <span class="keyword">in</span> namespace vela-system</span><br><span class="line"></span><br><span class="line">Do you want to overwrite this installation? (y/n)</span><br><span class="line">...</span><br><span class="line">Start upgrading Helm Chart kubevela <span class="keyword">in</span> namespace vela-system</span><br><span class="line">getting <span class="built_in">history</span> <span class="keyword">for</span> release kubevela</span><br><span class="line">Found existing installation, overwriting...preparing upgrade <span class="keyword">for</span> kubevela</span><br><span class="line">...</span><br><span class="line">updating status <span class="keyword">for</span> upgraded release <span class="keyword">for</span> kubevela</span><br><span class="line"></span><br><span class="line">KubeVela control plane has been successfully <span class="built_in">set</span> up on your cluster.</span><br><span class="line">If you want to <span class="built_in">enable</span> dashboard, please run <span class="string">&quot;vela addon enable velaux&quot;</span></span><br></pre></td></tr></table></figure><p>安装 VelaUX，便于通过浏览器访问 KubeVela 的 UI 控制台。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vela addon <span class="built_in">enable</span> velaux</span><br><span class="line"><span class="comment"># admin/VelaUX12345</span></span><br><span class="line">vela port-forward -n vela-system addon-velaux 8000:8000</span><br></pre></td></tr></table></figure><p>访问控制台 <code>http://host:8000</code>，弹出初始化窗口，输入用户名和密码创建。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-init.png" alt=""></p><h1>使用</h1><p>KubeVela 定义了一组关系，从大到小依次为 <code>项目</code>、<code>交付目标</code>、<code>环境</code>、<code>应用</code>、<code>组件</code>。</p><p>首先，创建您的项目，下图创建了名为 <code>demo</code> 的项目。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-create-project.png" alt=""></p><p>创建 <code>交付目标</code>，用于指定 Kubernetes 的部署位置，笔者分别创建了 <code>demo</code> 命名空间和 <code>demo-gray</code> 命名空间。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-create-object.png" alt=""></p><p>创建 <code>环境</code>，笔者分别创建了 <code>生产环境</code> 指向 <code>demo</code> 交付目标，<code>灰度环境</code> 指向 <code>demo-gray</code> 交付目标，</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-create-env.png" alt=""></p><p>创建 <code>应用</code>，笔者创建了名为 <code>demo</code> 的应用，主组件类型为 <code>webservice</code> 服务，并绑定 <code>生产环境</code> 和 <code>灰度环境</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-create-app.png" alt=""></p><p>点击下一步，为主组件设置容器镜像、内存、CPU、服务访问方式等。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-create-app-with-image.png" alt=""></p><p>您还可以展开高级选项，设置 ENV 环境变量、CMD 启动命令、Probe 探针等参数。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-create-app-advanced-args.png" alt=""></p><p>关于镜像的 Secret，您可以在 <code>管理面板</code> &gt; <code>全局配置</code> &gt; <code>Image Registry</code> 设置。下图，笔者使用了自建的 Harbor 作为私有仓库。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-set-harbor-registry.png" alt=""></p><p>一个应用可以设置多个组件，如下图，笔者分别创建了 <code>基础服务</code>、<code>认证中心</code>、<code>消息中心</code>、<code>订单中心</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-create-app-overview.png" alt=""></p><p>您可以编排某个服务依赖其他服务，例如，<code>订单中心</code>依赖<code>消息中心</code>、<code>认证中心</code>启动完成后才能进行部署。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-create-app-depend-on.png" alt=""></p><p>您也可以根据服务的规模调整 Pod 数量。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-modify-app-scaler.png" alt=""></p><p>在实际的生产场景，多个组件可能会共享同一个 ConfigMap。</p><p>在 KubeVela 有两种做法，第一种是定义一个独立的组件，组件类型为 <code>k8s-objects</code>，然后在自定义的 YAML 内容定义您的 ConfigMap。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-create-app-k8s-objects.png" alt=""></p><p>第一种方式笔者认为不合适，容易混淆我们的业务组件，并且很难适配不同的运行环境。笔者更倾向于使用第二种方式，基于策略使用配置覆盖的形式处理，如下图，笔者分别在 <code>灰度环境</code> 创建了 <code>override-gray</code> 策略，在生产环境创建了 <code>override-prod</code> 策略。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-create-app-override.png" alt=""></p><p>灰度环境 <code>override-gray.yaml</code> 代码片段如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">components:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">properties:</span> </span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span> <span class="comment"># 新增一个 ENV 变量</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">app-configmap</span></span><br><span class="line">              <span class="attr">optional:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">webservice</span> <span class="comment"># 替换所有组件</span></span><br><span class="line">  <span class="comment"># name: demo # 如果加上 name，就匹配某些组件 </span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-configmap</span> <span class="comment"># 创建名为 `app-configmap` 的配置字典</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">objects:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">data:</span> <span class="comment"># 使用 key-value 配置您的内容</span></span><br><span class="line">            <span class="attr">SPRING_PROFILES_ACTIVE:</span> <span class="string">gray</span></span><br><span class="line">          <span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line">          <span class="attr">metadata:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">app-configmap</span></span><br><span class="line">            <span class="attr">namespace:</span> <span class="string">demo-gray</span> <span class="comment"># 在灰度环境命名空间生效</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">k8s-objects</span></span><br></pre></td></tr></table></figure><p>生产环境 <code>override-prod.yaml</code> 代码片段如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">components:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">app-configmap</span></span><br><span class="line">              <span class="attr">optional:</span> <span class="literal">false</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">app-configmap</span></span><br><span class="line">              <span class="attr">optional:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">webservice</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-configmap</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">objects:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">data:</span></span><br><span class="line">            <span class="attr">JAVA_OPTS:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">              -Dspring.cloud.nacos.config.username=nacos</span></span><br><span class="line"><span class="string">              -Dspring.cloud.nacos.config.password=</span></span><br><span class="line"><span class="string">              -Dspring.cloud.nacos.config.server-addr=10.2.2.109:8848</span></span><br><span class="line"><span class="string">              -Dspring.cloud.nacos.config.namespace=prod</span></span><br><span class="line"><span class="string">              -Dspring.cloud.nacos.config.group=spring-cloud</span></span><br><span class="line"><span class="string">              -Dspring.cloud.nacos.discovery.username=nacos</span></span><br><span class="line"><span class="string">              -Dspring.cloud.nacos.discovery.password=</span></span><br><span class="line"><span class="string">              -Dspring.cloud.nacos.discovery.server-addr=10.2.2.109:8848</span></span><br><span class="line"><span class="string">              -Dspring.cloud.nacos.discovery.namespace=prod</span></span><br><span class="line"><span class="string">              -Dspring.cloud.nacos.discovery.group=spring-cloud</span></span><br><span class="line"><span class="string"></span>            <span class="attr">SPRING_PROFILES_ACTIVE:</span> <span class="string">prod</span></span><br><span class="line">          <span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line">          <span class="attr">metadata:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">app-configmap</span></span><br><span class="line">            <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">k8s-objects</span>    </span><br></pre></td></tr></table></figure><p>点击部署，多个组件根据描述定义自动更新。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-deploy-app.png" alt=""></p><p>在 Kubernetes 查看部署状态。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-deploy-app-in-kubesphere.png" alt=""></p><p>因为笔者没有对部署的组件设置 Probe 探针，KubeVela 很快就显示部署成功。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-deploy-app-success.png" alt=""></p><p>查看部署的拓扑状态，您可以看到 KubeVela 创建了 4 个 Deployment 无状态服务和 1 个 ConfigMap 配置字典，符合期望。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-deploy-app-topology.png" alt=""></p><p>点击日志，可以直接查看 Pod 的控制台日志信息。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-deploy-app-logview.png" alt=""></p><p>这个时候，发现有报错哈，准备回滚，您可以从 <code>版本</code> 找到记录，点击 <code>回滚</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-deploy-app-version.png" alt=""></p><p>KubeVela 支持回收资源，也就是前面部署的一系列资源，可以一键清理，确保对现有环境不污染。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kube-vela/kube-vela-undeploy-app.png" alt=""></p><h1>总结</h1><p>KubeVela 作为实现 OAM 的开源项目，使用感受如下。</p><ol><li>支持应用编排多个组件，一键部署，一键回收，实时观测服务状态。</li><li>允许您修改运维组件，为团队定制服务。不过运维组件扩展不能新增？只能修改现有的组件，而且能修改的位置有限制。</li><li>需要熟悉 CUE 语法，在配置 ConfigMap 这一块，没有可视化组件，只能自己写代码处理。</li></ol><p>和商业化 CODING 相比如下。</p><ol><li>不支持 CODING 勾选某些组件是否更新，不过这个问题不大，只要没有版本变化，不会触发更新。</li><li>在命名组件时，默认按应用名作为前缀，例如，笔者使用 <code>demo</code> 应用名，其他的组件强制以 <code>demo</code> 开头，无法自定义。</li><li>在其他方面，CODING 显得功能不完整，存在 Bug，例如，公测到现在，PVC 组件仍然没有实现。</li></ol><p>整体来说，KubeVela 作为 CODING 的平替是没有问题的，值得使用。</p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CI/CD </tag>
            
            <tag> GitOps </tag>
            
            <tag> OAM </tag>
            
            <tag> KubeVela </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Harbor 私有镜像仓库搭建</title>
      <link href="/2024/10/16/cloudnative/Harbor%20%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E6%90%AD%E5%BB%BA/"/>
      <url>/2024/10/16/cloudnative/Harbor%20%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>由于自建机房无法访问 DockerHub，需要搭建 Harbor 私有镜像仓库，并解决研发团队在本地镜像仓库中拉取镜像的问题。</p><h1>部署</h1><h2 id="Helm-部署-Harbor">Helm 部署 Harbor</h2><p>本次基于 KubeSphere 平台搭建，使用 Helm 安装，从 <a href="https://artifacthub.io/">ArtifaceHub</a> 搜索 Harbor，添加 <a href="https://artifacthub.io/packages/helm/harbor/harbor">Helm Chart</a>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">helm repo add harbor https://helm.goharbor.io</span><br></pre></td></tr></table></figure><p>Harbor 默认使用 DockerHub 镜像，可以在 Helm 模板添加 <a href="https://github.com/DaoCloud/public-image-mirror">m.daocloud.io</a> 镜像仓库前缀，以解决拉取镜像失败的问题。代码片段如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 存储类指定为 data-nfs-client，您可以自行选择其他存储类。</span></span><br><span class="line"><span class="comment"># Harbor 使用 Nginx 提供访问入口，此处设置为 http://10.2.2.109:30003</span></span><br><span class="line">helm upgrade --install harbor harbor/harbor --<span class="built_in">set</span> expose.type=nodePort --<span class="built_in">set</span> persistence.persistentVolumeClaim.registry.storageClass=data-nfs-client --<span class="built_in">set</span> persistence.persistentVolumeClaim.registry.accessMode=ReadWriteMany --<span class="built_in">set</span> persistence.persistentVolumeClaim.registry.size=50Gi --<span class="built_in">set</span> nginx.image.repository=m.daocloud.io/goharbor/nginx-photon --<span class="built_in">set</span> portal.image.repository=m.daocloud.io/goharbor/harbor-portal --<span class="built_in">set</span> core.image.repository=m.daocloud.io/goharbor/harbor-core --<span class="built_in">set</span> jobservice.image.repository=m.daocloud.io/goharbor/harbor-jobservice --<span class="built_in">set</span> registry.registry.image.repository=m.daocloud.io/goharbor/registry-photon --<span class="built_in">set</span> registry.controller.image.repository=m.daocloud.io/goharbor/harbor-registryctl --<span class="built_in">set</span> trivy.image.repository=m.daocloud.io/goharbor/trivy-adapter-photon --<span class="built_in">set</span> database.internal.image.repository=m.daocloud.io/goharbor/harbor-db --<span class="built_in">set</span> redis.internal.image.repository=m.daocloud.io/goharbor/redis-photon --<span class="built_in">set</span> exporter.image.repository=m.daocloud.io/goharbor/harbor-exporter --<span class="built_in">set</span> expose.tls.enabled=<span class="literal">true</span> --<span class="built_in">set</span> externalURL=https://10.2.2.109:30003 --<span class="built_in">set</span> expose.tls.auto.commonName=<span class="string">&quot;10.2.2.109&quot;</span></span><br></pre></td></tr></table></figure><p>验证 Harbor 登录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Harbor12345&quot;</span> | docker login 10.2.2.109:30003 -u <span class="string">&quot;admin&quot;</span> --password-stdin</span><br></pre></td></tr></table></figure><p>为方便内部访问，笔者没有配置自签名证书，如果您有这个需求，可以参考下述代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">cd</span> certs</span><br><span class="line"><span class="comment"># 自签名 CA 证书</span></span><br><span class="line">&gt; openssl genrsa -out ca.key 4096</span><br><span class="line">&gt; openssl req -x509 -new -nodes -sha512 -days 3650 \</span><br><span class="line">-subj <span class="string">&quot;/C=CN/ST=Guangdong/L=Guangzhou/O=PUYI/OU=Personal/CN=harbor.mengxiangge.org&quot;</span> \</span><br><span class="line">-key ca.key \</span><br><span class="line">-out ca.crt</span><br><span class="line"><span class="comment"># 私钥证书</span></span><br><span class="line">&gt; openssl genrsa -out harbor.mengxiangge.org.key 4096</span><br><span class="line">&gt; openssl req -sha512 -new \</span><br><span class="line">-subj <span class="string">&quot;/C=CN/ST=Guangdong/L=Guangzhou/O=PUYI/OU=Personal/CN=harbor.mengxiangge.org&quot;</span> \</span><br><span class="line">-key harbor.mengxiangge.org.key \</span><br><span class="line">-out harbor.mengxiangge.org.csr</span><br><span class="line"></span><br><span class="line">&gt; <span class="built_in">cat</span> &gt; v3.ext &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">authorityKeyIdentifier=keyid,issuer</span></span><br><span class="line"><span class="string">basicConstraints=CA:FALSE</span></span><br><span class="line"><span class="string">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span></span><br><span class="line"><span class="string">extendedKeyUsage = serverAuth</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">DNS.1=harbor.mengxiangge.org</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书</span></span><br><span class="line">&gt; openssl x509 -req -sha512 -days 3650 \</span><br><span class="line">-extfile v3.ext \</span><br><span class="line">-CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">-<span class="keyword">in</span> harbor.mengxiangge.org.csr \</span><br><span class="line">-out harbor.mengxiangge.org.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取证书</span></span><br><span class="line">&gt; openssl x509 -inform PEM -<span class="keyword">in</span> harbor.mengxiangge.org.crt -out harbor.mengxiangge.org.cert</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设您使用的是 Docker 运行时，使用以下命令将 CA 证书复制到 Docker 配置目录中。</span></span><br><span class="line"><span class="comment"># Docker守护程序将.crt 文件解释为 CA证书，将 .cert 文件解释为客户端证书</span></span><br><span class="line">&gt; <span class="built_in">mkdir</span> -p /etc/docker/certs.d/harbor.mengxiangge.org/</span><br><span class="line">&gt; <span class="built_in">cp</span> harbor.mengxiangge.org.cert /etc/docker/certs.d/harbor.mengxiangge.org/</span><br><span class="line">&gt; <span class="built_in">cp</span> harbor.mengxiangge.org.key /etc/docker/certs.d/harbor.mengxiangge.org/</span><br><span class="line">&gt; <span class="built_in">cp</span> ca.crt /etc/docker/certs.d/harbor.mengxiangge.org/</span><br></pre></td></tr></table></figure><h2 id="容器运行时跳过验证">容器运行时跳过验证</h2><p>使用 HTTP 访问，需要调整对应的 Docker 和 Containerd 相关配置，如果您不清楚 Kubernetes 使用的是 containerd 还是 docker，可以使用 <code>kubectl get nodes -o wide</code> 查看关键信息是否携带 <code>containerd</code> 或者 <code>docker</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&gt; kubectl get nodes -o wide</span><br><span class="line">NAME            STATUS   ROLES                  AGE     VERSION    INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION                 CONTAINER-RUNTIME</span><br><span class="line">k3s-master      Ready    control-plane,worker   3d23h   v1.24.17   10.2.2.109    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line">k3s-worker-01   Ready    worker                 3d22h   v1.24.17   10.2.2.140    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line">k3s-worker-02   Ready    worker                 3d22h   v1.24.17   10.2.2.211    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker</span></span><br><span class="line">&gt; vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.m.daocloud.io&quot;</span>],</span><br><span class="line">    <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;10.2.2.109:30003&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">:wq</span><br><span class="line">&gt; sudo systemctl daemon-reload</span><br><span class="line">&gt; sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># Containerd</span></span><br><span class="line">&gt; vim /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line">[plugins]</span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>]</span><br><span class="line">    ...</span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry]</span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://docker.m.daocloud.io&quot;</span>]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs.<span class="string">&quot;10.2.2.109:30003&quot;</span>.tls]</span><br><span class="line">          insecure_skip_verify=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&gt; sudo systemctl daemon-reload</span><br><span class="line">&gt; sudo systemctl restart containerd</span><br></pre></td></tr></table></figure><h1>验证</h1><p>访问 Harbor 控制台：<a href="http://10.2.2.109:30003">http://10.2.2.109:30003</a>。</p><p>输入初始用户 <code>admin</code> 和密码 <code>Harbor123451</code>，控制台登录成功界面如下。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/harbor/harbor-console.png" alt=""></p><p>验证镜像上传，本次使用 RocketMQ Dashboard 作为示例。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在有 VPN 的机器拉取 DockerHub 镜像</span></span><br><span class="line">&gt; docker pull apacherocketmq/rocketmq-dashboard:latest</span><br><span class="line"><span class="comment"># 推送到 Harbor 私有仓库</span></span><br><span class="line">&gt; <span class="built_in">echo</span> <span class="string">&quot;Harbor12345&quot;</span> | docker login 10.2.2.109:30003 -u <span class="string">&quot;admin&quot;</span> --password-stdin</span><br><span class="line">&gt; docker tag apacherocketmq/rocketmq-dashboard:latest 10.2.2.109:30003/middleware/rocketmq-dashboard:1.0.0</span><br><span class="line">&gt; docker push 10.2.2.109:30003/middleware/rocketmq-dashboard:1.0.0</span><br></pre></td></tr></table></figure><p>在 KubeSphere 中，在保密字典 Secret 添加 Harbor 私有仓库的认证信息，并设置默认镜像仓库。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-default-registry-secret.png" alt=""></p><p>使用 Helm 一键部署，为 RocketMQ Dashboard 指定镜像地址。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install rocketmq rocketmq/rocketmq -n mq --<span class="built_in">set</span> clusterName=rocketmq --<span class="built_in">set</span> image.tag=4.8.0 --<span class="built_in">set</span> broker.size.master=2 --<span class="built_in">set</span> broker.master.jvm.maxHeapSize=1024M --<span class="built_in">set</span> broker.persistence.storageClass=data-nfs-client --<span class="built_in">set</span> broker.size.replica=2 --<span class="built_in">set</span> nameserver.jvm.maxHeapSize=1024M --<span class="built_in">set</span> nameserver.persistence.enabled=<span class="literal">false</span> --<span class="built_in">set</span> nameserver.persistence.storageClass=data-nfs-client --<span class="built_in">set</span> dashboard.auth.users[0].name=admin --<span class="built_in">set</span> dashboard.auth.users[0].password=admin123 --<span class="built_in">set</span> dashboard.auth.users[1].name=mengxiangge --<span class="built_in">set</span> dashboard.auth.users[1].password=admin123 --<span class="built_in">set</span> dashboard.service.type=NodePort --<span class="built_in">set</span> dashboard.service.nodePort=9877 --<span class="built_in">set</span> proxy.enabled=<span class="literal">false</span> --<span class="built_in">set</span> dashboard.image.repository=<span class="string">&quot;10.2.2.109:30003/middleware/rocketmq-dashboard&quot;</span></span><br></pre></td></tr></table></figure><p>查看容器事件，可以看到 rocketmq-dashboard 使用了我们定义的私有镜像地址。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-use-harbor-registry.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 自建机房 </tag>
            
            <tag> 镜像仓库 </tag>
            
            <tag> Harbor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KubeSphere 高可用集群搭建</title>
      <link href="/2024/10/15/cloudnative/KubeSphere%20%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
      <url>/2024/10/15/cloudnative/KubeSphere%20%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1>背景介绍</h1><p>笔者最近在部署自建机房，准备搭建 KubeSphere 集群，KubeSphere 官网的文档似乎有点小问题，所以用这篇文章来记录一下实际的操作，可以放心食用。</p><h1>准备环境</h1><p>假设有 4 台机器节点，规划如下：</p><ul><li>10.2.2.109：控制节点和 etcd</li><li>10.2.2.140：数据节点1</li><li>10.2.2.211：数据节点2</li><li>10.2.1.9: NFS 服务器，与 KubeSphere 集群隔离 IP 网段</li></ul><h2 id="DNS-初始化">DNS 初始化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">cat</span> /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"></span><br><span class="line">10.2.2.109      k3s-master      k3s-master.novalocal</span><br><span class="line">10.2.2.140      k3s-worker-01   k3s-worker-01.novalocal</span><br><span class="line">10.2.2.211      k3s-worker-02   k3s-worker-02.novalocal</span><br></pre></td></tr></table></figure><h2 id="NFS-初始化">NFS 初始化</h2><p>容器重启后数据会丢失，建议您提前部署好一个 NFS 存储，作为 Kubernetes 的默认存储类。</p><p>在所有服务器节点执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; yum install -y nfs-common</span><br><span class="line">&gt; yum upgrade -y</span><br><span class="line">&gt; vgcreate containervg /dev/vdb</span><br><span class="line">&gt; lvcreate -n container -l 100%FREE containervg</span><br><span class="line">&gt; mkfs.xfs /dev/mapper/containervg-container</span><br><span class="line">&gt; vi /etc/fstab</span><br><span class="line">/dev/mapper/containervg-container /var/lib/containerd xfs     defaults        0 0</span><br><span class="line">&gt; mount -a</span><br><span class="line">&gt; yum install -y socat conntrack ebtables ipset ipvsadm</span><br></pre></td></tr></table></figure><p>在服务器节点 10.2.1.9 执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&gt; parted /dev/sda</span><br><span class="line">Using /dev/sda</span><br><span class="line">Welcome to GNU Parted! Type <span class="string">&#x27;help&#x27;</span> to view a list of commands.</span><br><span class="line">(parted) <span class="built_in">print</span></span><br><span class="line">Model: DELL PERC H330 Mini (scsi)</span><br><span class="line">Disk /dev/sda: 6000GB</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags: pmbr_boot</span><br><span class="line"></span><br><span class="line">Number  Start   End     Size    File system  Name            Flags</span><br><span class="line"> 1      1049kB  3146kB  2097kB                               bios_grub</span><br><span class="line"> 2      3146kB  2151MB  2147MB  xfs</span><br><span class="line"> 3      2151MB  110GB   107GB                                lvm</span><br><span class="line"> 4      110GB   2000GB  1890GB               cinder-volumes  lvm</span><br><span class="line"> 5      2000GB  2500GB  500GB                image-volume    lvm</span><br><span class="line"> 6      2500GB  3000GB  500GB                backup-volume   lvm</span><br><span class="line"> 7      3000GB  3500GB  500GB                nova-volume     lvm</span><br><span class="line"></span><br><span class="line">(parted) mkpart k3s-nfs xfs 3500GB 5500GB</span><br><span class="line">(parted) <span class="built_in">set</span> 8 lvm on</span><br><span class="line">(parted) <span class="built_in">print</span></span><br><span class="line">Model: DELL PERC H330 Mini (scsi)</span><br><span class="line">Disk /dev/sda: 6000GB</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags: pmbr_boot</span><br><span class="line"></span><br><span class="line">Number  Start   End     Size    File system  Name            Flags</span><br><span class="line"> 1      1049kB  3146kB  2097kB                               bios_grub</span><br><span class="line"> 2      3146kB  2151MB  2147MB  xfs</span><br><span class="line"> 3      2151MB  110GB   107GB                                lvm</span><br><span class="line"> 4      110GB   2000GB  1890GB               cinder-volumes  lvm</span><br><span class="line"> 5      2000GB  2500GB  500GB                image-volume    lvm</span><br><span class="line"> 6      2500GB  3000GB  500GB                backup-volume   lvm</span><br><span class="line"> 7      3000GB  3500GB  500GB                nova-volume     lvm</span><br><span class="line"> 8      3500GB  5500GB  2000GB  xfs          k3s-nfs         lvm</span><br><span class="line"></span><br><span class="line">(parted) quit</span><br><span class="line">Information: You may need to update /etc/fstab.</span><br><span class="line"></span><br><span class="line">&gt; udevadm settle</span><br><span class="line">&gt; <span class="built_in">cat</span> /proc/partitions</span><br><span class="line">&gt; vgcreate k3snfsvg /dev/sda8</span><br><span class="line">&gt; lvcreate -n k3snfs -l 100%FREE k3snfsvg</span><br><span class="line">&gt; mkfs.xfs /dev/mapper/k3snfsvg-k3snfs</span><br><span class="line">&gt; <span class="built_in">mkdir</span> -p /nfs/kubesphere</span><br><span class="line">&gt; vim /etc/fstab</span><br><span class="line">/dev/mapper/k3snfsvg-k3snfs /nfs/kubesphere xfs     defaults        0 0</span><br><span class="line"></span><br><span class="line">&gt; systemctl daemon-reload</span><br><span class="line">&gt; mount -a</span><br><span class="line">&gt; <span class="built_in">df</span> -h</span><br><span class="line">&gt; vim /etc/exports</span><br><span class="line">/nfs/kubesphere   10.0.0.0/8(rw,<span class="built_in">sync</span>,no_root_squash)</span><br><span class="line"></span><br><span class="line">&gt; exportfs -rv</span><br><span class="line">&gt; showmount -e localhost</span><br><span class="line">&gt; <span class="built_in">cd</span> /nfs/kubesphere</span><br><span class="line">&gt; <span class="built_in">mkdir</span> &#123;rootfs,data,<span class="built_in">log</span>,config&#125;</span><br></pre></td></tr></table></figure><h2 id="Docker-初始化">Docker 初始化</h2><p>如果 Kubernetes 使用 Containered 作为容器运行时，可以跳过此步骤。</p><p>在所有服务器节点执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; yum install -y yum-utils</span><br><span class="line">&gt; yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">&gt; yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line">&gt; systemctl <span class="built_in">enable</span> docker.service</span><br><span class="line"><span class="comment"># 如果不支持 VPN，建议设置镜像源为 m.daocloud.io</span></span><br><span class="line">&gt; vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://m.daocloud.io&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">&gt; systemctl daemon-reload</span><br><span class="line">&gt; systemctl start docker.service</span><br><span class="line">&gt; systemctl status -l docker.service</span><br></pre></td></tr></table></figure><h1>部署流程</h1><h2 id="Master-节点">Master 节点</h2><p>在服务器节点 10.2.2.109 执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">export</span> KKZONE=cn</span><br><span class="line">&gt; <span class="built_in">mkdir</span> k3s</span><br><span class="line">&gt; <span class="built_in">cd</span> k3s</span><br><span class="line">&gt; curl -sfL https://get-kk.kubesphere.io | sh -</span><br><span class="line">&gt; sudo <span class="built_in">chmod</span> +x kk</span><br><span class="line">&gt; ./kk version --show-supported-k8s</span><br><span class="line">&gt; ./kk create config --with-kubernetes v1.24.17 --with-kubesphere v3.4.1</span><br><span class="line">&gt; <span class="built_in">cp</span> -p config-sample.yaml config-init.yaml</span><br><span class="line">&gt; vim config-init.yaml</span><br></pre></td></tr></table></figure><p>执行 vim nfs-client.yaml 创建 NFS 配置文件，内容如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubekey.kubesphere.io/v1alpha2</span><br><span class="line">kind: Cluster</span><br><span class="line">metadata:</span><br><span class="line">  name: puyi</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - &#123;name: k3s-master, address: 10.2.2.109, internalAddress: 10.2.2.109, user: root, password: <span class="string">&quot;k3s-master@123&quot;</span>&#125;</span><br><span class="line">  roleGroups:</span><br><span class="line">    etcd:</span><br><span class="line">    - k3s-master</span><br><span class="line">    control-plane:</span><br><span class="line">    - k3s-master</span><br><span class="line">    worker:</span><br><span class="line">    - k3s-master</span><br><span class="line">  controlPlaneEndpoint:</span><br><span class="line">    domain: lb.kubesphere.local</span><br><span class="line">    address: <span class="string">&quot;&quot;</span></span><br><span class="line">    port: 6443</span><br><span class="line">  kubernetes:</span><br><span class="line">    version: v1.24.17</span><br><span class="line">    clusterName: cluster.local</span><br><span class="line">    autoRenewCerts: <span class="literal">true</span></span><br><span class="line">    containerManager: containerd</span><br><span class="line">    maxPods: 220</span><br><span class="line">  etcd:</span><br><span class="line">    <span class="built_in">type</span>: kubekey</span><br><span class="line">  network:</span><br><span class="line">    plugin: calico</span><br><span class="line">    kubePodsCIDR: 10.233.64.0/18</span><br><span class="line">    kubeServiceCIDR: 10.233.0.0/18</span><br><span class="line">    multusCNI:</span><br><span class="line">      enabled: <span class="literal">false</span></span><br><span class="line">  registry:</span><br><span class="line">    privateRegistry: <span class="string">&quot;&quot;</span></span><br><span class="line">    namespaceOverride: <span class="string">&quot;&quot;</span></span><br><span class="line">    registryMirrors: []</span><br><span class="line">    insecureRegistries: []</span><br><span class="line"><span class="comment"># 这个依赖好像失效了，先注释掉</span></span><br><span class="line"><span class="comment">#  addons: </span></span><br><span class="line"><span class="comment">#  - name: nfs-rootfs</span></span><br><span class="line"><span class="comment">#    namespace: kube-system</span></span><br><span class="line"><span class="comment">#    sources:</span></span><br><span class="line"><span class="comment">#      chart:</span></span><br><span class="line"><span class="comment">#        name: nfs-rootfs-provisioner</span></span><br><span class="line"><span class="comment">#        repo: https://charts.kubesphere.io/main</span></span><br><span class="line"><span class="comment">#        valuesFile: /root/k3s/nfs-client.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: installer.kubesphere.io/v1alpha1</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">metadata:</span><br><span class="line">  name: ks-installer</span><br><span class="line">  namespace: kubesphere-system</span><br><span class="line">  labels:</span><br><span class="line">    version: v3.4.1</span><br><span class="line">spec:</span><br><span class="line">  persistence:</span><br><span class="line">    storageClass: <span class="string">&quot;&quot;</span></span><br><span class="line">  authentication:</span><br><span class="line">    jwtSecret: <span class="string">&quot;&quot;</span></span><br><span class="line">  local_registry: <span class="string">&quot;&quot;</span></span><br><span class="line">  etcd:</span><br><span class="line">    monitoring: <span class="literal">false</span></span><br><span class="line">    endpointIps: localhost</span><br><span class="line">    port: 2379</span><br><span class="line">    tlsEnable: <span class="literal">true</span></span><br><span class="line">  common:</span><br><span class="line">    core:</span><br><span class="line">      console:</span><br><span class="line">        enableMultiLogin: <span class="literal">true</span></span><br><span class="line">        port: 30880</span><br><span class="line">        <span class="built_in">type</span>: NodePort</span><br><span class="line">    redis:</span><br><span class="line">      enabled: <span class="literal">false</span></span><br><span class="line">      enableHA: <span class="literal">false</span></span><br><span class="line">      volumeSize: 2Gi</span><br><span class="line">    openldap:</span><br><span class="line">      enabled: <span class="literal">false</span></span><br><span class="line">      volumeSize: 2Gi</span><br><span class="line">    minio:</span><br><span class="line">      volumeSize: 20Gi</span><br><span class="line">    monitoring:</span><br><span class="line">      endpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span><br><span class="line">      GPUMonitoring:</span><br><span class="line">        enabled: <span class="literal">false</span></span><br><span class="line">    gpu:</span><br><span class="line">      kinds:</span><br><span class="line">      - resourceName: <span class="string">&quot;nvidia.com/gpu&quot;</span></span><br><span class="line">        resourceType: <span class="string">&quot;GPU&quot;</span></span><br><span class="line">        default: <span class="literal">true</span></span><br><span class="line">    es:</span><br><span class="line">      enabled: <span class="literal">false</span></span><br><span class="line">      logMaxAge: 7</span><br><span class="line">      auditingMaxAge: 2</span><br><span class="line">      eventMaxAge: 1</span><br><span class="line">      istioMaxAge: 4</span><br><span class="line">      elkPrefix: logstash</span><br><span class="line">      basicAuth:</span><br><span class="line">        enabled: <span class="literal">false</span></span><br><span class="line">        username: <span class="string">&quot;&quot;</span></span><br><span class="line">        password: <span class="string">&quot;&quot;</span></span><br><span class="line">      externalElasticsearchHost: <span class="string">&quot;&quot;</span></span><br><span class="line">      externalElasticsearchPort: <span class="string">&quot;&quot;</span></span><br><span class="line">    opensearch:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">      logMaxAge: 7</span><br><span class="line">      auditingMaxAge: 2</span><br><span class="line">      eventMaxAge: 1</span><br><span class="line">      istioMaxAge: 4</span><br><span class="line">      opensearchPrefix: whizard</span><br><span class="line">      basicAuth:</span><br><span class="line">        enabled: <span class="literal">true</span></span><br><span class="line">        username: <span class="string">&quot;admin&quot;</span></span><br><span class="line">        password: <span class="string">&quot;admin&quot;</span></span><br><span class="line">      externalOpensearchHost: <span class="string">&quot;&quot;</span></span><br><span class="line">      externalOpensearchPort: <span class="string">&quot;&quot;</span></span><br><span class="line">      dashboard:</span><br><span class="line">        enabled: <span class="literal">false</span></span><br><span class="line">  alerting:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  auditing:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  devops:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    jenkinsCpuReq: 1</span><br><span class="line">    jenkinsCpuLim: 1</span><br><span class="line">    jenkinsMemoryReq: 4Gi</span><br><span class="line">    jenkinsMemoryLim: 4Gi</span><br><span class="line">    jenkinsVolumeSize: 30Gi</span><br><span class="line">  events:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    ruler:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">      replicas: 2</span><br><span class="line">  logging:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    logsidecar:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">      replicas: 2</span><br><span class="line">  metrics_server:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  monitoring:</span><br><span class="line">    storageClass: <span class="string">&quot;&quot;</span></span><br><span class="line">    node_exporter:</span><br><span class="line">      port: 9100</span><br><span class="line">    gpu:</span><br><span class="line">      nvidia_dcgm_exporter:</span><br><span class="line">        enabled: <span class="literal">false</span></span><br><span class="line">  multicluster:</span><br><span class="line">    clusterRole: none</span><br><span class="line">  network:</span><br><span class="line">    networkpolicy:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">    ippool:</span><br><span class="line">      <span class="built_in">type</span>: calico</span><br><span class="line">    topology:</span><br><span class="line">      <span class="built_in">type</span>: weave-scope</span><br><span class="line">  openpitrix:</span><br><span class="line">    store:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">  servicemesh:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">    istio:</span><br><span class="line">      components:</span><br><span class="line">        ingressGateways:</span><br><span class="line">        - name: istio-ingressgateway</span><br><span class="line">          enabled: <span class="literal">false</span></span><br><span class="line">        cni:</span><br><span class="line">          enabled: <span class="literal">false</span></span><br><span class="line">  edgeruntime:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">    kubeedge:</span><br><span class="line">      enabled: <span class="literal">false</span></span><br><span class="line">      cloudCore:</span><br><span class="line">        cloudHub:</span><br><span class="line">          advertiseAddress:</span><br><span class="line">            - <span class="string">&quot;&quot;</span></span><br><span class="line">        service:</span><br><span class="line">          cloudhubNodePort: <span class="string">&quot;30000&quot;</span></span><br><span class="line">          cloudhubQuicNodePort: <span class="string">&quot;30001&quot;</span></span><br><span class="line">          cloudhubHttpsNodePort: <span class="string">&quot;30002&quot;</span></span><br><span class="line">          cloudstreamNodePort: <span class="string">&quot;30003&quot;</span></span><br><span class="line">          tunnelNodePort: <span class="string">&quot;30004&quot;</span></span><br><span class="line">      iptables-manager:</span><br><span class="line">        enabled: <span class="literal">true</span></span><br><span class="line">        mode: <span class="string">&quot;external&quot;</span></span><br><span class="line">  gatekeeper:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  terminal:</span><br><span class="line">    <span class="built_in">timeout</span>: 600</span><br><span class="line">  zone: <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>修改后按 ESC 输入 <code>:wq</code> 保存退出，接着使用 KubeKey 开始安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br></pre></td><td class="code"><pre><span class="line">&gt; egrep -v <span class="string">&#x27;#|^$&#x27;</span> config-init.yaml</span><br><span class="line">&gt; ./kk create cluster -f config-init.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> _   __      _          _   __</span><br><span class="line">| | / /     | |        | | / /</span><br><span class="line">| |/ / _   _| |__   ___| |/ /  ___ _   _</span><br><span class="line">|    \| | | | <span class="string">&#x27;_ \ / _ \    \ / _ \ | | |</span></span><br><span class="line"><span class="string">| |\  \ |_| | |_) |  __/ |\  \  __/ |_| |</span></span><br><span class="line"><span class="string">\_| \_/\__,_|_.__/ \___\_| \_/\___|\__, |</span></span><br><span class="line"><span class="string">                                    __/ |</span></span><br><span class="line"><span class="string">                                   |___/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">13:39:30 CST [GreetingsModule] Greetings</span></span><br><span class="line"><span class="string">13:39:30 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">Greetings, KubeKey!</span></span><br><span class="line"><span class="string">13:39:30 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:39:30 CST [NodePreCheckModule] A pre-check on nodes</span></span><br><span class="line"><span class="string">13:39:30 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:39:30 CST [ConfirmModule] Display confirmation form</span></span><br><span class="line"><span class="string">+------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string">| name       | sudo | curl | openssl | ebtables | socat | ipset | ipvsadm | conntrack | chrony | docker | containerd | nfs client | ceph client | glusterfs client | time         |</span></span><br><span class="line"><span class="string">+------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string">| k3s-master | y    | y    | y       | y        | y     | y     | y       | y         | y      |        | v1.7.13    | y          |             |                  | CST 13:39:30 |</span></span><br><span class="line"><span class="string">+------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a simple check of your environment.</span></span><br><span class="line"><span class="string">Before installation, ensure that your machines meet all requirements specified at</span></span><br><span class="line"><span class="string">https://github.com/kubesphere/kubekey#requirements-and-recommendations</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Install k8s with specify version:  v1.24.17</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Continue this installation? [yes/no]: yes</span></span><br><span class="line"><span class="string">13:39:37 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">13:39:37 CST [NodeBinariesModule] Download installation binaries</span></span><br><span class="line"><span class="string">13:39:37 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubeadm v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 43.4M  100 43.4M    0     0   900k      0  0:00:49  0:00:49 --:--:-- 1076k</span></span><br><span class="line"><span class="string">13:40:27 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubelet v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100  112M  100  112M    0     0   971k      0  0:01:58  0:01:58 --:--:-- 1063k</span></span><br><span class="line"><span class="string">13:42:26 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubectl v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 44.5M  100 44.5M    0     0   907k      0  0:00:50  0:00:50 --:--:-- 1083k</span></span><br><span class="line"><span class="string">13:43:16 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 helm v3.14.3 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 48.3M  100 48.3M    0     0   914k      0  0:00:54  0:00:54 --:--:-- 1076k</span></span><br><span class="line"><span class="string">13:44:11 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubecni v1.2.0 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 38.6M  100 38.6M    0     0   900k      0  0:00:43  0:00:43 --:--:-- 1173k</span></span><br><span class="line"><span class="string">13:44:55 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 crictl v1.29.0 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 23.2M  100 23.2M    0     0   819k      0  0:00:29  0:00:29 --:--:-- 1080k</span></span><br><span class="line"><span class="string">13:45:24 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 etcd v3.5.13 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 19.1M  100 19.1M    0     0   778k      0  0:00:25  0:00:25 --:--:-- 1036k</span></span><br><span class="line"><span class="string">13:45:49 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 containerd 1.7.13 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 45.7M  100 45.7M    0     0   908k      0  0:00:51  0:00:51 --:--:-- 1079k</span></span><br><span class="line"><span class="string">13:46:41 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 runc v1.1.12 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 10.2M  100 10.2M    0     0   658k      0  0:00:15  0:00:15 --:--:-- 1079k</span></span><br><span class="line"><span class="string">13:46:57 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 calicoctl v3.27.4 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 61.3M  100 61.3M    0     0   939k      0  0:01:06  0:01:06 --:--:-- 1101k</span></span><br><span class="line"><span class="string">13:48:04 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">13:48:04 CST [ConfigureOSModule] Get OS release</span></span><br><span class="line"><span class="string">13:48:04 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:04 CST [ConfigureOSModule] Prepare to init OS</span></span><br><span class="line"><span class="string">13:48:05 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:05 CST [ConfigureOSModule] Generate init os script</span></span><br><span class="line"><span class="string">13:48:05 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:05 CST [ConfigureOSModule] Exec init os script</span></span><br><span class="line"><span class="string">13:48:07 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">setenforce: SELinux is disabled</span></span><br><span class="line"><span class="string">Disabled</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_source_route = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_redirects = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.icmp_echo_ignore_broadcasts = 1</span></span><br><span class="line"><span class="string">net.ipv4.icmp_ignore_bogus_error_responses = 1</span></span><br><span class="line"><span class="string">kernel.sched_child_runs_first = 1</span></span><br><span class="line"><span class="string">kernel.sched_latency_ns = 80000000</span></span><br><span class="line"><span class="string">kernel.sched_migration_cost_ns = 125000</span></span><br><span class="line"><span class="string">kernel.sched_min_granularity_ns = 40000000</span></span><br><span class="line"><span class="string">kernel.sched_wakeup_granularity_ns = 3750000</span></span><br><span class="line"><span class="string">kernel.sched_nr_migrate = 128</span></span><br><span class="line"><span class="string">kernel.pid_max = 65535</span></span><br><span class="line"><span class="string">kernel.msgmax = 2097152</span></span><br><span class="line"><span class="string">kernel.msgmnb = 4194304</span></span><br><span class="line"><span class="string">kernel.shmmni = 32768</span></span><br><span class="line"><span class="string">kernel.sem = 2000 256000 256 1024</span></span><br><span class="line"><span class="string">vm.overcommit_memory = 0</span></span><br><span class="line"><span class="string">vm.max_map_count = 262144</span></span><br><span class="line"><span class="string">vm.swappiness = 0</span></span><br><span class="line"><span class="string">vm.dirty_background_ratio = 40</span></span><br><span class="line"><span class="string">vm.dirty_ratio = 50</span></span><br><span class="line"><span class="string">fs.aio-max-nr = 262144</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances = 524288</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches = 524288</span></span><br><span class="line"><span class="string">net.core.rps_sock_flow_entries = 65536</span></span><br><span class="line"><span class="string">net.core.dev_weight = 1024</span></span><br><span class="line"><span class="string">net.core.busy_poll = 200</span></span><br><span class="line"><span class="string">net.core.busy_read = 200</span></span><br><span class="line"><span class="string">net.ipv4.tcp_moderate_rcvbuf = 1</span></span><br><span class="line"><span class="string">net.core.somaxconn = 32768</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 65535</span></span><br><span class="line"><span class="string">net.core.netdev_budget = 4800</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1 = 512</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2 = 2048</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3 = 4096</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.unres_qlen_bytes = 262144</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max = 1048576</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_tcp_timeout_established = 300</span></span><br><span class="line"><span class="string">sysctl: setting key &quot;net.netfilter.nf_conntrack_buckets&quot;: No such file or directory</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_high_thresh = 16777216</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_low_thresh = 12582912</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.udp_rmem_min = 131072</span></span><br><span class="line"><span class="string">net.ipv4.udp_wmem_min = 131072</span></span><br><span class="line"><span class="string">net.core.rmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.rmem_max = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_max = 33554432</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 5</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 600</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 10000 65000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-arptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_reserved_ports = 30000-32767</span></span><br><span class="line"><span class="string">net.ipv4.tcp_retries2 = 15</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 65535</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl = 30</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 10</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_ignore = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_ignore = 1</span></span><br><span class="line"><span class="string">fs.pipe-max-size = 4194304</span></span><br><span class="line"><span class="string">kernel.watchdog_thresh = 5</span></span><br><span class="line"><span class="string">kernel.hung_task_timeout_secs = 5</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.default.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.lo.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.forwarding = 1</span></span><br><span class="line"><span class="string">13:48:07 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:07 CST [ConfigureOSModule] configure the ntp server for each node</span></span><br><span class="line"><span class="string">13:48:07 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:07 CST [KubernetesStatusModule] Get kubernetes cluster status</span></span><br><span class="line"><span class="string">13:48:08 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Sync containerd binaries</span></span><br><span class="line"><span class="string">13:48:08 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Generate containerd service</span></span><br><span class="line"><span class="string">13:48:08 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Generate containerd config</span></span><br><span class="line"><span class="string">13:48:08 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Enable containerd</span></span><br><span class="line"><span class="string">13:48:08 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Sync crictl binaries</span></span><br><span class="line"><span class="string">13:48:08 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Generate crictl config</span></span><br><span class="line"><span class="string">13:48:08 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [PullModule] Start to pull images on all nodes</span></span><br><span class="line"><span class="string">13:48:08 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.7</span></span><br><span class="line"><span class="string">13:48:08 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-apiserver:v1.24.17</span></span><br><span class="line"><span class="string">13:48:08 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controller-manager:v1.24.17</span></span><br><span class="line"><span class="string">13:48:08 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-scheduler:v1.24.17</span></span><br><span class="line"><span class="string">13:48:08 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-proxy:v1.24.17</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.8.6</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/k8s-dns-node-cache:1.22.20</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controllers:v3.27.4</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.27.4</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/node:v3.27.4</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pod2daemon-flexvol:v3.27.4</span></span><br><span class="line"><span class="string">13:48:09 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:09 CST [ETCDPreCheckModule] Get etcd status</span></span><br><span class="line"><span class="string">13:48:09 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:09 CST [CertsModule] Fetch etcd certs</span></span><br><span class="line"><span class="string">13:48:09 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:09 CST [CertsModule] Generate etcd Certs</span></span><br><span class="line"><span class="string">[certs] Generating &quot;ca&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] admin-k3s-master serving cert is signed for DNS names [etcd etcd.kube-system etcd.kube-system.svc etcd.kube-system.svc.cluster.local k3s-master lb.kubesphere.local localhost] and IPs [127.0.0.1 ::1 10.2.2.109]</span></span><br><span class="line"><span class="string">[certs] member-k3s-master serving cert is signed for DNS names [etcd etcd.kube-system etcd.kube-system.svc etcd.kube-system.svc.cluster.local k3s-master lb.kubesphere.local localhost] and IPs [127.0.0.1 ::1 10.2.2.109]</span></span><br><span class="line"><span class="string">[certs] node-k3s-master serving cert is signed for DNS names [etcd etcd.kube-system etcd.kube-system.svc etcd.kube-system.svc.cluster.local k3s-master lb.kubesphere.local localhost] and IPs [127.0.0.1 ::1 10.2.2.109]</span></span><br><span class="line"><span class="string">13:48:11 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">13:48:11 CST [CertsModule] Synchronize certs file</span></span><br><span class="line"><span class="string">13:48:12 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:12 CST [CertsModule] Synchronize certs file to master</span></span><br><span class="line"><span class="string">13:48:12 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:12 CST [InstallETCDBinaryModule] Install etcd using binary</span></span><br><span class="line"><span class="string">13:48:14 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [InstallETCDBinaryModule] Generate etcd service</span></span><br><span class="line"><span class="string">13:48:14 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [InstallETCDBinaryModule] Generate access address</span></span><br><span class="line"><span class="string">13:48:14 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [ETCDConfigureModule] Health check on exist etcd</span></span><br><span class="line"><span class="string">13:48:14 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [ETCDConfigureModule] Generate etcd.env config on new etcd</span></span><br><span class="line"><span class="string">13:48:14 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [ETCDConfigureModule] Refresh etcd.env config on all etcd</span></span><br><span class="line"><span class="string">13:48:14 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [ETCDConfigureModule] Restart etcd</span></span><br><span class="line"><span class="string">13:48:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:19 CST [ETCDConfigureModule] Health check on all etcd</span></span><br><span class="line"><span class="string">13:48:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:19 CST [ETCDConfigureModule] Refresh etcd.env config to exist mode on all etcd</span></span><br><span class="line"><span class="string">13:48:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:19 CST [ETCDConfigureModule] Health check on all etcd</span></span><br><span class="line"><span class="string">13:48:20 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:20 CST [ETCDBackupModule] Backup etcd data regularly</span></span><br><span class="line"><span class="string">13:48:20 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:20 CST [ETCDBackupModule] Generate backup ETCD service</span></span><br><span class="line"><span class="string">13:48:20 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:20 CST [ETCDBackupModule] Generate backup ETCD timer</span></span><br><span class="line"><span class="string">13:48:20 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:20 CST [ETCDBackupModule] Enable backup etcd service</span></span><br><span class="line"><span class="string">13:48:20 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:20 CST [InstallKubeBinariesModule] Synchronize kubernetes binaries</span></span><br><span class="line"><span class="string">13:48:27 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:27 CST [InstallKubeBinariesModule] Change kubelet mode</span></span><br><span class="line"><span class="string">13:48:27 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:27 CST [InstallKubeBinariesModule] Generate kubelet service</span></span><br><span class="line"><span class="string">13:48:27 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:27 CST [InstallKubeBinariesModule] Enable kubelet service</span></span><br><span class="line"><span class="string">13:48:28 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:28 CST [InstallKubeBinariesModule] Generate kubelet env</span></span><br><span class="line"><span class="string">13:48:28 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:28 CST [InitKubernetesModule] Generate kubeadm config</span></span><br><span class="line"><span class="string">13:48:28 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:28 CST [InitKubernetesModule] Generate audit policy</span></span><br><span class="line"><span class="string">13:48:28 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:28 CST [InitKubernetesModule] Generate audit webhook</span></span><br><span class="line"><span class="string">13:48:28 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:28 CST [InitKubernetesModule] Init cluster using kubeadm</span></span><br><span class="line"><span class="string">13:48:51 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">W1009 13:48:28.956892   11930 utils.go:69] The recommended value for &quot;clusterDNS&quot; in &quot;KubeletConfiguration&quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]</span></span><br><span class="line"><span class="string">[init] Using Kubernetes version: v1.24.17</span></span><br><span class="line"><span class="string">[preflight] Running pre-flight checks</span></span><br><span class="line"><span class="string">[preflight] Pulling images required for setting up a Kubernetes cluster</span></span><br><span class="line"><span class="string">[preflight] This might take a minute or two, depending on the speed of your internet connection</span></span><br><span class="line"><span class="string">[preflight] You can also perform this action in beforehand using &#x27;</span>kubeadm config images pull<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[certs] Using certificateDir folder &quot;/etc/kubernetes/pki&quot;</span></span><br><span class="line"><span class="string">[certs] Generating &quot;ca&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] Generating &quot;apiserver&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] apiserver serving cert is signed for DNS names [k3s-master k3s-master.cluster.local kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local lb.kubesphere.local localhost] and IPs [10.233.0.1 10.2.2.109 127.0.0.1]</span></span><br><span class="line"><span class="string">[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] Generating &quot;front-proxy-ca&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] Generating &quot;front-proxy-client&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] External etcd mode: Skipping etcd/ca certificate authority generation</span></span><br><span class="line"><span class="string">[certs] External etcd mode: Skipping etcd/server certificate generation</span></span><br><span class="line"><span class="string">[certs] External etcd mode: Skipping etcd/peer certificate generation</span></span><br><span class="line"><span class="string">[certs] External etcd mode: Skipping etcd/healthcheck-client certificate generation</span></span><br><span class="line"><span class="string">[certs] External etcd mode: Skipping apiserver-etcd-client certificate generation</span></span><br><span class="line"><span class="string">[certs] Generating &quot;sa&quot; key and public key</span></span><br><span class="line"><span class="string">[kubeconfig] Using kubeconfig folder &quot;/etc/kubernetes&quot;</span></span><br><span class="line"><span class="string">[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="string">[kubeconfig] Writing &quot;kubelet.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="string">[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="string">[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="string">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line"><span class="string">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"><span class="string">[kubelet-start] Starting the kubelet</span></span><br><span class="line"><span class="string">[control-plane] Using manifest folder &quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line"><span class="string">[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;</span></span><br><span class="line"><span class="string">[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;</span></span><br><span class="line"><span class="string">[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;</span></span><br><span class="line"><span class="string">[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;/etc/kubernetes/manifests&quot;. This can take up to 4m0s</span></span><br><span class="line"><span class="string">[apiclient] All control plane components are healthy after 17.503847 seconds</span></span><br><span class="line"><span class="string">[upload-config] Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</span></span><br><span class="line"><span class="string">[kubelet] Creating a ConfigMap &quot;kubelet-config&quot; in namespace kube-system with the configuration for the kubelets in the cluster</span></span><br><span class="line"><span class="string">[upload-certs] Skipping phase. Please see --upload-certs</span></span><br><span class="line"><span class="string">[mark-control-plane] Marking the node k3s-master as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span></span><br><span class="line"><span class="string">[mark-control-plane] Marking the node k3s-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule node-role.kubernetes.io/control-plane:NoSchedule]</span></span><br><span class="line"><span class="string">[bootstrap-token] Using token: kvwh7d.tiuyjnwfbc8bqyt7</span></span><br><span class="line"><span class="string">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span></span><br><span class="line"><span class="string">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span></span><br><span class="line"><span class="string">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span></span><br><span class="line"><span class="string">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span></span><br><span class="line"><span class="string">[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span></span><br><span class="line"><span class="string">[bootstrap-token] Creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</span></span><br><span class="line"><span class="string">[kubelet-finalize] Updating &quot;/etc/kubernetes/kubelet.conf&quot; to point to a rotatable kubelet client certificate and key</span></span><br><span class="line"><span class="string">[addons] Applied essential addon: CoreDNS</span></span><br><span class="line"><span class="string">[addons] Applied essential addon: kube-proxy</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Your Kubernetes control-plane has initialized successfully!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To start using your cluster, you need to run the following as a regular user:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  mkdir -p $HOME/.kube</span></span><br><span class="line"><span class="string">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></span><br><span class="line"><span class="string">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Alternatively, if you are the root user, you can run:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  export KUBECONFIG=/etc/kubernetes/admin.conf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You should now deploy a pod network to the cluster.</span></span><br><span class="line"><span class="string">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span></span><br><span class="line"><span class="string">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can now join any number of control-plane nodes by copying certificate authorities</span></span><br><span class="line"><span class="string">and service account keys on each node and then running the following as root:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  kubeadm join lb.kubesphere.local:6443 --token kvwh7d.tiuyjnwfbc8bqyt7 \</span></span><br><span class="line"><span class="string">        --discovery-token-ca-cert-hash sha256:1f5b22071a80e7c647e441c29d0569b391de0dd15d2065c4283ee4c744a1327c \</span></span><br><span class="line"><span class="string">        --control-plane</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Then you can join any number of worker nodes by running the following on each as root:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">kubeadm join lb.kubesphere.local:6443 --token kvwh7d.tiuyjnwfbc8bqyt7 \</span></span><br><span class="line"><span class="string">        --discovery-token-ca-cert-hash sha256:1f5b22071a80e7c647e441c29d0569b391de0dd15d2065c4283ee4c744a1327c</span></span><br><span class="line"><span class="string">13:48:51 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:51 CST [InitKubernetesModule] Copy admin.conf to ~/.kube/config</span></span><br><span class="line"><span class="string">13:48:51 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:51 CST [InitKubernetesModule] Remove master taint</span></span><br><span class="line"><span class="string">13:48:53 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-master untainted</span></span><br><span class="line"><span class="string">13:48:53 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-master untainted</span></span><br><span class="line"><span class="string">13:48:53 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:53 CST [ClusterDNSModule] Generate coredns configmap</span></span><br><span class="line"><span class="string">13:48:53 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:53 CST [ClusterDNSModule] Apply coredns configmap</span></span><br><span class="line"><span class="string">13:48:54 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">Warning: resource configmaps/coredns is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span></span><br><span class="line"><span class="string">configmap/coredns configured</span></span><br><span class="line"><span class="string">13:48:54 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:54 CST [ClusterDNSModule] Generate coredns manifests</span></span><br><span class="line"><span class="string">13:48:54 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:54 CST [ClusterDNSModule] Deploy coredns</span></span><br><span class="line"><span class="string">13:48:54 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">service &quot;kube-dns&quot; deleted</span></span><br><span class="line"><span class="string">13:48:55 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">Warning: resource clusterroles/system:coredns is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/system:coredns configured</span></span><br><span class="line"><span class="string">service/coredns created</span></span><br><span class="line"><span class="string">Warning: resource deployments/coredns is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span></span><br><span class="line"><span class="string">deployment.apps/coredns configured</span></span><br><span class="line"><span class="string">13:48:55 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">deployment.apps/coredns restarted</span></span><br><span class="line"><span class="string">13:48:55 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:55 CST [ClusterDNSModule] Generate nodelocaldns configmap</span></span><br><span class="line"><span class="string">13:48:55 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:55 CST [ClusterDNSModule] Apply nodelocaldns configmap</span></span><br><span class="line"><span class="string">13:48:56 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">configmap/nodelocaldns created</span></span><br><span class="line"><span class="string">13:48:56 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:56 CST [ClusterDNSModule] Generate nodelocaldns</span></span><br><span class="line"><span class="string">13:48:56 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:56 CST [ClusterDNSModule] Deploy nodelocaldns</span></span><br><span class="line"><span class="string">13:48:56 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">serviceaccount/nodelocaldns created</span></span><br><span class="line"><span class="string">daemonset.apps/nodelocaldns created</span></span><br><span class="line"><span class="string">13:48:56 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:56 CST [KubernetesStatusModule] Get kubernetes cluster status</span></span><br><span class="line"><span class="string">13:48:56 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">v1.24.17</span></span><br><span class="line"><span class="string">13:48:56 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">k3s-master   v1.24.17   [map[address:10.2.2.109 type:InternalIP] map[address:k3s-master type:Hostname]]</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">W1009 13:48:57.018811   13416 utils.go:69] The recommended value for &quot;clusterDNS&quot; in &quot;KubeletConfiguration&quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]</span></span><br><span class="line"><span class="string">[upload-certs] Storing the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace</span></span><br><span class="line"><span class="string">[upload-certs] Using certificate key:</span></span><br><span class="line"><span class="string">64625b6043ef538848338b08d634ec2fdb933288b8b816ce928214b0398da1fa</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">gda258.973k95vadvzwx5y1</span></span><br><span class="line"><span class="string">13:48:57 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Generate kubeadm config</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Generate audit policy</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Generate audit webhook</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Join control-plane node</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Join worker node</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Copy admin.conf to ~/.kube/config</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Remove master taint</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Add worker label to all nodes</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-master labeled</span></span><br><span class="line"><span class="string">13:48:57 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [DeployNetworkPluginModule] Generate calico</span></span><br><span class="line"><span class="string">13:48:58 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:58 CST [DeployNetworkPluginModule] Deploy calico</span></span><br><span class="line"><span class="string">13:49:00 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">poddisruptionbudget.policy/calico-kube-controllers created</span></span><br><span class="line"><span class="string">serviceaccount/calico-kube-controllers created</span></span><br><span class="line"><span class="string">serviceaccount/calico-node created</span></span><br><span class="line"><span class="string">serviceaccount/calico-cni-plugin created</span></span><br><span class="line"><span class="string">configmap/calico-config created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/bgpfilters.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/calico-node created</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/calico-cni-plugin created</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/calico-cni-plugin created</span></span><br><span class="line"><span class="string">daemonset.apps/calico-node created</span></span><br><span class="line"><span class="string">deployment.apps/calico-kube-controllers created</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [ConfigureKubernetesModule] Configure kubernetes</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [ChownModule] Chown user $HOME/.kube dir</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [AutoRenewCertsModule] Generate k8s certs renew script</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [AutoRenewCertsModule] Generate k8s certs renew service</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [AutoRenewCertsModule] Generate k8s certs renew timer</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [AutoRenewCertsModule] Enable k8s certs renew service</span></span><br><span class="line"><span class="string">13:49:01 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:01 CST [SaveKubeConfigModule] Save kube config as a configmap</span></span><br><span class="line"><span class="string">13:49:01 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">13:49:01 CST [AddonsModule] Install addons</span></span><br><span class="line"><span class="string">13:49:01 CST message: [LocalHost]</span></span><br><span class="line"><span class="string">[0/0] enabled addons</span></span><br><span class="line"><span class="string">13:49:01 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">13:49:01 CST [DeployStorageClassModule] Generate OpenEBS manifest</span></span><br><span class="line"><span class="string">13:49:01 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:01 CST [DeployStorageClassModule] Deploy OpenEBS as cluster default StorageClass</span></span><br><span class="line"><span class="string">13:49:02 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:02 CST [DeployKubeSphereModule] Generate KubeSphere ks-installer crd manifests</span></span><br><span class="line"><span class="string">13:49:02 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:02 CST [DeployKubeSphereModule] Apply ks-installer</span></span><br><span class="line"><span class="string">13:49:03 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">namespace/kubesphere-system created</span></span><br><span class="line"><span class="string">serviceaccount/ks-installer created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/clusterconfigurations.installer.kubesphere.io created</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/ks-installer created</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/ks-installer created</span></span><br><span class="line"><span class="string">deployment.apps/ks-installer created</span></span><br><span class="line"><span class="string">13:49:03 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:03 CST [DeployKubeSphereModule] Add config to ks-installer manifests</span></span><br><span class="line"><span class="string">13:49:03 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:03 CST [DeployKubeSphereModule] Create the kubesphere namespace</span></span><br><span class="line"><span class="string">13:49:03 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:03 CST [DeployKubeSphereModule] Setup ks-installer config</span></span><br><span class="line"><span class="string">13:49:03 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kube-etcd-client-certs created</span></span><br><span class="line"><span class="string">13:49:03 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:03 CST [DeployKubeSphereModule] Apply ks-installer</span></span><br><span class="line"><span class="string">13:49:06 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">namespace/kubesphere-system unchanged</span></span><br><span class="line"><span class="string">serviceaccount/ks-installer unchanged</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/clusterconfigurations.installer.kubesphere.io unchanged</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/ks-installer unchanged</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/ks-installer unchanged</span></span><br><span class="line"><span class="string">deployment.apps/ks-installer unchanged</span></span><br><span class="line"><span class="string">clusterconfiguration.installer.kubesphere.io/ks-installer created</span></span><br><span class="line"><span class="string">13:49:06 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">#####################################################</span></span><br><span class="line"><span class="string">###              Welcome to KubeSphere!           ###</span></span><br><span class="line"><span class="string">#####################################################</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Console: http://10.2.2.109:30880</span></span><br><span class="line"><span class="string">Account: admin</span></span><br><span class="line"><span class="string">Password: P@88w0rd</span></span><br><span class="line"><span class="string">NOTES：</span></span><br><span class="line"><span class="string">  1. After you log into the console, please check the</span></span><br><span class="line"><span class="string">     monitoring status of service components in</span></span><br><span class="line"><span class="string">     &quot;Cluster Management&quot;. If any service is not</span></span><br><span class="line"><span class="string">     ready, please wait patiently until all components</span></span><br><span class="line"><span class="string">     are up and running.</span></span><br><span class="line"><span class="string">  2. Please change the default password after login.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#####################################################</span></span><br><span class="line"><span class="string">https://kubesphere.io             2024-10-09 14:08:38</span></span><br><span class="line"><span class="string">#####################################################</span></span><br><span class="line"><span class="string">14:08:40 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">14:08:40 CST Pipeline[CreateClusterPipeline] execute successfully</span></span><br><span class="line"><span class="string">Installation is complete.</span></span><br></pre></td></tr></table></figure><p>安装完成，通过以下命令检查安装是否正常。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l <span class="string">&#x27;app in (ks-install, ks-installer)&#x27;</span> -o jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -f</span><br><span class="line">&gt; <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">&gt; kubectl get event -A -w</span><br><span class="line">&gt; kubectl get pod -A -w</span><br><span class="line">&gt; kubectl get sc</span><br></pre></td></tr></table></figure><p>访问 KubeSphere 控制台，界面如下。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-install-master.png" alt=""></p><h2 id="Worker-节点">Worker 节点</h2><p>在服务器节点 10.2.2.140 和 10.2.2.211 执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">export</span> KKZONE=cn</span><br><span class="line">&gt; rsync -aAvz -e <span class="string">&#x27;ssh -p 22&#x27;</span> 10.2.2.109:/root/k3s /root/</span><br><span class="line">&gt; <span class="built_in">cd</span> k3s</span><br><span class="line">&gt; vim config-init.yaml</span><br><span class="line"><span class="comment"># 修改关键内容</span></span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - &#123;name: k3s-master, address: 10.2.2.109, internalAddress: 10.2.2.109, user: root, password: <span class="string">&quot;k3s-master@123&quot;</span>&#125;</span><br><span class="line">  - &#123;name: k3s-worker-01, address: 10.2.2.140, internalAddress: 10.2.2.140, user: root, password: <span class="string">&quot;k3s-worker01@123&quot;</span>&#125;</span><br><span class="line">  - &#123;name: k3s-worker-02, address: 10.2.2.211, internalAddress: 10.2.2.211, user: root, password: <span class="string">&quot;k3s-worker02@123&quot;</span>&#125;</span><br><span class="line">  roleGroups:</span><br><span class="line">    etcd:</span><br><span class="line">    - k3s-master</span><br><span class="line">    control-plane:</span><br><span class="line">    - k3s-master</span><br><span class="line">    worker:</span><br><span class="line">    - k3s-master</span><br><span class="line">    - k3s-worker-01</span><br><span class="line">    - k3s-worker-02</span><br></pre></td></tr></table></figure><p>使用 KubeKey 安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br></pre></td><td class="code"><pre><span class="line">&gt; ./kk add nodes -f config-init.yaml</span><br><span class="line"></span><br><span class="line">_   __      _          _   __</span><br><span class="line">| | / /     | |        | | / /</span><br><span class="line">| |/ / _   _| |__   ___| |/ /  ___ _   _</span><br><span class="line">|    \| | | | <span class="string">&#x27;_ \ / _ \    \ / _ \ | | |</span></span><br><span class="line"><span class="string">| |\  \ |_| | |_) |  __/ |\  \  __/ |_| |</span></span><br><span class="line"><span class="string">\_| \_/\__,_|_.__/ \___\_| \_/\___|\__, |</span></span><br><span class="line"><span class="string">                                    __/ |</span></span><br><span class="line"><span class="string">                                   |___/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">15:26:05 CST [GreetingsModule] Greetings</span></span><br><span class="line"><span class="string">15:26:05 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">Greetings, KubeKey!</span></span><br><span class="line"><span class="string">15:26:06 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">Greetings, KubeKey!</span></span><br><span class="line"><span class="string">15:26:06 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">Greetings, KubeKey!</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:26:06 CST [NodePreCheckModule] A pre-check on nodes</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:26:06 CST [ConfirmModule] Display confirmation form</span></span><br><span class="line"><span class="string">+---------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string">| name          | sudo | curl | openssl | ebtables | socat | ipset | ipvsadm | conntrack | chrony | docker | containerd | nfs client | ceph client | glusterfs client | time         |</span></span><br><span class="line"><span class="string">+---------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string">| k3s-master    | y    | y    | y       | y        | y     | y     | y       | y         | y      |        | v1.7.13    | y          |             |                  | CST 15:26:06 |</span></span><br><span class="line"><span class="string">| k3s-worker-01 | y    | y    | y       | y        | y     | y     | y       | y         | y      |        | v1.7.13    | y          |             |                  | CST 15:26:06 |</span></span><br><span class="line"><span class="string">| k3s-worker-02 | y    | y    | y       | y        | y     | y     | y       | y         | y      |        | v1.7.13    | y          |             |                  | CST 15:26:06 |</span></span><br><span class="line"><span class="string">+---------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a simple check of your environment.</span></span><br><span class="line"><span class="string">Before installation, ensure that your machines meet all requirements specified at</span></span><br><span class="line"><span class="string">https://github.com/kubesphere/kubekey#requirements-and-recommendations</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Install k8s with specify version:  v1.24.17</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Continue this installation? [yes/no]: yes</span></span><br><span class="line"><span class="string">15:26:08 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">15:26:08 CST [NodeBinariesModule] Download installation binaries</span></span><br><span class="line"><span class="string">15:26:08 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubeadm v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 43.4M  100 43.4M    0     0   904k      0  0:00:49  0:00:49 --:--:-- 1084k</span></span><br><span class="line"><span class="string">15:26:57 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubelet v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100  112M  100  112M    0     0   973k      0  0:01:58  0:01:58 --:--:-- 1088k</span></span><br><span class="line"><span class="string">15:28:56 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubectl v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 44.5M  100 44.5M    0     0   910k      0  0:00:50  0:00:50 --:--:-- 1087k</span></span><br><span class="line"><span class="string">15:29:47 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 helm v3.14.3 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 48.3M  100 48.3M    0     0   915k      0  0:00:54  0:00:54 --:--:-- 1076k</span></span><br><span class="line"><span class="string">15:30:41 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubecni v1.2.0 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 38.6M  100 38.6M    0     0   893k      0  0:00:44  0:00:44 --:--:-- 1088k</span></span><br><span class="line"><span class="string">15:31:25 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 crictl v1.29.0 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 23.2M  100 23.2M    0     0   821k      0  0:00:28  0:00:28 --:--:-- 1065k</span></span><br><span class="line"><span class="string">15:31:54 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 etcd v3.5.13 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 19.1M  100 19.1M    0     0   789k      0  0:00:24  0:00:24 --:--:-- 1062k</span></span><br><span class="line"><span class="string">15:32:19 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 containerd 1.7.13 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 45.7M  100 45.7M    0     0   910k      0  0:00:51  0:00:51 --:--:-- 1077k</span></span><br><span class="line"><span class="string">15:33:11 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 runc v1.1.12 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 10.2M  100 10.2M    0     0   660k      0  0:00:15  0:00:15 --:--:-- 1078k</span></span><br><span class="line"><span class="string">15:33:27 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 calicoctl v3.27.4 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 61.3M  100 61.3M    0     0   933k      0  0:01:07  0:01:07 --:--:-- 1026k</span></span><br><span class="line"><span class="string">15:34:34 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">15:34:34 CST [ConfigureOSModule] Get OS release</span></span><br><span class="line"><span class="string">15:34:34 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:34 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:34 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:34 CST [ConfigureOSModule] Prepare to init OS</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:36 CST [ConfigureOSModule] Generate init os script</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:36 CST [ConfigureOSModule] Exec init os script</span></span><br><span class="line"><span class="string">15:34:39 CST stdout: [k3s-worker-01]</span></span><br><span class="line"><span class="string">setenforce: SELinux is disabled</span></span><br><span class="line"><span class="string">Disabled</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_source_route = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_redirects = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.icmp_echo_ignore_broadcasts = 1</span></span><br><span class="line"><span class="string">net.ipv4.icmp_ignore_bogus_error_responses = 1</span></span><br><span class="line"><span class="string">kernel.sched_child_runs_first = 1</span></span><br><span class="line"><span class="string">kernel.sched_latency_ns = 80000000</span></span><br><span class="line"><span class="string">kernel.sched_migration_cost_ns = 125000</span></span><br><span class="line"><span class="string">kernel.sched_min_granularity_ns = 40000000</span></span><br><span class="line"><span class="string">kernel.sched_wakeup_granularity_ns = 3750000</span></span><br><span class="line"><span class="string">kernel.sched_nr_migrate = 128</span></span><br><span class="line"><span class="string">kernel.pid_max = 65535</span></span><br><span class="line"><span class="string">kernel.msgmax = 2097152</span></span><br><span class="line"><span class="string">kernel.msgmnb = 4194304</span></span><br><span class="line"><span class="string">kernel.shmmni = 32768</span></span><br><span class="line"><span class="string">kernel.sem = 2000 256000 256 1024</span></span><br><span class="line"><span class="string">vm.overcommit_memory = 0</span></span><br><span class="line"><span class="string">vm.max_map_count = 262144</span></span><br><span class="line"><span class="string">vm.swappiness = 0</span></span><br><span class="line"><span class="string">vm.dirty_background_ratio = 40</span></span><br><span class="line"><span class="string">vm.dirty_ratio = 50</span></span><br><span class="line"><span class="string">fs.aio-max-nr = 262144</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances = 524288</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches = 524288</span></span><br><span class="line"><span class="string">net.core.rps_sock_flow_entries = 65536</span></span><br><span class="line"><span class="string">net.core.dev_weight = 1024</span></span><br><span class="line"><span class="string">net.core.busy_poll = 200</span></span><br><span class="line"><span class="string">net.core.busy_read = 200</span></span><br><span class="line"><span class="string">net.ipv4.tcp_moderate_rcvbuf = 1</span></span><br><span class="line"><span class="string">net.core.somaxconn = 32768</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 65535</span></span><br><span class="line"><span class="string">net.core.netdev_budget = 4800</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1 = 512</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2 = 2048</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3 = 4096</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.unres_qlen_bytes = 262144</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max = 1048576</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_tcp_timeout_established = 300</span></span><br><span class="line"><span class="string">sysctl: setting key &quot;net.netfilter.nf_conntrack_buckets&quot;: No such file or directory</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_high_thresh = 16777216</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_low_thresh = 12582912</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.udp_rmem_min = 131072</span></span><br><span class="line"><span class="string">net.ipv4.udp_wmem_min = 131072</span></span><br><span class="line"><span class="string">net.core.rmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.rmem_max = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_max = 33554432</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 5</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 600</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 10000 65000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-arptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_reserved_ports = 30000-32767</span></span><br><span class="line"><span class="string">net.ipv4.tcp_retries2 = 15</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 65535</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl = 30</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 10</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_ignore = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_ignore = 1</span></span><br><span class="line"><span class="string">fs.pipe-max-size = 4194304</span></span><br><span class="line"><span class="string">kernel.watchdog_thresh = 5</span></span><br><span class="line"><span class="string">kernel.hung_task_timeout_secs = 5</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.default.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.lo.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.forwarding = 1</span></span><br><span class="line"><span class="string">15:34:39 CST stdout: [k3s-worker-02]</span></span><br><span class="line"><span class="string">setenforce: SELinux is disabled</span></span><br><span class="line"><span class="string">Disabled</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_source_route = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_redirects = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.icmp_echo_ignore_broadcasts = 1</span></span><br><span class="line"><span class="string">net.ipv4.icmp_ignore_bogus_error_responses = 1</span></span><br><span class="line"><span class="string">kernel.sched_child_runs_first = 1</span></span><br><span class="line"><span class="string">kernel.sched_latency_ns = 80000000</span></span><br><span class="line"><span class="string">kernel.sched_migration_cost_ns = 125000</span></span><br><span class="line"><span class="string">kernel.sched_min_granularity_ns = 40000000</span></span><br><span class="line"><span class="string">kernel.sched_wakeup_granularity_ns = 3750000</span></span><br><span class="line"><span class="string">kernel.sched_nr_migrate = 128</span></span><br><span class="line"><span class="string">kernel.pid_max = 65535</span></span><br><span class="line"><span class="string">kernel.msgmax = 2097152</span></span><br><span class="line"><span class="string">kernel.msgmnb = 4194304</span></span><br><span class="line"><span class="string">kernel.shmmni = 32768</span></span><br><span class="line"><span class="string">kernel.sem = 2000 256000 256 1024</span></span><br><span class="line"><span class="string">vm.overcommit_memory = 0</span></span><br><span class="line"><span class="string">vm.max_map_count = 262144</span></span><br><span class="line"><span class="string">vm.swappiness = 0</span></span><br><span class="line"><span class="string">vm.dirty_background_ratio = 40</span></span><br><span class="line"><span class="string">vm.dirty_ratio = 50</span></span><br><span class="line"><span class="string">fs.aio-max-nr = 262144</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances = 524288</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches = 524288</span></span><br><span class="line"><span class="string">net.core.rps_sock_flow_entries = 65536</span></span><br><span class="line"><span class="string">net.core.dev_weight = 1024</span></span><br><span class="line"><span class="string">net.core.busy_poll = 200</span></span><br><span class="line"><span class="string">net.core.busy_read = 200</span></span><br><span class="line"><span class="string">net.ipv4.tcp_moderate_rcvbuf = 1</span></span><br><span class="line"><span class="string">net.core.somaxconn = 32768</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 65535</span></span><br><span class="line"><span class="string">net.core.netdev_budget = 4800</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1 = 512</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2 = 2048</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3 = 4096</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.unres_qlen_bytes = 262144</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max = 1048576</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_tcp_timeout_established = 300</span></span><br><span class="line"><span class="string">sysctl: setting key &quot;net.netfilter.nf_conntrack_buckets&quot;: No such file or directory</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_high_thresh = 16777216</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_low_thresh = 12582912</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.udp_rmem_min = 131072</span></span><br><span class="line"><span class="string">net.ipv4.udp_wmem_min = 131072</span></span><br><span class="line"><span class="string">net.core.rmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.rmem_max = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_max = 33554432</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 5</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 600</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 10000 65000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-arptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_reserved_ports = 30000-32767</span></span><br><span class="line"><span class="string">net.ipv4.tcp_retries2 = 15</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 65535</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl = 30</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 10</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_ignore = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_ignore = 1</span></span><br><span class="line"><span class="string">fs.pipe-max-size = 4194304</span></span><br><span class="line"><span class="string">kernel.watchdog_thresh = 5</span></span><br><span class="line"><span class="string">kernel.hung_task_timeout_secs = 5</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.default.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.lo.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.forwarding = 1</span></span><br><span class="line"><span class="string">15:34:40 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">setenforce: SELinux is disabled</span></span><br><span class="line"><span class="string">Disabled</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_source_route = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_redirects = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.icmp_echo_ignore_broadcasts = 1</span></span><br><span class="line"><span class="string">net.ipv4.icmp_ignore_bogus_error_responses = 1</span></span><br><span class="line"><span class="string">kernel.sched_child_runs_first = 1</span></span><br><span class="line"><span class="string">kernel.sched_latency_ns = 80000000</span></span><br><span class="line"><span class="string">kernel.sched_migration_cost_ns = 125000</span></span><br><span class="line"><span class="string">kernel.sched_min_granularity_ns = 40000000</span></span><br><span class="line"><span class="string">kernel.sched_wakeup_granularity_ns = 3750000</span></span><br><span class="line"><span class="string">kernel.sched_nr_migrate = 128</span></span><br><span class="line"><span class="string">kernel.pid_max = 65535</span></span><br><span class="line"><span class="string">kernel.msgmax = 2097152</span></span><br><span class="line"><span class="string">kernel.msgmnb = 4194304</span></span><br><span class="line"><span class="string">kernel.shmmni = 32768</span></span><br><span class="line"><span class="string">kernel.sem = 2000 256000 256 1024</span></span><br><span class="line"><span class="string">vm.overcommit_memory = 0</span></span><br><span class="line"><span class="string">vm.max_map_count = 262144</span></span><br><span class="line"><span class="string">vm.swappiness = 0</span></span><br><span class="line"><span class="string">vm.dirty_background_ratio = 40</span></span><br><span class="line"><span class="string">vm.dirty_ratio = 50</span></span><br><span class="line"><span class="string">fs.aio-max-nr = 262144</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances = 524288</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches = 524288</span></span><br><span class="line"><span class="string">net.core.rps_sock_flow_entries = 65536</span></span><br><span class="line"><span class="string">net.core.dev_weight = 1024</span></span><br><span class="line"><span class="string">net.core.busy_poll = 200</span></span><br><span class="line"><span class="string">net.core.busy_read = 200</span></span><br><span class="line"><span class="string">net.ipv4.tcp_moderate_rcvbuf = 1</span></span><br><span class="line"><span class="string">net.core.somaxconn = 32768</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 65535</span></span><br><span class="line"><span class="string">net.core.netdev_budget = 4800</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1 = 512</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2 = 2048</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3 = 4096</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.unres_qlen_bytes = 262144</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max = 1048576</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_tcp_timeout_established = 300</span></span><br><span class="line"><span class="string">sysctl: setting key &quot;net.netfilter.nf_conntrack_buckets&quot;: No such file or directory</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_high_thresh = 16777216</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_low_thresh = 12582912</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.udp_rmem_min = 131072</span></span><br><span class="line"><span class="string">net.ipv4.udp_wmem_min = 131072</span></span><br><span class="line"><span class="string">net.core.rmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.rmem_max = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_max = 33554432</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 5</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 600</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 10000 65000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-arptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_reserved_ports = 30000-32767</span></span><br><span class="line"><span class="string">net.ipv4.tcp_retries2 = 15</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 65535</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl = 30</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 10</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_ignore = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_ignore = 1</span></span><br><span class="line"><span class="string">fs.pipe-max-size = 4194304</span></span><br><span class="line"><span class="string">kernel.watchdog_thresh = 5</span></span><br><span class="line"><span class="string">kernel.hung_task_timeout_secs = 5</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.default.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.lo.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.forwarding = 1</span></span><br><span class="line"><span class="string">15:34:40 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:40 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:40 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:40 CST [ConfigureOSModule] configure the ntp server for each node</span></span><br><span class="line"><span class="string">15:34:40 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:40 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:40 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:40 CST [KubernetesStatusModule] Get kubernetes cluster status</span></span><br><span class="line"><span class="string">15:34:41 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">v1.24.17</span></span><br><span class="line"><span class="string">15:34:41 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">k3s-master      v1.24.17   [map[address:10.2.2.109 type:InternalIP] map[address:k3s-master type:Hostname]]</span></span><br><span class="line"><span class="string">k3s-worker-01   v1.24.17   [map[address:10.2.2.140 type:InternalIP] map[address:k3s-worker-01 type:Hostname]]</span></span><br><span class="line"><span class="string">15:34:42 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">W1009 15:34:42.019455   34906 utils.go:69] The recommended value for &quot;clusterDNS&quot; in &quot;KubeletConfiguration&quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]</span></span><br><span class="line"><span class="string">[upload-certs] Storing the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace</span></span><br><span class="line"><span class="string">[upload-certs] Using certificate key:</span></span><br><span class="line"><span class="string">56a046cb392827bf42cec14effc1b0d27c3722e741e53ff9c5139d4c943b9efd</span></span><br><span class="line"><span class="string">15:34:42 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">15:34:42 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">15:34:42 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">15:34:43 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">0x3xku.uqjzfg1xclpwfkey</span></span><br><span class="line"><span class="string">15:34:43 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:43 CST [InstallContainerModule] Sync containerd binaries</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:43 CST [InstallContainerModule] Generate containerd service</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:43 CST [InstallContainerModule] Generate containerd config</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:43 CST [InstallContainerModule] Enable containerd</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:43 CST [InstallContainerModule] Sync crictl binaries</span></span><br><span class="line"><span class="string">15:34:44 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:44 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:44 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:44 CST [InstallContainerModule] Generate crictl config</span></span><br><span class="line"><span class="string">15:34:44 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:44 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:44 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:44 CST [PullModule] Start to pull images on all nodes</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.7</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.7</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.7</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-proxy:v1.24.17</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.8.6</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/k8s-dns-node-cache:1.22.20</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-apiserver:v1.24.17</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controllers:v3.27.4</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.27.4</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controller-manager:v1.24.17</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/node:v3.27.4</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-scheduler:v1.24.17</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pod2daemon-flexvol:v3.27.4</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-proxy:v1.24.17</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.8.6</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/k8s-dns-node-cache:1.22.20</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controllers:v3.27.4</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.27.4</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/node:v3.27.4</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pod2daemon-flexvol:v3.27.4</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-proxy:v1.24.17</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.8.6</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/k8s-dns-node-cache:1.22.20</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controllers:v3.27.4</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.27.4</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/node:v3.27.4</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pod2daemon-flexvol:v3.27.4</span></span><br><span class="line"><span class="string">15:34:46 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:46 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:46 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:46 CST [ETCDPreCheckModule] Get etcd status</span></span><br><span class="line"><span class="string">15:34:46 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">ETCD_NAME=etcd-k3s-master</span></span><br><span class="line"><span class="string">15:34:46 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:46 CST [CertsModule] Fetch etcd certs</span></span><br><span class="line"><span class="string">15:34:47 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:47 CST [CertsModule] Generate etcd Certs</span></span><br><span class="line"><span class="string">[certs] Using existing ca certificate authority</span></span><br><span class="line"><span class="string">[certs] Using existing admin-k3s-master certificate and key on disk</span></span><br><span class="line"><span class="string">[certs] Using existing member-k3s-master certificate and key on disk</span></span><br><span class="line"><span class="string">[certs] Using existing node-k3s-master certificate and key on disk</span></span><br><span class="line"><span class="string">15:34:47 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">15:34:47 CST [CertsModule] Synchronize certs file</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [CertsModule] Synchronize certs file to master</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [InstallETCDBinaryModule] Install etcd using binary</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [InstallETCDBinaryModule] Generate etcd service</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [InstallETCDBinaryModule] Generate access address</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Health check on exist etcd</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Generate etcd.env config on new etcd</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Join etcd member</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Health check on new etcd</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Check etcd member</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Refresh etcd.env config on all etcd</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Restart etcd</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Health check on all etcd</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDBackupModule] Backup etcd data regularly</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDBackupModule] Generate backup ETCD service</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDBackupModule] Generate backup ETCD timer</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDBackupModule] Enable backup etcd service</span></span><br><span class="line"><span class="string">15:34:51 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:51 CST [InstallKubeBinariesModule] Synchronize kubernetes binaries</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:00 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:00 CST [InstallKubeBinariesModule] Change kubelet mode</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:00 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:00 CST [InstallKubeBinariesModule] Generate kubelet service</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:00 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:00 CST [InstallKubeBinariesModule] Enable kubelet service</span></span><br><span class="line"><span class="string">15:35:01 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:01 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:01 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:01 CST [InstallKubeBinariesModule] Generate kubelet env</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:02 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:02 CST [JoinNodesModule] Generate kubeadm config</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:02 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:02 CST [JoinNodesModule] Generate audit policy</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:02 CST [JoinNodesModule] Generate audit webhook</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:02 CST [JoinNodesModule] Join control-plane node</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:02 CST [JoinNodesModule] Join worker node</span></span><br><span class="line"><span class="string">15:35:17 CST stdout: [k3s-worker-02]</span></span><br><span class="line"><span class="string">[preflight] Running pre-flight checks</span></span><br><span class="line"><span class="string">[preflight] Reading configuration from the cluster...</span></span><br><span class="line"><span class="string">[preflight] FYI: You can look at this config file with &#x27;</span>kubectl -n kube-system get cm kubeadm-config -o yaml<span class="string">&#x27;</span></span><br><span class="line"><span class="string">W1009 15:35:02.987472   10480 utils.go:69] The recommended value for &quot;clusterDNS&quot; in &quot;KubeletConfiguration&quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]</span></span><br><span class="line"><span class="string">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"><span class="string">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line"><span class="string">[kubelet-start] Starting the kubelet</span></span><br><span class="line"><span class="string">[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This node has joined the cluster:</span></span><br><span class="line"><span class="string">* Certificate signing request was sent to apiserver and a response was received.</span></span><br><span class="line"><span class="string">* The Kubelet was informed of the new secure connection details.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Run &#x27;</span>kubectl get nodes<span class="string">&#x27; on the control-plane to see this node join the cluster.</span></span><br><span class="line"><span class="string">15:35:17 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:17 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:17 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:17 CST [JoinNodesModule] Copy admin.conf to ~/.kube/config</span></span><br><span class="line"><span class="string">15:35:17 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:17 CST [JoinNodesModule] Remove master taint</span></span><br><span class="line"><span class="string">15:35:17 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:17 CST [JoinNodesModule] Add worker label to all nodes</span></span><br><span class="line"><span class="string">15:35:18 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-master not labeled</span></span><br><span class="line"><span class="string">15:35:18 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-worker-01 not labeled</span></span><br><span class="line"><span class="string">15:35:18 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-worker-02 labeled</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:18 CST [ConfigureKubernetesModule] Configure kubernetes</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:18 CST [ChownModule] Chown user $HOME/.kube dir</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:18 CST [AutoRenewCertsModule] Generate k8s certs renew script</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:18 CST [AutoRenewCertsModule] Generate k8s certs renew service</span></span><br><span class="line"><span class="string">15:35:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:19 CST [AutoRenewCertsModule] Generate k8s certs renew timer</span></span><br><span class="line"><span class="string">15:35:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:19 CST [AutoRenewCertsModule] Enable k8s certs renew service</span></span><br><span class="line"><span class="string">15:35:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:19 CST Pipeline[AddNodesPipeline] execute successfully</span></span><br></pre></td></tr></table></figure><p>验证集群状态。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; kubectl get node,cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span><br><span class="line">NAME                 STATUS   ROLES                  AGE    VERSION</span><br><span class="line">node/k3s-master      Ready    control-plane,worker   108m   v1.24.17</span><br><span class="line">node/k3s-worker-01   Ready    worker                 20m    v1.24.17</span><br><span class="line">node/k3s-worker-02   Ready    worker                 99s    v1.24.17</span><br><span class="line"></span><br><span class="line">NAME                                 STATUS    MESSAGE                         ERROR</span><br><span class="line">componentstatus/scheduler            Healthy   ok</span><br><span class="line">componentstatus/controller-manager   Healthy   ok</span><br><span class="line">componentstatus/etcd-0               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>,<span class="string">&quot;reason&quot;</span>:<span class="string">&quot;&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>查看控制台，Worker 节点成功接入集群。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-install-worker.png" alt=""></p><p>为方便使用，建议修改 NodePort 的端口范围，在所有服务器节点执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line">  - --service-node-port-range=1-65535</span><br><span class="line">  </span><br><span class="line">&gt; systemctl daemon-reload</span><br><span class="line">&gt; systemctl restart kubelet</span><br></pre></td></tr></table></figure><h2 id="创建-NFS-存储类">创建 NFS 存储类</h2><p>在所有服务器节点执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">&gt; helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建名为 data-nfs-client 的存储类，用于存储数据</span></span><br><span class="line">&gt; helm install data-nfs-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner --<span class="built_in">set</span> nfs.server=10.2.1.9 --<span class="built_in">set</span> nfs.path=/nfs/kubesphere/data --<span class="built_in">set</span> replicaCount=3 --<span class="built_in">set</span> storageClass.name=data-nfs-client --<span class="built_in">set</span> storageClass.provisionerName=nfs-data --<span class="built_in">set</span> storageClass.accessModes=ReadWriteMany --<span class="built_in">set</span> nfs.volumeName=data-nfs-root --<span class="built_in">set</span> image.repository=m.daocloud.io/registry.k8s.io/sig-storage/nfs-subdir-external-provisioner</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建名为 log-nfs-client 的存储类，用于存储日志</span></span><br><span class="line">&gt; helm install log-nfs-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner --<span class="built_in">set</span> nfs.server=10.2.1.9 --<span class="built_in">set</span> nfs.path=/nfs/kubesphere/log --<span class="built_in">set</span> replicaCount=1 --<span class="built_in">set</span> storageClass.name=log-nfs-client --<span class="built_in">set</span> storageClass.provisionerName=nfs-log --<span class="built_in">set</span> storageClass.accessModes=ReadWriteMany --<span class="built_in">set</span> nfs.volumeName=log-nfs-root --<span class="built_in">set</span> image.repository=m.daocloud.io/registry.k8s.io/sig-storage/nfs-subdir-external-provisioner</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建名为 config-nfs-client 的存储类，用于存储配置</span></span><br><span class="line">&gt; helm install config-nfs-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner --<span class="built_in">set</span> nfs.server=10.2.1.9 --<span class="built_in">set</span> nfs.path=/nfs/kubesphere/config --<span class="built_in">set</span> replicaCount=3 --<span class="built_in">set</span> storageClass.name=config-nfs-client --<span class="built_in">set</span> storageClass.provisionerName=nfs-config --<span class="built_in">set</span> storageClass.accessModes=ReadWriteMany --<span class="built_in">set</span> nfs.volumeName=config-nfs-root --<span class="built_in">set</span> image.repository=m.daocloud.io/registry.k8s.io/sig-storage/nfs-subdir-external-provisioner</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认的存储类为数据盘</span></span><br><span class="line">&gt; kubectl patch storageclass data-nfs-client -p <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">storageclass.storage.k8s.io/data-nfs-client patched</span><br></pre></td></tr></table></figure><h2 id="调整镜像仓库配置">调整镜像仓库配置</h2><p><a href="https://github.com/DaoCloud/public-image-mirror">DaoCloud</a> 提供了 DockerHub 的加速镜像源。如果您无法访问 DockerHub，可以参考以下代码片段进行设置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 K8s 使用 CONTAINER-TUNTIME 是 containerd:// 还是 docker://</span></span><br><span class="line">&gt; kubectl get nodes -o wide</span><br><span class="line">NAME            STATUS   ROLES                  AGE     VERSION    INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION                 CONTAINER-RUNTIME</span><br><span class="line">k3s-master      Ready    control-plane,worker   3d23h   v1.24.17   10.2.2.109    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line">k3s-worker-01   Ready    worker                 3d22h   v1.24.17   10.2.2.140    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line">k3s-worker-02   Ready    worker                 3d22h   v1.24.17   10.2.2.211    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line"></span><br><span class="line"><span class="comment"># If use docker</span></span><br><span class="line">&gt; vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://docker.m.daocloud.io&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">:wq</span><br><span class="line">&gt; sudo systemctl daemon-reload</span><br><span class="line">&gt; sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># If use containerd</span></span><br><span class="line">&gt; vim /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line">[plugins]</span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>]</span><br><span class="line">    ...</span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry]</span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://docker.m.daocloud.io&quot;</span>]</span><br><span class="line"></span><br><span class="line">&gt; sudo systemctl daemon-reload</span><br><span class="line">&gt; sudo systemctl restart containerd</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> 高可用集群 </tag>
            
            <tag> 自建机房 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockerfile 构建 Java 应用瘦身优化</title>
      <link href="/2024/09/02/devops/Dockerfile%20%E6%9E%84%E5%BB%BA%20Java%20%E5%BA%94%E7%94%A8%E7%98%A6%E8%BA%AB%E4%BC%98%E5%8C%96/"/>
      <url>/2024/09/02/devops/Dockerfile%20%E6%9E%84%E5%BB%BA%20Java%20%E5%BA%94%E7%94%A8%E7%98%A6%E8%BA%AB%E4%BC%98%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>早期我们对于 Docker 构建 Spring Boot 工程的方式很简单，直接构建生成 jar 可执行程序，通过 <code>java $JAVA_OPTS -jar</code> 启动。在 Kubernetes 环境下，如果要调整 JVM 参数，则通过 ConfigMap 维护 JAVA_OPTS 变量，方便统一管理同一个 Nacos 配置中心，如下：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-Xmn1G</span></span><br><span class="line"><span class="attr">-Xmx1G</span></span><br><span class="line"><span class="attr">-Xss256k</span></span><br><span class="line"><span class="attr">-Dspring.cloud.nacos.config.username</span>=<span class="string">nacos </span></span><br><span class="line"><span class="attr">-Dspring.cloud.nacos.config.password</span>=<span class="string">nacos</span></span><br><span class="line"><span class="attr">-Dspring.cloud.nacos.config.server-addr</span>=<span class="string">127.0.0.1:8848 </span></span><br></pre></td></tr></table></figure><p>在实际的生产环境，可能定义了十几个甚至上百个 Deployment，每个 Deployment 根据不同的负载设置不同的 JVM 参数，没办法共享同一份 ConfigMap 文件。为了解决这个问题，我们应该优化下 Dockerfile 构建模板，把 JVM 参数和运行环境变量分离出去。</p><h1>目标</h1><p>制定一套标准 Docker 构建模板，简化 JVM 配置流程。</p><h1>实现</h1><p>首先从 Dockerfile 文件着手，需要考虑几个方面：</p><ol><li>镜像分层：分离基础镜像（固定）、辅助工具（固定）、Maven 依赖（基本不变）和应用程序代码（变化），并减少镜像体积，通过镜像缓存提高构建速度。</li><li>变量简化：提取研发团队比较关心的 JVM 参数作为环境变量，例如 XMS 最小堆、XMX 最大堆、XSS 线程栈、GC 模式、GC 日志、堆转储、开启大页内存等。</li><li>容器安全：基于最小权限原则，运行容器时，以非 root 用户运行，只允许持有特定目录的读写权限。</li><li>脚本分离：将启动脚本与 Dockerfile 分离，方便从 ConfigMap 维护。</li></ol><p>Dockerfile 内容如下，因 DockerHub 镜像仓库访问不稳定，代码使用了 <a href="https://github.com/DaoCloud/public-image-mirror">m.daocloud.io</a> 代理，您可以根据实际情况调整。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> m.daocloud.io/eclipse-temurin:<span class="number">11</span>-jdk-alpine AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定构建模块</span></span><br><span class="line"><span class="keyword">ARG</span> MODULE=eden-demo-cola-start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制必要文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$MODULE</span>/target/<span class="variable">$MODULE</span>.jar application.jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker/entrypoint.sh entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装最小依赖项</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s|https://dl-cdn.alpinelinux.org|https://mirrors.aliyun.com|g&#x27;</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; apk update \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; apk add --no-cache tar binutils dos2unix \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; dos2unix entrypoint.sh \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; jdeps --ignore-missing-deps -q \</span></span><br><span class="line"><span class="language-bash">--recursive \</span></span><br><span class="line"><span class="language-bash">--multi-release 11 \</span></span><br><span class="line"><span class="language-bash">--print-module-deps \</span></span><br><span class="line"><span class="language-bash">--class-path <span class="string">&#x27;/BOOT-INF/lib/*&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">application.jar &gt; modules.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建运行环境</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="variable">$JAVA_HOME</span>/bin/jlink \</span></span><br><span class="line"><span class="language-bash">--verbose \</span></span><br><span class="line"><span class="language-bash">--add-modules $(<span class="built_in">cat</span> modules.txt),sun.misc \</span></span><br><span class="line"><span class="language-bash">--strip-debug \</span></span><br><span class="line"><span class="language-bash">--no-man-pages \</span></span><br><span class="line"><span class="language-bash">--no-header-files \</span></span><br><span class="line"><span class="language-bash">--compress=2 \</span></span><br><span class="line"><span class="language-bash">--output /jre</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Spring Boot 的分层模式提取 JAR 文件的依赖项</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> java -Djarmode=layertools -jar application.jar extract</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建容器镜像</span></span><br><span class="line"><span class="keyword">FROM</span> m.daocloud.io/alpine:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义元数据</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;梦想歌 &lt;shiyindaxiaojie@gmail.com&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&quot;1.0.0&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定构建参数</span></span><br><span class="line"><span class="keyword">ARG</span> <span class="keyword">USER</span>=tmpuser</span><br><span class="line"><span class="keyword">ARG</span> GROUP=tmpgroup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /opt/jdk/jdk-<span class="number">11</span></span><br><span class="line"><span class="keyword">ENV</span> PATH <span class="string">&quot;$&#123;JAVA_HOME&#125;/bin:$&#123;PATH&#125;&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> HOME <span class="string">&quot;/app&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> TZ <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> LANG <span class="string">&quot;C.UTF-8&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XMS <span class="string">&quot;1g&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XMX <span class="string">&quot;1g&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XSS <span class="string">&quot;256k&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> GC_MODE <span class="string">&quot;G1&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_GC_LOG <span class="string">&quot;Y&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_HEAP_DUMP <span class="string">&quot;Y&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_LARGE_PAGES <span class="string">&quot;N&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> SPRING_PROFILES_ACTIVE <span class="string">&quot;dev&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> SERVER_PORT <span class="string">&quot;8080&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> MANAGEMENT_SERVER_PORT <span class="string">&quot;9080&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置日志目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/logs \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">touch</span> <span class="variable">$HOME</span>/logs/entrypoint.out \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">ln</span> -sf /dev/stdout <span class="variable">$HOME</span>/logs/entrypoint.out \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">ln</span> -sf /dev/stderr <span class="variable">$HOME</span>/logs/entrypoint.out</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从基础镜像复制应用程序依赖项和模块</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /jre <span class="variable">$JAVA_HOME</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/dependencies/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/spring-boot-loader ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/organization-dependencies ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/modules-dependencies ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/snapshot-dependencies/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/application/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/entrypoint.sh ./</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建普通用户</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> addgroup -g 1000 <span class="variable">$GROUP</span> \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; adduser -u 1000 -G <span class="variable">$GROUP</span> -h <span class="variable">$HOME</span> -s /bin/bash -D <span class="variable">$USER</span> \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">chown</span> -R <span class="variable">$USER</span>:<span class="variable">$GROUP</span> <span class="variable">$HOME</span> \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">chmod</span> -R a+rwX <span class="variable">$HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到容器用户</span></span><br><span class="line"><span class="keyword">USER</span> $<span class="keyword">USER</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露容器端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> $SERVER_PORT $MANAGEMENT_SERVER_PORT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置启动脚本</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;./entrypoint.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>笔者将启动脚本命名为 <code>entrypoint.sh</code>，内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">JAVA_MAJOR_VERSION=$(java -version 2&gt;&amp;1 | sed -E -n <span class="string">&#x27;s/.* version &quot;([0-9]*).*$/\1/p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -server&quot;</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UnlockExperimentalVMOptions -XX:+UnlockDiagnosticVMOptions&quot;</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+AlwaysPreTouch -XX:+PrintFlagsFinal -XX:-DisplayVMOutput -XX:-OmitStackTraceInFastThrow&quot;</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -Xms<span class="variable">$&#123;XMS:-1G&#125;</span> -Xmx<span class="variable">$&#123;XMX:-1G&#125;</span> -Xss<span class="variable">$&#123;XSS:-256K&#125;</span>&quot;</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:MetaspaceSize=<span class="variable">$&#123;METASPACE_SIZE:-128M&#125;</span> -XX:MaxMetaspaceSize=<span class="variable">$&#123;MAX_METASPACE_SIZE:-256M&#125;</span>&quot;</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:MaxGCPauseMillis=<span class="variable">$&#123;MAX_GC_PAUSE_MILLIS:-200&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;GC_MODE&#125;</span>&quot;</span> = <span class="string">&quot;ShenandoahGC&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GC mode is ShenandoahGC&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseShenandoahGC&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$&#123;GC_MODE&#125;</span>&quot;</span> = <span class="string">&quot;ZGC&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GC mode is ZGC&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseZGC&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$&#123;GC_MODE&#125;</span>&quot;</span> = <span class="string">&quot;G1&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GC mode is G1&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseG1GC&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:InitiatingHeapOccupancyPercent=<span class="variable">$&#123;INITIATING_HEAP_OCCUPANCY_PERCENT:-45&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:G1ReservePercent=<span class="variable">$&#123;G1_RESERVE_PERCENT:-10&#125;</span> -XX:G1HeapWastePercent=<span class="variable">$&#123;G1_HEAP_WASTE_PERCENT:-5&#125;</span> &quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:G1NewSizePercent=<span class="variable">$&#123;G1_NEW_SIZE_PERCENT:-50&#125;</span> -XX:G1MaxNewSizePercent=<span class="variable">$&#123;G1_MAX_NEW_SIZE_PERCENT:-50&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:G1MixedGCCountTarget=<span class="variable">$&#123;G1_MIXED_GCCOUNT_TARGET:-8&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:G1MixedGCLiveThresholdPercent=<span class="variable">$&#123;G1_MIXED_GCLIVE_THRESHOLD_PERCENT:-65&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseStringDeduplication -XX:+ParallelRefProcEnabled&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$&#123;GC_MODE&#125;</span>&quot;</span> = <span class="string">&quot;CMS&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GC mode is CMS&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseConcMarkSweepGC -Xmn<span class="variable">$&#123;XMN:-512m&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:ParallelGCThreads=<span class="variable">$&#123;PARALLEL_GC_THREADS:-2&#125;</span> -XX:ConcGCThreads=<span class="variable">$&#123;CONC_GC_THREADS:-1&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=<span class="variable">$&#123;CMS_INITIATING_HEAP_OCCUPANCY_PERCENT:-92&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+CMSClassUnloadingEnabled -XX:+CMSScavengeBeforeRemark&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$JAVA_MAJOR_VERSION</span>&quot;</span> -le <span class="string">&quot;8&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+CMSIncrementalMode -XX:CMSFullGCsBeforeCompaction=<span class="variable">$&#123;CMS_FULL_GCS_BEFORE_COMPACTION:-5&#125;</span>&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+ExplicitGCInvokesConcurrent -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;USE_GC_LOG&#125;</span>&quot;</span> = <span class="string">&quot;Y&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GC log path is &#x27;<span class="variable">$&#123;HOME&#125;</span>/logs/jvm_gc.log&#x27;.&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+PrintVMOptions&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$JAVA_MAJOR_VERSION</span>&quot;</span> -gt <span class="string">&quot;8&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -Xlog:gc:file=<span class="variable">$&#123;HOME&#125;</span>/logs/jvm_gc-%p-%t.log:tags,uptime,time,level:filecount=<span class="variable">$&#123;GC_LOG_FILE_COUNT:-10&#125;</span>,filesize=<span class="variable">$&#123;GC_LOG_FILE_SIZE:-100M&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -Xloggc:<span class="variable">$&#123;HOME&#125;</span>/logs/jvm_gc.log -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=<span class="variable">$&#123;GC_LOG_FILE_COUNT:-10&#125;</span> -XX:GCLogFileSize=<span class="variable">$&#123;GC_LOG_FILE_SIZE:-100M&#125;</span>&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+PrintGCCause -XX:+PrintGCApplicationStoppedTime&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+PrintTLAB -XX:+PrintReferenceGC -XX:+PrintHeapAtGC&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+FlightRecorder -XX:+PrintSafepointStatistics -XX:PrintSafepointStatisticsCount=1&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+DebugNonSafepoints -XX:+SafepointTimeout -XX:SafepointTimeoutDelay=500&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/logs&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">mkdir</span> <span class="variable">$&#123;HOME&#125;</span>/logs</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;USE_HEAP_DUMP&#125;</span>&quot;</span> = <span class="string">&quot;Y&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Heap dump path is &#x27;<span class="variable">$&#123;HOME&#125;</span>/logs/jvm_heap_dump.hprof&#x27;.&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:HeapDumpPath=<span class="variable">$&#123;HOME&#125;</span>/logs/jvm_heap_dump.hprof -XX:+HeapDumpOnOutOfMemoryError&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;USE_LARGE_PAGES&#125;</span>&quot;</span> = <span class="string">&quot;Y&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Use large pages.&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseLargePages&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;JDWP_DEBUG:-N&#125;</span>&quot;</span> = <span class="string">&quot;Y&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Attach to remote JVM using port <span class="variable">$&#123;JDWP_PORT:-5005&#125;</span>.&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -Xdebug -Xrunjdwp:transport=dt_socket,address=<span class="variable">$&#123;JDWP_PORT:-5005&#125;</span>,server=y,suspend=n&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -Dserver.port=<span class="variable">$&#123;SERVER_PORT&#125;</span> -Dmanagement.server.port=<span class="variable">$&#123;MANAGEMENT_SERVER_PORT&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> java <span class="variable">$JAVA_OPTS</span> -noverify -Djava.security.egd=file:/dev/./urandom <span class="string">&quot;org.springframework.boot.loader.JarLauncher&quot;</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure><p>脚本目前兼容 JDK8、JDK11、JDK17，主要提供了以下参数：</p><ol><li>GC_MODE：垃圾回收器，适配 <code>ShenandoahGC</code>、<code>ZGC</code>、<code>G1</code>、<code>CMS</code>。</li><li>USE_GC_LOG：是否启用 GC 日志，默认输出路径为 <code>$&#123;HOME&#125;/logs/jvm_gc*.log</code>。</li><li>USE_HEAP_DUMP：是否启用堆转储，默认输出路径为 <code>$&#123;HOME&#125;/logs/jvm_heap_dump.hprof</code>。</li><li>USE_LARGE_PAGES：是否启用大页。</li><li>JDWP_DEBUG：是否启用 <code>JDWP</code> 调试，默认端口为 <code>5005</code>。</li><li>SERVER_PORT：服务端口。</li><li>MANAGEMENT_SERVER_PORT：管理端口，访问路径为 <code>/actuator</code>。</li></ol><h1>产出</h1><p>为团队提供 JVM 标准模板，通过 JVM 细节做了封装，研发团队只需要微调 JVM 变量就可以启用堆转储和 GC 日志、DEBUG 模式等配置。</p><p>服务瘦身效果比较明显，给研发团队做了测试，构建体积从原来的 389 MB 缩小到 295 MB，基础镜像占用了 240 MB，也就是说 jar 从 149 MB 降到 45 MB，如下图。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/docker/docker-slim.png" alt=""></p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-demo-cola/tree/main/docker">eden-demo-cola</a> 项目。</p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 镜像分层 </tag>
            
            <tag> 最佳实践 </tag>
            
            <tag> 模板示例 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KubeSphere 持续集成实践</title>
      <link href="/2024/08/10/devops/KubeSphere%20%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E5%AE%9E%E8%B7%B5/"/>
      <url>/2024/08/10/devops/KubeSphere%20%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>笔者在搭建 KubeSphere 集群时，发现 KubeSphere 控制台提供了内置的 DevOps 可视化工具，可以快速搭建 CI/CD 流水线。因官方文档没有详细说明，笔者决定通过实践的方式来研究 KubeSphere DevOps。</p><h1>目标</h1><p>探索 KubeSphere DevOps 能否满足研发团队的 CI/CD 需求。</p><h1>步骤</h1><h2 id="创建-DevOps-项目">创建 DevOps 项目</h2><p>在 <code>工作台</code> &gt; <code>项目</code> &gt; <code>流水线</code> 创建您的应用。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-create-devops-project.png" alt=""></p><p>选择流水线，KubeSphere 提供了单分支和多分支构建方式。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-create-devops-project-form1.png" alt=""></p><p>设置构建参数和触发器规则。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-create-devops-project-form2.png" alt=""></p><h2 id="编辑流水线">编辑流水线</h2><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-create-devops-pipeline.png" alt=""></p><p>KubeSphere 的可视化界面不是特别完善，笔者经过调试后，编写下面的脚本。如果您熟悉 Jenkinsfile 的语法，可以直接在流水线编辑界面中编写 Jenkinsfile。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent &#123;</span><br><span class="line">    node &#123;</span><br><span class="line">      label <span class="string">&#x27;maven&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">&#x27;Git Checkout&#x27;</span>) &#123;</span><br><span class="line">      agent none</span><br><span class="line">      steps &#123;</span><br><span class="line">        git(<span class="attr">url:</span> <span class="string">&#x27;https://git.code.tencent.com/demo/$APP_NAME&#x27;</span>, <span class="attr">credentialsId:</span> <span class="string">&#x27;git-code&#x27;</span>, <span class="attr">branch:</span> <span class="string">&#x27;$BRANCH_NAME&#x27;</span>, <span class="attr">changelog:</span> <span class="literal">true</span>, <span class="attr">poll:</span> <span class="literal">false</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;Maven Package&#x27;</span>) &#123;</span><br><span class="line">      agent none</span><br><span class="line">      steps &#123;</span><br><span class="line">        container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">          withCredentials([</span><br><span class="line">                        usernamePassword(</span><br><span class="line">                            <span class="symbol">credentialsId:</span> <span class="string">&#x27;maven-releases&#x27;</span>,</span><br><span class="line">                            <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span> ,</span><br><span class="line">                            <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">                        ),</span><br><span class="line">                        usernamePassword(</span><br><span class="line">                            <span class="symbol">credentialsId:</span> <span class="string">&#x27;maven-snapshots&#x27;</span>,</span><br><span class="line">                            <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span> ,</span><br><span class="line">                            <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">                        )</span><br><span class="line">                    ]) &#123;</span><br><span class="line">                        withEnv([</span><br><span class="line">                            <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">                        ]) &#123;</span><br><span class="line">                            sh <span class="string">&#x27;mvn -Pcoding versions:set -DnewVersion=$BUILD_VERSION package -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;Parallel&#x27;</span>) &#123;</span><br><span class="line">            parallel &#123;</span><br><span class="line">                stage(<span class="string">&#x27;Maven Deploy&#x27;</span>) &#123;</span><br><span class="line">                    agent none</span><br><span class="line">                    steps &#123;</span><br><span class="line">                        container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">                            withCredentials([</span><br><span class="line">                                usernamePassword(</span><br><span class="line">                                    <span class="symbol">credentialsId:</span> <span class="string">&#x27;maven-releases&#x27;</span>,</span><br><span class="line">                                    <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span> ,</span><br><span class="line">                                    <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">                                ),</span><br><span class="line">                                usernamePassword(</span><br><span class="line">                                    <span class="symbol">credentialsId:</span> <span class="string">&#x27;maven-snapshots&#x27;</span>,</span><br><span class="line">                                    <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span> ,</span><br><span class="line">                                    <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">                                )</span><br><span class="line">                            ]) &#123;</span><br><span class="line">                                withEnv([</span><br><span class="line">                                    <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">                                    <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">                                ]) &#123;</span><br><span class="line">                                    sh <span class="string">&#x27;mvn -Pcoding deploy -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                stage(<span class="string">&#x27;Docker Build&#x27;</span>) &#123;</span><br><span class="line">                    agent none</span><br><span class="line">                    steps &#123;</span><br><span class="line">                        container(<span class="string">&#x27;maven&#x27;</span>) &#123;</span><br><span class="line">                            sh <span class="string">&#x27;docker build -f docker/Dockerfile -t $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:$BUILD_VERSION-$BUILD_NUMBER .&#x27;</span></span><br><span class="line">                            withCredentials([</span><br><span class="line">                                usernamePassword(</span><br><span class="line">                                    <span class="symbol">credentialsId:</span> <span class="string">&#x27;harbor-registry&#x27;</span>,</span><br><span class="line">                                    <span class="symbol">passwordVariable:</span> <span class="string">&#x27;DOCKER_PASSWORD&#x27;</span>,</span><br><span class="line">                                    <span class="symbol">usernameVariable:</span> <span class="string">&#x27;DOCKER_USERNAME&#x27;</span></span><br><span class="line">                                )</span><br><span class="line">                            ]) &#123;</span><br><span class="line">                                sh <span class="string">&#x27;echo &quot;$DOCKER_PASSWORD&quot; | docker login $REGISTRY -u &quot;$DOCKER_USERNAME&quot; --password-stdin&#x27;</span></span><br><span class="line">                                sh <span class="string">&#x27;docker push $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:$BUILD_VERSION-$BUILD_NUMBER&#x27;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  environment &#123;</span><br><span class="line">    APP_NAME = <span class="string">&#x27;demo&#x27;</span></span><br><span class="line">    BRANCH_NAME = <span class="string">&#x27;dev&#x27;</span></span><br><span class="line">    BUILD_VERSION = <span class="string">&#x27;dev-SNAPSHOT&#x27;</span></span><br><span class="line">    REGISTRY = <span class="string">&#x27;10.2.2.109:30003&#x27;</span></span><br><span class="line">    DOCKERHUB_NAMESPACE = <span class="string">&#x27;demo&#x27;</span></span><br><span class="line">    MAVEN_RELEASES_ID = <span class="string">&#x27;releases&#x27;</span></span><br><span class="line">    MAVEN_RELEASES_URL = <span class="string">&#x27;https://demo-maven.pkg.coding.net/repository/demo/releases/&#x27;</span></span><br><span class="line">    MAVEN_SNAPSHOTS_ID = <span class="string">&#x27;snapshots&#x27;</span></span><br><span class="line">    MAVEN_SNAPSHOTS_URL = <span class="string">&#x27;https://demo-maven.pkg.coding.net/repository/demo/snapshots/&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>点击 <code>运行</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-devops-start-pipeline.png" alt=""></p><p>查看部署日志。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-devops-start-pipeline-log.png" alt=""></p><h2 id="多分支模式">多分支模式</h2><p>KubeSphere 多分支不支持可视化编排，也不支持在控制台编写 Jenkinsfile，只能在项目代码中管理您的 Jenkinsfile 文件，并且，不支持变量，非常鸡肋。</p><p>笔者创建了一个名为 <code>demo-multi-branches</code> 的项目，指定脚本的路径为 <code>.kubesphere/Jenkinsfile</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-create-devops-mutli-branches.png" alt=""></p><p>关于 <code>.kubesphere/Jenkinsfile</code> 的内容，请参考上述编写的 Jenkinsfile，将分支写死。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/kubesphere-create-devops-mutli-branches-status.png" alt=""></p><h1>总结</h1><p>KubeSphere DevOps 基本可以实现 CI/CD 的功能，但是功能不是很完善，单分支模式不支持 Git 事件触发流水线，只能使用 Cron 触发，多分支又不能在控制台管理，可能要等作者慢慢优化了。</p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CI/CD </tag>
            
            <tag> KubeSphere </tag>
            
            <tag> DevOps </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Higress 金丝雀发布实践</title>
      <link href="/2024/03/16/devops/Higress%20%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83%E5%AE%9E%E8%B7%B5/"/>
      <url>/2024/03/16/devops/Higress%20%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>Higress 是阿里巴巴开源的云原生网关，基于 Istio + Envoy 为核心构建，实现了流量网关 + 微服务网关 + 安全网关三合一的高集成能力，深度集成 Dubbo、Nacos、Sentinel 等微服务技术栈。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/higress/higress-all-in-one.png" alt=""></p><p>关于 Higress 具体的介绍，您可以查阅 <a href="https://higress.cn/docs/latest/overview/what-is-higress">Higress 文档</a>。</p><p>在早期的部署架构，业务通常采用 <code>WAF 安全防护网关</code> + <code>Nginx 流量网关</code> + <code>Spring Cloud Gateway 微服务网关</code> 实现。</p><p>一次用户请求 -&gt; LB（WAF） -&gt; Nginx -&gt; Spring Cloud Gateway -&gt; 微服务</p><p>这样导致在链路分析和日常维护上带来复杂性。因此，我们尝试引入 Higress 网关，去除 Spring Cloud Gateway 的依赖，将请求链缩短如下。</p><p>一次用户请求 -&gt; LB（WAF） -&gt; Higress -&gt; 微服务</p><h1>目标</h1><p>验证 Higress 网关能否替换 Spring Cloud Gateway，并实现 A/B 测试、金丝雀发布等功能。</p><h1>部署</h1><p>为方便维护，使用 Helm 部署 Higress 网关，代码片段如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install higress --create-namespace --namespace higress higress.io/higress</span><br></pre></td></tr></table></figure><p>在 KubeSphere 查看已部署的工作负载，可以看到 Higress 分别创建了 <code>higress-gateway</code> 访问入口、<code>higress-console</code> 控制台和 <code>higress-controller</code> 控制器。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/higress/higress-deployment.png" alt=""></p><p>调整 <code>higress-gateway</code> 控制台的服务端口为 80，对外统一访问这个端口。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/higress/higress-service.png" alt=""></p><p>调整 <code>higress-console</code> 控制台的服务端口为 8080，初始用户密码为 <code>admin/admin</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/higress/higress-console.png" alt=""></p><h1>使用</h1><blockquote><p>本文只讲解最基本的配置流程，不涉及域名和证书的配置步骤。</p></blockquote><h2 id="配置服务来源">配置服务来源</h2><p>Higress 支持 <code>Nacos</code>、<code>Eureka</code>、<code>Consul</code>、<code>Zookeeper</code> 等服务注册中心接入。</p><p>例如，下图使用 Nacos 2.x 版本配置。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/higress/higress-register-nacos2.png" alt=""></p><p>查看服务列表，选择命名空间为 <code>mcp</code>，过滤出注册中心的服务。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/higress/higress-register-list.png" alt=""></p><h2 id="配置路由列表">配置路由列表</h2><p>假设请求入口为 <code>/api/auth</code>，参考下图，配置为路由A。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/higress/higress-canary-none.png" alt=""></p><p>如果实际的请求入口为 <code>/demo/api/auth</code>，期望后端请求到 <code>/api/auth</code>，则需要设置重写策略。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/higress/higress-rewrite-router.png" alt=""></p><p>Higress 允许您添加多个路由，用于平替 <code>Spring Cloud Gateway</code> 的 API 路由策略。</p><h2 id="验证-A-B-测试">验证 A/B 测试</h2><p>Higress 通过注解 <code>higress.io/canary</code> 实现蓝绿发布、A/B 测试、金丝雀发布。</p><p>首先，保留上述配置的路由 A ，当请求不携带任何 Header、Cookies 时，默认请求到这个路由。</p><p>添加一个新的路由 B，使用 <code>higress.io/canary-by-header</code> 来控制。如下图，我们配置了 <code>higress.io/canary-by-header=region</code> 和 <code>higress.io/canary-by-header-value=gz|bj</code>，当客户端在 HTTP 请求头中携带 <code>region</code> 参数值 <code>gz</code> 或 <code>bj</code> 时，将请求路由到路由 B，否则路由到原来的路由 A。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/higress/higress-canary-header.png" alt=""></p><p>使用 curl 命令，模拟请求，查看路由的请求情况。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl --request GET http://10.2.2.109/api/auth</span><br><span class="line"></span><br><span class="line">路由A</span><br><span class="line">路由A</span><br><span class="line">路由A</span><br><span class="line">路由A</span><br><span class="line"></span><br><span class="line">curl --request GET http://10.2.2.109/api/auth --header <span class="string">&#x27;region: gz&#x27;</span></span><br><span class="line"></span><br><span class="line">路由B</span><br><span class="line">路由B</span><br><span class="line">路由B</span><br><span class="line">路由B</span><br></pre></td></tr></table></figure><h2 id="验证金丝雀发布">验证金丝雀发布</h2><p>实现金丝雀发布场景，使用 <code>higress.io/canary-weight</code> 权重来控制，您可以参考下图，添加路由 C ，权重慢慢从 20 到 80，分流原来的路由 A。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/higress/higress-canary-weight.png" alt=""></p><p>使用 curl 命令，模拟请求，查看路由的请求情况。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl --request GET http://10.2.2.109/api/auth</span><br><span class="line"></span><br><span class="line">路由A</span><br><span class="line">路由A</span><br><span class="line">路由A</span><br><span class="line">路由C</span><br><span class="line">路由A</span><br><span class="line">路由C</span><br><span class="line">路由C</span><br><span class="line">路由C</span><br></pre></td></tr></table></figure><h1>总结</h1><p>在引入 Higress 云原生网关后，我们去除了 <code>Spring Cloud Gateway</code>，并且可以很方便的实现 A/B 测试、金丝雀发布等场景。但是，目前的版本相对 APISIX 来说，存在一些不足：</p><ol><li>单个路由不支持同时设置多个匹配规则，一个后端服务可能存在多个 API 路径，如果 API 规则太多，维护就变得比较困难。APISIX 允许你设置多个匹配规则。</li><li>路由不支持 APISIX 的上线、下线，使用灰度发布场景，需要手动删除。</li><li>不支持静态资源代理，只能把静态资源打包为 Pod 暴露出去，而 APISIX 可以通过 Nginx 底层配置实现。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> A/B 测试 </tag>
            
            <tag> 金丝雀发布 </tag>
            
            <tag> Higress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Log4j2 扩展日志脱敏插件</title>
      <link href="/2024/03/15/log4j2/Log4j2%20%E6%89%A9%E5%B1%95%E6%97%A5%E5%BF%97%E8%84%B1%E6%95%8F%E6%8F%92%E4%BB%B6/"/>
      <url>/2024/03/15/log4j2/Log4j2%20%E6%89%A9%E5%B1%95%E6%97%A5%E5%BF%97%E8%84%B1%E6%95%8F%E6%8F%92%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>日志脱敏是常见的安全需求。为了金融交易的安全性，国家强制规定对于<strong>姓名</strong>、<strong>手机号</strong>、<strong>身份证号码</strong>、<strong>住址</strong>等信息需要数据脱敏。一般我们会采取注解的形式指定字段进行脱敏处理，但这样对代码的侵入性较高。假设公司有几十个系统要改造，或者采购了一些系统没有源代码，怎么办？还有，日志脱敏后，系统用户需要通过手机号找出对应的日志，怎么匹配？</p><h1>目标</h1><p>实现一个零侵入性的日志插件，并能支持原始数据检索。</p><h1>实现</h1><p>我们调研了 Github 一些开源项目，发现 <a href="https://github.com/houbb/sensitive">https://github.com/houbb/sensitive</a> 能够满足这个需求，它通过 <code>Trie</code> 类对字符进行解析处理，具体的处理逻辑大部分封装在 <code>com.github.houbb.chars.scan.bs.CharsScanBs</code> 这个类，我们只需要引入 <code>CharsScanBs.scanAndReplace(text)</code> 就可以实现对原始日志的脱敏处理，被脱敏的内容后面自动追加原始数据库的 MD5 信息，假设用户反馈系统问题，会提供他的手机号，我们将手机号生成 MD5，去脱敏日志文件匹配，就能定位到原始数据。</p><p>Log4j2 插件提供了两个扩展方式 <code>AbstractStringLayout</code> 和 <code>RewritePolicy</code>。在这里，我们定义了 <code>MaskingStringLayout</code> 对 <code>AbstractStringLayout</code> 进行扩展。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Plugin(name = &quot;MaskingStringLayout&quot;, category = Node.CATEGORY, elementType = Layout.ELEMENT_TYPE, printObject = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MaskingStringLayout</span> <span class="keyword">extends</span> <span class="title class_">AbstractStringLayout</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CharsScanBs charsScanBs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对日志内容进行脱敏处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toSerializable</span><span class="params">(LogEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (patternFormatterList == <span class="literal">null</span> || patternFormatterList.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> event.getMessage().getFormattedMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (PatternFormatter formatter : patternFormatterList) &#123;</span><br><span class="line">            formatter.format(event, stringBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> charsScanBs.scanAndReplace(stringBuilder.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 log4j.yml 读取配置</span></span><br><span class="line">    <span class="meta">@PluginFactory</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MaskingStringLayout <span class="title function_">createLayout</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginConfiguration</span> <span class="keyword">final</span> Configuration config,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;charset&quot;, defaultString = &quot;UTF-8&quot;)</span> String charset,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;pattern&quot;)</span> String pattern,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;type&quot;)</span> String type,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;prefix&quot;)</span> String prefix,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;scanList&quot;)</span> String scanList,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;replaceList&quot;)</span> String replaceList,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;defaultReplace&quot;)</span> String defaultReplace,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;replaceHash&quot;)</span> String replaceHash,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;whiteList&quot;)</span> String whiteList)</span> &#123;</span><br><span class="line">            </span><br><span class="line">        <span class="type">MaskingConfig</span> <span class="variable">maskingConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MaskingConfig</span>();</span><br><span class="line">        <span class="keyword">if</span> (type != <span class="literal">null</span>) &#123;</span><br><span class="line">            maskingConfig.setType(type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ... </span></span><br><span class="line">        <span class="type">MaskingStringLayout</span> <span class="variable">layout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MaskingStringLayout</span>(Charset.forName(charset), maskingConfig);</span><br><span class="line">        layout.patternFormatterList = patternParser.parse(pattern);</span><br><span class="line">        <span class="keyword">return</span> layout;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的 <code>MaskingConfig</code> 配置类如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MaskingConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;chars-scan&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">CharsScan</span> <span class="variable">charsScan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CharsScan</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line">    <span class="meta">@ToString</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CharsScan</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> <span class="string">&quot;：‘“，| ,:\\\&quot;&#x27;=&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">scanList</span> <span class="operator">=</span> <span class="string">&quot;TELEPHONE,ID_CARD,BANK_CARD,PASSPORT,ADDRESS,EMAIL&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">replaceList</span> <span class="operator">=</span> <span class="string">&quot;TELEPHONE,ID_CARD,BANK_CARD,PASSPORT,ADDRESS,EMAIL&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">defaultReplace</span> <span class="operator">=</span> <span class="string">&quot;ANY_PARTIALLY_MASKED&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">replaceHash</span> <span class="operator">=</span> <span class="string">&quot;md5&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">whiteList</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 log4j2.yml 配置相关日志插件。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Configuration:</span></span><br><span class="line">  <span class="attr">status:</span> <span class="string">WARN</span></span><br><span class="line">  <span class="attr">monitorInterval:</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">Properties:</span></span><br><span class="line">    <span class="attr">Property:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MASKING_STRATEGIES</span> <span class="comment"># 脱敏策略</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">TELEPHONE,ID_CARD,BANK_CARD,PASSPORT,ADDRESS,EMAIL</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MASKING_REPLACEMENT</span> <span class="comment"># 脱敏格式：ANY_PARTIALLY_MASKED（匹配任意半掩盖），ANY_FULLY_MASKED（匹配任意全掩盖）</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">ANY_PARTIALLY_MASKED</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MASKING_HASH</span> <span class="comment"># 脱敏哈希</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;md5&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MASKING_WHITELIST</span> <span class="comment"># 脱敏白名单</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">Appenders:</span></span><br><span class="line">    <span class="attr">Console:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">STDOUT</span> <span class="comment"># 控制台</span></span><br><span class="line">      <span class="attr">target:</span> <span class="string">SYSTEM_OUT</span></span><br><span class="line">      <span class="attr">MaskingStringLayout:</span> <span class="comment"># 脱敏插件</span></span><br><span class="line">        <span class="attr">pattern:</span> <span class="string">$&#123;LOG_PATTERN&#125;</span></span><br><span class="line">        <span class="attr">strategies:</span> <span class="string">$&#123;MASKING_STRATEGIES&#125;</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$&#123;MASKING_REPLACEMENT&#125;</span></span><br><span class="line">        <span class="attr">hash:</span> <span class="string">$&#123;MASKING_HASH&#125;</span></span><br><span class="line">        <span class="attr">whitelist:</span> <span class="string">$&#123;MASKING_WHITELIST&#125;</span></span><br></pre></td></tr></table></figure><p>假设我要查询 18820132137 这个手机号的日志，可以通过 MD5 在线加密工具得到 MD5 值。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/log4j2/log4j2-md5-online.png" alt=""></p><p>搜索日志时，直接输入 MD5 值，就能定位到原始日志。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/log4j2/log4j2-console-relate.png" alt=""></p><h1>产出</h1><p>可以满足金融级别的监管合规检查，对业务零侵入，研发团队只需要在 log4j2.yml 引入相关日志插件就可以完成日志脱敏。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-solutions/eden-data-masker">eden-data-masker</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 扩展点 </tag>
            
            <tag> Log4j2 </tag>
            
            <tag> 数据脱敏 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot 实现可扩展的消息队列</title>
      <link href="/2024/02/16/spring/Spring%20Boot%20%E5%AE%9E%E7%8E%B0%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
      <url>/2024/02/16/spring/Spring%20Boot%20%E5%AE%9E%E7%8E%B0%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>在复杂的分布式系统中，消息队列（如 <code>RocketMQ</code>、<code>Kafka</code>、<code>RabbitMQ</code>）常用于优化系统性能。然而，直接在代码中引入这些消息队列的 API 会导致系统与特定消息队列的强耦合，后续难以切换其他消息队列组件。虽然 <code>Spring Cloud Stream</code> 提供了一种抽象层，但其引入了复杂的概念（如绑定器、通道、处理器等），且与低版本的 <code>Spring Boot</code> 不兼容。</p><p>为了解决这些问题，我们决定开发一个简洁、可切换的 MQ 组件，保留原生配置的同时，屏蔽底层 API 细节，并通过 <code>Spring Boot</code> 自动装配进行管理。</p><h1>目标</h1><ol><li>封装通用接口：提供统一的接口，屏蔽底层消息队列的 API 细节。</li><li>保留原生配置：支持 <code>RocketMQ</code>、<code>Kafka</code> 等消息队列的原生配置。</li><li>做到开箱即用：通过 <code>Spring Boot</code> 的自动装配机制，简化配置和集成。</li></ol><h1>实现</h1><h2 id="消息模型设计">消息模型设计</h2><p>首先，定义一个通用的消息模型 <code>Message</code>，用于封装业务项目中生产和消费的消息内容。该模型兼容 RocketMQ 和 Kafka 的消息结构。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 命名空间 */</span></span><br><span class="line"><span class="keyword">private</span> String namespace;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 主题 */</span></span><br><span class="line"><span class="keyword">private</span> String topic;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 分区/队列 */</span></span><br><span class="line"><span class="keyword">private</span> Integer partition;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 分区键 */</span></span><br><span class="line"><span class="keyword">private</span> String key;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 标签过滤 */</span></span><br><span class="line"><span class="keyword">private</span> String tags;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 消息体 */</span></span><br><span class="line"><span class="keyword">private</span> String body;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 延时等级 */</span></span><br><span class="line"><span class="meta">@Builder</span>.Default</span><br><span class="line"><span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">delayTimeLevel</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="消费者接口设计">消费者接口设计</h2><p>定义 <code>MessageQueueConsumer</code> 接口，用于处理消息消费逻辑。通过 <code>@MessageQueueListener</code> 注解，可以配置消费参数，如主题、消费者组、消费线程等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageQueueConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消费消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> messages 消息报文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ack 消息确认</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">consume</span><span class="params">(List&lt;Message&gt; messages, Acknowledgement ack)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Acknowledgement</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提交</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">acknowledge</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义 <code>@MessageQueueListener</code> 注解，用于配置消费者的行为，如消费主题、消费者组、消费模式、消息过滤等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MessageQueueListener &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息队列类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 消息队列类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">type</span><span class="params">()</span> <span class="keyword">default</span> Strings.EMPTY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置消费者组</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 消费者组名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">group</span><span class="params">()</span> <span class="keyword">default</span> Strings.EMPTY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置消息主题</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 消息主题</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">topic</span><span class="params">()</span> <span class="keyword">default</span> Strings.EMPTY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从 Broker 端批量拉取消息大小</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 默认拉取 32 条消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pullBatchSize</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上报 Broker 端的最大消费消息数，当拉取消息的大小大于消费的大小时，拆成多个线程并发处理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 默认消费 1 条消息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">consumeMessageBatchMaxSize</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最小消费线程</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 默认 8 个线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">consumeThreadMin</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最大消费线程</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 默认 64 个线程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">consumeThreadMax</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消费超时</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 默认 15 分钟</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">consumeTimeout</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消费模式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 默认并发消费，不保证顺序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ConsumeMode <span class="title function_">consumeMode</span><span class="params">()</span> <span class="keyword">default</span> ConsumeMode.UNSET;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息模式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 默认集群模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">MessageModel <span class="title function_">messageModel</span><span class="params">()</span> <span class="keyword">default</span> MessageModel.UNSET;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息过滤类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 默认按 Tag 过滤</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">MessageSelectorType <span class="title function_">selectorType</span><span class="params">()</span> <span class="keyword">default</span> MessageSelectorType.UNSET;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息过滤规则</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 默认全模糊匹配</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">selectorExpression</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;*&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否开启消息轨迹追踪</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 默认开启</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">enableMsgTrace</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当我们设置启用 RocketMQ 时，通过 <code>RocketMQConsumer</code> 对 <code>MessageQueueListener</code> 注解进行配置解析，实现消息消费。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RocketMQConsumer</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span>, DisposableBean, ApplicationContextAware &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, DefaultMQPushConsumer&gt; consumers = Maps.newConcurrentMap();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RocketMQConfig rocketMQConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;MessageQueueConsumer&gt; messageQueueConsumers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Function&lt;String, Boolean&gt; matcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"><span class="built_in">this</span>.applicationContext = applicationContext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Initializing RocketMQConsumer&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (CollectionUtils.isEmpty(messageQueueConsumers)) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (MessageQueueConsumer messageQueueConsumer : messageQueueConsumers) &#123;</span><br><span class="line">DefaultMQPushConsumer consumer;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">consumer = initRocketMQPushConsumer(messageQueueConsumer);</span><br><span class="line">&#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (consumer == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">consumer.start();</span><br><span class="line">&#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;RocketMQConsumer consume error: &#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageConsumeException</span>(e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Destroy RocketMQConsumer&quot;</span>);</span><br><span class="line">consumers.forEach((k, v) -&gt; v.shutdown());</span><br><span class="line">consumers.clear();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> DefaultMQPushConsumer <span class="title function_">initRocketMQPushConsumer</span><span class="params">(MessageQueueConsumer messageQueueConsumer)</span> <span class="keyword">throws</span> MQClientException &#123;</span><br><span class="line">Class&lt;? <span class="keyword">extends</span> <span class="title class_">MessageQueueConsumer</span>&gt; clazz = messageQueueConsumer.getClass();</span><br><span class="line"><span class="type">MessageQueueListener</span> <span class="variable">annotation</span> <span class="operator">=</span> clazz.getAnnotation(MessageQueueListener.class);</span><br><span class="line"><span class="keyword">if</span> (!matcher.apply(annotation.type())) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 命名空间</span></span><br><span class="line"><span class="type">String</span> <span class="variable">namespace</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(rocketMQConfig.getConsumer().getNamespace())) &#123;</span><br><span class="line">namespace = rocketMQConfig.getConsumer().getNamespace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主题</span></span><br><span class="line"><span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(annotation.topic())) &#123;</span><br><span class="line">topic = annotation.topic();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotBlank(rocketMQConfig.getConsumer().getTopic())) &#123;</span><br><span class="line">topic = rocketMQConfig.getConsumer().getTopic();</span><br><span class="line">&#125;</span><br><span class="line">AssertUtils.notNull(topic, <span class="string">&quot;PROP-REQUIRED-500&quot;</span>, <span class="string">&quot;rocketmq.consumer.topic&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费组</span></span><br><span class="line"><span class="type">String</span> <span class="variable">consumerGroup</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(annotation.group())) &#123;</span><br><span class="line">consumerGroup = annotation.group();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotBlank(rocketMQConfig.getConsumer().getGroup())) &#123;</span><br><span class="line">consumerGroup = rocketMQConfig.getConsumer().getGroup() + Strings.UNDERLINE + topic;</span><br><span class="line">&#125;</span><br><span class="line">AssertUtils.notNull(consumerGroup, <span class="string">&quot;PROP-REQUIRED-500&quot;</span>, <span class="string">&quot;rocketmq.consumer.group&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化消费者</span></span><br><span class="line"><span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationContext.getEnvironment();</span><br><span class="line"><span class="type">RPCHook</span> <span class="variable">rpcHook</span> <span class="operator">=</span> RocketMQUtil.getRPCHookByAkSk(applicationContext.getEnvironment(),</span><br><span class="line">rocketMQConfig.getConsumer().getAccessKey(), rocketMQConfig.getConsumer().getSecretKey());</span><br><span class="line"><span class="type">boolean</span> <span class="variable">enableMsgTrace</span> <span class="operator">=</span> annotation.enableMsgTrace();</span><br><span class="line">DefaultMQPushConsumer consumer;</span><br><span class="line"><span class="keyword">if</span> (Objects.nonNull(rpcHook)) &#123;</span><br><span class="line">consumer = <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(namespace, consumerGroup, rpcHook, <span class="keyword">new</span> <span class="title class_">AllocateMessageQueueAveragely</span>(),</span><br><span class="line">enableMsgTrace, environment.resolveRequiredPlaceholders(topic));</span><br><span class="line">consumer.setVipChannelEnabled(<span class="literal">false</span>);</span><br><span class="line">consumer.setInstanceName(RocketMQUtil.getInstanceName(rpcHook, consumerGroup));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.warn(<span class="string">&quot;RocketMQ access-key or secret-key not configure in &#123;&#125;.&quot;</span>, <span class="built_in">this</span>.getClass().getName());</span><br><span class="line">consumer = <span class="keyword">new</span> <span class="title class_">DefaultMQPushConsumer</span>(namespace, consumerGroup, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">AllocateMessageQueueAveragely</span>(),</span><br><span class="line">enableMsgTrace, environment.resolveRequiredPlaceholders(topic));</span><br><span class="line">&#125;</span><br><span class="line">consumer.setNamesrvAddr(rocketMQConfig.getNameServer());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者本地缓存消息数，超过这个阈值会降低消费速率</span></span><br><span class="line"><span class="type">int</span> <span class="variable">pullThresholdForQueue</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">if</span> (rocketMQConfig.getConsumer().getPullThresholdForQueue() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">pullThresholdForQueue = rocketMQConfig.getConsumer().getPullThresholdForQueue();</span><br><span class="line">&#125;</span><br><span class="line">consumer.setPullThresholdForQueue(pullThresholdForQueue);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者本地缓存消息大小，超过这个阈值会降低消费速率</span></span><br><span class="line"><span class="type">int</span> <span class="variable">pullThresholdSizeForQueue</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"><span class="keyword">if</span> (rocketMQConfig.getConsumer().getPullThresholdSizeForQueue() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">pullThresholdSizeForQueue = rocketMQConfig.getConsumer().getPullThresholdSizeForQueue();</span><br><span class="line">&#125;</span><br><span class="line">consumer.setPullThresholdSizeForQueue(pullThresholdSizeForQueue);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量拉取消息条数</span></span><br><span class="line"><span class="type">int</span> <span class="variable">pullBatchSize</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line"><span class="keyword">if</span> (annotation.pullBatchSize() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">pullBatchSize = annotation.pullBatchSize();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rocketMQConfig.getConsumer().getPullBatchSize() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">pullBatchSize = rocketMQConfig.getConsumer().getPullBatchSize();</span><br><span class="line">&#125;</span><br><span class="line">consumer.setPullBatchSize(pullBatchSize);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量消费消息条数</span></span><br><span class="line"><span class="type">int</span> <span class="variable">consumeMessageBatchMaxSize</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (annotation.consumeMessageBatchMaxSize() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">consumeMessageBatchMaxSize = annotation.consumeMessageBatchMaxSize();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rocketMQConfig.getConsumer().getConsumeMessageBatchMaxSize() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">consumeMessageBatchMaxSize = rocketMQConfig.getConsumer().getConsumeMessageBatchMaxSize();</span><br><span class="line">&#125;</span><br><span class="line">consumer.setConsumeMessageBatchMaxSize(consumeMessageBatchMaxSize);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费者本地缓存消息跨度，超过这个阈值会降低消费速率</span></span><br><span class="line"><span class="type">int</span> <span class="variable">consumeConcurrentlyMaxSpan</span> <span class="operator">=</span> <span class="number">2000</span>;</span><br><span class="line"><span class="keyword">if</span> (rocketMQConfig.getConsumer().getConsumeConcurrentlyMaxSpan() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">consumeConcurrentlyMaxSpan = rocketMQConfig.getConsumer().getConsumeConcurrentlyMaxSpan();</span><br><span class="line">&#125;</span><br><span class="line">consumer.setConsumeConcurrentlyMaxSpan(consumeConcurrentlyMaxSpan);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费最大线程</span></span><br><span class="line"><span class="type">int</span> <span class="variable">consumeThreadMax</span> <span class="operator">=</span> <span class="number">64</span>;</span><br><span class="line"><span class="keyword">if</span> (annotation.consumeThreadMax() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">consumeThreadMax = annotation.consumeThreadMax();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rocketMQConfig.getConsumer().getConsumeThreadMax() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">consumeThreadMax = rocketMQConfig.getConsumer().getConsumeThreadMax();</span><br><span class="line">&#125;</span><br><span class="line">consumer.setConsumeThreadMax(consumeThreadMax);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费最小线程</span></span><br><span class="line"><span class="type">int</span> <span class="variable">consumeThreadMin</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (annotation.consumeThreadMin() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">consumeThreadMin = annotation.consumeThreadMin();</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rocketMQConfig.getConsumer().getConsumeThreadMax() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">consumeThreadMin = rocketMQConfig.getConsumer().getConsumeThreadMin();</span><br><span class="line">&#125;</span><br><span class="line">        consumer.setConsumeThreadMin(Math.min(consumeThreadMin, consumeThreadMax));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消费超时</span></span><br><span class="line"><span class="keyword">if</span> (annotation.consumeTimeout() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">consumer.setConsumeTimeout(annotation.consumeTimeout());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rocketMQConfig.getConsumer().getConsumeTimeout() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">consumer.setConsumeTimeout(rocketMQConfig.getConsumer().getConsumeTimeout());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息模式</span></span><br><span class="line"><span class="keyword">switch</span> (annotation.messageModel()) &#123;</span><br><span class="line"><span class="keyword">case</span> BROADCASTING:</span><br><span class="line">consumer.setMessageModel(MessageModel.BROADCASTING);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> CLUSTERING:</span><br><span class="line">consumer.setMessageModel(MessageModel.CLUSTERING);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="type">String</span> <span class="variable">messageModel</span> <span class="operator">=</span> rocketMQConfig.getConsumer().getMessageModel();</span><br><span class="line">AssertUtils.notNull(messageModel, <span class="string">&quot;PROP-REQUIRED-500&quot;</span>, <span class="string">&quot;rocketmq.consumer.messageModel&quot;</span>);</span><br><span class="line">consumer.setMessageModel(MessageModel.valueOf(rocketMQConfig.getConsumer().getMessageModel()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息选择器类型</span></span><br><span class="line"><span class="type">String</span> <span class="variable">selectorExpression</span> <span class="operator">=</span> annotation.selectorExpression();</span><br><span class="line">AssertUtils.notNull(selectorExpression, <span class="string">&quot;PROP-REQUIRED-500&quot;</span>, <span class="string">&quot;rocketmq.consumer.selectorType&quot;</span>);</span><br><span class="line">MessageSelector messageSelector;</span><br><span class="line"><span class="keyword">switch</span> (annotation.selectorType()) &#123;</span><br><span class="line"><span class="keyword">case</span> TAG:</span><br><span class="line">messageSelector = MessageSelector.byTag(selectorExpression);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> SQL92:</span><br><span class="line">messageSelector = MessageSelector.bySql(selectorExpression);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">messageSelector = ExpressionType.isTagType(rocketMQConfig.getConsumer().getSelectorType()) ?</span><br><span class="line">MessageSelector.byTag(selectorExpression) : MessageSelector.bySql(selectorExpression);</span><br><span class="line">consumer.setMessageModel(MessageModel.valueOf(rocketMQConfig.getConsumer().getMessageModel()));</span><br><span class="line">&#125;</span><br><span class="line">consumer.subscribe(topic, messageSelector);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置顺序模式或者并发模式</span></span><br><span class="line"><span class="type">ConsumeMode</span> <span class="variable">consumeMode</span> <span class="operator">=</span> annotation.consumeMode() != ConsumeMode.UNSET ?</span><br><span class="line">annotation.consumeMode() : ConsumeMode.valueOf(rocketMQConfig.getConsumer().getConsumeMode());</span><br><span class="line"><span class="keyword">switch</span> (consumeMode) &#123;</span><br><span class="line"><span class="keyword">case</span> ORDERLY:</span><br><span class="line">consumer.setMessageListener(<span class="keyword">new</span> <span class="title class_">DefaultMessageListenerOrderly</span>(messageQueueConsumer));</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> CONCURRENTLY:</span><br><span class="line">consumer.setMessageListener(<span class="keyword">new</span> <span class="title class_">DefaultMessageListenerConcurrently</span>(messageQueueConsumer));</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Property &#x27;consumeMode&#x27; was wrong.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log.debug(<span class="string">&quot;Create DefaultMQPushConsumer, group: &#123;&#125;, namespace: &#123;&#125;, topic: &#123;&#125;&quot;</span>, consumerGroup, namespace, topic);</span><br><span class="line">consumers.put(topic, consumer);</span><br><span class="line"><span class="keyword">return</span> consumer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultMessageListenerConcurrently</span> <span class="keyword">implements</span> <span class="title class_">MessageListenerConcurrently</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MessageQueueConsumer messageQueueConsumer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; messageExts, ConsumeConcurrentlyContext context)</span> &#123;</span><br><span class="line">AtomicReference&lt;ConsumeConcurrentlyStatus&gt; status =</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;(ConsumeConcurrentlyStatus.RECONSUME_LATER);</span><br><span class="line">List&lt;Message&gt; messages = getMessages(messageExts);</span><br><span class="line"><span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">messageQueueConsumer.consume(messages, () -&gt; status.set(ConsumeConcurrentlyStatus.CONSUME_SUCCESS));</span><br><span class="line"><span class="type">long</span> <span class="variable">costTime</span> <span class="operator">=</span> System.currentTimeMillis() - now;</span><br><span class="line">log.debug(<span class="string">&quot;consume message concurrently cost &#123;&#125; ms, message: &#123;&#125;&quot;</span>, costTime, messageExts);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;consume message concurrently failed, message: &#123;&#125;&quot;</span>, messageExts, e);</span><br><span class="line">context.setDelayLevelWhenNextConsume(rocketMQConfig.getConsumer().getDelayLevelWhenNextConsume());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> status.get();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultMessageListenerOrderly</span> <span class="keyword">implements</span> <span class="title class_">MessageListenerOrderly</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> MessageQueueConsumer messageQueueConsumer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ConsumeOrderlyStatus <span class="title function_">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; messageExts, ConsumeOrderlyContext context)</span> &#123;</span><br><span class="line">AtomicReference&lt;ConsumeOrderlyStatus&gt; status =</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;(ConsumeOrderlyStatus.SUSPEND_CURRENT_QUEUE_A_MOMENT);</span><br><span class="line">List&lt;Message&gt; messages = getMessages(messageExts);</span><br><span class="line"><span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">messageQueueConsumer.consume(messages, () -&gt; status.set(ConsumeOrderlyStatus.SUCCESS));</span><br><span class="line"><span class="type">long</span> <span class="variable">costTime</span> <span class="operator">=</span> System.currentTimeMillis() - now;</span><br><span class="line">log.debug(<span class="string">&quot;consume message concurrently cost &#123;&#125; ms, message: &#123;&#125;&quot;</span>, costTime, messageExts);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;consume message concurrently failed, message: &#123;&#125;&quot;</span>, messageExts, e);</span><br><span class="line">context.setSuspendCurrentQueueTimeMillis(rocketMQConfig.getConsumer().getSuspendCurrentQueueTimeMillis());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> status.get();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NotNull</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Message&gt; <span class="title function_">getMessages</span><span class="params">(List&lt;MessageExt&gt; messageExts)</span> &#123;</span><br><span class="line">List&lt;Message&gt; messages = Lists.newArrayListWithCapacity(messageExts.size());</span><br><span class="line">messageExts.forEach(messageExt -&gt; messages.add(</span><br><span class="line">Message.builder()</span><br><span class="line">.topic(messageExt.getTopic())</span><br><span class="line">.partition(messageExt.getQueueId())</span><br><span class="line">.key(messageExt.getKeys())</span><br><span class="line">.tags(messageExt.getTags())</span><br><span class="line">.delayTimeLevel(messageExt.getDelayTimeLevel())</span><br><span class="line">.body(<span class="keyword">new</span> <span class="title class_">String</span>(messageExt.getBody()))</span><br><span class="line">.build()));</span><br><span class="line"><span class="keyword">return</span> messages;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同理，启用 <code>Kafka</code> 时，通过 <code>KafkaConsumer</code> 类实现 <code>MessageQueueListener</code> 解析，并实现消息消费。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaConsumer</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span>, DisposableBean &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Consumer&lt;String, String&gt;&gt; consumers = Lists.newArrayList();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> KafkaProperties kafkaConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;MessageQueueConsumer&gt; messageQueueConsumers;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConsumerFactory&lt;String, String&gt; consumerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Function&lt;String, Boolean&gt; matcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicBoolean</span> <span class="variable">threadRunning</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicBoolean</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Initializing KafkaConsumer&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (CollectionUtils.isEmpty(messageQueueConsumers)) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (MessageQueueConsumer messageQueueConsumer : messageQueueConsumers) &#123;</span><br><span class="line">Consumer&lt;String, String&gt; consumer = initKafkaConsumer(messageQueueConsumer);</span><br><span class="line"><span class="keyword">if</span> (consumer == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line">consumers.add(consumer);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line"><span class="keyword">while</span> (threadRunning.get()) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ConsumerRecords&lt;String, String&gt; consumerRecords =</span><br><span class="line">consumer.poll(kafkaConfig.getConsumer().getFetchMaxWait());</span><br><span class="line"><span class="keyword">if</span> (consumerRecords == <span class="literal">null</span> || consumerRecords.isEmpty()) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="variable">maxPollRecords</span> <span class="operator">=</span> kafkaConfig.getConsumer().getMaxPollRecords();</span><br><span class="line">Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets = Maps.newHashMapWithExpectedSize(maxPollRecords);</span><br><span class="line">List&lt;Message&gt; messages = Lists.newArrayListWithCapacity(consumerRecords.count());</span><br><span class="line">consumerRecords.forEach(record -&gt; &#123;</span><br><span class="line">offsets.put(<span class="keyword">new</span> <span class="title class_">TopicPartition</span>(record.topic(), record.partition()),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">OffsetAndMetadata</span>(record.offset() + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">messages.add(Message.builder()</span><br><span class="line">.topic(record.topic())</span><br><span class="line">.partition(record.partition())</span><br><span class="line">.key(record.key())</span><br><span class="line">.body(record.value()).build());</span><br><span class="line">&#125;);</span><br><span class="line">messageQueueConsumer.consume(messages, () -&gt; consumer.commitSync(offsets));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;KafkaConsumerProcessor consume error: &#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;).start();</span><br><span class="line">&#125;</span><br><span class="line">threadRunning.set(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Destroy KafkaConsumer&quot;</span>);</span><br><span class="line">threadRunning.set(<span class="literal">false</span>);</span><br><span class="line">consumers.forEach(Consumer::unsubscribe);</span><br><span class="line">consumers.clear();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Consumer&lt;String, String&gt; <span class="title function_">initKafkaConsumer</span><span class="params">(MessageQueueConsumer messageQueueConsumer)</span> &#123;</span><br><span class="line">Class&lt;? <span class="keyword">extends</span> <span class="title class_">MessageQueueConsumer</span>&gt; clazz = messageQueueConsumer.getClass();</span><br><span class="line"><span class="type">MessageQueueListener</span> <span class="variable">annotation</span> <span class="operator">=</span> clazz.getAnnotation(MessageQueueListener.class);</span><br><span class="line"><span class="keyword">if</span> (!matcher.apply(annotation.type())) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> annotation.topic();</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">group</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(kafkaConfig.getConsumer().getGroupId())) &#123;</span><br><span class="line">group = kafkaConfig.getConsumer().getGroupId() + Strings.UNDERLINE + topic;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotBlank(annotation.group())) &#123;</span><br><span class="line">group = annotation.group();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Consumer&lt;String, String&gt; consumer = consumerFactory.createConsumer(group, kafkaConfig.getClientId());</span><br><span class="line">consumer.subscribe(Collections.singleton(topic));</span><br><span class="line"></span><br><span class="line">log.debug(<span class="string">&quot;Create consumer from consumerFactory, group: &#123;&#125;, topic: &#123;&#125;&quot;</span>, group, topic);</span><br><span class="line"><span class="keyword">return</span> consumer;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了简化配置，我们通过 <code>Spring Boot</code> 的自动装配机制，动态选择使用 <code>RocketMQ</code> 或 <code>Kafka</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = MessageQueueProperties.PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageQueueProperties</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;spring.message-queue.dynamic&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">primary</span> <span class="operator">=</span> <span class="string">&quot;RocketMQ&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">prefix = &quot;spring.message-queue.dynamic&quot;,</span></span><br><span class="line"><span class="meta">name = &quot;primary&quot;,</span></span><br><span class="line"><span class="meta">havingValue = &quot;RocketMQ&quot;,</span></span><br><span class="line"><span class="meta">matchIfMissing = true</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@ConditionalOnExpression(&quot;$&#123;rocketmq.enabled:true&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(RocketMQProperties.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(RocketMQTemplate.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(MessageQueueAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;</span></span><br><span class="line"><span class="meta">RocketMQProducerProperties.class,</span></span><br><span class="line"><span class="meta">RocketMQConsumerProperties.class</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RocketMQMessageQueueAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MessageQueueProperties messageQueueProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RocketMQProperties rocketMQProperties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RocketMQConsumer <span class="title function_">rocketMQConsumer</span><span class="params">(RocketMQConsumerProperties rocketMQConsumerProperties,</span></span><br><span class="line"><span class="params"> ObjectProvider&lt;List&lt;MessageQueueConsumer&gt;&gt; messageListeners)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired RocketMQConsumer&quot;</span>);</span><br><span class="line">Function&lt;String, Boolean&gt; matcher = type -&gt; StringUtils.isBlank(type) &amp;&amp; messageQueueProperties.getPrimary() != <span class="literal">null</span> ?</span><br><span class="line">MessageQueueType.ROCKETMQ.name().equalsIgnoreCase(messageQueueProperties.getPrimary()) :</span><br><span class="line">MessageQueueType.ROCKETMQ.name().equalsIgnoreCase(type);</span><br><span class="line"><span class="type">RocketMQConfig</span> <span class="variable">config</span> <span class="operator">=</span> RocketMQConvertor.INSTANCE.toConfig(rocketMQProperties);</span><br><span class="line">RocketMQConvertor.INSTANCE.updateConfigFromConsumer(rocketMQConsumerProperties, config.getConsumer());</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RocketMQConsumer</span>(config, messageListeners.getIfAvailable(), matcher);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageQueueProvider <span class="title function_">messageQueueProvider</span><span class="params">(RocketMQProducerProperties rocketMQProducerProperties,</span></span><br><span class="line"><span class="params"> RocketMQTemplate rocketMQTemplate)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired RocketMQProvider&quot;</span>);</span><br><span class="line"><span class="type">RocketMQConfig</span> <span class="variable">config</span> <span class="operator">=</span> RocketMQConvertor.INSTANCE.toConfig(rocketMQProperties);</span><br><span class="line">RocketMQConvertor.INSTANCE.updateConfigFromProducer(rocketMQProducerProperties, config.getProducer());</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RocketMQProvider</span>(config, rocketMQTemplate);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">prefix = &quot;spring.message-queue.dynamic&quot;,</span></span><br><span class="line"><span class="meta">name = &quot;primary&quot;,</span></span><br><span class="line"><span class="meta">havingValue = &quot;Kafka&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@ConditionalOnExpression(&quot;$&#123;spring.kafka.enabled:true&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(KafkaProperties.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(KafkaTemplate.class)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(MessageQueueAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaMessageQueueAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MessageQueueProperties messageQueueProperties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> KafkaProperties kafkaProperties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> KafkaConsumer <span class="title function_">kafkaConsumer</span><span class="params">(ObjectProvider&lt;List&lt;MessageQueueConsumer&gt;&gt; messageListeners,</span></span><br><span class="line"><span class="params">   ObjectProvider&lt;ConsumerFactory&lt;String, String&gt;&gt; consumerFactory)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired KafkaConsumer&quot;</span>);</span><br><span class="line">Function&lt;String, Boolean&gt; matcher = type -&gt; StringUtils.isBlank(type) &amp;&amp; messageQueueProperties.getPrimary() != <span class="literal">null</span> ?</span><br><span class="line">MessageQueueType.KAFKA.name().equalsIgnoreCase(messageQueueProperties.getPrimary()) :</span><br><span class="line">MessageQueueType.KAFKA.name().equalsIgnoreCase(type);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KafkaConsumer</span>(kafkaProperties, messageListeners.getIfAvailable(),</span><br><span class="line">consumerFactory.getIfAvailable(), matcher);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MessageQueueProvider <span class="title function_">messageQueueProvider</span><span class="params">(KafkaTemplate&lt;String, String&gt; kafkaTemplate)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired KafkaProvider&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KafkaProvider</span>(kafkaTemplate);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <code>spring.message-queue.dynamic.primary</code> 配置项，可以动态切换消息队列的实现。</p><h2 id="消费者代码示例">消费者代码示例</h2><p>消费者代码片段如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@MessageQueueListener(topic = &quot;demo-cola-user&quot;)</span> <span class="comment">// 该注解会触发消息消费</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserConsumer</span> <span class="keyword">implements</span> <span class="title class_">MessageQueueConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消费消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> messages</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ack</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">(List&lt;Message&gt; messages, Acknowledgement ack)</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;消费消息: &#123;&#125;&quot;</span>, messages);</span><br><span class="line">ack.acknowledge();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的 <code>application.yaml</code> 配置如下。关于 <code>RocketMQ</code> 或者 <code>Kafka</code> 的详细配置，我们直接沿用官方的基础配置。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">message-queue:</span></span><br><span class="line">    <span class="attr">dynamic:</span></span><br><span class="line">      <span class="attr">primary:</span> <span class="string">RocketMQ</span> <span class="comment"># 配置 RocketMQ 或者 Kafka</span></span><br><span class="line">  <span class="attr">kafka:</span> <span class="comment"># 官方原生配置</span></span><br><span class="line">    <span class="attr">client-id:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"><span class="attr">bootstrap-servers:</span> <span class="string">localhost:9092</span></span><br><span class="line">    <span class="attr">consumer:</span></span><br><span class="line">      <span class="attr">group-id:</span> <span class="string">$&#123;spring.application.name&#125;</span> <span class="comment"># 消费组，同一个消费组的实例数或者线程数不能超过 Kafka 的分区数量</span></span><br><span class="line">      <span class="attr">enable-auto-commit:</span> <span class="literal">false</span> <span class="comment"># 建议关闭自动提交 Offset，不然报错很难处理</span></span><br><span class="line">      <span class="attr">auto-offset-reset:</span> <span class="string">earliest</span> <span class="comment"># 设置消费者重连是否自动重置到最开始的消息偏移量</span></span><br><span class="line">      <span class="attr">heartbeat-interval:</span> <span class="number">5000</span> <span class="comment"># 心跳频率</span></span><br><span class="line">      <span class="attr">max-poll-records:</span> <span class="number">100</span> <span class="comment"># 单次拉取最大记录数</span></span><br><span class="line">      <span class="attr">fetch-max-wait:</span> <span class="number">3000</span> <span class="comment"># 未达到 fetch-min-size 时，阻塞拉取消息的时长</span></span><br><span class="line">      <span class="attr">fetch-min-size:</span> <span class="number">4096</span> <span class="comment"># 触发拉取消息的最小值</span></span><br><span class="line">      <span class="attr">isolation-level:</span> <span class="string">READ_COMMITTED</span> <span class="comment"># 隔离级别：READ_UNCOMMITTED/READ_COMMITTED</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">BATCH</span> <span class="comment"># 监听类型：BATCH/SINGLE</span></span><br><span class="line">      <span class="attr">ack-mode:</span> <span class="string">MANUAL_IMMEDIATE</span> <span class="comment"># 手动提交模式</span></span><br><span class="line">      <span class="attr">concurrency:</span> <span class="number">5</span> <span class="comment"># 消费监听线程数，当配置值大于 Kafka 分区数，按分区数执行</span></span><br><span class="line">      <span class="attr">poll-timeout:</span> <span class="number">5000</span> <span class="comment"># 单次拉取消息的超时时间</span></span><br><span class="line">      <span class="attr">idle-between-polls:</span> <span class="number">0</span> <span class="comment"># 拉取消息的空闲时间</span></span><br><span class="line">      <span class="attr">idle-event-interval:</span> <span class="number">0</span> <span class="comment"># 没有可消费的消息时空闲的间隔时间</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rocketmq:</span>  <span class="comment"># 官方原生配置</span></span><br><span class="line">  <span class="attr">name-server:</span> <span class="string">localhost:9876</span></span><br><span class="line">  <span class="attr">consumer:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active&#125;</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">    <span class="attr">pull-batch-size:</span> <span class="number">500</span> <span class="comment"># 单次拉取消息条数</span></span><br><span class="line">    <span class="attr">consume-message-batch-max-size:</span> <span class="number">100</span> <span class="comment"># 单次消费消息条数</span></span><br><span class="line">    <span class="attr">consume-mode:</span> <span class="string">CONCURRENTLY</span> <span class="comment"># CONCURRENTLY：并发模式，ORDERLY：顺序模式</span></span><br><span class="line">    <span class="attr">consume-thread-min:</span> <span class="number">8</span> <span class="comment"># 消费最小线程数</span></span><br><span class="line">    <span class="attr">consume-thread-max:</span> <span class="number">64</span> <span class="comment"># 消费最大线程数</span></span><br><span class="line">    <span class="attr">consume-timeout:</span> <span class="number">15</span> <span class="comment"># 消费超时（分钟）</span></span><br><span class="line">    <span class="attr">suspend-current-queue-time-millis:</span> <span class="number">1000</span> <span class="comment"># 顺序模式下消费者重试暂停的时间</span></span><br><span class="line">    <span class="attr">delay-level-when-next-consume:</span> <span class="number">0</span> <span class="comment"># 并发模式下消费者重试频率，0：Broker 控制重试、-1：不重试直接进入死信、大于1：参考 Client 重试级别</span></span><br></pre></td></tr></table></figure><h2 id="生产者接口设计">生产者接口设计</h2><p>同样的思路，定义 <code>MessageQueueProvider</code> 生产者接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageQueueProvider</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 消息类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">messageQueueType</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步发送消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message 消息实体</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 消息发送结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">MessageSendResult <span class="title function_">syncSend</span><span class="params">(Message message)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 异步发送消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message 消息实体</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> messageCallback 消息回调</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">asyncSend</span><span class="params">(Message message, MessageSendCallback messageCallback)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageSendCallback</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息发送成功</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> result 消息发送结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(MessageSendResult result)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息发送失败</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> e 异常堆栈</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">onFailed</span><span class="params">(Throwable e)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageSendResult</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**主题 */</span></span><br><span class="line"><span class="keyword">private</span> String topic;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**分区 */</span></span><br><span class="line"><span class="keyword">private</span> Integer partition;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 偏移量 */</span></span><br><span class="line"><span class="keyword">private</span> Long offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 事务ID */</span></span><br><span class="line"><span class="keyword">private</span> String transactionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义 <code>RocketMQProvider</code> 类实现 <code>MessageQueueProvider</code> 接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RocketMQProvider</span> <span class="keyword">implements</span> <span class="title class_">MessageQueueProvider</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RocketMQConfig rocketMQConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 消息类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">messageQueueType</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> MessageQueueType.ROCKETMQ.name();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步发送消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> MessageSendResult <span class="title function_">syncSend</span><span class="params">(Message message)</span> &#123;</span><br><span class="line"><span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> rocketMQTemplate.getProducer();</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(rocketMQConfig.getProducer().getNamespace())) &#123;</span><br><span class="line">producer.setNamespace(rocketMQConfig.getProducer().getNamespace());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotBlank(message.getNamespace())) &#123;</span><br><span class="line">producer.setNamespace(message.getNamespace());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="type">SendResult</span> <span class="variable">sendResult</span> <span class="operator">=</span> producer.send(transfer(message));</span><br><span class="line"><span class="keyword">return</span> transfer(sendResult);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;RocketMQProvider send interrupted: &#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line">Thread.currentThread().interrupt();</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageSendException</span>(e.getMessage());</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;RocketMQProvider send error: &#123;&#125;&quot;</span>, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageSendException</span>(e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 异步发送消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> messageCallback</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">asyncSend</span><span class="params">(Message message, MessageSendCallback messageCallback)</span> &#123;</span><br><span class="line"><span class="type">DefaultMQProducer</span> <span class="variable">producer</span> <span class="operator">=</span> rocketMQTemplate.getProducer();</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(rocketMQConfig.getProducer().getNamespace())) &#123;</span><br><span class="line">producer.setNamespace(rocketMQConfig.getProducer().getNamespace());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNotBlank(message.getNamespace())) &#123;</span><br><span class="line">producer.setNamespace(message.getNamespace());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">producer.send(transfer(message), <span class="keyword">new</span> <span class="title class_">SendCallback</span>() &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult sendResult)</span> &#123;</span><br><span class="line">messageCallback.onSuccess(transfer(sendResult));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onException</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">messageCallback.onFailed(e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">log.error(ROCKETMQ_PROVIDER_SEND_INTERRUPTED, e.getMessage(), e);</span><br><span class="line">Thread.currentThread().interrupt();</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageSendException</span>(e.getMessage());</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(ROCKETMQ_PROVIDER_CONSUME_ERROR, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageSendException</span>(e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转换为 RocketMQ 消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> org.apache.rocketmq.common.message.Message <span class="title function_">transfer</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">org.apache.rocketmq.common.message.<span class="type">Message</span> <span class="variable">rocketMsg</span> <span class="operator">=</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">org</span>.apache.rocketmq.common.message.Message(message.getTopic(), message.getTags(),</span><br><span class="line">message.getKey(), message.getBody().getBytes(StandardCharsets.UTF_8));</span><br><span class="line"><span class="keyword">if</span> (message.getDelayTimeLevel() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">rocketMsg.setDelayTimeLevel(message.getDelayTimeLevel());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> rocketMsg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转化为自定义的 MessageSendResult</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sendResult</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> MessageSendResult <span class="title function_">transfer</span><span class="params">(SendResult sendResult)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> MessageSendResult.builder()</span><br><span class="line">.topic(sendResult.getMessageQueue().getTopic())</span><br><span class="line">.partition(sendResult.getMessageQueue().getQueueId())</span><br><span class="line">.offset(sendResult.getQueueOffset())</span><br><span class="line">.transactionId(sendResult.getTransactionId())</span><br><span class="line">.build();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义 <code>KafkaProvider</code> 类实现 <code>MessageQueueProvider</code> 接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaProvider</span> <span class="keyword">implements</span> <span class="title class_">MessageQueueProvider</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KAFKA_PROVIDER_SEND_INTERRUPTED</span> <span class="operator">=</span> <span class="string">&quot;KafkaProvider send interrupted: &#123;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KAFKA_PROVIDER_CONSUME_ERROR</span> <span class="operator">=</span> <span class="string">&quot;KafkaProvider send error: &#123;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 消息类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">messageQueueType</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> MessageQueueType.KAFKA.name();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 同步发送消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> MessageSendResult <span class="title function_">syncSend</span><span class="params">(Message message)</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; future = kafkaTemplate.send(message.getTopic(), message.getBody());</span><br><span class="line">SendResult&lt;String, String&gt; sendResult = future.get();</span><br><span class="line"><span class="keyword">return</span> transfer(sendResult);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">log.error(KAFKA_PROVIDER_SEND_INTERRUPTED, e.getMessage(), e);</span><br><span class="line">Thread.currentThread().interrupt();</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageSendException</span>(e.getMessage());</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(KAFKA_PROVIDER_CONSUME_ERROR, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageSendException</span>(e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 异步发送消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> messageCallback</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">asyncSend</span><span class="params">(Message message, MessageSendCallback messageCallback)</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; future = kafkaTemplate.send(message.getTopic(), message.getBody());</span><br><span class="line">future.addCallback(<span class="keyword">new</span> <span class="title class_">ListenableFutureCallback</span>&lt;SendResult&lt;String, String&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(SendResult&lt;String, String&gt; sendResult)</span> &#123;</span><br><span class="line">messageCallback.onSuccess(transfer(sendResult));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">messageCallback.onFailed(e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(KAFKA_PROVIDER_CONSUME_ERROR, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageSendException</span>(e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转化为自定义的 MessageSendResult</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sendResult</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> MessageSendResult <span class="title function_">transfer</span><span class="params">(SendResult&lt;String, String&gt; sendResult)</span> &#123;</span><br><span class="line">ProducerRecord&lt;String, String&gt; producerRecord = sendResult.getProducerRecord();</span><br><span class="line"><span class="type">RecordMetadata</span> <span class="variable">recordMetadata</span> <span class="operator">=</span> sendResult.getRecordMetadata();</span><br><span class="line"><span class="keyword">return</span> MessageSendResult.builder()</span><br><span class="line">.topic(producerRecord.topic())</span><br><span class="line">.partition(recordMetadata.partition())</span><br><span class="line">.offset(recordMetadata.offset())</span><br><span class="line">.build();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="生产者代码示例">生产者代码示例</h2><p>业务只需要引入 <code>MessageQueueProvider</code> 就可以实现消息的发送，代码片段如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserMQProducer</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MessageQueueProvider messageQueueProvider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(User user)</span> &#123;</span><br><span class="line"><span class="type">MessageSendResult</span> <span class="variable">result</span> <span class="operator">=</span></span><br><span class="line">messageQueueProvider.syncSend(Message.builder()</span><br><span class="line">.topic(<span class="string">&quot;demo-cola-user&quot;</span>)</span><br><span class="line">.key(String.valueOf(user.getId()))</span><br><span class="line">.tags(<span class="string">&quot;demo&quot;</span>)</span><br><span class="line">.delayTimeLevel(<span class="number">2</span>)</span><br><span class="line">.body(JSONHelper.json().toJSONString(user)).build());</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;发送消息成功, topic: &#123;&#125;, offset: &#123;&#125;, queueId: &#123;&#125;&quot;</span>,</span><br><span class="line">result.getTopic(), result.getOffset(), result.getPartition());</span><br><span class="line"></span><br><span class="line">messageQueueProvider.asyncSend(Message.builder()</span><br><span class="line">.topic(<span class="string">&quot;demo-cola-user&quot;</span>)</span><br><span class="line">.key(String.valueOf(user.getId()))</span><br><span class="line">.tags(<span class="string">&quot;demo&quot;</span>)</span><br><span class="line">.delayTimeLevel(<span class="number">2</span>)</span><br><span class="line">.body(JSONHelper.json().toJSONString(user)).build(),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">MessageSendCallback</span>() &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(MessageSendResult result)</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;发送消息成功, topic: &#123;&#125;, offset: &#123;&#125;, queueId: &#123;&#125;&quot;</span>,</span><br><span class="line">result.getTopic(), result.getOffset(), result.getPartition());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailed</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">log.info(<span class="string">&quot;发送消息失败: &#123;&#125;&quot;</span> , e.getMessage(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的 <code>application.yaml</code> 配置如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">message-queue:</span></span><br><span class="line">    <span class="attr">dynamic:</span></span><br><span class="line">      <span class="attr">primary:</span> <span class="string">RocketMQ</span> <span class="comment"># 配置 RocketMQ 或者 Kafka</span></span><br><span class="line">  <span class="attr">kafka:</span> <span class="comment"># 官方原生配置</span></span><br><span class="line">    <span class="attr">client-id:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line"><span class="attr">bootstrap-servers:</span> <span class="string">localhost:9092</span></span><br><span class="line">    <span class="attr">producer:</span></span><br><span class="line">      <span class="attr">acks:</span> <span class="string">all</span> <span class="comment"># 发送确认机制</span></span><br><span class="line">      <span class="attr">batch-size:</span> <span class="string">4KB</span> <span class="comment"># 批处理发送主题大小</span></span><br><span class="line">      <span class="attr">buffer-memory:</span> <span class="number">40960</span> <span class="comment"># 发送缓冲大小</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span> <span class="comment"># 默认为 0，发送主题失败后重试的次数</span></span><br><span class="line">      <span class="attr">compression-type:</span> <span class="string">lz4</span> <span class="comment"># 压缩类型</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rocketmq:</span>  <span class="comment"># 官方原生配置</span></span><br><span class="line">  <span class="attr">name-server:</span> <span class="string">localhost:9876</span></span><br><span class="line">  <span class="attr">producer:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active&#125;</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">    <span class="attr">send-message-timeout:</span> <span class="number">3000</span> <span class="comment"># 生产消息超时</span></span><br><span class="line">    <span class="attr">retry-times-when-send-failed:</span> <span class="number">2</span> <span class="comment"># 同步模式生产消息失败重试次数</span></span><br><span class="line">    <span class="attr">retry-times-when-send-async-failed:</span> <span class="number">2</span> <span class="comment"># 异步模式生产消息失败重试次数</span></span><br></pre></td></tr></table></figure><p>这样就完成了，我们生产消息只需要调用 <code>MessageQueueProvider</code> 就可以实现消息的发送，通过继承 <code>MessageQueueConsumer</code>，并 <code>@MessageQueueListener</code> 注解，就可以实现消息的消费，业务代码上并没有涉及到第三方消息队列 API。</p><h1>产出</h1><p>通过 API 封装，我们成功实现了消息队列的可切换性，业务代码无需依赖具体的消息队列 API，只需要切换 <code>spring.message-queue.dynamic.primary</code> 配置项，就可以动态实现消息队列的切换。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-solutions/eden-common-mq">eden-common-mq</a> 和 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-common-mq-spring-boot-starter">eden-common-mq-spring-boot-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
            <tag> Spring </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot 实现自定义审计功能</title>
      <link href="/2024/02/11/spring/Spring%20Boot%20%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%A1%E8%AE%A1%E5%8A%9F%E8%83%BD/"/>
      <url>/2024/02/11/spring/Spring%20Boot%20%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%A1%E8%AE%A1%E5%8A%9F%E8%83%BD/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>在现代应用系统中，事件审计是一个至关重要的功能。通过记录用户的操作行为，我们可以追踪问题、分析用户行为，甚至在出现安全问题时提供关键证据。由于目前没有较好的事件审计框架，笔者决定实现一套可扩展的事件审计组件，要求对业务低侵入性，可以轻松获取前后变更的内容。</p><h1>目标</h1><p>提供自定义注解给业务侧，实现开箱即用的事件审计存储功能。</p><h1>实现</h1><h2 id="审计">审计</h2><p>我们定义了 <code>@EventAuditor</code> 注解，关键字段包括 <code>operator</code>（操作人）、<code>content</code>（操作内容模板）、<code>bizScenario</code>（事件发生的场景）等。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EventAuditor &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 操作对象，支持 SpEL 表达式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 操作对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">operator</span><span class="params">()</span> <span class="keyword">default</span> Strings.EMPTY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 操作角色，支持 SpEL 表达式</span></span><br><span class="line"><span class="comment"> * &lt;br/&gt; 用于区分运营人员和用户</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 操作角色</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">role</span><span class="params">()</span> <span class="keyword">default</span> Strings.EMPTY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 业务场景，支持 SpEL 表达式</span></span><br><span class="line"><span class="comment"> * &lt;br/&gt; 推荐风格：产品线+用例+场景</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 业务场景</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">bizScenario</span><span class="params">()</span> <span class="keyword">default</span> Strings.EMPTY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 记录内容</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 记录内容，支持 SpEL 表达式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">content</span><span class="params">()</span> <span class="keyword">default</span> Strings.EMPTY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 额外信息</span></span><br><span class="line"><span class="comment"> * &lt;br/&gt; 防止记录的内容过长无法展示，额外序列化保存</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 额外信息，支持 SpEL 表达式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">extra</span><span class="params">()</span> <span class="keyword">default</span> Strings.EMPTY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 触发条件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 触发条件，为空表示默认触发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">condition</span><span class="params">()</span> <span class="keyword">default</span> Strings.EMPTY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调用方法之前解析 SpEL 参数</span></span><br><span class="line"><span class="comment"> * &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 是否提前解析</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">evalBeforeInvoke</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 是否记录返回值</span></span><br><span class="line"><span class="comment"> * &lt;br/&gt; 防止记录查询类返回的 List 大对象导致 OOM</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 是否记录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">recordReturnValue</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 Spring 的 <code>MethodInterceptor</code>，我们实现了 <code>EventAuditorInterceptor</code> 来捕获 <code>@EventAuditor</code> 注解，并在方法调用前后进行审计记录。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventAuditorInterceptor</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RETURN</span> <span class="operator">=</span> <span class="string">&quot;_return&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ERROR_MSG</span> <span class="operator">=</span> <span class="string">&quot;_errorMsg&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventAuditorConfig eventAuditorConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> AsyncTaskExecutor asyncTaskExecutor;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 方法调用拦截处理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> invocation 方法调用元信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Throwable 异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(<span class="meta">@NotNull</span> MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"><span class="keyword">if</span> (AopUtils.isAopProxy(invocation.getThis())) &#123;</span><br><span class="line"><span class="keyword">return</span> invocation.proceed();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> invocation.getMethod();</span><br><span class="line">EventAuditor[] eventAuditors;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">eventAuditors = method.getAnnotationsByType(EventAuditor.class);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line"><span class="comment">// 如果解析异常，直接执行返回</span></span><br><span class="line"><span class="keyword">return</span> invocation.proceed();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;AuditingEvent&gt; events = Lists.newArrayList();</span><br><span class="line">events.addAll(parseList(invocation, eventAuditors, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">executionCost</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">errorMsg</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// 执行耗时</span></span><br><span class="line"><span class="type">String</span> <span class="variable">watchId</span> <span class="operator">=</span> invocation.getClass() + Strings.DOT + invocation.getMethod().getName();</span><br><span class="line"><span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>(watchId);</span><br><span class="line">stopWatch.start();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">result = invocation.proceed();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line"><span class="keyword">if</span> (stopWatch.isRunning()) &#123;</span><br><span class="line">stopWatch.stop();</span><br><span class="line">executionCost = stopWatch.getTotalTimeMillis();</span><br><span class="line">&#125;</span><br><span class="line">success = <span class="literal">false</span>;</span><br><span class="line">errorMsg = e.getMessage();</span><br><span class="line">SpelEvaluationContext.setVariable(ERROR_MSG, errorMsg);    <span class="comment">// 异常信息</span></span><br><span class="line"><span class="keyword">throw</span> e;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (stopWatch.isRunning()) &#123;</span><br><span class="line">stopWatch.stop();</span><br><span class="line">executionCost = stopWatch.getTotalTimeMillis();</span><br><span class="line">&#125;</span><br><span class="line">SpelEvaluationContext.setVariable(RETURN, result);    <span class="comment">// 返回值处理</span></span><br><span class="line">events.addAll(parseList(invocation, eventAuditors, <span class="literal">false</span>));</span><br><span class="line"><span class="keyword">for</span> (AuditingEvent event : events) &#123;</span><br><span class="line">event.setSuccess(success);</span><br><span class="line">event.setOperateDate(now);</span><br><span class="line">event.setExecutionCost(executionCost);</span><br><span class="line"><span class="keyword">if</span> (errorMsg != <span class="literal">null</span>) &#123;</span><br><span class="line">event.setThrowable(errorMsg);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">send(events);</span><br><span class="line">SpelEvaluationContext.remove(); <span class="comment">// 清理当前线程变量</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 异步开启后需要设置 AsyncTaskExecutor</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> asyncTaskExecutor 异步任务执行器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAsyncTaskExecutor</span><span class="params">(AsyncTaskExecutor asyncTaskExecutor)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.asyncTaskExecutor = asyncTaskExecutor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送审计事件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> events 审计事件列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(List&lt;AuditingEvent&gt; events)</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">senderType</span> <span class="operator">=</span> eventAuditorConfig.getSender().getSenderType();</span><br><span class="line"><span class="type">EventSenderBuilder</span> <span class="variable">eventSenderBuilder</span> <span class="operator">=</span> ExtensionLoader.getExtensionLoader(EventSenderBuilder.class).getExtension(senderType);</span><br><span class="line">eventSenderBuilder.setEventAuditorConfig(eventAuditorConfig);</span><br><span class="line"><span class="type">EventSender</span> <span class="variable">eventSender</span> <span class="operator">=</span> eventSenderBuilder.build();</span><br><span class="line"><span class="keyword">if</span> (eventAuditorConfig.getSender().isAsync() &amp;&amp; asyncTaskExecutor != <span class="literal">null</span>) &#123;</span><br><span class="line">asyncTaskExecutor.execute(() -&gt; eventSender.send(events));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">eventSender.send(events);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析 &#123;<span class="doctag">@code</span> AuditingEvent&#125; 列表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> invocation       方法调用元信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eventAuditors    审计注解</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> evalBeforeInvoke 是否在调用方法之前提前解析</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> AuditingEvent&#125; 列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;AuditingEvent&gt; <span class="title function_">parseList</span><span class="params">(<span class="meta">@NotNull</span> MethodInvocation invocation, EventAuditor[] eventAuditors,</span></span><br><span class="line"><span class="params">  <span class="type">boolean</span> evalBeforeInvoke)</span> &#123;</span><br><span class="line">List&lt;AuditingEvent&gt; events = Lists.newArrayList();</span><br><span class="line"><span class="keyword">for</span> (EventAuditor eventAuditor : eventAuditors) &#123;</span><br><span class="line"><span class="keyword">if</span> (eventAuditor.evalBeforeInvoke() == evalBeforeInvoke) &#123;</span><br><span class="line"><span class="type">AuditingEvent</span> <span class="variable">auditingEvent</span> <span class="operator">=</span> <span class="built_in">this</span>.parseModel(eventAuditor, invocation);</span><br><span class="line"><span class="keyword">if</span> (auditingEvent != <span class="literal">null</span>) &#123;</span><br><span class="line">events.add(auditingEvent);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> events;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析模型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eventAuditor 事件审计注解</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> invocation   方法调用元信息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 目标模型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> AuditingEvent <span class="title function_">parseModel</span><span class="params">(EventAuditor eventAuditor, MethodInvocation invocation)</span> &#123;</span><br><span class="line"><span class="type">EvaluationContext</span> <span class="variable">context</span> <span class="operator">=</span> SpelEvaluationContext.getContext();</span><br><span class="line">CustomFunctionRegistrar.register((StandardEvaluationContext) context);</span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> invocation.getMethod();</span><br><span class="line">String[] parameterNames = SpelExpressionEvaluator.getParameterNameDiscoverer().getParameterNames(method);</span><br><span class="line">Object[] arguments = invocation.getArguments();</span><br><span class="line"><span class="keyword">if</span> (parameterNames != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> parameterNames.length;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">context.setVariable(parameterNames[i], arguments[i]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ExpressionParser</span> <span class="variable">parser</span> <span class="operator">=</span> SpelExpressionEvaluator.getExpressionParser();</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(eventAuditor.condition())) &#123;</span><br><span class="line"><span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(eventAuditor.condition());</span><br><span class="line"><span class="keyword">if</span> (!Boolean.TRUE.equals(expression.getValue(context, Boolean.class))) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">AuditingEvent</span> <span class="variable">auditingEvent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AuditingEvent</span>();</span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(eventAuditor.operator())) &#123;</span><br><span class="line"><span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(eventAuditor.operator());</span><br><span class="line">auditingEvent.setOperator(expression.getValue(context, String.class));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(eventAuditor.role())) &#123;</span><br><span class="line"><span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(eventAuditor.role());</span><br><span class="line">auditingEvent.setRole(expression.getValue(context, String.class));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(eventAuditor.bizScenario())) &#123;</span><br><span class="line"><span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(eventAuditor.bizScenario());</span><br><span class="line">auditingEvent.setBizScenario(expression.getValue(context, String.class));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(eventAuditor.content())) &#123;</span><br><span class="line"><span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(eventAuditor.content());</span><br><span class="line">auditingEvent.setContent(expression.getValue(context, String.class));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (StringUtils.isNotBlank(eventAuditor.extra())) &#123;</span><br><span class="line"><span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> parser.parseExpression(eventAuditor.extra());</span><br><span class="line"><span class="type">Object</span> <span class="variable">extra</span> <span class="operator">=</span> expression.getValue(context, Object.class);</span><br><span class="line">auditingEvent.setExtra(extra <span class="keyword">instanceof</span> String ? (String) extra : JSONHelper.json().toJSONString(extra));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> auditingEvent;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上述代码中有 3 个关键类，分别是：</p><ol><li><code>SpelExpressionEvaluator</code> ：处理 SpEL 表达式。</li><li><code>CustomFunctionRegistrar</code>：存储自定义函数和 Java 方法的关联关系，解析自定义函数时，通过缓存找到对应的 Java 方法反射调用。</li><li><code>EventSenderBuilder</code> ：将事件内容往其他渠道发送，例如消息队列、数据库，便于存储。</li></ol><p>接下来依次展开说明。</p><h2 id="SpEL-表达式解析实现">SpEL 表达式解析实现</h2><p>SpEL 是 Spring 特有的表示解析格式，内部通过 <code>StandardEvaluationContext</code> 实现，我们可以在这个基础上进行封装。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpelExpressionEvaluator</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExpressionParser</span> <span class="variable">PARSER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpelExpressionParser</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ParameterNameDiscoverer</span> <span class="variable">DISCOVERER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LocalVariableTableParameterNameDiscoverer</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExpressionParser <span class="title function_">getExpressionParser</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> PARSER;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ParameterNameDiscoverer <span class="title function_">getParameterNameDiscoverer</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> DISCOVERER;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析 SpEL 表达式</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> expressionString SpEL 表达式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> method           方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> arguments        参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 解析后的内容</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">parseExpression</span><span class="params">(String expressionString, Method method, Object[] arguments)</span> &#123;</span><br><span class="line">String[] params = DISCOVERER.getParameterNames(method);</span><br><span class="line"><span class="keyword">if</span> (params != <span class="literal">null</span> &amp;&amp; params.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; params.length; i++) &#123;</span><br><span class="line">SpelEvaluationContext.setVariable(params[i], arguments[i]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Expression</span> <span class="variable">expression</span> <span class="operator">=</span> PARSER.parseExpression(expressionString);</span><br><span class="line"><span class="keyword">return</span> expression.getValue(SpelEvaluationContext.getContext(), String.class);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpelEvaluationContext</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> TransmittableThreadLocal&lt;EvaluationContext&gt; VARIABLES =</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;EvaluationContext&gt;() &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> EvaluationContext <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StandardEvaluationContext</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> EvaluationContext <span class="title function_">getContext</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> VARIABLES.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">lookupVariable</span><span class="params">(String key)</span> &#123;</span><br><span class="line"><span class="type">EvaluationContext</span> <span class="variable">context</span> <span class="operator">=</span> getContext();</span><br><span class="line"><span class="keyword">return</span> context.lookupVariable(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setVariable</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line"><span class="type">EvaluationContext</span> <span class="variable">context</span> <span class="operator">=</span> getContext();</span><br><span class="line">context.setVariable(key, value);</span><br><span class="line">VARIABLES.set(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">VARIABLES.remove();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义函数解决上下文历史">自定义函数解决上下文历史</h2><p>通过 <code>MethodInterceptor</code> 方法拦截只能获取入参和返回值，对于修改内容的场景，没办法获取原始记录。我们引入了 <code>CustomFunctionRegistrar</code> 自定义函数，由用户来决定调用哪个 Java 方法。</p><p>在应用启动时，基于 Spring 自动扫描所有标记了 <code>CustomFunctionRegistrar</code> 的代码，通过 AOP 生成代理，将自定义函数和代理方法的映射存到缓存中，这样就可以通过自定义函数找到代理方法，调用业务指定的逻辑了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomFunctionRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ApplicationContextAware</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Method&gt; FUNCTION_CACHE = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> applicationContext ApplicationContext</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BeansException 初始化Bean异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">initialize(applicationContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化自定义函数</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> applicationContext ApplicationContext</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(ApplicationContext applicationContext)</span> &#123;</span><br><span class="line">Map&lt;String, Object&gt; components = applicationContext.getBeansWithAnnotation(Component.class);</span><br><span class="line">components.values().forEach(component -&gt; &#123;</span><br><span class="line">Method[] methods = component.getClass().getMethods();</span><br><span class="line"><span class="keyword">if</span> (methods.length == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">targetObject</span> <span class="operator">=</span> AopUtils.getDynamicProxyTargetObject(component);</span><br><span class="line"><span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line"><span class="type">CustomFunction</span> <span class="variable">annotation</span> <span class="operator">=</span> AnnotatedElementUtils.findMergedAnnotation(method, CustomFunction.class);</span><br><span class="line"><span class="keyword">if</span> (annotation == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (ReflectionUtils.isStaticMethod(method)) &#123;</span><br><span class="line">cache(annotation, method);</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">Class&lt;?&gt; targetClass = targetObject.getClass();</span><br><span class="line"><span class="type">String</span> <span class="variable">staticallyClassName</span> <span class="operator">=</span> targetClass.getName() + <span class="string">&quot;_Statically&quot;</span>;</span><br><span class="line">Class&lt;?&gt; delegateClass;</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.getOrNull(staticallyClassName);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (ctClass == <span class="literal">null</span>) &#123;</span><br><span class="line">ctClass = constructCtClass(method, pool, targetClass, staticallyClassName);</span><br><span class="line">delegateClass = ctClass.toClass();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">delegateClass = ctClass.getClass().getClassLoader().loadClass(staticallyClassName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span> delegateClass.getConstructor(targetClass).newInstance(component);</span><br><span class="line">Method[] proxyMethods = proxy.getClass().getDeclaredMethods();</span><br><span class="line">Arrays.stream(proxyMethods).forEach(proxyMethod -&gt; &#123;</span><br><span class="line"><span class="keyword">if</span> (Arrays.equals(method.getParameterTypes(), proxyMethod.getParameterTypes()) &amp;&amp;</span><br><span class="line">method.getName().equals(proxyMethod.getName())) &#123;</span><br><span class="line">cache(annotation, proxyMethod);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注册自定义函数到 SpEL解析上下文</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> context SpEL解析上下文</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(StandardEvaluationContext context)</span> &#123;</span><br><span class="line">FUNCTION_CACHE.forEach(context::registerFunction);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">cache</span><span class="params">(CustomFunction annotation, Method method)</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">registerName</span> <span class="operator">=</span> StringUtils.hasText(annotation.value()) ? annotation.value() : method.getName();</span><br><span class="line">FUNCTION_CACHE.put(registerName, method);</span><br><span class="line">log.info(<span class="string">&quot;Register custom function &#x27;&#123;&#125;&#x27; as name &#x27;&#123;&#125;&#x27;&quot;</span>, method, registerName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> CtClass <span class="title function_">constructCtClass</span><span class="params">(Method method, ClassPool pool, Class&lt;?&gt; targetClass, String staticallyClassName)</span></span><br><span class="line"><span class="keyword">throws</span> NotFoundException, CannotCompileException &#123;</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(staticallyClassName);</span><br><span class="line">ctClass.addInterface(pool.get(Serializable.class.getName()));</span><br><span class="line"></span><br><span class="line"><span class="type">CtField</span> <span class="variable">field</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtField</span>(pool.get(targetClass.getName()), <span class="string">&quot;delegating&quot;</span>, ctClass);</span><br><span class="line">field.setModifiers(javassist.Modifier.STATIC | javassist.Modifier.PROTECTED);</span><br><span class="line">ctClass.addField(field);</span><br><span class="line"></span><br><span class="line"><span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;pool.get(targetClass.getName())&#125;, ctClass);</span><br><span class="line">constructor.setBody(<span class="string">&quot;&#123;delegating = $1;&#125;&quot;</span>);</span><br><span class="line">ctClass.addConstructor(constructor);</span><br><span class="line"></span><br><span class="line"><span class="type">CtMethod</span> <span class="variable">getterMethod</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtMethod</span>(pool.get(targetClass.getName()), <span class="string">&quot;getDelegating&quot;</span>, <span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;, ctClass);</span><br><span class="line">getterMethod.setModifiers(javassist.Modifier.PUBLIC);</span><br><span class="line">getterMethod.setBody(<span class="string">&quot;&#123;return delegating;&#125;&quot;</span>);</span><br><span class="line">ctClass.addMethod(getterMethod);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">modifier</span> <span class="operator">=</span> method.getModifiers();</span><br><span class="line">modifier |= javassist.Modifier.STATIC;</span><br><span class="line"><span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">Class&lt;?&gt; returnType = method.getReturnType();</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">builder.append(chooseModifier(modifier)).append(<span class="string">&quot; &quot;</span>)</span><br><span class="line">.append(returnType.getName()).append(<span class="string">&quot; &quot;</span>)</span><br><span class="line">.append(methodName).append(<span class="string">&quot;(&quot;</span>);</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt;[] parameterType = method.getParameterTypes();</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">params</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameterType.length; i++) &#123;</span><br><span class="line">builder.append(parameterType[i].getName()).append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">builder.append(<span class="string">&quot;$_&quot;</span>).append(i).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (params == <span class="literal">null</span>) &#123;</span><br><span class="line">params = <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">&#125;</span><br><span class="line">params.append(<span class="string">&quot;$_&quot;</span>).append(i).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (params != <span class="literal">null</span>) &#123;</span><br><span class="line">builder.delete(builder.length() - <span class="number">1</span>, builder.length());</span><br><span class="line">params.delete(params.length() - <span class="number">1</span>, params.length());</span><br><span class="line">&#125;</span><br><span class="line">builder.append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">builder.append(<span class="string">&quot;&#123;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (!returnType.equals(<span class="keyword">void</span>.class)) &#123;</span><br><span class="line">builder.append(<span class="string">&quot;return&quot;</span>).append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">builder.append(<span class="string">&quot;delegating.&quot;</span>).append(methodName).append(<span class="string">&quot;(&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (params != <span class="literal">null</span>) &#123;</span><br><span class="line">builder.append(params);</span><br><span class="line">&#125;</span><br><span class="line">builder.append(<span class="string">&quot;)&quot;</span>).append(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">builder.append(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">CtMethod</span> <span class="variable">ctMethod</span> <span class="operator">=</span> CtMethod.make(builder.toString(), ctClass);</span><br><span class="line">ctClass.addMethod(ctMethod);</span><br><span class="line"><span class="keyword">return</span> ctClass;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">chooseModifier</span><span class="params">(<span class="type">int</span> modifier)</span> &#123;</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="keyword">if</span> ((modifier &amp; javassist.Modifier.PUBLIC) == javassist.Modifier.PUBLIC) &#123;</span><br><span class="line">builder.append(<span class="string">&quot;public&quot;</span>).append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((modifier &amp; javassist.Modifier.PRIVATE) == javassist.Modifier.PRIVATE) &#123;</span><br><span class="line">builder.append(<span class="string">&quot;private&quot;</span>).append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((modifier &amp; javassist.Modifier.PROTECTED) == javassist.Modifier.PROTECTED) &#123;</span><br><span class="line">builder.append(<span class="string">&quot;protected&quot;</span>).append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((modifier &amp; javassist.Modifier.ABSTRACT) == javassist.Modifier.ABSTRACT) &#123;</span><br><span class="line">builder.append(<span class="string">&quot;abstract&quot;</span>).append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((modifier &amp; javassist.Modifier.STATIC) == javassist.Modifier.STATIC) &#123;</span><br><span class="line">builder.append(<span class="string">&quot;static&quot;</span>).append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((modifier &amp; javassist.Modifier.FINAL) == javassist.Modifier.FINAL) &#123;</span><br><span class="line">builder.append(<span class="string">&quot;final&quot;</span>).append(<span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> builder.toString();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="审计事件内容存储实现">审计事件内容存储实现</h2><p>拦截到审计信息后，接下来要做的事情就是存储。我们定义了 <code>EventSender</code> 接口和 <code>AuditingEvent</code> 审计事件模型。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EventSender</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送审计事件列表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> events 审计事件列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">send</span><span class="params">(List&lt;AuditingEvent&gt; events)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuditingEvent</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 操作对象 */</span></span><br><span class="line"><span class="keyword">private</span> String operator;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 操作角色 */</span></span><br><span class="line"><span class="keyword">private</span> String role;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 操作时间 */</span></span><br><span class="line"><span class="keyword">private</span> LocalDateTime operateDate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 业务场景 */</span></span><br><span class="line"><span class="keyword">private</span> String bizScenario;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 记录内容 */</span></span><br><span class="line"><span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 额外信息 */</span></span><br><span class="line"><span class="keyword">private</span> String extra;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 返回值 */</span></span><br><span class="line"><span class="keyword">private</span> String returnValue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 执行耗时 */</span></span><br><span class="line"><span class="keyword">private</span> Long executionCost;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 执行是否成功 */</span></span><br><span class="line"><span class="keyword">private</span> Boolean success;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 异常信息 */</span></span><br><span class="line"><span class="keyword">private</span> String throwable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在前面的 <code>EventAuditorInterceptor#send()</code> 方法，就是调用了这个接口。</p><p>关于接口的实现，我们预留了扩展点，可以本地日志打印、可以发送到 MQ 或者数据库，例如，本地日志打印实现代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoggingEventSender</span> <span class="keyword">implements</span> <span class="title class_">EventSender</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">AUDITING_EVENT</span> <span class="operator">=</span> <span class="string">&quot;Auditing event: &#123;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Level level;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送审计事件列表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> events 审计事件列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(List&lt;AuditingEvent&gt; events)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (CollectionUtils.isEmpty(events)) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; contents = events.stream()</span><br><span class="line">.map(AuditingEvent::getContent).collect(Collectors.toList());</span><br><span class="line"><span class="keyword">switch</span> (level) &#123;</span><br><span class="line"><span class="keyword">case</span> DEBUG:</span><br><span class="line">log.debug(AUDITING_EVENT, contents);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> INFO:</span><br><span class="line">log.info(AUDITING_EVENT, contents);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> WARN:</span><br><span class="line">log.warn(AUDITING_EVENT, contents);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了简化配置，我们基于 <code>Spring Boot</code> 的自动装配机制进一步封装。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">prefix = EventAuditorProperties.PREFIX,</span></span><br><span class="line"><span class="meta">name = Conditions.ENABLED,</span></span><br><span class="line"><span class="meta">havingValue = Conditions.TRUE,</span></span><br><span class="line"><span class="meta">matchIfMissing = true</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(AsyncTaskExecutionAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@EnableEventAuditor</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(EventAuditorProperties.class)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventAuditorAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = EventAuditorProperties.PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventAuditorProperties</span> <span class="keyword">extends</span> <span class="title class_">EventAuditorConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;event-auditor&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventAuditorConfiguration</span> <span class="keyword">implements</span> <span class="title class_">ImportAware</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> AnnotationAttributes enableEventAuditor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setImportMetadata</span><span class="params">(AnnotationMetadata importMetadata)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.enableEventAuditor = AnnotationAttributes.fromMap(</span><br><span class="line">importMetadata.getAnnotationAttributes(EnableEventAuditor.class.getName(), <span class="literal">false</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.enableEventAuditor == <span class="literal">null</span>) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;@EnableEventAuditor is not present on importing class&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> EventAuditorInterceptor <span class="title function_">eventAuditorInterceptor</span><span class="params">(ObjectProvider&lt;EventAuditorConfig&gt; eventAuditorConfig,</span></span><br><span class="line"><span class="params">   ObjectProvider&lt;AsyncTaskExecutor&gt; asyncTaskExecutor)</span> &#123;</span><br><span class="line"><span class="type">EventAuditorInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventAuditorInterceptor</span>(eventAuditorConfig.getIfUnique(EventAuditorConfig::<span class="keyword">new</span>));</span><br><span class="line">asyncTaskExecutor.ifAvailable(interceptor::setAsyncTaskExecutor);</span><br><span class="line"><span class="keyword">return</span> interceptor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> EventAuditorPointcutAdvisor <span class="title function_">eventAuditorPointcutAdvisor</span><span class="params">(EventAuditorInterceptor eventAuditorInterceptor)</span> &#123;</span><br><span class="line"><span class="type">EventAuditorPointcutAdvisor</span> <span class="variable">pointcutAdvisor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventAuditorPointcutAdvisor</span>();</span><br><span class="line">pointcutAdvisor.setAdviceBeanName(<span class="string">&quot;eventAuditorPointcutAdvisor&quot;</span>);</span><br><span class="line">pointcutAdvisor.setAdvice(eventAuditorInterceptor);</span><br><span class="line"><span class="keyword">if</span> (enableEventAuditor != <span class="literal">null</span>) &#123;</span><br><span class="line">pointcutAdvisor.setOrder(enableEventAuditor.getNumber(<span class="string">&quot;order&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> pointcutAdvisor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CustomFunctionRegistrar <span class="title function_">customFunctionRegistrar</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomFunctionRegistrar</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventAuditorConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Sender</span> <span class="variable">sender</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Sender</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sender</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">senderType</span> <span class="operator">=</span> <span class="string">&quot;logging&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">async</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logging</span> <span class="variable">logging</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Logging</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Kafka</span> <span class="variable">kafka</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Kafka</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">RocketMQ</span> <span class="variable">rocketMQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RocketMQ</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Logging</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">Level</span> <span class="variable">level</span> <span class="operator">=</span> Level.INFO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Kafka</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String topic;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RocketMQ</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String topic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String namespace;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String tags;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String keys;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从配置类可以看到，我们为消息存储提供了 3 个选项: <code>Logging</code> 本地日志、<code>RocketMQ</code> 或 <code>Kafka</code>。</p><h2 id="代码使用示例">代码使用示例</h2><p>假设我们在 <code>UserService#modifyUser()</code> 修改用户信息，需要记录修改了哪些内容。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;userService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改用户</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> cmd</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EventAuditor(bizScenario = &quot;&#x27;demo.users.getUserById&#x27;&quot;, operator = &quot;#operator&quot;,</span></span><br><span class="line"><span class="meta">content = &quot;&#x27;用户&#x27; + #cmd.login + &#x27;修改了邮箱，从&#x27; + #queryOldEmail(#cmd.id) + &#x27;修改为&#x27; + #cmd.email&quot;)</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Response <span class="title function_">modifyUser</span><span class="params">(UserModifyCmd cmd)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> userModifyCmdExe.execute(cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义函数</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id 用户ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 数据库值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@CustomFunction(&quot;queryOldEmail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">queryOldEmail</span><span class="params">(Long id)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.getUserById(UserByIdQry.builder().id(id).build()).getData().getEmail();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的 <code>application.yaml</code> 配置文件设置如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">event-auditor:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">sender:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">logging</span></span><br><span class="line"><span class="comment"># type: kafka</span></span><br><span class="line"><span class="comment"># kafka:</span></span><br><span class="line"><span class="comment">#   topic: demo</span></span><br><span class="line"><span class="comment"># type: rocketmq</span></span><br><span class="line"><span class="comment"># rocketmq:</span></span><br><span class="line"><span class="comment">#   topic: demo</span></span><br><span class="line"><span class="comment">#   namespace: test  </span></span><br></pre></td></tr></table></figure><p>因为笔者配置了 <code>event-auditor.sender.type=logging</code>，所以，审计内容输出到控制台日志，如下图，当调用用户信息更新接口，在控制台打印了 <code>用户admin修改了邮箱</code> 字眼。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-event-auditor.png" alt=""></p><h1>产出</h1><p>对业务代码的侵入性极小，扩展性很高，可以轻松实现事件审计的记录，并存储到你想要的位置。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-solutions/eden-event-auditor">eden-event-auditor</a> 和 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-event-auditor-spring-boot-starter">eden-event-auditor-spring-boot-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
            <tag> Spring </tag>
            
            <tag> 自定义审计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring 扩展 Bean 动态注册和销毁</title>
      <link href="/2024/02/11/spring/Spring%20%E6%89%A9%E5%B1%95%20Bean%20%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E5%92%8C%E9%94%80%E6%AF%81/"/>
      <url>/2024/02/11/spring/Spring%20%E6%89%A9%E5%B1%95%20Bean%20%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E5%92%8C%E9%94%80%E6%AF%81/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>Spring Boot Starters 的自动装配机制给我们提供了非常丰富的扩展点，但有时候需要动态开启或者关闭某些组件，只能修改配置，重启服务才能生效。例如，我们接入了 Arthas 工具，有时候需要关闭，有时候需要开启，但又不能随意重启服务。</p><h1>目标</h1><p>监听 Spring Boot Starters 组件的配置变化，动态注册销毁 Bean。</p><h1>实现</h1><p>以 Arthas Spring Boot Starter 组件为例。我们发现 Spring Cloud 组件提供了 <code>EnvironmentChangeEvent</code> 作为配置变更事件，传入 <code>ApplicationListener</code> 监听器可以实现配置变化的监听，代码片段如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArthasEnvironmentChangeListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;EnvironmentChangeEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ARTHAS_AGENT</span> <span class="operator">=</span> <span class="string">&quot;arthasAgent&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArthasProperties arthasProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; arthasConfigMap;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(EnvironmentChangeEvent event)</span> &#123;</span><br><span class="line">        Set&lt;String&gt; keys = event.getKeys();</span><br><span class="line">        <span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;spring.arthas.enabled&quot;</span>.equals(key)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Boolean.parseBoolean(environment.getProperty(key))) &#123;</span><br><span class="line">                    registerBean(); <span class="comment">// 注册 Bean</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    destroyBean(); <span class="comment">// 销毁 Bean</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">defaultListableBeanFactory</span> <span class="operator">=</span> getDefaultListableBeanFactory();</span><br><span class="line">        <span class="keyword">if</span> (defaultListableBeanFactory.containsBean(ARTHAS_AGENT)) &#123;  <span class="comment">// 检查 Bean 是否存在 Spring 缓存</span></span><br><span class="line">            defaultListableBeanFactory.getBean(ARTHAS_AGENT)).init(); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            defaultListableBeanFactory.registerSingleton(ARTHAS_AGENT, <span class="keyword">new</span> <span class="title class_">ArthasAgent</span>(arthasConfigMap, arthasProperties));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">destroyBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">defaultListableBeanFactory</span> <span class="operator">=</span> getDefaultListableBeanFactory();</span><br><span class="line">        <span class="keyword">if</span> (defaultListableBeanFactory.containsBean(ARTHAS_AGENT)) &#123;</span><br><span class="line">            defaultListableBeanFactory.getBean(ARTHAS_AGENT)).destroy();</span><br><span class="line">            defaultListableBeanFactory.destroySingleton(ARTHAS_AGENT); <span class="comment">// 从 Spring 缓存移除 Bean</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> DefaultListableBeanFactory <span class="title function_">getDefaultListableBeanFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (DefaultListableBeanFactory) applicationContext.getAutowireCapableBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将 <code>ArthasEnvironmentChangeListener</code> 复制到 <code>ArthasAutoConfiguration</code> 类注册 Bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureBefore(ArthasConfiguration.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123; SpringArthasProperties.class, ArthasProperties.class &#125;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArthasAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册监听器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ArthasEnvironmentChangeListener <span class="title function_">arthasEnvironmentChangeListener</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@Autowired</span> <span class="meta">@Qualifier(ARTHAS_CONFIG_MAP)</span> Map&lt;String, String&gt; arthasConfigMap)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArthasEnvironmentChangeListener</span>(applicationContext, environment, arthasProperties, arthasConfigMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动时判断是否开启，如果开启则注册 Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">        name = &#123;&quot;spring.arthas.enabled&quot;&#125;,</span></span><br><span class="line"><span class="meta">        matchIfMissing = true</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ArthasAgent <span class="title function_">arthasAgent</span><span class="params">(<span class="meta">@Autowired</span> <span class="meta">@Qualifier(ARTHAS_CONFIG_MAP)</span> Map&lt;String, String&gt; arthasConfigMap)</span> &#123;</span><br><span class="line">        arthasConfigMap = StringUtils.removeDashKey(arthasConfigMap);</span><br><span class="line">        <span class="keyword">return</span> init(arthasConfigMap, environment, arthasProperties); <span class="comment">// 初始化 Bean，细节省略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将 <code>ArthasAutoConfiguration</code> 类添加到 spring.factories 文件即可。</p><p>在 Nacos 设置 <code>spring.arthas.enabled=false</code>，期望关闭 Arthas。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-nacos-disabled-arthas.png" alt=""></p><p>从控制台可以看到 <code>Destroy arthas from ws:...</code> 字眼。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-java-destroy-arthas.png" alt=""></p><p>在 Nacos 设置 <code>spring.arthas.enabled=true</code>，期望开启 Arthas。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-nacos-enabled-arthas.png" alt=""></p><p>从控制台可以看到 <code>Register arthas to ws:...</code> 字眼。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-java-register-arthas.png" alt=""></p><h1>产出</h1><p>研发团队在生产环境的配置中心发布配置更新，可以实现应用零停机动态注册和销毁 Bean，解决了特定场景的需求。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-arthas-spring-boot-starter">eden-arthas-spring-boot-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis 拦截器解析原始 SQL 语句</title>
      <link href="/2024/02/02/spring/Mybatis%20%E6%8B%A6%E6%88%AA%E5%99%A8%E8%A7%A3%E6%9E%90%E5%8E%9F%E5%A7%8B%20SQL%20%E8%AF%AD%E5%8F%A5/"/>
      <url>/2024/02/02/spring/Mybatis%20%E6%8B%A6%E6%88%AA%E5%99%A8%E8%A7%A3%E6%9E%90%E5%8E%9F%E5%A7%8B%20SQL%20%E8%AF%AD%E5%8F%A5/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>MyBatis Plus 通过配置文件中设置 <code>log-impl</code> 属性来指定日志实现，以打印 SQL 语句。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org.ylzl.eden.demo.mapper:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure><p>打印出来的 SQL 内容如下。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">==&gt;  Preparing: <span class="keyword">SELECT</span> id,<span class="keyword">login</span>,email,activated,locked,lang_key,activation_key,reset_key,reset_date,created_by,created_date,last_modified_by,last_modified_date <span class="keyword">FROM</span> demo_user <span class="keyword">WHERE</span> id=?</span><br><span class="line">==&gt; Parameters: <span class="number">1</span>(Long)</span><br><span class="line">&lt;==  <span class="keyword">Columns</span>: ID, <span class="keyword">LOGIN</span>, EMAIL, ACTIVATED, LOCKED, LANG_KEY, ACTIVATION_KEY, RESET_KEY, RESET_DATE, CREATED_BY, CREATED_DATE, LAST_MODIFIED_BY, LAST_MODIFIED_DATE</span><br><span class="line">&lt;==  <span class="keyword">Row</span>: <span class="number">1</span>, <span class="keyword">admin</span>, <span class="number">1813986321</span>@qq.com, <span class="keyword">TRUE</span>, <span class="keyword">FALSE</span>, zh-cn, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">system</span>, <span class="number">2025</span><span class="number">-02</span><span class="number">-10</span> <span class="number">22</span>:<span class="number">31</span>:<span class="number">03.818</span>, <span class="keyword">system</span>, <span class="keyword">null</span></span><br><span class="line">&lt;==  Total: <span class="number">1</span></span><br></pre></td></tr></table></figure><p>然而，默认的日志输出格式存在以下不足：</p><ol><li>缺少日志时间，无法快速定位 SQL 执行时间。</li><li>SQL 语句可读性差，复杂的 SQL 语句难以阅读。</li><li>日志存储成本高：SQL 模板占用较多字符，增加了日志存储成本。</li></ol><h1>目标</h1><p>通过 MyBatis 的拦截器实现 SQL 原始语句的打印。</p><h1>实现</h1><p>首先，自定义 MyBatis 拦截器，实现 <code>org.apache.ibatis.plugin.Interceptor</code> 接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Intercepts(&#123;</span></span><br><span class="line"><span class="meta">@Signature(method = &quot;query&quot;, type = Executor.class, args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class&#125;),</span></span><br><span class="line"><span class="meta">@Signature(method = &quot;query&quot;, type = Executor.class, args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class, CacheKey.class, BoundSql.class&#125;),</span></span><br><span class="line"><span class="meta">@Signature(method = &quot;update&quot;, type = Executor.class, args = &#123;MappedStatement.class, Object.class&#125;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisSqlLogInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(<span class="string">&quot;MybatisSqlLog&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">Duration</span> <span class="variable">slownessThreshold</span> <span class="operator">=</span> Duration.ofMillis(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line"><span class="type">MappedStatement</span> <span class="variable">mappedStatement</span> <span class="operator">=</span> (MappedStatement) invocation.getArgs()[<span class="number">0</span>];</span><br><span class="line"><span class="type">String</span> <span class="variable">mapperId</span> <span class="operator">=</span> mappedStatement.getId();</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">originalSql</span> <span class="operator">=</span> MybatisUtils.getSql(mappedStatement, invocation);</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> SystemClock.now();</span><br><span class="line"><span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> invocation.proceed();</span><br><span class="line"><span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> SystemClock.now() - start;</span><br><span class="line">        <span class="comment">// 当 SQL 执行超过我们设置的阈值，转为 WARN 级别 </span></span><br><span class="line"><span class="keyword">if</span> (Duration.ofMillis(duration).compareTo(slownessThreshold) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">log.info(<span class="string">&quot;&#123;&#125; execute sql: &#123;&#125; (&#123;&#125; ms)&quot;</span>, mapperId, originalSql, duration);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.warn(<span class="string">&quot;&#123;&#125; execute sql took more than &#123;&#125; ms: &#123;&#125; (&#123;&#125; ms)&quot;</span>, mapperId, slownessThreshold.toMillis(), originalSql, duration);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">plugin</span><span class="params">(Object target)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (target <span class="keyword">instanceof</span> Executor) &#123;</span><br><span class="line"><span class="keyword">return</span> Plugin.wrap(target, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置慢 SQL 阈值，单位为秒</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSlownessThreshold</span><span class="params">(Duration slownessThreshold)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.slownessThreshold = slownessThreshold;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>笔者编写了一个工具类负责解析 MyBatis 执行语句，还原为可执行的 SQL 内容。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@UtilityClass</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">PARAMETER_PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;\\?&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getSql</span><span class="params">(MappedStatement mappedStatement, Invocation invocation)</span> &#123;</span><br><span class="line"><span class="type">Object</span> <span class="variable">parameter</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (invocation.getArgs().length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">parameter = invocation.getArgs()[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">BoundSql</span> <span class="variable">boundSql</span> <span class="operator">=</span> mappedStatement.getBoundSql(parameter);</span><br><span class="line"><span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> mappedStatement.getConfiguration();</span><br><span class="line"><span class="keyword">return</span> resolveSql(configuration, boundSql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">resolveSql</span><span class="params">(Configuration configuration, BoundSql boundSql)</span> &#123;</span><br><span class="line"><span class="type">Object</span> <span class="variable">parameterObject</span> <span class="operator">=</span> boundSql.getParameterObject();</span><br><span class="line">List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();</span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> boundSql.getSql().replaceAll(<span class="string">&quot;[\\s]+&quot;</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (!parameterMappings.isEmpty() &amp;&amp; parameterObject != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="type">TypeHandlerRegistry</span> <span class="variable">typeHandlerRegistry</span> <span class="operator">=</span> configuration.getTypeHandlerRegistry();</span><br><span class="line"><span class="keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;</span><br><span class="line">sql = sql.replaceFirst(<span class="string">&quot;\\?&quot;</span>, Matcher.quoteReplacement(resolveParameterValue(parameterObject)));</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="type">MetaObject</span> <span class="variable">metaObject</span> <span class="operator">=</span> configuration.newMetaObject(parameterObject);</span><br><span class="line"><span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> PARAMETER_PATTERN.matcher(sql);</span><br><span class="line"><span class="type">StringBuffer</span> <span class="variable">sqlBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line"><span class="keyword">for</span> (ParameterMapping parameterMapping : parameterMappings) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">propertyName</span> <span class="operator">=</span> parameterMapping.getProperty();</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (metaObject.hasGetter(propertyName)) &#123;</span><br><span class="line">obj = metaObject.getValue(propertyName);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;</span><br><span class="line">obj = boundSql.getAdditionalParameter(propertyName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">matcher.appendReplacement(sqlBuffer, Matcher.quoteReplacement(resolveParameterValue(obj)));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">matcher.appendTail(sqlBuffer);</span><br><span class="line">sql = sqlBuffer.toString();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sql;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">resolveParameterValue</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (obj <span class="keyword">instanceof</span> CharSequence) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&#x27;&quot;</span> + obj + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Date) &#123;</span><br><span class="line"><span class="type">DateFormat</span> <span class="variable">formatter</span> <span class="operator">=</span> DateFormat.getDateTimeInstance(DateFormat.DEFAULT, DateFormat.DEFAULT, Locale.CHINA);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&#x27;&quot;</span> + formatter.format(obj) + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> obj == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : String.valueOf(obj);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将 MyBatis 拦截器设置为 Spring 自动装配。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureAfter(DataSourceAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(SqlSessionFactory.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;mybatis.plugin.sql-log.enabled&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;MybatisPluginProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPluginAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MybatisPluginProperties mybatisPluginProperties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MybatisSqlLogInterceptor <span class="title function_">mybatisSqlLogInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">MybatisSqlLogInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisSqlLogInterceptor</span>();</span><br><span class="line">interceptor.setSlownessThreshold(mybatisPluginProperties.getSqlLog().getSlownessThreshold());</span><br><span class="line"><span class="keyword">return</span> interceptor;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mybatis.plugin&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPluginProperties</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">SqlLog</span> <span class="variable">sqlLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlLog</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SqlLog</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">Duration</span> <span class="variable">slownessThreshold</span> <span class="operator">=</span> Duration.ofMillis(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当项目配置了属性 <code>mybatis.plugin.sql-log.enabled=true</code> 时，SQL 拦截将生效，打印的内容如下。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2024</span><span class="number">-02</span><span class="number">-10</span> <span class="number">23</span>:<span class="number">03</span>:<span class="number">01.845</span> INFO  [dev] [XNIO<span class="number">-1</span> task<span class="number">-1</span>] org.ylzl.eden.demo.infrastructure.user.database.UserMapper.selectById <span class="keyword">execute</span> <span class="keyword">sql</span>: <span class="keyword">SELECT</span> id,login,email,activated,locked,lang_key,activation_key,reset_key,reset_date,created_by,created_date,last_modified_by,last_modified_date <span class="keyword">FROM</span> demo_user <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span> (<span class="number">10</span> ms)</span><br></pre></td></tr></table></figure><p>这种日志格式比较符合我们实际的生产要求：<code>提供日志时间</code>、<code>可运行的 SQL</code>、<code>执行耗时</code>。</p><h1>产出</h1><p>团队引入这个组件后，在定位生产 SQL 问题时，比原来清晰多了，并且，日志文件缩减了 30% 存储成本。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-mybatis-spring-boot-starter">eden-mybatis-spring-boot-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 扩展点 </tag>
            
            <tag> 降本增效 </tag>
            
            <tag> Mybatis </tag>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis 自动填充创建时间和更新时间字段</title>
      <link href="/2024/02/02/spring/Mybatis%20%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85%E5%88%9B%E5%BB%BA%E6%97%B6%E9%97%B4%E5%92%8C%E6%9B%B4%E6%96%B0%E6%97%B6%E9%97%B4%E5%AD%97%E6%AE%B5/"/>
      <url>/2024/02/02/spring/Mybatis%20%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85%E5%88%9B%E5%BB%BA%E6%97%B6%E9%97%B4%E5%92%8C%E6%9B%B4%E6%96%B0%E6%97%B6%E9%97%B4%E5%AD%97%E6%AE%B5/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>Spring JPA 提供了 <code>@CreatedDate</code>、<code>@LastModifiedDate</code> 注解，用于自动赋值实体类的创建时间和更新时间。但我们的团队主要使用 MyBatis-Plus 作为 ORM 框架，需要提供同类的机制支持。</p><h1>目标</h1><p>为 MyBatis-Plus 提供自动填充功能。</p><h1>实现</h1><p>MyBatis-Plus 也提供了自动填充功能，通过实现 <code>com.baomidou.mybatisplus.core.handlers.MetaObjectHandler</code> 接口来实现。笔者定了 <code>AutofillMetaObjectHandler</code> 类实现，如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutofillMetaObjectHandler</span> <span class="keyword">implements</span> <span class="title class_">MetaObjectHandler</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String createdDateFieldName;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String lastModifiedDateFieldName;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 插入元对象字段填充（用于插入时对公共字段的填充）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> metaObject 元对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertFill</span><span class="params">(MetaObject metaObject)</span> &#123;</span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line"><span class="built_in">this</span>.strictInsertFill(metaObject, createdDateFieldName, LocalDateTime.class, now);</span><br><span class="line"><span class="built_in">this</span>.strictUpdateFill(metaObject, lastModifiedDateFieldName, LocalDateTime.class, now);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新元对象字段填充（用于更新时对公共字段的填充）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> metaObject 元对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateFill</span><span class="params">(MetaObject metaObject)</span> &#123;</span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line"><span class="built_in">this</span>.strictUpdateFill(metaObject, lastModifiedDateFieldName, LocalDateTime.class, now);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>预留了 <code>createdDateFieldName</code> 和 <code>lastModifiedDateFieldName</code> 字段，提供给 <code>@Configuration</code> 配置类扩展。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureAfter(MybatisPlusAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;</span></span><br><span class="line"><span class="meta">SqlSessionFactory.class,</span></span><br><span class="line"><span class="meta">SqlSessionFactoryBean.class,</span></span><br><span class="line"><span class="meta">MybatisConfiguration.class</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;mybatis-plus.extension.auto-fill.enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;MybatisPlusExtensionProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusExtensionAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> MetaObjectHandler <span class="title function_">metaObjectHandler</span><span class="params">(MybatisPlusExtensionProperties properties)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired MetaObjectHandler&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutofillMetaObjectHandler</span>(properties.getAutoFill().getCreatedDateFieldName(),</span><br><span class="line">properties.getAutoFill().getLastModifiedDateFieldName());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;mybatis-plus.extension&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusExtensionProperties</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AutoFill</span> <span class="variable">autoFill</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AutoFill</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AutoFill</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabled</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">createdDateFieldName</span> <span class="operator">=</span> <span class="string">&quot;created_date&quot;</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">lastModifiedDateFieldName</span> <span class="operator">=</span> <span class="string">&quot;last_modified_date&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MybatisPlusExtensionProperties</code> 属性类默认设置 <code>created_date</code> 字段为 SQL 表的创建时间，<code>last_modified_date</code> 为最后修改时间，业务方可以通过 <code>mybatis-plus.extension.auto-fill.created-date-field-name</code> 和 <code>mybatis-plus.extension.auto-fill.last-modified-date-field-name</code> 自行调整。</p><p>业务方在项目配置 <code>mybatis-plus.extension.auto-fill.enabled=true</code> 启用 MyBatis-Plus 自动填充，在实体类中使用 <code>@TableField</code> 注解来标记哪些字段需要自动填充，并指定填充的策略，如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.INSERT)</span></span><br><span class="line">    <span class="keyword">private</span> String createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.UPDATE)</span></span><br><span class="line">    <span class="keyword">private</span> String updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他字段...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就完成了 MyBatis-Plus 的自动填充功能，根据这个思路，也可以实现 <code>@CreatedBy</code> 创建人和 <code>@LastModifiedBy</code> 最后修改人。</p><h1>产出</h1><p>一般我们在设计表都会保留两个字段：创建时间和最后修改时间，引入这个组件，可以简化业务的处理。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-mybatis-spring-boot-starter">eden-mybatis-spring-boot-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 扩展点 </tag>
            
            <tag> Mybatis </tag>
            
            <tag> Mybatis Plus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sentinel 接入 Prometheus 监控</title>
      <link href="/2024/02/02/spring/Sentinel%20%E6%8E%A5%E5%85%A5%20Prometheus%20%E7%9B%91%E6%8E%A7/"/>
      <url>/2024/02/02/spring/Sentinel%20%E6%8E%A5%E5%85%A5%20Prometheus%20%E7%9B%91%E6%8E%A7/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>由于 Sentinel Dashboard 开源版本没有实现监控数据的持久化，只能查看 5 分钟的内存数据。在项目初期，我们没有足够的精力对 Sentinel 进行改造，因此，将 Sentinel 的监控数据集成到 Prometheus，并导入到 Grafana 可视化管理。</p><h1>目标</h1><p>扩展 Sentinel，将监控数据作为 Spring Boot Actuator 暴露到 Prometheus，并展示到 Grafana 管理。</p><h1>实现</h1><p>从官方的 PR 可以找到，Sentinel 提供了 <a href="https://github.com/alibaba/Sentinel/pull/735">MetricExtension</a> 扩展点，允许您使用 SPI 扩展。</p><p>源码如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.alibaba.csp.sentinel.metric.extension;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MetricExtension</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addPass</span><span class="params">(String resource, <span class="type">int</span> n, Object... args)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addBlock</span><span class="params">(String resource, <span class="type">int</span> n, String origin, BlockException blockException, Object... args)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addSuccess</span><span class="params">(String resource, <span class="type">int</span> n, Object... args)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addException</span><span class="params">(String resource, <span class="type">int</span> n, Throwable throwable)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addRt</span><span class="params">(String resource, <span class="type">long</span> rt, Object... args)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">increaseThreadNum</span><span class="params">(String resource, Object... args)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">decreaseThreadNum</span><span class="params">(String resource, Object... args)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Sentinel 客户端执行onPass 或者 onBlock 方法会调用到这个扩展点。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetricEntryCallback</span> <span class="keyword">implements</span> <span class="title class_">ProcessorSlotEntryCallback</span>&lt;DefaultNode&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPass</span><span class="params">(Context context, ResourceWrapper rw, DefaultNode param, <span class="type">int</span> count, Object... args)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">for</span> (MetricExtension m : MetricExtensionProvider.getMetricExtensions()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (m <span class="keyword">instanceof</span> AdvancedMetricExtension) &#123;</span><br><span class="line">                ((AdvancedMetricExtension) m).onPass(rw, count, args);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                m.increaseThreadNum(rw.getName(), args);</span><br><span class="line">                m.addPass(rw.getName(), count, args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onBlocked</span><span class="params">(BlockException ex, Context context, ResourceWrapper resourceWrapper, DefaultNode param,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> count, Object... args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (MetricExtension m : MetricExtensionProvider.getMetricExtensions()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (m <span class="keyword">instanceof</span> AdvancedMetricExtension) &#123;</span><br><span class="line">                ((AdvancedMetricExtension) m).onBlocked(resourceWrapper, count, context.getOrigin(), ex, args);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                m.addBlock(resourceWrapper.getName(), count, context.getOrigin(), ex, args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因此，我们只需要在 <code>MetricExtension</code> 集成 Prometheus 客户端即可。</p><p>首先，在 pom.xml 引入 Prometheus 依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Prometheus --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.16.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Sentinel --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-extension<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-transport-simple-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>根据 <code>MetricExtensionProvider</code> 源码，找到 SPI 加载的路径为 MetricExtension.class，对应的 package 路径为 <code>com.alibaba.csp.sentinel.metric.extension</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MetricExtensionProvider</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;MetricExtension&gt; metricExtensions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MetricExtensionProvider</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">resolveInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;MetricExtension&gt; extensions = SpiLoader.of(MetricExtension.class).loadInstanceList();</span><br><span class="line">        <span class="keyword">if</span> (extensions.isEmpty()) &#123;</span><br><span class="line">            RecordLog.info(<span class="string">&quot;[MetricExtensionProvider] No existing MetricExtension found&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            metricExtensions.addAll(extensions);</span><br><span class="line">            RecordLog.info(<span class="string">&quot;[MetricExtensionProvider] MetricExtension resolved, size=&#123;&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;extensions.size()&#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;MetricExtension&gt; <span class="title function_">getMetricExtensions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> metricExtensions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addMetricExtension</span><span class="params">(MetricExtension metricExtension)</span> &#123;</span><br><span class="line">        metricExtensions.add(metricExtension);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        resolveInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在目录 <code>src/main/resources/META-INF/services</code> 创建 <code>com.alibaba.csp.sentinel.metric.extension.MetricExtension</code> 文件，内容如下。</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com<span class="selector-class">.xxx</span><span class="selector-class">.spi</span>.PrometheusMetricExtension</span><br></pre></td></tr></table></figure><p>创建 <code>PrometheusMetricExtension</code> 类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrometheusMetricExtension</span> <span class="keyword">implements</span> <span class="title class_">MetricExtension</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SentinelCollectorRegistry registry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SentinelCollectorRegistry <span class="title function_">getRegistry</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (registry != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> registry;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.registry = ApplicationContextHelper.getBean(SentinelCollectorRegistry.class); <span class="comment">// 尝试获取 Spring Bean，具体代码可以搜索 eden-architect 库</span></span><br><span class="line">        <span class="keyword">return</span> registry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPass</span><span class="params">(String resource, <span class="type">int</span> n, Object... args)</span> &#123;</span><br><span class="line">        getRegistry().getPassRequests().labels(resource).inc(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBlock</span><span class="params">(String resource, <span class="type">int</span> n, String origin, BlockException ex, Object... args)</span> &#123;</span><br><span class="line">        getRegistry().getBlockRequests().labels(resource, ex.getClass().getSimpleName(), ex.getRuleLimitApp(), origin).inc(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSuccess</span><span class="params">(String resource, <span class="type">int</span> n, Object... args)</span> &#123;</span><br><span class="line">        getRegistry().getSuccessRequests().labels(resource).inc(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addException</span><span class="params">(String resource, <span class="type">int</span> n, Throwable throwable)</span> &#123;</span><br><span class="line">        getRegistry().getExceptionRequests().labels(resource).inc(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addRt</span><span class="params">(String resource, <span class="type">long</span> rt, Object... args)</span> &#123;</span><br><span class="line">        getRegistry().getRtHist().labels(resource).observe(((<span class="type">double</span>)rt) / <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increaseThreadNum</span><span class="params">(String resource, Object... args)</span> &#123;</span><br><span class="line">    getRegistry().getCurrentThreads().labels(resource).inc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decreaseThreadNum</span><span class="params">(String resource, Object... args)</span> &#123;</span><br><span class="line">    getRegistry().getCurrentThreads().labels(resource).dec();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建 <code>Prometheus</code> 客户端注册类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SentinelCollectorRegistry</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Counter passRequests;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Counter blockRequests;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Counter successRequests;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Counter exceptionRequests;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Histogram rtHist;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Gauge currentThreads;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SentinelCollectorRegistry</span><span class="params">(CollectorRegistry registry)</span> &#123;</span><br><span class="line">passRequests = Counter.build()</span><br><span class="line">.name(<span class="string">&quot;sentinel_pass_requests_total&quot;</span>)</span><br><span class="line">.help(<span class="string">&quot;total pass requests.&quot;</span>)</span><br><span class="line">.labelNames(<span class="string">&quot;resource&quot;</span>)</span><br><span class="line">.register(registry);</span><br><span class="line">blockRequests = Counter.build()</span><br><span class="line">.name(<span class="string">&quot;sentinel_block_requests_total&quot;</span>)</span><br><span class="line">.help(<span class="string">&quot;total block requests.&quot;</span>)</span><br><span class="line">.labelNames(<span class="string">&quot;resource&quot;</span>, <span class="string">&quot;type&quot;</span>, <span class="string">&quot;ruleLimitApp&quot;</span>, <span class="string">&quot;limitApp&quot;</span>)</span><br><span class="line">.register(registry);</span><br><span class="line">successRequests = Counter.build()</span><br><span class="line">.name(<span class="string">&quot;sentinel_success_requests_total&quot;</span>)</span><br><span class="line">.help(<span class="string">&quot;total success requests.&quot;</span>)</span><br><span class="line">.labelNames(<span class="string">&quot;resource&quot;</span>)</span><br><span class="line">.register(registry);</span><br><span class="line">exceptionRequests = Counter.build()</span><br><span class="line">.name(<span class="string">&quot;sentinel_exception_requests_total&quot;</span>)</span><br><span class="line">.help(<span class="string">&quot;total exception requests.&quot;</span>)</span><br><span class="line">.labelNames(<span class="string">&quot;resource&quot;</span>)</span><br><span class="line">.register(registry);</span><br><span class="line">currentThreads = Gauge.build()</span><br><span class="line">.name(<span class="string">&quot;sentinel_current_threads&quot;</span>)</span><br><span class="line">.help(<span class="string">&quot;current thread count.&quot;</span>)</span><br><span class="line">.labelNames(<span class="string">&quot;resource&quot;</span>)</span><br><span class="line">.register(registry);</span><br><span class="line">rtHist = Histogram.build()</span><br><span class="line">.name(<span class="string">&quot;sentinel_requests_latency_seconds&quot;</span>)</span><br><span class="line">.help(<span class="string">&quot;request latency in seconds.&quot;</span>)</span><br><span class="line">.labelNames(<span class="string">&quot;resource&quot;</span>)</span><br><span class="line">.register(registry);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将 <code>SentinelCollectorRegistry</code> 注册为 Spring Bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureBefore(&#123; PrometheusMetricsExportAutoConfiguration.class &#125;)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(MetricsAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(CollectorRegistry.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnEnabledMetricsExport(&quot;prometheus&quot;)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(name = &quot;spring.cloud.sentinel.enabled&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SentinelPrometheusAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SentinelCollectorRegistry <span class="title function_">sentinelCollectorRegistry</span><span class="params">(CollectorRegistry registry)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired SentinelCollectorRegistry&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SentinelCollectorRegistry</span>(registry);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>业务项目在 <code>application.yaml</code> 设置 <code>spring.cloud.sentinel.enabled=true</code> 即可开启我们自定义的组件。启动项目，访问 <code>/actuator/prometheus</code> 端点。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/sentinel/sentinel-spring-boot-actuator.png" alt=""></p><p>导入到 Grafana 查看效果。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/sentinel/sentinel-grafana.png" alt=""></p><h1>产出</h1><p>团队引入这个组件后，可以在 Grafana 直接查看线上 QPS 流量，提高了监控效率。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-cloud/src/main/java/org/ylzl/eden/spring/cloud/sentinel/prometheus">eden-spring-cloud</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 扩展点 </tag>
            
            <tag> Prometheus </tag>
            
            <tag> Sentinel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot 实现可扩展的分布式锁</title>
      <link href="/2024/02/02/spring/Spring%20Boot%20%E5%AE%9E%E7%8E%B0%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
      <url>/2024/02/02/spring/Spring%20Boot%20%E5%AE%9E%E7%8E%B0%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>在 Java 中分布式锁的实现框架‌主要包括基于 <code>数据库</code>、<code>Redis</code> 和 <code>Zookeeper</code> 的实现方式。使用 <code>Redis</code> 实现的组件可以选择 <code>Jedis API</code> 或者 <code>Redisson API</code>，使用 <code>Zookeeper</code> 实现的组件可以选择 <code>Zookeeper API</code> 或者 <code>Curator API</code>。笔者在项目中看到不少这种混用 API 的情况，维护性较差。</p><h1>目标</h1><p>封装通用接口，屏蔽 API 细节，基于 Spring Boot 自动装配管理。</p><h1>实现</h1><p>首先，定义分布式锁接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DistributedLock</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 锁类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 锁类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">lockType</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加锁（阻塞）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 锁对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加锁（阻塞直到超时）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key      锁对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> waitTime 等待时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeUnit 时间单位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 是否加锁成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(String key, <span class="type">int</span> waitTime, TimeUnit timeUnit)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 释放锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 锁对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(String key)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 Jedis 实现接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisDistributedLock</span> <span class="keyword">implements</span> <span class="title class_">DistributedLock</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UNLOCK_LUA</span> <span class="operator">=</span></span><br><span class="line"><span class="string">&quot;if redis.call(\&quot;get\&quot;,KEYS[1]) == ARGV[1] &quot;</span></span><br><span class="line">+ <span class="string">&quot;then return redis.call(\&quot;del\&quot;,KEYS[1])&quot;</span></span><br><span class="line">+ <span class="string">&quot;else return 0 end&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TransmittableThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Jedis jedis;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 锁类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 锁类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">lockType</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> DistributedLockType.JEDIS.name();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阻塞加锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 锁对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NonNull</span> String key)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Jedis create lock &#x27;&#123;&#125;&#x27;&quot;</span>, key);</span><br><span class="line"><span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"><span class="type">SetParams</span> <span class="variable">setParams</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SetParams</span>();</span><br><span class="line">setParams.ex(-<span class="number">1</span>);</span><br><span class="line"><span class="type">boolean</span> isSuccess;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> jedis.set(key, value, setParams);</span><br><span class="line">isSuccess = StringUtils.isNotEmpty(result);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;Jedis create lock &#x27;&#123;&#125;&#x27;, catch exception: &#123;&#125;&quot;</span>, key, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockAcquireException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">threadLocal.set(value);</span><br><span class="line">log.debug(<span class="string">&quot;Jedis create lock &#x27;&#123;&#125;&#x27; successfully&quot;</span>, key);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Jedis create lock &#x27;&#123;&#125;&#x27; failed&quot;</span>, key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> isSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key      锁对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> waitTime 等待时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeUnit 时间单位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 加锁是否成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NonNull</span> String key, <span class="type">int</span> waitTime, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Jedis create lock &#x27;&#123;&#125;&#x27; not support waitTime&quot;</span>, key);</span><br><span class="line"><span class="keyword">return</span> lock(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 释放锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 锁对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(<span class="meta">@NonNull</span> String key)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Jedis release lock &#x27;&#123;&#125;&#x27;&quot;</span>, key);</span><br><span class="line"><span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> threadLocal.get();</span><br><span class="line"><span class="keyword">if</span> (uuid == <span class="literal">null</span>) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Jedis release lock &#x27;&#123;&#125;&#x27; failed due to thread local is null&quot;</span>, key);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">List&lt;String&gt; args = Collections.singletonList(uuid);</span><br><span class="line">List&lt;String&gt; keys = Collections.singletonList(key);</span><br><span class="line">Long result;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">result = (Long) jedis.eval(UNLOCK_LUA, keys, args);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;Jedis release lock &#x27;&#123;&#125;&#x27;, catch exception: &#123;&#125;&quot;</span>, key, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockReleaseException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (result == <span class="literal">null</span> || result == <span class="number">0L</span>) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Jedis release lock &#x27;&#123;&#125;&#x27;, but it not work&quot;</span>, key);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Jedis release lock &#x27;&#123;&#125;&#x27; successfully&quot;</span>, key);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 Redisson 实现接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonDistributedLock</span> <span class="keyword">implements</span> <span class="title class_">DistributedLock</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> TransmittableThreadLocal&lt;RLock&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 锁类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 锁类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">lockType</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> DistributedLockType.REDISSON.name();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阻塞加锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 锁对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NonNull</span> String key)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Redisson create lock &#x27;&#123;&#125;&#x27;&quot;</span>, key);</span><br><span class="line"><span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> redissonClient.getFairLock(key);</span><br><span class="line"><span class="type">boolean</span> isSuccess;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">isSuccess = rLock.tryLock();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;Redisson create lock &#x27;&#123;&#125;&#x27;, catch exception: &#123;&#125;&quot;</span>, key, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockAcquireException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> isSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key      锁对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> waitTime 等待时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeUnit 时间单位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 加锁是否成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NonNull</span> String key, <span class="type">int</span> waitTime, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Redisson create lock &#x27;&#123;&#125;&#x27; with waitTime &#x27;&#123;&#125;&#x27;&quot;</span>, key, waitTime);</span><br><span class="line"><span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> redissonClient.getFairLock(key);</span><br><span class="line"><span class="type">boolean</span> isSuccess;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">isSuccess = rLock.tryLock(waitTime, <span class="number">1</span>, timeUnit);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;Redisson create lock &#x27;&#123;&#125;&#x27; with waitTime &#x27;&#123;&#125;&#x27;, catch exception: &#123;&#125;&quot;</span>, key, waitTime, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockTimeoutException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">threadLocal.set(rLock);</span><br><span class="line">log.debug(<span class="string">&quot;Redisson create lock &#x27;&#123;&#125;&#x27; with waitTime &#x27;&#123;&#125;&#x27; successfully&quot;</span>, key, waitTime);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Redisson create lock &#x27;&#123;&#125;&#x27; with waitTime &#x27;&#123;&#125;&#x27; failed&quot;</span>, key, waitTime);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> isSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 释放锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 锁对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(<span class="meta">@NonNull</span> String key)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Redisson release lock &#x27;&#123;&#125;&#x27;&quot;</span>, key);</span><br><span class="line"><span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> threadLocal.get();</span><br><span class="line"><span class="keyword">if</span> (rLock == <span class="literal">null</span>) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Redisson release lock &#x27;&#123;&#125;&#x27; failed due to thread local is null&quot;</span>, key);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!rLock.isHeldByCurrentThread()) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Curator release lock &#x27;&#123;&#125;&#x27; failed that is not held by current thread&quot;</span>, key);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">rLock.unlock();</span><br><span class="line">threadLocal.remove();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;Redisson release lock &#x27;&#123;&#125;&#x27;, catch exception: &#123;&#125;&quot;</span>, key, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockReleaseException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line">log.debug(<span class="string">&quot;Redisson release lock &#x27;&#123;&#125;&#x27; successfully&quot;</span>, key);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 Zookeeper 实现接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZookeeperDistributedLock</span> <span class="keyword">implements</span> <span class="title class_">DistributedLock</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> TransmittableThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] EMPTY_DATA = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ZooKeeper zooKeeper;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 锁类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 锁类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">lockType</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> DistributedLockType.ZOOKEEPER.name();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阻塞加锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 锁对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NonNull</span> String key)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Zookeeper create lock &#x27;&#123;&#125;&#x27;&quot;</span>, key);</span><br><span class="line"><span class="type">boolean</span> isSuccess;</span><br><span class="line">String result;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">result = zooKeeper.create(key, EMPTY_DATA, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL);</span><br><span class="line">isSuccess = StringUtils.isNotEmpty(result);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;Zookeeper create lock &#x27;&#123;&#125;&#x27;, catch exception: &#123;&#125;&quot;</span>, key, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockAcquireException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">threadLocal.set(result);</span><br><span class="line">log.debug(<span class="string">&quot;Zookeeper create lock &#x27;&#123;&#125;&#x27; successfully&quot;</span>, key);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Zookeeper create lock &#x27;&#123;&#125;&#x27; failed&quot;</span>, key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> isSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key      锁对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> waitTime 等待时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeUnit 时间单位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 加锁是否成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NonNull</span> String key, <span class="type">int</span> waitTime, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Zookeeper create lock &#x27;&#123;&#125;&#x27; not support waitTime&quot;</span>, key);</span><br><span class="line"><span class="keyword">return</span> lock(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 释放锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 锁对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(<span class="meta">@NonNull</span> String key)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Zookeeper release lock &#x27;&#123;&#125;&#x27;&quot;</span>, key);</span><br><span class="line"><span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> threadLocal.get();</span><br><span class="line"><span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Zookeeper release lock &#x27;&#123;&#125;&#x27; failed due to thread local is null&quot;</span>, key);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">zooKeeper.delete(key, -<span class="number">1</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;Zookeeper release lock &#x27;&#123;&#125;&#x27;, catch exception: &#123;&#125;&quot;</span>, key, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockReleaseException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line">log.debug(<span class="string">&quot;Zookeeper release lock &#x27;&#123;&#125;&#x27; successfully&quot;</span>, key);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 Curator 实现接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CuratorDistributedLock</span> <span class="keyword">implements</span> <span class="title class_">DistributedLock</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> TransmittableThreadLocal&lt;InterProcessMutex&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> CuratorFramework curatorFramework;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 锁类型</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 锁类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">lockType</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> DistributedLockType.CURATOR.name();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阻塞加锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 锁对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NonNull</span> String key)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Curator create lock &#x27;&#123;&#125;&#x27;&quot;</span>, key);</span><br><span class="line"><span class="keyword">if</span> (!key.startsWith(Strings.SLASH)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockAcquireException</span>(<span class="string">&quot;Invalid curator lock: &quot;</span> + key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">InterProcessMutex</span> <span class="variable">interProcessMutex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(curatorFramework, key);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">interProcessMutex.acquire();</span><br><span class="line">threadLocal.set(interProcessMutex);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;Curator create lock &#x27;&#123;&#125;&#x27;, catch exception: &#123;&#125;&quot;</span>, key, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockAcquireException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line">log.debug(<span class="string">&quot;Curator create lock &#x27;&#123;&#125;&#x27; successfully&quot;</span>, key);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 加锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key      锁对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> waitTime 等待时间</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timeUnit 时间单位</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 加锁是否成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">lock</span><span class="params">(<span class="meta">@NonNull</span> String key, <span class="type">int</span> waitTime, TimeUnit timeUnit)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Curator create lock &#x27;&#123;&#125;&#x27; with waitTime &#x27;&#123;&#125;&#x27;&quot;</span>, key, waitTime);</span><br><span class="line"><span class="keyword">if</span> (!key.startsWith(Strings.SLASH)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockAcquireException</span>(<span class="string">&quot;Invalid curator lock: &quot;</span> + key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">InterProcessMutex</span> <span class="variable">interProcessMutex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(curatorFramework, key);</span><br><span class="line"><span class="type">boolean</span> isSuccess;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">isSuccess = interProcessMutex.acquire(waitTime, timeUnit);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;Curator create lock &#x27;&#123;&#125;&#x27; with waitTime &#x27;&#123;&#125;&#x27;, catch exception: &#123;&#125;&quot;</span>, key, waitTime, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockTimeoutException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (isSuccess) &#123;</span><br><span class="line">threadLocal.set(interProcessMutex);</span><br><span class="line">log.debug(<span class="string">&quot;Curator create lock &#x27;&#123;&#125;&#x27; with waitTime &#x27;&#123;&#125; successfully&quot;</span>, key, waitTime);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Curator create lock &#x27;&#123;&#125;&#x27; with waitTime &#x27;&#123;&#125; failed&quot;</span>, key, waitTime);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> isSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 释放锁</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> key 锁对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">(<span class="meta">@NonNull</span> String key)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Curator release lock &#x27;&#123;&#125;&#x27;&quot;</span>, key);</span><br><span class="line"><span class="type">InterProcessMutex</span> <span class="variable">interProcessMutex</span> <span class="operator">=</span> threadLocal.get();</span><br><span class="line"><span class="keyword">if</span> (interProcessMutex == <span class="literal">null</span>) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Curator release lock &#x27;&#123;&#125;&#x27; failed due to thread local is null&quot;</span>, key);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!interProcessMutex.isAcquiredInThisProcess()) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Curator release lock &#x27;&#123;&#125;&#x27; failed that is not acquired in process&quot;</span>, key);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">interProcessMutex.release();</span><br><span class="line">threadLocal.remove();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;Curator release lock: &#123;&#125;, catch exception: &#123;&#125;&quot;</span>, key, e.getMessage(), e);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">DistributedLockReleaseException</span>(e.getMessage());</span><br><span class="line">&#125;</span><br><span class="line">log.debug(<span class="string">&quot;Curator release lock &#x27;&#123;&#125;&#x27; successfully&quot;</span>, key);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将具体实现放入 Spring Boot 管理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;distributed-lock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedLockProperties</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String primary;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Redisson</span> <span class="variable">redisson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Redisson</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Curator</span> <span class="variable">curator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Curator</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ZooKeeper</span> <span class="variable">zooKeeper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ZooKeeper</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Redisson</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Jedis</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Curator</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ZooKeeper</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;distributed-lock.jedis&quot;, name = &quot;enabled&quot;, havingValue = true)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(Jedis.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(Jedis.class)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JedisDistributedLockAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DistributedLock <span class="title function_">distributedLock</span><span class="params">(Jedis jedis)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired JedisDistributedLock&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JedisDistributedLock</span>(jedis);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;distributed-lock.redisson&quot;, name = &quot;enabled&quot;, havingValue = true)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(RedissonAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(RedissonClient.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(Redisson.class)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonDistributedLockAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DistributedLock <span class="title function_">distributedLock</span><span class="params">(RedissonClient redissonClient)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired RedissonDistributedLock&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RedissonDistributedLock</span>(redissonClient);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;distributed-lock.zookeeper&quot;, name = &quot;enabled&quot;, havingValue = true)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(ZooKeeper.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(ZookeeperTemplate.class)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZookeeperDistributedLockAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DistributedLock <span class="title function_">distributedLock</span><span class="params">(ZookeeperTemplate zookeeperTemplate)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired ZookeeperDistributedLock&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ZookeeperDistributedLock</span>(zookeeperTemplate.getZookeeper());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;distributed-lock.curator&quot;, name = &quot;enabled&quot;, havingValue = true)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(CuratorFramework.class)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CuratorDistributedLockAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DistributedLock <span class="title function_">distributedLock</span><span class="params">(CuratorFramework curatorFramework)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired CuratorDistributedLock&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CuratorDistributedLock</span>(curatorFramework);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当项目配置 <code>distributed-lock.redisson.enabled=true</code> 时，开启 Redisson 作为分布式锁的底层实现。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">distributed-lock:</span></span><br><span class="line">  <span class="attr">redisson:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启 Redisson 作为分布式锁的底层实现</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">demo@123</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">5000</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure><p>当项目配置 <code>distributed-lock.curator.enabled=true</code> 时，开启 Curator 作为分布式锁的底层实现。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">distributed-lock:</span></span><br><span class="line">  <span class="attr">curator:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启 Curator 作为分布式锁的底层实现</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">  <span class="attr">zookeeper:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">connectString:</span> <span class="string">localhost:2181</span></span><br></pre></td></tr></table></figure><p>业务代码只需要引入 <code>DistributedLock</code> 接口，调用 <code>lock</code> 和 <code>unlock</code> 方法完成分布式场景的加锁和解锁。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> cliass Demo &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DistributedLock distributedLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;demo&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (distributedLock.lock(key, <span class="number">2</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line"><span class="comment">// do something...</span></span><br><span class="line">distributedLock.unlock(key);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>产出</h1><p>通过 API 封装，简化了业务项目对分布式锁的繁琐编码工作，提高开发效率。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-solutions/eden-distributed-lock">eden-distributed-lock</a> 和 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-distributed-lock-spring-boot-starter">eden-distributed-lock-spring-boot-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
            <tag> Spring </tag>
            
            <tag> 分布式锁 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot 实现可扩展的分布式ID生成器</title>
      <link href="/2024/02/02/spring/Spring%20Boot%20%E5%AE%9E%E7%8E%B0%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8FID%E7%94%9F%E6%88%90%E5%99%A8/"/>
      <url>/2024/02/02/spring/Spring%20Boot%20%E5%AE%9E%E7%8E%B0%E5%8F%AF%E6%89%A9%E5%B1%95%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8FID%E7%94%9F%E6%88%90%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>在复杂的分布式系统中，往往需要对大量的数据和消息进行唯一标识。美团技术团队的文章中介绍了 Leaf 分布式ID生成系统的两种方案：<code>Leaf-snowflake</code> 方案和 <code>Leaf-segment</code> 方案。</p><p>Leaf-snowflake 方案沿用 Twitter 开源的雪花算法，在原有的基础上使用 Zookeeper 持久顺序节点进行优化，如下图。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-distributed-uid-leaf-snowflake.png" alt=""></p><p>Leaf-segment 方案基于数据库实现，每次获取一批递增号段的值，用完之后再去数据库获取新的号段，可以生成趋势递增的 ID，同时 ID 号是可计算的，因此不适用于订单 ID 生成场景（容易被竞争对手算出一天的订单量），相关原理如下图。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-distributed-uid-leaf-segment.png" alt=""></p><p>由于 Leaf 分布式ID生成系统设计为独立部署，由各系统接入使用，但稍微维护不当，容易搞垮整个系统。笔者认为，可以将 Leaf 改造为插件化组件，托管到 Spring Boot Starter 自动装配。除此之外，业界开源的组件也有滴滴 TinyId、百度 UidGenerator 等，最好是设计为通用的 ID 生成器，底层实现任意切换，对业务无感知。</p><h1>目标</h1><p>封装通用接口，屏蔽 API 细节，基于 Spring Boot 自动装配管理。</p><h1>实现</h1><p>由于分布式 ID 生成方案有<code>号段生成器</code>和<code>雪花算法生成器</code>这两种，需要分别定义接口。</p><p>首先，定义分布式 ID 号段生成器接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SegmentGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从号段获取ID</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 号段</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将 Leaf 号段生成器的代码迁移过来。由于官方源码依赖于手动创建数据表，笔者在这个基础上进行改良，使用 <code>Liquibase</code> 组件实现自动化创建库表和版本管理。代码片段如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeafSegmentGenerator</span> <span class="keyword">implements</span> <span class="title class_">SegmentGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">LIQUIBASE_SLOWNESS_THRESHOLD</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SegmentGeneratorConfig config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LeafAllocDAO leafAllocDAO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">5</span>, Integer.MAX_VALUE, <span class="number">60L</span>,</span><br><span class="line">TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;(), <span class="keyword">new</span> <span class="title class_">UpdateThreadFactory</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, SegmentBuffer&gt; cache = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> initialized;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">LeafSegmentGenerator</span><span class="params">(SegmentGeneratorConfig config, DataSource dataSource)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.config = config;</span><br><span class="line"><span class="keyword">if</span> (config.getLiquibase().isEnabled()) &#123;</span><br><span class="line"><span class="built_in">this</span>.initDb(dataSource);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">this</span>.leafAllocDAO = <span class="keyword">new</span> <span class="title class_">LeafAllocDAO</span>(dataSource);</span><br><span class="line"><span class="built_in">this</span>.updateCacheFromDb();</span><br><span class="line"><span class="built_in">this</span>.initialized = <span class="literal">true</span>;</span><br><span class="line"><span class="built_in">this</span>.updateCacheFromDbAtEveryMinute();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (!initialized) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SegmentGeneratorException</span>(<span class="string">&quot;Database segment generator not initialized&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> config.getTenant();</span><br><span class="line"><span class="keyword">if</span> (!cache.containsKey(key)) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SegmentGeneratorException</span>(<span class="string">&quot;Database segment cache contains key &#x27;&quot;</span> + key + <span class="string">&quot;&#x27;, please check database&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">SegmentBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> cache.get(key);</span><br><span class="line"><span class="keyword">if</span> (!buffer.isInitialized()) &#123;</span><br><span class="line"><span class="keyword">synchronized</span> (buffer) &#123;</span><br><span class="line"><span class="keyword">if</span> (!buffer.isInitialized()) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">updateSegmentFromDb(key, buffer.getCurrent());</span><br><span class="line">log.debug(<span class="string">&quot;Initialize buffer and update leaf key &#123;&#125; &#123;&#125; from db&quot;</span>, key, buffer.getCurrent());</span><br><span class="line">buffer.setInitialized(<span class="literal">true</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Initialize buffer &#123;&#125; catch exception&quot;</span>, buffer.getCurrent(), e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> getIdFromSegmentBuffer(cache.get(key));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initDb</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line"><span class="type">SpringLiquibase</span> <span class="variable">liquibase</span> <span class="operator">=</span> buildLiquibase(dataSource);</span><br><span class="line"><span class="type">StopWatch</span> <span class="variable">watch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">watch.start();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">liquibase.afterPropertiesSet();</span><br><span class="line">&#125; <span class="keyword">catch</span> (LiquibaseException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SegmentGeneratorException</span>(<span class="string">&quot;Leaf liquibase has initialized your database error&quot;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line">watch.stop();</span><br><span class="line">log.debug(<span class="string">&quot;Leaf liquibase has initialized your database in &#123;&#125; ms&quot;</span>, watch.getTotalTimeMillis());</span><br><span class="line"><span class="keyword">if</span> (watch.getTotalTimeMillis() &gt; LIQUIBASE_SLOWNESS_THRESHOLD * <span class="number">1000L</span>) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Leaf liquibase took more than &#123;&#125; seconds to initialized your database!&quot;</span>, LIQUIBASE_SLOWNESS_THRESHOLD);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> SpringLiquibase <span class="title function_">buildLiquibase</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line"><span class="type">SpringLiquibase</span> <span class="variable">liquibase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringLiquibase</span>();</span><br><span class="line">liquibase.setDataSource(dataSource);</span><br><span class="line">liquibase.setChangeLog(<span class="built_in">this</span>.config.getLiquibase().getChangeLog());</span><br><span class="line">liquibase.setClearCheckSums(<span class="built_in">this</span>.config.getLiquibase().isClearChecksums());</span><br><span class="line">liquibase.setContexts(<span class="built_in">this</span>.config.getLiquibase().getContexts());</span><br><span class="line">liquibase.setDefaultSchema(<span class="built_in">this</span>.config.getLiquibase().getDefaultSchema());</span><br><span class="line">liquibase.setLiquibaseSchema(<span class="built_in">this</span>.config.getLiquibase().getLiquibaseSchema());</span><br><span class="line">liquibase.setLiquibaseTablespace(<span class="built_in">this</span>.config.getLiquibase().getLiquibaseTablespace());</span><br><span class="line">liquibase.setDatabaseChangeLogTable(<span class="built_in">this</span>.config.getLiquibase().getDatabaseChangeLogTable());</span><br><span class="line">liquibase.setDatabaseChangeLogLockTable(<span class="built_in">this</span>.config.getLiquibase().getDatabaseChangeLogLockTable());</span><br><span class="line">liquibase.setDropFirst(<span class="built_in">this</span>.config.getLiquibase().isDropFirst());</span><br><span class="line">liquibase.setShouldRun(<span class="built_in">this</span>.config.getLiquibase().isEnabled());</span><br><span class="line">liquibase.setLabels(<span class="built_in">this</span>.config.getLiquibase().getLabels());</span><br><span class="line">liquibase.setChangeLogParameters(<span class="built_in">this</span>.config.getLiquibase().getParameters());</span><br><span class="line">liquibase.setRollbackFile(<span class="built_in">this</span>.config.getLiquibase().getRollbackFile());</span><br><span class="line">liquibase.setTestRollbackOnUpdate(<span class="built_in">this</span>.config.getLiquibase().isTestRollbackOnUpdate());</span><br><span class="line">liquibase.setTag(<span class="built_in">this</span>.config.getLiquibase().getTag());</span><br><span class="line"><span class="keyword">return</span> liquibase;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateCacheFromDb</span><span class="params">()</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Leaf update cache from db&quot;</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">List&lt;String&gt; dbTags = leafAllocDAO.getAllTags();</span><br><span class="line"><span class="keyword">if</span> (dbTags == <span class="literal">null</span> || dbTags.isEmpty()) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">List&lt;String&gt; cacheTags = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(cache.keySet());</span><br><span class="line">Set&lt;String&gt; insertTagsSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(dbTags);</span><br><span class="line">Set&lt;String&gt; removeTagsSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(cacheTags);</span><br><span class="line"><span class="keyword">for</span> (String tag : cacheTags) &#123;</span><br><span class="line">insertTagsSet.remove(tag);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (String tag : insertTagsSet) &#123;</span><br><span class="line"><span class="type">SegmentBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SegmentBuffer</span>();</span><br><span class="line">buffer.setKey(tag);</span><br><span class="line"><span class="type">Segment</span> <span class="variable">segment</span> <span class="operator">=</span> buffer.getCurrent();</span><br><span class="line">segment.setValue(<span class="keyword">new</span> <span class="title class_">AtomicLong</span>(<span class="number">0</span>));</span><br><span class="line">segment.setMax(<span class="number">0</span>);</span><br><span class="line">segment.setStep(<span class="number">0</span>);</span><br><span class="line">cache.put(tag, buffer);</span><br><span class="line">log.debug(<span class="string">&quot;Leaf add tag &#123;&#125; from db to IdCache&quot;</span>, tag);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (String tag : dbTags) &#123;</span><br><span class="line">removeTagsSet.remove(tag);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (String tag : removeTagsSet) &#123;</span><br><span class="line">cache.remove(tag);</span><br><span class="line">log.debug(<span class="string">&quot;Leaf remove tag &#123;&#125; from IdCache&quot;</span>, tag);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Leaf update cache from db exception&quot;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateCacheFromDbAtEveryMinute</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">ScheduledExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newSingleThreadScheduledExecutor(r -&gt; &#123;</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">t.setName(<span class="string">&quot;leaf-check-id-cache-thread&quot;</span>);</span><br><span class="line">t.setDaemon(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">return</span> t;</span><br><span class="line">&#125;);</span><br><span class="line">service.scheduleWithFixedDelay(<span class="built_in">this</span>::updateCacheFromDb, <span class="number">60</span>, <span class="number">60</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateSegmentFromDb</span><span class="params">(String key, Segment segment)</span> &#123;</span><br><span class="line"><span class="type">SegmentBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> segment.getBuffer();</span><br><span class="line">LeafAlloc leafAlloc;</span><br><span class="line"><span class="keyword">if</span> (!buffer.isInitialized()) &#123;</span><br><span class="line">leafAlloc = leafAllocDAO.updateMaxIdAndGetLeafAlloc(key);</span><br><span class="line">buffer.setStep(leafAlloc.getStep());</span><br><span class="line">buffer.setMinStep(leafAlloc.getStep());</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (buffer.getUpdateTimestamp() == <span class="number">0</span>) &#123;</span><br><span class="line">leafAlloc = leafAllocDAO.updateMaxIdAndGetLeafAlloc(key);</span><br><span class="line">buffer.setUpdateTimestamp(System.currentTimeMillis());</span><br><span class="line">buffer.setStep(leafAlloc.getStep());</span><br><span class="line">buffer.setMinStep(leafAlloc.getStep());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.currentTimeMillis() - buffer.getUpdateTimestamp();</span><br><span class="line"><span class="type">int</span> <span class="variable">nextStep</span> <span class="operator">=</span> buffer.getStep();</span><br><span class="line"><span class="keyword">if</span> (duration &lt; config.getSegmentTtl()) &#123;</span><br><span class="line"><span class="keyword">if</span> (config.getMaxStep() &gt;= nextStep * <span class="number">2</span>) &#123;</span><br><span class="line">nextStep = nextStep * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (duration &gt;= config.getSegmentTtl() * <span class="number">2</span>) &#123;</span><br><span class="line">nextStep = nextStep / <span class="number">2</span> &gt;= buffer.getMinStep() ? nextStep / <span class="number">2</span> : nextStep;</span><br><span class="line">&#125;</span><br><span class="line">log.debug(<span class="string">&quot;leafKey[&#123;&#125;], step[&#123;&#125;], duration[&#123;&#125;mins], nextStep[&#123;&#125;]&quot;</span>, key, buffer.getStep(), String.format(<span class="string">&quot;%.2f&quot;</span>, ((<span class="type">double</span>) duration / (<span class="number">1000</span> * <span class="number">60</span>))), nextStep);</span><br><span class="line"><span class="type">LeafAlloc</span> <span class="variable">temp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LeafAlloc</span>();</span><br><span class="line">temp.setKey(key);</span><br><span class="line">temp.setStep(nextStep);</span><br><span class="line">leafAlloc = leafAllocDAO.updateMaxIdByCustomStepAndGetLeafAlloc(temp);</span><br><span class="line">buffer.setUpdateTimestamp(System.currentTimeMillis());</span><br><span class="line">buffer.setStep(nextStep);</span><br><span class="line">buffer.setMinStep(leafAlloc.getStep());</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> leafAlloc.getMaxId() - buffer.getStep();</span><br><span class="line">segment.getValue().set(value);</span><br><span class="line">segment.setMax(leafAlloc.getMaxId());</span><br><span class="line">segment.setStep(buffer.getStep());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">getIdFromSegmentBuffer</span><span class="params">(<span class="keyword">final</span> SegmentBuffer buffer)</span> &#123;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">buffer.rLock().lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">final</span> <span class="type">Segment</span> <span class="variable">segment</span> <span class="operator">=</span> buffer.getCurrent();</span><br><span class="line"><span class="keyword">if</span> (!buffer.isNextReady() &amp;&amp; (segment.getIdle() &lt; <span class="number">0.9</span> * segment.getStep())</span><br><span class="line">&amp;&amp; buffer.getThreadRunning().compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">executorService.execute(() -&gt; &#123;</span><br><span class="line"><span class="type">Segment</span> <span class="variable">next</span> <span class="operator">=</span> buffer.getSegments()[buffer.nextPos()];</span><br><span class="line"><span class="type">boolean</span> <span class="variable">updateOk</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">updateSegmentFromDb(buffer.getKey(), next);</span><br><span class="line">updateOk = <span class="literal">true</span>;</span><br><span class="line">log.info(<span class="string">&quot;Leaf update segment &#123;&#125; from db &#123;&#125;&quot;</span>, buffer.getKey(), next);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.error(<span class="string">&quot;Leaf update segment &#123;&#125; from db &#123;&#125; error&quot;</span>, buffer.getKey(), e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (updateOk) &#123;</span><br><span class="line">buffer.wLock().lock();</span><br><span class="line">buffer.setNextReady(<span class="literal">true</span>);</span><br><span class="line">buffer.getThreadRunning().set(<span class="literal">false</span>);</span><br><span class="line">buffer.wLock().unlock();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">buffer.getThreadRunning().set(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> segment.getValue().getAndIncrement();</span><br><span class="line"><span class="keyword">if</span> (value &lt; segment.getMax()) &#123;</span><br><span class="line"><span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">buffer.rLock().unlock();</span><br><span class="line">&#125;</span><br><span class="line">waitAndSleep(buffer);</span><br><span class="line">buffer.wLock().lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">final</span> <span class="type">Segment</span> <span class="variable">segment</span> <span class="operator">=</span> buffer.getCurrent();</span><br><span class="line"><span class="type">long</span> <span class="variable">value</span> <span class="operator">=</span> segment.getValue().getAndIncrement();</span><br><span class="line"><span class="keyword">if</span> (value &lt; segment.getMax()) &#123;</span><br><span class="line"><span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (buffer.isNextReady()) &#123;</span><br><span class="line">buffer.switchPos();</span><br><span class="line">buffer.setNextReady(<span class="literal">false</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SegmentGeneratorException</span>(<span class="string">&quot;Both two segments in &#x27;&quot;</span> + buffer + <span class="string">&quot;&#x27; are not ready!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">buffer.wLock().unlock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">waitAndSleep</span><span class="params">(SegmentBuffer buffer)</span> &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">roll</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (buffer.getThreadRunning().get()) &#123;</span><br><span class="line">roll += <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (roll &gt; <span class="number">10000</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">log.warn(<span class="string">&quot;Thread &#123;&#125; Interrupted&quot;</span>, Thread.currentThread().getName());</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UpdateThreadFactory</span> <span class="keyword">implements</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">threadInitNumber</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">nextThreadNum</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> threadInitNumber++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, <span class="string">&quot;leaf-segment-update-&quot;</span> + nextThreadNum());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关于其他代码不是本文讨论的重点，稍后在文章尾部放出整个源码链接。</p><p>好了，接下来设计雪花算法生成器接口。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SnowflakeGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取ID</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ID</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的雪花算法代码实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LeafSnowflakeGenerator</span> <span class="keyword">implements</span> <span class="title class_">SnowflakeGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">workerIdBits</span> <span class="operator">=</span> <span class="number">10L</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">maxWorkerId</span> <span class="operator">=</span> ~(-<span class="number">1L</span> &lt;&lt; workerIdBits);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">sequenceBits</span> <span class="operator">=</span> <span class="number">12L</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">workerIdShift</span> <span class="operator">=</span> sequenceBits;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">timestampLeftShift</span> <span class="operator">=</span> sequenceBits + workerIdBits;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">sequenceMask</span> <span class="operator">=</span> ~(-<span class="number">1L</span> &lt;&lt; sequenceBits);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Random</span> <span class="variable">RANDOM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> workerId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">sequence</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="variable">lastTimestamp</span> <span class="operator">=</span> -<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> twepoch;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">LeafSnowflakeGenerator</span><span class="params">(SnowflakeGeneratorConfig config, App app)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.twepoch = config.getTwepoch();</span><br><span class="line">AssertUtils.isTrue(timeGen() &gt; twepoch, <span class="string">&quot;Snowflake not support twepoch gt currentTime&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.workerId = SnowflakeCoordinatorBuilder.build(config, app).getWorkerId();</span><br><span class="line">AssertUtils.isTrue(workerId &gt;= <span class="number">0</span> &amp;&amp; workerId &lt;= maxWorkerId, <span class="string">&quot;Snowflake worker id must between 0 and 1023&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Synchronized</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">nextId</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> timeGen();</span><br><span class="line"><span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line"><span class="type">long</span> <span class="variable">offset</span> <span class="operator">=</span> lastTimestamp - timestamp;</span><br><span class="line"><span class="keyword">if</span> (offset &lt;= <span class="number">5</span>) &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">wait(offset &lt;&lt; <span class="number">1</span>);</span><br><span class="line">timestamp = timeGen();</span><br><span class="line"><span class="keyword">if</span> (timestamp &lt; lastTimestamp) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SnowflakeGeneratorException</span>(<span class="string">&quot;Snowflake last timestamp gt currentTime&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SnowflakeGeneratorException</span>(<span class="string">&quot;Snowflake next id wait interrupted&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SnowflakeGeneratorException</span>(<span class="string">&quot;Snowflake last timestamp offset gt 5&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (lastTimestamp == timestamp) &#123;</span><br><span class="line">sequence = (sequence + <span class="number">1</span>) &amp; sequenceMask;</span><br><span class="line"><span class="keyword">if</span> (sequence == <span class="number">0</span>) &#123;</span><br><span class="line">sequence = RANDOM.nextInt(<span class="number">100</span>);</span><br><span class="line">timestamp = tillNextMillis(lastTimestamp);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">sequence = RANDOM.nextInt(<span class="number">100</span>);</span><br><span class="line">&#125;</span><br><span class="line">lastTimestamp = timestamp;</span><br><span class="line"><span class="keyword">return</span> ((timestamp - twepoch) &lt;&lt; timestampLeftShift) | (workerId &lt;&lt; workerIdShift) | sequence;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">tillNextMillis</span><span class="params">(<span class="type">long</span> lastTimestamp)</span> &#123;</span><br><span class="line"><span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> timeGen();</span><br><span class="line"><span class="keyword">while</span> (timestamp &lt;= lastTimestamp) &#123;</span><br><span class="line">timestamp = timeGen();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> timestamp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">timeGen</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> System.currentTimeMillis();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和 Twitter 不同的地方是，引入了 <code>SnowflakeCoordinator</code> 雪花算法协调器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI(&quot;zookeeper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SnowflakeCoordinator</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取 workerId</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> workerId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">getWorkerId</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 雪花算法协调器配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config 雪花算法协调器配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SnowflakeCoordinator <span class="title function_">config</span><span class="params">(SnowflakeGeneratorConfig config)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置应用信息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> app 应用信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SnowflakeCoordinator <span class="title function_">app</span><span class="params">(App app)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZookeeperSnowflakeCoordinator</span> <span class="keyword">implements</span> <span class="title class_">SnowflakeCoordinator</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LEAF_SCHEDULE_NAME</span> <span class="operator">=</span> <span class="string">&quot;leaf-zookeeper-schedule&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ZK_PATH_PATTERN</span> <span class="operator">=</span> <span class="string">&quot;/leaf/snowflake/&#123;&#125;/node&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NODE_PREFIX_PATTERN</span> <span class="operator">=</span> ZK_PATH_PATTERN + <span class="string">&quot;/&#123;&#125;:&#123;&#125;-&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CONF_PATH_PATTERN</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;java.io.tmpdir&quot;</span>) + <span class="string">&quot;/leaf/&#123;&#125;/&#123;&#125;/worker-id.properties&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> CuratorFramework curatorFramework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> SnowflakeGeneratorConfig config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> App app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> lastUpdateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getWorkerId</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.startCurator();</span><br><span class="line"><span class="type">int</span> <span class="variable">workerId</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">zkPath</span> <span class="operator">=</span> MessageFormatUtils.format(ZK_PATH_PATTERN, config.getName());</span><br><span class="line">String zkNode;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> curatorFramework.checkExists().forPath(zkPath);</span><br><span class="line"><span class="keyword">if</span> (stat == <span class="literal">null</span>) &#123;</span><br><span class="line">zkNode = createNode();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">Map&lt;String, Integer&gt; nodeIds = Maps.newHashMap();</span><br><span class="line">Map&lt;String, String&gt; nodes = Maps.newHashMap();</span><br><span class="line">List&lt;String&gt; keys = curatorFramework.getChildren().forPath(zkPath);</span><br><span class="line"><span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">String[] nodeKey = key.split(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">nodeIds.put(nodeKey[<span class="number">0</span>], Integer.parseInt(nodeKey[<span class="number">1</span>]));</span><br><span class="line">nodes.put(nodeKey[<span class="number">0</span>], key);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">String</span> <span class="variable">listenAddress</span> <span class="operator">=</span> app.getIp() + <span class="string">&quot;:&quot;</span> + app.getPort();</span><br><span class="line"><span class="type">Integer</span> <span class="variable">nodeWorkerId</span> <span class="operator">=</span> nodeIds.get(listenAddress);</span><br><span class="line"><span class="keyword">if</span> (nodeWorkerId != <span class="literal">null</span>) &#123;</span><br><span class="line">zkNode = zkPath + <span class="string">&quot;/&quot;</span> + nodes.get(listenAddress);</span><br><span class="line">workerId = nodeWorkerId;</span><br><span class="line">checkEndpointTimeStamp(zkNode);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">zkNode = createNode();</span><br><span class="line">String[] nodeKey = zkNode.split(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">workerId = Integer.parseInt(nodeKey[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">this</span>.updateLocalWorkerId(workerId);</span><br><span class="line"><span class="built_in">this</span>.scheduledEndpoint(zkNode);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SnowflakeGeneratorException</span>(e.getMessage(), e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> workerId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 雪花算法协调器配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> config 雪花算法协调器配置</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> this</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SnowflakeCoordinator <span class="title function_">config</span><span class="params">(SnowflakeGeneratorConfig config)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.config = config;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置应用信息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> app 应用信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SnowflakeCoordinator <span class="title function_">app</span><span class="params">(App app)</span> &#123;</span><br><span class="line"><span class="built_in">this</span>.app = app;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启动 CuratorFramework</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startCurator</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (curatorFramework == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (curatorFramework == <span class="literal">null</span>) &#123;</span><br><span class="line">curatorFramework = CuratorFrameworkFactory.builder()</span><br><span class="line">.connectString(config.getCoordinator().getZookeeper().getConnectString())</span><br><span class="line">.retryPolicy(<span class="keyword">new</span> <span class="title class_">RetryUntilElapsed</span>(<span class="number">1000</span>, <span class="number">4</span>))</span><br><span class="line">.connectionTimeoutMs(<span class="number">10000</span>)</span><br><span class="line">.sessionTimeoutMs(<span class="number">6000</span>)</span><br><span class="line">.build();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (curatorFramework.getState() != CuratorFrameworkState.STARTED) &#123;</span><br><span class="line">curatorFramework.start();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建 Zookeeper 顺序节点</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 创建成功后返回的 Zookeeper 的顺序节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> String <span class="title function_">createNode</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> MessageFormatUtils.format(NODE_PREFIX_PATTERN, config.getName(),</span><br><span class="line">app.getIp(), app.getPort());</span><br><span class="line"><span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> Endpoint.build(app.getIp(), app.getPort());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> curatorFramework.create()</span><br><span class="line">.creatingParentsIfNeeded()</span><br><span class="line">.withMode(CreateMode.PERSISTENT_SEQUENTIAL)</span><br><span class="line">.forPath(prefix, endpoint.getBytes());</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SnowflakeGeneratorException</span>(<span class="string">&quot;Create zookeeper node &#x27;&quot;</span> + prefix + <span class="string">&quot;&#x27; failed&quot;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新本地 workerId，确保机器重启时能够正常启动</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> workerId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateLocalWorkerId</span><span class="params">(<span class="type">int</span> workerId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">pathname</span> <span class="operator">=</span> MessageFormatUtils.format(CONF_PATH_PATTERN, config.getName(), workerId);</span><br><span class="line"><span class="type">File</span> <span class="variable">leafConfFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(pathname);</span><br><span class="line"><span class="keyword">if</span> (leafConfFile.exists()) &#123;</span><br><span class="line">log.info(<span class="string">&quot;Update local config file &#x27;&#123;&#125;&#x27; with worker id is &#123;&#125;&quot;</span>, pathname, workerId);</span><br><span class="line">FileUtils.writeStringToFile(leafConfFile, <span class="string">&quot;workerId=&quot;</span> + workerId, Charset.defaultCharset(), <span class="literal">false</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (!leafConfFile.getParentFile().exists()) &#123;</span><br><span class="line">leafConfFile.getParentFile().mkdirs();</span><br><span class="line">&#125;</span><br><span class="line">log.info(<span class="string">&quot;Initialize local config file &#x27;&#123;&#125;&#x27; with worker id is &#123;&#125;&quot;</span>, pathname, workerId);</span><br><span class="line"><span class="keyword">if</span> (leafConfFile.createNewFile()) &#123;</span><br><span class="line">FileUtils.writeStringToFile(leafConfFile, <span class="string">&quot;workerId=&quot;</span> + workerId, Charset.defaultCharset(), <span class="literal">false</span>);</span><br><span class="line">log.info(<span class="string">&quot;Write local file cache worker id is  &#123;&#125;&quot;</span>, workerId);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查节点上报时间</span></span><br><span class="line"><span class="comment"> * &lt;br/&gt; 该节点的时间不能小于最后一次上报的时间</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> zkNode Zookeeper 节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkEndpointTimeStamp</span><span class="params">(String zkNode)</span> &#123;</span><br><span class="line"><span class="type">byte</span>[] bytes;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">bytes = curatorFramework.getData().forPath(zkNode);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SnowflakeGeneratorException</span>(<span class="string">&quot;Get zookeeper node &#x27;&quot;</span> + zkNode + <span class="string">&quot;&#x27; data error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">Endpoint</span> <span class="variable">endPoint</span> <span class="operator">=</span> Endpoint.parse(<span class="keyword">new</span> <span class="title class_">String</span>(bytes));</span><br><span class="line"><span class="keyword">if</span> (endPoint.getTimestamp() &gt; System.currentTimeMillis()) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SnowflakeGeneratorException</span>(<span class="string">&quot;Check endpoint timestamp invalid&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定时上报节点时间</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> zkNode Zookeeper 节点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduledEndpoint</span><span class="params">(String zkNode)</span> &#123;</span><br><span class="line">Executors.newSingleThreadScheduledExecutor(r -&gt; &#123;</span><br><span class="line"><span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r, LEAF_SCHEDULE_NAME);</span><br><span class="line">thread.setDaemon(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">return</span> thread;</span><br><span class="line">&#125;).scheduleWithFixedDelay(() -&gt; &#123;</span><br><span class="line"><span class="keyword">if</span> (System.currentTimeMillis() &lt; lastUpdateTime) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">curatorFramework.setData().forPath(zkNode, Endpoint.build(app.getIp(), app.getPort()).getBytes());</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SnowflakeGeneratorException</span>(<span class="string">&quot;Scheduled endpoint timestamp error&quot;</span>, e);</span><br><span class="line">&#125;</span><br><span class="line">lastUpdateTime = System.currentTimeMillis();</span><br><span class="line">&#125;, <span class="number">1L</span>, <span class="number">3L</span>, TimeUnit.SECONDS); <span class="comment">// 每 3 秒上报一次数据</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>两种方案封装完成，接下来放到 Spring Boot 自动装配管理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(DistributedUIDProperties.class)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedUIDAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DistributedUIDProperties properties;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;distributed-uid.snowflake-generator&quot;, name = &quot;enabled&quot;, havingValue = true)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SnowflakeGenerator <span class="title function_">snowflakeGenerator</span><span class="params">(<span class="meta">@Value(SpringProperties.NAME_PATTERN)</span> String applicationName,</span></span><br><span class="line"><span class="params"> ServerProperties serverProperties)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired SnowflakeGenerator&quot;</span>);</span><br><span class="line"><span class="type">SnowflakeGeneratorConfig</span> <span class="variable">config</span> <span class="operator">=</span> properties.getSnowflakeGenerator();</span><br><span class="line">config.setName(applicationName);</span><br><span class="line"><span class="keyword">return</span> SnowflakeGeneratorHelper.snowflakeGenerator(config,</span><br><span class="line">App.builder().ip(IpConfigUtils.getIpAddress()).port(serverProperties.getPort()).build());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;distributed-uid.segment-generator&quot;, name = &quot;enabled&quot;, havingValue = true)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SegmentGenerator <span class="title function_">segmentGenerator</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">log.debug(<span class="string">&quot;Autowired SegmentGenerator&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> SegmentGeneratorHelper.segmentGenerator(properties.getSegmentGenerator(), dataSource);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;distributed-uid&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DistributedUIDProperties</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">SnowflakeGeneratorConfig</span> <span class="variable">snowflakeGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SnowflakeGeneratorConfig</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">SegmentGeneratorConfig</span> <span class="variable">segmentGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SegmentGeneratorConfig</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>业务项目引入我们自定义的 Spring Boot Starter 组件后，在配置文件设置以下内容。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">distributed-uid:</span></span><br><span class="line">  <span class="attr">snowflake-generator:</span> </span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># 开启雪花算法生成器</span></span><br><span class="line">    <span class="attr">coordinator:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">zookeeper</span></span><br><span class="line">      <span class="attr">zookeeper:</span></span><br><span class="line">        <span class="attr">connect-string:</span> <span class="string">localhost:2181</span></span><br><span class="line">  <span class="attr">segment-generator:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 开启数据库号段生成器</span></span><br><span class="line">    <span class="attr">liquibase:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">sa</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">demo</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:h2:mem:db;DB_CLOSE_ON_EXIT=TRUE</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">org.h2.Driver</span></span><br></pre></td></tr></table></figure><p>启动项目，可以在日志控制台看出 Leaf 表数据自动初始化。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-distributed-uid-leaf-segment-liquibase.png" alt=""></p><p>考虑团队使用 MyBatis-Plus 涉及到 ID 的生成，笔者也扩展了相关实现，通过 <code>com.baomidou.mybatisplus.core.incrementer.IdentifierGenerator</code> 扩展。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureAfter(MybatisPlusAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;MybatisPlusIdGeneratorProperties.class&#125;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusIdGeneratorAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">prefix = MybatisPlusIdGeneratorProperties.PREFIX,</span></span><br><span class="line"><span class="meta">name = MybatisPlusIdGeneratorProperties.TYPE,</span></span><br><span class="line"><span class="meta">havingValue = MybatisPlusIdGeneratorProperties.SNOWFLAKE</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SnowflakeIdentifierGenerator <span class="title function_">snowflakeIdentifierGenerator</span><span class="params">(SnowflakeGenerator snowflakeGenerator)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SnowflakeIdentifierGenerator</span>(snowflakeGenerator);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">prefix = MybatisPlusIdGeneratorProperties.PREFIX,</span></span><br><span class="line"><span class="meta">name = MybatisPlusIdGeneratorProperties.TYPE,</span></span><br><span class="line"><span class="meta">havingValue = MybatisPlusIdGeneratorProperties.SEGMENT</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SegmentIdentifierGenerator <span class="title function_">segmentIdentifierGenerator</span><span class="params">(SegmentGenerator segmentGenerator)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SegmentIdentifierGenerator</span>(segmentGenerator);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = MybatisPlusIdGeneratorProperties.PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisPlusIdGeneratorProperties</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;mybatis-plus.id-generator&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TYPE</span> <span class="operator">=</span> <span class="string">&quot;type&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SNOWFLAKE</span> <span class="operator">=</span> <span class="string">&quot;snowflake&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SEGMENT</span> <span class="operator">=</span> <span class="string">&quot;segment&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SegmentIdentifierGenerator</span> <span class="keyword">implements</span> <span class="title class_">IdentifierGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SegmentGenerator segmentGenerator;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">nextId</span><span class="params">(Object entity)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> segmentGenerator.nextId();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SnowflakeIdentifierGenerator</span> <span class="keyword">implements</span> <span class="title class_">IdentifierGenerator</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SnowflakeGenerator snowflakeGenerator;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Long <span class="title function_">nextId</span><span class="params">(Object entity)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> snowflakeGenerator.nextId();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>业务项目配置如下内容即可使用。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">id-generator:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">segment</span> <span class="comment"># 设置为 snowflake 表示开启雪花算法，设置为 segment 表示基于数据库发号</span></span><br></pre></td></tr></table></figure><p>除了 Leaf，也可以扩展其他组件的集成，具体就不展开了。</p><h1>产出</h1><p>通过 API 封装，简化了业务项目对分布式 ID 生成的繁琐编码工作，提高开发效率。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-solutions/eden-distributed-uid">eden-distributed-uid</a> 和 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-distributed-uid-spring-boot-starter">eden-distributed-lock-spring-boot-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
            <tag> Spring </tag>
            
            <tag> 分布式ID </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring 自定义 @RestControllerAdvice 返回结果</title>
      <link href="/2024/01/05/spring/Spring%20%E8%87%AA%E5%AE%9A%E4%B9%89%20@RestControllerAdvice%20%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C/"/>
      <url>/2024/01/05/spring/Spring%20%E8%87%AA%E5%AE%9A%E4%B9%89%20@RestControllerAdvice%20%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>Spring 提供了 <code>@RestControllerAdvice</code> 用来实现 HTTP 协议的全局异常处理。在异常信息的处理上通常只返回特定的 Response 对象，如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestExceptionResolver</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;?&gt; processException(Exception ex) &#123;</span><br><span class="line">BodyBuilder builder;</span><br><span class="line">Response response;</span><br><span class="line"><span class="type">ResponseStatus</span> <span class="variable">responseStatus</span> <span class="operator">=</span></span><br><span class="line">AnnotationUtils.findAnnotation(ex.getClass(), ResponseStatus.class);</span><br><span class="line"><span class="keyword">if</span> (responseStatus != <span class="literal">null</span>) &#123;</span><br><span class="line">builder = ResponseEntity.status(responseStatus.value());</span><br><span class="line">response = Response.buildFailure(<span class="string">&quot;500&quot;</span>, responseStatus.reason());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">builder = ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">response = Response.buildFailure(<span class="string">&quot;500&quot;</span>, ex.getMessage());</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">this</span>.process(ex, response);</span><br><span class="line"><span class="keyword">return</span> builder.body(response);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>作为基础框架，笔者就遇到项目A 要求返回 Response1 对象，项目B 要求返回 Response2 对象，这个时候，适配起来就很痛苦，例如下方的代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@ToString(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Response</span> <span class="keyword">extends</span> <span class="title class_">DTO</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> success;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String errCode; <span class="comment">// 项目A 要求错误码是字符型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String errMessage; <span class="comment">// 项目A 要求用这个名字</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> code; <span class="comment">// 项目B 要求错误码是整型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String message; <span class="comment">// 项目B 要求用这个名字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外，<code>@RestControllerAdvice</code> 只适用于 Web 异常捕获，我们还要考虑其他组件的情况，例如 Dubbo 捕获 RPC 异常、Sentinel 组件触发限流、Spring Security 安全框架抛出认证异常。</p><h1>目标</h1><p>不需要修改基础框架，允许业务方自行扩展异常返回对象。</p><h1>实现</h1><p>将 <code>Response</code> 提炼为 Builder 模式，改为 <code>ResponseBuilder.builder()</code> 构建返回对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RestExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;?&gt; resolveException(Exception ex) &#123;</span><br><span class="line">BodyBuilder builder;</span><br><span class="line">Object response;</span><br><span class="line"><span class="type">ResponseStatus</span> <span class="variable">status</span> <span class="operator">=</span> AnnotationUtils.findAnnotation(ex.getClass(), ResponseStatus.class);</span><br><span class="line"><span class="keyword">if</span> (status != <span class="literal">null</span>) &#123;</span><br><span class="line">builder = ResponseEntity.status(status.value());</span><br><span class="line">response = ResponseBuilder.builder().buildFailure(<span class="string">&quot;500&quot;</span>, status.reason());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">builder = ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">response = ResponseBuilder.builder().buildFailure(<span class="string">&quot;500&quot;</span>, ex.getMessage());</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">this</span>.postProcess(ex);</span><br><span class="line"><span class="keyword">return</span> builder.body(response);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ResponseBuilder</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> ResponseBuilder&lt;?&gt; builder() &#123;</span><br><span class="line"><span class="comment">// 尝试从业务项目获取自定义的 Spring Bean</span></span><br><span class="line">ResponseBuilder&lt;?&gt; builder = ApplicationContextHelper.getBean(ResponseBuilder.class);</span><br><span class="line"><span class="keyword">if</span> (builder != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> builder;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果业务项目没有自定义 Bean，返回默认的 Builder</span></span><br><span class="line"><span class="keyword">return</span> DefalutResponseBuilder.getInstance();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">T <span class="title function_">buildSuccess</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&lt;Body&gt; T <span class="title function_">buildSuccess</span><span class="params">(Body data)</span>;</span><br><span class="line"></span><br><span class="line">T <span class="title function_">buildFailure</span><span class="params">(String errCode, String errMessage, Object... params)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefalutResponseBuilder</span> <span class="keyword">implements</span> <span class="title class_">ResponseBuilder</span>&lt;Response&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">DefaultResponseBuilder</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultResponseBuilder</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">DefaultResponseBuilder</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DefaultResponseBuilder <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Response <span class="title function_">buildSuccess</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Response</span>();</span><br><span class="line">response.setSuccess(<span class="literal">true</span>);</span><br><span class="line"><span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;Body&gt; Response <span class="title function_">buildSuccess</span><span class="params">(Body data)</span> &#123;</span><br><span class="line">SingleResponse&lt;Body&gt; response = <span class="keyword">new</span> <span class="title class_">SingleResponse</span>&lt;&gt;();</span><br><span class="line">response.setSuccess(<span class="literal">true</span>);</span><br><span class="line">response.setData(data);</span><br><span class="line"><span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Response <span class="title function_">buildFailure</span><span class="params">(String errCode, String errMessage, Object... params)</span> &#123;</span><br><span class="line"><span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Response</span>();</span><br><span class="line">response.setSuccess(<span class="literal">false</span>);</span><br><span class="line">response.setErrCode(errCode);</span><br><span class="line">response.setErrMessage(MessageFormatter.arrayFormat(message, placeholders).getMessage());</span><br><span class="line"><span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@ToString(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Response</span> <span class="keyword">extends</span> <span class="title class_">DTO</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> success;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String errCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String errMessage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>业务方觉得 <code>Response</code> 不能满足需求，重新定义了新对象，如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@ToString(callSuper = true)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomResponse</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> success;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> code; <span class="comment">// 要求错误码是整型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String message; <span class="comment">// 前端要求用这个名字</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>创建 <code>CustomResponseBuilder</code> 包装 <code>CustomResponse</code> 对象，并标记 <code>@Component</code> 注解，放入 Spring Bean 管理。</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public <span class="keyword">class</span> CustomResponseBuilder implements ResponseBuilder&lt;CustomResponse&gt; &#123;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public CustomResponse build<span class="constructor">Success()</span> &#123;</span><br><span class="line">CustomResponse response = <span class="keyword">new</span> <span class="constructor">CustomResponse()</span>;</span><br><span class="line">response.set<span class="constructor">Success(<span class="params">true</span>)</span>;</span><br><span class="line">return response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public &lt;Body&gt; CustomResponse build<span class="constructor">Success(Body <span class="params">data</span>)</span> &#123;</span><br><span class="line"><span class="comment">// 略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public CustomResponse build<span class="constructor">Failure(<span class="params">int</span> <span class="params">code</span>, String <span class="params">message</span>, Object<span class="operator">...</span> <span class="params">params</span>)</span> &#123;</span><br><span class="line">CustomResponse response = <span class="keyword">new</span> <span class="constructor">CustomResponse()</span>;</span><br><span class="line">response.set<span class="constructor">Success(<span class="params">false</span>)</span>;</span><br><span class="line">response.set<span class="constructor">Code(<span class="params">code</span>)</span>;</span><br><span class="line">response.set<span class="constructor">Message(MessageFormatter.<span class="params">arrayFormat</span>(<span class="params">message</span>, <span class="params">placeholders</span>)</span>.get<span class="constructor">Message()</span>);</span><br><span class="line">return response;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上述已提到 <code>ResponseBuilder.builder()</code> 优先查找 Spring Bean，所以 <code>CustomResponseBuilder</code> 覆盖了框架内置的 <code>DefaultResponseBuilder</code> 类，全局异常捕获器返回结果时，就能返回业务方自定义的 <code>CustomResponse</code> 对象，这样，不需要改动框架，就能满足业务需求。</p><h1>产出</h1><p>根据这个思路，我们分别实现了 Web 异常、Dubbo 异常、Sentinel 限流、Security 认证等各种场景的异常处理机制，业务方只需要自行创建 <code>ResponseBuilder</code> 扩展自己的返回对象即可，不需要修改框架。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-framework/src/main/java/org/ylzl/eden/spring/framework/dto/extension">eden-spring-framework</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring 扩展 @AutoConfiguration 开关</title>
      <link href="/2024/01/02/spring/Spring%20%E6%89%A9%E5%B1%95%20@AutoConfiguration%20%E5%BC%80%E5%85%B3/"/>
      <url>/2024/01/02/spring/Spring%20%E6%89%A9%E5%B1%95%20@AutoConfiguration%20%E5%BC%80%E5%85%B3/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>Spring Boot Starters 提供了很多常用的组件，有些组件例如 <code>Kafka</code> 和 <code>RocketMQ</code>，引入到工程后会自动装配，它会检查您的配置，跟外部的组件创建一些连接，这个时候，我们很难控制 <code>Kafka</code> 关闭，<code>RocketMQ</code> 开启。</p><h1>目标</h1><p>给 Spring Boot Starters 的组件提供一个开关，控制自动装配。</p><h1>实现</h1><p>Spring Boot AutoCofiguration 提供了 <code>AutoConfigurationImportFilter</code> 过滤器，用来控制 <code>@Configuration</code> 配置类是否生效。查看 <code>AutoConfigurationImportSelector</code> 的源码，它会去调用 <code>AutoConfigurationImportFilter</code> 过滤器，传入所有的 <code>@Configuration</code> 配置类，通过 filter 方法筛选掉不需要的配置类，返回最新的配置类集合。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span>, BeanClassLoaderAware, ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConfigurationClassFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AutoConfigurationMetadata autoConfigurationMetadata;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;AutoConfigurationImportFilter&gt; filters;</span><br><span class="line"></span><br><span class="line">        ConfigurationClassFilter(ClassLoader classLoader, List&lt;AutoConfigurationImportFilter&gt; filters) &#123;</span><br><span class="line">            <span class="built_in">this</span>.autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(classLoader);</span><br><span class="line">            <span class="built_in">this</span>.filters = filters;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> AutoConfigurationEntry <span class="title function_">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">                <span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            configurations = getConfigurationClassFilter().filter(configurations); <span class="comment">// 过滤配置类</span></span><br><span class="line">            fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutoConfigurationEntry</span>(configurations, exclusions);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; <span class="title function_">filter</span><span class="params">(List&lt;String&gt; configurations)</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            String[] candidates = StringUtils.toStringArray(configurations);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">skipped</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (AutoConfigurationImportFilter filter : <span class="built_in">this</span>.filters) &#123;</span><br><span class="line">                <span class="type">boolean</span>[] match = filter.match(candidates, <span class="built_in">this</span>.autoConfigurationMetadata);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; match.length; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!match[i]) &#123;</span><br><span class="line">                        candidates[i] = <span class="literal">null</span>;</span><br><span class="line">                        skipped = <span class="literal">true</span>; <span class="comment">// 为 true 表示自动装配失效</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!skipped) &#123;</span><br><span class="line">                <span class="keyword">return</span> configurations; <span class="comment">// 返回对象表示自动装配生效</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以 Kafka 为例，我们可以在 <code>src/main/resources/META-INF</code> 添加 <code>spring.factories</code> 文件，内容如下：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Auto Configuration Import Filters</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.AutoConfigurationImportFilter</span>=<span class="string">\</span></span><br><span class="line"><span class="string">  org.ylzl.spring.boot.kafka.autoconfigure.KafkaAutoConfigurationImportFilter</span></span><br></pre></td></tr></table></figure><p>对应的代码实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaAutoConfigurationImportFilter</span> <span class="keyword">implements</span> <span class="title class_">AutoConfigurationImportFilter</span>, EnvironmentAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MATCH_KEY</span> <span class="operator">=</span> <span class="string">&quot;spring.kafka.enabled&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] IGNORE_CLASSES = &#123;</span><br><span class="line">      <span class="string">&quot;org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration&quot;</span>,</span><br><span class="line">      <span class="string">&quot;org.springframework.boot.actuate.autoconfigure.metrics.KafkaMetricsAutoConfiguration&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnvironment</span><span class="params">(<span class="meta">@NotNull</span> Environment environment)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span>[] match(String[] autoConfigurationClasses, AutoConfigurationMetadata autoConfigurationMetadata) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">disabled</span> <span class="operator">=</span> !Boolean.parseBoolean(environment.getProperty(MATCH_KEY, Conditions.TRUE));</span><br><span class="line">        <span class="type">boolean</span>[] match = <span class="keyword">new</span> <span class="title class_">boolean</span>[autoConfigurationClasses.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; autoConfigurationClasses.length; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">            match[i] = !disabled || Arrays.stream(IGNORE_CLASSES).noneMatch(e -&gt; e.equals(autoConfigurationClasses[index]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> match; <span class="comment">// 如果 match 为 false，对应的配置类不生效</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码扩展完成，当设置 <code>spring.kafka.enabled=true</code> 时开启 Kafka，设置 <code>spring.kafka.enabled=false</code> 时关闭 Kafka。</p><h1>产出</h1><p>适用接入消息引擎、第三方支付平台、第三方短信服务等各种场景，研发团队引入了这个方案后，极大减少了维护成本，在切换厂商接口也能省下很多时间。并且，在引入第三方项目依赖也会遇到自动装配的问题，一般情况下，第三方依赖会引入多项配置，这些配置我们用不到，又修改不了相关源码，需要从扩展点屏蔽。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-kafka-spring-boot-starter">eden-kafka-spring-boot-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 binlog2sql 工具在线恢复数据</title>
      <link href="/2023/10/25/mysql/%E4%BD%BF%E7%94%A8%20binlog2sql%20%E5%B7%A5%E5%85%B7%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE/"/>
      <url>/2023/10/25/mysql/%E4%BD%BF%E7%94%A8%20binlog2sql%20%E5%B7%A5%E5%85%B7%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>生产数据库执行 SQL 脚本，一般会经过正规的审批流程才能运行。但有些情况是例外的，业务部门在提出一些删除数据的需求后打算撤回，或者在运营后台不小心删除了一些数据，然后找到 DBA 团队协助，希望能恢复数据。</p><p>经调研，binlog2sql 是大众点评开源的一款用于解析 MySQL binlog 的工具，根据不同选项，可以得到原始SQL、回滚SQL、去除主键的INSERT SQL 等，适用于数据快速回滚（闪回）和主从切换后新 Master 丢数据的修复工作。</p><h1>目标</h1><p>验证 binlog2sql 工具是否可以快速恢复数据。</p><h1>步骤</h1><h2 id="准备工作">准备工作</h2><p>安装 binlog2sql 工具。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; git <span class="built_in">clone</span> https://github.com/danfengcao/binlog2sql.git &amp;&amp; <span class="built_in">cd</span> binlog2sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt; yum install python3-pip</span></span><br><span class="line"><span class="comment"># &gt; whereis pip</span></span><br><span class="line"><span class="comment"># &gt; pip3.6 install -r requirements.txt</span></span><br><span class="line">&gt; pip install -r requirements.txt</span><br></pre></td></tr></table></figure><p>MySQL 服务端配置以下参数，请注意，binlog2sql 仅支持 row 格式。</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="string">1</span></span><br><span class="line"><span class="attr">log_bin</span> = <span class="string">/var/log/mysql/mysql-bin.log</span></span><br><span class="line"><span class="attr">max_binlog_size</span> = <span class="string">1G</span></span><br><span class="line"><span class="attr">binlog_format</span> = <span class="string">row</span></span><br><span class="line"><span class="attr">binlog_row_image</span> = <span class="string">full</span></span><br></pre></td></tr></table></figure><p>指定执行脚本的数据库用户授权。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SELECT 权限：查询 information_schema.COLUMNS</span></span><br><span class="line"><span class="comment">-- REPLICATION SLAVE：通过 BINLOG_DUMP 协议获取 binlog 内容</span></span><br><span class="line"><span class="comment">-- REPLICATION CLIENT：执行 SHOW MASTER STATUS 获取 binlog 信息</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, REPLICATION SLAVE, REPLICATION CLIENT <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="keyword">user</span></span><br></pre></td></tr></table></figure><p>准备一张用户表 user，并填充 1W 条数据。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `gmt_create` <span class="type">date</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4</span><br><span class="line"></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> InsertRandomData()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> randomName <span class="type">CHAR</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> randomDate <span class="type">DATE</span>;</span><br><span class="line"></span><br><span class="line">    WHILE i <span class="operator">&lt;=</span> <span class="number">10000</span> DO</span><br><span class="line">        <span class="comment">-- 生成随机 name (随机字符串)</span></span><br><span class="line">        <span class="keyword">SET</span> randomName <span class="operator">=</span> CONCAT(</span><br><span class="line">            <span class="type">CHAR</span>(<span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">26</span>) <span class="operator">+</span> <span class="number">65</span>), </span><br><span class="line">            <span class="type">CHAR</span>(<span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">26</span>) <span class="operator">+</span> <span class="number">65</span>), </span><br><span class="line">            <span class="type">CHAR</span>(<span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">26</span>) <span class="operator">+</span> <span class="number">65</span>), </span><br><span class="line">            <span class="type">CHAR</span>(<span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">26</span>) <span class="operator">+</span> <span class="number">65</span>), </span><br><span class="line">            <span class="type">CHAR</span>(<span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">26</span>) <span class="operator">+</span> <span class="number">65</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 生成随机日期 (2013-11-11 起始，随机范围约为一年内)</span></span><br><span class="line">        <span class="keyword">SET</span> randomDate <span class="operator">=</span> DATE_ADD(<span class="string">&#x27;2023-01-01&#x27;</span>, <span class="type">INTERVAL</span> <span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">365</span>) <span class="keyword">DAY</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 插入数据</span></span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` (`name`, `gmt_create`) <span class="keyword">VALUES</span> (randomName, randomDate);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">CALL</span> InsertRandomData();</span><br></pre></td></tr></table></figure><p>查看大于 11 月份的数据总数，共 363 条。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> gmt_create <span class="operator">&gt;</span> <span class="string">&#x27;2023-11-01 00:00:00&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">363</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br></pre></td></tr></table></figure><p>模拟误删除，假设在 15:30 左右删除了 11 月份之后的数据。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> gmt_create <span class="operator">&gt;</span> <span class="string">&#x27;2023-11-01 00:00:00&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="恢复数据">恢复数据</h2><p>查看主库 binlog 状态，最新的文件为 mysql-bin.000003。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 低版本使用 SHOW MASTER STATUS;</span></span><br><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">SHOW</span> <span class="type">BINARY</span> LOGS;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span> Encrypted <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">1871</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>       <span class="number">181</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>    <span class="number">917878</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+-----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br></pre></td></tr></table></figure><p>筛选出需要回滚的SQL，误操作人一般知道大致的误操作时间，我们首先根据时间做一次过滤。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; python binlog2sql/binlog2sql.py -h地址 -P端口 -u用户 -p<span class="string">&#x27;密码&#x27;</span> -d库民 -t表名 --start-file=<span class="string">&#x27;mysql-bin.000003&#x27;</span> --start-datetime=<span class="string">&#x27;2023-11-02 15:00:00&#x27;</span> --stop-datetime=<span class="string">&#x27;2023-11-02 16:00:00&#x27;</span> &gt; /tmp/raw.sql</span><br><span class="line"></span><br><span class="line">raw.sql输出：</span><br><span class="line">DELETE FROM `<span class="built_in">test</span>`.`user` WHERE `gmt_create`=<span class="string">&#x27;2023-11-01 00:00:00&#x27;</span> AND `<span class="built_in">id</span>`=1351 AND `name`=<span class="string">&#x27;TPUDJ&#x27;</span> LIMIT 1; <span class="comment">#start 105311 end 262311 time 2023-11-02 15:31:10</span></span><br><span class="line">DELETE FROM `<span class="built_in">test</span>`.`user` WHERE `gmt_create`=<span class="string">&#x27;2023-11-01 00:00:00&#x27;</span> AND `<span class="built_in">id</span>`=1352 AND `name`=<span class="string">&#x27;YKIIS&#x27;</span> LIMIT 1; <span class="comment">#start 105311 end 262311 time 2023-11-02 15:31:10</span></span><br><span class="line">...</span><br><span class="line">DELETE FROM `<span class="built_in">test</span>`.`user` WHERE `gmt_create`=<span class="string">&#x27;2023-12-31 00:00:00&#x27;</span> AND `<span class="built_in">id</span>`=1714 AND `name`=<span class="string">&#x27;SHKBC&#x27;</span> LIMIT 1; <span class="comment">#start 105311 end 265754 time 2023-11-02 15:31:10</span></span><br></pre></td></tr></table></figure><p>根据 raw.sql 的位置信息，可以判断误操作的 SQL 来自同一个事务，准确位置在 105311-265754 之间，根据位置过滤，使用 -B 选项生成回滚 SQL。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; python binlog2sql/binlog2sql.py -h地址 -P端口 -u用户 -p<span class="string">&#x27;密码&#x27;</span> -d库民 -t表名 --start-file=<span class="string">&#x27;mysql-bin.000003&#x27;</span> --start-position=105311 --stop-position=265754 -B &gt; /tmp/rollback.sql</span><br><span class="line"></span><br><span class="line">rollback.sql输出：</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>`.`user`(`gmt_create`, `<span class="built_in">id</span>`, `name`) VALUES (<span class="string">&#x27;2023-11-01 00:00:00&#x27;</span>, 1351, <span class="string">&#x27;TPUDJ&#x27;</span>); <span class="comment">#start 105311 end 262311 time 2023-11-02 15:31:10</span></span><br><span class="line">INSERT INTO `<span class="built_in">test</span>`.`user`(`gmt_create`, `<span class="built_in">id</span>`, `name`) VALUES (<span class="string">&#x27;2023-11-01 00:00:00&#x27;</span>, 1352, <span class="string">&#x27;YKIIS&#x27;</span>); <span class="comment">#start 105311 end 262311 time 2023-11-02 15:31:10</span></span><br><span class="line">...</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>`.`user`(`gmt_create`, `<span class="built_in">id</span>`, `name`) VALUES (<span class="string">&#x27;2023-12-31 00:00:00&#x27;</span>, 1714, <span class="string">&#x27;SHKBC&#x27;</span>); <span class="comment">#start 105311 end 265754 time 2023-11-02 15:31:10</span></span><br></pre></td></tr></table></figure><h2 id="结果验证">结果验证</h2><p>确认回滚 SQL 总行数是否对应误删除的 363 条。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; <span class="built_in">wc</span> -l /tmp/rollback.sql</span><br><span class="line"></span><br><span class="line">363 /tmp/rollback.sql</span><br></pre></td></tr></table></figure><p>与业务方确认回滚 SQL 没问题，执行回滚语句。登录 MySQL，确认回滚成功。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">shell<span class="operator">&gt;</span> mysql <span class="operator">-</span>h地址 <span class="operator">-</span>P端口 <span class="operator">-</span>u用户 <span class="operator">-</span>p<span class="string">&#x27;密码&#x27;</span> <span class="operator">&lt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>rollback.sql</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> gmt_create <span class="operator">&gt;</span> <span class="string">&#x27;2023-11-01 00:00:00&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">363</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br></pre></td></tr></table></figure><h1>结论</h1><p>binlog2sql 适用于在线恢复误操作的数据，但不适用于以下情况：</p><ol><li><strong>数据恢复建议控制在 50W 以内</strong>，数据量越大，逆向生成的语句越多，超过这个数值，恢复时间可能会超过 15 分钟。</li><li><strong>不支持 DDL 恢复操作</strong>。因为即使在 row 模式下，binlog对于 DDL 操作不会记录每行数据的变化。要实现 DDL 快速回滚，必须修改 MySQL 源码，使得在执行 DDL 前先备份老数据。阿里林晓斌团队提交了 patch 给 MySQL 官方，相关实现方案可以查阅 <a href="https://www.iteye.com/blog/dinglin-1539167">MySQL闪回方案讨论及实现</a>。</li><li>根据官方说法，在线召回数据推荐使用 binlog2sql 工具，离线解析使用 mysqlbinlog 工具，MySQL 闪回特性最早由阿里彭立勋开发，具体可以查阅 <a href="http://www.penglixun.com/database/mysql_flashback_feature.html">MySQL Flashback Feature</a>。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 数据恢复 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>搜索自动补全系统设计</title>
      <link href="/2023/10/25/design/%E6%90%9C%E7%B4%A2%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
      <url>/2023/10/25/design/%E6%90%9C%E7%B4%A2%E8%87%AA%E5%8A%A8%E8%A1%A5%E5%85%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h1>场景</h1><p>设计一个搜索自动补全系统，支持 Top k 查询词或者 k 个最常被搜索的查询词。</p><p>需求点：</p><ol><li>仅支持前缀匹配。</li><li>输入查询词，在 100 毫秒内返回结果。</li><li>系统返回 5 条自动补全建议，基于历史的查询频率决定。</li><li>支持 1000 万活跃用户（DAU）。</li></ol><h1>估算</h1><p>假设每个用户每天搜索 20 次，每次搜索 4 个字。<br>按 UTF8 字符编码，每个字占用 3 个字节，每次查询占用 4 * 3 = 12 字节。</p><p>每当在搜索框中输入一个字符，客户端就会向后端发送一个请求以获取自动补全建议。假设，输入完 “原神启动”，客户端会发送 4 个请求到服务端。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_search?q=原</span><br><span class="line">_search?q=原神</span><br><span class="line">_search?q=原神启</span><br><span class="line">_search?q=原神启动</span><br></pre></td></tr></table></figure><p>根据每天有 1000 万活跃用户，系统需要承载的 QPS 为 10,000,000 * 20 次 * 4 个请求 / 24 小时 / 60 分 / 60 秒 = 9200 次/秒，则峰值 QPS 按两倍计算，约 18,400 次/秒。</p><h1>设计</h1><h1>总结</h1>]]></content>
      
      
      <categories>
          
          <category> 场景设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 系统设计 </tag>
            
            <tag> Trie </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring 扩展 AOP 自定义切面路径</title>
      <link href="/2023/10/23/spring/Spring%20%E6%89%A9%E5%B1%95%20AOP%20%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%87%E9%9D%A2%E8%B7%AF%E5%BE%84/"/>
      <url>/2023/10/23/spring/Spring%20%E6%89%A9%E5%B1%95%20AOP%20%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%87%E9%9D%A2%E8%B7%AF%E5%BE%84/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>看到有些框架在实现日志切面时，直接编写一个切面类，在 <code>@Aspect</code> 注解指定好 package 路径，然后通过 <code>@EnableAspectJAutoProxy</code> 开启 AOP。业务代码引入这个框架，必须按照框架约定好的 package 路径匹配，才能生效。这样的框架对业务代码有较大的侵入性，不适合所有场景。</p><h1>目标</h1><p>实现一个可配置的日志切面路径组件，对业务代码零侵入性。</p><h1>实现</h1><p>实现切面路径自定义的方式有两种：<code>Annotation</code> 注解和 <code>AutoConfiguration</code> 自动装配，前者对代码有较小的侵入性。先说说 <code>Annotation</code> 注解怎么实现。</p><p>以日志切面为例，先设计配置属性类 <code>AccessLogConfig</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 是否保存到 MDC */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabledMdc</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 需要输出日志的包名 */</span></span><br><span class="line">    <span class="keyword">private</span> String expression;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 日志输出采样率 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="variable">sampleRate</span> <span class="operator">=</span> <span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 是否输出入参 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">logArguments</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 是否输出返回值 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">logReturnValue</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 是否输出方法执行耗时 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">logExecutionTime</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 最大长度 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxLength</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 慢日志 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">slowThreshold</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义一个注解 <code>@EnableAccessLog</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import(AccessLogImportSelector.class)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAccessLog &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 是否开启 CGLIB 代理 */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">proxyTargetClass</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** PointcutAdvisor 代理模式 */</span></span><br><span class="line">    AdviceMode <span class="title function_">mode</span><span class="params">()</span> <span class="keyword">default</span> AdviceMode.PROXY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** PointcutAdvisor 优先级 */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">order</span><span class="params">()</span> <span class="keyword">default</span> Ordered.LOWEST_PRECEDENCE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** AspectJ 切面表达式 */</span></span><br><span class="line">    String <span class="title function_">expression</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写 <code>AccessLogConfiguration</code> 配置类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogConfiguration</span> <span class="keyword">implements</span> <span class="title class_">ImportAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AnnotationAttributes annotation;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setImportMetadata</span><span class="params">(AnnotationMetadata importMetadata)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.annotation = AnnotationAttributes.fromMap(</span><br><span class="line">            importMetadata.getAnnotationAttributes(EnableAccessLog.class.getName(), <span class="literal">false</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.annotation == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;@EnableAccessLog is not present on importing class&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关键代码实现</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AccessLogAdvisor <span class="title function_">accessLogAdvisor</span><span class="params">(ObjectProvider&lt;AccessLogConfig&gt; configs, AccessLogInterceptor interceptor)</span> &#123;</span><br><span class="line">        <span class="type">AccessLogAdvisor</span> <span class="variable">advisor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccessLogAdvisor</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">expression</span> <span class="operator">=</span> getAccessLogConfig(configs).getExpression();</span><br><span class="line">        advisor.setExpression(expression); <span class="comment">// 指定您要匹配的包名</span></span><br><span class="line">        advisor.setAdvice(interceptor); <span class="comment">// 指定您的拦截器</span></span><br><span class="line">        <span class="keyword">if</span> (annotation != <span class="literal">null</span>) &#123;</span><br><span class="line">            advisor.setOrder(annotation.getNumber(<span class="string">&quot;order&quot;</span>)); <span class="comment">// 指定拦截次序</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AccessLogInterceptor <span class="title function_">accessLogInterceptor</span><span class="params">(ObjectProvider&lt;AccessLogConfig&gt; configs)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AccessLogInterceptor</span>(getAccessLogConfig(configs));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AccessLogConfig <span class="title function_">getAccessLogConfig</span><span class="params">(ObjectProvider&lt;AccessLogConfig&gt; accessLogConfigs)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accessLogConfigs.getIfUnique(() -&gt; &#123;</span><br><span class="line">            <span class="type">AccessLogConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccessLogConfig</span>();</span><br><span class="line">            config.setExpression(annotation.getString(<span class="string">&quot;expression&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> config;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的 <code>AccessLogInterceptor</code> 拦截器代码片段如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogInterceptor</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccessLogConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(<span class="meta">@NotNull</span> MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 排除代理类</span></span><br><span class="line">        <span class="keyword">if</span> (AopUtils.isAopProxy(invocation.getThis())) &#123;</span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否需要输出日志</span></span><br><span class="line">        <span class="keyword">if</span> (!AccessLogHelper.shouldLog(config.getSampleRate())) &#123;</span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Instant</span> <span class="variable">start</span> <span class="operator">=</span> Instant.now();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">throwable</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = invocation.proceed();</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            throwable = t;</span><br><span class="line">            <span class="keyword">throw</span> t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> Duration.between(start, Instant.now()).toMillis();</span><br><span class="line">            AccessLogHelper.log(invocation, result, throwable, duration,</span><br><span class="line">                config.isEnabledMdc(), config.getMaxLength(), config.getSlowThreshold());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 <code>@Import(AccessLogImportSelector.class)</code> 导入配置类 <code>AccessLogConfiguration</code>，代码如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogImportSelector</span> <span class="keyword">extends</span> <span class="title class_">AdviceModeImportSelector</span>&lt;EnableAccessLog&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] selectImports(AdviceMode adviceMode) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (adviceMode) &#123;</span><br><span class="line">            <span class="keyword">case</span> PROXY:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">                    AutoProxyRegistrar.class.getName(),</span><br><span class="line">                    AccessLogConfiguration.class.getName()</span><br><span class="line">                &#125;;</span><br><span class="line">            <span class="keyword">case</span> ASPECTJ:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">                    AccessLogConfiguration.class.getName()</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当业务代码使用 <code>@EnableAccessLog(expression=&quot;您的包名&quot;)</code>，底层通过 <code>@Import(AccessLogImportSelector.class)</code> 调用 <code>AccessLogConfiguration</code> 配置类，完成自动配置。</p><p>但使用 <code>@EnableAccessLog</code> 注解对代码还是有一定的侵入性，最好的办法就是彻底改为 <code>AutoConfiguration</code>，优化如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;logging.access&quot;, name = &quot;enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(AccessLogProperties.class)</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@EnableAccessLog</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;logging.access&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogProperties</span> <span class="keyword">extends</span> <span class="title class_">AccessLogConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 是否开启日志切面 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当业务代码配置如下内容，就会自动开启日志切面，不需要在代码里面编写 <code>@EnableAccessLog</code> 注解。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">access:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">expression:</span> <span class="string">within(org.ylzl.eden.demo.adapter.*.web..*)</span></span><br></pre></td></tr></table></figure><p>根据上述配置的切面路径，测试下 HTTP 请求，可以从控制台日志看到切面打印了接口请求的入参、返回值、耗时。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-aop-logging.png" alt=""></p><h1>产出</h1><p>为研发团队提供统一的日志打印模板，便于后期统一维护日志内容的格式解析工作，在引入这个日志切面组件后，研发团队只需要微调自己的项目 package 就完成了集成工作，对业务代码没有任何侵入性。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-framework/src/main/java/org/ylzl/eden/spring/framework/logging">eden-spring-framework</a> 自定义注解实现和 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot/src/main/java/org/ylzl/eden/spring/boot/logging">eden-spring-boot</a> 自动装配实现。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Log4j2 零停机动态加载配置文件</title>
      <link href="/2023/10/12/log4j2/Log4j2%20%E9%9B%B6%E5%81%9C%E6%9C%BA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
      <url>/2023/10/12/log4j2/Log4j2%20%E9%9B%B6%E5%81%9C%E6%9C%BA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>有时候生产环境需要临时调整日志级别 Level 或者修改日志输出路径 Appender，使用 Spring Boot 提供的日志刷新不能满足这个需求，最终还是重启服务才能生效。为了解决这个问题，需要实现 log4j2 配置文件的动态加载。</p><h1>目标</h1><p>实现零停机修改 log4j 配置，动态配置日志级别和输出路径。</p><h1>实现</h1><p>Nacos 配置监听通过 <code>NacosConfigManager.getConfigService().addListener()</code> 实现，为了避免 Nacos 服务端宕机，Nacos Client 实现了本地缓存机制，配置文件保存路径如下： <code>$&#123;user.home&#125;/nacos/config/fixed-host_port-namespace_tenant/snapshot-tenant/namespace/group</code>，将配置文件转化为 URI，利用 log4j2 的 API 重新加载日志配置 <code>Configurator.reconfigure(uri)</code>。</p><p>首先，定义配置属性类 <code>Log4j2NacosProperties</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = Log4j2NacosProperties.PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4j2NacosProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;log4j2.nacos&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String group;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> <span class="string">&quot;log4j2.yml&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写自动装配组件 <code>Log4j2NacosAutoConfiguration</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">    prefix = Log4j2NacosProperties.PREFIX,</span></span><br><span class="line"><span class="meta">    name = &quot;enabled&quot;</span></span><br><span class="line"><span class="meta">    havingValue = &quot;true&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(NacosConfigBootstrapConfiguration.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(Log4j2NacosProperties.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(LogManager.class)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4j2NacosAutoConfiguration</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RPC_CLIENT</span> <span class="operator">=</span> <span class="string">&quot;config_rpc_client&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIXED</span> <span class="operator">=</span> <span class="string">&quot;fixed&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NacosConfigProperties nacosConfigProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Log4j2NacosProperties log4j2ConfigProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NacosConfigManager nacosConfigManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">configFile</span> <span class="operator">=</span> <span class="built_in">this</span>.getFile(RPC_CLIENT);</span><br><span class="line">        <span class="keyword">if</span> (!configFile.exists()) &#123;</span><br><span class="line">            configFile = <span class="built_in">this</span>.getFile(getServerName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!configFile.exists()) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Loading log4j2 config file from nacos config cache failed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> configFile.toURI();</span><br><span class="line">        log.info(<span class="string">&quot;Loading log4j2 config file from nacos config cache: &#123;&#125;&quot;</span>, uri);</span><br><span class="line">        Configurator.reconfigure(uri);</span><br><span class="line">        log.info(<span class="string">&quot;Loading log4j2 config file finished.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nacosConfigManager.getConfigService().addListener(</span><br><span class="line">            log4j2ConfigProperties.getDataId(), log4j2ConfigProperties.getGroup(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Listener</span>() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveConfigInfo</span><span class="params">(String configInfo)</span> &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;Reloading log4j2 config file from nacos listener, changed info: \n&#123;&#125;&quot;</span>, configInfo);</span><br><span class="line">                    Configurator.reconfigure(uri);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Executor <span class="title function_">getExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File <span class="title function_">getFile</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> getFailoverFile(name);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file = getSnapshotFile(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> file;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File <span class="title function_">getSnapshotFile</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LocalConfigInfoProcessorExporter.getSnapshotFile(name,</span><br><span class="line">            log4j2ConfigProperties.getDataId(),</span><br><span class="line">            log4j2ConfigProperties.getGroup(), getNamespace());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File <span class="title function_">getFailoverFile</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LocalConfigInfoProcessorExporter.getFailoverFile(name,</span><br><span class="line">            log4j2ConfigProperties.getDataId(),</span><br><span class="line">            log4j2ConfigProperties.getGroup(), getNamespace());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getServerName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.join(FIXED, <span class="string">&quot;-&quot;</span>, getServerAddr());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getServerAddr</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nacosConfigProperties.getServerAddr()</span><br><span class="line">            .replaceAll(<span class="string">&quot;http(s)?://&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            .replaceAll(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;_&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getNamespace</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nacosConfigProperties.getNamespace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于 <code>LocalConfigInfoProcessor</code> 部分方法私有化，需要重写方法，暴露出来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalConfigInfoProcessorExporter</span> <span class="keyword">extends</span> <span class="title class_">LocalConfigInfoProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUFFIX</span> <span class="operator">=</span> <span class="string">&quot;_nacos&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ENV_CHILD</span> <span class="operator">=</span> <span class="string">&quot;snapshot&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FAILOVER_FILE_CHILD_1</span> <span class="operator">=</span> <span class="string">&quot;data&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FAILOVER_FILE_CHILD_2</span> <span class="operator">=</span> <span class="string">&quot;config-data&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FAILOVER_FILE_CHILD_3</span> <span class="operator">=</span> <span class="string">&quot;config-data-tenant&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SNAPSHOT_FILE_CHILD_1</span> <span class="operator">=</span> <span class="string">&quot;snapshot&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SNAPSHOT_FILE_CHILD_2</span> <span class="operator">=</span> <span class="string">&quot;snapshot-tenant&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> File <span class="title function_">getFailoverFile</span><span class="params">(String serverName, String dataId, String group, String tenant)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(LOCAL_SNAPSHOT_PATH, serverName + SUFFIX);</span><br><span class="line">        tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, FAILOVER_FILE_CHILD_1);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(tenant)) &#123;</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, FAILOVER_FILE_CHILD_2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, FAILOVER_FILE_CHILD_3);</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, tenant);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="keyword">new</span> <span class="title class_">File</span>(tmp, group), dataId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> File <span class="title function_">getSnapshotFile</span><span class="params">(String envName, String dataId, String group, String tenant)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(LOCAL_SNAPSHOT_PATH, envName + SUFFIX);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(tenant)) &#123;</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, SNAPSHOT_FILE_CHILD_1);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, SNAPSHOT_FILE_CHILD_2);</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, tenant);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="keyword">new</span> <span class="title class_">File</span>(tmp, group), dataId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码扩展完成，对应的 application.yaml 配置文件如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span> <span class="comment"># 配置中心</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 默认关闭，请按需开启</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">eden</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">eden</span></span><br><span class="line">            <span class="attr">data-id:</span> <span class="string">log4j2.yml</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log4j2:</span></span><br><span class="line">  <span class="attr">nacos:</span> <span class="comment"># Nacos 支持 log4j2 刷新，需要同时设置 spring.cloud.nacos.config.extension-configs</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">eden</span></span><br><span class="line">    <span class="attr">data-id:</span> <span class="string">log4j2.yml</span></span><br></pre></td></tr></table></figure><p>关于 log4j2.yml 配置文件，直接在 Nacos 设置完成。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/log4j2/log4j2-nacos-config.png" alt=""></p><p>在 Nacos 修改 log4j.yml 发布后，可以从应用日志看到 <code>Reloading log4j2 config file from nacos listener, changed info</code>，表示日志已经重新加载。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/log4j2/reloading-log4j2-config-file.png" alt=""></p><h1>产出</h1><p>研发团队引入这个组件后，可以根据自己的需求在线调整生产环境的日志配置，动态控制日志级别、输出路径，提高线上排查效率。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-cloud-starters/eden-nacos-config-spring-cloud-starter">eden-nacos-config-spring-cloud-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
            <tag> Log4j2 </tag>
            
            <tag> Nacos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>News Feed 系统设计</title>
      <link href="/2023/08/25/design/News%20Feed%20%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
      <url>/2023/08/25/design/News%20Feed%20%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h1>场景</h1><h1>估算</h1><h1>设计</h1><h1>总结</h1>]]></content>
      
      
      <categories>
          
          <category> 场景设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 系统设计 </tag>
            
            <tag> 写广播 </tag>
            
            <tag> 读广播 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>URL 短链系统设计</title>
      <link href="/2023/08/25/design/URL%20%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
      <url>/2023/08/25/design/URL%20%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h1>场景</h1><h1>估算</h1><h1>设计</h1><h1>总结</h1>]]></content>
      
      
      <categories>
          
          <category> 场景设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 系统设计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>消息推送系统设计</title>
      <link href="/2023/08/25/design/%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
      <url>/2023/08/25/design/%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h1>场景</h1><h1>估算</h1><h1>设计</h1><h1>总结</h1>]]></content>
      
      
      <categories>
          
          <category> 场景设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 系统设计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网络爬虫系统设计</title>
      <link href="/2023/08/25/design/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/"/>
      <url>/2023/08/25/design/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h1>场景</h1><h1>估算</h1><h1>设计</h1><h1>总结</h1>]]></content>
      
      
      <categories>
          
          <category> 场景设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 系统设计 </tag>
            
            <tag> 爬虫 </tag>
            
            <tag> DFS </tag>
            
            <tag> BFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>唯一ID生成器设计</title>
      <link href="/2023/08/25/design/%E5%94%AF%E4%B8%80ID%E7%94%9F%E6%88%90%E5%99%A8%E8%AE%BE%E8%AE%A1/"/>
      <url>/2023/08/25/design/%E5%94%AF%E4%B8%80ID%E7%94%9F%E6%88%90%E5%99%A8%E8%AE%BE%E8%AE%A1/</url>
      
        <content type="html"><![CDATA[<h1>场景</h1><h1>估算</h1><h1>设计</h1><h1>总结</h1>]]></content>
      
      
      <categories>
          
          <category> 场景设计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 系统设计 </tag>
            
            <tag> 雪花算法 </tag>
            
            <tag> 发号器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>APISIX 金丝雀发布实践</title>
      <link href="/2023/08/16/devops/APISIX%20%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83%E5%AE%9E%E8%B7%B5/"/>
      <url>/2023/08/16/devops/APISIX%20%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>Apache APISIX 是 Apache 软件基金会下的云原生 API 网关，由 <a href="http://API7.ai">API7.ai</a> 开发并捐赠，基于 NGINX + ngx_lua 构建，提供了动态路由、动态上游、动态证书、A/B 测试、灰度发布（金丝雀发布）、蓝绿部署、限速、防攻击、收集指标、监控报警、可观测、服务治理等功能。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/apisix/apisix-architect.png" alt=""></p><p>具体的介绍可以查阅 <a href="https://apisix.apache.org/zh/docs/apisix/getting-started/README/">APISIX 文档</a>。</p><p>由于 Nginx reload 存在网络抖动，并且随着业务路由增加，nginx 配置维护十分困难。根据 APISIX 的官方介绍，这些问题得到解决。因此，我们尝试引入 APISIX 作为云原生网关，实现 A/B 测试、金丝雀发布等功能。</p><h1>目标</h1><p>引入 APISIX 代替 Nginx 网关，简化生产运维操作。</p><h1>部署</h1><p>为方便维护，使用官方提供的 Helm 脚本部署 APISIX 网关，代码片段如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add apisix https://charts.apiseven.com</span><br><span class="line">helm repo update</span><br><span class="line">helm install apisix apisix/apisix --create-namespace  --namespace apisix</span><br></pre></td></tr></table></figure><p>在 KubeSphere 查看已部署的工作负载，可以看到 APISIX 分别创建了 <code>apisix</code> 访问入口、<code>apisix-dashboard</code> 控制台和 <code>apisix-ingress-controller</code> 控制器。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/apisix/apisix-deployment.png" alt=""></p><p>调整 <code>apisix</code> 网关的服务端口为 80，<code>apisix-dashboard</code> 控制台的服务端口为 9000，初始用户密码为 <code>admin/admin</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/apisix/apisix-dashboard.png" alt=""></p><h1>配置</h1><blockquote><p>本文只讲解最基本的配置流程，不涉及域名和证书的配置步骤。</p></blockquote><h2 id="配置上游">配置上游</h2><p>假设创建一个名为 <code>eden-demo-cola</code> 的上游。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/apisix/apisix-create-upstream.png" alt=""></p><h2 id="配置服务">配置服务</h2><p>添加 <code>eden-demo-cola</code> 服务，并绑定已创建的上游。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/apisix/apisix-create-service.png" alt=""></p><h2 id="配置路由">配置路由</h2><p>假设请求入口为 <code>/api/auth</code>，参考下图，配置为路由A。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/apisix/apisix-create-router.png" alt=""></p><p>如果你的上游服务访问入口为 <code>/auth</code>，可以通过重写请求路径的方式，将 <code>/api/auth</code> 重写为 <code>/auth</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/apisix/apisix-rewrite-router.png" alt=""></p><h2 id="验证-A-B-测试">验证 A/B 测试</h2><p>保存上述创建好的路由 A，当客户端不携带任何请求头时，默认访问路由 A。</p><p>添加新的路由 B，设置 HTTP 请求头来控制是否接收请求，例如 <code>region=gz</code> 或者 <code>region=sz</code>，当客户端携带这些请求头，将访问路由 B。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/apisix/apisix-create-router-by-header.png" alt=""></p><p>使用 curl 命令，模拟请求，查看路由的请求情况。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl --request GET http://10.2.2.109/api/auth</span><br><span class="line"></span><br><span class="line">路由A</span><br><span class="line">路由A</span><br><span class="line">路由A</span><br><span class="line">路由A</span><br><span class="line"></span><br><span class="line">curl --request GET http://10.2.2.109/api/auth --header <span class="string">&#x27;region: gz&#x27;</span></span><br><span class="line"></span><br><span class="line">路由B</span><br><span class="line">路由B</span><br><span class="line">路由B</span><br><span class="line">路由B</span><br></pre></td></tr></table></figure><h2 id="验证金丝雀发布">验证金丝雀发布</h2><p>APISIX 控制台在配置上游时，提供了权重控制选项，您可以添加多个节点来实现金丝雀发布。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/apisix/apisix-update-upstream-weight.png" alt=""></p><p>使用 curl 命令，模拟请求，查看路由的请求情况。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; curl --request GET http://10.2.2.109/api/auth</span><br><span class="line"></span><br><span class="line">路由A</span><br><span class="line">路由A</span><br><span class="line">路由A</span><br><span class="line">路由C</span><br><span class="line">路由A</span><br><span class="line">路由C</span><br><span class="line">路由C</span><br><span class="line">路由C</span><br></pre></td></tr></table></figure><h1>总结</h1><p>在引入 APISIX 云原生网关后，我们替换了 Nginx，解决了 Nginx reload 的网络抖动问题，并且可以很方便的实现 A/B 测试、金丝雀发布等场景。</p><p>本文并没有探讨 APISIX Ingress Controller 的使用，因为 APISIX Dashboard 本身的功能已经足够满足我们的需求。</p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> APISIX </tag>
            
            <tag> A/B 测试 </tag>
            
            <tag> 金丝雀发布 </tag>
            
            <tag> 云原生网关 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus 动态获取 Pod 监控数据改造</title>
      <link href="/2023/08/15/spring/Prometheus%20%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%20Pod%20%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E6%94%B9%E9%80%A0/"/>
      <url>/2023/08/15/spring/Prometheus%20%E5%8A%A8%E6%80%81%E8%8E%B7%E5%8F%96%20Pod%20%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%E6%94%B9%E9%80%A0/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>Spring Boot Actuator 提供了一个监控和管理生产环境的端点，可以查看应用的运行状态。由于运维人员对 Prometheus 和 Grafana 的配置不是很熟悉，使用静态 IP 来获取监控数据，并且从 Grafana 模板市场获取的 Dashboard 不能较好的区分运行环境。</p><h1>目标</h1><p>使用 Prometheus 服务发现动态获取 Pod 的监控数据，支持 K8s 运行环境筛选监控数据。</p><h1>实现</h1><h2 id="引入-Prometheus-依赖">引入 Prometheus 依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.micrometer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient_common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.prometheus<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simpleclient_httpserver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="配置-Actuator-端点">配置 Actuator 端点</h2><p>假设您的配置文件是 <code>application.yaml</code>，示例配置内容如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9080</span> <span class="comment"># 建议和 server.port 业务端口隔离，便于区分请求流量和鉴权防护</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">base-path:</span> <span class="string">/actuator</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">health,info,prometheus,metrics</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">health:</span></span><br><span class="line">      <span class="attr">show-details:</span> <span class="string">ALWAYS</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br></pre></td></tr></table></figure><p>访问 <a href="http://127.0.0.1:9080/actuator/prometheus">http://127.0.0.1:9080/actuator/prometheus</a></p><p>效果如下。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-boot-actuator-prometheus.png" alt=""></p><h2 id="配置-Prometheus-服务发现">配置 Prometheus 服务发现</h2><p>Prometheus 默认支持 K8s 服务发现，不建议您配置静态 IP。</p><p>笔者的做法是在目标监测服务 Service，配置 2 个 Label 作为匹配项，例如 <code>prometheus.io/port</code> 监控端口<br>和 <code>prometheus.io/spring-boot-actuator-enabled</code> 监控开关，设置为 true 表示开启采集。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">eden-demo-cola</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prod</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/port:</span> <span class="string">&quot;9080&quot;</span></span><br><span class="line">    <span class="attr">prometheus.io/spring-boot-actuator-enabled:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">//</span> <span class="string">省略</span></span><br></pre></td></tr></table></figure><p>对应的 <code>prometheus.yml</code> 配置模板，设置自动获取 Pod 服务所在的 Namespace 和 Service。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;spring-boot-actuator&#x27;</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/actuator/prometheus</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="comment"># 对应 prometheus.io/spring-boot-actuator-enabled 注解</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_spring_boot_actuator_enabled</span>]</span><br><span class="line">      <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scheme</span>]</span><br><span class="line">      <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_path</span>]</span><br><span class="line">      <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">    <span class="comment"># 对应 prometheus.io/port 注解</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span>]</span><br><span class="line">      <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">      <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">namespace</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">      <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">service_name</span></span><br></pre></td></tr></table></figure><p>上述代码，除了注释标记的两个注解，其它的都可以通过 K8s 环境获取。</p><h2 id="集成到-Grafana-可视化">集成到 Grafana 可视化</h2><p>官方提供的 Spring Boot Actuator 模板很难区分服务部署在哪一套环境，需要进行调整。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/grafana/grafana-spring-boot-actuator.png" alt=""></p><p>我们的需求是实现 <code>namespace (环境)</code> &gt; <code>application(应用名称)</code> &gt; <code>instance(IP)</code> 这样的级联过滤，因此，需要进入 <code>Dashboard</code> &gt; <code>Settings</code> &gt; <code>Variables</code> 中修改，您可以参考图片中的内容。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/grafana/grafana-spring-boot-actuator-variables.png" alt=""></p><p>修改后的 Dashboard 完整代码如下（内容较长，建议直接复制粘贴到 Grafana 中即可）。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br><span class="line">1850</span><br><span class="line">1851</span><br><span class="line">1852</span><br><span class="line">1853</span><br><span class="line">1854</span><br><span class="line">1855</span><br><span class="line">1856</span><br><span class="line">1857</span><br><span class="line">1858</span><br><span class="line">1859</span><br><span class="line">1860</span><br><span class="line">1861</span><br><span class="line">1862</span><br><span class="line">1863</span><br><span class="line">1864</span><br><span class="line">1865</span><br><span class="line">1866</span><br><span class="line">1867</span><br><span class="line">1868</span><br><span class="line">1869</span><br><span class="line">1870</span><br><span class="line">1871</span><br><span class="line">1872</span><br><span class="line">1873</span><br><span class="line">1874</span><br><span class="line">1875</span><br><span class="line">1876</span><br><span class="line">1877</span><br><span class="line">1878</span><br><span class="line">1879</span><br><span class="line">1880</span><br><span class="line">1881</span><br><span class="line">1882</span><br><span class="line">1883</span><br><span class="line">1884</span><br><span class="line">1885</span><br><span class="line">1886</span><br><span class="line">1887</span><br><span class="line">1888</span><br><span class="line">1889</span><br><span class="line">1890</span><br><span class="line">1891</span><br><span class="line">1892</span><br><span class="line">1893</span><br><span class="line">1894</span><br><span class="line">1895</span><br><span class="line">1896</span><br><span class="line">1897</span><br><span class="line">1898</span><br><span class="line">1899</span><br><span class="line">1900</span><br><span class="line">1901</span><br><span class="line">1902</span><br><span class="line">1903</span><br><span class="line">1904</span><br><span class="line">1905</span><br><span class="line">1906</span><br><span class="line">1907</span><br><span class="line">1908</span><br><span class="line">1909</span><br><span class="line">1910</span><br><span class="line">1911</span><br><span class="line">1912</span><br><span class="line">1913</span><br><span class="line">1914</span><br><span class="line">1915</span><br><span class="line">1916</span><br><span class="line">1917</span><br><span class="line">1918</span><br><span class="line">1919</span><br><span class="line">1920</span><br><span class="line">1921</span><br><span class="line">1922</span><br><span class="line">1923</span><br><span class="line">1924</span><br><span class="line">1925</span><br><span class="line">1926</span><br><span class="line">1927</span><br><span class="line">1928</span><br><span class="line">1929</span><br><span class="line">1930</span><br><span class="line">1931</span><br><span class="line">1932</span><br><span class="line">1933</span><br><span class="line">1934</span><br><span class="line">1935</span><br><span class="line">1936</span><br><span class="line">1937</span><br><span class="line">1938</span><br><span class="line">1939</span><br><span class="line">1940</span><br><span class="line">1941</span><br><span class="line">1942</span><br><span class="line">1943</span><br><span class="line">1944</span><br><span class="line">1945</span><br><span class="line">1946</span><br><span class="line">1947</span><br><span class="line">1948</span><br><span class="line">1949</span><br><span class="line">1950</span><br><span class="line">1951</span><br><span class="line">1952</span><br><span class="line">1953</span><br><span class="line">1954</span><br><span class="line">1955</span><br><span class="line">1956</span><br><span class="line">1957</span><br><span class="line">1958</span><br><span class="line">1959</span><br><span class="line">1960</span><br><span class="line">1961</span><br><span class="line">1962</span><br><span class="line">1963</span><br><span class="line">1964</span><br><span class="line">1965</span><br><span class="line">1966</span><br><span class="line">1967</span><br><span class="line">1968</span><br><span class="line">1969</span><br><span class="line">1970</span><br><span class="line">1971</span><br><span class="line">1972</span><br><span class="line">1973</span><br><span class="line">1974</span><br><span class="line">1975</span><br><span class="line">1976</span><br><span class="line">1977</span><br><span class="line">1978</span><br><span class="line">1979</span><br><span class="line">1980</span><br><span class="line">1981</span><br><span class="line">1982</span><br><span class="line">1983</span><br><span class="line">1984</span><br><span class="line">1985</span><br><span class="line">1986</span><br><span class="line">1987</span><br><span class="line">1988</span><br><span class="line">1989</span><br><span class="line">1990</span><br><span class="line">1991</span><br><span class="line">1992</span><br><span class="line">1993</span><br><span class="line">1994</span><br><span class="line">1995</span><br><span class="line">1996</span><br><span class="line">1997</span><br><span class="line">1998</span><br><span class="line">1999</span><br><span class="line">2000</span><br><span class="line">2001</span><br><span class="line">2002</span><br><span class="line">2003</span><br><span class="line">2004</span><br><span class="line">2005</span><br><span class="line">2006</span><br><span class="line">2007</span><br><span class="line">2008</span><br><span class="line">2009</span><br><span class="line">2010</span><br><span class="line">2011</span><br><span class="line">2012</span><br><span class="line">2013</span><br><span class="line">2014</span><br><span class="line">2015</span><br><span class="line">2016</span><br><span class="line">2017</span><br><span class="line">2018</span><br><span class="line">2019</span><br><span class="line">2020</span><br><span class="line">2021</span><br><span class="line">2022</span><br><span class="line">2023</span><br><span class="line">2024</span><br><span class="line">2025</span><br><span class="line">2026</span><br><span class="line">2027</span><br><span class="line">2028</span><br><span class="line">2029</span><br><span class="line">2030</span><br><span class="line">2031</span><br><span class="line">2032</span><br><span class="line">2033</span><br><span class="line">2034</span><br><span class="line">2035</span><br><span class="line">2036</span><br><span class="line">2037</span><br><span class="line">2038</span><br><span class="line">2039</span><br><span class="line">2040</span><br><span class="line">2041</span><br><span class="line">2042</span><br><span class="line">2043</span><br><span class="line">2044</span><br><span class="line">2045</span><br><span class="line">2046</span><br><span class="line">2047</span><br><span class="line">2048</span><br><span class="line">2049</span><br><span class="line">2050</span><br><span class="line">2051</span><br><span class="line">2052</span><br><span class="line">2053</span><br><span class="line">2054</span><br><span class="line">2055</span><br><span class="line">2056</span><br><span class="line">2057</span><br><span class="line">2058</span><br><span class="line">2059</span><br><span class="line">2060</span><br><span class="line">2061</span><br><span class="line">2062</span><br><span class="line">2063</span><br><span class="line">2064</span><br><span class="line">2065</span><br><span class="line">2066</span><br><span class="line">2067</span><br><span class="line">2068</span><br><span class="line">2069</span><br><span class="line">2070</span><br><span class="line">2071</span><br><span class="line">2072</span><br><span class="line">2073</span><br><span class="line">2074</span><br><span class="line">2075</span><br><span class="line">2076</span><br><span class="line">2077</span><br><span class="line">2078</span><br><span class="line">2079</span><br><span class="line">2080</span><br><span class="line">2081</span><br><span class="line">2082</span><br><span class="line">2083</span><br><span class="line">2084</span><br><span class="line">2085</span><br><span class="line">2086</span><br><span class="line">2087</span><br><span class="line">2088</span><br><span class="line">2089</span><br><span class="line">2090</span><br><span class="line">2091</span><br><span class="line">2092</span><br><span class="line">2093</span><br><span class="line">2094</span><br><span class="line">2095</span><br><span class="line">2096</span><br><span class="line">2097</span><br><span class="line">2098</span><br><span class="line">2099</span><br><span class="line">2100</span><br><span class="line">2101</span><br><span class="line">2102</span><br><span class="line">2103</span><br><span class="line">2104</span><br><span class="line">2105</span><br><span class="line">2106</span><br><span class="line">2107</span><br><span class="line">2108</span><br><span class="line">2109</span><br><span class="line">2110</span><br><span class="line">2111</span><br><span class="line">2112</span><br><span class="line">2113</span><br><span class="line">2114</span><br><span class="line">2115</span><br><span class="line">2116</span><br><span class="line">2117</span><br><span class="line">2118</span><br><span class="line">2119</span><br><span class="line">2120</span><br><span class="line">2121</span><br><span class="line">2122</span><br><span class="line">2123</span><br><span class="line">2124</span><br><span class="line">2125</span><br><span class="line">2126</span><br><span class="line">2127</span><br><span class="line">2128</span><br><span class="line">2129</span><br><span class="line">2130</span><br><span class="line">2131</span><br><span class="line">2132</span><br><span class="line">2133</span><br><span class="line">2134</span><br><span class="line">2135</span><br><span class="line">2136</span><br><span class="line">2137</span><br><span class="line">2138</span><br><span class="line">2139</span><br><span class="line">2140</span><br><span class="line">2141</span><br><span class="line">2142</span><br><span class="line">2143</span><br><span class="line">2144</span><br><span class="line">2145</span><br><span class="line">2146</span><br><span class="line">2147</span><br><span class="line">2148</span><br><span class="line">2149</span><br><span class="line">2150</span><br><span class="line">2151</span><br><span class="line">2152</span><br><span class="line">2153</span><br><span class="line">2154</span><br><span class="line">2155</span><br><span class="line">2156</span><br><span class="line">2157</span><br><span class="line">2158</span><br><span class="line">2159</span><br><span class="line">2160</span><br><span class="line">2161</span><br><span class="line">2162</span><br><span class="line">2163</span><br><span class="line">2164</span><br><span class="line">2165</span><br><span class="line">2166</span><br><span class="line">2167</span><br><span class="line">2168</span><br><span class="line">2169</span><br><span class="line">2170</span><br><span class="line">2171</span><br><span class="line">2172</span><br><span class="line">2173</span><br><span class="line">2174</span><br><span class="line">2175</span><br><span class="line">2176</span><br><span class="line">2177</span><br><span class="line">2178</span><br><span class="line">2179</span><br><span class="line">2180</span><br><span class="line">2181</span><br><span class="line">2182</span><br><span class="line">2183</span><br><span class="line">2184</span><br><span class="line">2185</span><br><span class="line">2186</span><br><span class="line">2187</span><br><span class="line">2188</span><br><span class="line">2189</span><br><span class="line">2190</span><br><span class="line">2191</span><br><span class="line">2192</span><br><span class="line">2193</span><br><span class="line">2194</span><br><span class="line">2195</span><br><span class="line">2196</span><br><span class="line">2197</span><br><span class="line">2198</span><br><span class="line">2199</span><br><span class="line">2200</span><br><span class="line">2201</span><br><span class="line">2202</span><br><span class="line">2203</span><br><span class="line">2204</span><br><span class="line">2205</span><br><span class="line">2206</span><br><span class="line">2207</span><br><span class="line">2208</span><br><span class="line">2209</span><br><span class="line">2210</span><br><span class="line">2211</span><br><span class="line">2212</span><br><span class="line">2213</span><br><span class="line">2214</span><br><span class="line">2215</span><br><span class="line">2216</span><br><span class="line">2217</span><br><span class="line">2218</span><br><span class="line">2219</span><br><span class="line">2220</span><br><span class="line">2221</span><br><span class="line">2222</span><br><span class="line">2223</span><br><span class="line">2224</span><br><span class="line">2225</span><br><span class="line">2226</span><br><span class="line">2227</span><br><span class="line">2228</span><br><span class="line">2229</span><br><span class="line">2230</span><br><span class="line">2231</span><br><span class="line">2232</span><br><span class="line">2233</span><br><span class="line">2234</span><br><span class="line">2235</span><br><span class="line">2236</span><br><span class="line">2237</span><br><span class="line">2238</span><br><span class="line">2239</span><br><span class="line">2240</span><br><span class="line">2241</span><br><span class="line">2242</span><br><span class="line">2243</span><br><span class="line">2244</span><br><span class="line">2245</span><br><span class="line">2246</span><br><span class="line">2247</span><br><span class="line">2248</span><br><span class="line">2249</span><br><span class="line">2250</span><br><span class="line">2251</span><br><span class="line">2252</span><br><span class="line">2253</span><br><span class="line">2254</span><br><span class="line">2255</span><br><span class="line">2256</span><br><span class="line">2257</span><br><span class="line">2258</span><br><span class="line">2259</span><br><span class="line">2260</span><br><span class="line">2261</span><br><span class="line">2262</span><br><span class="line">2263</span><br><span class="line">2264</span><br><span class="line">2265</span><br><span class="line">2266</span><br><span class="line">2267</span><br><span class="line">2268</span><br><span class="line">2269</span><br><span class="line">2270</span><br><span class="line">2271</span><br><span class="line">2272</span><br><span class="line">2273</span><br><span class="line">2274</span><br><span class="line">2275</span><br><span class="line">2276</span><br><span class="line">2277</span><br><span class="line">2278</span><br><span class="line">2279</span><br><span class="line">2280</span><br><span class="line">2281</span><br><span class="line">2282</span><br><span class="line">2283</span><br><span class="line">2284</span><br><span class="line">2285</span><br><span class="line">2286</span><br><span class="line">2287</span><br><span class="line">2288</span><br><span class="line">2289</span><br><span class="line">2290</span><br><span class="line">2291</span><br><span class="line">2292</span><br><span class="line">2293</span><br><span class="line">2294</span><br><span class="line">2295</span><br><span class="line">2296</span><br><span class="line">2297</span><br><span class="line">2298</span><br><span class="line">2299</span><br><span class="line">2300</span><br><span class="line">2301</span><br><span class="line">2302</span><br><span class="line">2303</span><br><span class="line">2304</span><br><span class="line">2305</span><br><span class="line">2306</span><br><span class="line">2307</span><br><span class="line">2308</span><br><span class="line">2309</span><br><span class="line">2310</span><br><span class="line">2311</span><br><span class="line">2312</span><br><span class="line">2313</span><br><span class="line">2314</span><br><span class="line">2315</span><br><span class="line">2316</span><br><span class="line">2317</span><br><span class="line">2318</span><br><span class="line">2319</span><br><span class="line">2320</span><br><span class="line">2321</span><br><span class="line">2322</span><br><span class="line">2323</span><br><span class="line">2324</span><br><span class="line">2325</span><br><span class="line">2326</span><br><span class="line">2327</span><br><span class="line">2328</span><br><span class="line">2329</span><br><span class="line">2330</span><br><span class="line">2331</span><br><span class="line">2332</span><br><span class="line">2333</span><br><span class="line">2334</span><br><span class="line">2335</span><br><span class="line">2336</span><br><span class="line">2337</span><br><span class="line">2338</span><br><span class="line">2339</span><br><span class="line">2340</span><br><span class="line">2341</span><br><span class="line">2342</span><br><span class="line">2343</span><br><span class="line">2344</span><br><span class="line">2345</span><br><span class="line">2346</span><br><span class="line">2347</span><br><span class="line">2348</span><br><span class="line">2349</span><br><span class="line">2350</span><br><span class="line">2351</span><br><span class="line">2352</span><br><span class="line">2353</span><br><span class="line">2354</span><br><span class="line">2355</span><br><span class="line">2356</span><br><span class="line">2357</span><br><span class="line">2358</span><br><span class="line">2359</span><br><span class="line">2360</span><br><span class="line">2361</span><br><span class="line">2362</span><br><span class="line">2363</span><br><span class="line">2364</span><br><span class="line">2365</span><br><span class="line">2366</span><br><span class="line">2367</span><br><span class="line">2368</span><br><span class="line">2369</span><br><span class="line">2370</span><br><span class="line">2371</span><br><span class="line">2372</span><br><span class="line">2373</span><br><span class="line">2374</span><br><span class="line">2375</span><br><span class="line">2376</span><br><span class="line">2377</span><br><span class="line">2378</span><br><span class="line">2379</span><br><span class="line">2380</span><br><span class="line">2381</span><br><span class="line">2382</span><br><span class="line">2383</span><br><span class="line">2384</span><br><span class="line">2385</span><br><span class="line">2386</span><br><span class="line">2387</span><br><span class="line">2388</span><br><span class="line">2389</span><br><span class="line">2390</span><br><span class="line">2391</span><br><span class="line">2392</span><br><span class="line">2393</span><br><span class="line">2394</span><br><span class="line">2395</span><br><span class="line">2396</span><br><span class="line">2397</span><br><span class="line">2398</span><br><span class="line">2399</span><br><span class="line">2400</span><br><span class="line">2401</span><br><span class="line">2402</span><br><span class="line">2403</span><br><span class="line">2404</span><br><span class="line">2405</span><br><span class="line">2406</span><br><span class="line">2407</span><br><span class="line">2408</span><br><span class="line">2409</span><br><span class="line">2410</span><br><span class="line">2411</span><br><span class="line">2412</span><br><span class="line">2413</span><br><span class="line">2414</span><br><span class="line">2415</span><br><span class="line">2416</span><br><span class="line">2417</span><br><span class="line">2418</span><br><span class="line">2419</span><br><span class="line">2420</span><br><span class="line">2421</span><br><span class="line">2422</span><br><span class="line">2423</span><br><span class="line">2424</span><br><span class="line">2425</span><br><span class="line">2426</span><br><span class="line">2427</span><br><span class="line">2428</span><br><span class="line">2429</span><br><span class="line">2430</span><br><span class="line">2431</span><br><span class="line">2432</span><br><span class="line">2433</span><br><span class="line">2434</span><br><span class="line">2435</span><br><span class="line">2436</span><br><span class="line">2437</span><br><span class="line">2438</span><br><span class="line">2439</span><br><span class="line">2440</span><br><span class="line">2441</span><br><span class="line">2442</span><br><span class="line">2443</span><br><span class="line">2444</span><br><span class="line">2445</span><br><span class="line">2446</span><br><span class="line">2447</span><br><span class="line">2448</span><br><span class="line">2449</span><br><span class="line">2450</span><br><span class="line">2451</span><br><span class="line">2452</span><br><span class="line">2453</span><br><span class="line">2454</span><br><span class="line">2455</span><br><span class="line">2456</span><br><span class="line">2457</span><br><span class="line">2458</span><br><span class="line">2459</span><br><span class="line">2460</span><br><span class="line">2461</span><br><span class="line">2462</span><br><span class="line">2463</span><br><span class="line">2464</span><br><span class="line">2465</span><br><span class="line">2466</span><br><span class="line">2467</span><br><span class="line">2468</span><br><span class="line">2469</span><br><span class="line">2470</span><br><span class="line">2471</span><br><span class="line">2472</span><br><span class="line">2473</span><br><span class="line">2474</span><br><span class="line">2475</span><br><span class="line">2476</span><br><span class="line">2477</span><br><span class="line">2478</span><br><span class="line">2479</span><br><span class="line">2480</span><br><span class="line">2481</span><br><span class="line">2482</span><br><span class="line">2483</span><br><span class="line">2484</span><br><span class="line">2485</span><br><span class="line">2486</span><br><span class="line">2487</span><br><span class="line">2488</span><br><span class="line">2489</span><br><span class="line">2490</span><br><span class="line">2491</span><br><span class="line">2492</span><br><span class="line">2493</span><br><span class="line">2494</span><br><span class="line">2495</span><br><span class="line">2496</span><br><span class="line">2497</span><br><span class="line">2498</span><br><span class="line">2499</span><br><span class="line">2500</span><br><span class="line">2501</span><br><span class="line">2502</span><br><span class="line">2503</span><br><span class="line">2504</span><br><span class="line">2505</span><br><span class="line">2506</span><br><span class="line">2507</span><br><span class="line">2508</span><br><span class="line">2509</span><br><span class="line">2510</span><br><span class="line">2511</span><br><span class="line">2512</span><br><span class="line">2513</span><br><span class="line">2514</span><br><span class="line">2515</span><br><span class="line">2516</span><br><span class="line">2517</span><br><span class="line">2518</span><br><span class="line">2519</span><br><span class="line">2520</span><br><span class="line">2521</span><br><span class="line">2522</span><br><span class="line">2523</span><br><span class="line">2524</span><br><span class="line">2525</span><br><span class="line">2526</span><br><span class="line">2527</span><br><span class="line">2528</span><br><span class="line">2529</span><br><span class="line">2530</span><br><span class="line">2531</span><br><span class="line">2532</span><br><span class="line">2533</span><br><span class="line">2534</span><br><span class="line">2535</span><br><span class="line">2536</span><br><span class="line">2537</span><br><span class="line">2538</span><br><span class="line">2539</span><br><span class="line">2540</span><br><span class="line">2541</span><br><span class="line">2542</span><br><span class="line">2543</span><br><span class="line">2544</span><br><span class="line">2545</span><br><span class="line">2546</span><br><span class="line">2547</span><br><span class="line">2548</span><br><span class="line">2549</span><br><span class="line">2550</span><br><span class="line">2551</span><br><span class="line">2552</span><br><span class="line">2553</span><br><span class="line">2554</span><br><span class="line">2555</span><br><span class="line">2556</span><br><span class="line">2557</span><br><span class="line">2558</span><br><span class="line">2559</span><br><span class="line">2560</span><br><span class="line">2561</span><br><span class="line">2562</span><br><span class="line">2563</span><br><span class="line">2564</span><br><span class="line">2565</span><br><span class="line">2566</span><br><span class="line">2567</span><br><span class="line">2568</span><br><span class="line">2569</span><br><span class="line">2570</span><br><span class="line">2571</span><br><span class="line">2572</span><br><span class="line">2573</span><br><span class="line">2574</span><br><span class="line">2575</span><br><span class="line">2576</span><br><span class="line">2577</span><br><span class="line">2578</span><br><span class="line">2579</span><br><span class="line">2580</span><br><span class="line">2581</span><br><span class="line">2582</span><br><span class="line">2583</span><br><span class="line">2584</span><br><span class="line">2585</span><br><span class="line">2586</span><br><span class="line">2587</span><br><span class="line">2588</span><br><span class="line">2589</span><br><span class="line">2590</span><br><span class="line">2591</span><br><span class="line">2592</span><br><span class="line">2593</span><br><span class="line">2594</span><br><span class="line">2595</span><br><span class="line">2596</span><br><span class="line">2597</span><br><span class="line">2598</span><br><span class="line">2599</span><br><span class="line">2600</span><br><span class="line">2601</span><br><span class="line">2602</span><br><span class="line">2603</span><br><span class="line">2604</span><br><span class="line">2605</span><br><span class="line">2606</span><br><span class="line">2607</span><br><span class="line">2608</span><br><span class="line">2609</span><br><span class="line">2610</span><br><span class="line">2611</span><br><span class="line">2612</span><br><span class="line">2613</span><br><span class="line">2614</span><br><span class="line">2615</span><br><span class="line">2616</span><br><span class="line">2617</span><br><span class="line">2618</span><br><span class="line">2619</span><br><span class="line">2620</span><br><span class="line">2621</span><br><span class="line">2622</span><br><span class="line">2623</span><br><span class="line">2624</span><br><span class="line">2625</span><br><span class="line">2626</span><br><span class="line">2627</span><br><span class="line">2628</span><br><span class="line">2629</span><br><span class="line">2630</span><br><span class="line">2631</span><br><span class="line">2632</span><br><span class="line">2633</span><br><span class="line">2634</span><br><span class="line">2635</span><br><span class="line">2636</span><br><span class="line">2637</span><br><span class="line">2638</span><br><span class="line">2639</span><br><span class="line">2640</span><br><span class="line">2641</span><br><span class="line">2642</span><br><span class="line">2643</span><br><span class="line">2644</span><br><span class="line">2645</span><br><span class="line">2646</span><br><span class="line">2647</span><br><span class="line">2648</span><br><span class="line">2649</span><br><span class="line">2650</span><br><span class="line">2651</span><br><span class="line">2652</span><br><span class="line">2653</span><br><span class="line">2654</span><br><span class="line">2655</span><br><span class="line">2656</span><br><span class="line">2657</span><br><span class="line">2658</span><br><span class="line">2659</span><br><span class="line">2660</span><br><span class="line">2661</span><br><span class="line">2662</span><br><span class="line">2663</span><br><span class="line">2664</span><br><span class="line">2665</span><br><span class="line">2666</span><br><span class="line">2667</span><br><span class="line">2668</span><br><span class="line">2669</span><br><span class="line">2670</span><br><span class="line">2671</span><br><span class="line">2672</span><br><span class="line">2673</span><br><span class="line">2674</span><br><span class="line">2675</span><br><span class="line">2676</span><br><span class="line">2677</span><br><span class="line">2678</span><br><span class="line">2679</span><br><span class="line">2680</span><br><span class="line">2681</span><br><span class="line">2682</span><br><span class="line">2683</span><br><span class="line">2684</span><br><span class="line">2685</span><br><span class="line">2686</span><br><span class="line">2687</span><br><span class="line">2688</span><br><span class="line">2689</span><br><span class="line">2690</span><br><span class="line">2691</span><br><span class="line">2692</span><br><span class="line">2693</span><br><span class="line">2694</span><br><span class="line">2695</span><br><span class="line">2696</span><br><span class="line">2697</span><br><span class="line">2698</span><br><span class="line">2699</span><br><span class="line">2700</span><br><span class="line">2701</span><br><span class="line">2702</span><br><span class="line">2703</span><br><span class="line">2704</span><br><span class="line">2705</span><br><span class="line">2706</span><br><span class="line">2707</span><br><span class="line">2708</span><br><span class="line">2709</span><br><span class="line">2710</span><br><span class="line">2711</span><br><span class="line">2712</span><br><span class="line">2713</span><br><span class="line">2714</span><br><span class="line">2715</span><br><span class="line">2716</span><br><span class="line">2717</span><br><span class="line">2718</span><br><span class="line">2719</span><br><span class="line">2720</span><br><span class="line">2721</span><br><span class="line">2722</span><br><span class="line">2723</span><br><span class="line">2724</span><br><span class="line">2725</span><br><span class="line">2726</span><br><span class="line">2727</span><br><span class="line">2728</span><br><span class="line">2729</span><br><span class="line">2730</span><br><span class="line">2731</span><br><span class="line">2732</span><br><span class="line">2733</span><br><span class="line">2734</span><br><span class="line">2735</span><br><span class="line">2736</span><br><span class="line">2737</span><br><span class="line">2738</span><br><span class="line">2739</span><br><span class="line">2740</span><br><span class="line">2741</span><br><span class="line">2742</span><br><span class="line">2743</span><br><span class="line">2744</span><br><span class="line">2745</span><br><span class="line">2746</span><br><span class="line">2747</span><br><span class="line">2748</span><br><span class="line">2749</span><br><span class="line">2750</span><br><span class="line">2751</span><br><span class="line">2752</span><br><span class="line">2753</span><br><span class="line">2754</span><br><span class="line">2755</span><br><span class="line">2756</span><br><span class="line">2757</span><br><span class="line">2758</span><br><span class="line">2759</span><br><span class="line">2760</span><br><span class="line">2761</span><br><span class="line">2762</span><br><span class="line">2763</span><br><span class="line">2764</span><br><span class="line">2765</span><br><span class="line">2766</span><br><span class="line">2767</span><br><span class="line">2768</span><br><span class="line">2769</span><br><span class="line">2770</span><br><span class="line">2771</span><br><span class="line">2772</span><br><span class="line">2773</span><br><span class="line">2774</span><br><span class="line">2775</span><br><span class="line">2776</span><br><span class="line">2777</span><br><span class="line">2778</span><br><span class="line">2779</span><br><span class="line">2780</span><br><span class="line">2781</span><br><span class="line">2782</span><br><span class="line">2783</span><br><span class="line">2784</span><br><span class="line">2785</span><br><span class="line">2786</span><br><span class="line">2787</span><br><span class="line">2788</span><br><span class="line">2789</span><br><span class="line">2790</span><br><span class="line">2791</span><br><span class="line">2792</span><br><span class="line">2793</span><br><span class="line">2794</span><br><span class="line">2795</span><br><span class="line">2796</span><br><span class="line">2797</span><br><span class="line">2798</span><br><span class="line">2799</span><br><span class="line">2800</span><br><span class="line">2801</span><br><span class="line">2802</span><br><span class="line">2803</span><br><span class="line">2804</span><br><span class="line">2805</span><br><span class="line">2806</span><br><span class="line">2807</span><br><span class="line">2808</span><br><span class="line">2809</span><br><span class="line">2810</span><br><span class="line">2811</span><br><span class="line">2812</span><br><span class="line">2813</span><br><span class="line">2814</span><br><span class="line">2815</span><br><span class="line">2816</span><br><span class="line">2817</span><br><span class="line">2818</span><br><span class="line">2819</span><br><span class="line">2820</span><br><span class="line">2821</span><br><span class="line">2822</span><br><span class="line">2823</span><br><span class="line">2824</span><br><span class="line">2825</span><br><span class="line">2826</span><br><span class="line">2827</span><br><span class="line">2828</span><br><span class="line">2829</span><br><span class="line">2830</span><br><span class="line">2831</span><br><span class="line">2832</span><br><span class="line">2833</span><br><span class="line">2834</span><br><span class="line">2835</span><br><span class="line">2836</span><br><span class="line">2837</span><br><span class="line">2838</span><br><span class="line">2839</span><br><span class="line">2840</span><br><span class="line">2841</span><br><span class="line">2842</span><br><span class="line">2843</span><br><span class="line">2844</span><br><span class="line">2845</span><br><span class="line">2846</span><br><span class="line">2847</span><br><span class="line">2848</span><br><span class="line">2849</span><br><span class="line">2850</span><br><span class="line">2851</span><br><span class="line">2852</span><br><span class="line">2853</span><br><span class="line">2854</span><br><span class="line">2855</span><br><span class="line">2856</span><br><span class="line">2857</span><br><span class="line">2858</span><br><span class="line">2859</span><br><span class="line">2860</span><br><span class="line">2861</span><br><span class="line">2862</span><br><span class="line">2863</span><br><span class="line">2864</span><br><span class="line">2865</span><br><span class="line">2866</span><br><span class="line">2867</span><br><span class="line">2868</span><br><span class="line">2869</span><br><span class="line">2870</span><br><span class="line">2871</span><br><span class="line">2872</span><br><span class="line">2873</span><br><span class="line">2874</span><br><span class="line">2875</span><br><span class="line">2876</span><br><span class="line">2877</span><br><span class="line">2878</span><br><span class="line">2879</span><br><span class="line">2880</span><br><span class="line">2881</span><br><span class="line">2882</span><br><span class="line">2883</span><br><span class="line">2884</span><br><span class="line">2885</span><br><span class="line">2886</span><br><span class="line">2887</span><br><span class="line">2888</span><br><span class="line">2889</span><br><span class="line">2890</span><br><span class="line">2891</span><br><span class="line">2892</span><br><span class="line">2893</span><br><span class="line">2894</span><br><span class="line">2895</span><br><span class="line">2896</span><br><span class="line">2897</span><br><span class="line">2898</span><br><span class="line">2899</span><br><span class="line">2900</span><br><span class="line">2901</span><br><span class="line">2902</span><br><span class="line">2903</span><br><span class="line">2904</span><br><span class="line">2905</span><br><span class="line">2906</span><br><span class="line">2907</span><br><span class="line">2908</span><br><span class="line">2909</span><br><span class="line">2910</span><br><span class="line">2911</span><br><span class="line">2912</span><br><span class="line">2913</span><br><span class="line">2914</span><br><span class="line">2915</span><br><span class="line">2916</span><br><span class="line">2917</span><br><span class="line">2918</span><br><span class="line">2919</span><br><span class="line">2920</span><br><span class="line">2921</span><br><span class="line">2922</span><br><span class="line">2923</span><br><span class="line">2924</span><br><span class="line">2925</span><br><span class="line">2926</span><br><span class="line">2927</span><br><span class="line">2928</span><br><span class="line">2929</span><br><span class="line">2930</span><br><span class="line">2931</span><br><span class="line">2932</span><br><span class="line">2933</span><br><span class="line">2934</span><br><span class="line">2935</span><br><span class="line">2936</span><br><span class="line">2937</span><br><span class="line">2938</span><br><span class="line">2939</span><br><span class="line">2940</span><br><span class="line">2941</span><br><span class="line">2942</span><br><span class="line">2943</span><br><span class="line">2944</span><br><span class="line">2945</span><br><span class="line">2946</span><br><span class="line">2947</span><br><span class="line">2948</span><br><span class="line">2949</span><br><span class="line">2950</span><br><span class="line">2951</span><br><span class="line">2952</span><br><span class="line">2953</span><br><span class="line">2954</span><br><span class="line">2955</span><br><span class="line">2956</span><br><span class="line">2957</span><br><span class="line">2958</span><br><span class="line">2959</span><br><span class="line">2960</span><br><span class="line">2961</span><br><span class="line">2962</span><br><span class="line">2963</span><br><span class="line">2964</span><br><span class="line">2965</span><br><span class="line">2966</span><br><span class="line">2967</span><br><span class="line">2968</span><br><span class="line">2969</span><br><span class="line">2970</span><br><span class="line">2971</span><br><span class="line">2972</span><br><span class="line">2973</span><br><span class="line">2974</span><br><span class="line">2975</span><br><span class="line">2976</span><br><span class="line">2977</span><br><span class="line">2978</span><br><span class="line">2979</span><br><span class="line">2980</span><br><span class="line">2981</span><br><span class="line">2982</span><br><span class="line">2983</span><br><span class="line">2984</span><br><span class="line">2985</span><br><span class="line">2986</span><br><span class="line">2987</span><br><span class="line">2988</span><br><span class="line">2989</span><br><span class="line">2990</span><br><span class="line">2991</span><br><span class="line">2992</span><br><span class="line">2993</span><br><span class="line">2994</span><br><span class="line">2995</span><br><span class="line">2996</span><br><span class="line">2997</span><br><span class="line">2998</span><br><span class="line">2999</span><br><span class="line">3000</span><br><span class="line">3001</span><br><span class="line">3002</span><br><span class="line">3003</span><br><span class="line">3004</span><br><span class="line">3005</span><br><span class="line">3006</span><br><span class="line">3007</span><br><span class="line">3008</span><br><span class="line">3009</span><br><span class="line">3010</span><br><span class="line">3011</span><br><span class="line">3012</span><br><span class="line">3013</span><br><span class="line">3014</span><br><span class="line">3015</span><br><span class="line">3016</span><br><span class="line">3017</span><br><span class="line">3018</span><br><span class="line">3019</span><br><span class="line">3020</span><br><span class="line">3021</span><br><span class="line">3022</span><br><span class="line">3023</span><br><span class="line">3024</span><br><span class="line">3025</span><br><span class="line">3026</span><br><span class="line">3027</span><br><span class="line">3028</span><br><span class="line">3029</span><br><span class="line">3030</span><br><span class="line">3031</span><br><span class="line">3032</span><br><span class="line">3033</span><br><span class="line">3034</span><br><span class="line">3035</span><br><span class="line">3036</span><br><span class="line">3037</span><br><span class="line">3038</span><br><span class="line">3039</span><br><span class="line">3040</span><br><span class="line">3041</span><br><span class="line">3042</span><br><span class="line">3043</span><br><span class="line">3044</span><br><span class="line">3045</span><br><span class="line">3046</span><br><span class="line">3047</span><br><span class="line">3048</span><br><span class="line">3049</span><br><span class="line">3050</span><br><span class="line">3051</span><br><span class="line">3052</span><br><span class="line">3053</span><br><span class="line">3054</span><br><span class="line">3055</span><br><span class="line">3056</span><br><span class="line">3057</span><br><span class="line">3058</span><br><span class="line">3059</span><br><span class="line">3060</span><br><span class="line">3061</span><br><span class="line">3062</span><br><span class="line">3063</span><br><span class="line">3064</span><br><span class="line">3065</span><br><span class="line">3066</span><br><span class="line">3067</span><br><span class="line">3068</span><br><span class="line">3069</span><br><span class="line">3070</span><br><span class="line">3071</span><br><span class="line">3072</span><br><span class="line">3073</span><br><span class="line">3074</span><br><span class="line">3075</span><br><span class="line">3076</span><br><span class="line">3077</span><br><span class="line">3078</span><br><span class="line">3079</span><br><span class="line">3080</span><br><span class="line">3081</span><br><span class="line">3082</span><br><span class="line">3083</span><br><span class="line">3084</span><br><span class="line">3085</span><br><span class="line">3086</span><br><span class="line">3087</span><br><span class="line">3088</span><br><span class="line">3089</span><br><span class="line">3090</span><br><span class="line">3091</span><br><span class="line">3092</span><br><span class="line">3093</span><br><span class="line">3094</span><br><span class="line">3095</span><br><span class="line">3096</span><br><span class="line">3097</span><br><span class="line">3098</span><br><span class="line">3099</span><br><span class="line">3100</span><br><span class="line">3101</span><br><span class="line">3102</span><br><span class="line">3103</span><br><span class="line">3104</span><br><span class="line">3105</span><br><span class="line">3106</span><br><span class="line">3107</span><br><span class="line">3108</span><br><span class="line">3109</span><br><span class="line">3110</span><br><span class="line">3111</span><br><span class="line">3112</span><br><span class="line">3113</span><br><span class="line">3114</span><br><span class="line">3115</span><br><span class="line">3116</span><br><span class="line">3117</span><br><span class="line">3118</span><br><span class="line">3119</span><br><span class="line">3120</span><br><span class="line">3121</span><br><span class="line">3122</span><br><span class="line">3123</span><br><span class="line">3124</span><br><span class="line">3125</span><br><span class="line">3126</span><br><span class="line">3127</span><br><span class="line">3128</span><br><span class="line">3129</span><br><span class="line">3130</span><br><span class="line">3131</span><br><span class="line">3132</span><br><span class="line">3133</span><br><span class="line">3134</span><br><span class="line">3135</span><br><span class="line">3136</span><br><span class="line">3137</span><br><span class="line">3138</span><br><span class="line">3139</span><br><span class="line">3140</span><br><span class="line">3141</span><br><span class="line">3142</span><br><span class="line">3143</span><br><span class="line">3144</span><br><span class="line">3145</span><br><span class="line">3146</span><br><span class="line">3147</span><br><span class="line">3148</span><br><span class="line">3149</span><br><span class="line">3150</span><br><span class="line">3151</span><br><span class="line">3152</span><br><span class="line">3153</span><br><span class="line">3154</span><br><span class="line">3155</span><br><span class="line">3156</span><br><span class="line">3157</span><br><span class="line">3158</span><br><span class="line">3159</span><br><span class="line">3160</span><br><span class="line">3161</span><br><span class="line">3162</span><br><span class="line">3163</span><br><span class="line">3164</span><br><span class="line">3165</span><br><span class="line">3166</span><br><span class="line">3167</span><br><span class="line">3168</span><br><span class="line">3169</span><br><span class="line">3170</span><br><span class="line">3171</span><br><span class="line">3172</span><br><span class="line">3173</span><br><span class="line">3174</span><br><span class="line">3175</span><br><span class="line">3176</span><br><span class="line">3177</span><br><span class="line">3178</span><br><span class="line">3179</span><br><span class="line">3180</span><br><span class="line">3181</span><br><span class="line">3182</span><br><span class="line">3183</span><br><span class="line">3184</span><br><span class="line">3185</span><br><span class="line">3186</span><br><span class="line">3187</span><br><span class="line">3188</span><br><span class="line">3189</span><br><span class="line">3190</span><br><span class="line">3191</span><br><span class="line">3192</span><br><span class="line">3193</span><br><span class="line">3194</span><br><span class="line">3195</span><br><span class="line">3196</span><br><span class="line">3197</span><br><span class="line">3198</span><br><span class="line">3199</span><br><span class="line">3200</span><br><span class="line">3201</span><br><span class="line">3202</span><br><span class="line">3203</span><br><span class="line">3204</span><br><span class="line">3205</span><br><span class="line">3206</span><br><span class="line">3207</span><br><span class="line">3208</span><br><span class="line">3209</span><br><span class="line">3210</span><br><span class="line">3211</span><br><span class="line">3212</span><br><span class="line">3213</span><br><span class="line">3214</span><br><span class="line">3215</span><br><span class="line">3216</span><br><span class="line">3217</span><br><span class="line">3218</span><br><span class="line">3219</span><br><span class="line">3220</span><br><span class="line">3221</span><br><span class="line">3222</span><br><span class="line">3223</span><br><span class="line">3224</span><br><span class="line">3225</span><br><span class="line">3226</span><br><span class="line">3227</span><br><span class="line">3228</span><br><span class="line">3229</span><br><span class="line">3230</span><br><span class="line">3231</span><br><span class="line">3232</span><br><span class="line">3233</span><br><span class="line">3234</span><br><span class="line">3235</span><br><span class="line">3236</span><br><span class="line">3237</span><br><span class="line">3238</span><br><span class="line">3239</span><br><span class="line">3240</span><br><span class="line">3241</span><br><span class="line">3242</span><br><span class="line">3243</span><br><span class="line">3244</span><br><span class="line">3245</span><br><span class="line">3246</span><br><span class="line">3247</span><br><span class="line">3248</span><br><span class="line">3249</span><br><span class="line">3250</span><br><span class="line">3251</span><br><span class="line">3252</span><br><span class="line">3253</span><br><span class="line">3254</span><br><span class="line">3255</span><br><span class="line">3256</span><br><span class="line">3257</span><br><span class="line">3258</span><br><span class="line">3259</span><br><span class="line">3260</span><br><span class="line">3261</span><br><span class="line">3262</span><br><span class="line">3263</span><br><span class="line">3264</span><br><span class="line">3265</span><br><span class="line">3266</span><br><span class="line">3267</span><br><span class="line">3268</span><br><span class="line">3269</span><br><span class="line">3270</span><br><span class="line">3271</span><br><span class="line">3272</span><br><span class="line">3273</span><br><span class="line">3274</span><br><span class="line">3275</span><br><span class="line">3276</span><br><span class="line">3277</span><br><span class="line">3278</span><br><span class="line">3279</span><br><span class="line">3280</span><br><span class="line">3281</span><br><span class="line">3282</span><br><span class="line">3283</span><br><span class="line">3284</span><br><span class="line">3285</span><br><span class="line">3286</span><br><span class="line">3287</span><br><span class="line">3288</span><br><span class="line">3289</span><br><span class="line">3290</span><br><span class="line">3291</span><br><span class="line">3292</span><br><span class="line">3293</span><br><span class="line">3294</span><br><span class="line">3295</span><br><span class="line">3296</span><br><span class="line">3297</span><br><span class="line">3298</span><br><span class="line">3299</span><br><span class="line">3300</span><br><span class="line">3301</span><br><span class="line">3302</span><br><span class="line">3303</span><br><span class="line">3304</span><br><span class="line">3305</span><br><span class="line">3306</span><br><span class="line">3307</span><br><span class="line">3308</span><br><span class="line">3309</span><br><span class="line">3310</span><br><span class="line">3311</span><br><span class="line">3312</span><br><span class="line">3313</span><br><span class="line">3314</span><br><span class="line">3315</span><br><span class="line">3316</span><br><span class="line">3317</span><br><span class="line">3318</span><br><span class="line">3319</span><br><span class="line">3320</span><br><span class="line">3321</span><br><span class="line">3322</span><br><span class="line">3323</span><br><span class="line">3324</span><br><span class="line">3325</span><br><span class="line">3326</span><br><span class="line">3327</span><br><span class="line">3328</span><br><span class="line">3329</span><br><span class="line">3330</span><br><span class="line">3331</span><br><span class="line">3332</span><br><span class="line">3333</span><br><span class="line">3334</span><br><span class="line">3335</span><br><span class="line">3336</span><br><span class="line">3337</span><br><span class="line">3338</span><br><span class="line">3339</span><br><span class="line">3340</span><br><span class="line">3341</span><br><span class="line">3342</span><br><span class="line">3343</span><br><span class="line">3344</span><br><span class="line">3345</span><br><span class="line">3346</span><br><span class="line">3347</span><br><span class="line">3348</span><br><span class="line">3349</span><br><span class="line">3350</span><br><span class="line">3351</span><br><span class="line">3352</span><br><span class="line">3353</span><br><span class="line">3354</span><br><span class="line">3355</span><br><span class="line">3356</span><br><span class="line">3357</span><br><span class="line">3358</span><br><span class="line">3359</span><br><span class="line">3360</span><br><span class="line">3361</span><br><span class="line">3362</span><br><span class="line">3363</span><br><span class="line">3364</span><br><span class="line">3365</span><br><span class="line">3366</span><br><span class="line">3367</span><br><span class="line">3368</span><br><span class="line">3369</span><br><span class="line">3370</span><br><span class="line">3371</span><br><span class="line">3372</span><br><span class="line">3373</span><br><span class="line">3374</span><br><span class="line">3375</span><br><span class="line">3376</span><br><span class="line">3377</span><br><span class="line">3378</span><br><span class="line">3379</span><br><span class="line">3380</span><br><span class="line">3381</span><br><span class="line">3382</span><br><span class="line">3383</span><br><span class="line">3384</span><br><span class="line">3385</span><br><span class="line">3386</span><br><span class="line">3387</span><br><span class="line">3388</span><br><span class="line">3389</span><br><span class="line">3390</span><br><span class="line">3391</span><br><span class="line">3392</span><br><span class="line">3393</span><br><span class="line">3394</span><br><span class="line">3395</span><br><span class="line">3396</span><br><span class="line">3397</span><br><span class="line">3398</span><br><span class="line">3399</span><br><span class="line">3400</span><br><span class="line">3401</span><br><span class="line">3402</span><br><span class="line">3403</span><br><span class="line">3404</span><br><span class="line">3405</span><br><span class="line">3406</span><br><span class="line">3407</span><br><span class="line">3408</span><br><span class="line">3409</span><br><span class="line">3410</span><br><span class="line">3411</span><br><span class="line">3412</span><br><span class="line">3413</span><br><span class="line">3414</span><br><span class="line">3415</span><br><span class="line">3416</span><br><span class="line">3417</span><br><span class="line">3418</span><br><span class="line">3419</span><br><span class="line">3420</span><br><span class="line">3421</span><br><span class="line">3422</span><br><span class="line">3423</span><br><span class="line">3424</span><br><span class="line">3425</span><br><span class="line">3426</span><br><span class="line">3427</span><br><span class="line">3428</span><br><span class="line">3429</span><br><span class="line">3430</span><br><span class="line">3431</span><br><span class="line">3432</span><br><span class="line">3433</span><br><span class="line">3434</span><br><span class="line">3435</span><br><span class="line">3436</span><br><span class="line">3437</span><br><span class="line">3438</span><br><span class="line">3439</span><br><span class="line">3440</span><br><span class="line">3441</span><br><span class="line">3442</span><br><span class="line">3443</span><br><span class="line">3444</span><br><span class="line">3445</span><br><span class="line">3446</span><br><span class="line">3447</span><br><span class="line">3448</span><br><span class="line">3449</span><br><span class="line">3450</span><br><span class="line">3451</span><br><span class="line">3452</span><br><span class="line">3453</span><br><span class="line">3454</span><br><span class="line">3455</span><br><span class="line">3456</span><br><span class="line">3457</span><br><span class="line">3458</span><br><span class="line">3459</span><br><span class="line">3460</span><br><span class="line">3461</span><br><span class="line">3462</span><br><span class="line">3463</span><br><span class="line">3464</span><br><span class="line">3465</span><br><span class="line">3466</span><br><span class="line">3467</span><br><span class="line">3468</span><br><span class="line">3469</span><br><span class="line">3470</span><br><span class="line">3471</span><br><span class="line">3472</span><br><span class="line">3473</span><br><span class="line">3474</span><br><span class="line">3475</span><br><span class="line">3476</span><br><span class="line">3477</span><br><span class="line">3478</span><br><span class="line">3479</span><br><span class="line">3480</span><br><span class="line">3481</span><br><span class="line">3482</span><br><span class="line">3483</span><br><span class="line">3484</span><br><span class="line">3485</span><br><span class="line">3486</span><br><span class="line">3487</span><br><span class="line">3488</span><br><span class="line">3489</span><br><span class="line">3490</span><br><span class="line">3491</span><br><span class="line">3492</span><br><span class="line">3493</span><br><span class="line">3494</span><br><span class="line">3495</span><br><span class="line">3496</span><br><span class="line">3497</span><br><span class="line">3498</span><br><span class="line">3499</span><br><span class="line">3500</span><br><span class="line">3501</span><br><span class="line">3502</span><br><span class="line">3503</span><br><span class="line">3504</span><br><span class="line">3505</span><br><span class="line">3506</span><br><span class="line">3507</span><br><span class="line">3508</span><br><span class="line">3509</span><br><span class="line">3510</span><br><span class="line">3511</span><br><span class="line">3512</span><br><span class="line">3513</span><br><span class="line">3514</span><br><span class="line">3515</span><br><span class="line">3516</span><br><span class="line">3517</span><br><span class="line">3518</span><br><span class="line">3519</span><br><span class="line">3520</span><br><span class="line">3521</span><br><span class="line">3522</span><br><span class="line">3523</span><br><span class="line">3524</span><br><span class="line">3525</span><br><span class="line">3526</span><br><span class="line">3527</span><br><span class="line">3528</span><br><span class="line">3529</span><br><span class="line">3530</span><br><span class="line">3531</span><br><span class="line">3532</span><br><span class="line">3533</span><br><span class="line">3534</span><br><span class="line">3535</span><br><span class="line">3536</span><br><span class="line">3537</span><br><span class="line">3538</span><br><span class="line">3539</span><br><span class="line">3540</span><br><span class="line">3541</span><br><span class="line">3542</span><br><span class="line">3543</span><br><span class="line">3544</span><br><span class="line">3545</span><br><span class="line">3546</span><br><span class="line">3547</span><br><span class="line">3548</span><br><span class="line">3549</span><br><span class="line">3550</span><br><span class="line">3551</span><br><span class="line">3552</span><br><span class="line">3553</span><br><span class="line">3554</span><br><span class="line">3555</span><br><span class="line">3556</span><br><span class="line">3557</span><br><span class="line">3558</span><br><span class="line">3559</span><br><span class="line">3560</span><br><span class="line">3561</span><br><span class="line">3562</span><br><span class="line">3563</span><br><span class="line">3564</span><br><span class="line">3565</span><br><span class="line">3566</span><br><span class="line">3567</span><br><span class="line">3568</span><br><span class="line">3569</span><br><span class="line">3570</span><br><span class="line">3571</span><br><span class="line">3572</span><br><span class="line">3573</span><br><span class="line">3574</span><br><span class="line">3575</span><br><span class="line">3576</span><br><span class="line">3577</span><br><span class="line">3578</span><br><span class="line">3579</span><br><span class="line">3580</span><br><span class="line">3581</span><br><span class="line">3582</span><br><span class="line">3583</span><br><span class="line">3584</span><br><span class="line">3585</span><br><span class="line">3586</span><br><span class="line">3587</span><br><span class="line">3588</span><br><span class="line">3589</span><br><span class="line">3590</span><br><span class="line">3591</span><br><span class="line">3592</span><br><span class="line">3593</span><br><span class="line">3594</span><br><span class="line">3595</span><br><span class="line">3596</span><br><span class="line">3597</span><br><span class="line">3598</span><br><span class="line">3599</span><br><span class="line">3600</span><br><span class="line">3601</span><br><span class="line">3602</span><br><span class="line">3603</span><br><span class="line">3604</span><br><span class="line">3605</span><br><span class="line">3606</span><br><span class="line">3607</span><br><span class="line">3608</span><br><span class="line">3609</span><br><span class="line">3610</span><br><span class="line">3611</span><br><span class="line">3612</span><br><span class="line">3613</span><br><span class="line">3614</span><br><span class="line">3615</span><br><span class="line">3616</span><br><span class="line">3617</span><br><span class="line">3618</span><br><span class="line">3619</span><br><span class="line">3620</span><br><span class="line">3621</span><br><span class="line">3622</span><br><span class="line">3623</span><br><span class="line">3624</span><br><span class="line">3625</span><br><span class="line">3626</span><br><span class="line">3627</span><br><span class="line">3628</span><br><span class="line">3629</span><br><span class="line">3630</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;annotations&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;builtIn&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;datasource&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;grafana&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;enable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hide&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;iconColor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rgba(0, 211, 255, 1)&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Annotations &amp; Alerts&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;matchAny&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dashboard&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dashboard&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Dashboard for Spring Boot2.1 Statistics(based on Spring Boot2 Statistic by micrometer-prometheus).&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;editable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;fiscalYearStartMonth&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;gnetId&quot;</span><span class="punctuation">:</span> <span class="number">11378</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;graphTooltip&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">21</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;liveNow&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;panels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;collapsed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">54</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;panels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Basic Statistics&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;row&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;thresholds&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;N/A&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;special&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;absolute&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;steps&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;green&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">80</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">52</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;maxDataPoints&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;colorMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;graphMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;justifyMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;horizontal&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reduceOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;calcs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;lastNotNull&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;textMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;process_uptime_seconds&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;metric&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;step&quot;</span><span class="punctuation">:</span> <span class="number">14400</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Uptime&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stat&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;thresholds&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;N/A&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;special&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;absolute&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;steps&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">70</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">90</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;percent&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">58</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;maxDataPoints&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;horizontal&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reduceOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;calcs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;lastNotNull&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;showThresholdLabels&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;showThresholdMarkers&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum(jvm_memory_used_bytes&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;, area=\&quot;heap\&quot;&#125;)*100/sum(jvm_memory_max_bytes&#123;application=\&quot;$application\&quot;,instance=\&quot;$instance\&quot;, area=\&quot;heap\&quot;&#125;)&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;step&quot;</span><span class="punctuation">:</span> <span class="number">14400</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Heap Used&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gauge&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;thresholds&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;N/A&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;special&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">-1e+32</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;N/A&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;to&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;range&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;absolute&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;steps&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rgba(50, 172, 45, 0.97)&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rgba(237, 129, 40, 0.89)&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">70</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rgba(245, 54, 54, 0.9)&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">90</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;percent&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;maxDataPoints&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;horizontal&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reduceOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;calcs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;lastNotNull&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;showThresholdLabels&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;showThresholdMarkers&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum(jvm_memory_used_bytes&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;, area=\&quot;nonheap\&quot;&#125;)*100/sum(jvm_memory_max_bytes&#123;application=\&quot;$application\&quot;,instance=\&quot;$instance\&quot;, area=\&quot;nonheap\&quot;&#125;)&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;step&quot;</span><span class="punctuation">:</span> <span class="number">14400</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Non-Heap Used&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gauge&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">66</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;process_files_open_files&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Open Files&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;process_files_max_files&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Max Files&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Process Open Files&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;locale&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;thresholds&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;N/A&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;special&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;absolute&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;steps&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;green&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">80</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dateTimeAsIso&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">56</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;maxDataPoints&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;colorMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;graphMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;justifyMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;horizontal&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reduceOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;calcs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;lastNotNull&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;textMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;process_start_time_seconds&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;&#125;*1000&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;metric&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;step&quot;</span><span class="punctuation">:</span> <span class="number">14400</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Start time&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stat&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">7</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">95</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system_cpu_usage&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;System CPU Usage&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;process_cpu_usage&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Process CPU Usage&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CPU Usage&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">7</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">96</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system_load_average_1m&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Load Average [1m]&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;system_cpu_count&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CPU Core Size&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Load Average&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;collapsed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">15</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">48</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;panels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JVM Statistics - Heaps&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;row&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">16</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">85</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;repeat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;memory_pool_heap&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;repeatDirection&quot;</span><span class="punctuation">:</span> <span class="string">&quot;h&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_memory_used_bytes&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, id=\&quot;$memory_pool_heap\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Used&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_memory_committed_bytes&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, id=\&quot;$memory_pool_heap\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Commited&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_memory_max_bytes&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, id=\&quot;$memory_pool_heap\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Max&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$memory_pool_heap (heap)&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bytes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">9</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">25</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">88</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;repeat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;memory_pool_nonheap&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;repeatDirection&quot;</span><span class="punctuation">:</span> <span class="string">&quot;h&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_memory_used_bytes&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, id=\&quot;$memory_pool_nonheap\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Used&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_memory_committed_bytes&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, id=\&quot;$memory_pool_nonheap\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Commited&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_memory_max_bytes&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, id=\&quot;$memory_pool_nonheap\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Max&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$memory_pool_nonheap (non-heap)&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bytes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;collapsed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">43</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">117</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;panels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JVM Statistics Threads/Buffers&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;row&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">44</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">68</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_threads_daemon_threads&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Daemon&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_threads_live_threads&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Live&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_threads_peak_threads&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Peak&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Threads&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">44</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">78</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;irate(jvm_gc_memory_allocated_bytes_total&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;[5m])&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;allocated&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;irate(jvm_gc_memory_promoted_bytes_total&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;[5m])&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;promoted&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Memory Allocate/Promote&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bytes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;decimals&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">54</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_classes_loaded_classes&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Classes Loaded&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Classes Loaded&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;decimals&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;locale&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">54</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;irate(jvm_classes_unloaded_classes_total&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;[5m])&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Classes Unloaded&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Classes Unloaded&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">61</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">82</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_buffer_memory_used_bytes&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, id=\&quot;direct\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Used Bytes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_buffer_total_capacity_bytes&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, id=\&quot;direct\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Capacity Bytes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Direct Buffers&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">61</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">83</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_buffer_memory_used_bytes&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, id=\&quot;mapped\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Used Bytes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jvm_buffer_total_capacity_bytes&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, id=\&quot;mapped\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Capacity Bytes&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mapped Buffers&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;collapsed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">68</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">72</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;panels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JVM Statistics - GC&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;row&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">69</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">74</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hideEmpty&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hideZero&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;irate(jvm_gc_pause_seconds_count&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;[5m])&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;action&#125;&#125; [&#123;&#123;cause&#125;&#125;]&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GC Count&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;locale&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">69</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">76</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hideEmpty&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hideZero&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;irate(jvm_gc_pause_seconds_sum&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;[5m])&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;action&#125;&#125; [&#123;&#123;cause&#125;&#125;]&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GC Stop the World Duration&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;collapsed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">77</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">34</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;panels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HikariCP Statistics&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;row&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;thresholds&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;N/A&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;special&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;absolute&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;steps&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;green&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">80</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">78</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">44</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;maxDataPoints&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;colorMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;graphMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;justifyMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;horizontal&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reduceOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;calcs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;lastNotNull&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;textMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hikaricp_connections&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, pool=\&quot;$hikaricp\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Connections Size&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stat&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">78</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">36</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hideEmpty&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hideZero&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hikaricp_connections_active&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, pool=\&quot;$hikaricp\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Active&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hikaricp_connections_idle&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, pool=\&quot;$hikaricp\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Idle&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hikaricp_connections_pending&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, pool=\&quot;$hikaricp\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Pending&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Connections&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;thresholds&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;N/A&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;special&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;absolute&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;steps&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;green&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">80</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">82</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">46</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;maxDataPoints&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;colorMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;graphMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;justifyMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;horizontal&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reduceOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;calcs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;lastNotNull&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;textMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hikaricp_connections_timeout_total&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, pool=\&quot;$hikaricp\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Connection Timeout Count&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stat&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">86</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">38</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hikaricp_connections_creation_seconds_sum&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, pool=\&quot;$hikaricp\&quot;&#125; / hikaricp_connections_creation_seconds_count&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, pool=\&quot;$hikaricp\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Creation Time&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Connection Creation Time&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">86</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">42</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hikaricp_connections_usage_seconds_sum&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, pool=\&quot;$hikaricp\&quot;&#125; / hikaricp_connections_usage_seconds_count&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, pool=\&quot;$hikaricp\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Usage Time&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Connection Usage Time&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">86</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hikaricp_connections_acquire_seconds_sum&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, pool=\&quot;$hikaricp\&quot;&#125; / hikaricp_connections_acquire_seconds_count&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, pool=\&quot;$hikaricp\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Acquire Time&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Connection Acquire Time&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;collapsed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">92</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;panels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Undertow Statistics&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;row&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;thresholds&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;N/A&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;special&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;absolute&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;steps&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;green&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">80</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;locale&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">93</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">101</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;maxDataPoints&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;colorMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;graphMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;justifyMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;horizontal&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reduceOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;calcs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;lastNotNull&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;textMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jetty_threads_config_min&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Min threads&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Thread Config Min&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stat&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;HTTP&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#890f02&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;HTTP - 5xx&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#bf1b00&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">93</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">111</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum(rate(http_server_requests_seconds_count&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;, status=~\&quot;5..\&quot;&#125;[1m]))&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5xx - Server Errors&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum(rate(http_server_requests_seconds_count&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;, status=~\&quot;4..\&quot;&#125;[1m]))&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4xx - Client Errors&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum(rate(http_server_requests_seconds_count&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;, status=~\&quot;2..\&quot;&#125;[1m]))&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2xx - Success&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum(rate(http_server_requests_seconds_count&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;, status=~\&quot;3..\&quot;&#125;[1m]))&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3xx - Redirections&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HTTP Codes&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ops&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;thresholds&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;N/A&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;special&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;absolute&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;steps&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;green&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;color&quot;</span><span class="punctuation">:</span> <span class="string">&quot;red&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">80</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;unit&quot;</span><span class="punctuation">:</span> <span class="string">&quot;locale&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">97</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">32</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;maxDataPoints&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;colorMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;graphMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;justifyMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;orientation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;horizontal&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reduceOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;calcs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;lastNotNull&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;textMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;auto&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jetty_threads_config_max&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Max threads&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Thread Config Max&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stat&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">101</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">107</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum(rate(http_server_requests_seconds_count&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;&#125;[1m]))&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;instant&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Requests per second&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Requests/second&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">101</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">108</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum(rate(http_server_requests_seconds_sum&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;, status!~\&quot;5..\&quot;&#125;[1m]))/sum(rate(http_server_requests_seconds_count&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;, status!~\&quot;5..\&quot;&#125;[1m]))&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;instant&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Average&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;max(http_server_requests_seconds_max&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;, status!~\&quot;5..\&quot;&#125;)&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;instant&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Maximum&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Requests duration&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">108</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">109</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;topk(10, sum by(uri, method) (rate(http_server_requests_seconds_count&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;&#125;[1m])))&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;uri&#125;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TOP 10&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">108</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jetty_threads_current&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Current thread&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jetty_threads_busy&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Busy thread&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;B&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jetty_threads_idle&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Idle threads&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jetty_threads_jobs&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Jobs  threads&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Threads&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;collapsed&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">122</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;panels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Log4j2 Statistics&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;row&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">123</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;irate(log4j2_events_total&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, level=\&quot;info\&quot;&#125;[5m])&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;info&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;rawSql&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;INFO logs&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">123</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;irate(log4j2_events_total&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, level=\&quot;error\&quot;&#125;[5m])&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;error&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;rawSql&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ERROR logs&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">130</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;irate(log4j2_events_total&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, level=\&quot;warn\&quot;&#125;[5m])&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;rawSql&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;WARN logs&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">130</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;irate(log4j2_events_total&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, level=\&quot;debug\&quot;&#125;[5m])&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;rawSql&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DEBUG logs&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;aliasColors&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;bars&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dashes&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fieldConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;defaults&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;overrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fill&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fillGradient&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;gridPos&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;h&quot;</span><span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;w&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;x&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;y&quot;</span><span class="punctuation">:</span> <span class="number">130</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;hiddenSeries&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;legend&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alignAsTable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;avg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;lines&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;linewidth&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;links&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;nullPointMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;null&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alertThreshold&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;percentage&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pluginVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;pointradius&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;points&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;renderer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;flot&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;seriesOverrides&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;spaceLength&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;steppedLine&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;irate(log4j2_events_total&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;, level=\&quot;trace\&quot;&#125;[5m])&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time_series&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;intervalFactor&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trace&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;rawSql&quot;</span><span class="punctuation">:</span> <span class="string">&quot;SELECT\n  $__time(time_column),\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;A&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;thresholds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeRegions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TRACE logs&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tooltip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;shared&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;individual&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;xaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;time&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;short&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;logBase&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;show&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;yaxis&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;align&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;refresh&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;schemaVersion&quot;</span><span class="punctuation">:</span> <span class="number">36</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dark&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;tags&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;Java&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;templating&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;list&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blue&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;definition&quot;</span><span class="punctuation">:</span> <span class="string">&quot;label_values(namespace)&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hide&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;includeAll&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Namespace&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;multi&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;namespace&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;label_values(namespace)&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;StandardVariableQuery&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;refresh&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;regex&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/.*[^[default,tools]]*/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipUrlSync&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;puyiwm-gateway&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;puyiwm-gateway&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;definition&quot;</span><span class="punctuation">:</span> <span class="string">&quot;label_values(jvm_memory_used_bytes&#123;namespace=\&quot;$namespace\&quot;&#125;, application)&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hide&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;includeAll&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Application&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;multi&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;label_values(jvm_memory_used_bytes&#123;namespace=\&quot;$namespace\&quot;&#125;, application)&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;StandardVariableQuery&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;refresh&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;regex&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipUrlSync&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tagValuesQuery&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tagsQuery&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;useTags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.28.80.248:9080&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.28.80.248:9080&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;definition&quot;</span><span class="punctuation">:</span> <span class="string">&quot;label_values(jvm_memory_used_bytes&#123;application=\&quot;$application\&quot;,namespace=\&quot;$namespace\&quot;&#125;, instance)&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hide&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;includeAll&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Instance&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;multi&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;instance&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;label_values(jvm_memory_used_bytes&#123;application=\&quot;$application\&quot;,namespace=\&quot;$namespace\&quot;&#125;, instance)&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;StandardVariableQuery&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;refresh&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;regex&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipUrlSync&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tagValuesQuery&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tagsQuery&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;useTags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;isNone&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;None&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;definition&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hide&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;includeAll&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HikariCP-Pool&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;multi&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hikaricp&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;label_values(hikaricp_connections&#123;instance=\&quot;$instance\&quot;, application=\&quot;$application\&quot;&#125;, pool)&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Prometheus-hikaricp-Variable-Query&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;refresh&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;regex&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipUrlSync&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tagValuesQuery&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tagsQuery&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;useTags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;All&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$__all&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;definition&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hide&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;includeAll&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Memory Pool (heap)&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;multi&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;memory_pool_heap&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;label_values(jvm_memory_used_bytes&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;, area=\&quot;heap\&quot;&#125;,id)&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Prometheus-memory_pool_heap-Variable-Query&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;refresh&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;regex&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipUrlSync&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tagValuesQuery&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tagsQuery&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;useTags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;current&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;selected&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;All&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$__all&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;datasource&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uDc5hjgVk&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;definition&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;hide&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;includeAll&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Memory Pool (nonheap)&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;multi&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;memory_pool_nonheap&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;label_values(jvm_memory_used_bytes&#123;application=\&quot;$application\&quot;, instance=\&quot;$instance\&quot;, area=\&quot;nonheap\&quot;&#125;,id)&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;refId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Prometheus-memory_pool_nonheap-Variable-Query&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;refresh&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;regex&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;skipUrlSync&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tagValuesQuery&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tagsQuery&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;query&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;useTags&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="string">&quot;now-1h&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;to&quot;</span><span class="punctuation">:</span> <span class="string">&quot;now&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timepicker&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;refresh_intervals&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;5s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;10s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;1m&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;5m&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;15m&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;30m&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;1h&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;2h&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;1d&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;time_options&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;5m&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;15m&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;1h&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;6h&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;12h&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;24h&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;2d&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;7d&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;30d&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timezone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Spring Boot&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;spring_boot_21&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">26</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;weekStart&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>保存 Dashboard，查看效果。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/grafana/grafana-spring-boot-actuator-modified.png" alt=""></p><h1>总结</h1><p>支持动态获取 Pod 的监控数据，并优化了官方的 Dashboard，支持区分运行环境和服务名，提高线上排查效率。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 可观测性 </tag>
            
            <tag> 项目集成 </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CODING 云原生应用交付实践</title>
      <link href="/2023/08/10/devops/CODING%20%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E5%AE%9E%E8%B7%B5/"/>
      <url>/2023/08/10/devops/CODING%20%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>我们引入了腾讯云 CODING 作为新项目的构建方式，践行了 DevOps 研发运营一体化的理念。</p><p>在使用的过程中，我们也发现持续集成这块功能，不能满足我们一些场景。</p><ol><li>可视化编排只支持镜像更新，不支持镜像部署，需要手动写 <code>kubectl apply</code> 实现，对于研发人员来说，不够傻瓜化。</li><li>部署人员对 Kubernetes 云原生环境不熟悉，例如 Deployment、Service、ConfigMap 等资源。</li><li>在生产发布场景，不支持批量发布，没有完善的生产发布流程，缺乏上线留痕和回滚机制。</li></ol><p>上述的问题其实就是 OAM 要解决的目标。</p><p>OAM（Open Application Model）是阿里巴巴和微软共同开源的云原生应用规范模型，构建于 GitOps 基础上。对于 OAM 来说，基础设施即代码，一些代码都可以基于 Git 版本控制。稍微用过 Kubernetes 的伙伴可以知道，Kubernetes 的资源变更基本都是 <code>kubectl apply YAML 文件</code> 调用 API 实现。OAM 的本质就是把 YAML 文件放到 Git 管理，并根据研发团队和运维团队的视角，将 YAML 内容拆分维护，在构建阶段，将各文件解析，合并为 Kubernetes 能理解的内容，实现资源变更。腾讯云基于 OAM 模型实现了 Orbit 工具，可以快速实现云原生应用交付。</p><p>在笔者的公司，研发团队提出了他们的诉求，他们希望的是应用级别的编排，最小调度单位是 App，也就是说，一个应用下有多个服务，不关心 K8s 的 Deployment 如何部署，Service 如何绑定，ConfigMap 如何挂载…而运维团队表示，他们可以负责维护 K8s 模板，但不想参与业务。</p><p>笔者根据现状，将研发团队和运维团队的职责细分如下。</p><ul><li>开发人员（普通）：编写代码、上传 API、发布 Tag</li><li>开发人员（部署）：服务创建和编排，版本发布，上线操作</li><li>运维人员：设计 K8s 模板和运维插件</li></ul><p>协作流程如下，图中的开发人员一般是有部署权限的研发。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-workflow.png" alt=""></p><h1>目标</h1><p>使用 CODING 自研的 Orbit 工具实现生产环境的部署。</p><h1>实战</h1><h2 id="运维人员准备环境">运维人员准备环境</h2><p>运维人员（K8s 专家）创建服务模板和运维插件。</p><p>首先，添加 K8s 集群。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-add-kubernetes-cluster.png" alt=""></p><p>进入 <code>团队设置中心</code> &gt; <code>功能设置</code> &gt; <code>服务模板</code>，创建 <code>Deployment</code>、<code>StatefuleSet</code>、<code>Job</code>、<code>DaemonSet</code> 等工作负载的模板。下图，笔者创建了一个 Deployment 模板。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-edit-component-template-detail.png" alt=""></p><p>对应的 <code>工作负载</code> 代码片段如下，包含了图中 <code>自定义变量</code> 的文本内容。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123;<span class="string">.name</span>&#125;&#125;</span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">reloader.stakater.com/auto:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> &#123;&#123;<span class="string">.name</span>&#125;&#125;</span><br><span class="line">    <span class="attr">qcloud-app:</span> &#123;&#123;<span class="string">.name</span>&#125;&#125;</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.replicas</span> &#125;&#125;</span><br><span class="line">  <span class="attr">replicas:</span> &#123;&#123; <span class="string">.replicas</span> &#125;&#125;</span><br><span class="line">  &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> &#123;&#123;<span class="string">.name</span>&#125;&#125;</span><br><span class="line">      <span class="attr">qcloud-app:</span> &#123;&#123;<span class="string">.name</span>&#125;&#125;</span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">eks.tke.cloud.tencent.com/cpu-type:</span> <span class="string">intel</span></span><br><span class="line">        <span class="attr">eks.tke.cloud.tencent.com/root-cbs-size:</span> <span class="string">&quot;20&quot;</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.isolated</span> &#125;&#125;</span><br><span class="line">        <span class="attr">eks.tke.cloud.tencent.com/security-group-id:</span> &#123;&#123; <span class="string">.isolated.securityGroupId</span> &#125;&#125;</span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">else</span> &#125;&#125;</span><br><span class="line">        <span class="attr">eks.tke.cloud.tencent.com/security-group-id:</span> <span class="string">&quot;sg-233333&quot;</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> &#123;&#123;<span class="string">.name</span>&#125;&#125;</span><br><span class="line">        <span class="attr">qcloud-app:</span> &#123;&#123;<span class="string">.name</span>&#125;&#125;</span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LANG</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">C.UTF-8</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">SPRING_PROFILES_ACTIVE</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">java</span></span><br><span class="line">              <span class="attr">optional:</span> <span class="literal">false</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">java</span></span><br><span class="line">              <span class="attr">optional:</span> <span class="literal">false</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.jvm</span>&#125;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMS</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123; <span class="string">default</span> <span class="number">1536</span> <span class="string">.jvm.xms</span>&#125;&#125;<span class="string">m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XMX</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123; <span class="string">default</span> <span class="number">1536</span> <span class="string">.jvm.xmx</span>&#125;&#125;<span class="string">m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XSS</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123; <span class="string">default</span> <span class="number">256</span> <span class="string">.jvm.xss</span>&#125;&#125;<span class="string">k</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GC_MODE</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123; <span class="string">default</span> <span class="string">&quot;G1&quot;</span> <span class="string">.jvm.gcmode</span> <span class="string">|</span> <span class="string">quote</span>&#125;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USE_GC_LOG</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123; <span class="string">default</span> <span class="string">&quot;Y&quot;</span> <span class="string">.jvm.gcmode</span> <span class="string">|</span> <span class="string">quote</span>&#125;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USE_HEAP_DUMP</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123; <span class="string">default</span> <span class="string">&quot;Y&quot;</span> <span class="string">.jvm.gcmode</span> <span class="string">|</span> <span class="string">quote</span>&#125;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USE_LARGE_PAGES</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123; <span class="string">default</span> <span class="string">&quot;N&quot;</span> <span class="string">.jvm.gcmode</span> <span class="string">|</span> <span class="string">quote</span>&#125;&#125;</span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">end</span>&#125;&#125;</span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.containeredJvm</span>&#125;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_INIT_RAM_PERC</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123; <span class="string">default</span> <span class="string">&quot;70.0&quot;</span> <span class="string">.containeredJvm.initialRAMPercentage</span> <span class="string">|</span> <span class="string">quote</span>&#125;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_MIN_RAM_PERC</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123; <span class="string">default</span> <span class="string">&quot;70.0&quot;</span> <span class="string">.containeredJvm.minRAMPercentage</span> <span class="string">|</span> <span class="string">quote</span>&#125;&#125;</span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_MAX_RAM_PERC</span></span><br><span class="line">          <span class="attr">value:</span> &#123;&#123; <span class="string">default</span> <span class="string">&quot;70.0&quot;</span> <span class="string">.containeredJvm.maxRAMPercentage</span> <span class="string">|</span> <span class="string">quote</span>&#125;&#125;</span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">end</span>&#125;&#125;</span><br><span class="line">        <span class="attr">name:</span> &#123;&#123;<span class="string">.name</span>&#125;&#125;</span><br><span class="line">        <span class="attr">image:</span> &#123;&#123; <span class="string">.image</span>&#125;&#125;</span><br><span class="line">        <span class="attr">imagePullPolicy:</span> &#123;&#123; <span class="string">.imagePullPolicy</span> <span class="string">|</span> <span class="string">default</span> <span class="string">&quot;IfNotPresent&quot;</span>&#125;&#125;</span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> &#123;&#123;<span class="string">.port</span>&#125;&#125;</span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure><p>对应的 <code>服务发现</code> 代码片段如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123;<span class="string">.name</span>&#125;&#125;</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> &#123;&#123;<span class="string">.name</span>&#125;&#125;</span><br><span class="line">    <span class="attr">qcloud-app:</span> &#123;&#123;<span class="string">.name</span>&#125;&#125;</span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> &#123;&#123;<span class="string">.port</span>&#125;&#125;</span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> &#123;&#123;<span class="string">.port</span>&#125;&#125;</span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-edit-component-template.png" alt=""></p><p>进入 <code>团队设置中心</code> &gt; <code>功能设置</code> &gt; <code>运维插件</code>，创建 <code>ConfigMap</code>、<code>Secret</code>、<code>Probe</code> 等运维插件。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-edit-trait-template.png" alt=""></p><h2 id="部署人员编排应用">部署人员编排应用</h2><p>部署人员负责创建应用、环境、服务和配置。</p><p>在 <code>应用中心</code> 创建您的应用。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-create-app.png" alt=""></p><p>添加环境。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-create-env.png" alt=""></p><p>添加服务，根据需要选择运维插件，并进行编排。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-compose-component.png" alt=""></p><p>添加配置，便于多个服务共享，这里特指 <code>ConfigMap</code> 和 <code>Secret</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-create-shared-config.png" alt=""></p><h2 id="研发人员持续集成">研发人员持续集成</h2><p>一般的开发人员不参与 OAM 发布，只负责代码的提交和发布。</p><p>开发人员通过 <code>maven-release-plugin</code> 插件发布 Tag 后，自动触发 CODING 的构建计划，发布到 Docker 制品，此时部署人员可以在服务管理选择对应的版本。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-change-image-version.png" alt=""></p><h2 id="部署人员发布生产">部署人员发布生产</h2><p>部署人员可以在 <code>服务管理</code> 修改镜像的版本、Pod 副本数、配置文件等，然后点击发布到生产环境。服务配置变更后，点击 <code>创建版本</code>，选择需要更新的镜像。如果配置有变更，也会在表单出现变更内容，方便您核对。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-create-app-version.png" alt=""></p><p>版本创建完成后，点击发布，指定需要发布的流程（每个部署流程对于一套运行环境）</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-publish-app-version.png" alt=""></p><p>等待部署，当所有就绪探针检测完成后，部署完成。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-wait-app-deploy.png" alt=""></p><p>如果部署过程中遇到问题，您可以在右上角点击取消操作，当前的一切变更全部回滚。</p><p>部署执行完毕后，我们配置了钉钉通知，部署成功的提示如下。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-deploy-app-success-notice.png" alt=""></p><p>如果部署过程中点击了取消操作，或者部署超时，则提示部署失败。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-deploy-app-failed-notice.png" alt=""></p><p>顺利的话，在 Orbit 应用管理可以看到，版本已成功发布。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-app-overview.png" alt=""></p><p>查看 CODING 的发布操作记录。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-app-publish-log.png" alt=""></p><h1>总结</h1><p>CODING 整体使用感觉不错，可以满足我们的业务需求，但是 CODING 的发布功能还不太完善，需要后续优化。</p><p>配置管理不支持在界面添加 Secret，建议在代码仓库新建文件，里面的内容通过 base64 编码保存。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-edit-oam-code-usebase64.png" alt=""></p><p>配置管理不支持删除 ConfigMap，这个是 CODING 的 Bug，目前只能在代码仓库删除。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-delete-configmap-from-code-repo.png" alt=""></p><p>如果在部署流程选择了失败回滚，发布过程中点击了取消操作，建议等待一段时间，再次发布新版本。否则，有可能上一次版本在回滚，你发布的新版本会被回滚掉。如果在发布应用提示 <code>Invalid value: &quot;&quot;: may not be specified when value is not empty</code>，这个建议从腾讯云控制台删除 YAML，再次发布。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-reserve-if-deploy-failed.png" alt=""></p><p>由于 CODING 目前没有支持存储配置，我们这边通过运维插件实现 ConfigMap 和 NFS 挂载，在应用管理，目前不支持重复引用相同的运维插件，否则会有问题。因此，我们有些插件通过数字区分。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-orbit-trait-mutil-nfs-bug.png" alt=""></p><p>希望 CODING 越做越好吧。</p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CODING </tag>
            
            <tag> CI/CD </tag>
            
            <tag> GitOps </tag>
            
            <tag> OAM </tag>
            
            <tag> 云原生应用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务器高可用恢复演练报告</title>
      <link href="/2023/06/26/ha/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%AB%98%E5%8F%AF%E7%94%A8%E6%81%A2%E5%A4%8D%E6%BC%94%E7%BB%83%E6%8A%A5%E5%91%8A/"/>
      <url>/2023/06/26/ha/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%AB%98%E5%8F%AF%E7%94%A8%E6%81%A2%E5%A4%8D%E6%BC%94%E7%BB%83%E6%8A%A5%E5%91%8A/</url>
      
        <content type="html"><![CDATA[<h1>概述</h1><h2 id="背景介绍">背景介绍</h2><p>根据《服务器高可用恢复演练方案》文档介绍，验证基于 CLB 负载均衡下部署多台 CVM 的高可用。</p><h2 id="目标要求">目标要求</h2><p>通过混沌演练故障注入，验证 A 系统的 RPO 不超过 4 小时，RTO 不超过 12 小时。</p><h2 id="实施人员">实施人员</h2><p>*　演练实施组：小D<br>*　业务验证组：小E、小F</p><h2 id="测试对象">测试对象</h2><p>A 系统的 prd1 生产环境</p><h2 id="操作时间">操作时间</h2><p>2023-06-25 15:00 ~ 18:00</p><h1>记录</h1><h2 id="Linux内核故障恢复演练">Linux内核故障恢复演练</h2><h3 id="故障模拟">故障模拟</h3><p>在 prd1 服务器节点注入Linux内核故障。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-kernel-crash.png" alt=""></p><p>控制台显示 “执行中”。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-kernel-crash-log.png" alt=""></p><p>等待执行完成后，我们连接这台服务器的 ssh 会话自动退出，说明故障注入已生效。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-kernel-crash-ssh-exit.png" alt=""></p><h3 id="过程记录">过程记录</h3><p>Linux 内核故障注入总共持续了 30 分钟，表现如下：<br>持续访问生产环境，出现短暂几秒的接口报错。在 CLB 探测 prd1 环境端口异常之后，访问生产环境的接口不再出现报错。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-kernel-crash-clb-check.png" alt=""></p><p>短信收到系统告警，提示 prd1 服务器异常。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-kernel-crash-alert-sms.png" alt=""></p><p>关闭故障注入，重启 prd1 服务器后，ssh 登录 prd1 服务器成功，但发现应用进程已经停止，没有再次启动，需要手动重启。</p><h3 id="结果验证">结果验证</h3><ol><li>首次故障注入后，业务接口出现短暂的报错，CLB 在几秒内检测到目标 CVM 不可用，业务请求随后恢复正常，符合预期。</li><li>系统自动告警，恢复服务器，因内核故障导致应用进程无法启动，手动执行脚本启动进程，切回 CLB，业务请求正常，符合预期。</li></ol><h3 id="现场还原">现场还原</h3><p>控制台执行 Linux 内核故障注入结束后，重启服务器即可。</p><h2 id="CPU利用率100-恢复演练">CPU利用率100%恢复演练</h2><h3 id="故障模拟-2">故障模拟</h3><p>在 prd1 服务器节点注入CPU压力测试。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-cpu-100-stress.png" alt=""></p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-cpu-100-stressing.png" alt=""></p><p>使用 ssh 登录服务器执行 <code>Top</code> 命令，查看产生了 4 个 <code>stress-ng-cpu</code> 进程（服务器的 CPU 规格为 4 核），CPU 的负载分别达到 <code>5.90</code> <code>5.47</code> <code>3.28</code>，说明故障注入已生效。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-cpu-100-stress-top.png" alt=""></p><h3 id="过程记录-2">过程记录</h3><p>CPU 故障注入总共持续了 10 分钟，系统仍然可以正常访问，原因是服务器只部署了 Nginx 进程，后端服务不在节点，而是部署在 K8s 集群。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-cpu-100-stress-finished.png" alt=""></p><h3 id="结果验证-2">结果验证</h3><p>CPU 高负载对服务器 Nginx 进程的影响较低。</p><h3 id="现场还原-2">现场还原</h3><p>使用 HTTP 发起 GET 查询请求，不会产生测试数据，不需要还原。<br>控制台执行完成后，<code>stress-ng-cpu</code> 驻留进程自动被清除，不会影响正常的应用访问。</p><h2 id="内存利用率100-恢复演练">内存利用率100%恢复演练</h2><h3 id="故障模拟-3">故障模拟</h3><p>在 prd1 服务器节点注入内存压力测试。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-memory-100-stress.png" alt=""></p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-memory-100-stressing.png" alt=""></p><p>使用 ssh 登录服务器执行 <code>Top</code> 命令，查看产生了 1 个 <code>stress-ng-vm</code> 进程（服务器的内存规格为 8 GB），内存持续增长，导致进程 CPU 达到 100%，说明故障注入已生效。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-memory-100-stress-top.png" alt=""></p><h3 id="过程记录-3">过程记录</h3><p>系统响应延迟，接口返回超过 10 秒，从用户的层面来看，会认为系统卡顿。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-memory-100-stress-slowapi.png" alt=""></p><h3 id="结果验证-3">结果验证</h3><p>当内存使用率达到 100%，系统响应时间会变长，CLB 心跳探测异常，将该节点从 CLB 中摘除，后续业务请求正常，符合预期。</p><h3 id="现场还原-3">现场还原</h3><p>使用 HTTP 发起 GET 查询请求，不会产生测试数据，不需要还原。<br>控制台执行完成后，<code>stress-ng-vm</code> 驻留进程自动被清除，不会影响正常的应用访问。</p><h2 id="机器重启恢复演练">机器重启恢复演练</h2><h3 id="故障模拟-4">故障模拟</h3><p>在 prd1 服务器节点注入内存压力测试。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-reboot.png" alt=""></p><h3 id="过程记录-4">过程记录</h3><p>系统重启很快，从用户感官上没有出现接口报错。因 Nginx 进程未启动，导致 CLB 无法探测到该节点，后续业务请求会失败。CLB 显示后端服务端口异常，如下图。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-reboot-check.png" alt=""></p><p>启动 Nginx 进程后，CLB 节点恢复正常。</p><h3 id="结果验证-4">结果验证</h3><p>机器节点重启后，对业务的请求影响较小，符合预期。</p><h3 id="现场还原-4">现场还原</h3><p>使用 HTTP 发起 GET 查询请求，不会产生测试数据，不需要还原。</p><h1>总结</h1><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-report.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模板示例 </tag>
            
            <tag> 混沌演练 </tag>
            
            <tag> ChaosBlade </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务器高可用恢复演练方案</title>
      <link href="/2023/06/25/ha/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%AB%98%E5%8F%AF%E7%94%A8%E6%81%A2%E5%A4%8D%E6%BC%94%E7%BB%83%E6%96%B9%E6%A1%88/"/>
      <url>/2023/06/25/ha/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%AB%98%E5%8F%AF%E7%94%A8%E6%81%A2%E5%A4%8D%E6%BC%94%E7%BB%83%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<h1>概述</h1><h2 id="演练目的">演练目的</h2><p>由于历史原因，A 系统存在部分项目使用 CVM 作为运行环境。尽管腾讯云方承诺单实例服务的可用性达到 99.975%，但遇到 Linux 内核故障、CPU 或内存的使用率过高等问题，仍然会导致系统不可用。为避免业务中断，使用腾讯云 CLB 作为负载均衡，管理和分流至少 3 台以上的 CVM 实例，实现高可用。</p><h2 id="目标要求">目标要求</h2><p>通过混沌演练故障注入，验证 A 系统当前的部署架构具备自愈能力，对业务的影响在可接受范围，满足金融行业IT系统容灾标准，灾难恢复能力达到国家标准等级 4 级以上，即 RPO 不超过 4 小时，RTO 不超过 12 小时。</p><h2 id="名词解释">名词解释</h2><table><thead><tr><th>名词</th><th>解释</th></tr></thead><tbody><tr><td>RPO</td><td>恢复点目标（Recovery Point Object，简称 RPO）。指灾难发生后，容灾系统进行数据恢复，恢复得来的数据所对应的时间点。</td></tr><tr><td>RTO</td><td>恢复时间目标（Recovery Time Object，简称 RTO）。指灾难发生后，从 IT系统宕机导致业务停顿之刻开始，到 IT 系统恢复至可以支持各部门运作，业务恢复运营之间的时间段。</td></tr><tr><td>CVM</td><td>云服务器（Cloud Virtual Machine，CVM）是腾讯云提供的可扩展的计算服务。可以避免使用传统服务器时需要预估资源用量及前期投入的问题，并在短时间内快速启动任意数量的云服务器并及时部署应用程序。具体可查阅<a href="https://cloud.tencent.com/document/product/213/495">文档</a>。</td></tr><tr><td>CLB</td><td>负载均衡（Cloud Load Balancer，CLB）提供安全快捷的流量分发服务，访问流量经由 CLB 可以自动分配到云中的多台后端服务器上，扩展系统的服务能力并消除单点故障。负载均衡支持亿级连接和千万级并发，可轻松应对大流量访问，满足业务需求。具体可查阅<a href="https://cloud.tencent.com/document/product/214">文档</a>。</td></tr><tr><td>CFG</td><td>混沌演练（Chaotic Fault Generator）提供高效便捷、安全可靠的故障演习服务，除可视化故障注入服务外，还提供行业经验模板，监控护栏等核心功能，帮助用户及时发现业务容灾隐患、验证高可用预案的有效性，从而提高系统的可用性和韧性。具体可查阅<a href="https://cloud.tencent.com/document/product/1500/97565">文档</a>。</td></tr></tbody></table><h1>方案</h1><h2 id="系统分析">系统分析</h2><p>本次演练的对象为 A 系统的生产环境，访问地址为 <a href="https://www.XXX.com">https://www.XXX.com</a>。</p><p>该系统使用负载均衡 CLB 提供公网访问入口，CLB 对上游的存活检测规则，响应超时为 2 秒，检查间隔为 5 秒，不健康阈值为 3 次，健康阈值为 3 次。当某个 CVM 实例发生故障时，超过 21 秒后判断该实例不健康，不再分发流量。</p><p>CLB 的上游绑定 5 个机器节点，各节点的规格统一为 8 核 16 GB，如下。</p><ol><li>gray 灰度环境：内网 IP 为 172.28.0.1（这个有前端依赖，不适合做故障注入）</li><li>prd1 生产环境：内网 IP 为 172.28.0.2</li><li>prd2 生产环境：内网 IP 为 172.28.0.3</li><li>prd3 生产环境：内网 IP 为 172.28.0.4</li><li>prd4 生产环境：内网 IP 为 172.28.0.5</li></ol><p>因各节点规格一致，计划使用 <strong>prd1</strong> 生产环境作为测试对象。</p><h2 id="实施时间">实施时间</h2><p>选定 2023 年 6 月 25 日（非交易日，用户访问量少）</p><h2 id="人员分工">人员分工</h2><p>由演练领导组、演练实施组、演练指挥组和业务验证组共同参与，具体人员如下。</p><table><thead><tr><th>灾备演练组</th><th>人员</th><th>岗位</th><th>职责</th></tr></thead><tbody><tr><td>演练领导组</td><td>小A</td><td>技术总监</td><td>负责容灾方案的审核和决策</td></tr><tr><td>演练指挥组</td><td>小B</td><td>云原生专家</td><td>负责制定容灾方案和发起</td></tr><tr><td>演练实施组</td><td>小C</td><td>平台工程师</td><td>负责实施应用平台的容灾恢复</td></tr><tr><td>演练实施组</td><td>小D</td><td>运维工程师</td><td>负责实施基础设施的容灾恢复</td></tr><tr><td>业务验证组</td><td>小E</td><td>研发负责人</td><td>负责业务监控和系统可靠性验证</td></tr><tr><td>业务验证组</td><td>小F</td><td>研发工程师</td><td>负责业务测试和容灾恢复前后的数据比对验证</td></tr></tbody></table><h2 id="整体流程">整体流程</h2><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-workflow.png" alt=""></p><h2 id="准备工作">准备工作</h2><p>本次演练基于腾讯云<strong>混沌演练平台</strong>完成故障注入和灾难恢复工作，在正式执行容灾演练前，需要预先创建好相关任务、动作库、监控护栏、演练计划等配置。</p><h3 id="创建演练任务">创建演练任务</h3><p>演练名称设置为 &quot;CVM 故障注入恢复演练”。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-create-task.png" alt=""></p><h3 id="配置动作库">配置动作库</h3><p>分别创建任务，依次为：Linux 内核故障、CPU 利用率100%、内存利用率100% 、主机异常重启。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-create-action.png" alt=""></p><h3 id="设置监控护栏">设置监控护栏</h3><p>防止演练过程中出现一些不可预估的影响，使用护栏策略触发告警，中断演练执行。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-create-barrier.png" alt=""></p><h3 id="保存到经验库">保存到经验库</h3><p>将已配置的流程保存起来，以便后续演练复用，经验名称为 “CVM 故障注入案例”。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-save-experience.png" alt=""></p><h3 id="新建演练计划">新建演练计划</h3><p>设置演练起止时间，并选择创建好的经验库。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-create-plan.png" alt=""></p><h3 id="演练事后总结">演练事后总结</h3><p>演练结束后，点击按钮生成演练报告。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-finished-report.png" alt=""></p><h2 id="演练内容">演练内容</h2><h3 id="Linux内核故障恢复演练">Linux内核故障恢复演练</h3><p>故障模拟：prd1 服务器节点发生内核故障</p><p>执行步骤：</p><ol><li>针对 prd1 环境执行 <code>Linux内核故障</code> 注入，从控制台面板查看故障是否注入完成。</li><li>登录 CVM 执行 <code>Top</code> 命令，查看是否产生一个 <code>chaos_burnkernel</code> 进程。</li><li>故障注入 1 分钟，不做 CLB 流量切换，观察系统和日志的表现。</li><li>再次执行故障注入 1 分钟，当收到系统告警，人工介入 CLB 流量切换，观察系统和日志的表现。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-inject-linux-kernel-error.png" alt=""></p><p>期望结果：</p><ol><li>首次故障注入，不做 CLB 切换，CLB 在 21 秒后检测到目标 CVM 不可用，业务请求随后恢复正常。</li><li>再次故障注入，系统自动告警，手动切换 CLB 到正常节点，业务请求快速恢复正常，故障恢复时长 RTO 在可接受范围内。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-execute-linux-kernel-error.png" alt=""></p><h3 id="CPU使用100-恢复演练">CPU使用100%恢复演练</h3><p>故障模拟：prd1 服务器节点的 CPU 利用率达到 100%</p><p>执行步骤：</p><ol><li>针对 prd1 环境执行 <code>CPU使用率100%</code> 注入，从控制台面板查看故障是否注入完成。</li><li>登录 CVM 执行 <code>Top</code> 命令，查看是否产生一个 <code>chaos_burnkernel</code> 进程。</li><li>故障注入 1 分钟，不做 CLB 流量切换，观察系统和日志的表现。</li><li>再次执行故障注入 1 分钟，当收到系统告警，人工介入 CLB 流量切换，观察系统和日志的表现。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-inject-linux-cpu-100.png" alt=""></p><p>期望结果：</p><ol><li>首次故障注入，不做 CLB 切换，CLB 在 21 秒后检测到目标 CVM 不可用，业务请求随后恢复正常。</li><li>再次故障注入，系统自动告警，手动切换 CLB 到正常节点，业务请求快速恢复正常，故障恢复时长 RTO 在可接受范围内。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-execute-linux-cpu-100.png" alt=""></p><h3 id="内存使用100-恢复演练">内存使用100%恢复演练</h3><p>故障模拟：prd1 服务器节点的内存利用率达到 100%</p><p>执行步骤：</p><ol><li>针对 prd1 环境执行 <code>内存使用率100%</code> 注入，从控制台面板查看故障是否注入完成。</li><li>登录 CVM 执行 <code>Top</code> 命令，查看是否产生一个 <code>chaos_burnmem</code> 进程。</li><li>故障注入 1 分钟，不做 CLB 流量切换，观察系统和日志的表现。</li><li>再次执行故障注入 1 分钟，当收到系统告警，人工介入 CLB 流量切换，观察系统和日志的表现。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-inject-linux-memory-100.png" alt=""></p><p>期望结果：</p><ol><li>首次故障注入，不做 CLB 切换，CLB 在 21 秒后检测到目标 CVM 不可用，业务请求随后恢复正常。</li><li>再次故障注入，系统自动告警，手动切换 CLB 到正常节点，业务请求快速恢复正常，故障恢复时长 RTO 在可接受范围内。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-execute-linux-memory-100.png" alt=""></p><h3 id="机器故障重启恢复演练">机器故障重启恢复演练</h3><p>故障模拟：prd1 服务器节点宕机重启</p><p>执行步骤：</p><ol><li>针对 prd1 环境执行 <code>机器故障重启</code> 注入，从控制台面板查看故障是否注入完成。</li><li>登录 CVM 执行 <code>Top</code> 命令，查看是否产生一个 <code>chaos_burnreboot</code> 进程。</li><li>故障注入 1 分钟，不做 CLB 流量切换，观察系统和日志的表现。</li><li>再次执行故障注入 1 分钟，当收到系统告警，人工介入 CLB 流量切换，观察系统和日志的表现。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-inject-linux-reboot-100.png" alt=""></p><p>期望结果：</p><ol><li>首次故障注入，不做 CLB 切换，CLB 在 21 秒后检测到目标 CVM 不可用，业务请求随后恢复正常。</li><li>再次故障注入，系统自动告警，手动切换 CLB 到正常节点，业务请求快速恢复正常，故障恢复时长 RTO 在可接受范围内。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-execute-linux-reboot-100.png" alt=""></p><h2 id="现场还原">现场还原</h2><p>在故障注入期间，会额外产生 <code>chaos_burncpu</code>、<code>chaos_burnmem</code> 等进程，在混沌演练平台执行销毁探针可能会不成功，需要人工检查这些进程是否存在，按需销毁这些驻留进程。</p><h2 id="数据核对">数据核对</h2><p>由于演练过程中并不产生数据写入，因此，无须进行数据核对。</p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模板示例 </tag>
            
            <tag> 混沌演练 </tag>
            
            <tag> ChaosBlade </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 执行 tar 命令处理大文件引发线上问题</title>
      <link href="/2023/06/15/linux/Linux%20%E6%89%A7%E8%A1%8C%20tar%20%E5%91%BD%E4%BB%A4%E5%A4%84%E7%90%86%E5%A4%A7%E6%96%87%E4%BB%B6%E5%BC%95%E5%8F%91%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/"/>
      <url>/2023/06/15/linux/Linux%20%E6%89%A7%E8%A1%8C%20tar%20%E5%91%BD%E4%BB%A4%E5%A4%84%E7%90%86%E5%A4%A7%E6%96%87%E4%BB%B6%E5%BC%95%E5%8F%91%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1>问题描述</h1><p>最近我们生产环境的几个系统出现了很诡异的现象，每天晚上 21 点之后出现短暂的报错，或者响应超时。</p><p>例如，系统 A 在 21 点弹出微信预警，提示接口访问异常。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfs-wechat-alarm.png" alt=""></p><p>系统 B 在 21 点弹出钉钉预警，提示网关探测异常。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfs-dingtalk-alarm.png" alt=""></p><p>一开始我们怀疑是数据库、代码、xxl-job 等问题，但是这些想法很快就否决了。</p><ol><li>各系统分别独立部署在腾讯云的 EKS 弹性集群，互不干扰。</li><li>各系统使用的数据库和 xxljob 都是分开的。</li><li>我们通过回退代码版本检查，也排除了这些系统近期的代码更新问题。</li></ol><h1>原因分析</h1><p>经过时间线整理，各系统发生故障的时间点基本是同时触发的，如下。</p><table><thead><tr><th>时间范围</th><th>系统A 微信预警</th><th>系统B 钉钉预警</th><th>其他系统</th></tr></thead><tbody><tr><td>2023-03-15 20:58-21:00</td><td>20:59:13 推送 499 访问异常</td><td>21:03 提示 APISIX 探测异常</td><td>…</td></tr><tr><td>2023-03-16 21:03-21:06</td><td>21:03:04 推送 499 访问异常</td><td>21:03 提示 APISIX 探测异常</td><td>…</td></tr><tr><td>2023-03-20 21:19-21:23</td><td>21:19:34 推送 499 访问异常</td><td>21:20 提示 APISIX 探测异常</td><td>…</td></tr><tr><td>2023-03-21 21:43-21:45</td><td>21:41:50 推送 499 访问异常</td><td>21:43 提示 APISIX 探测异常</td><td>…</td></tr></tbody></table><h2 id="网络故障？">网络故障？</h2><p>我们某个系统的网络链路，可以简化如下。</p><p>用户访问 -&gt; 腾讯云CLB -&gt; 腾讯云EKS容器（K8s Service）-&gt; Nginx（Pod） -&gt; 业务网关（Pod）-&gt; 业务服务集（Pod）</p><p>首先从入口检查，腾讯云负载均衡 CLB 当时的流量监控如下，以 <code>2023-03-21</code> 的监控数据为例，当时 <code>21:42</code> 的入包量为 39 个/秒。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/clb-monitoring-network-before.png" alt=""></p><p>到了 <code>21:44</code>，入包量为 9 个/秒，请求变少了。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/clb-monitoring-network-after.png" alt=""></p><p>往后一层检查 Nginx 的访问日志，得到 4434 条状态码为 499 的报错条数。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root]<span class="comment"># egrep &quot;2023-03-21T21:4[0-9]&quot; access.log | grep -w 499 | wc -1</span></span><br><span class="line">4434</span><br></pre></td></tr></table></figure><p>499 错误码表示 Nginx 的上游 upstream 服务端响应太慢了，微信（客户端）主动断开了连接，然后推送了相关预警。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfs-nginx-499.png" alt=""></p><p>我们检查了 Nginx 的上游服务，并没有发现任何报错。</p><p>不得不怀疑是不是腾讯云网络近期做了网络调整导致，我们联系了腾讯云团队协助检查。腾讯方的技术团队和我们制定了如下策略：</p><ol><li>腾讯方负责监控容器、网络问题。</li><li>我方运维团队负责收集网络不通的 Pod ，通过脚本进行 PING 操作。</li><li>我方研发团队通过 Apifox 发起大量请求，查看持续请求是否出现异常。</li></ol><p>由于运维脚本额操作的步骤太多，为了提高监控效率，笔者将运维脚本导入到 blackbox-exporter 监控，并展示到 Grafana 查看。代码片段如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">alertmanager:9093</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/etc/prometheus/rules/*.rules</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;blackbox-ping&quot;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">module:</span> [<span class="string">icmp</span>]</span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="comment"># 网络不通的机器</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;172.28.12.1&#x27;</span>,<span class="string">&#x27;172.28.12.2&#x27;</span>,<span class="string">&#x27;...&#x27;</span>]</span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter:9115</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox-tcp&#x27;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">module:</span> [<span class="string">tcp_connect</span>]</span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;172.28.12.101:2181&#x27;</span>,<span class="string">&#x27;172.28.12.102:2181&#x27;</span>,<span class="string">&#x27;...&#x27;</span>] </span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter:9115</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;blackbox-http&#x27;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">module:</span> [<span class="string">http_2xx</span>]</span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;http://172.28.20.1:9091/apisix/prometheus/metrics&#x27;</span>, <span class="string">&#x27;...&#x27;</span>]</span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter:9115</span></span><br></pre></td></tr></table></figure><p>我们主动发起的请求，并没有出现任何异常。等到了 21:30 之后，我们不再模拟请求，故障又出现了，但是，腾讯方反馈，他们的网络是正常的。我们在 Grafana 监控也证实网络是正常的。</p><h2 id="可疑后台进程？">可疑后台进程？</h2><p>排除网络问题，因为这些故障看起来是周期性的，感觉就像有一个后台进程定时执行某些工作，同时对这几个 K8s 集群造成了影响。</p><p>因为系统使用的是腾讯云 <code>EKS</code> 弹性集群，机器节点由腾讯方团队负责维护，我们让腾讯云协助检查我们使用的 K8s 集群节点，他们还是没找到原因。</p><p>我们内部做了复盘，回头看看事故的时间点，每隔一天同一时段发生一次，像是定时任务做了什么操作导致。有可能是 腾讯做了什么定时任务？我们的 xxljob？服务器上的定时任务？</p><p>好像算漏了 Linux 定时任务。经过盘点各服务器的定时脚本，发现有个 Linux 过期日志清理脚本执行卡死。这个脚本每天凌晨 4 点执行日志清理，发生问题的代码片段如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对 kafka-consumer 控制台输入的 out 文件压缩处理</span></span><br><span class="line">tar czf kafka-consumer_<span class="variable">$&#123;today&#125;</span>.tar.gz kafka-consumer.out</span><br><span class="line"><span class="comment"># 在压缩完成后通过 echo 重置内容</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;-------<span class="variable">$&#123;today&#125;</span> New Log-------&quot;</span> &gt; kafka-consumer.out</span><br></pre></td></tr></table></figure><p>日志文件通过腾讯云 <code>CFS</code> 文件系统挂载到我们的运维服务器，运维服务器运行这个清洗脚本对日志文件执行读写操作，如下图。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-hang-io-from-tar-spare.png" alt=""></p><p>腾讯云对 <code>CFS</code> 做了存储效率优化，为了提高存储资源申请的分配效率，采用稀疏文件的方式，我们写入 <code>kafka-consumer.out</code> 每天大概就 <code>5GB</code>，<code>CFS</code> 通过稀疏文件机制预占了 <code>100 GB</code>，甚至更多。</p><p>结果，脚本内的 <code>tar</code> 命令无法识别 spare 稀疏文件，按照稀疏文件给出的大小进行压缩，导致整个 CFS 的宿主机 IO 僵死。我们的系统 A、系统 B、系统 C 部分组件挂载了该 CFS 路径，产生了连锁故障。</p><p>做个实验，执行 ls 和 du 命令，如下图。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-du-ls.png" alt=""></p><p>可以看到，我们只写入了 <code>1.5M</code> 的大小，结果在稀疏文件表现为 <code>716G</code> 。这是因为 <code>ls</code> 命令查到的是文件逻辑上占用的空间，而 <code>du</code> 命令查到的是文件物理上占用的块大小。</p><p>对于腾讯来说，如果使用稀疏文件来作为虚拟硬盘文件，那么只有当虚拟机实际写入数据时，才会消耗宿主机的存储空间，有利于他们的成本控制。</p><h1>解决方案</h1><p>责任已经明确，相应的解决方案如下。</p><p>腾讯方：同一个 CFS 路径没有做到真正的物理隔离，没有告知用户，用户在使用 CFS 的个数是有限制的，当时的做法只能共用。既然 CFS 解决不了这个问题，那就和腾讯申请更多的 CFS 盘，每套系统单独挂载，做到物理隔离。</p><p>我方：日志脚本有问题，去除 tar 命令，以防误读稀疏文件，并增加日志，邮件监控，应用层尽可能避免大量的控制台日志打印。</p>]]></content>
      
      
      <categories>
          
          <category> 线上排查 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 稀疏文件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch 深度分页查询问题处理方案</title>
      <link href="/2023/05/25/elasticsearch/Elasticsearch%20%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88/"/>
      <url>/2023/05/25/elasticsearch/Elasticsearch%20%E6%B7%B1%E5%BA%A6%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>在 Elasticsearch 中，分页查询是常见的需求，尤其是在处理大量数据时。为了提高查询效率，Elasticsearch 提供了多种分页方案，适用于不同的场景。笔者根据实际的使用情况整理了相关方案。</p><h1>方案</h1><p>Elasticsearch 分页查询方式主要有如下 3 种，现给出结论。</p><table><thead><tr><th>查询方案</th><th>用法限制</th><th>适用场景</th></tr></thead><tbody><tr><td><code>from+size</code> 查询</td><td>支持随机跳转不同分页，不超过 <code>max_result_window</code> 值</td><td>小数据范围查询</td></tr><tr><td><code>search_after</code> 查询</td><td>仅支持向后翻页，可以超过 <code>max_result_window</code> 值</td><td>APP向下滑动查看新闻</td></tr><tr><td><code>scroll</code> 查询</td><td>大数据量分页查询，但数据实时性不高</td><td>批量大数据、日志导出</td></tr></tbody></table><h2 id="from-size-小数据范围查询">from+size 小数据范围查询</h2><p><code>from</code> 参数指定从结果集中的第几条数据开始返回数据，<code>size</code> 参数指定返回数据的总量。假设我们有一个索引 <code>my_index</code>，并希望查询名字为 “梦想歌” 的文档，且返回 10 条数据。可以使用如下查询：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;from&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;梦想歌&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当 <code>from+size</code> 超过 <code>max_result_window</code> 值（默认为 10000 条），返回报错。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET <span class="regexp">/my_index/</span>_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;from&quot;</span>: <span class="number">10001</span>,</span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">10</span>,</span><br><span class="line">  <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;name&quot;</span>: <span class="string">&quot;梦想歌&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>报错内容如下。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="string">&quot;error&quot;</span></span><br><span class="line">    <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;illegal argument exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Result window is too large, from + size must be less than or equal to: [10000] but was [10001]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    ...</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>结论：<code>from+size</code> 查询只适合小数据范围的查询，超过 <code>max_result_window</code> 时，无法继续分页查询。</p><h2 id="search-after-向后滚动翻页">search_after 向后滚动翻页</h2><p><code>search_after</code> 是一个基于排序字段的分页方式，适用于需要按特定顺序（例如时间戳、ID）查询大量数据。与传统的分页不同，它不使用 <code>from</code> 参数，而是基于上一页的最后一条记录的排序值进行查询。为了保证分页过程中的数据一致性，<code>search_after</code> 通常需要配合 <code>Point In Time</code>（PIT）一起使用。</p><p>在执行分页查询之前，首先需要创建一个 PIT 来固定查询时刻的数据快照，避免查询过程中数据的变化。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /my_index/_pit?keep_alive=<span class="number">1</span>m # 滚动视图保留 <span class="number">1</span> 分钟</span><br></pre></td></tr></table></figure><p>这个请求会返回一个 <code>PIT ID</code>，如下所示：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ABCDEFG...&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>假设你要按 <code>timestamp</code> 字段升序排序，并且已经获取了第一页的最后一条文档的 <code>timestamp</code> 值为 <code>1633036800000</code>，可以使用如下的 <code>search_after</code> 查询获取下一页数据：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET /_search</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pit&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ABCDEFG...&quot;</span><span class="punctuation">,</span>  <span class="comment">// 替换为实际的 PIT ID</span></span><br><span class="line">    <span class="attr">&quot;keep_alive&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1m&quot;</span> <span class="comment">// 设置 PIT 存活时间</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sort&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="string">&quot;asc&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;search_after&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="number">1633036800000</span>  <span class="comment">// 替换为上一页最后一个文档的 timestamp 值</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>在完成所有分页查询后，调用 DELETE 请求来删除 PIT，从而释放相应的资源。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DELETE /_pit</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ABCDEFG...&quot;</span>  <span class="comment">// 替换为实际的 PIT ID</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>结论：<code>search_after</code> 查询无论数据量有多大，都可以不受 <code>max_result_window</code> 限制进行分页（严谨的说法是单次查询不能超过限制）。缺点是仅支持向后分页（不能向前翻页），需要在每次分页时提供上一页的排序值，并确保排序字段的唯一性。</p><h2 id="scroll-查询">scroll 查询</h2><p><code>scroll</code> 查询用于批量获取大量数据，尤其是在需要一次性遍历整个索引或较大数据集时，它比传统的分页查询更高效。</p><p><code>scroll</code> 通过维护一个滚动上下文来支持分页的，而不是重新计算分页的位置。每次返回的结果包含一个新的 <code>scroll_id</code>，我们可以用它来继续获取下一批数据。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /my_index/_search?scroll=<span class="number">1</span>m</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;match_all&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1000</span>  <span class="comment">// 每次批量返回 1000 个文档</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>返回值示例如下，其中，<code>_scroll_id</code> 用于标识当前查询的滚动上下文。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_scroll_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAA...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">100000</span><span class="punctuation">,</span> <span class="comment">// 共有 100000 个文档需要分页获取</span></span><br><span class="line">      <span class="attr">&quot;relation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eq&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hits&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="comment">// 文档...</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>使用返回的 <code>_scroll_id</code> 来请求后续数据。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /_search/scroll</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scroll&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1m&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scroll_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAA...&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>所有数据获取完毕后，应该通过 Scroll API 来释放资源。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DELETE /_search/scroll</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scroll_id&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAA...&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>结论：<code>scroll</code> 查询适合用于批量数据导出、日志分析等场景，但是查询的过程中，返回的数据是非实时的，并且数据量较大时，需要有足够的堆内存空间来保留上下文。</p><h1>总结</h1><p>对于小数据量的分页查询，可以使用 from+size 查询。</p><p>当分页结果超过 10000 条结果时，则推荐使用 search_after 查询。</p><p>不推荐使用 scroll 查询进行深度分页，因为实时性不高，对资源要求高。</p>]]></content>
      
      
      <categories>
          
          <category> 学习总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 搜索引擎 </tag>
            
            <tag> 解决方案 </tag>
            
            <tag> Elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch 文档版本冲突处理方案</title>
      <link href="/2023/05/18/elasticsearch/Elasticsearch%20%E6%96%87%E6%A1%A3%E7%89%88%E6%9C%AC%E5%86%B2%E7%AA%81%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88/"/>
      <url>/2023/05/18/elasticsearch/Elasticsearch%20%E6%96%87%E6%A1%A3%E7%89%88%E6%9C%AC%E5%86%B2%E7%AA%81%E5%A4%84%E7%90%86%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>使用 <code>_update_by_query</code> 批量更新或者 <code>_delete_by_query</code> 批量删除，刚好有个 <code>_bulk</code> 批量写入，并且 <code>_bulk</code> 的执行更快，导致批量更新或者批量删除的版本比写入的版本要低，造成版本冲突报错。</p><h1>方案</h1><p>以下提供两种方式避免版本冲突：一是使用 <code>version=版本号&amp;version_type=external</code> 外部控制，二是 <code>if_seq_no</code> 和 <code>if_primary_term</code> 参数控制。</p><h2 id="基于-external-外部模式">基于 <code>external</code> 外部模式</h2><p>将 version 的控制权交由客户端管理。</p><p>例如，更新 <code>my_index</code> 索引。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index/_doc/<span class="number">233</span>?version=<span class="number">2</span>&amp;version_type=external</span><br></pre></td></tr></table></figure><p>当给定的 version=2，大于当前版本 version=1，执行更新或索引操作成功。</p><h2 id="使用-if-seq-no-和-if-primary-term-参数控制">使用 <code>if_seq_no</code> 和 <code>if_primary_term</code> 参数控制</h2><p>在更新索引之前先查询 <code>if_seq_no</code> 和 <code>if_primary_term</code> 这两个参数，然后传入更新指令。</p><p>例如，更新 <code>my_index</code> 索引之前先查询。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET my_index/_doc/<span class="number">233</span></span><br></pre></td></tr></table></figure><p>返回结果。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;233&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_version&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span><span class="punctuation">:</span><span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>将获取的 <code>_seq_no</code> 和 <code>_primary_term</code> 传入更新指令。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index/_doc/<span class="number">233</span>?if_seq_no=<span class="number">0</span>&amp;if_primary_term=<span class="number">1</span></span><br></pre></td></tr></table></figure><p>执行成功。</p>]]></content>
      
      
      <categories>
          
          <category> 学习总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 搜索引擎 </tag>
            
            <tag> 解决方案 </tag>
            
            <tag> Elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch 索引备份与恢复方案</title>
      <link href="/2023/05/16/elasticsearch/Elasticsearch%20%E7%B4%A2%E5%BC%95%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D%E6%96%B9%E6%A1%88/"/>
      <url>/2023/05/16/elasticsearch/Elasticsearch%20%E7%B4%A2%E5%BC%95%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>有时候需要对 Elasticsearch 集群进行备份，或者恢复到其他集群。</p><h1>方案</h1><p>以下提供两种方案：使用 Elasticsearch 自带的 SNAPSHOT 快照机制，或者利用 elasticsearch-dump 工具完成。</p><h2 id="使用快照与恢复功能">使用快照与恢复功能</h2><p>将索引数据备份到其他文件存储，恢复时先恢复快照，再恢复索引。</p><p>在 elasticsearch.yaml 配置快照存储路径。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">path.repo:</span> [<span class="string">&quot;/path/to/snapshot&quot;</span>]</span><br></pre></td></tr></table></figure><p>注册快照存储库。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /_snapshot/my_backup</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fs&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/snapshot&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>创建快照。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 全量备份</span><br><span class="line">PUT /_snapshot/my_backup/snapshot_cluster?wait_for_completion=<span class="literal"><span class="keyword">true</span></span></span><br><span class="line"></span><br><span class="line"># 按需备份</span><br><span class="line">PUT /_snapshot/my_backup/snapshot_demo_index?wait_for_completion=<span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;indices&quot;</span><span class="punctuation">:</span> <span class="string">&quot;demo_*&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ignore_unavailable&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="attr">&quot;include_global_state&quot;</span><span class="punctuation">:</span> <span class="literal">false</span>.</span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mengxiangge&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;backup before reindex&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>恢复快照。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 全量恢复</span><br><span class="line">POST /_snapshot/my_backup/snapshot_cluster/_restore</span><br><span class="line"></span><br><span class="line"># 按需恢复</span><br><span class="line">POST /_snapshot/my_backup/snapshot_demo_index/_restore</span><br></pre></td></tr></table></figure><h2 id="使用-elasticsearch-dump-工具">使用 elasticsearch-dump 工具</h2><p>elasticsearch-dump 是一个开源的命令行工具，用于将 Elasticsearch 索引数据导出为 JSON 文件，或将 JSON 文件导入 Elasticsearch 中。项目地址可以查阅<a href="https://github.com/taskrabbit/elasticsearch-dump">链接</a>。</p><p>假设源数据节点为 10.2.0.1:9200，迁移到 10.2.1.1:9200。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 迁移 Analyzer、Settings、Mapping</span></span><br><span class="line">elasticdump --input=http://10.2.0.1:9200/my_index --output=http://10.2.1.1:9200/my_index --<span class="built_in">type</span>=analyzer</span><br><span class="line">elasticdump --input=http://10.2.0.1:9200/my_index --output=http://10.2.1.1:9200/my_index --<span class="built_in">type</span>=settings</span><br><span class="line">elasticdump --input=http://10.2.0.1:9200/my_index --output=http://10.2.1.1:9200/my_index --<span class="built_in">type</span>=mapping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 迁移数据</span></span><br><span class="line">elasticdump --input=http://10.2.0.1:9200/my_index --output=http://10.2.1.1:9200/my_index --<span class="built_in">type</span>=data</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 搜索引擎 </tag>
            
            <tag> 解决方案 </tag>
            
            <tag> Elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Elasticsearch 索引零停机变更方案</title>
      <link href="/2023/05/15/elasticsearch/Elasticsearch%20%E7%B4%A2%E5%BC%95%E9%9B%B6%E5%81%9C%E6%9C%BA%E5%8F%98%E6%9B%B4%E6%96%B9%E6%A1%88/"/>
      <url>/2023/05/15/elasticsearch/Elasticsearch%20%E7%B4%A2%E5%BC%95%E9%9B%B6%E5%81%9C%E6%9C%BA%E5%8F%98%E6%9B%B4%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>在对外提供服务的线上环境中，发现 Elasticsearch 集群中核心业务涉及的索引设计不合理，需要做数据迁移，但不允许重启服务。</p><h1>方案</h1><p>使用 Alias 别名对外提供服务。</p><p>新建索引并设定好 Mapping，然后进行数据 reindex 迁移操作。</p><p>例如，设置索引 <code>my_index</code> 的 Alias 别名为 <code>my_index_alias</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;my_index_alias&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span> </span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>创建新索引 <code>my_index_v2</code>，根据需要调整 mapping 配置。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index_v2</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;aliases&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;refresh_interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;30s&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>将数据从旧索引 <code>my_index</code> 重索引到新索引 <code>my_index_v2</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index_v2&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当确认新索引已经准备就绪，并且所有数据都已经成功迁移后，更新别名 <code>my_index_alias</code> 以指向新索引 <code>my_index_v2</code>。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST _aliases</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;actions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;remove&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index_alias&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;add&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index_v2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;alias&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my_index_alias&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>在 <code>reindex</code> 迁移索引到 <code>aliases</code> 更换别名指向的期间，如果有业务往旧索引 <code>my_index</code>写入数据，可能会导致数据不一致，建议将 <code>POST _reindex</code> 和 <code>POST _aliases</code> 放在一起执行，并在低峰期执行。</p>]]></content>
      
      
      <categories>
          
          <category> 学习总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 搜索引擎 </tag>
            
            <tag> 解决方案 </tag>
            
            <tag> Elasticsearch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>探索 VictoriaLogs 优化日志存储成本</title>
      <link href="/2023/05/15/advanced/%E6%8E%A2%E7%B4%A2%20VictoriaLogs%20%E4%BC%98%E5%8C%96%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E6%88%90%E6%9C%AC/"/>
      <url>/2023/05/15/advanced/%E6%8E%A2%E7%B4%A2%20VictoriaLogs%20%E4%BC%98%E5%8C%96%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E6%88%90%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>VictoriaLogs 是属于 <a href="https://victoriametrics.com/">VictoriaMetrics</a> 的开源项目，用于日志存储和查询。相对 Elasticsearch 和 Grafana Loki，VictoriaLogs 在存储空间和内存占用的成本更低。相关介绍说明可以查阅<a href="https://docs.victoriametrics.com/VictoriaLogs">官网</a>。</p><h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>根据官网的部署文档，使用 <a href="https://artifacthub.io/packages/helm/victoriametrics/victoria-logs-single">Helm Chart</a> 部署。请注意，<code>data-nfs-client</code> 是部署 Kubernetes 集群的 NFS 存储类，您可以根据实际情况调整。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add victoriametrics https://victoriametrics.github.io/helm-charts/</span><br><span class="line">helm repo update</span><br><span class="line">helm upgrade --install victoria-logs victoriametrics/victoria-logs-single -n logging --<span class="built_in">set</span> nameOverride=victoria-logs --<span class="built_in">set</span> server.persistentVolume.enabled=<span class="literal">true</span> --<span class="built_in">set</span> server.persistentVolume.storageClassName=data-nfs-client --<span class="built_in">set</span> server.service.type=NodePort --<span class="built_in">set</span> server.service.nodePort=9428 --<span class="built_in">set</span> dashboards.enabled=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>如果提示 <code>Error: chart requires kubeVersion: &gt;=1.25.0-0 which is incompatible with Kubernetes v1.24.17</code>，表示您的 Kubernetes 版本低于 1.25.0，可以降低下 Helm 版本，在脚本追加 <code>--version 0.5.4</code> 解决。</p><p>控制台界面如下。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/victoriametrics/victoria-logs.png"></p><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><blockquote><p>TODO</p></blockquote><h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>VictoriaLogs 目前存在的问题有：</p><ol><li>提供的分词功能有限，只能做简单的搜索，无法做到类似于 ES 的各种分词。</li><li>当前版本不支持集群部署，只能通过双写的形式实现。</li><li>官方的 SDK 还不完善，只能自行编写 REST API 实现。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术前瞻 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 成本优化 </tag>
            
            <tag> 日志检索 </tag>
            
            <tag> VictoriaLogs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于 CAT 新增链路追踪和告警通知</title>
      <link href="/2023/03/03/opensource/%E5%9F%BA%E4%BA%8E%20CAT%20%E6%96%B0%E5%A2%9E%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA%E5%92%8C%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/"/>
      <url>/2023/03/03/opensource/%E5%9F%BA%E4%BA%8E%20CAT%20%E6%96%B0%E5%A2%9E%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA%E5%92%8C%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/</url>
      
        <content type="html"><![CDATA[<p>CAT 是美团点评开源的实时应用监控平台，提供了 <code>Tracsaction</code>、<code>Event</code>、<code>Problem</code>、<code>Business</code> 等丰富的指标项。</p><p>在官方的 Issue 遇到以下几个问题：</p><ol><li>能不能支持链路追踪？</li><li>如何配置告警？</li><li>能不能接入钉钉、飞书机器人推送？</li><li>为什么 CAT 部署这么麻烦？</li></ol><p>基于上面的需求，笔者 fork 了官方最新的源码进行二次开发，并打包镜像到 Docker Hub，方便大家使用。</p><ul><li>Github 地址：<a href="https://github.com/shiyindaxiaojie/cat">传送门</a></li><li>Docker Hub 地址：<a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/cat-home/tags">传送门</a></li></ul><h1 id="改造内容"><a href="#改造内容" class="headerlink" title="改造内容"></a>改造内容</h1><ul><li><p>新增<strong>链路追踪</strong>支持，您可以通过日志打印的 TraceId 查找整个请求路径的 HTTP 请求、RPC 调用、Log4j2 日志、SQL 语句和 Cache 执行耗时。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/tracing.png"></p></li><li><p>支持<strong>邮件、钉钉、微信、飞书</strong>机器人推送。不需要额外实现告警接口，直接开箱即用，您只需要在后台配置相关的 Token 即可。如下图，触发告警后，钉钉将推送相关信息，您可以点击 <code>查看告警</code> 触达异常堆栈，也可以点击 <code>告警规则</code> 设置告警阈值，避免多次干扰。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/dingtalk.png"></p></li><li><p>支持 <strong>Jira Software</strong> 自动录单。当生产故障触发告警时，自动录入 Jira Software，便于研发内部跟进问题。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/auto-create-jira-issue.png"></p></li><li><p>优化 <strong>Docker</strong> 部署，只需要提供 JVM 参数和 MySQL 配置即可完成部署，不需要额外挂载 <code>datasource.xml</code> 和 <code>client.xml</code> 等配置文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e MYSQL_URL=<span class="string">&quot;127.0.0.1&quot;</span> -e MYSQL_PORT=<span class="string">&quot;3306&quot;</span> -e MYSQL_SCHEMA=<span class="string">&quot;cat&quot;</span> -e MYSQL_USERNAME=<span class="string">&quot;数据库账号&quot;</span> -e MYSQL_PASSWD=<span class="string">&quot;数据库密码&quot;</span> -p 8080:8080 --name=cat-home -d shiyindaxiaojie/cat-home</span><br></pre></td></tr></table></figure></li></ul><h1 id="部署教程"><a href="#部署教程" class="headerlink" title="部署教程"></a>部署教程</h1><h2 id="运行环境要求"><a href="#运行环境要求" class="headerlink" title="运行环境要求"></a>运行环境要求</h2><ul><li>JDK 版本 &gt;&#x3D; 7</li><li>MySQL 5.7（亲测 8.0 会报错）</li><li>Tomcat 8.0+</li><li>Linux 内核版本 &gt;&#x3D; 2.6</li></ul><h2 id="Tomcat-部署"><a href="#Tomcat-部署" class="headerlink" title="Tomcat 部署"></a>Tomcat 部署</h2><p>从 <a href="https://github.com/shiyindaxiaojie/cat/releases/tag/v3.4.0">Github Release</a> 下载相关文件，拷贝 <code>client.xml</code> 和 <code>datasources.xml</code> 到用户目录 <code>~/.cat/appdatas/cat</code> 中，并调整数据库配置。</p><p>将 <code>cat.war</code> 部署在目标 <code>Tomcat</code> 的 <code>webapps</code> 目录下，启动 <code>Tomcat</code>，访问 <code>http://localhost:8080/cat</code> 即可。原则上请保持 <code>Tomcat</code> 的端口为 <code>8080</code>，遇到项目启动失败的情况，建议查看 <code>~/.cat/applog/</code> 目录下的日志。</p><h2 id="Docker-部署"><a href="#Docker-部署" class="headerlink" title="Docker 部署"></a>Docker 部署</h2><p>本项目已发布稳定的镜像到 <a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/cat-home/tags">Docker Hub</a>，您可以直接使用如下命令，提供 JVM 参数和 MySQL 配置，完成部署。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e MYSQL_URL=<span class="string">&quot;127.0.0.1&quot;</span> -e MYSQL_PORT=<span class="string">&quot;3306&quot;</span> -e MYSQL_SCHEMA=<span class="string">&quot;cat&quot;</span> -e MYSQL_USERNAME=<span class="string">&quot;数据库账号&quot;</span> -e MYSQL_PASSWD=<span class="string">&quot;数据库密码&quot;</span> -e JVM_XMS=<span class="string">&quot;最小堆&quot;</span> -e JVM_XMX=<span class="string">&quot;最大堆&quot;</span> -p 8080:8080 --name=cat-home -d shiyindaxiaojie/cat-home</span><br></pre></td></tr></table></figure><h2 id="Kubernetes-部署"><a href="#Kubernetes-部署" class="headerlink" title="Kubernetes 部署"></a>Kubernetes 部署</h2><p>建议使用 StatefulSet 部署，YAML 示例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cat-home</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">-Xmx1536m</span> <span class="string">-Xms1536m</span> <span class="string">-Xmn1024m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">数据库地址</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;3306&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_USERNAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">数据库账号</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">数据库密码</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SCHEMA</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">CAT</span> <span class="string">数据库名称</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVER_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">CAT</span> <span class="string">运行地址</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">2G</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMX</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">2G</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMN</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">1G</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">shiyindaxiaojie/cat-home:v3.4.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">lifecycle:</span></span><br><span class="line">          <span class="attr">preStop:</span></span><br><span class="line">            <span class="attr">exec:</span></span><br><span class="line">              <span class="attr">command:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">curl</span> <span class="string">http://localhost:8080/cat/r/home?op=checkpoint</span> <span class="string">&amp;&amp;</span> <span class="string">sleep</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cat-home</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/appdatas/cat/bucket</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">appdatas</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/applogs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">applogs</span></span><br><span class="line">      <span class="attr">volumes:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">nfs:</span> <span class="comment"># 此处省略，请根据实际情况配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">        <span class="attr">nfs:</span> <span class="comment"># 此处省略，请根据实际情况配置</span></span><br></pre></td></tr></table></figure><h2 id="生产集群部署"><a href="#生产集群部署" class="headerlink" title="生产集群部署"></a>生产集群部署</h2><p>推荐使用 Kubernetes 部署生产集群，假设部署三个节点，一个节点为监控节点，另外两个节点为消费节点，如下配置：</p><ul><li>监控节点：10.1.1.1</li><li>消费节点：10.1.1.2</li><li>消费节点：10.1.1.3</li></ul><p>请复制上面的 YAML，将 SERVER_URL 参数调整为 <code>10.1.1.1,10.1.1.2,10.1.1.3</code>。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cat-home</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVER_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">10.1</span><span class="number">.1</span><span class="number">.1</span><span class="string">,10.1.1.2,10.1.1.3</span></span><br></pre></td></tr></table></figure><p>启动后，点击顶部导航栏 <code>配置</code>，从左侧 <code>系统配置</code> 设置 <code>服务端配置</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-config.png"></p><p>配置内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server-config</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 默认不开启监控 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;local-mode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;job-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;send-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;alarm-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hdfs-enabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;remote-servers&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10.1.1.1:8080,10.1.1.2:8080,10.1.1.3:8080&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">storage</span> <span class="attr">local-base-dir</span>=<span class="string">&quot;/data/appdatas/cat/bucket/&quot;</span> <span class="attr">max-hdfs-storage-time</span>=<span class="string">&quot;15&quot;</span> <span class="attr">local-report-storage-time</span>=<span class="string">&quot;30&quot;</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">&quot;30&quot;</span> <span class="attr">har-mode</span>=<span class="string">&quot;true&quot;</span> <span class="attr">upload-thread</span>=<span class="string">&quot;5&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">&quot;dump&quot;</span> <span class="attr">max-size</span>=<span class="string">&quot;128M&quot;</span> <span class="attr">server-uri</span>=<span class="string">&quot;hdfs://127.0.0.1/&quot;</span> <span class="attr">base-dir</span>=<span class="string">&quot;/user/cat/dump&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">harfs</span> <span class="attr">id</span>=<span class="string">&quot;dump&quot;</span> <span class="attr">max-size</span>=<span class="string">&quot;128M&quot;</span> <span class="attr">server-uri</span>=<span class="string">&quot;har://127.0.0.1/&quot;</span> <span class="attr">base-dir</span>=<span class="string">&quot;/user/cat/dump&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hadoop.security.authentication&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dfs.namenode.kerberos.principal&quot;</span> <span class="attr">value</span>=<span class="string">&quot;hadoop/dev80.hadoop@testserver.com&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dfs.cat.kerberos.principal&quot;</span> <span class="attr">value</span>=<span class="string">&quot;cat@testserver.com&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dfs.cat.keytab.file&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/data/appdatas/cat/cat.keytab&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;java.security.krb5.realm&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;java.security.krb5.kdc&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">storage</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">consumer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">long-config</span> <span class="attr">default-url-threshold</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">default-sql-threshold</span>=<span class="string">&quot;100&quot;</span> <span class="attr">default-service-threshold</span>=<span class="string">&quot;50&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">domain</span> <span class="attr">name</span>=<span class="string">&quot;cat&quot;</span> <span class="attr">url-threshold</span>=<span class="string">&quot;500&quot;</span> <span class="attr">sql-threshold</span>=<span class="string">&quot;500&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">domain</span> <span class="attr">name</span>=<span class="string">&quot;OpenPlatformWeb&quot;</span> <span class="attr">url-threshold</span>=<span class="string">&quot;100&quot;</span> <span class="attr">sql-threshold</span>=<span class="string">&quot;500&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">long-config</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">consumer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 将 10.1.1.1 设置为监控节点，其他节点设置为消费节点 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;job-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;send-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;alarm-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server-config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>从左侧 <code>系统配置</code> 设置 <code>客户端路由</code> 。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/client-route-config.png"></p><p>配置内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-config</span> <span class="attr">backup-server</span>=<span class="string">&quot;10.1.1.1&quot;</span> <span class="attr">backup-server-port</span>=<span class="string">&quot;2280&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 监控节点不开启消费，其他节点开启消费，可以根据实际情况调整 weight 权重 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">default-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.1&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">default-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.2&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">default-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.3&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">network-policy</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span> <span class="attr">title</span>=<span class="string">&quot;default&quot;</span> <span class="attr">block</span>=<span class="string">&quot;false&quot;</span> <span class="attr">server-group</span>=<span class="string">&quot;default_group&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">network-policy</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">server-group</span> <span class="attr">id</span>=<span class="string">&quot;default_group&quot;</span> <span class="attr">title</span>=<span class="string">&quot;default-group&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.2&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.3&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">server-group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">domain</span> <span class="attr">id</span>=<span class="string">&quot;cat&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.2&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.3&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">router-config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置完成后，查看<code>首页</code>的<code>系统状态</code>，集群配置已生效，如下图，监控节点只负责控制台的数据展示和告警通知，不消费客户端的数据。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/cluster-monitor-node.png"></p><p>数据消费节点会消费客户端发送的数据，根据客户端路由设置的权重策略均摊数据。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/cluster-data-node.png"></p><h1 id="应用集成"><a href="#应用集成" class="headerlink" title="应用集成"></a>应用集成</h1><p>为了减少客户端集成的工作，推荐您使用 <a href="https://github.com/shiyindaxiaojie/eden-architect">eden-architect</a> 框架，集成后在 log4j2 自动记录 TraceId。您只需要根据以下两步就可以完成 CAT 的集成。</p><p>引入 CAT 依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.shiyindaxiaojie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eden-cat-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>开启 CAT 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cat:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># 默认关闭，请按需开启</span></span><br><span class="line">  <span class="attr">trace-mode:</span> <span class="literal">true</span> <span class="comment"># 开启访问观测</span></span><br><span class="line">  <span class="attr">support-out-trace-id:</span> <span class="literal">false</span> <span class="comment"># 允许异构子系统间透传链路ID</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">servers:</span> <span class="string">localhost</span> <span class="comment"># CAT 地址</span></span><br><span class="line">  <span class="attr">tcp-port:</span> <span class="number">2280</span></span><br><span class="line">  <span class="attr">http-port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果您使用 Dubbo 组件，请增加对应的过滤器，确保 CAT 埋点正常工作</span></span><br><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">  <span class="attr">provider:</span></span><br><span class="line">    <span class="attr">filter:</span> <span class="string">cat-tracing</span></span><br><span class="line">  <span class="attr">consumer:</span></span><br><span class="line">    <span class="attr">filter:</span> <span class="string">cat-tracing,cat-consumer</span></span><br></pre></td></tr></table></figure><p>启动您的项目，调用接口，查看控制台输出的日志内容，红圈中就是 CAT 的链路ID。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/traceid-of-logging.png"></p><p>根据链路ID，在 CAT 中查看详细链路信息。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/tracing.png"></p><blockquote><p>当然，如果你不希望依赖 eden-architect，则可以参考<a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-integration/src/main/java/org/ylzl/eden/spring/integration/cat/integration">相关代码</a>实现自己的需求。关于相关代码的实现原理，笔者将在后面的文章中给出。</p></blockquote><h1 id="告警配置"><a href="#告警配置" class="headerlink" title="告警配置"></a>告警配置</h1><p>目前 CAT 经过二次开发，实现了告警通知的开箱即用，您只需要微调相关配置，即可开启告警通知功能。告警通知支持以下方式：邮件、钉钉、飞书、微信、Jira Software，配置步骤如下：</p><p>点击控制台的 <code>配置</code>，展开左侧 <code>系统配置</code> 的 <code>告警渠道</code>，如下图：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/alert-config.png"></p><p>以 <code>邮件</code>、<code>钉钉</code>、<code>Jira Software</code> 为例，内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sender-config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sender</span> <span class="attr">id</span>=<span class="string">&quot;mail&quot;</span> <span class="attr">url</span>=<span class="string">&quot;smtp.qq.com:25&quot;</span> <span class="attr">type</span>=<span class="string">&quot;post&quot;</span> <span class="attr">successCode</span>=<span class="string">&quot;200&quot;</span> <span class="attr">batchSend</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">par</span> <span class="attr">id</span>=<span class="string">&quot;username=发件人邮箱地址&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">par</span> <span class="attr">id</span>=<span class="string">&quot;password=发件人邮箱密码&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sender</span> <span class="attr">id</span>=<span class="string">&quot;dingtalk&quot;</span> <span class="attr">url</span>=<span class="string">&quot;https://oapi.dingtalk.com/robot/send?access_token=&quot;</span> <span class="attr">type</span>=<span class="string">&quot;post&quot;</span> <span class="attr">successCode</span>=<span class="string">&quot;200&quot;</span> <span class="attr">batchSend</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sender</span> <span class="attr">id</span>=<span class="string">&quot;jira&quot;</span> <span class="attr">url</span>=<span class="string">&quot;http://localhost:8080&quot;</span> <span class="attr">type</span>=<span class="string">&quot;post&quot;</span> <span class="attr">successCode</span>=<span class="string">&quot;200&quot;</span> <span class="attr">batchSend</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">par</span> <span class="attr">id</span>=<span class="string">&quot;reporter_token=凭据&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sender-config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>设置 <code>系统配置</code> 的 <code>告警策略</code>，即 CAT 埋点达到告警阈值时发送的接收对象，例如 <code>dingtalk</code>、<code>mail</code>、<code>jira</code>，如下图：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/alert-strategy.png"></p><p>内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">alert-policy</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Transaction&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Event&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Exception&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail,jira&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail,jira&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Business&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Heartbeat&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">alert-policy</span>&gt;</span></span><br></pre></td></tr></table></figure><p>设置 <code>系统配置</code> 的 <code>告警对象</code>，即告警通知接收对象，如下图：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/alert-config-receiver.png"></p><p>内容如下，笔者设置了 <code>Exception</code> 类型的告警：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">alert-config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Transaction&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Event&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Exception&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">email</span>&gt;</span>您的邮箱<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">jira</span>&gt;</span>reporterName=monitor<span class="symbol">&amp;amp;</span>issueType=故障<span class="symbol">&amp;amp;</span>components=架构<span class="symbol">&amp;amp;</span>fixVersionNames=待定<span class="tag">&lt;/<span class="name">jira</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dingtalk</span>&gt;</span>您的钉钉机器人Token<span class="tag">&lt;/<span class="name">dingtalk</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Heartbeat&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Business&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">alert-config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接下来设置 <code>Server</code> 的 <code>异常告警配置</code>，如下图：<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-exception-alert-config.png"></p><p>配置界面如下，应用名称填写 <code>default</code> 表示监控所有服务，您可以指定自己的服务名称独立监控。异常名称建议填写 <code>Total</code>，表示监控所有异常，如果您需要监控某个异常，则填写该异常名称即可：<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-exception-alert-config-editable.png"></p><p>如果有些异常是不需要监控的，请在<code>异常过滤</code>列表添加。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-exception-alert-config-ignore.png"></p><p>笔者设置了所有异常出现 5 次时发送告警，10 次时发送告警。达到这个阈值时，邮件会发送到 <code>告警对象</code> 设置的接收对象，Jira Software 会创建一个故障，钉钉会发送告警通知：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/mail.png"></p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 可观测性 </tag>
            
            <tag> 二次开发 </tag>
            
            <tag> 中间件 </tag>
            
            <tag> 链路追踪 </tag>
            
            <tag> 美团 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深入浅出 Elasticsearch：底层存储实现</title>
      <link href="/2023/03/01/elasticsearch/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Elasticsearch%EF%BC%9A%E5%BA%95%E5%B1%82%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0/"/>
      <url>/2023/03/01/elasticsearch/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20Elasticsearch%EF%BC%9A%E5%BA%95%E5%B1%82%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1>基础知识</h1><p>Elasticsearch 是 Elastic Stack 核心的分布式搜索和分析引擎，底层使用 Lucene 存储引擎实现，对外提供 RESTful API，支持 JSON 接口和 DSL 查询。随着 Elastic 公司的发展，组成了 Elastic Stack，由 Logstash、Beats、Elasticsearch 和 Kibana 四大核心产品组成。</p><p>目前除了 Elasticsearch，开源的搜索引擎有：</p><ol><li>Apache Solr：Apache 开源，基于 Lucene 构建，<strong>依赖 Zookeeper 部署</strong>，相对 ES 部署、监控、多租户<strong>配置比较复杂</strong>。</li><li>OpenSearch：AWS 开源，承诺永久免费，基于 Elasticsearch 的<strong>分支版本</strong>，集成了 ES 和 Kibana 的全部功能。</li><li>ClickHouse：俄罗斯开源，<strong>支持 SQL 查询</strong>，提供丰富的数据分析功能，适用于 OLAP 场景，<strong>全文检索能力不如</strong> Elasticsearch。</li><li>Doris：百度开源，<strong>支持 SQL 查询</strong>，适合实时 OLAP 场景，但<strong>社区活跃度和性能不如</strong> Elasticsearch。</li></ol><blockquote><p>2021 年，Elastic 决定放弃 Apache 2.0 协议，转而采用 SSPL 和 ELv2，主要是为了应对 AWS 等云服务提供商利用凯源代码提供商业服务的问题，导致社区不满，AWS 随即推出了 OpenSearch 项目。<br>2024 年，Elastic 引入 AGPL 协议，希望修复与社区的关系，重新确立其开源项目的定位。</p></blockquote><h1>核心概念</h1><p>Elasticsearch 使用 Shard 分片来实现水平扩展，以支持多节点、分布式部署，通过 Follow 副本机制实现数据备份，实现高可用。</p><h1>工作原理</h1><p>Elasticsearch 的底层存储实现是 Lucene，基于 Java 实现。</p><h2 id="底层存储实现">底层存储实现</h2><h2 id="全文检索原理">全文检索原理</h2><h2 id="文档版本控制">文档版本控制</h2><h2 id="索引写入流程">索引写入流程</h2>]]></content>
      
      
      <categories>
          
          <category> 学习总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 搜索引擎 </tag>
            
            <tag> Elasticsearch </tag>
            
            <tag> 工作原理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 存储 emoji 报错问题排查</title>
      <link href="/2023/02/10/mysql/MySQL%20%E5%AD%98%E5%82%A8%20emoji%20%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
      <url>/2023/02/10/mysql/MySQL%20%E5%AD%98%E5%82%A8%20emoji%20%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/</url>
      
        <content type="html"><![CDATA[<h1>问题描述</h1><p>我们使用 MySQL 在特定业务场景（帖子、评论、个人签名）存储 emoji 表情。Server 配置和建表语句统一使用 <code>utf8mb4</code>，仍然抛出如下错误：<br><code>java.sql.SQLException: Incorrect string value: '\xF0\x9F\x92\x94' for column 'name' at row 1</code>。</p><h1>原因分析</h1><p>MySQL 的 <code>utf8</code> 编码最多支持 3 个字节，而 emoji 表情需要占用 4 个字节，在早期的版本并没有实现真正意义上的 <code>utf8</code> 字符集。MySQL 从 <code>5.5.3</code> 版本开始支持 <code>utf8mb4</code> 字符集。</p><p>我们检查了 Server 的版本和配置，确定字符集用的是 <code>utf8mb4</code>，也检查了客户端连接 Server 的参数，也没发现其他异常。</p><p>将代码部署到自建的 MySQL 环境，可以正常存储，但是部署到云数据库 MySQL，就会报错，基本上判断是云厂商配置的问题。</p><p>因云数据库的环境不支持在 Server 端配置 <code>character-set-client-handshake</code> 或者 <code>init_connect</code> 参数，我们使用了 <code>HikariCP</code> 数据库连接池框架，在数据库连接池框架初始化连接之前传入 <code>set names utf8mb4; </code>命令处理，代码片段如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">connection-init-sql:</span> <span class="string">SET</span> <span class="string">NAMES</span> <span class="string">utf8mb4</span></span><br></pre></td></tr></table></figure><p>修改配置后，问题解决。</p><h1>故障复盘</h1><p>云厂商数据库通过 proxy 代理，屏蔽了客户端和服务器之间的细节，导致我们很难排查出问题的根本原因。对于 MySQL 的字符存储问题，我们通常会通过以下方式来排查问题。</p><h2 id="检查客户端代码的会话字符集">检查客户端代码的会话字符集</h2><p>例如 HikariCP 数据库连接池框架，在数据库连接池框架初始化连接之前传入 <code>set names utf8mb4; </code>命令，让客户端告知 Server，使用 <code>utf8mb4</code> 字符集。</p><h2 id="检查-MySQL-服务端的字符集">检查 MySQL 服务端的字符集</h2><p>通过以下语句查看 MySQL 服务端的字符集是否为 <code>utf8mb4</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">WHERE</span> VARIABLE_NAME <span class="keyword">LIKE</span> <span class="string">&#x27;character_set_database&#x27;</span> <span class="keyword">OR</span> VARIABLE_NAME <span class="keyword">LIKE</span> <span class="string">&#x27;collation%&#x27;</span>;</span><br></pre></td></tr></table></figure><p>如果不是，调整 MySQL 的配置文件，关键代码片段如下。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">character-set-server</span> = utf8mb4</span><br><span class="line"><span class="attr">collation-server</span> = utf8mb4_unicode_ci</span><br><span class="line"><span class="attr">init_connect</span>=<span class="string">&#x27;SET NAMES utf8mb4&#x27;</span></span><br><span class="line"><span class="attr">character-set-client-handshake</span> = <span class="literal">FALSE</span></span><br></pre></td></tr></table></figure><p>重启 MySQL Server，重新确认 MySQL 服务端的字符集是否修改成功。</p><h2 id="检查-JDBC-连接信息">检查 JDBC 连接信息</h2><p>去除 <code>characterEncoding</code> 选项，让 MySQL 连接器选择服务端的字符集。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">3306</span><span class="operator">/</span>db?useUnicode<span class="operator">=</span><span class="literal">true</span><span class="operator">&amp;&amp;</span>zeroDateTimeBehavior<span class="operator">=</span>convertToNull<span class="operator">&amp;</span>autoReconnect<span class="operator">=</span><span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="修改历史数据的字符集">修改历史数据的字符集</h2><p>对于存储了字符编码为 <code>utf8</code> 的历史数据，如果要支持 <code>utf8mb4</code> ，需要将已经存在的数据库、表、列的类型修改成 <code>utf8mb4</code>。</p><p>首先，调整数据库的默认字符集。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE <span class="operator">&lt;</span>database_name<span class="operator">&gt;</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure><p>修改表或者列的字符集。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>table_name<span class="operator">&gt;</span> <span class="keyword">CONVERT</span> <span class="keyword">TO</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure><p>如果您不希望修改整个表的字符集，可以选择指定 Column 进行调整。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>table_name<span class="operator">&gt;</span> MODIFY <span class="keyword">COLUMN</span> <span class="operator">&lt;</span>column_name<span class="operator">&gt;</span> <span class="type">VARCHAR</span>(<span class="number">512</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 线上排查 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 字符集 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 时区相差 5 小时问题排查</title>
      <link href="/2023/01/10/mysql/MySQL%20%E6%97%B6%E5%8C%BA%E7%9B%B8%E5%B7%AE%205%20%E5%B0%8F%E6%97%B6%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
      <url>/2023/01/10/mysql/MySQL%20%E6%97%B6%E5%8C%BA%E7%9B%B8%E5%B7%AE%205%20%E5%B0%8F%E6%97%B6%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/</url>
      
        <content type="html"><![CDATA[<h1>问题描述</h1><p>最近经业务部门反馈，我们有个 APP 升级后，在 <code>2023-01-09 22:47</code> 发现，当前账号的最近登录时间为 <code>2023-01-10 03:47</code>，相差了 5 个小时。</p><ol><li>第一轮排查：我们第一印象会认为是刚升级的代码出了问题，有可能是日期格式化没处理好，也有可能是 JSON 序列化没有指定时区，经过 Git diff 排查，我们并没有修改相关代码。</li><li>第二轮排查：可能是有人动了生产配置！排除了配置中心的改动，也检查了 K8s 的 Deployment 是否正确设置了 TZ=Asia/Shanghai，依然无果。</li><li>第三轮排查：提取线上部署的 jar，经过对比，我们发现 MySQL 驱动从原来的 5.1.45 升级到了 8.0.22 版本。</li></ol><h1>原因分析</h1><p>生产数据库的配置是 <code>time_zone=SYSTEM</code>（对应 <code>system_time_zone=CST</code>，CST 时区没有标准，我们在使用 Java 客户端连接默认会把 CST 解析为时区+3，也就是当时事故出现的 5 小时误差）。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/show-variables.png" alt=""></p><p>应用配置连接数据库的 jdbc-url 没有显示设置时区。MySQL驱动如果升级版本到 8.0.11 和 8.0.22 区间，jdbc-url 必须显式设置时区。从 8.0.23 版本开始，<a href="https://dev.mysql.com/doc/relnotes/connector-j/8.0/en/news-8-0-23.html">官网修复了这个问题，不再需要显示设置时区。</a></p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql-bug_v8.0.22.png" alt=""></p><hr><p>从下面对比 8.0.22 和 8.0.23 版本的变化，可以看到官网把 8.0.22 版本获取 MySQL 服务端的代码移除了，默认获取客户端自身的系统变量，例如，在 K8s 环境设置的 <code>TZ=Asia/Shanghai</code>变量。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql_v8.0.22_upgrade_v8.0.23.png" alt=""></p><p>为什么 5.1.45 版本没有这个问题呢？从源码可以看出，5.1.x 版本，不显示设置时区，代码逻辑会直接绕过设置。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql_v5.1.44_vs_v8.0.22.png" alt=""></p><p>在我们拿到 PreparedStatement 设置插入的字段会自动使用我们程序所在的系统时区。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql-auto-set-timezone.png" alt=""></p><p>因升级 MySQL 驱动到 8.0.23 的风险比较大，我们决定在 jdbc-url 参数加上 <code>serverTimezone=GMT%2B8</code>，问题解决。</p><h1>故障复盘</h1><p>为避免 MySQL 驱动版本的兼容性问题，K8s 默认设置 <code>TZ=Asia/Shanghai</code>，应用层接入 MySQL 最好显示设置 <code>serverTimezone=GMT%2B8</code>。</p>]]></content>
      
      
      <categories>
          
          <category> 线上排查 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 时区 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于 Sentinel 新增规则存储和监控回看</title>
      <link href="/2022/10/20/opensource/%E5%9F%BA%E4%BA%8E%20Sentinel%20%E6%96%B0%E5%A2%9E%E8%A7%84%E5%88%99%E5%AD%98%E5%82%A8%E5%92%8C%E7%9B%91%E6%8E%A7%E5%9B%9E%E7%9C%8B/"/>
      <url>/2022/10/20/opensource/%E5%9F%BA%E4%BA%8E%20Sentinel%20%E6%96%B0%E5%A2%9E%E8%A7%84%E5%88%99%E5%AD%98%E5%82%A8%E5%92%8C%E7%9B%91%E6%8E%A7%E5%9B%9E%E7%9C%8B/</url>
      
        <content type="html"><![CDATA[<p>Sentinel 是阿里巴巴开源的流量治理平台，提供了流量控制、熔断降级、系统负载保护、黑白名单访问控制等功能。</p><p>在实际的生产应用中，我们遇到以下几个问题：</p><ol><li>Sentinel 控制台不支持流控规则持久化，需要自行扩展。</li><li>Sentinel 控制台的监控数据只保存到内存中，只能查看近 5 分钟的数据。</li></ol><p>基于上面的问题，笔者 fork 了官方最新的源码进行二次开发，并打包镜像到 Docker Hub，方便大家使用。</p><ul><li>Github 地址：<a href="https://github.com/shiyindaxiaojie/sentinel">传送门</a></li><li>Docker Hub 地址：<a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/sentinel-dashboard/tags">传送门</a></li></ul><h1>改造内容</h1><ul><li><p>新增<strong>流控规则持久化</strong>支持，适配 <code>Apollo</code>、<code>Nacos</code>、<code>Zookeeper</code> 等组件。</p></li><li><p>新增<strong>监控数据持久化</strong>机制，适配 <code>InfluxDB</code>、<code>Kafka</code>、<code>Elasticsearch</code> 等组件，您可以通过时间控制回看历史数据，如下图。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/sentinel/sentinel-dashboard-overview-custom.png" alt=""><br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/sentinel/sentinel-dashboard-overview-quick.png" alt=""></p></li></ul><h1>部署教程</h1><h2 id="微调应用配置">微调应用配置</h2><p>在实际的生产需求，Sentinel 保存的规则和监控是需要持久化落盘的，因此，您可以在 <code>sentinel-dashboard/src/main/resources/application.properties</code> 接入外部组件。</p><p>规则存储类型支持：memory（默认）、nacos（推荐）、apollo、zookeeper</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 规则存储类型，可选项：memory（默认）、nacos（推荐）、apollo、zookeeper</span></span><br><span class="line"><span class="attr">sentinel.rule.type</span>=<span class="string">nacos</span></span><br><span class="line"><span class="comment"># Nacos 存储规则，如果您设置了 sentinel.metrics.type=nacos，需要调整相关配置</span></span><br><span class="line"><span class="attr">sentinel.rule.nacos.server-addr</span>=<span class="string">localhost:8848</span></span><br><span class="line"><span class="attr">sentinel.rule.nacos.namespace</span>=<span class="string">demo</span></span><br><span class="line"><span class="attr">sentinel.rule.nacos.group-id</span>=<span class="string">sentinel</span></span><br><span class="line"><span class="attr">sentinel.rule.nacos.username</span>=<span class="string">nacos</span></span><br><span class="line"><span class="attr">sentinel.rule.nacos.password</span>=<span class="string">nacos</span></span><br><span class="line"><span class="comment"># Apollo 存储规则，如果您设置了 sentinel.metrics.type=apollo，需要调整相关配置</span></span><br><span class="line"><span class="attr">sentinel.rule.apollo.portal-url</span>=<span class="string">http://localhost:10034</span></span><br><span class="line"><span class="attr">sentinel.rule.apollo.token</span>=<span class="string"></span></span><br><span class="line"><span class="attr">sentinel.rule.apollo.env</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># Zookeeper 存储规则，如果您设置了 sentinel.metrics.type=zookeeper，需要调整相关配置</span></span><br><span class="line"><span class="attr">sentinel.rule.zookeeper.connect-string</span>=<span class="string">localhost:2181</span></span><br><span class="line"><span class="attr">sentinel.rule.zookeeper.root-path</span>=<span class="string">/sentinel_rule</span></span><br></pre></td></tr></table></figure><p>监控存储类型支持：memory（默认）、influxdb（推荐）、elasticsearch、kafka</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控存储类型，可选项：memory（默认）、influxdb（推荐）、elasticsearch</span></span><br><span class="line"><span class="attr">sentinel.metrics.type</span>=<span class="string">memory</span></span><br><span class="line"><span class="comment"># InfluxDB 存储监控数据，如果您设置了 sentinel.metrics.type=influxdb，需要调整相关配置</span></span><br><span class="line"><span class="attr">influx.url</span>=<span class="string">http://localhost:8086/</span></span><br><span class="line"><span class="attr">influx.token</span>=<span class="string"></span></span><br><span class="line"><span class="attr">influx.org</span>=<span class="string">sentinel</span></span><br><span class="line"><span class="attr">influx.bucket</span>=<span class="string">sentinel</span></span><br><span class="line"><span class="attr">influx.log-level</span>=<span class="string">NONE</span></span><br><span class="line"><span class="attr">influx.read-timeout</span>=<span class="string">10s</span></span><br><span class="line"><span class="attr">influx.write-timeout</span>=<span class="string">10s</span></span><br><span class="line"><span class="attr">influx.connect-timeout</span>=<span class="string">10s</span></span><br><span class="line"><span class="comment"># Elasticsearch 存储监控数据，如果您设置了 sentinel.metrics.type=elasticsearch，需要调整相关配置</span></span><br><span class="line"><span class="attr">sentinel.metrics.elasticsearch.index-name</span>=<span class="string">sentinel_metric</span></span><br><span class="line"><span class="attr">spring.elasticsearch.rest.uris</span>=<span class="string">http://localhost:9200</span></span><br><span class="line"><span class="attr">spring.elasticsearch.rest.connection-timeout</span>=<span class="string">3000</span></span><br><span class="line"><span class="attr">spring.elasticsearch.rest.read-timeout</span>=<span class="string">5000</span></span><br><span class="line"><span class="attr">spring.elasticsearch.rest.username</span>=<span class="string"></span></span><br><span class="line"><span class="attr">spring.elasticsearch.rest.password</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 监控数据存储缓冲设置，降低底层存储组件写入压力。可选项：none（默认不启用）、kafka（推荐）</span></span><br><span class="line"><span class="attr">sentinel.metrics.sender.type</span>=<span class="string">none</span></span><br><span class="line"><span class="comment"># Kafka 存储监控数据，如果您设置了 sentinel.metrics.sender.type=kafka，需要调整相关配置</span></span><br><span class="line"><span class="attr">sentinel.metrics.sender.kafka.topic</span>=<span class="string">sentinel_metric</span></span><br><span class="line"><span class="attr">spring.kafka.producer.bootstrap-servers</span>=<span class="string">localhost:9092</span></span><br><span class="line"><span class="attr">spring.kafka.producer.batch-size</span>=<span class="string">4096</span></span><br><span class="line"><span class="attr">spring.kafka.producer.buffer-memory</span>=<span class="string">40960</span></span><br><span class="line"><span class="attr">spring.kafka.producer.key-serializer</span>=<span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br><span class="line"><span class="attr">spring.kafka.producer.value-serializer</span>=<span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br></pre></td></tr></table></figure><h2 id="FatJar-部署">FatJar 部署</h2><p>执行 <code>mvn clean package</code> 打包成一个 fat jar，参考如下命令启动编译后的控制台。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=8080 \</span><br><span class="line">-Dsentinel.rule.nacos.server-addr=localhost:8848 \</span><br><span class="line">-Dsentinel.rule.nacos.namespace=demo \</span><br><span class="line">-Dsentinel.rule.nacos.group-id=sentinel \</span><br><span class="line">-Dsentinel.metrics.type=influxdb \</span><br><span class="line">-Dinflux.url=http://localhost:8086 \</span><br><span class="line">-Dinflux.token=XXXXXX \</span><br><span class="line">-Dinflux.org=sentinel \</span><br><span class="line">-Dinflux.bucket=sentinel \</span><br><span class="line">-jar target/sentinel-dashboard.jar</span><br></pre></td></tr></table></figure><h2 id="Docker-部署">Docker 部署</h2><p>本项目已发布稳定的镜像到 <a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/sentinel/tags">Docker Hub</a>，您可以直接使用如下命令，完成部署。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8090:8090 --name=sentinel-dashboard -d shiyindaxiaojie/sentinel-dashboard</span><br></pre></td></tr></table></figure><h2 id="Kubernetes-部署">Kubernetes 部署</h2><p>建议使用 StatefulSet 部署，YAML 示例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sentinel-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PATH</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/usr/local/openjdk-11/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_HOME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/usr/local/openjdk-11</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_OUTPUT_ANSI_ENABLED</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">ALWAYS</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">sentinel-dashboard</span></span><br><span class="line">              <span class="attr">optional:</span> <span class="literal">false</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_VERSION</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">11.0</span><span class="number">.16</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_SLEEP</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LANG</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">C.UTF-8</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">512m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMX</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">512m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMN</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">256m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVER_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;8090&quot;</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">shiyindaxiaojie/sentinel-dashboard:v1.8.6</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">sentinel-dashboard</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/app/application.properties</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">application</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">application.properties</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">application.properties</span></span><br><span class="line">            <span class="attr">mode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">application.properties</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">arthas-tunnel-server</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">application</span></span><br></pre></td></tr></table></figure><p>对应的 ConfigMap 如下（仅供参考，需自行替换），用于配置账号和权限。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sentinel-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">JAVA_OPTS:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    -Dsentinel.rule.nacos.server-addr=nacos-server:8848 -Dsentinel.rule.nacos.namespace=sentinel</span></span><br><span class="line"><span class="string">    -Dsentinel.rule.nacos.group-id=sentinel -Dsentinel.metrics.type=influxdb -Dinflux.url=http://influxdb:8086/</span></span><br><span class="line"><span class="string">    -Dinflux.token=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line"><span class="string">    -Dinflux.org=demo -Dinflux.bucket=sentinel</span></span><br></pre></td></tr></table></figure><h1>应用集成</h1><p>为了减少客户端集成的工作，推荐您使用 <a href="https://github.com/shiyindaxiaojie/eden-architect">eden-architect</a> 框架，只需要两步就可以完成 Sentinel 的集成。</p><p>引入 Sentinel 依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.shiyindaxiaojie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eden-sentinel-spring-cloud-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>开启 Sentinel 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span> <span class="comment"># 流量治理组件</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 默认关闭，请按需开启</span></span><br><span class="line">      <span class="attr">http-method-specify:</span> <span class="literal">true</span> <span class="comment"># 兼容 RESTful</span></span><br><span class="line">      <span class="attr">eager:</span> <span class="literal">true</span> <span class="comment"># 立刻刷新到 Dashboard</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8090</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">flow:</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="string">$&#123;spring.cloud.nacos.config.server-addr&#125;</span></span><br><span class="line">            <span class="attr">namespace:</span> <span class="string">$&#123;spring.cloud.nacos.config.namespace&#125;</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">sentinel</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">$&#123;spring.application.name&#125;-flow-rule</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span></span><br><span class="line">            <span class="attr">data-type:</span> <span class="string">json</span></span><br></pre></td></tr></table></figure><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-cloud-starters/eden-sentinel-spring-cloud-starter">eden-sentinel-spring-cloud-starter</a> 实现自己的需求。</p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 可观测性 </tag>
            
            <tag> 阿里巴巴 </tag>
            
            <tag> 二次开发 </tag>
            
            <tag> 中间件 </tag>
            
            <tag> 限流熔断 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于 Arthas 新增权限控制和服务发现</title>
      <link href="/2022/09/09/opensource/%E5%9F%BA%E4%BA%8E%20Arthas%20%E6%96%B0%E5%A2%9E%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/"/>
      <url>/2022/09/09/opensource/%E5%9F%BA%E4%BA%8E%20Arthas%20%E6%96%B0%E5%A2%9E%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>Arthas 是阿里巴巴开源的在线诊断工具，提供了 <code>Dashboard</code> 负载总览、<code>Thread</code> 线程占用、<code>Stack</code> 堆栈查看、<code>Watch</code> 性能观测等功能。</p><p>在实际的生产应用中，我们遇到以下几个问题：</p><ol><li>Arthas 控制台没有权限控制，一旦访问 IP 暴露，就有安全问题。</li><li>Arthas 控制台需要提前知道 AgentId 才能访问，不适合 K8s 扩容管理。</li></ol><p>基于上面的问题，笔者 fork 了官方最新的源码进行二次开发，并打包镜像到 Docker Hub，方便大家使用。</p><ul><li>Github 地址：<a href="https://github.com/shiyindaxiaojie/arthas">传送门</a></li><li>Docker Hub 地址：<a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/arthas-tunnel-server/tags">传送门</a></li></ul><h1>改造内容</h1><ul><li><p>新增<strong>服务发现</strong>支持，自动获取接入的应用列表 IP 和端口，无须手动输入 AgentId。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/arthas/arthas-dashboard-overview.png" alt=""></p></li><li><p>新增<strong>权限控制</strong>机制，授权用户输入用户密码登录后，在控制台只能操作已授权的应用。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/arthas/arthas-dashboard-login.png" alt=""></p></li></ul><h1>部署教程</h1><h2 id="FatJar-部署">FatJar 部署</h2><p>执行 <code>mvn clean package</code> 打包成一个 fat jar，参考如下命令启动编译后的控制台。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=8080 -jar target/arthas-tunnel-server.jar</span><br></pre></td></tr></table></figure><h2 id="Docker-部署">Docker 部署</h2><p>本项目已发布稳定的镜像到 <a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/arthas/tags">Docker Hub</a>，您可以直接使用如下命令，完成部署。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8080:8080 --name=arthas-tunnel-server -d shiyindaxiaojie/arthas-tunnel-server</span><br></pre></td></tr></table></figure><h2 id="Kubernetes-部署">Kubernetes 部署</h2><p>建议使用 StatefulSet 部署，YAML 示例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">arthas-tunnel-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">shiyindaxiaojie/arthas-tunnel-server:v3.6.7</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cat-home</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/app/application.properties</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">application</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">application.properties</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">application.properties</span></span><br><span class="line">            <span class="attr">mode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">application.properties</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">arthas-tunnel-server</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">application</span></span><br></pre></td></tr></table></figure><p>对应的 ConfigMap 如下，用于配置账号和权限。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">arthas-tunnel-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">application.properties:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    arthas.server.host=0.0.0.0</span></span><br><span class="line"><span class="string">    arthas.server.port=7777</span></span><br><span class="line"><span class="string">    arthas.enable-detail-pages=false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="string">spring.cache.type=caffeine</span></span><br><span class="line">    <span class="string">spring.cache.cache-names=inMemoryClusterCache</span></span><br><span class="line">    <span class="string">spring.cache.caffeine.spec=maximumSize=3000,expireAfterAccess=3600s</span></span><br><span class="line"></span><br><span class="line">    <span class="string">spring.security.jwt.secret=base64码</span></span><br><span class="line">    <span class="string">spring.security.jwt.token-validity-in-seconds=604800</span></span><br><span class="line">    <span class="comment"># Administrator</span></span><br><span class="line">    <span class="string">spring.security.users[0].name=admin</span></span><br><span class="line">    <span class="string">spring.security.users[0].password=123456</span></span><br><span class="line">    <span class="string">spring.security.users[0].roles=ADMIN</span></span><br><span class="line">    <span class="comment"># Custom User</span></span><br><span class="line">    <span class="string">spring.security.users[1].name=user</span></span><br><span class="line">    <span class="string">spring.security.users[1].password=123456</span></span><br><span class="line">    <span class="string">spring.security.users[1].roles=eden-*</span></span><br></pre></td></tr></table></figure><h1>应用集成</h1><p>为了减少客户端集成的工作，推荐您使用 <a href="https://github.com/shiyindaxiaojie/eden-architect">eden-architect</a> 框架，只需要两步就可以完成 Arthas 的集成。</p><p>引入 Arthas 依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.shiyindaxiaojie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eden-arthas-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>开启 Arthas 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">arthas:</span> </span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 默认关闭，请按需开启，支持零停机开启和关闭</span></span><br><span class="line"></span><br><span class="line"><span class="attr">arthas:</span> <span class="comment"># 在线诊断工具</span></span><br><span class="line">  <span class="attr">agent-id:</span> <span class="string">$&#123;spring.application.name&#125;@$&#123;random.value&#125;</span></span><br><span class="line">  <span class="attr">tunnel-server:</span> <span class="string">ws://localhost:7777/ws</span> <span class="comment"># Arthas 地址</span></span><br><span class="line">  <span class="attr">session-timeout:</span> <span class="number">1800</span></span><br><span class="line">  <span class="attr">telnet-port:</span> <span class="number">0</span> <span class="comment"># 随机端口</span></span><br><span class="line">  <span class="attr">http-port:</span> <span class="number">0</span> <span class="comment"># 随机端口</span></span><br></pre></td></tr></table></figure><p>启动您的项目，在控制台中查看到应用列表，就可以看到您的应用了。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-arthas-spring-boot-starter">eden-arthas-spring-boot-starter</a> 实现自己的需求。</p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 在线诊断 </tag>
            
            <tag> 可观测性 </tag>
            
            <tag> 阿里巴巴 </tag>
            
            <tag> 二次开发 </tag>
            
            <tag> 中间件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NGINX Ingress 金丝雀发布实践</title>
      <link href="/2022/08/16/devops/NGINX%20Ingress%20%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83%E5%AE%9E%E8%B7%B5/"/>
      <url>/2022/08/16/devops/NGINX%20Ingress%20%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>我们的系统建设初期，使用腾讯云 CLB 负载均衡实现蓝绿发布，由于 CLB 的设计只能绑定腾讯云 CVM 服务器，对于 Serverless 集群架构很不友好。为解决这个问题，笔者尝试在腾讯云部署 NGINX Ingress Controller 实现金丝雀发布。</p><h1>目标</h1><p>探索 NGINX Ingress Controller 实现金丝雀发布。</p><h1>部署</h1><h2 id="准备-Nginx-测试用例">准备 Nginx 测试用例</h2><p>部署 nginx-v1 和 nginx-v2 两个工作负载作为测试用例，使用 <code>openresty/openresty:centos</code> 作为基础镜像。</p><p>nginx-v1 部署代码片段如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># StatefulSet</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-v1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">openresty/openresty:centos</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/local/openresty/nginx/conf/nginx.conf</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">nginx.conf</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-v1</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">partition:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-v1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-v1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">nginx.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">   &quot;worker_processes auto;</span></span><br><span class="line"><span class="string">    error_log /usr/local/openresty/nginx/logs/error.log warn;</span></span><br><span class="line"><span class="string">    pid /var/run/nginx.pid;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="string">events</span> &#123;</span><br><span class="line">      <span class="string">accept_mutex</span> <span class="string">on;</span></span><br><span class="line">      <span class="string">multi_accept</span> <span class="string">on;</span></span><br><span class="line">      <span class="string">use</span> <span class="string">epoll;</span> </span><br><span class="line">      <span class="string">worker_connections</span> <span class="number">1024</span><span class="string">;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">http</span> &#123;</span><br><span class="line">      <span class="string">sendfile</span> <span class="string">on;</span></span><br><span class="line">      <span class="string">gzip</span> <span class="string">on;</span></span><br><span class="line">      <span class="string">keepalive_timeout</span> <span class="number">30</span><span class="string">;</span></span><br><span class="line">      </span><br><span class="line">      <span class="string">ignore_invalid_headers</span> <span class="string">off;</span></span><br><span class="line">            <span class="string">server</span> &#123;</span><br><span class="line">                <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line">                <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">                    <span class="string">access_by_lua</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">                        local header_str = ngx.say(&quot;nginx-v1&quot;)</span></span><br><span class="line"><span class="string">                    &#x27;</span><span class="string">;</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="string">include</span> <span class="string">/etc/nginx/conf.d/*.conf;</span></span><br><span class="line">    &#125;<span class="string">&quot;</span></span><br></pre></td></tr></table></figure><p>nginx-v2 部署代码片段如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># StatefulSet</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-v2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">openresty/openresty:centos</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/usr/local/openresty/nginx/conf/nginx.conf</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">nginx.conf</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nginx-v2</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">conf</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">partition:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-v2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">qcloud-app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-v2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">nginx.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">   &quot;worker_processes auto;</span></span><br><span class="line"><span class="string">    error_log /usr/local/openresty/nginx/logs/error.log warn;</span></span><br><span class="line"><span class="string">    pid /var/run/nginx.pid;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="string">events</span> &#123;</span><br><span class="line">      <span class="string">accept_mutex</span> <span class="string">on;</span></span><br><span class="line">      <span class="string">multi_accept</span> <span class="string">on;</span></span><br><span class="line">      <span class="string">use</span> <span class="string">epoll;</span> </span><br><span class="line">      <span class="string">worker_connections</span> <span class="number">1024</span><span class="string">;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="string">http</span> &#123;</span><br><span class="line">      <span class="string">sendfile</span> <span class="string">on;</span></span><br><span class="line">      <span class="string">gzip</span> <span class="string">on;</span></span><br><span class="line">      <span class="string">keepalive_timeout</span> <span class="number">30</span><span class="string">;</span></span><br><span class="line">      </span><br><span class="line">      <span class="string">ignore_invalid_headers</span> <span class="string">off;</span></span><br><span class="line">            <span class="string">server</span> &#123;</span><br><span class="line">                <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line">                <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">                    <span class="string">access_by_lua</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">                        local header_str = ngx.say(&quot;nginx-v2&quot;)</span></span><br><span class="line"><span class="string">                    &#x27;</span><span class="string">;</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="string">include</span> <span class="string">/etc/nginx/conf.d/*.conf;</span></span><br><span class="line">    &#125;<span class="string">&quot;</span></span><br></pre></td></tr></table></figure><h2 id="创建-NGINX-Ingress-Controller">创建 NGINX Ingress Controller</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cloud.tencent.com/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NginxIngress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClass:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">watchNamespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">workLoad:</span></span><br><span class="line">    <span class="attr">hpa:</span></span><br><span class="line">      <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">maxReplicas:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">metrics:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">pods:</span></span><br><span class="line">          <span class="attr">metricName:</span> <span class="string">k8s_pod_rate_cpu_core_used_limit</span></span><br><span class="line">          <span class="attr">targetAverageValue:</span> <span class="string">&quot;80&quot;</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Pods</span></span><br><span class="line">      <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">affinity:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">container:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">shjrccr.ccs.tencentyun.com/paas/nginx-ingress-controller:v0.49.3</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;0.25&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;0.25&quot;</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">deployment</span></span><br></pre></td></tr></table></figure><p>对应的 ConfigMap 如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">access-log-path:</span> <span class="string">/var/log/nginx/nginx_access.log</span></span><br><span class="line">  <span class="attr">allow-snippet-annotations:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="attr">error-log-path:</span> <span class="string">/var/log/nginx/nginx_error.log</span></span><br><span class="line">  <span class="attr">keep-alive-requests:</span> <span class="string">&quot;10000&quot;</span></span><br><span class="line">  <span class="attr">log-format-upstream:</span> <span class="string">$remote_addr</span> <span class="bullet">-</span> <span class="string">$remote_user</span> [<span class="string">$time_iso8601</span>] <span class="string">$msec</span> <span class="string">&quot;$request&quot;</span></span><br><span class="line">    <span class="string">$status</span> <span class="string">$body_bytes_sent</span> <span class="string">&quot;$http_referer&quot;</span> <span class="string">&quot;$http_user_agent&quot;</span> <span class="string">$request_length</span> <span class="string">$request_time</span></span><br><span class="line">    [<span class="string">$proxy_upstream_name</span>] [<span class="string">$proxy_alternative_upstream_name</span>] [<span class="string">$upstream_addr</span>] [<span class="string">$upstream_response_length</span>]</span><br><span class="line">    [<span class="string">$upstream_response_time</span>] [<span class="string">$upstream_status</span>] <span class="string">$req_id</span></span><br><span class="line">  <span class="attr">max-worker-connections:</span> <span class="string">&quot;65536&quot;</span></span><br><span class="line">  <span class="attr">upstream-keepalive-connections:</span> <span class="string">&quot;200&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">nginx-ingress-ingress-nginx-controller</span></span><br><span class="line">    <span class="attr">qcloud-app:</span> <span class="string">nginx-ingress-ingress-nginx-controller</span></span><br><span class="line">    <span class="attr">manager:</span> <span class="string">tke-nginx-ingress-controller</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-ingress-nginx-controller</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure><p>在腾讯云控制台可以看到 NGINX Ingress 实例已成功部署。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/eks-nginx-ingress-controller-created.png" alt=""></p><h2 id="创建-NGINX-Ingress">创建 NGINX Ingress</h2><p>创建 nginx-ingress 指向 nginx-v1 服务。客户端请求默认路由到这个 Ingress。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">nginx-ingress</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.rule-mix:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.subnetId:</span> <span class="string">subnet-1234567</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-v1</span> <span class="comment"># 绑定 Service</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">172.28</span><span class="number">.84</span><span class="number">.54</span></span><br></pre></td></tr></table></figure><p>创建 nginx-ingress-canary 指向 nginx-v2 服务，通过 <code> nginx.ingress.kubernetes.io/canary: &quot;true&quot;</code> 注解实现灰度。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">nginx-ingress</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.rule-mix:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.subnetId:</span> <span class="string">subnet-1234567</span></span><br><span class="line">    <span class="comment"># 开启灰度</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress-canary</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">nginx-v2</span> <span class="comment"># 绑定 Service</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">loadBalancer:</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">172.28</span><span class="number">.84</span><span class="number">.54</span></span><br></pre></td></tr></table></figure><p>腾讯云控制台可以看到，<code>nginx-ingress</code> 和 <code>nginx-ingress-canary</code> 指向同一个访问 IP 172.28.84.54。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/eks-nginx-ingress-created.png" alt=""></p><h2 id="验证-A-B-测试">验证 A/B 测试</h2><p>使用 curl 验证流量切分是否有效。</p><p>在未开启流量切分之前，curl 请求情况如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># for i in &#123;1..10&#125;; do curl http://172.28.84.54; done;</span></span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br></pre></td></tr></table></figure><p>给 <code>nginx-ingress-canary</code> 添加如下代码。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="comment"># 基于 Header 的流量切分</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class="string">region</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary-by-header-pattern:</span> <span class="string">gz|sz</span> <span class="comment"># 如果 Http 请求头包含 region=gz 或者 region=sz 都会转发到该 Ingress</span></span><br></pre></td></tr></table></figure><p>在 curl 请求头添加 <code>region=gz</code>，请求情况如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># curl http://172.28.84.54;</span></span><br><span class="line">nginx-v1</span><br><span class="line">[root@localhost ~]<span class="comment"># curl -H &quot;region: gz&quot; http://172.28.84.54;</span></span><br><span class="line">nginx-v2</span><br><span class="line">[root@localhost ~]<span class="comment"># curl -H &quot;region: bj&quot; http://172.28.84.54;</span></span><br><span class="line">nginx-v1</span><br><span class="line">[root@localhost ~]<span class="comment"># curl -H &quot;region: sz&quot; http://172.28.84.54;</span></span><br><span class="line">nginx-v2</span><br></pre></td></tr></table></figure><p>验证通过，使用 <code>nginx.ingress.kubernetes.io/canary-by-header-pattern: gz|sz</code> 表示我们要灰度新版本到 gz 区域或者 sz 区域，客户端携带这些请求，流量就会进入灰度的 Ingress。</p><h2 id="验证金丝雀发布">验证金丝雀发布</h2><p>金丝雀发布主要通过权重逐步分流，基于 <code>nginx.ingress.kubernetes.io/canary-weight</code> 控制。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/canary-weight:</span> <span class="string">&quot;10&quot;</span></span><br></pre></td></tr></table></figure><p>发起 curl 请求，响应情况如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># for i in &#123;1..10&#125;; do curl http://172.28.84.54; done;</span></span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v2</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v2</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br><span class="line">nginx-v1</span><br></pre></td></tr></table></figure><p>验证通过，从结果可以看出，流量约 10% 的比例被灰度版本分流。</p><h1>总结</h1><p>基于 NGINX Ingress Controller 实现 A/B 测试、金丝雀发布还是比较简单的，但是 NGINX reload 问题并没有彻底解决。笔者更倾向于使用 APISIX Ingress Controller 实现金丝雀发布。</p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> A/B 测试 </tag>
            
            <tag> 金丝雀发布 </tag>
            
            <tag> NGINX </tag>
            
            <tag> 负载均衡 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CODING 持续部署实践</title>
      <link href="/2022/08/10/devops/CODING%20%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/"/>
      <url>/2022/08/10/devops/CODING%20%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>CODING 是腾讯云提供的云原生应用平台，提供了可视化的编排工具，支持 GitOps、CI/CD、Helm、Kubernetes 等云原生技术。笔者所在的公司使用 Jenkins 构建，由运维团队负责管理 CI/CD，效率低下，腾讯云给我们推广了这个产品，趁这个机会，笔者决定研究下 CODING。</p><h1>目标</h1><p>探索 CODING 流水线使用，验证 CI/CD 能力。</p><h1>实战</h1><p>以 <a href="https://github.com/shiyindaxiaojie/eden-demo-cola">演示工程</a> 为例，使用 <code>Maven</code> 构建工具，目录结构如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">eden-demo-cola</span><br><span class="line">  |_ .coding/</span><br><span class="line">    |_ Jenkinsfile <span class="comment"># CODING 流水线脚本</span></span><br><span class="line">    |_ settings.xml <span class="comment"># 自定义Maven 配置文件</span></span><br><span class="line">  |_ docker/</span><br><span class="line">    |_ Dockerfile <span class="comment"># Docker 构建文件</span></span><br><span class="line">    |_ entrypoint.sh <span class="comment"># Docker 容器启动脚本</span></span><br><span class="line">  |_ ...</span><br><span class="line">  |_ pom.xml <span class="comment"># Maven 构建文件</span></span><br></pre></td></tr></table></figure><h2 id="设置-Git-代码仓库">设置 Git 代码仓库</h2><p>由于笔者的项目主要托管在 Github，使用<code>关联代码仓库</code>完成构建。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-relate-code-repo.png" alt=""></p><h2 id="选择-Image-构建工具">选择 Image 构建工具</h2><blockquote><p>目前 Java 构建镜像的主流方式有两种：</p><ol><li>使用 Google 的 <code>jib-maven-plugin</code> 插件，这种方式简单轻便，不需要在 Docker 环境下运行。</li><li>编写 Dockerfile 文件：自由度较高，结合 <code>spring-boot-maven-plugin</code> 插件配置分层。</li></ol></blockquote><h3 id="Google-Jib-插件构建">Google Jib 插件构建</h3><p>在子模块 <code>eden-demo-cola-start</code> 中引入 <code>jib-maven-plugin</code> 插件。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.shiyindaxiaojie.eden.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eden-demo-cola<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eden-demo-cola-start<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>eden-demo-cola-start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>启动入口<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">start-class</span>&gt;</span>org.ylzl.eden.demo.ColaApplication<span class="tag">&lt;/<span class="name">start-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">maven.deploy.skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">maven.deploy.skip</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build.layers.enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">build.layers.enabled</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.name&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.cloud.tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jib-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">from</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span>&gt;</span>openjdk:11-jdk-slim<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">to</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span>&gt;</span>$&#123;docker.image&#125;<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">auth</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">username</span>&gt;</span>$&#123;docker.username&#125;<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;docker.password&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">auth</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tags</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tag</span>&gt;</span>latest<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tags</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">container</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">entrypoint</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shell</span>&gt;</span>bash<span class="tag">&lt;/<span class="name">shell</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">option</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">arg</span>&gt;</span>/entrypoint.sh<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">entrypoint</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ports</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">port</span>&gt;</span>9080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ports</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">environment</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">TZ</span>&gt;</span>Asia/Shanghai<span class="tag">&lt;/<span class="name">TZ</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LANG</span>&gt;</span>C.UTF-8<span class="tag">&lt;/<span class="name">LANG</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">JVM_XMS</span>&gt;</span>1g<span class="tag">&lt;/<span class="name">JVM_XMS</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">JVM_XMX</span>&gt;</span>1g<span class="tag">&lt;/<span class="name">JVM_XMX</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">JVM_XSS</span>&gt;</span>256k<span class="tag">&lt;/<span class="name">JVM_XSS</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">GC_MODE</span>&gt;</span>G1<span class="tag">&lt;/<span class="name">GC_MODE</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">USE_GC_LOG</span>&gt;</span>Y<span class="tag">&lt;/<span class="name">USE_GC_LOG</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">USE_HEAP_DUMP</span>&gt;</span>Y<span class="tag">&lt;/<span class="name">USE_HEAP_DUMP</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">USE_LARGE_PAGES</span>&gt;</span>N<span class="tag">&lt;/<span class="name">USE_LARGE_PAGES</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">SPRING_PROFILES_ACTIVE</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">SPRING_PROFILES_ACTIVE</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">creationTime</span>&gt;</span>USE_CURRENT_TIMESTAMP<span class="tag">&lt;/<span class="name">creationTime</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>$&#123;start-class&#125;<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">container</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">extraDirectories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">paths</span>&gt;</span>src/main/docker/jib<span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">file</span>&gt;</span>/entrypoint.sh<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mode</span>&gt;</span>755<span class="tag">&lt;/<span class="name">mode</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">extraDirectories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">allowInsecureRegistries</span>&gt;</span>true<span class="tag">&lt;/<span class="name">allowInsecureRegistries</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>使用 Maven 构建并发布镜像，代码片段如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn -pl eden-demo-cola-start jib:build -Dimage=shiyindaxiaojie/eden-demo-cola -Djib.disableUpdateChecks=<span class="literal">true</span> -DskipTests -U -T 4C</span><br></pre></td></tr></table></figure><h3 id="Dockerfile-分层构建">Dockerfile 分层构建</h3><p>如果您不希望引入 Google 第三方插件，也可以参考 <code>docker</code> 目录的 Dockerfile 文件，代码实现了镜像的分层，可以放心使用。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> m.daocloud.io/openjdk:<span class="number">11</span>-jdk-slim AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定构建模块</span></span><br><span class="line"><span class="keyword">ARG</span> MODULE=eden-demo-cola-start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制必要文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$MODULE</span>/target/<span class="variable">$MODULE</span>.jar application.jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker/entrypoint.sh entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Spring Boot 的分层模式提取 JAR 文件的依赖项</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> java -Djarmode=layertools -jar application.jar extract</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建容器镜像</span></span><br><span class="line"><span class="keyword">FROM</span> m.daocloud.io/openjdk:<span class="number">11</span>-jdk-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义元数据</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;梦想歌 &lt;shiyindaxiaojie@gmail.com&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&quot;1.0.0&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定构建参数</span></span><br><span class="line"><span class="keyword">ARG</span> <span class="keyword">USER</span>=tmpuser</span><br><span class="line"><span class="keyword">ARG</span> GROUP=tmpgroup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> HOME=<span class="string">&quot;/app&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=<span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> LANG=<span class="string">&quot;C.UTF-8&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XMS=<span class="string">&quot;1g&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XMX=<span class="string">&quot;1g&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XSS=<span class="string">&quot;256k&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> GC_MODE=<span class="string">&quot;G1&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_GC_LOG=<span class="string">&quot;Y&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_HEAP_DUMP=<span class="string">&quot;Y&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_LARGE_PAGES=<span class="string">&quot;N&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> SPRING_PROFILES_ACTIVE=<span class="string">&quot;dev&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> SERVER_PORT=<span class="string">&quot;8080&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> MANAGEMENT_SERVER_PORT=<span class="string">&quot;9080&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建日志目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/logs \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">touch</span> <span class="variable">$HOME</span>/logs/entrypoint.out \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">ln</span> -sf /dev/stdout <span class="variable">$HOME</span>/logs/entrypoint.out \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">ln</span> -sf /dev/stderr <span class="variable">$HOME</span>/logs/entrypoint.out</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从基础镜像复制应用程序依赖项和模块</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/dependencies/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/spring-boot-loader ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/organization-dependencies ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/modules-dependencies ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/snapshot-dependencies/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/application/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/entrypoint.sh ./</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建普通用户</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -g 1000 <span class="variable">$GROUP</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; useradd -u 1000 -g <span class="variable">$GROUP</span> -d <span class="variable">$HOME</span> -s /bin/bash <span class="variable">$USER</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">chown</span> -R <span class="variable">$USER</span>:<span class="variable">$GROUP</span> <span class="variable">$HOME</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">chmod</span> -R a+rwX <span class="variable">$HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到容器用户</span></span><br><span class="line"><span class="keyword">USER</span> $<span class="keyword">USER</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露访问端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> $SERVER_PORT $MANAGEMENT_SERVER_PORT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置启动入口</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;./entrypoint.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>在根目录执行 Docker 指令完成构建。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -f docker/Dockerfile -t shiyindaxiaojie/eden-demo-cola .</span><br><span class="line">docker push shiyindaxiaojie/eden-demo-cola</span><br></pre></td></tr></table></figure><h2 id="自定义-Maven-配置文件">自定义 Maven 配置文件</h2><p>由于笔者直接使用 CODING 节点托管部署，无法了解服务器内部的 Maven 细节，并且，Maven 的环境变动可能会影响整个构建计划不可用，因此，建议自定义 <code>settings.xml</code> 来控制您的应用。</p><p>首先，使用 <code>-s</code> 选项指定项目 <code>.coding</code> 目录的 <code>settings.xml</code> 文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package -DskipTests -T 4C -s ./.coding/settings.xml</span><br></pre></td></tr></table></figure><p>Maven 配置文件的内容统一使用 <code>$&#123;env.xxx&#125;</code> 变量，表示通过 CODING 的脚本传递环境变量，代码片段如下。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>coding<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">username</span>&gt;</span>$&#123;env.MAVEN_USERNAME&#125;<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;env.MAVEN_PASSWORD&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>coding<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">docker.username</span>&gt;</span>$&#123;env.DOCKER_USERNAME&#125;<span class="tag">&lt;/<span class="name">docker.username</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">docker.password</span>&gt;</span>$&#123;env.DOCKER_PASSWORD&#125;<span class="tag">&lt;/<span class="name">docker.password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">docker.image</span>&gt;</span>$&#123;env.DOCKER_IMAGE&#125;<span class="tag">&lt;/<span class="name">docker.image</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">altReleaseDeploymentRepository</span>&gt;</span></span><br><span class="line">coding::default::$&#123;env.MAVEN_REPO_URL&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">altReleaseDeploymentRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">altSnapshotDeploymentRepository</span>&gt;</span></span><br><span class="line">coding::default::$&#123;env.MAVEN_REPO_URL&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">altSnapshotDeploymentRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>coding<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">url</span>&gt;</span>$&#123;env.MAVEN_REPO_URL&#125;<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">id</span>&gt;</span>coding<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">url</span>&gt;</span>$&#123;env.MAVEN_REPO_URL&#125;<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">activeProfile</span>&gt;</span>coding<span class="tag">&lt;/<span class="name">activeProfile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure><p>对应的 CODING 流水线传递相关变量到 <code>settings.xml</code>。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;推送到 Maven 制品库&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    withCredentials([</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">      ),</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    ]) &#123;</span><br><span class="line">      withEnv([</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">      ]) &#123;</span><br><span class="line">        sh <span class="string">&#x27;mvn -T 4C -Pcoding deploy -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="设置-Docker-和-Maven-凭据">设置 Docker 和 Maven 凭据</h2><p>使用项目凭据来替换 CODING 脚本所需的 Docker/Maven 账户信息，减少维护凭据的工作，允许多个构建计划复用同一个凭据。同时防止构建计划泄露账户信息，特别是多人协作部署。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-set-credential.png" alt=""></p><p>录入凭据后，在构建计划的 <code>变量与缓存</code> 选择相关凭据。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-select-credential.png" alt=""></p><h2 id="编排-Jenkinsfile-脚本">编排 Jenkinsfile 脚本</h2><blockquote><p>由于 CODING 目前没有实现 Jenkinsfile 脚本的版本控制，为防止误删配置导致整个构建计划不可用，笔者的做法是把 Jenkinsfile 脚本保存到工程 <code>.coding</code> 目录下，使用 <code>Git</code> 完成版本控制。</p></blockquote><p>在 <code>.coding</code> 目录提供了开箱即用的 Jenkinsfile，包含编译打包、单元测试、发布私服、推送镜像等步骤，完整代码如下。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">environment &#123;</span><br><span class="line">  MAVEN_SNAPSHOTS_NAME = <span class="string">&quot;maven-snapshots&quot;</span></span><br><span class="line">MAVEN_SNAPSHOTS_ID = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-$&#123;PROJECT_NAME&#125;-$&#123;MAVEN_SNAPSHOTS_NAME&#125;&quot;</span></span><br><span class="line">    MAVEN_SNAPSHOTS_URL = <span class="string">&quot;$&#123;CCI_CURRENT_WEB_PROTOCOL&#125;://$&#123;CCI_CURRENT_TEAM&#125;-maven.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;/repository/$&#123;PROJECT_NAME&#125;/$&#123;MAVEN_SNAPSHOTS_NAME&#125;/&quot;</span></span><br><span class="line"></span><br><span class="line">  MAVEN_RELEASES_NAME = <span class="string">&quot;maven-releases&quot;</span></span><br><span class="line">MAVEN_RELEASES_ID = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-$&#123;PROJECT_NAME&#125;-$&#123;MAVEN_RELEASES_NAME&#125;&quot;</span></span><br><span class="line">    MAVEN_RELEASES_URL = <span class="string">&quot;$&#123;CCI_CURRENT_WEB_PROTOCOL&#125;://$&#123;CCI_CURRENT_TEAM&#125;-maven.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;/repository/$&#123;PROJECT_NAME&#125;/$&#123;MAVEN_RELEASES_NAME&#125;/&quot;</span></span><br><span class="line"></span><br><span class="line">  MAVEN_SNAPSHOTS_NAME = <span class="string">&quot;maven-snapshots&quot;</span></span><br><span class="line">  MAVEN_RELEASES_NAME = <span class="string">&quot;maven-releases&quot;</span></span><br><span class="line">  DOCKER_REPOSITORY_NAME = <span class="string">&quot;docker&quot;</span></span><br><span class="line"></span><br><span class="line">MAVEN_SNAPSHOTS_ID = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-$&#123;PROJECT_NAME&#125;-$&#123;MAVEN_SNAPSHOTS_NAME&#125;&quot;</span></span><br><span class="line">MAVEN_SNAPSHOTS_URL = <span class="string">&quot;$&#123;CCI_CURRENT_WEB_PROTOCOL&#125;://$&#123;CCI_CURRENT_TEAM&#125;-maven.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;/repository/$&#123;PROJECT_NAME&#125;/$&#123;MAVEN_SNAPSHOTS_NAME&#125;/&quot;</span></span><br><span class="line">MAVEN_RELEASES_ID = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-$&#123;PROJECT_NAME&#125;-$&#123;MAVEN_RELEASES_NAME&#125;&quot;</span></span><br><span class="line">MAVEN_RELEASES_URL = <span class="string">&quot;$&#123;CCI_CURRENT_WEB_PROTOCOL&#125;://$&#123;CCI_CURRENT_TEAM&#125;-maven.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;/repository/$&#123;PROJECT_NAME&#125;/$&#123;MAVEN_RELEASES_NAME&#125;/&quot;</span></span><br><span class="line">  DOCKER_REPOSITORY = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-docker.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;/$&#123;PROJECT_NAME&#125;/$&#123;DOCKER_REPOSITORY_NAME&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">&#x27;检出&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>,</span><br><span class="line">        <span class="symbol">branches:</span> [[<span class="attr">name:</span> GIT_BUILD_REF]],</span><br><span class="line">        <span class="symbol">userRemoteConfigs:</span> [[</span><br><span class="line">          <span class="symbol">url:</span> GIT_REPO_URL,</span><br><span class="line">          <span class="symbol">credentialsId:</span> CREDENTIALS_ID</span><br><span class="line">        ]]])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;编译&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        script &#123;</span><br><span class="line">          <span class="keyword">if</span> (env.TAG_NAME ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">          ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.TAG_NAME&#125;&quot;</span></span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (env.MR_SOURCE_BRANCH ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">          ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.MR_RESOURCE_ID&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.BRANCH_NAME.replace(&#x27;/&#x27;, &#x27;-&#x27;)&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        withCredentials([</span><br><span class="line">            usernamePassword(</span><br><span class="line">                <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">                <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">                <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">            ),</span><br><span class="line">            usernamePassword(</span><br><span class="line">                <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">                <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">                <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">            )</span><br><span class="line">        ]) &#123;</span><br><span class="line">            withEnv([</span><br><span class="line">                <span class="string">&quot;ARTIFACT_VERSION=$&#123;ARTIFACT_VERSION&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">            ]) &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -T 4C -U -Pcoding versions:set -DnewVersion=$&#123;ARTIFACT_VERSION&#125; package -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;单元测试&#x27;</span>) &#123;</span><br><span class="line">        steps &#123;</span><br><span class="line">            withCredentials([</span><br><span class="line">                usernamePassword(</span><br><span class="line">                    <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">                    <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">                    <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">                ),</span><br><span class="line">                usernamePassword(</span><br><span class="line">                    <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">                    <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">                    <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">                )</span><br><span class="line">            ]) &#123;</span><br><span class="line">                withEnv([</span><br><span class="line">                    <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">                ]) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;mvn -T 4C -Pcoding,unit-test test -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        post &#123;</span><br><span class="line">            always &#123;</span><br><span class="line">                junit <span class="string">&#x27;**/surefire-reports/*.xml&#x27;</span></span><br><span class="line">                codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-adapter-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-adapter/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">                codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-app-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-app/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">                codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-infrastructure-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-infrastructure/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;推送到 Maven 制品库&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        withCredentials([</span><br><span class="line">            usernamePassword(</span><br><span class="line">                <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">                <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">                <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">            ),</span><br><span class="line">            usernamePassword(</span><br><span class="line">                <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">                <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">                <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">            )</span><br><span class="line">        ]) &#123;</span><br><span class="line">            withEnv([</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">            ]) &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -T 4C -Pcoding deploy -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;推送到 Docker 制品库&#x27;</span>) &#123;</span><br><span class="line">        steps &#123;</span><br><span class="line">            withCredentials([</span><br><span class="line">                usernamePassword(</span><br><span class="line">                    <span class="symbol">credentialsId:</span> env.DOCKER_REGISTRY_CREDENTIALS_ID,</span><br><span class="line">                    <span class="symbol">usernameVariable:</span> <span class="string">&#x27;DOCKER_USERNAME&#x27;</span>,</span><br><span class="line">                    <span class="symbol">passwordVariable:</span> <span class="string">&#x27;DOCKER_PASSWORD&#x27;</span></span><br><span class="line">                )</span><br><span class="line">            ]) &#123;</span><br><span class="line">                withEnv([</span><br><span class="line">                    <span class="string">&quot;DOCKER_USERNAME=$&#123;DOCKER_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DOCKER_PASSWORD=$&#123;DOCKER_PASSWORD&#125;&quot;</span></span><br><span class="line">            ]) &#123;</span><br><span class="line">                sh <span class="string">&quot;docker login $&#123;DOCKER_REPOSITORY&#125; -u $&#123;DOCKER_USERNAME&#125; -p $&#123;DOCKER_PASSWORD&#125;&quot;</span></span><br><span class="line">                sh <span class="string">&quot;docker build -t $&#123;DOCKER_REPOSITORY&#125;/$&#123;DEPOT_NAME&#125;:$&#123;ARTIFACT_VERSION&#125; -f docker/Dockerfile .&quot;</span></span><br><span class="line">                sh <span class="string">&quot;docker push $&#123;DOCKER_REPOSITORY&#125;/$&#123;DEPOT_NAME&#125;:$&#123;ARTIFACT_VERSION&#125;&quot;</span></span><br><span class="line">                sh <span class="string">&quot;docker push $&#123;DOCKER_REPOSITORY&#125;/$&#123;DEPOT_NAME&#125;:latest&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果您不熟悉 Jenkinsfile 的语法，可以复制上述代码，切换到 CODING 图形化视角，进入可视化模式调整。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-edit-visualization.png" alt=""></p><p>编辑好 Jenkinsfile 文件后保存，点击 <code>立即构建</code>，触发流水线即可。接下来，笔者根据 Jenkinsfile 内容中的关键代码块进行讲解。</p><h3 id="自定义检出-Git-代码">自定义检出 Git 代码</h3><p>正常情况下，我们是一对一检出 Git 仓库。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;检出&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>,</span><br><span class="line">    <span class="symbol">branches:</span> [[<span class="attr">name:</span> GIT_BUILD_REF]],</span><br><span class="line">    <span class="symbol">userRemoteConfigs:</span> [[</span><br><span class="line">      <span class="symbol">url:</span> GIT_REPO_URL,</span><br><span class="line">      <span class="symbol">credentialsId:</span> CREDENTIALS_ID</span><br><span class="line">    ]]])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有些特殊场景，需要同时检出多个 Git 仓库，详见下述代码片段。不过，这样做会导致您无法有效控制 Git 自动触发。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;检出&#x27;</span>) &#123;</span><br><span class="line">  parallel &#123; <span class="comment">// 开启并行构建</span></span><br><span class="line">    stage(<span class="string">&#x27;检出 eden-gateway&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        dir(<span class="string">&#x27;eden-gateway&#x27;</span>) &#123;</span><br><span class="line">          checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>,</span><br><span class="line">          <span class="symbol">branches:</span> [[<span class="attr">name:</span> env.EDEN_GATEWAY_VERSION]],</span><br><span class="line">          <span class="symbol">userRemoteConfigs:</span> [[</span><br><span class="line">            <span class="symbol">url:</span> env.EDEN_GATEWAY_GIT_URL,</span><br><span class="line">            <span class="symbol">credentialsId:</span> CREDENTIALS_ID</span><br><span class="line">          ]]])</span><br><span class="line">          script &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;检出 eden-uaa&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        dir(<span class="string">&#x27;eden-uaa&#x27;</span>) &#123;</span><br><span class="line">          checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>,</span><br><span class="line">          <span class="symbol">branches:</span> [[<span class="attr">name:</span> env.EDEN_UAA_VERSION]],</span><br><span class="line">          <span class="symbol">userRemoteConfigs:</span> [[</span><br><span class="line">            <span class="symbol">url:</span> env.EDEN_UAA_GIT_URL,</span><br><span class="line">            <span class="symbol">credentialsId:</span> CREDENTIALS_ID</span><br><span class="line">          ]]])</span><br><span class="line">          script &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;                                                                 </span><br></pre></td></tr></table></figure><h3 id="设置-Maven-魔法版本号">设置 Maven 魔法版本号</h3><p>CODING 内置了一系列丰富的环境变量，您可以通过 <code>$&#123;env.TAG_NAME&#125;</code> 或者 <code>$&#123;env.BRANCH_NAME&#125;</code> 获取 Git 的版本号，使用 <code>versions-maven-plugin</code> 执行 <code>mvn versions:set -DnewVersion=$&#123;VERSION&#125;</code> 动态设置 Maven 模块的版本号。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;编译&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    script &#123;</span><br><span class="line">      <span class="keyword">if</span> (env.TAG_NAME ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">        ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.TAG_NAME&#125;&quot;</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (env.MR_SOURCE_BRANCH ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">        ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.MR_RESOURCE_ID&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.BRANCH_NAME.replace(&#x27;/&#x27;, &#x27;-&#x27;)&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    withCredentials([</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">      ),</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    ]) &#123;</span><br><span class="line">      withEnv([</span><br><span class="line">        <span class="string">&quot;ARTIFACT_VERSION=$&#123;ARTIFACT_VERSION&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">      ]) &#123;</span><br><span class="line">        sh <span class="string">&#x27;mvn -T 4C -U -Pcoding versions:set -DnewVersion=$&#123;ARTIFACT_VERSION&#125; package -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Java-测试报告可视化">Java 测试报告可视化</h3><p>CODING 提供了测试报告的可视化支持，下述代码片段提供了<strong>单元测试</strong>和<strong>代码覆盖率分析</strong>的配置示例。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;单元测试&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    withCredentials([</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">      ),</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    ]) &#123;</span><br><span class="line">      withEnv([</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">      ]) &#123;</span><br><span class="line">        sh <span class="string">&#x27;mvn -T 4C -Pcoding,unit-test test -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  post &#123;</span><br><span class="line">    always &#123;</span><br><span class="line">      junit <span class="string">&#x27;**/surefire-reports/*.xml&#x27;</span> <span class="comment">// 单元测试报告</span></span><br><span class="line">      codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-adapter-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-adapter/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">      codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-app-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-app/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">      codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-infrastructure-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-infrastructure/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在构建记录中，点击 <code>测试报告</code> 页签，查看单元测试报告。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-unit-test-report.png" alt=""></p><p>从 <code>通用报告</code> 查看代码覆盖率报告。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-code-coverage-report.png" alt=""></p><h3 id="发布制品到-Maven-仓库">发布制品到 Maven 仓库</h3><p>多人协同下，需要把构建生成的 API 依赖发布到私服（制品库）。在此之前我们已经配置好了 Maven 私服地址和相关凭据，具体可以参考下面的代码片段。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;推送到 Maven 制品库&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    withCredentials([</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">      ),</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    ]) &#123;</span><br><span class="line">      withEnv([</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">      ]) &#123;</span><br><span class="line">        sh <span class="string">&#x27;mvn -T 4C -Pcoding deploy -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Maven 私服应当严格区分 <code>Releases</code> 和 <code>Snapshots</code> 仓库。</p><p>在开发测试阶段，需要利用 Maven 的快照更新维持 API 的变动，使用 <code>Snapshots</code> 仓库比较合适。</p><p>在预发布阶段，表示测试已通过，可以发布生产了，API 不允许有变动，应当严格使用 <code>Releases</code> 仓库来限制版本的发布，避免相同版本的 API 被覆盖。</p><p>在 CODING 制品库，您可以在 <code>Releases</code> 仓库设置版本策略为禁止覆盖版本。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-repo-deny-same-verison.png" alt=""></p><h3 id="推送镜像到-Docker-仓库">推送镜像到 Docker 仓库</h3><p>本文中，笔者使用 Docker Hub 托管镜像，代码中的变量，在设置凭据的小节已详细说明，您可以根据实际情况进行调整。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;推送到 Docker 制品库&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    withCredentials([</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.DOCKER_CREDENTIALS,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;DOCKER_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;DOCKER_PASSWORD&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    ]) &#123;</span><br><span class="line">      withEnv([</span><br><span class="line">        <span class="string">&quot;DOCKER_USERNAME=$&#123;DOCKER_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DOCKER_PASSWORD=$&#123;DOCKER_PASSWORD&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DOCKER_IMAGE=$&#123;DOCKER_REPOSITORY&#125;:$&#123;ARTIFACT_VERSION&#125;&quot;</span></span><br><span class="line">      ]) &#123;</span><br><span class="line">        sh <span class="string">&#x27;mvn -Pcoding -pl eden-demo-cola-start jib:build -Djib.disableUpdateChecks=true -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行上述代码后，在 DockerHub 查看镜像已更新，验证通过。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-upload-image-successed.png" alt=""></p><h3 id="更新镜像到-K8s-集群">更新镜像到 K8s 集群</h3><p>CODING 支持配置镜像更新到 K8s 已部署的工作负载。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;部署到 K8s 集群&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    withEnv([<span class="string">&quot;DOCKER_IMAGE=$&#123;DOCKER_REPOSITORY&#125;:$&#123;ARTIFACT_VERSION&#125;&quot;</span>]) &#123;</span><br><span class="line">      cdDeploy(<span class="attr">deployType:</span> <span class="string">&#x27;PATCH_IMAGE&#x27;</span>, <span class="attr">application:</span> <span class="string">&#x27;$&#123;CCI_CURRENT_TEAM&#125;&#x27;</span>, <span class="attr">pipelineName:</span> <span class="string">&#x27;$&#123;PROJECT_NAME&#125;-$&#123;CCI_JOB_NAME&#125;-5001969&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;$&#123;DOCKER_IMAGE&#125;&#x27;</span>, <span class="attr">cloudAccountName:</span> <span class="string">&#x27;test&#x27;</span>, <span class="attr">namespace:</span> <span class="string">&#x27;test&#x27;</span>, <span class="attr">manifestType:</span> <span class="string">&#x27;Deployment&#x27;</span>, <span class="attr">manifestName:</span> <span class="string">&#x27;demo-cola&#x27;</span>, <span class="attr">containerName:</span> <span class="string">&#x27;demo-cola&#x27;</span>, <span class="attr">credentialId:</span> <span class="string">&#x27;a2954a785e1d40caa1803274a23edac9&#x27;</span>, <span class="attr">personalAccessToken:</span> <span class="string">&#x27;$&#123;CD_PERSONAL_ACCESS_TOKEN&#125;&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 CODING 的 <code>持续部署</code> &gt; <code>弹性伸缩</code> &gt; <code>配置云账号</code> 添加 K8s 凭据，绑定需要部署的 K8s 集群。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-bind-kubernetes-cluster.png" alt=""></p><p>在 CODING 构建计划编排界面配置 <code>镜像更新</code>，选择上述已绑定的 K8s 集群，根据级联选择到具体的 Pod 容器。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-select-kubernetes-cluster.png" alt=""></p><p>点击构建，查看镜像更新执行记录。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-deploy-kubernetes-log.png" alt=""></p><p>除了控制台输出，也可以点击查看 K8s 发布详情。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-deploy-kubernetes-detail.png" alt=""></p><p>查看 K8s 集群（笔者使用腾讯云 Serveless 集群部署），启动成功！</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-deploy-kubernetes-app-log.png" alt=""></p><p>访问控制台输出的 External Access URL 地址，系统访问正常。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-deploy-kubernetes-app-ui.png" alt=""></p><h3 id="前端项目怎么构建？">前端项目怎么构建？</h3><p>以开源的若依项目（Vue）为例，在代码目录下分别创建以下目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">eden-ui</span><br><span class="line">  |_ .coding/</span><br><span class="line">    |_ Jenkinsfile <span class="comment"># CODING 流水线脚本</span></span><br><span class="line">    |_ nginx.conf <span class="comment"># Nginx 配置文件</span></span><br><span class="line">  |_ docker/</span><br><span class="line">    |_ Dockerfile <span class="comment"># Docker 构建文件</span></span><br><span class="line">  |_ ...</span><br><span class="line">  |_ .npmrc</span><br></pre></td></tr></table></figure><p>初始化 <code>.npmrc</code>，代理 npm 源，指向 CODING 制品库。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">registry=https://xxx-npm.pkg.coding.net/xxx/npm/</span><br><span class="line">always-auth=<span class="literal">true</span></span><br><span class="line">//xxx-npm.pkg.coding.net/xxx/npm/:username=<span class="variable">$&#123;CODING_ARTIFACTS_USERNAME&#125;</span></span><br><span class="line">//xxx-npm.pkg.coding.net/xxx/npm/:_password=<span class="variable">$&#123;CODING_ARTIFACTS_PASSWORD&#125;</span></span><br><span class="line">//xxx-npm.pkg.coding.net/xxx/npm/:email=xxx@gmail.com</span><br></pre></td></tr></table></figure><p>为了让前端单独运行，需要依赖 Nginx 的镜像进行部署，所以，我们要把 nginx 的配置也加上，<code>nginx.conf</code> 配置如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  logs/error.log warn;</span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  logs/access.log  main;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    client_max_body_size   500m;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        charset utf-8;</span><br><span class="line"></span><br><span class="line">        gzip_static on;</span><br><span class="line">        gzip_vary on;</span><br><span class="line">        gzip_min_length 1k;</span><br><span class="line">        gzip_comp_level 9;</span><br><span class="line">        gzip_types text/css text/javascript application/javascript application/x-javascript application/xml;</span><br><span class="line">        gzip_disable <span class="string">&quot;MSIE [1-6]\.&quot;</span>;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   /usr/share/nginx/html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123; <span class="comment"># 前端</span></span><br><span class="line">            root   /usr/share/nginx/html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ^~ /api/  &#123; <span class="comment"># 后端</span></span><br><span class="line">            proxy_pass http://xxx:8080/; </span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调整 Dockerfile 打包脚本，指定 Vue 项目打包后的静态资源到 Nginx 的静态资源目录中。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx:1.15.2-alpine</span><br><span class="line"></span><br><span class="line">LABEL maintainer=<span class="string">&quot;梦想歌&quot;</span></span><br><span class="line"></span><br><span class="line">COPY dist/ /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">COPY .coding/nginx.conf /etc/nginx/conf.d/default.conf</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br></pre></td></tr></table></figure><p>编写 Jenkinsfile 构建脚本，参考如下内容。</p><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment &#123;</span><br><span class="line">        CODING_DOCKER_REPO_NAME = <span class="string">&quot;docker&quot;</span></span><br><span class="line">        CODING_DOCKER_REPO_HOST = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-docker.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;&quot;</span></span><br><span class="line">        CODING_DOCKER_REPO_URL = <span class="string">&quot;$&#123;CODING_DOCKER_REPO_HOST&#125;/$&#123;PROJECT_NAME&#125;/$&#123;CODING_DOCKER_REPO_NAME&#125;/$&#123;DEPOT_NAME&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">        TCR_NAMESPACE_NAME = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">        TCR_DOCKER_REPO_URL = <span class="string">&quot;shjrccr.ccs.tencentyun.com/$&#123;TCR_NAMESPACE_NAME&#125;/$&#123;DEPOT_NAME&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;检出&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>,</span><br><span class="line">                <span class="symbol">branches:</span> [[<span class="attr">name:</span> GIT_BUILD_REF]],</span><br><span class="line">                <span class="symbol">userRemoteConfigs:</span> [[</span><br><span class="line">                <span class="symbol">url:</span> GIT_REPO_URL,</span><br><span class="line">                <span class="symbol">credentialsId:</span> CREDENTIALS_ID</span><br><span class="line">                ]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;编译&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="keyword">if</span> (env.TAG_NAME ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">                        CODING_ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.TAG_NAME&#125;&quot;</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (env.MR_SOURCE_BRANCH ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">                        CODING_ARTIFACT_VERSION = <span class="string">&quot;mr-$&#123;env.MR_RESOURCE_ID&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        CODING_ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.BRANCH_NAME.replace(&#x27;/&#x27;, &#x27;-&#x27;)&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                sh <span class="string">&#x27;rm -rf /usr/lib/node_modules/npm/&#x27;</span></span><br><span class="line">                dir (<span class="string">&#x27;/root/.cache/downloads&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;wget -nc &quot;https://coding-public-generic.pkg.coding.net/public/downloads/node-linux-x64.tar.xz?version=v16.13.0&quot; -O node-v16.13.0-linux-x64.tar.xz | true&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;tar -xf node-v16.13.0-linux-x64.tar.xz -C /usr --strip-components 1&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                withCredentials([</span><br><span class="line">                    usernamePassword(</span><br><span class="line">                        <span class="symbol">credentialsId:</span> env.CODING_ARTIFACTS_CREDENTIALS_ID,</span><br><span class="line">                        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;CODING_ARTIFACTS_USERNAME&#x27;</span>,</span><br><span class="line">                        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;CODING_ARTIFACTS_PASSWORD&#x27;</span></span><br><span class="line">                    )]) &#123;</span><br><span class="line">                    script &#123;</span><br><span class="line">                        sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                        echo &quot;CODING_ARTIFACTS_USERNAME=$&#123;CODING_ARTIFACTS_USERNAME&#125;&quot; &gt;&gt; $CI_ENV_FILE</span></span><br><span class="line"><span class="string">                        echo &quot;CODING_ARTIFACTS_PASSWORD=$&#123;CODING_ARTIFACTS_PASSWORD&#125;&quot; &gt;&gt; $CI_ENV_FILE</span></span><br><span class="line"><span class="string">                        &#x27;&#x27;&#x27;</span></span><br><span class="line">                        readProperties(<span class="attr">file:</span> env.CI_ENV_FILE).each &#123;</span><br><span class="line">                            key, value -&gt; env[key] = value </span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    sh <span class="string">&#x27;npm install&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;npm run build:prod&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;推送到 Docker 制品库&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                withEnv([</span><br><span class="line">                    <span class="string">&quot;DOCKER_USERNAME=$&#123;DOCKER_USERNAME&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;DOCKER_PASSWORD=$&#123;DOCKER_PASSWORD&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;DOCKER_IMAGE=$&#123;TCR_DOCKER_REPO_URL&#125;:$&#123;CODING_ARTIFACT_VERSION&#125;&quot;</span></span><br><span class="line">                ]) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;docker login --username=$&#123;DOCKER_USERNAME&#125; --password=$&#123;DOCKER_PASSWORD&#125; shjrccr.ccs.tencentyun.com&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;docker build -t $&#123;DOCKER_IMAGE&#125; .&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;docker tag $&#123;DOCKER_IMAGE&#125; $&#123;DOCKER_IMAGE&#125;&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;docker push $&#123;DOCKER_IMAGE&#125;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;部署到 K8s 集群&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                withEnv([<span class="string">&quot;DOCKER_IMAGE=$&#123;TCR_DOCKER_REPO_URL&#125;:$&#123;CODING_ARTIFACT_VERSION&#125;&quot;</span>]) &#123;</span><br><span class="line">                    cdDeploy(<span class="attr">deployType:</span> <span class="string">&#x27;PATCH_IMAGE&#x27;</span>, <span class="attr">application:</span> <span class="string">&#x27;$&#123;CCI_CURRENT_TEAM&#125;&#x27;</span>, <span class="attr">pipelineName:</span> <span class="string">&#x27;$&#123;PROJECT_NAME&#125;-$&#123;CCI_JOB_NAME&#125;-202222222&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;$&#123;DOCKER_IMAGE&#125;&#x27;</span>, <span class="attr">cloudAccountName:</span> <span class="string">&#x27;xxx-k8s-test&#x27;</span>, <span class="attr">namespace:</span> <span class="string">&#x27;test&#x27;</span>, <span class="attr">manifestType:</span> <span class="string">&#x27;Deployment&#x27;</span>, <span class="attr">manifestName:</span> <span class="string">&#x27;xxx-client&#x27;</span>, <span class="attr">containerName:</span> <span class="string">&#x27;xxx-client&#x27;</span>, <span class="attr">credentialId:</span> <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>, <span class="attr">personalAccessToken:</span> <span class="string">&#x27;$&#123;CD_PERSONAL_ACCESS_TOKEN&#125;&#x27;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构建成功的效果图如下。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-deploy-vue-successed.png" alt=""></p><h1>总结</h1><p>在公司引入 CODING 后，研发团队和运维团队的工作都发生了很大的变化。研发团队负责 DevOps 的全生命周期管理，不再依赖运维团队，效率提升明显。而运维团队专注于基础设施，如云原生、网络、操作系统的优化，能更有效地处理线上故障。从整体的收益来看，至少节省了两个员工的成本。</p><p>CODING 流水线存在一些不足，只提供了单一镜像的更新功能，只能用于已部署的目标，并且不适合多服务批量部署，除非手动写脚本，基于 <code>kubectl apply</code> 实现。和腾讯方沟通后，他们告诉笔者，目前有个 <strong>Orbit 云原生应用交付</strong>正在内测，即将上线，可以开放白名单给我们尝试下。</p><p>下一期，笔者将介绍 CODING Orbit 云原生应用交付。</p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CODING </tag>
            
            <tag> CI/CD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深入浅出 MySQL：Buffer Pool 缓冲池</title>
      <link href="/2022/06/25/mysql/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20MySQL%EF%BC%9ABuffer%20Pool%20%E7%BC%93%E5%86%B2%E6%B1%A0/"/>
      <url>/2022/06/25/mysql/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20MySQL%EF%BC%9ABuffer%20Pool%20%E7%BC%93%E5%86%B2%E6%B1%A0/</url>
      
        <content type="html"><![CDATA[<h1></h1>]]></content>
      
      
      <categories>
          
          <category> 学习总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工作原理 </tag>
            
            <tag> MySQL </tag>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 MySQL 系统库排查线上问题</title>
      <link href="/2022/06/15/mysql/%E4%BD%BF%E7%94%A8%20MySQL%20%E7%B3%BB%E7%BB%9F%E5%BA%93%E6%8E%92%E6%9F%A5%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/"/>
      <url>/2022/06/15/mysql/%E4%BD%BF%E7%94%A8%20MySQL%20%E7%B3%BB%E7%BB%9F%E5%BA%93%E6%8E%92%E6%9F%A5%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1></h1>]]></content>
      
      
      <categories>
          
          <category> 线上排查 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 数据库 </tag>
            
            <tag> 性能优化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 从库同步延迟解决方案</title>
      <link href="/2022/06/15/mysql/MySQL%20%E4%BB%8E%E5%BA%93%E5%90%8C%E6%AD%A5%E5%BB%B6%E8%BF%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
      <url>/2022/06/15/mysql/MySQL%20%E4%BB%8E%E5%BA%93%E5%90%8C%E6%AD%A5%E5%BB%B6%E8%BF%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<h1>问题描述</h1><p>MySQL 主库使用云厂商较高配置，规格为 <code>32U 128G 2.5T</code>，数据空间实际使用 <code>1.5 T</code>，日志空间使用 <code>0.5T</code>，如下图。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql_tencent-cloud-overview.png" alt=""></p><p>MySQL 从库通过 K8s 自行搭建，使用 MySQL 原生镜像，规格为 <code>4U 24G</code>。</p><p>由于两者配置差距太大，MySQL 从库经过出现同步延迟或者同步报错的现象，MySQL 从库的 <code>my.cnf</code> 配置如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server_id=服务器唯一标识</span><br><span class="line"><span class="comment"># 服务器默认字符集</span></span><br><span class="line">character_set_server=utf8</span><br><span class="line"><span class="comment"># 表名是否忽略大小写：0 表示区分大小写，1 表示不区分大小写，2 表示 Windows 下不区分大小写</span></span><br><span class="line">lower_case_table_names=1 </span><br><span class="line"><span class="comment"># 启用事件调度器：1 表示启用，0 表示禁用。</span></span><br><span class="line">event_scheduler=1 </span><br><span class="line"><span class="comment"># 最大并发连接数</span></span><br><span class="line">max_connections=10000</span><br><span class="line"><span class="comment"># 允许的最大连续连接错误次数</span></span><br><span class="line">max_connect_errors=200</span><br><span class="line"><span class="comment"># 错误日志中记录的最大错误条目数</span></span><br><span class="line">max_error_count=100</span><br><span class="line"><span class="comment"># 允许的最大网络包大小</span></span><br><span class="line">max_allowed_packet=1G</span><br><span class="line"><span class="comment"># 指定中继日志的名称</span></span><br><span class="line">relay_log=mysqld-relay-bin</span><br><span class="line"><span class="comment"># 刷盘时机：0 表示提交事务时不立即刷新，1 表示每次提交事务时都刷新，2 表示每秒刷新一次</span></span><br><span class="line">innodb_flush_log_at_trx_commit=2</span><br><span class="line"><span class="comment"># InnoDB 数据和索引的缓存大小</span></span><br><span class="line">innodb_buffer_pool_size=4G</span><br><span class="line"><span class="comment"># 默认时区</span></span><br><span class="line">default-time-zone=<span class="string">&#x27;+8:00&#x27;</span></span><br><span class="line"><span class="comment"># 临时目录的位置</span></span><br><span class="line">tmpdir=/var/lib/mysql/tmp</span><br><span class="line"><span class="comment"># 错误日志文件的位置</span></span><br><span class="line">log-error=/var/lib/mysql/mysql.err</span><br></pre></td></tr></table></figure><h1>原因分析</h1><p>经过对主库和从库的分析，我们整理了一些从库可优化的配置项。</p><ol><li><strong>开启并行复制</strong>：根据从库配置调整线程数，提高同步的并行效率，关键配置参数为 <code>slave_parallel_mode=optimistic</code> 和 <code>slave_parallel_threads=4</code>。</li><li><strong>跳过一些错误码</strong>：避免复制过程中因为一些非关键性错误（如重复插入、数据不一致等）而中断，例如 <code>1062</code> 重复键，<code>1032</code>更新的数据不存在，<code>1146</code>访问的表不存在。</li><li><strong>跳过不需要的表</strong>：主库存在备份表、历史表，这些表往往数据量较大，从库并不需要这些表数据，可设置 <code>replicate_ignore_db</code> 忽略数据库和 <code>replicate_wild_ignore_table</code> 忽略指定表。</li><li><strong>Buffer Pool优化</strong>：提高 InnoDB 数据和索引的缓存大小，例如 <code>innodb_buffer_pool_size=16G</code>。</li><li><strong>binlog 缓存优化</strong>：增大 binlog 日志文件的缓存大小、事务缓存大小，例如 <code>binlog_file_cache_size=16M</code>、<code>binlog_cache_size=4M</code>。</li></ol><h1>解决方案</h1><p>优化后的 my.cnf 配置文件如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">server_id=服务器唯一标识</span><br><span class="line"><span class="comment"># 服务器默认字符集</span></span><br><span class="line">character_set_server=utf8</span><br><span class="line"><span class="comment"># 表名是否忽略大小写：0 表示区分大小写，1 表示不区分大小写，2 表示 Windows 下不区分大小写</span></span><br><span class="line">lower_case_table_names=1 </span><br><span class="line"><span class="comment"># 启用事件调度器：1 表示启用，0 表示禁用。</span></span><br><span class="line">event_scheduler=1 </span><br><span class="line"><span class="comment"># 最大并发连接数</span></span><br><span class="line">max_connections=10000</span><br><span class="line"><span class="comment"># 允许的最大连续连接错误次数</span></span><br><span class="line">max_connect_errors=200</span><br><span class="line"><span class="comment"># 错误日志中记录的最大错误条目数</span></span><br><span class="line">max_error_count=100</span><br><span class="line"><span class="comment"># 允许的最大网络包大小</span></span><br><span class="line">max_allowed_packet=1G</span><br><span class="line"><span class="comment"># 指定中继日志的名称</span></span><br><span class="line">relay_log=mysqld-relay-bin</span><br><span class="line"><span class="comment"># 联接缓存级别。范围从 0 到 8，0 表示禁用缓存，8 表示最大缓存级别。</span></span><br><span class="line">join_cache_level=8</span><br><span class="line"><span class="comment"># 禁用查询缓存</span></span><br><span class="line">query_cache_size=0</span><br><span class="line"><span class="comment"># 超过多少秒记录到慢查询日志</span></span><br><span class="line">long_query_time=15</span><br><span class="line"><span class="comment"># 默认时区</span></span><br><span class="line">default-time-zone=<span class="string">&#x27;+8:00&#x27;</span></span><br><span class="line"><span class="comment"># 临时目录的位置</span></span><br><span class="line">tmpdir=/var/lib/mysql/tmp</span><br><span class="line"><span class="comment"># 错误日志文件的位置</span></span><br><span class="line">log-error=/var/lib/mysql/mysql.err</span><br><span class="line"></span><br><span class="line"><span class="comment">## 优化点一：开启并行复制</span></span><br><span class="line"><span class="comment"># 并行复制模式</span></span><br><span class="line">slave_parallel_mode=optimistic</span><br><span class="line"><span class="comment"># 并行复制的线程数</span></span><br><span class="line">slave_parallel_threads=4</span><br><span class="line"><span class="comment"># 并行复制队列的最大条数</span></span><br><span class="line">slave_parallel_max_queued=10M</span><br><span class="line"></span><br><span class="line"><span class="comment">## 优化点二：跳过可能引起中断的错误码</span></span><br><span class="line"><span class="comment"># 在复制过程中遇到指定错误时跳过</span></span><br><span class="line">slave_skip_errors=1062,1032,1146</span><br><span class="line"></span><br><span class="line"><span class="comment">## 优化点三：跳过不需要的表</span></span><br><span class="line"><span class="comment"># 忽略复制的数据库名称</span></span><br><span class="line">replicate_ignore_db=库名</span><br><span class="line"><span class="comment"># 忽略复制的表名称</span></span><br><span class="line">replicate_wild_ignore_table=库名.表名</span><br><span class="line"><span class="comment"># 模糊匹配</span></span><br><span class="line">replicate_wild_ignore_table=库名.表名%</span><br><span class="line">replicate_wild_ignore_table=information_schema.*</span><br><span class="line"></span><br><span class="line"><span class="comment">## 优化点四：提高 InnoDB 数据和索引的缓存大小</span></span><br><span class="line"><span class="comment"># InnoDB 数据和索引的缓存大小</span></span><br><span class="line">innodb_buffer_pool_size=16G</span><br><span class="line"></span><br><span class="line"><span class="comment">## 优化点五：增大 binlog 日志文件的缓存大小、事务缓存大小</span></span><br><span class="line"><span class="comment"># binlog 日志文件的缓存大小</span></span><br><span class="line">binlog_file_cache_size=16M</span><br><span class="line"><span class="comment"># 单个 SQL 语句的缓存大小</span></span><br><span class="line">binlog_stmt_cache_size=32M</span><br><span class="line"><span class="comment"># 单个事务的缓存大小</span></span><br><span class="line">binlog_cache_size=4M</span><br><span class="line"><span class="comment"># 等待提交的数量</span></span><br><span class="line">binlog_commit_wait_count=4</span><br><span class="line"><span class="comment"># 等待提交的时间（微秒）</span></span><br><span class="line">binlog_commit_wait_usec=200000</span><br><span class="line"><span class="comment"># binlog 保留天数</span></span><br><span class="line">expire_logs_days=1</span><br><span class="line"><span class="comment"># 允许在 binlog 中记录创建函数的语句</span></span><br><span class="line">log_bin_trust_function_creators=1 </span><br><span class="line"></span><br><span class="line"><span class="comment">## 其他优化（需要看业务是否允许）</span></span><br><span class="line"><span class="comment"># 禁用严格的 InnoDB 模式</span></span><br><span class="line">innodb_strict_mode=0</span><br><span class="line"><span class="comment"># InnoDB 自增锁模式。2 表示松散模式，性能较高。</span></span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line"><span class="comment"># InnoDB 锁等待超时时间（秒）</span></span><br><span class="line">innodb_lock_wait_timeout=500</span><br><span class="line"><span class="comment"># InnoDB 存储引擎优化</span></span><br><span class="line"><span class="comment"># 刷盘时机：0 表示提交事务时不立即刷新，1 表示每次提交事务时都刷新，2 表示每秒刷新一次</span></span><br><span class="line">innodb_flush_log_at_trx_commit=0</span><br><span class="line"><span class="comment"># 关闭自适应哈希索引</span></span><br><span class="line">innodb_adaptive_hash_index=<span class="string">&#x27;OFF&#x27;</span></span><br></pre></td></tr></table></figure><p>从实际情况来看，跳过不需要的表是最有效的颁发，因为避免了大量数据表的同步，从源头减少了复制工作，同步延迟问题自然得到解决。</p>]]></content>
      
      
      <categories>
          
          <category> 线上排查 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 数据库 </tag>
            
            <tag> 主从复制 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>

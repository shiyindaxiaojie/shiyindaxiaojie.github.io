<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Harbor 私有镜像仓库搭建</title>
      <link href="/2024/10/16/Harbor%20%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E6%90%AD%E5%BB%BA/"/>
      <url>/2024/10/16/Harbor%20%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h1><p>由于自建机房无法访问 DockerHub，需要搭建 Harbor 私有镜像仓库，并解决研发团队在本地镜像仓库中拉取镜像的问题。</p><h1 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h1><p>本次基于 KubeSphere 平台搭建，使用 Helm 安装，从 <a href="https://artifacthub.io/">ArtifaceHub</a> 搜索 Harbor，添加 <a href="https://artifacthub.io/packages/helm/harbor/harbor">Helm Chart</a>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">helm repo add harbor https://helm.goharbor.io</span><br></pre></td></tr></table></figure><p>Harbor 默认使用 DockerHub 镜像，在 Helm 模板添加 <a href="https://github.com/DaoCloud/public-image-mirror">m.daocloud.io</a> 镜像仓库前缀，以解决拉取镜像失败的问题。代码片段如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 存储类指定为 data-nfs-client，您可以自行选择其他存储类。</span></span><br><span class="line"><span class="comment"># Harbor 使用 Nginx 提供访问入口，此处设置为 http://10.2.2.109:30003</span></span><br><span class="line">helm upgrade --install harbor harbor/harbor --<span class="built_in">set</span> expose.type=nodePort --<span class="built_in">set</span> persistence.persistentVolumeClaim.registry.storageClass=data-nfs-client --<span class="built_in">set</span> persistence.persistentVolumeClaim.registry.accessMode=ReadWriteMany --<span class="built_in">set</span> persistence.persistentVolumeClaim.registry.size=50Gi --<span class="built_in">set</span> nginx.image.repository=m.daocloud.io/goharbor/nginx-photon --<span class="built_in">set</span> portal.image.repository=m.daocloud.io/goharbor/harbor-portal --<span class="built_in">set</span> core.image.repository=m.daocloud.io/goharbor/harbor-core --<span class="built_in">set</span> jobservice.image.repository=m.daocloud.io/goharbor/harbor-jobservice --<span class="built_in">set</span> registry.registry.image.repository=m.daocloud.io/goharbor/registry-photon --<span class="built_in">set</span> registry.controller.image.repository=m.daocloud.io/goharbor/harbor-registryctl --<span class="built_in">set</span> trivy.image.repository=m.daocloud.io/goharbor/trivy-adapter-photon --<span class="built_in">set</span> database.internal.image.repository=m.daocloud.io/goharbor/harbor-db --<span class="built_in">set</span> redis.internal.image.repository=m.daocloud.io/goharbor/redis-photon --<span class="built_in">set</span> exporter.image.repository=m.daocloud.io/goharbor/harbor-exporter --<span class="built_in">set</span> expose.tls.enabled=<span class="literal">true</span> --<span class="built_in">set</span> externalURL=https://10.2.2.109:30003 --<span class="built_in">set</span> expose.tls.auto.commonName=<span class="string">&quot;10.2.2.109&quot;</span></span><br></pre></td></tr></table></figure><p>验证 Harbor 登录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Harbor12345&quot;</span> | docker login 10.2.2.109:30003 -u <span class="string">&quot;admin&quot;</span> --password-stdin</span><br></pre></td></tr></table></figure><p>为方便内部访问，笔者没有配置自签名证书，如果您有这个需求，可以参考下述代码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">cd</span> certs</span><br><span class="line"><span class="comment"># 自签名 CA 证书</span></span><br><span class="line">&gt; openssl genrsa -out ca.key 4096</span><br><span class="line">&gt; openssl req -x509 -new -nodes -sha512 -days 3650 \</span><br><span class="line">-subj <span class="string">&quot;/C=CN/ST=Guangdong/L=Guangzhou/O=PUYI/OU=Personal/CN=harbor.mengxiangge.org&quot;</span> \</span><br><span class="line">-key ca.key \</span><br><span class="line">-out ca.crt</span><br><span class="line"><span class="comment"># 私钥证书</span></span><br><span class="line">&gt; openssl genrsa -out harbor.mengxiangge.org.key 4096</span><br><span class="line">&gt; openssl req -sha512 -new \</span><br><span class="line">-subj <span class="string">&quot;/C=CN/ST=Guangdong/L=Guangzhou/O=PUYI/OU=Personal/CN=harbor.mengxiangge.org&quot;</span> \</span><br><span class="line">-key harbor.mengxiangge.org.key \</span><br><span class="line">-out harbor.mengxiangge.org.csr</span><br><span class="line"></span><br><span class="line">&gt; <span class="built_in">cat</span> &gt; v3.ext &lt;&lt;-<span class="string">EOF</span></span><br><span class="line"><span class="string">authorityKeyIdentifier=keyid,issuer</span></span><br><span class="line"><span class="string">basicConstraints=CA:FALSE</span></span><br><span class="line"><span class="string">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span></span><br><span class="line"><span class="string">extendedKeyUsage = serverAuth</span></span><br><span class="line"><span class="string">subjectAltName = @alt_names</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">[alt_names]</span></span><br><span class="line"><span class="string">DNS.1=harbor.mengxiangge.org</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书</span></span><br><span class="line">&gt; openssl x509 -req -sha512 -days 3650 \</span><br><span class="line">-extfile v3.ext \</span><br><span class="line">-CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">-<span class="keyword">in</span> harbor.mengxiangge.org.csr \</span><br><span class="line">-out harbor.mengxiangge.org.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取证书</span></span><br><span class="line">&gt; openssl x509 -inform PEM -<span class="keyword">in</span> harbor.mengxiangge.org.crt -out harbor.mengxiangge.org.cert</span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设您使用的是 Docker 运行时，使用以下命令将 CA 证书复制到 Docker 配置目录中。</span></span><br><span class="line"><span class="comment"># Docker守护程序将.crt 文件解释为 CA证书，将 .cert 文件解释为客户端证书</span></span><br><span class="line">&gt; <span class="built_in">mkdir</span> -p /etc/docker/certs.d/harbor.mengxiangge.org/</span><br><span class="line">&gt; <span class="built_in">cp</span> harbor.mengxiangge.org.cert /etc/docker/certs.d/harbor.mengxiangge.org/</span><br><span class="line">&gt; <span class="built_in">cp</span> harbor.mengxiangge.org.key /etc/docker/certs.d/harbor.mengxiangge.org/</span><br><span class="line">&gt; <span class="built_in">cp</span> ca.crt /etc/docker/certs.d/harbor.mengxiangge.org/</span><br></pre></td></tr></table></figure><p>使用 HTTP 访问，需要调整对应的 Docker 和 Containerd 相关配置，如果您不清楚 Kubernetes 使用的是 containerd 还是 docker，可以使用 <code>kubectl get nodes -o wide</code> 查看关键信息是否携带 <code>containerd</code> 或者 <code>docker</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&gt; kubectl get nodes -o wide</span><br><span class="line">NAME            STATUS   ROLES                  AGE     VERSION    INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION                 CONTAINER-RUNTIME</span><br><span class="line">k3s-master      Ready    control-plane,worker   3d23h   v1.24.17   10.2.2.109    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line">k3s-worker-01   Ready    worker                 3d22h   v1.24.17   10.2.2.140    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line">k3s-worker-02   Ready    worker                 3d22h   v1.24.17   10.2.2.211    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker</span></span><br><span class="line">&gt; vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://m.daocloud.io&quot;</span>],</span><br><span class="line">    <span class="string">&quot;insecure-registries&quot;</span>: [<span class="string">&quot;10.2.2.109:30003&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">:wq</span><br><span class="line">&gt; sudo systemctl daemon-reload</span><br><span class="line">&gt; sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># Containerd</span></span><br><span class="line">&gt; vim /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line">[plugins]</span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>]</span><br><span class="line">    ...</span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry]</span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://m.daocloud.io&quot;</span>]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs.<span class="string">&quot;10.2.2.109:30003&quot;</span>.tls]</span><br><span class="line">          insecure_skip_verify=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">&gt; sudo systemctl daemon-reload</span><br><span class="line">&gt; sudo systemctl restart containerd</span><br></pre></td></tr></table></figure><h1 id="结果验证"><a href="#结果验证" class="headerlink" title="结果验证"></a>结果验证</h1><p>访问 <a href="http://10.2.2.109:30003，输入初始用户密码">http://10.2.2.109:30003，输入初始用户密码</a> admin&#x2F;Harbor12345，控制台登录成功界面。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/harbor/harbor-console.png"></p><p>验证镜像上传。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在有 VPN 的机器拉取 DockerHub 镜像</span></span><br><span class="line">&gt; docker pull apacherocketmq/rocketmq-dashboard:latest</span><br><span class="line"><span class="comment"># 推送到 Harbor 私有仓库</span></span><br><span class="line">&gt; <span class="built_in">echo</span> <span class="string">&quot;Harbor12345&quot;</span> | docker login 10.2.2.109:30003 -u <span class="string">&quot;admin&quot;</span> --password-stdin</span><br><span class="line">&gt; docker tag apacherocketmq/rocketmq-dashboard:latest 10.2.2.109:30003/middleware/rocketmq-dashboard:1.0.0</span><br><span class="line">&gt; docker push 10.2.2.109:30003/middleware/rocketmq-dashboard:1.0.0</span><br></pre></td></tr></table></figure><p>在 KubeSphere 中，在保密字典 Secret 添加 Harbor 私有仓库的认证信息，并设置默认镜像仓库。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/Kubesphere-default-registry-secret.png"></p><p>Helm 部署 RockeMQ 指定镜像地址。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install rocketmq rocketmq/rocketmq -n mq --<span class="built_in">set</span> clusterName=rocketmq --<span class="built_in">set</span> image.tag=4.8.0 --<span class="built_in">set</span> broker.size.master=2 --<span class="built_in">set</span> broker.master.jvm.maxHeapSize=1024M --<span class="built_in">set</span> broker.persistence.storageClass=data-nfs-client --<span class="built_in">set</span> broker.size.replica=2 --<span class="built_in">set</span> nameserver.jvm.maxHeapSize=1024M --<span class="built_in">set</span> nameserver.persistence.enabled=<span class="literal">false</span> --<span class="built_in">set</span> nameserver.persistence.storageClass=data-nfs-client --<span class="built_in">set</span> dashboard.auth.users[0].name=admin --<span class="built_in">set</span> dashboard.auth.users[0].password=puyiwm --<span class="built_in">set</span> dashboard.auth.users[1].name=guoyuanlu --<span class="built_in">set</span> dashboard.auth.users[1].password=puyiwm --<span class="built_in">set</span> dashboard.service.type=NodePort --<span class="built_in">set</span> dashboard.service.nodePort=9877 --<span class="built_in">set</span> proxy.enabled=<span class="literal">false</span> --<span class="built_in">set</span> dashboard.image.repository=<span class="string">&quot;10.2.2.109:30003/middleware/rocketmq-dashboard&quot;</span></span><br></pre></td></tr></table></figure><p>查看容器事件，可以看到 rocketmq-dashboard 使用了我们定义的私有镜像地址。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubesphere/Kubesphere-use-harbor-registry.png"></p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> 自建机房 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KubeSphere 高可用集群搭建</title>
      <link href="/2024/10/15/KubeSphere%20%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
      <url>/2024/10/15/KubeSphere%20%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h1><p>笔者最近在部署自建机房，准备搭建 KubeSphere 集群，KubeSphere 官网的文档似乎有点小问题，所以用这篇文章来记录一下实际的操作，可以放心食用。</p><h1 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h1><p>假设有 4 台机器节点，规划如下：</p><ul><li>10.2.2.109：控制节点和 etcd</li><li>10.2.2.140：数据节点1</li><li>10.2.2.211：数据节点2</li><li>10.2.1.9: NFS 服务器，与 KubeSphere 集群隔离 IP 网段</li></ul><h2 id="DNS-初始化"><a href="#DNS-初始化" class="headerlink" title="DNS 初始化"></a>DNS 初始化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">cat</span> /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"></span><br><span class="line">10.2.2.109      k3s-master      k3s-master.novalocal</span><br><span class="line">10.2.2.140      k3s-worker-01   k3s-worker-01.novalocal</span><br><span class="line">10.2.2.211      k3s-worker-02   k3s-worker-02.novalocal</span><br></pre></td></tr></table></figure><h2 id="NFS-初始化"><a href="#NFS-初始化" class="headerlink" title="NFS 初始化"></a>NFS 初始化</h2><p>容器重启后数据会丢失，建议您提前部署好一个 NFS 存储，作为 Kubernetes 的默认存储类。</p><p>在所有服务器节点执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; yum install -y nfs-common</span><br><span class="line">&gt; yum upgrade -y</span><br><span class="line">&gt; vgcreate containervg /dev/vdb</span><br><span class="line">&gt; lvcreate -n container -l 100%FREE containervg</span><br><span class="line">&gt; mkfs.xfs /dev/mapper/containervg-container</span><br><span class="line">&gt; vi /etc/fstab</span><br><span class="line">/dev/mapper/containervg-container /var/lib/containerd xfs     defaults        0 0</span><br><span class="line">&gt; mount -a</span><br><span class="line">&gt; yum install -y socat conntrack ebtables ipset ipvsadm</span><br></pre></td></tr></table></figure><p>在服务器节点 10.2.1.9 执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&gt; parted /dev/sda</span><br><span class="line">Using /dev/sda</span><br><span class="line">Welcome to GNU Parted! Type <span class="string">&#x27;help&#x27;</span> to view a list of commands.</span><br><span class="line">(parted) <span class="built_in">print</span></span><br><span class="line">Model: DELL PERC H330 Mini (scsi)</span><br><span class="line">Disk /dev/sda: 6000GB</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags: pmbr_boot</span><br><span class="line"></span><br><span class="line">Number  Start   End     Size    File system  Name            Flags</span><br><span class="line"> 1      1049kB  3146kB  2097kB                               bios_grub</span><br><span class="line"> 2      3146kB  2151MB  2147MB  xfs</span><br><span class="line"> 3      2151MB  110GB   107GB                                lvm</span><br><span class="line"> 4      110GB   2000GB  1890GB               cinder-volumes  lvm</span><br><span class="line"> 5      2000GB  2500GB  500GB                image-volume    lvm</span><br><span class="line"> 6      2500GB  3000GB  500GB                backup-volume   lvm</span><br><span class="line"> 7      3000GB  3500GB  500GB                nova-volume     lvm</span><br><span class="line"></span><br><span class="line">(parted) mkpart k3s-nfs xfs 3500GB 5500GB</span><br><span class="line">(parted) <span class="built_in">set</span> 8 lvm on</span><br><span class="line">(parted) <span class="built_in">print</span></span><br><span class="line">Model: DELL PERC H330 Mini (scsi)</span><br><span class="line">Disk /dev/sda: 6000GB</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags: pmbr_boot</span><br><span class="line"></span><br><span class="line">Number  Start   End     Size    File system  Name            Flags</span><br><span class="line"> 1      1049kB  3146kB  2097kB                               bios_grub</span><br><span class="line"> 2      3146kB  2151MB  2147MB  xfs</span><br><span class="line"> 3      2151MB  110GB   107GB                                lvm</span><br><span class="line"> 4      110GB   2000GB  1890GB               cinder-volumes  lvm</span><br><span class="line"> 5      2000GB  2500GB  500GB                image-volume    lvm</span><br><span class="line"> 6      2500GB  3000GB  500GB                backup-volume   lvm</span><br><span class="line"> 7      3000GB  3500GB  500GB                nova-volume     lvm</span><br><span class="line"> 8      3500GB  5500GB  2000GB  xfs          k3s-nfs         lvm</span><br><span class="line"></span><br><span class="line">(parted) quit</span><br><span class="line">Information: You may need to update /etc/fstab.</span><br><span class="line"></span><br><span class="line">&gt; udevadm settle</span><br><span class="line">&gt; <span class="built_in">cat</span> /proc/partitions</span><br><span class="line">&gt; vgcreate k3snfsvg /dev/sda8</span><br><span class="line">&gt; lvcreate -n k3snfs -l 100%FREE k3snfsvg</span><br><span class="line">&gt; mkfs.xfs /dev/mapper/k3snfsvg-k3snfs</span><br><span class="line">&gt; <span class="built_in">mkdir</span> -p /nfs/kubesphere</span><br><span class="line">&gt; vim /etc/fstab</span><br><span class="line">/dev/mapper/k3snfsvg-k3snfs /nfs/kubesphere xfs     defaults        0 0</span><br><span class="line"></span><br><span class="line">&gt; systemctl daemon-reload</span><br><span class="line">&gt; mount -a</span><br><span class="line">&gt; <span class="built_in">df</span> -h</span><br><span class="line">&gt; vim /etc/exports</span><br><span class="line">/nfs/kubesphere   10.0.0.0/8(rw,<span class="built_in">sync</span>,no_root_squash)</span><br><span class="line"></span><br><span class="line">&gt; exportfs -rv</span><br><span class="line">&gt; showmount -e localhost</span><br><span class="line">&gt; <span class="built_in">cd</span> /nfs/kubesphere</span><br><span class="line">&gt; <span class="built_in">mkdir</span> &#123;rootfs,data,<span class="built_in">log</span>,config&#125;</span><br></pre></td></tr></table></figure><h2 id="Docker-初始化"><a href="#Docker-初始化" class="headerlink" title="Docker 初始化"></a>Docker 初始化</h2><p>如果 Kubernetes 使用 Containered 作为容器运行时，可以跳过此步骤。</p><p>在所有服务器节点执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; yum install -y yum-utils</span><br><span class="line">&gt; yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">&gt; yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line">&gt; systemctl <span class="built_in">enable</span> docker.service</span><br><span class="line"><span class="comment"># 如果不支持 VPN，建议设置镜像源为 m.daocloud.io</span></span><br><span class="line">&gt; vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://m.daocloud.io&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">&gt; systemctl daemon-reload</span><br><span class="line">&gt; systemctl start docker.service</span><br><span class="line">&gt; systemctl status -l docker.service</span><br></pre></td></tr></table></figure><h1 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h1><h2 id="Master-节点"><a href="#Master-节点" class="headerlink" title="Master 节点"></a>Master 节点</h2><p>在服务器节点 10.2.2.109 执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">export</span> KKZONE=cn</span><br><span class="line">&gt; <span class="built_in">mkdir</span> k3s</span><br><span class="line">&gt; <span class="built_in">cd</span> k3s</span><br><span class="line">&gt; curl -sfL https://get-kk.kubesphere.io | sh -</span><br><span class="line">&gt; sudo <span class="built_in">chmod</span> +x kk</span><br><span class="line">&gt; ./kk version --show-supported-k8s</span><br><span class="line">&gt; ./kk create config --with-kubernetes v1.24.17 --with-kubesphere v3.4.1</span><br><span class="line">&gt; <span class="built_in">cp</span> -p config-sample.yaml config-init.yaml</span><br><span class="line">&gt; vim config-init.yaml</span><br></pre></td></tr></table></figure><p>执行 vim nfs-client.yaml 创建 NFS 配置文件，内容如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubekey.kubesphere.io/v1alpha2</span><br><span class="line">kind: Cluster</span><br><span class="line">metadata:</span><br><span class="line">  name: puyi</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - &#123;name: k3s-master, address: 10.2.2.109, internalAddress: 10.2.2.109, user: root, password: <span class="string">&quot;k3s-master@123&quot;</span>&#125;</span><br><span class="line">  roleGroups:</span><br><span class="line">    etcd:</span><br><span class="line">    - k3s-master</span><br><span class="line">    control-plane:</span><br><span class="line">    - k3s-master</span><br><span class="line">    worker:</span><br><span class="line">    - k3s-master</span><br><span class="line">  controlPlaneEndpoint:</span><br><span class="line">    domain: lb.kubesphere.local</span><br><span class="line">    address: <span class="string">&quot;&quot;</span></span><br><span class="line">    port: 6443</span><br><span class="line">  kubernetes:</span><br><span class="line">    version: v1.24.17</span><br><span class="line">    clusterName: cluster.local</span><br><span class="line">    autoRenewCerts: <span class="literal">true</span></span><br><span class="line">    containerManager: containerd</span><br><span class="line">    maxPods: 220</span><br><span class="line">  etcd:</span><br><span class="line">    <span class="built_in">type</span>: kubekey</span><br><span class="line">  network:</span><br><span class="line">    plugin: calico</span><br><span class="line">    kubePodsCIDR: 10.233.64.0/18</span><br><span class="line">    kubeServiceCIDR: 10.233.0.0/18</span><br><span class="line">    multusCNI:</span><br><span class="line">      enabled: <span class="literal">false</span></span><br><span class="line">  registry:</span><br><span class="line">    privateRegistry: <span class="string">&quot;&quot;</span></span><br><span class="line">    namespaceOverride: <span class="string">&quot;&quot;</span></span><br><span class="line">    registryMirrors: []</span><br><span class="line">    insecureRegistries: []</span><br><span class="line"><span class="comment"># 这个依赖好像失效了，先注释掉</span></span><br><span class="line"><span class="comment">#  addons: </span></span><br><span class="line"><span class="comment">#  - name: nfs-rootfs</span></span><br><span class="line"><span class="comment">#    namespace: kube-system</span></span><br><span class="line"><span class="comment">#    sources:</span></span><br><span class="line"><span class="comment">#      chart:</span></span><br><span class="line"><span class="comment">#        name: nfs-rootfs-provisioner</span></span><br><span class="line"><span class="comment">#        repo: https://charts.kubesphere.io/main</span></span><br><span class="line"><span class="comment">#        valuesFile: /root/k3s/nfs-client.yaml</span></span><br><span class="line">---</span><br><span class="line">apiVersion: installer.kubesphere.io/v1alpha1</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">metadata:</span><br><span class="line">  name: ks-installer</span><br><span class="line">  namespace: kubesphere-system</span><br><span class="line">  labels:</span><br><span class="line">    version: v3.4.1</span><br><span class="line">spec:</span><br><span class="line">  persistence:</span><br><span class="line">    storageClass: <span class="string">&quot;&quot;</span></span><br><span class="line">  authentication:</span><br><span class="line">    jwtSecret: <span class="string">&quot;&quot;</span></span><br><span class="line">  local_registry: <span class="string">&quot;&quot;</span></span><br><span class="line">  etcd:</span><br><span class="line">    monitoring: <span class="literal">false</span></span><br><span class="line">    endpointIps: localhost</span><br><span class="line">    port: 2379</span><br><span class="line">    tlsEnable: <span class="literal">true</span></span><br><span class="line">  common:</span><br><span class="line">    core:</span><br><span class="line">      console:</span><br><span class="line">        enableMultiLogin: <span class="literal">true</span></span><br><span class="line">        port: 30880</span><br><span class="line">        <span class="built_in">type</span>: NodePort</span><br><span class="line">    redis:</span><br><span class="line">      enabled: <span class="literal">false</span></span><br><span class="line">      enableHA: <span class="literal">false</span></span><br><span class="line">      volumeSize: 2Gi</span><br><span class="line">    openldap:</span><br><span class="line">      enabled: <span class="literal">false</span></span><br><span class="line">      volumeSize: 2Gi</span><br><span class="line">    minio:</span><br><span class="line">      volumeSize: 20Gi</span><br><span class="line">    monitoring:</span><br><span class="line">      endpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090</span><br><span class="line">      GPUMonitoring:</span><br><span class="line">        enabled: <span class="literal">false</span></span><br><span class="line">    gpu:</span><br><span class="line">      kinds:</span><br><span class="line">      - resourceName: <span class="string">&quot;nvidia.com/gpu&quot;</span></span><br><span class="line">        resourceType: <span class="string">&quot;GPU&quot;</span></span><br><span class="line">        default: <span class="literal">true</span></span><br><span class="line">    es:</span><br><span class="line">      enabled: <span class="literal">false</span></span><br><span class="line">      logMaxAge: 7</span><br><span class="line">      auditingMaxAge: 2</span><br><span class="line">      eventMaxAge: 1</span><br><span class="line">      istioMaxAge: 4</span><br><span class="line">      elkPrefix: logstash</span><br><span class="line">      basicAuth:</span><br><span class="line">        enabled: <span class="literal">false</span></span><br><span class="line">        username: <span class="string">&quot;&quot;</span></span><br><span class="line">        password: <span class="string">&quot;&quot;</span></span><br><span class="line">      externalElasticsearchHost: <span class="string">&quot;&quot;</span></span><br><span class="line">      externalElasticsearchPort: <span class="string">&quot;&quot;</span></span><br><span class="line">    opensearch:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">      logMaxAge: 7</span><br><span class="line">      auditingMaxAge: 2</span><br><span class="line">      eventMaxAge: 1</span><br><span class="line">      istioMaxAge: 4</span><br><span class="line">      opensearchPrefix: whizard</span><br><span class="line">      basicAuth:</span><br><span class="line">        enabled: <span class="literal">true</span></span><br><span class="line">        username: <span class="string">&quot;admin&quot;</span></span><br><span class="line">        password: <span class="string">&quot;admin&quot;</span></span><br><span class="line">      externalOpensearchHost: <span class="string">&quot;&quot;</span></span><br><span class="line">      externalOpensearchPort: <span class="string">&quot;&quot;</span></span><br><span class="line">      dashboard:</span><br><span class="line">        enabled: <span class="literal">false</span></span><br><span class="line">  alerting:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  auditing:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  devops:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    jenkinsCpuReq: 1</span><br><span class="line">    jenkinsCpuLim: 1</span><br><span class="line">    jenkinsMemoryReq: 4Gi</span><br><span class="line">    jenkinsMemoryLim: 4Gi</span><br><span class="line">    jenkinsVolumeSize: 30Gi</span><br><span class="line">  events:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    ruler:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">      replicas: 2</span><br><span class="line">  logging:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    logsidecar:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">      replicas: 2</span><br><span class="line">  metrics_server:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  monitoring:</span><br><span class="line">    storageClass: <span class="string">&quot;&quot;</span></span><br><span class="line">    node_exporter:</span><br><span class="line">      port: 9100</span><br><span class="line">    gpu:</span><br><span class="line">      nvidia_dcgm_exporter:</span><br><span class="line">        enabled: <span class="literal">false</span></span><br><span class="line">  multicluster:</span><br><span class="line">    clusterRole: none</span><br><span class="line">  network:</span><br><span class="line">    networkpolicy:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">    ippool:</span><br><span class="line">      <span class="built_in">type</span>: calico</span><br><span class="line">    topology:</span><br><span class="line">      <span class="built_in">type</span>: weave-scope</span><br><span class="line">  openpitrix:</span><br><span class="line">    store:</span><br><span class="line">      enabled: <span class="literal">true</span></span><br><span class="line">  servicemesh:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">    istio:</span><br><span class="line">      components:</span><br><span class="line">        ingressGateways:</span><br><span class="line">        - name: istio-ingressgateway</span><br><span class="line">          enabled: <span class="literal">false</span></span><br><span class="line">        cni:</span><br><span class="line">          enabled: <span class="literal">false</span></span><br><span class="line">  edgeruntime:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">    kubeedge:</span><br><span class="line">      enabled: <span class="literal">false</span></span><br><span class="line">      cloudCore:</span><br><span class="line">        cloudHub:</span><br><span class="line">          advertiseAddress:</span><br><span class="line">            - <span class="string">&quot;&quot;</span></span><br><span class="line">        service:</span><br><span class="line">          cloudhubNodePort: <span class="string">&quot;30000&quot;</span></span><br><span class="line">          cloudhubQuicNodePort: <span class="string">&quot;30001&quot;</span></span><br><span class="line">          cloudhubHttpsNodePort: <span class="string">&quot;30002&quot;</span></span><br><span class="line">          cloudstreamNodePort: <span class="string">&quot;30003&quot;</span></span><br><span class="line">          tunnelNodePort: <span class="string">&quot;30004&quot;</span></span><br><span class="line">      iptables-manager:</span><br><span class="line">        enabled: <span class="literal">true</span></span><br><span class="line">        mode: <span class="string">&quot;external&quot;</span></span><br><span class="line">  gatekeeper:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">  terminal:</span><br><span class="line">    <span class="built_in">timeout</span>: 600</span><br><span class="line">  zone: <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>修改后按 ESC 输入 <code>:wq</code> 保存退出，接着使用 KubeKey 开始安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br></pre></td><td class="code"><pre><span class="line">&gt; egrep -v <span class="string">&#x27;#|^$&#x27;</span> config-init.yaml</span><br><span class="line">&gt; ./kk create cluster -f config-init.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> _   __      _          _   __</span><br><span class="line">| | / /     | |        | | / /</span><br><span class="line">| |/ / _   _| |__   ___| |/ /  ___ _   _</span><br><span class="line">|    \| | | | <span class="string">&#x27;_ \ / _ \    \ / _ \ | | |</span></span><br><span class="line"><span class="string">| |\  \ |_| | |_) |  __/ |\  \  __/ |_| |</span></span><br><span class="line"><span class="string">\_| \_/\__,_|_.__/ \___\_| \_/\___|\__, |</span></span><br><span class="line"><span class="string">                                    __/ |</span></span><br><span class="line"><span class="string">                                   |___/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">13:39:30 CST [GreetingsModule] Greetings</span></span><br><span class="line"><span class="string">13:39:30 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">Greetings, KubeKey!</span></span><br><span class="line"><span class="string">13:39:30 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:39:30 CST [NodePreCheckModule] A pre-check on nodes</span></span><br><span class="line"><span class="string">13:39:30 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:39:30 CST [ConfirmModule] Display confirmation form</span></span><br><span class="line"><span class="string">+------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string">| name       | sudo | curl | openssl | ebtables | socat | ipset | ipvsadm | conntrack | chrony | docker | containerd | nfs client | ceph client | glusterfs client | time         |</span></span><br><span class="line"><span class="string">+------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string">| k3s-master | y    | y    | y       | y        | y     | y     | y       | y         | y      |        | v1.7.13    | y          |             |                  | CST 13:39:30 |</span></span><br><span class="line"><span class="string">+------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a simple check of your environment.</span></span><br><span class="line"><span class="string">Before installation, ensure that your machines meet all requirements specified at</span></span><br><span class="line"><span class="string">https://github.com/kubesphere/kubekey#requirements-and-recommendations</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Install k8s with specify version:  v1.24.17</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Continue this installation? [yes/no]: yes</span></span><br><span class="line"><span class="string">13:39:37 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">13:39:37 CST [NodeBinariesModule] Download installation binaries</span></span><br><span class="line"><span class="string">13:39:37 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubeadm v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 43.4M  100 43.4M    0     0   900k      0  0:00:49  0:00:49 --:--:-- 1076k</span></span><br><span class="line"><span class="string">13:40:27 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubelet v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100  112M  100  112M    0     0   971k      0  0:01:58  0:01:58 --:--:-- 1063k</span></span><br><span class="line"><span class="string">13:42:26 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubectl v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 44.5M  100 44.5M    0     0   907k      0  0:00:50  0:00:50 --:--:-- 1083k</span></span><br><span class="line"><span class="string">13:43:16 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 helm v3.14.3 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 48.3M  100 48.3M    0     0   914k      0  0:00:54  0:00:54 --:--:-- 1076k</span></span><br><span class="line"><span class="string">13:44:11 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubecni v1.2.0 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 38.6M  100 38.6M    0     0   900k      0  0:00:43  0:00:43 --:--:-- 1173k</span></span><br><span class="line"><span class="string">13:44:55 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 crictl v1.29.0 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 23.2M  100 23.2M    0     0   819k      0  0:00:29  0:00:29 --:--:-- 1080k</span></span><br><span class="line"><span class="string">13:45:24 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 etcd v3.5.13 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 19.1M  100 19.1M    0     0   778k      0  0:00:25  0:00:25 --:--:-- 1036k</span></span><br><span class="line"><span class="string">13:45:49 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 containerd 1.7.13 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 45.7M  100 45.7M    0     0   908k      0  0:00:51  0:00:51 --:--:-- 1079k</span></span><br><span class="line"><span class="string">13:46:41 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 runc v1.1.12 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 10.2M  100 10.2M    0     0   658k      0  0:00:15  0:00:15 --:--:-- 1079k</span></span><br><span class="line"><span class="string">13:46:57 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 calicoctl v3.27.4 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 61.3M  100 61.3M    0     0   939k      0  0:01:06  0:01:06 --:--:-- 1101k</span></span><br><span class="line"><span class="string">13:48:04 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">13:48:04 CST [ConfigureOSModule] Get OS release</span></span><br><span class="line"><span class="string">13:48:04 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:04 CST [ConfigureOSModule] Prepare to init OS</span></span><br><span class="line"><span class="string">13:48:05 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:05 CST [ConfigureOSModule] Generate init os script</span></span><br><span class="line"><span class="string">13:48:05 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:05 CST [ConfigureOSModule] Exec init os script</span></span><br><span class="line"><span class="string">13:48:07 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">setenforce: SELinux is disabled</span></span><br><span class="line"><span class="string">Disabled</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_source_route = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_redirects = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.icmp_echo_ignore_broadcasts = 1</span></span><br><span class="line"><span class="string">net.ipv4.icmp_ignore_bogus_error_responses = 1</span></span><br><span class="line"><span class="string">kernel.sched_child_runs_first = 1</span></span><br><span class="line"><span class="string">kernel.sched_latency_ns = 80000000</span></span><br><span class="line"><span class="string">kernel.sched_migration_cost_ns = 125000</span></span><br><span class="line"><span class="string">kernel.sched_min_granularity_ns = 40000000</span></span><br><span class="line"><span class="string">kernel.sched_wakeup_granularity_ns = 3750000</span></span><br><span class="line"><span class="string">kernel.sched_nr_migrate = 128</span></span><br><span class="line"><span class="string">kernel.pid_max = 65535</span></span><br><span class="line"><span class="string">kernel.msgmax = 2097152</span></span><br><span class="line"><span class="string">kernel.msgmnb = 4194304</span></span><br><span class="line"><span class="string">kernel.shmmni = 32768</span></span><br><span class="line"><span class="string">kernel.sem = 2000 256000 256 1024</span></span><br><span class="line"><span class="string">vm.overcommit_memory = 0</span></span><br><span class="line"><span class="string">vm.max_map_count = 262144</span></span><br><span class="line"><span class="string">vm.swappiness = 0</span></span><br><span class="line"><span class="string">vm.dirty_background_ratio = 40</span></span><br><span class="line"><span class="string">vm.dirty_ratio = 50</span></span><br><span class="line"><span class="string">fs.aio-max-nr = 262144</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances = 524288</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches = 524288</span></span><br><span class="line"><span class="string">net.core.rps_sock_flow_entries = 65536</span></span><br><span class="line"><span class="string">net.core.dev_weight = 1024</span></span><br><span class="line"><span class="string">net.core.busy_poll = 200</span></span><br><span class="line"><span class="string">net.core.busy_read = 200</span></span><br><span class="line"><span class="string">net.ipv4.tcp_moderate_rcvbuf = 1</span></span><br><span class="line"><span class="string">net.core.somaxconn = 32768</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 65535</span></span><br><span class="line"><span class="string">net.core.netdev_budget = 4800</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1 = 512</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2 = 2048</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3 = 4096</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.unres_qlen_bytes = 262144</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max = 1048576</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_tcp_timeout_established = 300</span></span><br><span class="line"><span class="string">sysctl: setting key &quot;net.netfilter.nf_conntrack_buckets&quot;: No such file or directory</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_high_thresh = 16777216</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_low_thresh = 12582912</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.udp_rmem_min = 131072</span></span><br><span class="line"><span class="string">net.ipv4.udp_wmem_min = 131072</span></span><br><span class="line"><span class="string">net.core.rmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.rmem_max = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_max = 33554432</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 5</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 600</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 10000 65000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-arptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_reserved_ports = 30000-32767</span></span><br><span class="line"><span class="string">net.ipv4.tcp_retries2 = 15</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 65535</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl = 30</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 10</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_ignore = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_ignore = 1</span></span><br><span class="line"><span class="string">fs.pipe-max-size = 4194304</span></span><br><span class="line"><span class="string">kernel.watchdog_thresh = 5</span></span><br><span class="line"><span class="string">kernel.hung_task_timeout_secs = 5</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.default.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.lo.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.forwarding = 1</span></span><br><span class="line"><span class="string">13:48:07 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:07 CST [ConfigureOSModule] configure the ntp server for each node</span></span><br><span class="line"><span class="string">13:48:07 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:07 CST [KubernetesStatusModule] Get kubernetes cluster status</span></span><br><span class="line"><span class="string">13:48:08 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Sync containerd binaries</span></span><br><span class="line"><span class="string">13:48:08 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Generate containerd service</span></span><br><span class="line"><span class="string">13:48:08 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Generate containerd config</span></span><br><span class="line"><span class="string">13:48:08 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Enable containerd</span></span><br><span class="line"><span class="string">13:48:08 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Sync crictl binaries</span></span><br><span class="line"><span class="string">13:48:08 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [InstallContainerModule] Generate crictl config</span></span><br><span class="line"><span class="string">13:48:08 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:08 CST [PullModule] Start to pull images on all nodes</span></span><br><span class="line"><span class="string">13:48:08 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.7</span></span><br><span class="line"><span class="string">13:48:08 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-apiserver:v1.24.17</span></span><br><span class="line"><span class="string">13:48:08 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controller-manager:v1.24.17</span></span><br><span class="line"><span class="string">13:48:08 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-scheduler:v1.24.17</span></span><br><span class="line"><span class="string">13:48:08 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-proxy:v1.24.17</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.8.6</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/k8s-dns-node-cache:1.22.20</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controllers:v3.27.4</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.27.4</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/node:v3.27.4</span></span><br><span class="line"><span class="string">13:48:09 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pod2daemon-flexvol:v3.27.4</span></span><br><span class="line"><span class="string">13:48:09 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:09 CST [ETCDPreCheckModule] Get etcd status</span></span><br><span class="line"><span class="string">13:48:09 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:09 CST [CertsModule] Fetch etcd certs</span></span><br><span class="line"><span class="string">13:48:09 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:09 CST [CertsModule] Generate etcd Certs</span></span><br><span class="line"><span class="string">[certs] Generating &quot;ca&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] admin-k3s-master serving cert is signed for DNS names [etcd etcd.kube-system etcd.kube-system.svc etcd.kube-system.svc.cluster.local k3s-master lb.kubesphere.local localhost] and IPs [127.0.0.1 ::1 10.2.2.109]</span></span><br><span class="line"><span class="string">[certs] member-k3s-master serving cert is signed for DNS names [etcd etcd.kube-system etcd.kube-system.svc etcd.kube-system.svc.cluster.local k3s-master lb.kubesphere.local localhost] and IPs [127.0.0.1 ::1 10.2.2.109]</span></span><br><span class="line"><span class="string">[certs] node-k3s-master serving cert is signed for DNS names [etcd etcd.kube-system etcd.kube-system.svc etcd.kube-system.svc.cluster.local k3s-master lb.kubesphere.local localhost] and IPs [127.0.0.1 ::1 10.2.2.109]</span></span><br><span class="line"><span class="string">13:48:11 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">13:48:11 CST [CertsModule] Synchronize certs file</span></span><br><span class="line"><span class="string">13:48:12 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:12 CST [CertsModule] Synchronize certs file to master</span></span><br><span class="line"><span class="string">13:48:12 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:12 CST [InstallETCDBinaryModule] Install etcd using binary</span></span><br><span class="line"><span class="string">13:48:14 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [InstallETCDBinaryModule] Generate etcd service</span></span><br><span class="line"><span class="string">13:48:14 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [InstallETCDBinaryModule] Generate access address</span></span><br><span class="line"><span class="string">13:48:14 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [ETCDConfigureModule] Health check on exist etcd</span></span><br><span class="line"><span class="string">13:48:14 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [ETCDConfigureModule] Generate etcd.env config on new etcd</span></span><br><span class="line"><span class="string">13:48:14 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [ETCDConfigureModule] Refresh etcd.env config on all etcd</span></span><br><span class="line"><span class="string">13:48:14 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:14 CST [ETCDConfigureModule] Restart etcd</span></span><br><span class="line"><span class="string">13:48:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:19 CST [ETCDConfigureModule] Health check on all etcd</span></span><br><span class="line"><span class="string">13:48:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:19 CST [ETCDConfigureModule] Refresh etcd.env config to exist mode on all etcd</span></span><br><span class="line"><span class="string">13:48:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:19 CST [ETCDConfigureModule] Health check on all etcd</span></span><br><span class="line"><span class="string">13:48:20 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:20 CST [ETCDBackupModule] Backup etcd data regularly</span></span><br><span class="line"><span class="string">13:48:20 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:20 CST [ETCDBackupModule] Generate backup ETCD service</span></span><br><span class="line"><span class="string">13:48:20 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:20 CST [ETCDBackupModule] Generate backup ETCD timer</span></span><br><span class="line"><span class="string">13:48:20 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:20 CST [ETCDBackupModule] Enable backup etcd service</span></span><br><span class="line"><span class="string">13:48:20 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:20 CST [InstallKubeBinariesModule] Synchronize kubernetes binaries</span></span><br><span class="line"><span class="string">13:48:27 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:27 CST [InstallKubeBinariesModule] Change kubelet mode</span></span><br><span class="line"><span class="string">13:48:27 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:27 CST [InstallKubeBinariesModule] Generate kubelet service</span></span><br><span class="line"><span class="string">13:48:27 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:27 CST [InstallKubeBinariesModule] Enable kubelet service</span></span><br><span class="line"><span class="string">13:48:28 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:28 CST [InstallKubeBinariesModule] Generate kubelet env</span></span><br><span class="line"><span class="string">13:48:28 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:28 CST [InitKubernetesModule] Generate kubeadm config</span></span><br><span class="line"><span class="string">13:48:28 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:28 CST [InitKubernetesModule] Generate audit policy</span></span><br><span class="line"><span class="string">13:48:28 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:28 CST [InitKubernetesModule] Generate audit webhook</span></span><br><span class="line"><span class="string">13:48:28 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:28 CST [InitKubernetesModule] Init cluster using kubeadm</span></span><br><span class="line"><span class="string">13:48:51 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">W1009 13:48:28.956892   11930 utils.go:69] The recommended value for &quot;clusterDNS&quot; in &quot;KubeletConfiguration&quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]</span></span><br><span class="line"><span class="string">[init] Using Kubernetes version: v1.24.17</span></span><br><span class="line"><span class="string">[preflight] Running pre-flight checks</span></span><br><span class="line"><span class="string">[preflight] Pulling images required for setting up a Kubernetes cluster</span></span><br><span class="line"><span class="string">[preflight] This might take a minute or two, depending on the speed of your internet connection</span></span><br><span class="line"><span class="string">[preflight] You can also perform this action in beforehand using &#x27;</span>kubeadm config images pull<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[certs] Using certificateDir folder &quot;/etc/kubernetes/pki&quot;</span></span><br><span class="line"><span class="string">[certs] Generating &quot;ca&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] Generating &quot;apiserver&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] apiserver serving cert is signed for DNS names [k3s-master k3s-master.cluster.local kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local lb.kubesphere.local localhost] and IPs [10.233.0.1 10.2.2.109 127.0.0.1]</span></span><br><span class="line"><span class="string">[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] Generating &quot;front-proxy-ca&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] Generating &quot;front-proxy-client&quot; certificate and key</span></span><br><span class="line"><span class="string">[certs] External etcd mode: Skipping etcd/ca certificate authority generation</span></span><br><span class="line"><span class="string">[certs] External etcd mode: Skipping etcd/server certificate generation</span></span><br><span class="line"><span class="string">[certs] External etcd mode: Skipping etcd/peer certificate generation</span></span><br><span class="line"><span class="string">[certs] External etcd mode: Skipping etcd/healthcheck-client certificate generation</span></span><br><span class="line"><span class="string">[certs] External etcd mode: Skipping apiserver-etcd-client certificate generation</span></span><br><span class="line"><span class="string">[certs] Generating &quot;sa&quot; key and public key</span></span><br><span class="line"><span class="string">[kubeconfig] Using kubeconfig folder &quot;/etc/kubernetes&quot;</span></span><br><span class="line"><span class="string">[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="string">[kubeconfig] Writing &quot;kubelet.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="string">[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="string">[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file</span></span><br><span class="line"><span class="string">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line"><span class="string">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"><span class="string">[kubelet-start] Starting the kubelet</span></span><br><span class="line"><span class="string">[control-plane] Using manifest folder &quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line"><span class="string">[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;</span></span><br><span class="line"><span class="string">[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;</span></span><br><span class="line"><span class="string">[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;</span></span><br><span class="line"><span class="string">[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;/etc/kubernetes/manifests&quot;. This can take up to 4m0s</span></span><br><span class="line"><span class="string">[apiclient] All control plane components are healthy after 17.503847 seconds</span></span><br><span class="line"><span class="string">[upload-config] Storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</span></span><br><span class="line"><span class="string">[kubelet] Creating a ConfigMap &quot;kubelet-config&quot; in namespace kube-system with the configuration for the kubelets in the cluster</span></span><br><span class="line"><span class="string">[upload-certs] Skipping phase. Please see --upload-certs</span></span><br><span class="line"><span class="string">[mark-control-plane] Marking the node k3s-master as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span></span><br><span class="line"><span class="string">[mark-control-plane] Marking the node k3s-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule node-role.kubernetes.io/control-plane:NoSchedule]</span></span><br><span class="line"><span class="string">[bootstrap-token] Using token: kvwh7d.tiuyjnwfbc8bqyt7</span></span><br><span class="line"><span class="string">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span></span><br><span class="line"><span class="string">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span></span><br><span class="line"><span class="string">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span></span><br><span class="line"><span class="string">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span></span><br><span class="line"><span class="string">[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span></span><br><span class="line"><span class="string">[bootstrap-token] Creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</span></span><br><span class="line"><span class="string">[kubelet-finalize] Updating &quot;/etc/kubernetes/kubelet.conf&quot; to point to a rotatable kubelet client certificate and key</span></span><br><span class="line"><span class="string">[addons] Applied essential addon: CoreDNS</span></span><br><span class="line"><span class="string">[addons] Applied essential addon: kube-proxy</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Your Kubernetes control-plane has initialized successfully!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To start using your cluster, you need to run the following as a regular user:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  mkdir -p $HOME/.kube</span></span><br><span class="line"><span class="string">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></span><br><span class="line"><span class="string">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Alternatively, if you are the root user, you can run:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  export KUBECONFIG=/etc/kubernetes/admin.conf</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You should now deploy a pod network to the cluster.</span></span><br><span class="line"><span class="string">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span></span><br><span class="line"><span class="string">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can now join any number of control-plane nodes by copying certificate authorities</span></span><br><span class="line"><span class="string">and service account keys on each node and then running the following as root:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  kubeadm join lb.kubesphere.local:6443 --token kvwh7d.tiuyjnwfbc8bqyt7 \</span></span><br><span class="line"><span class="string">        --discovery-token-ca-cert-hash sha256:1f5b22071a80e7c647e441c29d0569b391de0dd15d2065c4283ee4c744a1327c \</span></span><br><span class="line"><span class="string">        --control-plane</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Then you can join any number of worker nodes by running the following on each as root:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">kubeadm join lb.kubesphere.local:6443 --token kvwh7d.tiuyjnwfbc8bqyt7 \</span></span><br><span class="line"><span class="string">        --discovery-token-ca-cert-hash sha256:1f5b22071a80e7c647e441c29d0569b391de0dd15d2065c4283ee4c744a1327c</span></span><br><span class="line"><span class="string">13:48:51 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:51 CST [InitKubernetesModule] Copy admin.conf to ~/.kube/config</span></span><br><span class="line"><span class="string">13:48:51 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:51 CST [InitKubernetesModule] Remove master taint</span></span><br><span class="line"><span class="string">13:48:53 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-master untainted</span></span><br><span class="line"><span class="string">13:48:53 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-master untainted</span></span><br><span class="line"><span class="string">13:48:53 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:53 CST [ClusterDNSModule] Generate coredns configmap</span></span><br><span class="line"><span class="string">13:48:53 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:53 CST [ClusterDNSModule] Apply coredns configmap</span></span><br><span class="line"><span class="string">13:48:54 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">Warning: resource configmaps/coredns is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span></span><br><span class="line"><span class="string">configmap/coredns configured</span></span><br><span class="line"><span class="string">13:48:54 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:54 CST [ClusterDNSModule] Generate coredns manifests</span></span><br><span class="line"><span class="string">13:48:54 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:54 CST [ClusterDNSModule] Deploy coredns</span></span><br><span class="line"><span class="string">13:48:54 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">service &quot;kube-dns&quot; deleted</span></span><br><span class="line"><span class="string">13:48:55 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">Warning: resource clusterroles/system:coredns is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/system:coredns configured</span></span><br><span class="line"><span class="string">service/coredns created</span></span><br><span class="line"><span class="string">Warning: resource deployments/coredns is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span></span><br><span class="line"><span class="string">deployment.apps/coredns configured</span></span><br><span class="line"><span class="string">13:48:55 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">deployment.apps/coredns restarted</span></span><br><span class="line"><span class="string">13:48:55 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:55 CST [ClusterDNSModule] Generate nodelocaldns configmap</span></span><br><span class="line"><span class="string">13:48:55 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:55 CST [ClusterDNSModule] Apply nodelocaldns configmap</span></span><br><span class="line"><span class="string">13:48:56 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">configmap/nodelocaldns created</span></span><br><span class="line"><span class="string">13:48:56 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:56 CST [ClusterDNSModule] Generate nodelocaldns</span></span><br><span class="line"><span class="string">13:48:56 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:56 CST [ClusterDNSModule] Deploy nodelocaldns</span></span><br><span class="line"><span class="string">13:48:56 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">serviceaccount/nodelocaldns created</span></span><br><span class="line"><span class="string">daemonset.apps/nodelocaldns created</span></span><br><span class="line"><span class="string">13:48:56 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:56 CST [KubernetesStatusModule] Get kubernetes cluster status</span></span><br><span class="line"><span class="string">13:48:56 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">v1.24.17</span></span><br><span class="line"><span class="string">13:48:56 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">k3s-master   v1.24.17   [map[address:10.2.2.109 type:InternalIP] map[address:k3s-master type:Hostname]]</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">W1009 13:48:57.018811   13416 utils.go:69] The recommended value for &quot;clusterDNS&quot; in &quot;KubeletConfiguration&quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]</span></span><br><span class="line"><span class="string">[upload-certs] Storing the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace</span></span><br><span class="line"><span class="string">[upload-certs] Using certificate key:</span></span><br><span class="line"><span class="string">64625b6043ef538848338b08d634ec2fdb933288b8b816ce928214b0398da1fa</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">gda258.973k95vadvzwx5y1</span></span><br><span class="line"><span class="string">13:48:57 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Generate kubeadm config</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Generate audit policy</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Generate audit webhook</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Join control-plane node</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Join worker node</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Copy admin.conf to ~/.kube/config</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Remove master taint</span></span><br><span class="line"><span class="string">13:48:57 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [JoinNodesModule] Add worker label to all nodes</span></span><br><span class="line"><span class="string">13:48:57 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-master labeled</span></span><br><span class="line"><span class="string">13:48:57 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:57 CST [DeployNetworkPluginModule] Generate calico</span></span><br><span class="line"><span class="string">13:48:58 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:48:58 CST [DeployNetworkPluginModule] Deploy calico</span></span><br><span class="line"><span class="string">13:49:00 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">poddisruptionbudget.policy/calico-kube-controllers created</span></span><br><span class="line"><span class="string">serviceaccount/calico-kube-controllers created</span></span><br><span class="line"><span class="string">serviceaccount/calico-node created</span></span><br><span class="line"><span class="string">serviceaccount/calico-cni-plugin created</span></span><br><span class="line"><span class="string">configmap/calico-config created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/bgpfilters.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/calico-node created</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/calico-cni-plugin created</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/calico-node created</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/calico-cni-plugin created</span></span><br><span class="line"><span class="string">daemonset.apps/calico-node created</span></span><br><span class="line"><span class="string">deployment.apps/calico-kube-controllers created</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [ConfigureKubernetesModule] Configure kubernetes</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [ChownModule] Chown user $HOME/.kube dir</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [AutoRenewCertsModule] Generate k8s certs renew script</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [AutoRenewCertsModule] Generate k8s certs renew service</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [AutoRenewCertsModule] Generate k8s certs renew timer</span></span><br><span class="line"><span class="string">13:49:00 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:00 CST [AutoRenewCertsModule] Enable k8s certs renew service</span></span><br><span class="line"><span class="string">13:49:01 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:01 CST [SaveKubeConfigModule] Save kube config as a configmap</span></span><br><span class="line"><span class="string">13:49:01 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">13:49:01 CST [AddonsModule] Install addons</span></span><br><span class="line"><span class="string">13:49:01 CST message: [LocalHost]</span></span><br><span class="line"><span class="string">[0/0] enabled addons</span></span><br><span class="line"><span class="string">13:49:01 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">13:49:01 CST [DeployStorageClassModule] Generate OpenEBS manifest</span></span><br><span class="line"><span class="string">13:49:01 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:01 CST [DeployStorageClassModule] Deploy OpenEBS as cluster default StorageClass</span></span><br><span class="line"><span class="string">13:49:02 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:02 CST [DeployKubeSphereModule] Generate KubeSphere ks-installer crd manifests</span></span><br><span class="line"><span class="string">13:49:02 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:02 CST [DeployKubeSphereModule] Apply ks-installer</span></span><br><span class="line"><span class="string">13:49:03 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">namespace/kubesphere-system created</span></span><br><span class="line"><span class="string">serviceaccount/ks-installer created</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/clusterconfigurations.installer.kubesphere.io created</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/ks-installer created</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/ks-installer created</span></span><br><span class="line"><span class="string">deployment.apps/ks-installer created</span></span><br><span class="line"><span class="string">13:49:03 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:03 CST [DeployKubeSphereModule] Add config to ks-installer manifests</span></span><br><span class="line"><span class="string">13:49:03 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:03 CST [DeployKubeSphereModule] Create the kubesphere namespace</span></span><br><span class="line"><span class="string">13:49:03 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:03 CST [DeployKubeSphereModule] Setup ks-installer config</span></span><br><span class="line"><span class="string">13:49:03 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kube-etcd-client-certs created</span></span><br><span class="line"><span class="string">13:49:03 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">13:49:03 CST [DeployKubeSphereModule] Apply ks-installer</span></span><br><span class="line"><span class="string">13:49:06 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">namespace/kubesphere-system unchanged</span></span><br><span class="line"><span class="string">serviceaccount/ks-installer unchanged</span></span><br><span class="line"><span class="string">customresourcedefinition.apiextensions.k8s.io/clusterconfigurations.installer.kubesphere.io unchanged</span></span><br><span class="line"><span class="string">clusterrole.rbac.authorization.k8s.io/ks-installer unchanged</span></span><br><span class="line"><span class="string">clusterrolebinding.rbac.authorization.k8s.io/ks-installer unchanged</span></span><br><span class="line"><span class="string">deployment.apps/ks-installer unchanged</span></span><br><span class="line"><span class="string">clusterconfiguration.installer.kubesphere.io/ks-installer created</span></span><br><span class="line"><span class="string">13:49:06 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">#####################################################</span></span><br><span class="line"><span class="string">###              Welcome to KubeSphere!           ###</span></span><br><span class="line"><span class="string">#####################################################</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Console: http://10.2.2.109:30880</span></span><br><span class="line"><span class="string">Account: admin</span></span><br><span class="line"><span class="string">Password: P@88w0rd</span></span><br><span class="line"><span class="string">NOTES：</span></span><br><span class="line"><span class="string">  1. After you log into the console, please check the</span></span><br><span class="line"><span class="string">     monitoring status of service components in</span></span><br><span class="line"><span class="string">     &quot;Cluster Management&quot;. If any service is not</span></span><br><span class="line"><span class="string">     ready, please wait patiently until all components</span></span><br><span class="line"><span class="string">     are up and running.</span></span><br><span class="line"><span class="string">  2. Please change the default password after login.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#####################################################</span></span><br><span class="line"><span class="string">https://kubesphere.io             2024-10-09 14:08:38</span></span><br><span class="line"><span class="string">#####################################################</span></span><br><span class="line"><span class="string">14:08:40 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">14:08:40 CST Pipeline[CreateClusterPipeline] execute successfully</span></span><br><span class="line"><span class="string">Installation is complete.</span></span><br></pre></td></tr></table></figure><p>安装完成，通过以下命令检查安装是否正常。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l <span class="string">&#x27;app in (ks-install, ks-installer)&#x27;</span> -o jsonpath=<span class="string">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -f</span><br><span class="line">&gt; <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">&gt; kubectl get event -A -w</span><br><span class="line">&gt; kubectl get pod -A -w</span><br><span class="line">&gt; kubectl get sc</span><br></pre></td></tr></table></figure><p>访问 KubeSphere 控制台，界面如下。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubernetes/kubesphere-install-master.png"></p><h2 id="Worker-节点"><a href="#Worker-节点" class="headerlink" title="Worker 节点"></a>Worker 节点</h2><p>在服务器节点 10.2.2.140 和 10.2.2.211 执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">export</span> KKZONE=cn</span><br><span class="line">&gt; rsync -aAvz -e <span class="string">&#x27;ssh -p 22&#x27;</span> 10.2.2.109:/root/k3s /root/</span><br><span class="line">&gt; <span class="built_in">cd</span> k3s</span><br><span class="line">&gt; vim config-init.yaml</span><br><span class="line"><span class="comment"># 修改关键内容</span></span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - &#123;name: k3s-master, address: 10.2.2.109, internalAddress: 10.2.2.109, user: root, password: <span class="string">&quot;k3s-master@123&quot;</span>&#125;</span><br><span class="line">  - &#123;name: k3s-worker-01, address: 10.2.2.140, internalAddress: 10.2.2.140, user: root, password: <span class="string">&quot;k3s-worker01@123&quot;</span>&#125;</span><br><span class="line">  - &#123;name: k3s-worker-02, address: 10.2.2.211, internalAddress: 10.2.2.211, user: root, password: <span class="string">&quot;k3s-worker02@123&quot;</span>&#125;</span><br><span class="line">  roleGroups:</span><br><span class="line">    etcd:</span><br><span class="line">    - k3s-master</span><br><span class="line">    control-plane:</span><br><span class="line">    - k3s-master</span><br><span class="line">    worker:</span><br><span class="line">    - k3s-master</span><br><span class="line">    - k3s-worker-01</span><br><span class="line">    - k3s-worker-02</span><br></pre></td></tr></table></figure><p>使用 KubeKey 安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br></pre></td><td class="code"><pre><span class="line">&gt; ./kk add nodes -f config-init.yaml</span><br><span class="line"></span><br><span class="line">_   __      _          _   __</span><br><span class="line">| | / /     | |        | | / /</span><br><span class="line">| |/ / _   _| |__   ___| |/ /  ___ _   _</span><br><span class="line">|    \| | | | <span class="string">&#x27;_ \ / _ \    \ / _ \ | | |</span></span><br><span class="line"><span class="string">| |\  \ |_| | |_) |  __/ |\  \  __/ |_| |</span></span><br><span class="line"><span class="string">\_| \_/\__,_|_.__/ \___\_| \_/\___|\__, |</span></span><br><span class="line"><span class="string">                                    __/ |</span></span><br><span class="line"><span class="string">                                   |___/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">15:26:05 CST [GreetingsModule] Greetings</span></span><br><span class="line"><span class="string">15:26:05 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">Greetings, KubeKey!</span></span><br><span class="line"><span class="string">15:26:06 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">Greetings, KubeKey!</span></span><br><span class="line"><span class="string">15:26:06 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">Greetings, KubeKey!</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:26:06 CST [NodePreCheckModule] A pre-check on nodes</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:26:06 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:26:06 CST [ConfirmModule] Display confirmation form</span></span><br><span class="line"><span class="string">+---------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string">| name          | sudo | curl | openssl | ebtables | socat | ipset | ipvsadm | conntrack | chrony | docker | containerd | nfs client | ceph client | glusterfs client | time         |</span></span><br><span class="line"><span class="string">+---------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string">| k3s-master    | y    | y    | y       | y        | y     | y     | y       | y         | y      |        | v1.7.13    | y          |             |                  | CST 15:26:06 |</span></span><br><span class="line"><span class="string">| k3s-worker-01 | y    | y    | y       | y        | y     | y     | y       | y         | y      |        | v1.7.13    | y          |             |                  | CST 15:26:06 |</span></span><br><span class="line"><span class="string">| k3s-worker-02 | y    | y    | y       | y        | y     | y     | y       | y         | y      |        | v1.7.13    | y          |             |                  | CST 15:26:06 |</span></span><br><span class="line"><span class="string">+---------------+------+------+---------+----------+-------+-------+---------+-----------+--------+--------+------------+------------+-------------+------------------+--------------+</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a simple check of your environment.</span></span><br><span class="line"><span class="string">Before installation, ensure that your machines meet all requirements specified at</span></span><br><span class="line"><span class="string">https://github.com/kubesphere/kubekey#requirements-and-recommendations</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Install k8s with specify version:  v1.24.17</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Continue this installation? [yes/no]: yes</span></span><br><span class="line"><span class="string">15:26:08 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">15:26:08 CST [NodeBinariesModule] Download installation binaries</span></span><br><span class="line"><span class="string">15:26:08 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubeadm v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 43.4M  100 43.4M    0     0   904k      0  0:00:49  0:00:49 --:--:-- 1084k</span></span><br><span class="line"><span class="string">15:26:57 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubelet v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100  112M  100  112M    0     0   973k      0  0:01:58  0:01:58 --:--:-- 1088k</span></span><br><span class="line"><span class="string">15:28:56 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubectl v1.24.17 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 44.5M  100 44.5M    0     0   910k      0  0:00:50  0:00:50 --:--:-- 1087k</span></span><br><span class="line"><span class="string">15:29:47 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 helm v3.14.3 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 48.3M  100 48.3M    0     0   915k      0  0:00:54  0:00:54 --:--:-- 1076k</span></span><br><span class="line"><span class="string">15:30:41 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 kubecni v1.2.0 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 38.6M  100 38.6M    0     0   893k      0  0:00:44  0:00:44 --:--:-- 1088k</span></span><br><span class="line"><span class="string">15:31:25 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 crictl v1.29.0 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 23.2M  100 23.2M    0     0   821k      0  0:00:28  0:00:28 --:--:-- 1065k</span></span><br><span class="line"><span class="string">15:31:54 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 etcd v3.5.13 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 19.1M  100 19.1M    0     0   789k      0  0:00:24  0:00:24 --:--:-- 1062k</span></span><br><span class="line"><span class="string">15:32:19 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 containerd 1.7.13 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 45.7M  100 45.7M    0     0   910k      0  0:00:51  0:00:51 --:--:-- 1077k</span></span><br><span class="line"><span class="string">15:33:11 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 runc v1.1.12 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 10.2M  100 10.2M    0     0   660k      0  0:00:15  0:00:15 --:--:-- 1078k</span></span><br><span class="line"><span class="string">15:33:27 CST message: [localhost]</span></span><br><span class="line"><span class="string">downloading amd64 calicoctl v3.27.4 ...</span></span><br><span class="line"><span class="string">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line"><span class="string">                                 Dload  Upload   Total   Spent    Left  Speed</span></span><br><span class="line"><span class="string">100 61.3M  100 61.3M    0     0   933k      0  0:01:07  0:01:07 --:--:-- 1026k</span></span><br><span class="line"><span class="string">15:34:34 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">15:34:34 CST [ConfigureOSModule] Get OS release</span></span><br><span class="line"><span class="string">15:34:34 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:34 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:34 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:34 CST [ConfigureOSModule] Prepare to init OS</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:36 CST [ConfigureOSModule] Generate init os script</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:36 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:36 CST [ConfigureOSModule] Exec init os script</span></span><br><span class="line"><span class="string">15:34:39 CST stdout: [k3s-worker-01]</span></span><br><span class="line"><span class="string">setenforce: SELinux is disabled</span></span><br><span class="line"><span class="string">Disabled</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_source_route = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_redirects = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.icmp_echo_ignore_broadcasts = 1</span></span><br><span class="line"><span class="string">net.ipv4.icmp_ignore_bogus_error_responses = 1</span></span><br><span class="line"><span class="string">kernel.sched_child_runs_first = 1</span></span><br><span class="line"><span class="string">kernel.sched_latency_ns = 80000000</span></span><br><span class="line"><span class="string">kernel.sched_migration_cost_ns = 125000</span></span><br><span class="line"><span class="string">kernel.sched_min_granularity_ns = 40000000</span></span><br><span class="line"><span class="string">kernel.sched_wakeup_granularity_ns = 3750000</span></span><br><span class="line"><span class="string">kernel.sched_nr_migrate = 128</span></span><br><span class="line"><span class="string">kernel.pid_max = 65535</span></span><br><span class="line"><span class="string">kernel.msgmax = 2097152</span></span><br><span class="line"><span class="string">kernel.msgmnb = 4194304</span></span><br><span class="line"><span class="string">kernel.shmmni = 32768</span></span><br><span class="line"><span class="string">kernel.sem = 2000 256000 256 1024</span></span><br><span class="line"><span class="string">vm.overcommit_memory = 0</span></span><br><span class="line"><span class="string">vm.max_map_count = 262144</span></span><br><span class="line"><span class="string">vm.swappiness = 0</span></span><br><span class="line"><span class="string">vm.dirty_background_ratio = 40</span></span><br><span class="line"><span class="string">vm.dirty_ratio = 50</span></span><br><span class="line"><span class="string">fs.aio-max-nr = 262144</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances = 524288</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches = 524288</span></span><br><span class="line"><span class="string">net.core.rps_sock_flow_entries = 65536</span></span><br><span class="line"><span class="string">net.core.dev_weight = 1024</span></span><br><span class="line"><span class="string">net.core.busy_poll = 200</span></span><br><span class="line"><span class="string">net.core.busy_read = 200</span></span><br><span class="line"><span class="string">net.ipv4.tcp_moderate_rcvbuf = 1</span></span><br><span class="line"><span class="string">net.core.somaxconn = 32768</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 65535</span></span><br><span class="line"><span class="string">net.core.netdev_budget = 4800</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1 = 512</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2 = 2048</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3 = 4096</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.unres_qlen_bytes = 262144</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max = 1048576</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_tcp_timeout_established = 300</span></span><br><span class="line"><span class="string">sysctl: setting key &quot;net.netfilter.nf_conntrack_buckets&quot;: No such file or directory</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_high_thresh = 16777216</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_low_thresh = 12582912</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.udp_rmem_min = 131072</span></span><br><span class="line"><span class="string">net.ipv4.udp_wmem_min = 131072</span></span><br><span class="line"><span class="string">net.core.rmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.rmem_max = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_max = 33554432</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 5</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 600</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 10000 65000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-arptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_reserved_ports = 30000-32767</span></span><br><span class="line"><span class="string">net.ipv4.tcp_retries2 = 15</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 65535</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl = 30</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 10</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_ignore = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_ignore = 1</span></span><br><span class="line"><span class="string">fs.pipe-max-size = 4194304</span></span><br><span class="line"><span class="string">kernel.watchdog_thresh = 5</span></span><br><span class="line"><span class="string">kernel.hung_task_timeout_secs = 5</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.default.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.lo.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.forwarding = 1</span></span><br><span class="line"><span class="string">15:34:39 CST stdout: [k3s-worker-02]</span></span><br><span class="line"><span class="string">setenforce: SELinux is disabled</span></span><br><span class="line"><span class="string">Disabled</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_source_route = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_redirects = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.icmp_echo_ignore_broadcasts = 1</span></span><br><span class="line"><span class="string">net.ipv4.icmp_ignore_bogus_error_responses = 1</span></span><br><span class="line"><span class="string">kernel.sched_child_runs_first = 1</span></span><br><span class="line"><span class="string">kernel.sched_latency_ns = 80000000</span></span><br><span class="line"><span class="string">kernel.sched_migration_cost_ns = 125000</span></span><br><span class="line"><span class="string">kernel.sched_min_granularity_ns = 40000000</span></span><br><span class="line"><span class="string">kernel.sched_wakeup_granularity_ns = 3750000</span></span><br><span class="line"><span class="string">kernel.sched_nr_migrate = 128</span></span><br><span class="line"><span class="string">kernel.pid_max = 65535</span></span><br><span class="line"><span class="string">kernel.msgmax = 2097152</span></span><br><span class="line"><span class="string">kernel.msgmnb = 4194304</span></span><br><span class="line"><span class="string">kernel.shmmni = 32768</span></span><br><span class="line"><span class="string">kernel.sem = 2000 256000 256 1024</span></span><br><span class="line"><span class="string">vm.overcommit_memory = 0</span></span><br><span class="line"><span class="string">vm.max_map_count = 262144</span></span><br><span class="line"><span class="string">vm.swappiness = 0</span></span><br><span class="line"><span class="string">vm.dirty_background_ratio = 40</span></span><br><span class="line"><span class="string">vm.dirty_ratio = 50</span></span><br><span class="line"><span class="string">fs.aio-max-nr = 262144</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances = 524288</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches = 524288</span></span><br><span class="line"><span class="string">net.core.rps_sock_flow_entries = 65536</span></span><br><span class="line"><span class="string">net.core.dev_weight = 1024</span></span><br><span class="line"><span class="string">net.core.busy_poll = 200</span></span><br><span class="line"><span class="string">net.core.busy_read = 200</span></span><br><span class="line"><span class="string">net.ipv4.tcp_moderate_rcvbuf = 1</span></span><br><span class="line"><span class="string">net.core.somaxconn = 32768</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 65535</span></span><br><span class="line"><span class="string">net.core.netdev_budget = 4800</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1 = 512</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2 = 2048</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3 = 4096</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.unres_qlen_bytes = 262144</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max = 1048576</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_tcp_timeout_established = 300</span></span><br><span class="line"><span class="string">sysctl: setting key &quot;net.netfilter.nf_conntrack_buckets&quot;: No such file or directory</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_high_thresh = 16777216</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_low_thresh = 12582912</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.udp_rmem_min = 131072</span></span><br><span class="line"><span class="string">net.ipv4.udp_wmem_min = 131072</span></span><br><span class="line"><span class="string">net.core.rmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.rmem_max = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_max = 33554432</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 5</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 600</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 10000 65000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-arptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_reserved_ports = 30000-32767</span></span><br><span class="line"><span class="string">net.ipv4.tcp_retries2 = 15</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 65535</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl = 30</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 10</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_ignore = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_ignore = 1</span></span><br><span class="line"><span class="string">fs.pipe-max-size = 4194304</span></span><br><span class="line"><span class="string">kernel.watchdog_thresh = 5</span></span><br><span class="line"><span class="string">kernel.hung_task_timeout_secs = 5</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.default.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.lo.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.forwarding = 1</span></span><br><span class="line"><span class="string">15:34:40 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">setenforce: SELinux is disabled</span></span><br><span class="line"><span class="string">Disabled</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_source_route = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.accept_redirects = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.icmp_echo_ignore_broadcasts = 1</span></span><br><span class="line"><span class="string">net.ipv4.icmp_ignore_bogus_error_responses = 1</span></span><br><span class="line"><span class="string">kernel.sched_child_runs_first = 1</span></span><br><span class="line"><span class="string">kernel.sched_latency_ns = 80000000</span></span><br><span class="line"><span class="string">kernel.sched_migration_cost_ns = 125000</span></span><br><span class="line"><span class="string">kernel.sched_min_granularity_ns = 40000000</span></span><br><span class="line"><span class="string">kernel.sched_wakeup_granularity_ns = 3750000</span></span><br><span class="line"><span class="string">kernel.sched_nr_migrate = 128</span></span><br><span class="line"><span class="string">kernel.pid_max = 65535</span></span><br><span class="line"><span class="string">kernel.msgmax = 2097152</span></span><br><span class="line"><span class="string">kernel.msgmnb = 4194304</span></span><br><span class="line"><span class="string">kernel.shmmni = 32768</span></span><br><span class="line"><span class="string">kernel.sem = 2000 256000 256 1024</span></span><br><span class="line"><span class="string">vm.overcommit_memory = 0</span></span><br><span class="line"><span class="string">vm.max_map_count = 262144</span></span><br><span class="line"><span class="string">vm.swappiness = 0</span></span><br><span class="line"><span class="string">vm.dirty_background_ratio = 40</span></span><br><span class="line"><span class="string">vm.dirty_ratio = 50</span></span><br><span class="line"><span class="string">fs.aio-max-nr = 262144</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances = 524288</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches = 524288</span></span><br><span class="line"><span class="string">net.core.rps_sock_flow_entries = 65536</span></span><br><span class="line"><span class="string">net.core.dev_weight = 1024</span></span><br><span class="line"><span class="string">net.core.busy_poll = 200</span></span><br><span class="line"><span class="string">net.core.busy_read = 200</span></span><br><span class="line"><span class="string">net.ipv4.tcp_moderate_rcvbuf = 1</span></span><br><span class="line"><span class="string">net.core.somaxconn = 32768</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 65535</span></span><br><span class="line"><span class="string">net.core.netdev_budget = 4800</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1 = 512</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2 = 2048</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3 = 4096</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.unres_qlen_bytes = 262144</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max = 1048576</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_tcp_timeout_established = 300</span></span><br><span class="line"><span class="string">sysctl: setting key &quot;net.netfilter.nf_conntrack_buckets&quot;: No such file or directory</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_high_thresh = 16777216</span></span><br><span class="line"><span class="string">net.ipv4.ipfrag_low_thresh = 12582912</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 8388608 16777216 67108864</span></span><br><span class="line"><span class="string">net.ipv4.udp_rmem_min = 131072</span></span><br><span class="line"><span class="string">net.ipv4.udp_wmem_min = 131072</span></span><br><span class="line"><span class="string">net.core.rmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_default = 33554432</span></span><br><span class="line"><span class="string">net.core.rmem_max = 33554432</span></span><br><span class="line"><span class="string">net.core.wmem_max = 33554432</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 5</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 600</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 10000 65000</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 1048576</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-arptables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_reserved_ports = 30000-32767</span></span><br><span class="line"><span class="string">net.ipv4.tcp_retries2 = 15</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_orphans = 65535</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_intvl = 30</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_probes = 10</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.rp_filter = 0</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_accept = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.arp_ignore = 1</span></span><br><span class="line"><span class="string">net.ipv4.conf.default.arp_ignore = 1</span></span><br><span class="line"><span class="string">fs.pipe-max-size = 4194304</span></span><br><span class="line"><span class="string">kernel.watchdog_thresh = 5</span></span><br><span class="line"><span class="string">kernel.hung_task_timeout_secs = 5</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.default.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.lo.disable_ipv6 = 0</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.forwarding = 1</span></span><br><span class="line"><span class="string">15:34:40 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:40 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:40 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:40 CST [ConfigureOSModule] configure the ntp server for each node</span></span><br><span class="line"><span class="string">15:34:40 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:40 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:40 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:40 CST [KubernetesStatusModule] Get kubernetes cluster status</span></span><br><span class="line"><span class="string">15:34:41 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">v1.24.17</span></span><br><span class="line"><span class="string">15:34:41 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">k3s-master      v1.24.17   [map[address:10.2.2.109 type:InternalIP] map[address:k3s-master type:Hostname]]</span></span><br><span class="line"><span class="string">k3s-worker-01   v1.24.17   [map[address:10.2.2.140 type:InternalIP] map[address:k3s-worker-01 type:Hostname]]</span></span><br><span class="line"><span class="string">15:34:42 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">W1009 15:34:42.019455   34906 utils.go:69] The recommended value for &quot;clusterDNS&quot; in &quot;KubeletConfiguration&quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]</span></span><br><span class="line"><span class="string">[upload-certs] Storing the certificates in Secret &quot;kubeadm-certs&quot; in the &quot;kube-system&quot; Namespace</span></span><br><span class="line"><span class="string">[upload-certs] Using certificate key:</span></span><br><span class="line"><span class="string">56a046cb392827bf42cec14effc1b0d27c3722e741e53ff9c5139d4c943b9efd</span></span><br><span class="line"><span class="string">15:34:42 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">15:34:42 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">15:34:42 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">secret/kubeadm-certs patched</span></span><br><span class="line"><span class="string">15:34:43 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">0x3xku.uqjzfg1xclpwfkey</span></span><br><span class="line"><span class="string">15:34:43 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:43 CST [InstallContainerModule] Sync containerd binaries</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:43 CST [InstallContainerModule] Generate containerd service</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:43 CST [InstallContainerModule] Generate containerd config</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:43 CST [InstallContainerModule] Enable containerd</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:43 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:43 CST [InstallContainerModule] Sync crictl binaries</span></span><br><span class="line"><span class="string">15:34:44 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:44 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:44 CST skipped: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:44 CST [InstallContainerModule] Generate crictl config</span></span><br><span class="line"><span class="string">15:34:44 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:44 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:44 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:44 CST [PullModule] Start to pull images on all nodes</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.7</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.7</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.7</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-proxy:v1.24.17</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.8.6</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/k8s-dns-node-cache:1.22.20</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-apiserver:v1.24.17</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controllers:v3.27.4</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.27.4</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controller-manager:v1.24.17</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/node:v3.27.4</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-scheduler:v1.24.17</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-worker-02]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pod2daemon-flexvol:v3.27.4</span></span><br><span class="line"><span class="string">15:34:44 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-proxy:v1.24.17</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.8.6</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/k8s-dns-node-cache:1.22.20</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controllers:v3.27.4</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.27.4</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/node:v3.27.4</span></span><br><span class="line"><span class="string">15:34:45 CST message: [k3s-master]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pod2daemon-flexvol:v3.27.4</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-proxy:v1.24.17</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/coredns:1.8.6</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/k8s-dns-node-cache:1.22.20</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/kube-controllers:v3.27.4</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/cni:v3.27.4</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/node:v3.27.4</span></span><br><span class="line"><span class="string">15:34:46 CST message: [k3s-worker-01]</span></span><br><span class="line"><span class="string">downloading image: registry.cn-beijing.aliyuncs.com/kubesphereio/pod2daemon-flexvol:v3.27.4</span></span><br><span class="line"><span class="string">15:34:46 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:34:46 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:46 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:34:46 CST [ETCDPreCheckModule] Get etcd status</span></span><br><span class="line"><span class="string">15:34:46 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">ETCD_NAME=etcd-k3s-master</span></span><br><span class="line"><span class="string">15:34:46 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:46 CST [CertsModule] Fetch etcd certs</span></span><br><span class="line"><span class="string">15:34:47 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:47 CST [CertsModule] Generate etcd Certs</span></span><br><span class="line"><span class="string">[certs] Using existing ca certificate authority</span></span><br><span class="line"><span class="string">[certs] Using existing admin-k3s-master certificate and key on disk</span></span><br><span class="line"><span class="string">[certs] Using existing member-k3s-master certificate and key on disk</span></span><br><span class="line"><span class="string">[certs] Using existing node-k3s-master certificate and key on disk</span></span><br><span class="line"><span class="string">15:34:47 CST success: [LocalHost]</span></span><br><span class="line"><span class="string">15:34:47 CST [CertsModule] Synchronize certs file</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [CertsModule] Synchronize certs file to master</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [InstallETCDBinaryModule] Install etcd using binary</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [InstallETCDBinaryModule] Generate etcd service</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [InstallETCDBinaryModule] Generate access address</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Health check on exist etcd</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Generate etcd.env config on new etcd</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Join etcd member</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Health check on new etcd</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Check etcd member</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Refresh etcd.env config on all etcd</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Restart etcd</span></span><br><span class="line"><span class="string">15:34:50 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDConfigureModule] Health check on all etcd</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDBackupModule] Backup etcd data regularly</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDBackupModule] Generate backup ETCD service</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDBackupModule] Generate backup ETCD timer</span></span><br><span class="line"><span class="string">15:34:50 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:50 CST [ETCDBackupModule] Enable backup etcd service</span></span><br><span class="line"><span class="string">15:34:51 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:34:51 CST [InstallKubeBinariesModule] Synchronize kubernetes binaries</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:00 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:00 CST [InstallKubeBinariesModule] Change kubelet mode</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:00 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:00 CST [InstallKubeBinariesModule] Generate kubelet service</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:00 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:00 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:00 CST [InstallKubeBinariesModule] Enable kubelet service</span></span><br><span class="line"><span class="string">15:35:01 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:01 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:01 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:01 CST [InstallKubeBinariesModule] Generate kubelet env</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:02 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:02 CST [JoinNodesModule] Generate kubeadm config</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:02 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:02 CST [JoinNodesModule] Generate audit policy</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:02 CST [JoinNodesModule] Generate audit webhook</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:02 CST [JoinNodesModule] Join control-plane node</span></span><br><span class="line"><span class="string">15:35:02 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:02 CST [JoinNodesModule] Join worker node</span></span><br><span class="line"><span class="string">15:35:17 CST stdout: [k3s-worker-02]</span></span><br><span class="line"><span class="string">[preflight] Running pre-flight checks</span></span><br><span class="line"><span class="string">[preflight] Reading configuration from the cluster...</span></span><br><span class="line"><span class="string">[preflight] FYI: You can look at this config file with &#x27;</span>kubectl -n kube-system get cm kubeadm-config -o yaml<span class="string">&#x27;</span></span><br><span class="line"><span class="string">W1009 15:35:02.987472   10480 utils.go:69] The recommended value for &quot;clusterDNS&quot; in &quot;KubeletConfiguration&quot; is: [10.233.0.10]; the provided value is: [169.254.25.10]</span></span><br><span class="line"><span class="string">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line"><span class="string">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line"><span class="string">[kubelet-start] Starting the kubelet</span></span><br><span class="line"><span class="string">[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This node has joined the cluster:</span></span><br><span class="line"><span class="string">* Certificate signing request was sent to apiserver and a response was received.</span></span><br><span class="line"><span class="string">* The Kubelet was informed of the new secure connection details.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Run &#x27;</span>kubectl get nodes<span class="string">&#x27; on the control-plane to see this node join the cluster.</span></span><br><span class="line"><span class="string">15:35:17 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:17 CST skipped: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:17 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:17 CST [JoinNodesModule] Copy admin.conf to ~/.kube/config</span></span><br><span class="line"><span class="string">15:35:17 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:17 CST [JoinNodesModule] Remove master taint</span></span><br><span class="line"><span class="string">15:35:17 CST skipped: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:17 CST [JoinNodesModule] Add worker label to all nodes</span></span><br><span class="line"><span class="string">15:35:18 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-master not labeled</span></span><br><span class="line"><span class="string">15:35:18 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-worker-01 not labeled</span></span><br><span class="line"><span class="string">15:35:18 CST stdout: [k3s-master]</span></span><br><span class="line"><span class="string">node/k3s-worker-02 labeled</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:18 CST [ConfigureKubernetesModule] Configure kubernetes</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:18 CST [ChownModule] Chown user $HOME/.kube dir</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-worker-02]</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-worker-01]</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:18 CST [AutoRenewCertsModule] Generate k8s certs renew script</span></span><br><span class="line"><span class="string">15:35:18 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:18 CST [AutoRenewCertsModule] Generate k8s certs renew service</span></span><br><span class="line"><span class="string">15:35:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:19 CST [AutoRenewCertsModule] Generate k8s certs renew timer</span></span><br><span class="line"><span class="string">15:35:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:19 CST [AutoRenewCertsModule] Enable k8s certs renew service</span></span><br><span class="line"><span class="string">15:35:19 CST success: [k3s-master]</span></span><br><span class="line"><span class="string">15:35:19 CST Pipeline[AddNodesPipeline] execute successfully</span></span><br></pre></td></tr></table></figure><p>验证集群状态。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; kubectl get node,cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span><br><span class="line">NAME                 STATUS   ROLES                  AGE    VERSION</span><br><span class="line">node/k3s-master      Ready    control-plane,worker   108m   v1.24.17</span><br><span class="line">node/k3s-worker-01   Ready    worker                 20m    v1.24.17</span><br><span class="line">node/k3s-worker-02   Ready    worker                 99s    v1.24.17</span><br><span class="line"></span><br><span class="line">NAME                                 STATUS    MESSAGE                         ERROR</span><br><span class="line">componentstatus/scheduler            Healthy   ok</span><br><span class="line">componentstatus/controller-manager   Healthy   ok</span><br><span class="line">componentstatus/etcd-0               Healthy   &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>,<span class="string">&quot;reason&quot;</span>:<span class="string">&quot;&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>查看控制台，Worker 节点成功接入集群。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/kubernetes/kubesphere-install-worker.png"></p><p>为方便使用，建议修改 NodePort 的端口范围，在所有服务器节点执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line"></span><br><span class="line">  - --service-node-port-range=1-65535</span><br><span class="line">  </span><br><span class="line">&gt; systemctl daemon-reload</span><br><span class="line">&gt; systemctl restart kubelet</span><br></pre></td></tr></table></figure><h2 id="基于-NFS-服务器创建存储类"><a href="#基于-NFS-服务器创建存储类" class="headerlink" title="基于 NFS 服务器创建存储类"></a>基于 NFS 服务器创建存储类</h2><p>在所有服务器节点执行。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line">&gt; helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建名为 data-nfs-client 的存储类，用于存储数据</span></span><br><span class="line">&gt; helm install data-nfs-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner --<span class="built_in">set</span> nfs.server=10.2.1.9 --<span class="built_in">set</span> nfs.path=/nfs/kubesphere/data --<span class="built_in">set</span> replicaCount=3 --<span class="built_in">set</span> storageClass.name=data-nfs-client --<span class="built_in">set</span> storageClass.provisionerName=nfs-data --<span class="built_in">set</span> storageClass.accessModes=ReadWriteMany --<span class="built_in">set</span> nfs.volumeName=data-nfs-root --<span class="built_in">set</span> image.repository=m.daocloud.io/registry.k8s.io/sig-storage/nfs-subdir-external-provisioner</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建名为 log-nfs-client 的存储类，用于存储日志</span></span><br><span class="line">&gt; helm install log-nfs-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner --<span class="built_in">set</span> nfs.server=10.2.1.9 --<span class="built_in">set</span> nfs.path=/nfs/kubesphere/log --<span class="built_in">set</span> replicaCount=1 --<span class="built_in">set</span> storageClass.name=log-nfs-client --<span class="built_in">set</span> storageClass.provisionerName=nfs-log --<span class="built_in">set</span> storageClass.accessModes=ReadWriteMany --<span class="built_in">set</span> nfs.volumeName=log-nfs-root --<span class="built_in">set</span> image.repository=m.daocloud.io/registry.k8s.io/sig-storage/nfs-subdir-external-provisioner</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建名为 config-nfs-client 的存储类，用于存储配置</span></span><br><span class="line">&gt; helm install config-nfs-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner --<span class="built_in">set</span> nfs.server=10.2.1.9 --<span class="built_in">set</span> nfs.path=/nfs/kubesphere/config --<span class="built_in">set</span> replicaCount=3 --<span class="built_in">set</span> storageClass.name=config-nfs-client --<span class="built_in">set</span> storageClass.provisionerName=nfs-config --<span class="built_in">set</span> storageClass.accessModes=ReadWriteMany --<span class="built_in">set</span> nfs.volumeName=config-nfs-root --<span class="built_in">set</span> image.repository=m.daocloud.io/registry.k8s.io/sig-storage/nfs-subdir-external-provisioner</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认的存储类为数据盘</span></span><br><span class="line">&gt; kubectl patch storageclass data-nfs-client -p <span class="string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">storageclass.storage.k8s.io/data-nfs-client patched</span><br></pre></td></tr></table></figure><h2 id="调整镜像仓库代理地址"><a href="#调整镜像仓库代理地址" class="headerlink" title="调整镜像仓库代理地址"></a>调整镜像仓库代理地址</h2><p>如果您无法访问 DockerHub，需要调整对应的 Docker 或者 Containerd 配置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 K8s 使用 CONTAINER-TUNTIME 是 containerd:// 还是 docker://</span></span><br><span class="line">&gt; kubectl get nodes -o wide</span><br><span class="line">NAME            STATUS   ROLES                  AGE     VERSION    INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION                 CONTAINER-RUNTIME</span><br><span class="line">k3s-master      Ready    control-plane,worker   3d23h   v1.24.17   10.2.2.109    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line">k3s-worker-01   Ready    worker                 3d22h   v1.24.17   10.2.2.140    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line">k3s-worker-02   Ready    worker                 3d22h   v1.24.17   10.2.2.211    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.119.1.el7.x86_64   containerd://1.6.33</span><br><span class="line"></span><br><span class="line"><span class="comment"># If use docker</span></span><br><span class="line">&gt; vim /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://m.daocloud.io&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">:wq</span><br><span class="line">&gt; sudo systemctl daemon-reload</span><br><span class="line">&gt; sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># If use containerd</span></span><br><span class="line">&gt; vim /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line">[plugins]</span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>]</span><br><span class="line">    ...</span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry]</span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://m.daocloud.io&quot;</span>]</span><br><span class="line"></span><br><span class="line">&gt; sudo systemctl daemon-reload</span><br><span class="line">&gt; sudo systemctl restart containerd</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> 高可用集群 </tag>
            
            <tag> 自建机房 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockerfile 构建 Spring Boot 应用优化</title>
      <link href="/2024/09/02/Dockerfile%20%E6%9E%84%E5%BB%BA%20Spring%20Boot%20%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96/"/>
      <url>/2024/09/02/Dockerfile%20%E6%9E%84%E5%BB%BA%20Spring%20Boot%20%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>早期我们对于 Docker 构建 Spring Boot 工程的方式很简单，直接构建生成 jar 可执行程序，通过 <code>java $JAVA_OPTS -jar</code> 启动。在 Kubernetes 环境下，如果要调整 JVM 参数，则通过 ConfigMap 维护 JAVA_OPTS 变量，如下：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-Xmn1G</span></span><br><span class="line"><span class="attr">-Xmx1G</span></span><br><span class="line"><span class="attr">-Xss256k</span></span><br><span class="line"><span class="attr">-Dspring.cloud.nacos.config.username</span>=<span class="string">nacos </span></span><br><span class="line"><span class="attr">-Dspring.cloud.nacos.config.password</span>=<span class="string">nacos</span></span><br><span class="line"><span class="attr">-Dspring.cloud.nacos.config.server-addr</span>=<span class="string">127.0.0.1:8848 </span></span><br></pre></td></tr></table></figure><p>在实际的生产环境，可能定义了十几个甚至上百个 Deployment，对应不同的 ConfigMap 文件，它们可能指向同一个 Nacos 配置中心。如果 Nacos 地址发生变化，维护起来非常困难。为了解决这个问题，我们应该优化下 Dockerfile 构建模板，把 JVM 参数和运行环境变量分离出去。</p><h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>制定一套标准 Docker 构建模板，简化 JVM 配置流程。</p><h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>首先从 Dockerfile 文件着手，需要考虑几个方面：</p><ol><li>镜像分层：分离基础镜像（固定）、辅助工具（固定）、Maven 依赖（基本不变）和应用程序代码（变化），并减少镜像体积，通过镜像缓存提高构建速度。</li><li>变量简化：提取研发团队比较关心的 JVM 参数作为环境变量，例如 XMS 最小堆、XMX 最大堆、XSS 线程栈、GC 模式、GC 日志、堆转储、开启大页内存等。</li><li>容器安全：基于最小权限原则，运行容器时，以非 root 用户运行，只允许持有特定目录的读写权限。</li><li>脚本分离：将启动脚本与 Dockerfile 分离，方便从 ConfigMap 维护。</li></ol><p>Dockerfile 内容如下，因 DockerHub 镜像仓库访问不稳定，代码使用了 <a href="https://github.com/DaoCloud/public-image-mirror">m.daocloud.io</a> 代理，您可以根据实际情况调整。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> m.daocloud.io/eclipse-temurin:<span class="number">11</span>-jdk-alpine AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定构建模块</span></span><br><span class="line"><span class="keyword">ARG</span> MODULE=eden-demo-cola-start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制必要文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$MODULE</span>/target/<span class="variable">$MODULE</span>.jar application.jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker/entrypoint.sh entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装最小依赖项</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s|https://dl-cdn.alpinelinux.org|https://mirrors.aliyun.com|g&#x27;</span> /etc/apk/repositories \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; apk update \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; apk add --no-cache tar binutils dos2unix \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; dos2unix entrypoint.sh \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; jdeps --ignore-missing-deps -q \</span></span><br><span class="line"><span class="language-bash">--recursive \</span></span><br><span class="line"><span class="language-bash">--multi-release 11 \</span></span><br><span class="line"><span class="language-bash">--print-module-deps \</span></span><br><span class="line"><span class="language-bash">--class-path <span class="string">&#x27;/BOOT-INF/lib/*&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">application.jar &gt; modules.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建运行环境</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="variable">$JAVA_HOME</span>/bin/jlink \</span></span><br><span class="line"><span class="language-bash">--verbose \</span></span><br><span class="line"><span class="language-bash">--add-modules $(<span class="built_in">cat</span> modules.txt),sun.misc \</span></span><br><span class="line"><span class="language-bash">--strip-debug \</span></span><br><span class="line"><span class="language-bash">--no-man-pages \</span></span><br><span class="line"><span class="language-bash">--no-header-files \</span></span><br><span class="line"><span class="language-bash">--compress=2 \</span></span><br><span class="line"><span class="language-bash">--output /jre</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Spring Boot 的分层模式提取 JAR 文件的依赖项</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> java -Djarmode=layertools -jar application.jar extract</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建容器镜像</span></span><br><span class="line"><span class="keyword">FROM</span> m.daocloud.io/alpine:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义元数据</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;梦想歌 &lt;shiyindaxiaojie@gmail.com&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&quot;1.0.0&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定构建参数</span></span><br><span class="line"><span class="keyword">ARG</span> <span class="keyword">USER</span>=tmpuser</span><br><span class="line"><span class="keyword">ARG</span> GROUP=tmpgroup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /opt/jdk/jdk-<span class="number">11</span></span><br><span class="line"><span class="keyword">ENV</span> PATH <span class="string">&quot;$&#123;JAVA_HOME&#125;/bin:$&#123;PATH&#125;&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> HOME <span class="string">&quot;/app&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> TZ <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> LANG <span class="string">&quot;C.UTF-8&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XMS <span class="string">&quot;1g&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XMX <span class="string">&quot;1g&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XSS <span class="string">&quot;256k&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> GC_MODE <span class="string">&quot;G1&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_GC_LOG <span class="string">&quot;Y&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_HEAP_DUMP <span class="string">&quot;Y&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_LARGE_PAGES <span class="string">&quot;N&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> SPRING_PROFILES_ACTIVE <span class="string">&quot;dev&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> SERVER_PORT <span class="string">&quot;8080&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> MANAGEMENT_SERVER_PORT <span class="string">&quot;9080&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置日志目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/logs \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">touch</span> <span class="variable">$HOME</span>/logs/entrypoint.out \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">ln</span> -sf /dev/stdout <span class="variable">$HOME</span>/logs/entrypoint.out \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">ln</span> -sf /dev/stderr <span class="variable">$HOME</span>/logs/entrypoint.out</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从基础镜像复制应用程序依赖项和模块</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /jre <span class="variable">$JAVA_HOME</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/dependencies/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/spring-boot-loader ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/organization-dependencies ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/modules-dependencies ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/snapshot-dependencies/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/application/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/entrypoint.sh ./</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建普通用户</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> addgroup -g 1000 <span class="variable">$GROUP</span> \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; adduser -u 1000 -G <span class="variable">$GROUP</span> -h <span class="variable">$HOME</span> -s /bin/bash -D <span class="variable">$USER</span> \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">chown</span> -R <span class="variable">$USER</span>:<span class="variable">$GROUP</span> <span class="variable">$HOME</span> \</span></span><br><span class="line"><span class="language-bash">&amp;&amp; <span class="built_in">chmod</span> -R a+rwX <span class="variable">$HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到容器用户</span></span><br><span class="line"><span class="keyword">USER</span> $<span class="keyword">USER</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露容器端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> $SERVER_PORT $MANAGEMENT_SERVER_PORT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置启动脚本</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;./entrypoint.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>笔者将启动脚本命名为 <code>entrypoint.sh</code>，内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">JAVA_MAJOR_VERSION=$(java -version 2&gt;&amp;1 | sed -E -n <span class="string">&#x27;s/.* version &quot;([0-9]*).*$/\1/p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -server&quot;</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UnlockExperimentalVMOptions -XX:+UnlockDiagnosticVMOptions&quot;</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+AlwaysPreTouch -XX:+PrintFlagsFinal -XX:-DisplayVMOutput -XX:-OmitStackTraceInFastThrow&quot;</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -Xms<span class="variable">$&#123;XMS:-1G&#125;</span> -Xmx<span class="variable">$&#123;XMX:-1G&#125;</span> -Xss<span class="variable">$&#123;XSS:-256K&#125;</span>&quot;</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:MetaspaceSize=<span class="variable">$&#123;METASPACE_SIZE:-128M&#125;</span> -XX:MaxMetaspaceSize=<span class="variable">$&#123;MAX_METASPACE_SIZE:-256M&#125;</span>&quot;</span></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:MaxGCPauseMillis=<span class="variable">$&#123;MAX_GC_PAUSE_MILLIS:-200&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;GC_MODE&#125;</span>&quot;</span> = <span class="string">&quot;ShenandoahGC&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GC mode is ShenandoahGC&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseShenandoahGC&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$&#123;GC_MODE&#125;</span>&quot;</span> = <span class="string">&quot;ZGC&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GC mode is ZGC&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseZGC&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$&#123;GC_MODE&#125;</span>&quot;</span> = <span class="string">&quot;G1&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GC mode is G1&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseG1GC&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:InitiatingHeapOccupancyPercent=<span class="variable">$&#123;INITIATING_HEAP_OCCUPANCY_PERCENT:-45&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:G1ReservePercent=<span class="variable">$&#123;G1_RESERVE_PERCENT:-10&#125;</span> -XX:G1HeapWastePercent=<span class="variable">$&#123;G1_HEAP_WASTE_PERCENT:-5&#125;</span> &quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:G1NewSizePercent=<span class="variable">$&#123;G1_NEW_SIZE_PERCENT:-50&#125;</span> -XX:G1MaxNewSizePercent=<span class="variable">$&#123;G1_MAX_NEW_SIZE_PERCENT:-50&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:G1MixedGCCountTarget=<span class="variable">$&#123;G1_MIXED_GCCOUNT_TARGET:-8&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:G1MixedGCLiveThresholdPercent=<span class="variable">$&#123;G1_MIXED_GCLIVE_THRESHOLD_PERCENT:-65&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseStringDeduplication -XX:+ParallelRefProcEnabled&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="string">&quot;<span class="variable">$&#123;GC_MODE&#125;</span>&quot;</span> = <span class="string">&quot;CMS&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GC mode is CMS&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseConcMarkSweepGC -Xmn<span class="variable">$&#123;XMN:-512m&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:ParallelGCThreads=<span class="variable">$&#123;PARALLEL_GC_THREADS:-2&#125;</span> -XX:ConcGCThreads=<span class="variable">$&#123;CONC_GC_THREADS:-1&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=<span class="variable">$&#123;CMS_INITIATING_HEAP_OCCUPANCY_PERCENT:-92&#125;</span>&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+CMSClassUnloadingEnabled -XX:+CMSScavengeBeforeRemark&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$JAVA_MAJOR_VERSION</span>&quot;</span> -le <span class="string">&quot;8&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+CMSIncrementalMode -XX:CMSFullGCsBeforeCompaction=<span class="variable">$&#123;CMS_FULL_GCS_BEFORE_COMPACTION:-5&#125;</span>&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+ExplicitGCInvokesConcurrent -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;USE_GC_LOG&#125;</span>&quot;</span> = <span class="string">&quot;Y&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;GC log path is &#x27;<span class="variable">$&#123;HOME&#125;</span>/logs/jvm_gc.log&#x27;.&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+PrintVMOptions&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$JAVA_MAJOR_VERSION</span>&quot;</span> -gt <span class="string">&quot;8&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -Xlog:gc:file=<span class="variable">$&#123;HOME&#125;</span>/logs/jvm_gc-%p-%t.log:tags,uptime,time,level:filecount=<span class="variable">$&#123;GC_LOG_FILE_COUNT:-10&#125;</span>,filesize=<span class="variable">$&#123;GC_LOG_FILE_SIZE:-100M&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -Xloggc:<span class="variable">$&#123;HOME&#125;</span>/logs/jvm_gc.log -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=<span class="variable">$&#123;GC_LOG_FILE_COUNT:-10&#125;</span> -XX:GCLogFileSize=<span class="variable">$&#123;GC_LOG_FILE_SIZE:-100M&#125;</span>&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+PrintGCCause -XX:+PrintGCApplicationStoppedTime&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+PrintTLAB -XX:+PrintReferenceGC -XX:+PrintHeapAtGC&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+FlightRecorder -XX:+PrintSafepointStatistics -XX:PrintSafepointStatisticsCount=1&quot;</span></span><br><span class="line">        JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+DebugNonSafepoints -XX:+SafepointTimeout -XX:SafepointTimeoutDelay=500&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$&#123;HOME&#125;</span>/logs&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">mkdir</span> <span class="variable">$&#123;HOME&#125;</span>/logs</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;USE_HEAP_DUMP&#125;</span>&quot;</span> = <span class="string">&quot;Y&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Heap dump path is &#x27;<span class="variable">$&#123;HOME&#125;</span>/logs/jvm_heap_dump.hprof&#x27;.&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:HeapDumpPath=<span class="variable">$&#123;HOME&#125;</span>/logs/jvm_heap_dump.hprof -XX:+HeapDumpOnOutOfMemoryError&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;USE_LARGE_PAGES&#125;</span>&quot;</span> = <span class="string">&quot;Y&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Use large pages.&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -XX:+UseLargePages&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$&#123;JDWP_DEBUG:-N&#125;</span>&quot;</span> = <span class="string">&quot;Y&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Attach to remote JVM using port <span class="variable">$&#123;JDWP_PORT:-5005&#125;</span>.&quot;</span></span><br><span class="line">    JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -Xdebug -Xrunjdwp:transport=dt_socket,address=<span class="variable">$&#123;JDWP_PORT:-5005&#125;</span>,server=y,suspend=n&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">JAVA_OPTS=<span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS&#125;</span> -Dserver.port=<span class="variable">$&#123;SERVER_PORT&#125;</span> -Dmanagement.server.port=<span class="variable">$&#123;MANAGEMENT_SERVER_PORT&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> java <span class="variable">$JAVA_OPTS</span> -noverify -Djava.security.egd=file:/dev/./urandom <span class="string">&quot;org.springframework.boot.loader.JarLauncher&quot;</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure><p>脚本目前兼容 JDK8、JDK11、JDK17，主要提供了以下参数：</p><ol><li>GC_MODE：垃圾回收器，适配 <code>ShenandoahGC</code>、<code>ZGC</code>、<code>G1</code>、<code>CMS</code>。</li><li>USE_GC_LOG：是否启用 GC 日志，默认输出路径为 <code>$&#123;HOME&#125;/logs/jvm_gc*.log</code>。</li><li>USE_HEAP_DUMP：是否启用堆转储，默认输出路径为 <code>$&#123;HOME&#125;/logs/jvm_heap_dump.hprof</code>。</li><li>USE_LARGE_PAGES：是否启用大页。</li><li>JDWP_DEBUG：是否启用 <code>JDWP</code> 调试，默认端口为 <code>5005</code>。</li><li>SERVER_PORT：服务端口。</li><li>MANAGEMENT_SERVER_PORT：管理端口，访问路径为 <code>/actuator</code>。</li></ol><h1 id="产出"><a href="#产出" class="headerlink" title="产出"></a>产出</h1><p>为团队提供 JVM 标准模板，通过 JVM 细节做了封装，研发团队只需要微调 JVM 变量就可以启用堆转储和 GC 日志、DEBUG 模式等配置。</p><p>服务瘦身效果比较明显，给研发团队做了测试，构建体积从原来的 389 MB 缩小到 295 MB，基础镜像占用了 240 MB，也就是说 jar 从 149 MB 降到 45 MB，如下图。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/docker/docker-slim.png"></p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-demo-cola/tree/main/docker">eden-demo-cola</a> 项目。</p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 最佳实践 </tag>
            
            <tag> 镜像分层 </tag>
            
            <tag> 模板示例 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Log4j2 扩展日志脱敏插件</title>
      <link href="/2024/03/15/Log4j2%20%E6%89%A9%E5%B1%95%E6%97%A5%E5%BF%97%E8%84%B1%E6%95%8F%E6%8F%92%E4%BB%B6/"/>
      <url>/2024/03/15/Log4j2%20%E6%89%A9%E5%B1%95%E6%97%A5%E5%BF%97%E8%84%B1%E6%95%8F%E6%8F%92%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>日志脱敏是常见的安全需求。为了金融交易的安全性，国家强制规定对于<strong>姓名</strong>、<strong>手机号</strong>、<strong>身份证号码</strong>、<strong>住址</strong>等信息需要数据脱敏。一般我们会采取注解的形式指定字段进行脱敏处理，但这样对代码的侵入性较高。假设公司有几十个系统要改造，或者采购了一些系统没有源代码，怎么办？还有，日志脱敏后，系统用户需要通过手机号找出对应的日志，怎么匹配？</p><h1>目标</h1><p>实现一个零侵入性的日志插件，并能支持原始数据检索。</p><h1>实现</h1><p>我们调研了 Github 一些开源项目，发现 <a href="https://github.com/houbb/sensitive">https://github.com/houbb/sensitive</a> 能够满足这个需求，它通过 <code>Trie</code> 对字符进行处理，细节处理封装在 <code>com.github.houbb.chars.scan.bs.CharsScanBs</code>，我们只需要引入 <code>CharsScanBs.scanAndReplace(text)</code> 就可以实现对原始日志的脱敏处理，被脱敏的内容后面自动追加原始数据库的 MD5 信息，假设用户反馈系统问题，会提供他的手机号，我们将手机号生成 MD5，去脱敏日志文件匹配，就能定位到原始数据。</p><p>Log4j2 插件提供了两个扩展方式 <code>AbstractStringLayout</code> 和 <code>RewritePolicy</code>。在这里，我们定义了 <code>MaskingStringLayout</code> 对 <code>AbstractStringLayout</code> 进行扩展。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Plugin(name = &quot;MaskingStringLayout&quot;, category = Node.CATEGORY, elementType = Layout.ELEMENT_TYPE, printObject = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MaskingStringLayout</span> <span class="keyword">extends</span> <span class="title class_">AbstractStringLayout</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CharsScanBs charsScanBs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对日志内容进行脱敏处理</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toSerializable</span><span class="params">(LogEvent event)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (patternFormatterList == <span class="literal">null</span> || patternFormatterList.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> event.getMessage().getFormattedMessage();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (PatternFormatter formatter : patternFormatterList) &#123;</span><br><span class="line">            formatter.format(event, stringBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> charsScanBs.scanAndReplace(stringBuilder.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 log4j.yml 读取配置</span></span><br><span class="line">    <span class="meta">@PluginFactory</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> MaskingStringLayout <span class="title function_">createLayout</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginConfiguration</span> <span class="keyword">final</span> Configuration config,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;charset&quot;, defaultString = &quot;UTF-8&quot;)</span> String charset,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;pattern&quot;)</span> String pattern,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;type&quot;)</span> String type,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;prefix&quot;)</span> String prefix,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;scanList&quot;)</span> String scanList,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;replaceList&quot;)</span> String replaceList,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;defaultReplace&quot;)</span> String defaultReplace,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;replaceHash&quot;)</span> String replaceHash,</span></span><br><span class="line"><span class="params">        <span class="meta">@PluginAttribute(value = &quot;whiteList&quot;)</span> String whiteList)</span> &#123;</span><br><span class="line">            </span><br><span class="line">        <span class="type">MaskingConfig</span> <span class="variable">maskingConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MaskingConfig</span>();</span><br><span class="line">        <span class="keyword">if</span> (type != <span class="literal">null</span>) &#123;</span><br><span class="line">            maskingConfig.setType(type);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ... </span></span><br><span class="line">        <span class="type">MaskingStringLayout</span> <span class="variable">layout</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MaskingStringLayout</span>(Charset.forName(charset), maskingConfig);</span><br><span class="line">        layout.patternFormatterList = patternParser.parse(pattern);</span><br><span class="line">        <span class="keyword">return</span> layout;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的 <code>MaskingConfig</code> 配置类如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MaskingConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;chars-scan&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">CharsScan</span> <span class="variable">charsScan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CharsScan</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line">    <span class="meta">@ToString</span></span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CharsScan</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> <span class="string">&quot;：‘“，| ,:\\\&quot;&#x27;=&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">scanList</span> <span class="operator">=</span> <span class="string">&quot;TELEPHONE,ID_CARD,BANK_CARD,PASSPORT,ADDRESS,EMAIL&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">replaceList</span> <span class="operator">=</span> <span class="string">&quot;TELEPHONE,ID_CARD,BANK_CARD,PASSPORT,ADDRESS,EMAIL&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">defaultReplace</span> <span class="operator">=</span> <span class="string">&quot;ANY_PARTIALLY_MASKED&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">replaceHash</span> <span class="operator">=</span> <span class="string">&quot;md5&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">String</span> <span class="variable">whiteList</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 log4j2.yml 配置相关日志插件。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Configuration:</span></span><br><span class="line">  <span class="attr">status:</span> <span class="string">WARN</span></span><br><span class="line">  <span class="attr">monitorInterval:</span> <span class="number">30</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">Properties:</span></span><br><span class="line">    <span class="attr">Property:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MASKING_STRATEGIES</span> <span class="comment"># 脱敏策略</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">TELEPHONE,ID_CARD,BANK_CARD,PASSPORT,ADDRESS,EMAIL</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MASKING_REPLACEMENT</span> <span class="comment"># 脱敏格式：ANY_PARTIALLY_MASKED（匹配任意半掩盖），ANY_FULLY_MASKED（匹配任意全掩盖）</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">ANY_PARTIALLY_MASKED</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MASKING_HASH</span> <span class="comment"># 脱敏哈希</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;md5&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MASKING_WHITELIST</span> <span class="comment"># 脱敏白名单</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">Appenders:</span></span><br><span class="line">    <span class="attr">Console:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">STDOUT</span> <span class="comment"># 控制台</span></span><br><span class="line">      <span class="attr">target:</span> <span class="string">SYSTEM_OUT</span></span><br><span class="line">      <span class="attr">MaskingStringLayout:</span> <span class="comment"># 脱敏插件</span></span><br><span class="line">        <span class="attr">pattern:</span> <span class="string">$&#123;LOG_PATTERN&#125;</span></span><br><span class="line">        <span class="attr">strategies:</span> <span class="string">$&#123;MASKING_STRATEGIES&#125;</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$&#123;MASKING_REPLACEMENT&#125;</span></span><br><span class="line">        <span class="attr">hash:</span> <span class="string">$&#123;MASKING_HASH&#125;</span></span><br><span class="line">        <span class="attr">whitelist:</span> <span class="string">$&#123;MASKING_WHITELIST&#125;</span></span><br></pre></td></tr></table></figure><p>假设我要查询 18820132137 这个手机号的日志，可以通过 MD5 在线加密工具得到 MD5 值。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/log4j2/log4j2-md5-online.png" alt=""></p><p>搜索日志时，直接输入 MD5 值，就能定位到原始日志。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/log4j2/log4j2-console-relate.png" alt=""></p><h1>产出</h1><p>可以满足金融级别的监管合规检查，对业务零侵入，研发团队只需要在 log4j2.yml 引入我们提供的日志插件，就实现了日志脱敏，</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-solutions/eden-data-masker">eden-data-masker</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 扩展点 </tag>
            
            <tag> Log4j2 </tag>
            
            <tag> 数据脱敏 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring 扩展 Bean 动态注册和销毁</title>
      <link href="/2024/02/11/Spring%20%E6%89%A9%E5%B1%95%20Bean%20%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E5%92%8C%E9%94%80%E6%AF%81/"/>
      <url>/2024/02/11/Spring%20%E6%89%A9%E5%B1%95%20Bean%20%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E5%92%8C%E9%94%80%E6%AF%81/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>Spring Boot Starters 的自动装配机制给我们提供了非常丰富的扩展点，但有时候需要动态开启或者关闭某些组件，只能修改配置，重启服务才能生效。例如，我们接入了 Arthas 工具，有时候需要关闭，有时候需要开启，但又不能随意重启服务。</p><h1>目标</h1><p>监听 Spring Boot Starters 组件的配置变化，动态注册销毁 Bean。</p><h1>实现</h1><p>以 Arthas Spring Boot Starter 组件为例。我们发现 Spring Cloud 组件提供了 <code>EnvironmentChangeEvent</code> 作为配置变更事件，传入 <code>ApplicationListener</code> 监听器可以实现配置变化的监听，代码片段如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArthasEnvironmentChangeListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;EnvironmentChangeEvent&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ARTHAS_AGENT</span> <span class="operator">=</span> <span class="string">&quot;arthasAgent&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArthasProperties arthasProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; arthasConfigMap;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(EnvironmentChangeEvent event)</span> &#123;</span><br><span class="line">        Set&lt;String&gt; keys = event.getKeys();</span><br><span class="line">        <span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;spring.arthas.enabled&quot;</span>.equals(key)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Boolean.parseBoolean(environment.getProperty(key))) &#123;</span><br><span class="line">                    registerBean(); <span class="comment">// 注册 Bean</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    destroyBean(); <span class="comment">// 销毁 Bean</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">defaultListableBeanFactory</span> <span class="operator">=</span> getDefaultListableBeanFactory();</span><br><span class="line">        <span class="keyword">if</span> (defaultListableBeanFactory.containsBean(ARTHAS_AGENT)) &#123;  <span class="comment">// 检查 Bean 是否存在 Spring 缓存</span></span><br><span class="line">            defaultListableBeanFactory.getBean(ARTHAS_AGENT)).init(); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            defaultListableBeanFactory.registerSingleton(ARTHAS_AGENT, <span class="keyword">new</span> <span class="title class_">ArthasAgent</span>(arthasConfigMap, arthasProperties));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">destroyBean</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DefaultListableBeanFactory</span> <span class="variable">defaultListableBeanFactory</span> <span class="operator">=</span> getDefaultListableBeanFactory();</span><br><span class="line">        <span class="keyword">if</span> (defaultListableBeanFactory.containsBean(ARTHAS_AGENT)) &#123;</span><br><span class="line">            defaultListableBeanFactory.getBean(ARTHAS_AGENT)).destroy();</span><br><span class="line">            defaultListableBeanFactory.destroySingleton(ARTHAS_AGENT); <span class="comment">// 从 Spring 缓存移除 Bean</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> DefaultListableBeanFactory <span class="title function_">getDefaultListableBeanFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (DefaultListableBeanFactory) applicationContext.getAutowireCapableBeanFactory();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将 <code>ArthasEnvironmentChangeListener</code> 复制到 <code>ArthasAutoConfiguration</code> 类注册 Bean。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureBefore(ArthasConfiguration.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(&#123; SpringArthasProperties.class, ArthasProperties.class &#125;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArthasAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册监听器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ArthasEnvironmentChangeListener <span class="title function_">arthasEnvironmentChangeListener</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@Autowired</span> <span class="meta">@Qualifier(ARTHAS_CONFIG_MAP)</span> Map&lt;String, String&gt; arthasConfigMap)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArthasEnvironmentChangeListener</span>(applicationContext, environment, arthasProperties, arthasConfigMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动时判断是否开启，如果开启则注册 Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">        name = &#123;&quot;spring.arthas.enabled&quot;&#125;,</span></span><br><span class="line"><span class="meta">        matchIfMissing = true</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ArthasAgent <span class="title function_">arthasAgent</span><span class="params">(<span class="meta">@Autowired</span> <span class="meta">@Qualifier(ARTHAS_CONFIG_MAP)</span> Map&lt;String, String&gt; arthasConfigMap)</span> &#123;</span><br><span class="line">        arthasConfigMap = StringUtils.removeDashKey(arthasConfigMap);</span><br><span class="line">        <span class="keyword">return</span> init(arthasConfigMap, environment, arthasProperties); <span class="comment">// 初始化 Bean，细节省略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将 <code>ArthasAutoConfiguration</code> 类添加到 spring.factories 文件即可。</p><p>在 Nacos 设置 <code>spring.arthas.enabled=false</code>，期望关闭 Arthas。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-nacos-disabled-arthas.png" alt=""></p><p>从控制台可以看到 <code>Destroy arthas from ws:...</code> 字眼。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-java-destroy-arthas.png" alt=""></p><p>在 Nacos 设置 <code>spring.arthas.enabled=true</code>，期望开启 Arthas。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-nacos-enabled-arthas.png" alt=""></p><p>从控制台可以看到 <code>Register arthas to ws:...</code> 字眼。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-java-register-arthas.png" alt=""></p><h1>产出</h1><p>研发团队在生产环境的配置中心发布配置更新，可以实现应用零停机动态注册和销毁 Bean，解决了特定场景的需求。本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-arthas-spring-boot-starter">eden-arthas-spring-boot-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring 扩展 @AutoConfiguration 开关</title>
      <link href="/2024/01/02/Spring%20%E6%89%A9%E5%B1%95%20@AutoConfiguration%20%E5%BC%80%E5%85%B3/"/>
      <url>/2024/01/02/Spring%20%E6%89%A9%E5%B1%95%20@AutoConfiguration%20%E5%BC%80%E5%85%B3/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>Spring Boot Starters 提供了很多常用的组件，有些组件例如 <code>Kafka</code> 和 <code>RocketMQ</code>，引入到工程后会自动装配，它会检查您的配置，跟外部的组件创建一些连接，这个时候，我们很难控制 <code>Kafka</code> 关闭，<code>RocketMQ</code> 开启。</p><h1>目标</h1><p>给 Spring Boot Starters 的组件提供一个开关，控制自动装配。</p><h1>实现</h1><p>Spring Boot AutoCofiguration 提供了 <code>AutoConfigurationImportFilter</code> 过滤器，用来控制 <code>@Configuration</code> 配置类是否生效。查看 <code>AutoConfigurationImportSelector</code> 的源码，它会去调用 <code>AutoConfigurationImportFilter</code> 过滤器，传入所有的 <code>@Configuration</code> 配置类，通过 filter 方法筛选掉不需要的配置类，返回最新的配置类集合。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AutoConfigurationImportSelector</span> <span class="keyword">implements</span> <span class="title class_">DeferredImportSelector</span>, BeanClassLoaderAware, ResourceLoaderAware, BeanFactoryAware, EnvironmentAware, Ordered &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ConfigurationClassFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AutoConfigurationMetadata autoConfigurationMetadata;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;AutoConfigurationImportFilter&gt; filters;</span><br><span class="line"></span><br><span class="line">        ConfigurationClassFilter(ClassLoader classLoader, List&lt;AutoConfigurationImportFilter&gt; filters) &#123;</span><br><span class="line">            <span class="built_in">this</span>.autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(classLoader);</span><br><span class="line">            <span class="built_in">this</span>.filters = filters;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> AutoConfigurationEntry <span class="title function_">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">                <span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            configurations = getConfigurationClassFilter().filter(configurations); <span class="comment">// 过滤配置类</span></span><br><span class="line">            fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutoConfigurationEntry</span>(configurations, exclusions);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; <span class="title function_">filter</span><span class="params">(List&lt;String&gt; configurations)</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">            String[] candidates = StringUtils.toStringArray(configurations);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">skipped</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (AutoConfigurationImportFilter filter : <span class="built_in">this</span>.filters) &#123;</span><br><span class="line">                <span class="type">boolean</span>[] match = filter.match(candidates, <span class="built_in">this</span>.autoConfigurationMetadata);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; match.length; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!match[i]) &#123;</span><br><span class="line">                        candidates[i] = <span class="literal">null</span>;</span><br><span class="line">                        skipped = <span class="literal">true</span>; <span class="comment">// 为 true 表示自动装配失效</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!skipped) &#123;</span><br><span class="line">                <span class="keyword">return</span> configurations; <span class="comment">// 返回对象表示自动装配生效</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以 Kafka 为例，我们可以在 <code>src/main/resources/META-INF</code> 添加 <code>spring.factories</code> 文件，内容如下：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Auto Configuration Import Filters</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.AutoConfigurationImportFilter</span>=<span class="string">\</span></span><br><span class="line"><span class="string">  org.ylzl.spring.boot.kafka.autoconfigure.KafkaAutoConfigurationImportFilter</span></span><br></pre></td></tr></table></figure><p>对应的代码实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KafkaAutoConfigurationImportFilter</span> <span class="keyword">implements</span> <span class="title class_">AutoConfigurationImportFilter</span>, EnvironmentAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MATCH_KEY</span> <span class="operator">=</span> <span class="string">&quot;spring.kafka.enabled&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] IGNORE_CLASSES = &#123;</span><br><span class="line">      <span class="string">&quot;org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration&quot;</span>,</span><br><span class="line">      <span class="string">&quot;org.springframework.boot.actuate.autoconfigure.metrics.KafkaMetricsAutoConfiguration&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnvironment</span><span class="params">(<span class="meta">@NotNull</span> Environment environment)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span>[] match(String[] autoConfigurationClasses, AutoConfigurationMetadata autoConfigurationMetadata) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">disabled</span> <span class="operator">=</span> !Boolean.parseBoolean(environment.getProperty(MATCH_KEY, Conditions.TRUE));</span><br><span class="line">        <span class="type">boolean</span>[] match = <span class="keyword">new</span> <span class="title class_">boolean</span>[autoConfigurationClasses.length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; autoConfigurationClasses.length; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">            match[i] = !disabled || Arrays.stream(IGNORE_CLASSES).noneMatch(e -&gt; e.equals(autoConfigurationClasses[index]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> match; <span class="comment">// 如果 match 为 false，对应的配置类不生效</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码扩展完成，当设置 <code>spring.kafka.enabled=true</code> 时开启 Kafka，设置 <code>spring.kafka.enabled=false</code> 时关闭 Kafka。</p><h1>产出</h1><p>适用接入消息引擎、第三方支付平台、第三方短信服务等各种场景，研发团队引入了这个方案后，极大减少了维护成本，在切换厂商接口也能省下很多时间。并且，在引入第三方项目依赖也会遇到自动装配的问题，一般情况下，第三方依赖会引入多项配置，这些配置我们用不到，又修改不了相关源码，需要从扩展点屏蔽。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-kafka-spring-boot-starter">eden-kafka-spring-boot-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 binlog2sql 工具在线恢复数据</title>
      <link href="/2023/10/25/%E4%BD%BF%E7%94%A8%20binlog2sql%20%E5%B7%A5%E5%85%B7%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE/"/>
      <url>/2023/10/25/%E4%BD%BF%E7%94%A8%20binlog2sql%20%E5%B7%A5%E5%85%B7%E5%BF%AB%E9%80%9F%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>生产数据库执行 SQL 脚本，一般会经过正规的审批流程才能运行。但有些情况是例外的，业务部门在提出一些删除数据的需求后打算撤回，或者在运营后台不小心删除了一些数据，然后找到 DBA 团队协助，希望能恢复数据。</p><p>经调研，binlog2sql 是大众点评开源的一款用于解析 MySQL binlog 的工具，根据不同选项，可以得到原始SQL、回滚SQL、去除主键的INSERT SQL 等，适用于数据快速回滚（闪回）和主从切换后新 Master 丢数据的修复工作。</p><h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>验证 binlog2sql 工具是否可以快速恢复数据。</p><h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>安装 binlog2sql 工具。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; git <span class="built_in">clone</span> https://github.com/danfengcao/binlog2sql.git &amp;&amp; <span class="built_in">cd</span> binlog2sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># &gt; yum install python3-pip</span></span><br><span class="line"><span class="comment"># &gt; whereis pip</span></span><br><span class="line"><span class="comment"># &gt; pip3.6 install -r requirements.txt</span></span><br><span class="line">&gt; pip install -r requirements.txt</span><br></pre></td></tr></table></figure><p>MySQL 服务端配置以下参数，请注意，binlog2sql 仅支持 row 格式。</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">server_id</span> = <span class="string">1</span></span><br><span class="line"><span class="attr">log_bin</span> = <span class="string">/var/log/mysql/mysql-bin.log</span></span><br><span class="line"><span class="attr">max_binlog_size</span> = <span class="string">1G</span></span><br><span class="line"><span class="attr">binlog_format</span> = <span class="string">row</span></span><br><span class="line"><span class="attr">binlog_row_image</span> = <span class="string">full</span></span><br></pre></td></tr></table></figure><p>指定执行脚本的数据库用户授权。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SELECT 权限：查询 information_schema.COLUMNS</span></span><br><span class="line"><span class="comment">-- REPLICATION SLAVE：通过 BINLOG_DUMP 协议获取 binlog 内容</span></span><br><span class="line"><span class="comment">-- REPLICATION CLIENT：执行 SHOW MASTER STATUS 获取 binlog 信息</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, REPLICATION SLAVE, REPLICATION CLIENT <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="keyword">user</span></span><br></pre></td></tr></table></figure><p>准备一张用户表 user，并填充 1W 条数据。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `gmt_create` <span class="type">date</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4</span><br><span class="line"></span><br><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> InsertRandomData()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">DECLARE</span> randomName <span class="type">CHAR</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">DECLARE</span> randomDate <span class="type">DATE</span>;</span><br><span class="line"></span><br><span class="line">    WHILE i <span class="operator">&lt;=</span> <span class="number">10000</span> DO</span><br><span class="line">        <span class="comment">-- 生成随机 name (随机字符串)</span></span><br><span class="line">        <span class="keyword">SET</span> randomName <span class="operator">=</span> CONCAT(</span><br><span class="line">            <span class="type">CHAR</span>(<span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">26</span>) <span class="operator">+</span> <span class="number">65</span>), </span><br><span class="line">            <span class="type">CHAR</span>(<span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">26</span>) <span class="operator">+</span> <span class="number">65</span>), </span><br><span class="line">            <span class="type">CHAR</span>(<span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">26</span>) <span class="operator">+</span> <span class="number">65</span>), </span><br><span class="line">            <span class="type">CHAR</span>(<span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">26</span>) <span class="operator">+</span> <span class="number">65</span>), </span><br><span class="line">            <span class="type">CHAR</span>(<span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">26</span>) <span class="operator">+</span> <span class="number">65</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 生成随机日期 (2013-11-11 起始，随机范围约为一年内)</span></span><br><span class="line">        <span class="keyword">SET</span> randomDate <span class="operator">=</span> DATE_ADD(<span class="string">&#x27;2023-01-01&#x27;</span>, <span class="type">INTERVAL</span> <span class="built_in">FLOOR</span>(RAND() <span class="operator">*</span> <span class="number">365</span>) <span class="keyword">DAY</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- 插入数据</span></span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` (`name`, `gmt_create`) <span class="keyword">VALUES</span> (randomName, randomDate);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 调用存储过程</span></span><br><span class="line"><span class="keyword">CALL</span> InsertRandomData();</span><br></pre></td></tr></table></figure><p>查看大于 11 月份的数据总数，共 363 条。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> gmt_create <span class="operator">&gt;</span> <span class="string">&#x27;2023-11-01 00:00:00&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">363</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br></pre></td></tr></table></figure><p>模拟误删除，假设在 15:30 左右删除了 11 月份之后的数据。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> gmt_create <span class="operator">&gt;</span> <span class="string">&#x27;2023-11-01 00:00:00&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="恢复数据"><a href="#恢复数据" class="headerlink" title="恢复数据"></a>恢复数据</h2><p>查看主库 binlog 状态，最新的文件为 mysql-bin.000003。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 低版本使用 SHOW MASTER STATUS;</span></span><br><span class="line">mysql <span class="operator">&gt;</span> <span class="keyword">SHOW</span> <span class="type">BINARY</span> LOGS;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Log_name         <span class="operator">|</span> File_size <span class="operator">|</span> Encrypted <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000001</span> <span class="operator">|</span>      <span class="number">1871</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000002</span> <span class="operator">|</span>       <span class="number">181</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql<span class="operator">-</span>bin<span class="number">.000003</span> <span class="operator">|</span>    <span class="number">917878</span> <span class="operator">|</span> <span class="keyword">No</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-----------+-----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br></pre></td></tr></table></figure><p>筛选出需要回滚的SQL，误操作人一般知道大致的误操作时间，我们首先根据时间做一次过滤。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; python binlog2sql/binlog2sql.py -h地址 -P端口 -u用户 -p<span class="string">&#x27;密码&#x27;</span> -d库民 -t表名 --start-file=<span class="string">&#x27;mysql-bin.000003&#x27;</span> --start-datetime=<span class="string">&#x27;2023-11-02 15:00:00&#x27;</span> --stop-datetime=<span class="string">&#x27;2023-11-02 16:00:00&#x27;</span> &gt; /tmp/raw.sql</span><br><span class="line"></span><br><span class="line">raw.sql输出：</span><br><span class="line">DELETE FROM `<span class="built_in">test</span>`.`user` WHERE `gmt_create`=<span class="string">&#x27;2023-11-01 00:00:00&#x27;</span> AND `<span class="built_in">id</span>`=1351 AND `name`=<span class="string">&#x27;TPUDJ&#x27;</span> LIMIT 1; <span class="comment">#start 105311 end 262311 time 2023-11-02 15:31:10</span></span><br><span class="line">DELETE FROM `<span class="built_in">test</span>`.`user` WHERE `gmt_create`=<span class="string">&#x27;2023-11-01 00:00:00&#x27;</span> AND `<span class="built_in">id</span>`=1352 AND `name`=<span class="string">&#x27;YKIIS&#x27;</span> LIMIT 1; <span class="comment">#start 105311 end 262311 time 2023-11-02 15:31:10</span></span><br><span class="line">...</span><br><span class="line">DELETE FROM `<span class="built_in">test</span>`.`user` WHERE `gmt_create`=<span class="string">&#x27;2023-12-31 00:00:00&#x27;</span> AND `<span class="built_in">id</span>`=1714 AND `name`=<span class="string">&#x27;SHKBC&#x27;</span> LIMIT 1; <span class="comment">#start 105311 end 265754 time 2023-11-02 15:31:10</span></span><br></pre></td></tr></table></figure><p>根据 raw.sql 的位置信息，可以判断误操作的 SQL 来自同一个事务，准确位置在 105311-265754 之间，根据位置过滤，使用 -B 选项生成回滚 SQL。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; python binlog2sql/binlog2sql.py -h地址 -P端口 -u用户 -p<span class="string">&#x27;密码&#x27;</span> -d库民 -t表名 --start-file=<span class="string">&#x27;mysql-bin.000003&#x27;</span> --start-position=105311 --stop-position=265754 -B &gt; /tmp/rollback.sql</span><br><span class="line"></span><br><span class="line">rollback.sql输出：</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>`.`user`(`gmt_create`, `<span class="built_in">id</span>`, `name`) VALUES (<span class="string">&#x27;2023-11-01 00:00:00&#x27;</span>, 1351, <span class="string">&#x27;TPUDJ&#x27;</span>); <span class="comment">#start 105311 end 262311 time 2023-11-02 15:31:10</span></span><br><span class="line">INSERT INTO `<span class="built_in">test</span>`.`user`(`gmt_create`, `<span class="built_in">id</span>`, `name`) VALUES (<span class="string">&#x27;2023-11-01 00:00:00&#x27;</span>, 1352, <span class="string">&#x27;YKIIS&#x27;</span>); <span class="comment">#start 105311 end 262311 time 2023-11-02 15:31:10</span></span><br><span class="line">...</span><br><span class="line">INSERT INTO `<span class="built_in">test</span>`.`user`(`gmt_create`, `<span class="built_in">id</span>`, `name`) VALUES (<span class="string">&#x27;2023-12-31 00:00:00&#x27;</span>, 1714, <span class="string">&#x27;SHKBC&#x27;</span>); <span class="comment">#start 105311 end 265754 time 2023-11-02 15:31:10</span></span><br></pre></td></tr></table></figure><h2 id="结果验证"><a href="#结果验证" class="headerlink" title="结果验证"></a>结果验证</h2><p>确认回滚 SQL 总行数是否对应误删除的 363 条。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; <span class="built_in">wc</span> -l /tmp/rollback.sql</span><br><span class="line"></span><br><span class="line">363 /tmp/rollback.sql</span><br></pre></td></tr></table></figure><p>与业务方确认回滚 SQL 没问题，执行回滚语句。登录 MySQL，确认回滚成功。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">shell<span class="operator">&gt;</span> mysql <span class="operator">-</span>h地址 <span class="operator">-</span>P端口 <span class="operator">-</span>u用户 <span class="operator">-</span>p<span class="string">&#x27;密码&#x27;</span> <span class="operator">&lt;</span> <span class="operator">/</span>tmp<span class="operator">/</span>rollback.sql</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> gmt_create <span class="operator">&gt;</span> <span class="string">&#x27;2023-11-01 00:00:00&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">363</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br></pre></td></tr></table></figure><h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>binlog2sql 适用于在线恢复误操作的数据，但不适用于以下情况：</p><ol><li><strong>数据恢复建议控制在 50W 以内</strong>，数据量越大，逆向生成的语句越多，超过这个数值，恢复时间可能会超过 15 分钟。</li><li><strong>不支持 DDL 恢复操作</strong>。因为即使在 row 模式下，binlog对于 DDL 操作不会记录每行数据的变化。要实现 DDL 快速回滚，必须修改 MySQL 源码，使得在执行 DDL 前先备份老数据。阿里林晓斌团队提交了 patch 给 MySQL 官方，相关实现方案可以查阅 <a href="https://www.iteye.com/blog/dinglin-1539167">MySQL闪回方案讨论及实现</a>。</li><li>根据官方说法，在线召回数据推荐使用 binlog2sql 工具，离线解析使用 mysqlbinlog 工具，MySQL 闪回特性最早由阿里彭立勋开发，具体可以查阅 <a href="http://www.penglixun.com/database/mysql_flashback_feature.html">MySQL Flashback Feature</a>。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 数据恢复 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring 扩展 AOP 自定义切面路径</title>
      <link href="/2023/10/23/Spring%20%E6%89%A9%E5%B1%95%20AOP%20%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%87%E9%9D%A2%E8%B7%AF%E5%BE%84/"/>
      <url>/2023/10/23/Spring%20%E6%89%A9%E5%B1%95%20AOP%20%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%87%E9%9D%A2%E8%B7%AF%E5%BE%84/</url>
      
        <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>看到有些框架在实现日志切面时，直接编写一个切面类，在 <code>@Aspect</code> 注解指定好 package 路径，然后通过 <code>@EnableAspectJAutoProxy</code> 开启 AOP。业务代码引入这个框架，必须按照框架约定好的 package 路径匹配，才能生效。这样的框架对业务代码有较大的侵入性，不适合所有场景。</p><h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>实现一个可配置的日志切面路径组件，对业务代码零侵入性。</p><h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>实现切面路径自定义的方式有两种：<code>Annotation</code> 注解和 <code>AutoConfiguration</code> 自动装配，前者对代码有较小的侵入性。先说说 <code>Annotation</code> 注解怎么实现。</p><p>以日志切面为例，先设计配置属性类 <code>AccessLogConfig</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 是否保存到 MDC */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabledMdc</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 需要输出日志的包名 */</span></span><br><span class="line">    <span class="keyword">private</span> String expression;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 日志输出采样率 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> <span class="variable">sampleRate</span> <span class="operator">=</span> <span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 是否输出入参 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">logArguments</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 是否输出返回值 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">logReturnValue</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 是否输出方法执行耗时 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">logExecutionTime</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 最大长度 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxLength</span> <span class="operator">=</span> <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 慢日志 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">slowThreshold</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义一个注解 <code>@EnableAccessLog</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import(AccessLogImportSelector.class)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAccessLog &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 是否开启 CGLIB 代理 */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">proxyTargetClass</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** PointcutAdvisor 代理模式 */</span></span><br><span class="line">    AdviceMode <span class="title function_">mode</span><span class="params">()</span> <span class="keyword">default</span> AdviceMode.PROXY;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** PointcutAdvisor 优先级 */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">order</span><span class="params">()</span> <span class="keyword">default</span> Ordered.LOWEST_PRECEDENCE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** AspectJ 切面表达式 */</span></span><br><span class="line">    String <span class="title function_">expression</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写 <code>AccessLogConfiguration</code> 配置类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogConfiguration</span> <span class="keyword">implements</span> <span class="title class_">ImportAware</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AnnotationAttributes annotation;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setImportMetadata</span><span class="params">(AnnotationMetadata importMetadata)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.annotation = AnnotationAttributes.fromMap(</span><br><span class="line">            importMetadata.getAnnotationAttributes(EnableAccessLog.class.getName(), <span class="literal">false</span>));</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.annotation == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;@EnableAccessLog is not present on importing class&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关键代码实现</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AccessLogAdvisor <span class="title function_">accessLogAdvisor</span><span class="params">(ObjectProvider&lt;AccessLogConfig&gt; configs, AccessLogInterceptor interceptor)</span> &#123;</span><br><span class="line">        <span class="type">AccessLogAdvisor</span> <span class="variable">advisor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccessLogAdvisor</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">expression</span> <span class="operator">=</span> getAccessLogConfig(configs).getExpression();</span><br><span class="line">        advisor.setExpression(expression); <span class="comment">// 指定您要匹配的包名</span></span><br><span class="line">        advisor.setAdvice(interceptor); <span class="comment">// 指定您的拦截器</span></span><br><span class="line">        <span class="keyword">if</span> (annotation != <span class="literal">null</span>) &#123;</span><br><span class="line">            advisor.setOrder(annotation.getNumber(<span class="string">&quot;order&quot;</span>)); <span class="comment">// 指定拦截次序</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AccessLogInterceptor <span class="title function_">accessLogInterceptor</span><span class="params">(ObjectProvider&lt;AccessLogConfig&gt; configs)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AccessLogInterceptor</span>(getAccessLogConfig(configs));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AccessLogConfig <span class="title function_">getAccessLogConfig</span><span class="params">(ObjectProvider&lt;AccessLogConfig&gt; accessLogConfigs)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accessLogConfigs.getIfUnique(() -&gt; &#123;</span><br><span class="line">            <span class="type">AccessLogConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AccessLogConfig</span>();</span><br><span class="line">            config.setExpression(annotation.getString(<span class="string">&quot;expression&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> config;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对应的 <code>AccessLogInterceptor</code> 拦截器代码片段如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogInterceptor</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccessLogConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(<span class="meta">@NotNull</span> MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 排除代理类</span></span><br><span class="line">        <span class="keyword">if</span> (AopUtils.isAopProxy(invocation.getThis())) &#123;</span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否需要输出日志</span></span><br><span class="line">        <span class="keyword">if</span> (!AccessLogHelper.shouldLog(config.getSampleRate())) &#123;</span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Instant</span> <span class="variable">start</span> <span class="operator">=</span> Instant.now();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">throwable</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = invocation.proceed();</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            throwable = t;</span><br><span class="line">            <span class="keyword">throw</span> t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> Duration.between(start, Instant.now()).toMillis();</span><br><span class="line">            AccessLogHelper.log(invocation, result, throwable, duration,</span><br><span class="line">                config.isEnabledMdc(), config.getMaxLength(), config.getSlowThreshold());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 <code>@Import(AccessLogImportSelector.class)</code> 导入配置类 <code>AccessLogConfiguration</code>，代码如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogImportSelector</span> <span class="keyword">extends</span> <span class="title class_">AdviceModeImportSelector</span>&lt;EnableAccessLog&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String[] selectImports(AdviceMode adviceMode) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (adviceMode) &#123;</span><br><span class="line">            <span class="keyword">case</span> PROXY:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">                    AutoProxyRegistrar.class.getName(),</span><br><span class="line">                    AccessLogConfiguration.class.getName()</span><br><span class="line">                &#125;;</span><br><span class="line">            <span class="keyword">case</span> ASPECTJ:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">                    AccessLogConfiguration.class.getName()</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当业务代码使用 <code>@EnableAccessLog(expression=&quot;您的包名&quot;)</code>，底层通过 <code>@Import(AccessLogImportSelector.class)</code> 调用 <code>AccessLogConfiguration</code> 配置类，完成自动配置。</p><p>但使用 <code>@EnableAccessLog</code> 注解对代码还是有一定的侵入性，最好的办法就是彻底改为 <code>AutoConfiguration</code>，优化如下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;logging.access&quot;, name = &quot;enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(AccessLogProperties.class)</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@EnableAccessLog</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;logging.access&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccessLogProperties</span> <span class="keyword">extends</span> <span class="title class_">AccessLogConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 是否开启日志切面 */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当业务代码配置如下内容，就会自动开启日志切面，不需要在代码里面编写 <code>@EnableAccessLog</code> 注解。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">access:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">expression:</span> <span class="string">within(org.ylzl.eden.demo.adapter.*.web..*)</span></span><br></pre></td></tr></table></figure><p>根据上述配置的切面路径，测试下 HTTP 请求，可以从控制台日志看到切面打印了接口请求的入参、返回值、耗时。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/spring/spring-aop-logging.png"></p><h1 id="产出"><a href="#产出" class="headerlink" title="产出"></a>产出</h1><p>为研发团队提供统一的日志打印模板，便于后期统一维护日志内容的格式解析工作，在引入这个日志切面组件后，研发团队只需要微调自己的项目 package 就完成了集成工作，对业务代码没有任何侵入性。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-framework/src/main/java/org/ylzl/eden/spring/framework/logging">eden-spring-framework</a> 自定义注解实现和 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot/src/main/java/org/ylzl/eden/spring/boot/logging">eden-spring-boot</a> 自动装配实现。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Log4j2 零停机动态加载配置文件</title>
      <link href="/2023/10/12/Log4j2%20%E9%9B%B6%E5%81%9C%E6%9C%BA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
      <url>/2023/10/12/Log4j2%20%E9%9B%B6%E5%81%9C%E6%9C%BA%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h1>背景</h1><p>有时候生产环境需要临时调整日志级别 Level 或者修改日志输出路径 Appender，使用 Spring Boot 提供的日志刷新不能满足这个需求，最终还是重启服务才能生效。为了解决这个问题，需要实现 log4j2 配置文件的动态加载。</p><h1>目标</h1><p>实现零停机修改 log4j 配置，动态配置日志级别和输出路径。</p><h1>实现</h1><p>Nacos 配置监听通过 <code>NacosConfigManager.getConfigService().addListener()</code> 实现，为了避免 Nacos 服务端宕机，Nacos Client 实现了本地缓存机制，配置文件保存路径如下： <code>$&#123;user.home&#125;/nacos/config/fixed-host_port-namespace_tenant/snapshot-tenant/namespace/group</code>，将配置文件转化为 URI，利用 log4j2 的 API 重新加载日志配置 <code>Configurator.reconfigure(uri)</code>。</p><p>首先，定义配置属性类 <code>Log4j2NacosProperties</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = Log4j2NacosProperties.PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4j2NacosProperties</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREFIX</span> <span class="operator">=</span> <span class="string">&quot;log4j2.nacos&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">enabled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String group;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">dataId</span> <span class="operator">=</span> <span class="string">&quot;log4j2.yml&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编写自动装配组件 <code>Log4j2NacosAutoConfiguration</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">    prefix = Log4j2NacosProperties.PREFIX,</span></span><br><span class="line"><span class="meta">    name = &quot;enabled&quot;</span></span><br><span class="line"><span class="meta">    havingValue = &quot;true&quot;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(NacosConfigBootstrapConfiguration.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(Log4j2NacosProperties.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(LogManager.class)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4j2NacosAutoConfiguration</span> <span class="keyword">implements</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">RPC_CLIENT</span> <span class="operator">=</span> <span class="string">&quot;config_rpc_client&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FIXED</span> <span class="operator">=</span> <span class="string">&quot;fixed&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NacosConfigProperties nacosConfigProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Log4j2NacosProperties log4j2ConfigProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NacosConfigManager nacosConfigManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">configFile</span> <span class="operator">=</span> <span class="built_in">this</span>.getFile(RPC_CLIENT);</span><br><span class="line">        <span class="keyword">if</span> (!configFile.exists()) &#123;</span><br><span class="line">            configFile = <span class="built_in">this</span>.getFile(getServerName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!configFile.exists()) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;Loading log4j2 config file from nacos config cache failed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> configFile.toURI();</span><br><span class="line">        log.info(<span class="string">&quot;Loading log4j2 config file from nacos config cache: &#123;&#125;&quot;</span>, uri);</span><br><span class="line">        Configurator.reconfigure(uri);</span><br><span class="line">        log.info(<span class="string">&quot;Loading log4j2 config file finished.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nacosConfigManager.getConfigService().addListener(</span><br><span class="line">            log4j2ConfigProperties.getDataId(), log4j2ConfigProperties.getGroup(),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Listener</span>() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveConfigInfo</span><span class="params">(String configInfo)</span> &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;Reloading log4j2 config file from nacos listener, changed info: \n&#123;&#125;&quot;</span>, configInfo);</span><br><span class="line">                    Configurator.reconfigure(uri);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> Executor <span class="title function_">getExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File <span class="title function_">getFile</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> getFailoverFile(name);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file = getSnapshotFile(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> file;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File <span class="title function_">getSnapshotFile</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LocalConfigInfoProcessorExporter.getSnapshotFile(name,</span><br><span class="line">            log4j2ConfigProperties.getDataId(),</span><br><span class="line">            log4j2ConfigProperties.getGroup(), getNamespace());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File <span class="title function_">getFailoverFile</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> LocalConfigInfoProcessorExporter.getFailoverFile(name,</span><br><span class="line">            log4j2ConfigProperties.getDataId(),</span><br><span class="line">            log4j2ConfigProperties.getGroup(), getNamespace());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getServerName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> StringUtils.join(FIXED, <span class="string">&quot;-&quot;</span>, getServerAddr());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getServerAddr</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nacosConfigProperties.getServerAddr()</span><br><span class="line">            .replaceAll(<span class="string">&quot;http(s)?://&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            .replaceAll(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;_&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getNamespace</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nacosConfigProperties.getNamespace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于 <code>LocalConfigInfoProcessor</code> 部分方法私有化，需要重写方法，暴露出来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LocalConfigInfoProcessorExporter</span> <span class="keyword">extends</span> <span class="title class_">LocalConfigInfoProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SUFFIX</span> <span class="operator">=</span> <span class="string">&quot;_nacos&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ENV_CHILD</span> <span class="operator">=</span> <span class="string">&quot;snapshot&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FAILOVER_FILE_CHILD_1</span> <span class="operator">=</span> <span class="string">&quot;data&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FAILOVER_FILE_CHILD_2</span> <span class="operator">=</span> <span class="string">&quot;config-data&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FAILOVER_FILE_CHILD_3</span> <span class="operator">=</span> <span class="string">&quot;config-data-tenant&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SNAPSHOT_FILE_CHILD_1</span> <span class="operator">=</span> <span class="string">&quot;snapshot&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SNAPSHOT_FILE_CHILD_2</span> <span class="operator">=</span> <span class="string">&quot;snapshot-tenant&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> File <span class="title function_">getFailoverFile</span><span class="params">(String serverName, String dataId, String group, String tenant)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(LOCAL_SNAPSHOT_PATH, serverName + SUFFIX);</span><br><span class="line">        tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, FAILOVER_FILE_CHILD_1);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(tenant)) &#123;</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, FAILOVER_FILE_CHILD_2);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, FAILOVER_FILE_CHILD_3);</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, tenant);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="keyword">new</span> <span class="title class_">File</span>(tmp, group), dataId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> File <span class="title function_">getSnapshotFile</span><span class="params">(String envName, String dataId, String group, String tenant)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">tmp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(LOCAL_SNAPSHOT_PATH, envName + SUFFIX);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(tenant)) &#123;</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, SNAPSHOT_FILE_CHILD_1);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, SNAPSHOT_FILE_CHILD_2);</span><br><span class="line">            tmp = <span class="keyword">new</span> <span class="title class_">File</span>(tmp, tenant);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="keyword">new</span> <span class="title class_">File</span>(tmp, group), dataId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码扩展完成，对应的 application.yaml 配置文件如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span> <span class="comment"># 配置中心</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 默认关闭，请按需开启</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">demo</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">eden</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="attr">extension-configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">group:</span> <span class="string">eden</span></span><br><span class="line">            <span class="attr">data-id:</span> <span class="string">log4j2.yml</span></span><br><span class="line">            <span class="attr">refresh:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">log4j2:</span></span><br><span class="line">  <span class="attr">nacos:</span> <span class="comment"># Nacos 支持 log4j2 刷新，需要同时设置 spring.cloud.nacos.config.extension-configs</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">eden</span></span><br><span class="line">    <span class="attr">data-id:</span> <span class="string">log4j2.yml</span></span><br></pre></td></tr></table></figure><p>关于 log4j2.yml 配置文件，直接在 Nacos 设置完成。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/log4j2/log4j2-nacos-config.png" alt=""></p><p>在 Nacos 修改 log4j.yml 发布后，可以从应用日志看到 <code>Reloading log4j2 config file from nacos listener, changed info</code>，表示日志已经重新加载。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/log4j2/reloading-log4j2-config-file.png" alt=""></p><h1>产出</h1><p>研发团队引入这个组件后，可以根据自己的需求在线调整生产环境的日志配置，动态控制日志级别、输出路径，提高线上排查效率。</p><p>本文涉及的代码完全开源，感兴趣的伙伴可以查阅 <a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-cloud-starters/eden-nacos-config-spring-cloud-starter">eden-nacos-config-spring-cloud-starter</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 组件开发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring Boot </tag>
            
            <tag> 扩展点 </tag>
            
            <tag> Nacos </tag>
            
            <tag> Log4j2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务器高可用恢复演练报告</title>
      <link href="/2023/06/26/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%AB%98%E5%8F%AF%E7%94%A8%E6%81%A2%E5%A4%8D%E6%BC%94%E7%BB%83%E6%8A%A5%E5%91%8A/"/>
      <url>/2023/06/26/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%AB%98%E5%8F%AF%E7%94%A8%E6%81%A2%E5%A4%8D%E6%BC%94%E7%BB%83%E6%8A%A5%E5%91%8A/</url>
      
        <content type="html"><![CDATA[<h1>概述</h1><h2 id="背景介绍">背景介绍</h2><p>根据《服务器高可用恢复演练方案》文档介绍，验证基于 CLB 负载均衡下部署多台 CVM 的高可用。</p><h2 id="目标要求">目标要求</h2><p>通过混沌演练故障注入，验证 A 系统的 RPO 不超过 4 小时，RTO 不超过 12 小时。</p><h2 id="实施人员">实施人员</h2><p>*　演练实施组：小D<br>*　业务验证组：小E、小F</p><h2 id="测试对象">测试对象</h2><p>A 系统的 prd1 生产环境</p><h2 id="操作时间">操作时间</h2><p>2023-06-25 15:00 ~ 18:00</p><h1>记录</h1><h2 id="Linux内核故障恢复演练">Linux内核故障恢复演练</h2><h3 id="故障模拟">故障模拟</h3><p>在 prd1 服务器节点注入Linux内核故障。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-kernel-crash.png" alt=""></p><p>控制台显示 “执行中”。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-kernel-crash-log.png" alt=""></p><p>等待执行完成后，我们连接这台服务器的 ssh 会话自动退出，说明故障注入已生效。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-kernel-crash-ssh-exit.png" alt=""></p><h3 id="过程记录">过程记录</h3><p>Linux 内核故障注入总共持续了 30 分钟，表现如下：<br>持续访问生产环境，出现短暂几秒的接口报错。在 CLB 探测 prd1 环境端口异常之后，访问生产环境的接口不再出现报错。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-kernel-crash-clb-check.png" alt=""></p><p>短信收到系统告警，提示 prd1 服务器异常。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-kernel-crash-alert-sms.png" alt=""></p><p>关闭故障注入，重启 prd1 服务器后，ssh 登录 prd1 服务器成功，但发现应用进程已经停止，没有再次启动，需要手动重启。</p><h3 id="结果验证">结果验证</h3><ol><li>首次故障注入后，业务接口出现短暂的报错，CLB 在几秒内检测到目标 CVM 不可用，业务请求随后恢复正常，符合预期。</li><li>系统自动告警，恢复服务器，因内核故障导致应用进程无法启动，手动执行脚本启动进程，切回 CLB，业务请求正常，符合预期。</li></ol><h3 id="现场还原">现场还原</h3><p>控制台执行 Linux 内核故障注入结束后，重启服务器即可。</p><h2 id="CPU利用率100-恢复演练">CPU利用率100%恢复演练</h2><h3 id="故障模拟-2">故障模拟</h3><p>在 prd1 服务器节点注入CPU压力测试。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-cpu-100-stress.png" alt=""></p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-cpu-100-stressing.png" alt=""></p><p>使用 ssh 登录服务器执行 <code>Top</code> 命令，查看产生了 4 个 <code>stress-ng-cpu</code> 进程（服务器的 CPU 规格为 4 核），CPU 的负载分别达到 <code>5.90</code> <code>5.47</code> <code>3.28</code>，说明故障注入已生效。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-cpu-100-stress-top.png" alt=""></p><h3 id="过程记录-2">过程记录</h3><p>CPU 故障注入总共持续了 10 分钟，系统仍然可以正常访问，原因是服务器只部署了 Nginx 进程，后端服务不在节点，而是部署在 K8s 集群。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-cpu-100-stress-finished.png" alt=""></p><h3 id="结果验证-2">结果验证</h3><p>CPU 高负载对服务器 Nginx 进程的影响较低。</p><h3 id="现场还原-2">现场还原</h3><p>使用 HTTP 发起 GET 查询请求，不会产生测试数据，不需要还原。<br>控制台执行完成后，<code>stress-ng-cpu</code> 驻留进程自动被清除，不会影响正常的应用访问。</p><h2 id="内存利用率100-恢复演练">内存利用率100%恢复演练</h2><h3 id="故障模拟-3">故障模拟</h3><p>在 prd1 服务器节点注入内存压力测试。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-memory-100-stress.png" alt=""></p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-memory-100-stressing.png" alt=""></p><p>使用 ssh 登录服务器执行 <code>Top</code> 命令，查看产生了 1 个 <code>stress-ng-vm</code> 进程（服务器的内存规格为 8 GB），内存持续增长，导致进程 CPU 达到 100%，说明故障注入已生效。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-memory-100-stress-top.png" alt=""></p><h3 id="过程记录-3">过程记录</h3><p>系统响应延迟，接口返回超过 10 秒，从用户的层面来看，会认为系统卡顿。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-memory-100-stress-slowapi.png" alt=""></p><h3 id="结果验证-3">结果验证</h3><p>当内存使用率达到 100%，系统响应时间会变长，CLB 心跳探测异常，将该节点从 CLB 中摘除，后续业务请求正常，符合预期。</p><h3 id="现场还原-3">现场还原</h3><p>使用 HTTP 发起 GET 查询请求，不会产生测试数据，不需要还原。<br>控制台执行完成后，<code>stress-ng-vm</code> 驻留进程自动被清除，不会影响正常的应用访问。</p><h2 id="机器重启恢复演练">机器重启恢复演练</h2><h3 id="故障模拟-4">故障模拟</h3><p>在 prd1 服务器节点注入内存压力测试。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-reboot.png" alt=""></p><h3 id="过程记录-4">过程记录</h3><p>系统重启很快，从用户感官上没有出现接口报错。因 Nginx 进程未启动，导致 CLB 无法探测到该节点，后续业务请求会失败。CLB 显示后端服务端口异常，如下图。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-reboot-check.png" alt=""></p><p>启动 Nginx 进程后，CLB 节点恢复正常。</p><h3 id="结果验证-4">结果验证</h3><p>机器节点重启后，对业务的请求影响较小，符合预期。</p><h3 id="现场还原-4">现场还原</h3><p>使用 HTTP 发起 GET 查询请求，不会产生测试数据，不需要还原。</p><h1>总结</h1><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-cvm-report.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模板示例 </tag>
            
            <tag> 混沌演练 </tag>
            
            <tag> ChaosBlade </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务器高可用恢复演练方案</title>
      <link href="/2023/06/25/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%AB%98%E5%8F%AF%E7%94%A8%E6%81%A2%E5%A4%8D%E6%BC%94%E7%BB%83%E6%96%B9%E6%A1%88/"/>
      <url>/2023/06/25/%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%AB%98%E5%8F%AF%E7%94%A8%E6%81%A2%E5%A4%8D%E6%BC%94%E7%BB%83%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><h2 id="演练目的"><a href="#演练目的" class="headerlink" title="演练目的"></a>演练目的</h2><p>由于历史原因，A 系统存在部分项目使用 CVM 作为运行环境。尽管腾讯云方承诺单实例服务的可用性达到 99.975%，但遇到 Linux 内核故障、CPU 或内存的使用率过高等问题，仍然会导致系统不可用。为避免业务中断，使用腾讯云 CLB 作为负载均衡，管理和分流至少 3 台以上的 CVM 实例，实现高可用。</p><h2 id="目标要求"><a href="#目标要求" class="headerlink" title="目标要求"></a>目标要求</h2><p>通过混沌演练故障注入，验证 A 系统当前的部署架构具备自愈能力，对业务的影响在可接受范围，满足金融行业IT系统容灾标准，灾难恢复能力达到国家标准等级 4 级以上，即 RPO 不超过 4 小时，RTO 不超过 12 小时。</p><h2 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h2><table><thead><tr><th>名词</th><th>解释</th></tr></thead><tbody><tr><td>RPO</td><td>恢复点目标（Recovery Point Object，简称 RPO）。指灾难发生后，容灾系统进行数据恢复，恢复得来的数据所对应的时间点。</td></tr><tr><td>RTO</td><td>恢复时间目标（Recovery Time Object，简称 RTO）。指灾难发生后，从 IT系统宕机导致业务停顿之刻开始，到 IT 系统恢复至可以支持各部门运作，业务恢复运营之间的时间段。</td></tr><tr><td>CVM</td><td>云服务器（Cloud Virtual Machine，CVM）是腾讯云提供的可扩展的计算服务。可以避免使用传统服务器时需要预估资源用量及前期投入的问题，并在短时间内快速启动任意数量的云服务器并及时部署应用程序。具体可查阅<a href="https://cloud.tencent.com/document/product/213/495">文档</a>。</td></tr><tr><td>CLB</td><td>负载均衡（Cloud Load Balancer，CLB）提供安全快捷的流量分发服务，访问流量经由 CLB 可以自动分配到云中的多台后端服务器上，扩展系统的服务能力并消除单点故障。负载均衡支持亿级连接和千万级并发，可轻松应对大流量访问，满足业务需求。具体可查阅<a href="https://cloud.tencent.com/document/product/214">文档</a>。</td></tr><tr><td>CFG</td><td>混沌演练（Chaotic Fault Generator）提供高效便捷、安全可靠的故障演习服务，除可视化故障注入服务外，还提供行业经验模板，监控护栏等核心功能，帮助用户及时发现业务容灾隐患、验证高可用预案的有效性，从而提高系统的可用性和韧性。具体可查阅<a href="https://cloud.tencent.com/document/product/1500/97565">文档</a>。</td></tr></tbody></table><h1 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h1><h2 id="系统分析"><a href="#系统分析" class="headerlink" title="系统分析"></a>系统分析</h2><p>本次演练的对象为 A 系统的生产环境，访问地址为 <a href="https://www.xxx.com./">https://www.XXX.com。</a></p><p>该系统使用负载均衡 CLB 提供公网访问入口，CLB 对上游的存活检测规则，响应超时为 2 秒，检查间隔为 5 秒，不健康阈值为 3 次，健康阈值为 3 次。当某个 CVM 实例发生故障时，超过 21 秒后判断该实例不健康，不再分发流量。</p><p>CLB 的上游绑定 5 个机器节点，各节点的规格统一为 8 核 16 GB，如下。</p><ol><li>gray 灰度环境：内网 IP 为 172.28.0.1（这个有前端依赖，不适合做故障注入）</li><li>prd1 生产环境：内网 IP 为 172.28.0.2</li><li>prd2 生产环境：内网 IP 为 172.28.0.3</li><li>prd3 生产环境：内网 IP 为 172.28.0.4</li><li>prd4 生产环境：内网 IP 为 172.28.0.5</li></ol><p>因各节点规格一致，计划使用 <strong>prd1</strong> 生产环境作为测试对象。</p><h2 id="实施时间"><a href="#实施时间" class="headerlink" title="实施时间"></a>实施时间</h2><p>选定 2023 年 6 月 25 日（非交易日，用户访问量少）</p><h2 id="人员分工"><a href="#人员分工" class="headerlink" title="人员分工"></a>人员分工</h2><p>由演练领导组、演练实施组、演练指挥组和业务验证组共同参与，具体人员如下。</p><table><thead><tr><th>灾备演练组</th><th>人员</th><th>岗位</th><th>职责</th></tr></thead><tbody><tr><td>演练领导组</td><td>小A</td><td>技术总监</td><td>负责容灾方案的审核和决策</td></tr><tr><td>演练指挥组</td><td>小B</td><td>云原生专家</td><td>负责制定容灾方案和发起</td></tr><tr><td>演练实施组</td><td>小C</td><td>平台工程师</td><td>负责实施应用平台的容灾恢复</td></tr><tr><td>演练实施组</td><td>小D</td><td>运维工程师</td><td>负责实施基础设施的容灾恢复</td></tr><tr><td>业务验证组</td><td>小E</td><td>研发负责人</td><td>负责业务监控和系统可靠性验证</td></tr><tr><td>业务验证组</td><td>小F</td><td>研发工程师</td><td>负责业务测试和容灾恢复前后的数据比对验证</td></tr></tbody></table><h2 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h2><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-workflow.png"></p><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>本次演练基于腾讯云<strong>混沌演练平台</strong>完成故障注入和灾难恢复工作，在正式执行容灾演练前，需要预先创建好相关任务、动作库、监控护栏、演练计划等配置。</p><h3 id="创建演练任务"><a href="#创建演练任务" class="headerlink" title="创建演练任务"></a>创建演练任务</h3><p>演练名称设置为 “CVM 故障注入恢复演练”。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-create-task.png"></p><h3 id="配置动作库"><a href="#配置动作库" class="headerlink" title="配置动作库"></a>配置动作库</h3><p>分别创建任务，依次为：Linux 内核故障、CPU 利用率100%、内存利用率100% 、主机异常重启。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-create-action.png"></p><h3 id="设置监控护栏"><a href="#设置监控护栏" class="headerlink" title="设置监控护栏"></a>设置监控护栏</h3><p>防止演练过程中出现一些不可预估的影响，使用护栏策略触发告警，中断演练执行。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-create-barrier.png"></p><h3 id="保存到经验库"><a href="#保存到经验库" class="headerlink" title="保存到经验库"></a>保存到经验库</h3><p>将已配置的流程保存起来，以便后续演练复用，经验名称为 “CVM 故障注入案例”。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-save-experience.png"></p><h3 id="新建演练计划"><a href="#新建演练计划" class="headerlink" title="新建演练计划"></a>新建演练计划</h3><p>设置演练起止时间，并选择创建好的经验库。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-create-plan.png"></p><h3 id="演练事后总结"><a href="#演练事后总结" class="headerlink" title="演练事后总结"></a>演练事后总结</h3><p>演练结束后，点击按钮生成演练报告。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-finished-report.png"></p><h2 id="演练内容"><a href="#演练内容" class="headerlink" title="演练内容"></a>演练内容</h2><h3 id="Linux内核故障恢复演练"><a href="#Linux内核故障恢复演练" class="headerlink" title="Linux内核故障恢复演练"></a>Linux内核故障恢复演练</h3><p>故障模拟：prd1 服务器节点发生内核故障</p><p>执行步骤：</p><ol><li>针对 prd1 环境执行 <code>Linux内核故障</code> 注入，从控制台面板查看故障是否注入完成。</li><li>登录 CVM 执行 <code>Top</code> 命令，查看是否产生一个 <code>chaos_burnkernel</code> 进程。</li><li>故障注入 1 分钟，不做 CLB 流量切换，观察系统和日志的表现。</li><li>再次执行故障注入 1 分钟，当收到系统告警，人工介入 CLB 流量切换，观察系统和日志的表现。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-inject-linux-kernel-error.png"></p><p>期望结果：</p><ol><li>首次故障注入，不做 CLB 切换，CLB 在 21 秒后检测到目标 CVM 不可用，业务请求随后恢复正常。</li><li>再次故障注入，系统自动告警，手动切换 CLB 到正常节点，业务请求快速恢复正常，故障恢复时长 RTO 在可接受范围内。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-execute-linux-kernel-error.png"></p><h3 id="CPU使用100-恢复演练"><a href="#CPU使用100-恢复演练" class="headerlink" title="CPU使用100%恢复演练"></a>CPU使用100%恢复演练</h3><p>故障模拟：prd1 服务器节点的 CPU 利用率达到 100%</p><p>执行步骤：</p><ol><li>针对 prd1 环境执行 <code>CPU使用率100%</code> 注入，从控制台面板查看故障是否注入完成。</li><li>登录 CVM 执行 <code>Top</code> 命令，查看是否产生一个 <code>chaos_burnkernel</code> 进程。</li><li>故障注入 1 分钟，不做 CLB 流量切换，观察系统和日志的表现。</li><li>再次执行故障注入 1 分钟，当收到系统告警，人工介入 CLB 流量切换，观察系统和日志的表现。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-inject-linux-cpu-100.png"></p><p>期望结果：</p><ol><li>首次故障注入，不做 CLB 切换，CLB 在 21 秒后检测到目标 CVM 不可用，业务请求随后恢复正常。</li><li>再次故障注入，系统自动告警，手动切换 CLB 到正常节点，业务请求快速恢复正常，故障恢复时长 RTO 在可接受范围内。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-execute-linux-cpu-100.png"></p><h3 id="内存使用100-恢复演练"><a href="#内存使用100-恢复演练" class="headerlink" title="内存使用100%恢复演练"></a>内存使用100%恢复演练</h3><p>故障模拟：prd1 服务器节点的内存利用率达到 100%</p><p>执行步骤：</p><ol><li>针对 prd1 环境执行 <code>内存使用率100%</code> 注入，从控制台面板查看故障是否注入完成。</li><li>登录 CVM 执行 <code>Top</code> 命令，查看是否产生一个 <code>chaos_burnmem</code> 进程。</li><li>故障注入 1 分钟，不做 CLB 流量切换，观察系统和日志的表现。</li><li>再次执行故障注入 1 分钟，当收到系统告警，人工介入 CLB 流量切换，观察系统和日志的表现。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-inject-linux-memory-100.png"></p><p>期望结果：</p><ol><li>首次故障注入，不做 CLB 切换，CLB 在 21 秒后检测到目标 CVM 不可用，业务请求随后恢复正常。</li><li>再次故障注入，系统自动告警，手动切换 CLB 到正常节点，业务请求快速恢复正常，故障恢复时长 RTO 在可接受范围内。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-execute-linux-memory-100.png"></p><h3 id="机器故障重启恢复演练"><a href="#机器故障重启恢复演练" class="headerlink" title="机器故障重启恢复演练"></a>机器故障重启恢复演练</h3><p>故障模拟：prd1 服务器节点宕机重启</p><p>执行步骤：</p><ol><li>针对 prd1 环境执行 <code>机器故障重启</code> 注入，从控制台面板查看故障是否注入完成。</li><li>登录 CVM 执行 <code>Top</code> 命令，查看是否产生一个 <code>chaos_burnreboot</code> 进程。</li><li>故障注入 1 分钟，不做 CLB 流量切换，观察系统和日志的表现。</li><li>再次执行故障注入 1 分钟，当收到系统告警，人工介入 CLB 流量切换，观察系统和日志的表现。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-inject-linux-reboot-100.png"></p><p>期望结果：</p><ol><li>首次故障注入，不做 CLB 切换，CLB 在 21 秒后检测到目标 CVM 不可用，业务请求随后恢复正常。</li><li>再次故障注入，系统自动告警，手动切换 CLB 到正常节点，业务请求快速恢复正常，故障恢复时长 RTO 在可接受范围内。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/tencent/cfg-execute-linux-reboot-100.png"></p><h2 id="现场还原"><a href="#现场还原" class="headerlink" title="现场还原"></a>现场还原</h2><p>在故障注入期间，会额外产生 <code>chaos_burncpu</code>、<code>chaos_burnmem</code> 等进程，在混沌演练平台执行销毁探针可能会不成功，需要人工检查这些进程是否存在，按需销毁这些驻留进程。</p><h2 id="数据核对"><a href="#数据核对" class="headerlink" title="数据核对"></a>数据核对</h2><p>由于演练过程中并不产生数据写入，因此，无须进行数据核对。</p>]]></content>
      
      
      <categories>
          
          <category> 平台工程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模板示例 </tag>
            
            <tag> 混沌演练 </tag>
            
            <tag> ChaosBlade </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于 CAT 新增链路跟踪和告警通知</title>
      <link href="/2023/03/03/%E5%9F%BA%E4%BA%8E%20CAT%20%E6%96%B0%E5%A2%9E%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%92%8C%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/"/>
      <url>/2023/03/03/%E5%9F%BA%E4%BA%8E%20CAT%20%E6%96%B0%E5%A2%9E%E9%93%BE%E8%B7%AF%E8%B7%9F%E8%B8%AA%E5%92%8C%E5%91%8A%E8%AD%A6%E9%80%9A%E7%9F%A5/</url>
      
        <content type="html"><![CDATA[<p>CAT 是美团点评开源的实时应用监控平台，提供了 <code>Tracsaction</code>、<code>Event</code>、<code>Problem</code>、<code>Business</code> 等丰富的指标项。</p><p>在官方的 Issue 遇到以下几个问题：</p><ol><li>能不能支持链路跟踪？</li><li>如何配置告警？</li><li>能不能接入钉钉、飞书机器人推送？</li><li>为什么 CAT 部署这么麻烦？</li></ol><p>基于上面的需求，笔者 fork 了官方最新的源码进行二次开发，并打包镜像到 Docker Hub，方便大家使用。</p><ul><li>Github 地址：<a href="https://github.com/shiyindaxiaojie/cat">传送门</a></li><li>Docker Hub 地址：<a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/cat-home/tags">传送门</a></li></ul><h1>改造内容</h1><ul><li><p>新增<strong>链路跟踪</strong>支持，您可以通过日志打印的 TraceId 查找整个请求路径的 HTTP 请求、RPC 调用、Log4j2 日志、SQL 语句和 Cache 执行耗时。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/tracing.png" alt=""></p></li><li><p>支持<strong>邮件、钉钉、微信、飞书</strong>机器人推送。不需要额外实现告警接口，直接开箱即用，您只需要在后台配置相关的 Token 即可。如下图，触发告警后，钉钉将推送相关信息，您可以点击 <code>查看告警</code> 触达异常堆栈，也可以点击 <code>告警规则</code> 设置告警阈值，避免多次干扰。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/dingtalk.png" alt=""></p></li><li><p>支持 <strong>Jira Software</strong> 自动录单。当生产故障触发告警时，自动录入 Jira Software，便于研发内部跟进问题。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/auto-create-jira-issue.png" alt=""></p></li><li><p>优化 <strong>Docker</strong> 部署，只需要提供 JVM 参数和 MySQL 配置即可完成部署，不需要额外挂载 <code>datasource.xml</code> 和 <code>client.xml</code> 等配置文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e MYSQL_URL=<span class="string">&quot;127.0.0.1&quot;</span> -e MYSQL_PORT=<span class="string">&quot;3306&quot;</span> -e MYSQL_SCHEMA=<span class="string">&quot;cat&quot;</span> -e MYSQL_USERNAME=<span class="string">&quot;数据库账号&quot;</span> -e MYSQL_PASSWD=<span class="string">&quot;数据库密码&quot;</span> -p 8080:8080 --name=cat-home -d shiyindaxiaojie/cat-home</span><br></pre></td></tr></table></figure></li></ul><h1>部署教程</h1><h2 id="运行环境要求">运行环境要求</h2><ul><li>JDK 版本 &gt;= 7</li><li>MySQL 5.7（亲测 8.0 会报错）</li><li>Tomcat 8.0+</li><li>Linux 内核版本 &gt;= 2.6</li></ul><h2 id="Tomcat-部署">Tomcat 部署</h2><p>从 <a href="https://github.com/shiyindaxiaojie/cat/releases/tag/v3.4.0">Github Release</a> 下载相关文件，拷贝 <code>client.xml</code> 和 <code>datasources.xml</code> 到用户目录 <code>~/.cat/appdatas/cat</code> 中，并调整数据库配置。</p><p>将 <code>cat.war</code> 部署在目标 <code>Tomcat</code> 的 <code>webapps</code> 目录下，启动 <code>Tomcat</code>，访问 <code>http://localhost:8080/cat</code> 即可。原则上请保持 <code>Tomcat</code> 的端口为 <code>8080</code>，遇到项目启动失败的情况，建议查看 <code>~/.cat/applog/</code> 目录下的日志。</p><h2 id="Docker-部署">Docker 部署</h2><p>本项目已发布稳定的镜像到 <a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/cat-home/tags">Docker Hub</a>，您可以直接使用如下命令，提供 JVM 参数和 MySQL 配置，完成部署。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e MYSQL_URL=<span class="string">&quot;127.0.0.1&quot;</span> -e MYSQL_PORT=<span class="string">&quot;3306&quot;</span> -e MYSQL_SCHEMA=<span class="string">&quot;cat&quot;</span> -e MYSQL_USERNAME=<span class="string">&quot;数据库账号&quot;</span> -e MYSQL_PASSWD=<span class="string">&quot;数据库密码&quot;</span> -e JVM_XMS=<span class="string">&quot;最小堆&quot;</span> -e JVM_XMX=<span class="string">&quot;最大堆&quot;</span> -p 8080:8080 --name=cat-home -d shiyindaxiaojie/cat-home</span><br></pre></td></tr></table></figure><h2 id="Kubernetes-部署">Kubernetes 部署</h2><p>建议使用 StatefulSet 部署，YAML 示例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cat-home</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">-Xmx1536m</span> <span class="string">-Xms1536m</span> <span class="string">-Xmn1024m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">数据库地址</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;3306&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_USERNAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">数据库账号</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">数据库密码</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SCHEMA</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">CAT</span> <span class="string">数据库名称</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVER_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">CAT</span> <span class="string">运行地址</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">2G</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMX</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">2G</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMN</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">1G</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">shiyindaxiaojie/cat-home:v3.4.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">lifecycle:</span></span><br><span class="line">          <span class="attr">preStop:</span></span><br><span class="line">            <span class="attr">exec:</span></span><br><span class="line">              <span class="attr">command:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">curl</span> <span class="string">http://localhost:8080/cat/r/home?op=checkpoint</span> <span class="string">&amp;&amp;</span> <span class="string">sleep</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cat-home</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/appdatas/cat/bucket</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">appdatas</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/applogs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">applogs</span></span><br><span class="line">      <span class="attr">volumes:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">nfs:</span> <span class="comment"># 此处省略，请根据实际情况配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">        <span class="attr">nfs:</span> <span class="comment"># 此处省略，请根据实际情况配置</span></span><br></pre></td></tr></table></figure><h2 id="生产集群部署">生产集群部署</h2><p>推荐使用 Kubernetes 部署生产集群，假设部署三个节点，一个节点为监控节点，另外两个节点为消费节点，如下配置：</p><ul><li>监控节点：10.1.1.1</li><li>消费节点：10.1.1.2</li><li>消费节点：10.1.1.3</li></ul><p>请复制上面的 YAML，将 SERVER_URL 参数调整为 <code>10.1.1.1,10.1.1.2,10.1.1.3</code>。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cat-home</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVER_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">10.1</span><span class="number">.1</span><span class="number">.1</span><span class="string">,10.1.1.2,10.1.1.3</span></span><br></pre></td></tr></table></figure><p>启动后，点击顶部导航栏 <code>配置</code>，从左侧 <code>系统配置</code> 设置 <code>服务端配置</code>。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-config.png" alt=""></p><p>配置内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server-config</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 默认不开启监控 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;local-mode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;job-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;send-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;alarm-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hdfs-enabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;remote-servers&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10.1.1.1:8080,10.1.1.2:8080,10.1.1.3:8080&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">storage</span> <span class="attr">local-base-dir</span>=<span class="string">&quot;/data/appdatas/cat/bucket/&quot;</span> <span class="attr">max-hdfs-storage-time</span>=<span class="string">&quot;15&quot;</span> <span class="attr">local-report-storage-time</span>=<span class="string">&quot;30&quot;</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">&quot;30&quot;</span> <span class="attr">har-mode</span>=<span class="string">&quot;true&quot;</span> <span class="attr">upload-thread</span>=<span class="string">&quot;5&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">&quot;dump&quot;</span> <span class="attr">max-size</span>=<span class="string">&quot;128M&quot;</span> <span class="attr">server-uri</span>=<span class="string">&quot;hdfs://127.0.0.1/&quot;</span> <span class="attr">base-dir</span>=<span class="string">&quot;/user/cat/dump&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">harfs</span> <span class="attr">id</span>=<span class="string">&quot;dump&quot;</span> <span class="attr">max-size</span>=<span class="string">&quot;128M&quot;</span> <span class="attr">server-uri</span>=<span class="string">&quot;har://127.0.0.1/&quot;</span> <span class="attr">base-dir</span>=<span class="string">&quot;/user/cat/dump&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hadoop.security.authentication&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dfs.namenode.kerberos.principal&quot;</span> <span class="attr">value</span>=<span class="string">&quot;hadoop/dev80.hadoop@testserver.com&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dfs.cat.kerberos.principal&quot;</span> <span class="attr">value</span>=<span class="string">&quot;cat@testserver.com&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dfs.cat.keytab.file&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/data/appdatas/cat/cat.keytab&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;java.security.krb5.realm&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;java.security.krb5.kdc&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">storage</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">consumer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">long-config</span> <span class="attr">default-url-threshold</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">default-sql-threshold</span>=<span class="string">&quot;100&quot;</span> <span class="attr">default-service-threshold</span>=<span class="string">&quot;50&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">domain</span> <span class="attr">name</span>=<span class="string">&quot;cat&quot;</span> <span class="attr">url-threshold</span>=<span class="string">&quot;500&quot;</span> <span class="attr">sql-threshold</span>=<span class="string">&quot;500&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">domain</span> <span class="attr">name</span>=<span class="string">&quot;OpenPlatformWeb&quot;</span> <span class="attr">url-threshold</span>=<span class="string">&quot;100&quot;</span> <span class="attr">sql-threshold</span>=<span class="string">&quot;500&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">long-config</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">consumer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 将 10.1.1.1 设置为监控节点，其他节点设置为消费节点 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;job-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;send-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;alarm-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server-config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>从左侧 <code>系统配置</code> 设置 <code>客户端路由</code> 。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/client-route-config.png" alt=""></p><p>配置内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-config</span> <span class="attr">backup-server</span>=<span class="string">&quot;10.1.1.1&quot;</span> <span class="attr">backup-server-port</span>=<span class="string">&quot;2280&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 监控节点不开启消费，其他节点开启消费，可以根据实际情况调整 weight 权重 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">default-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.1&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">default-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.2&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">default-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.3&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">network-policy</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span> <span class="attr">title</span>=<span class="string">&quot;default&quot;</span> <span class="attr">block</span>=<span class="string">&quot;false&quot;</span> <span class="attr">server-group</span>=<span class="string">&quot;default_group&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">network-policy</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">server-group</span> <span class="attr">id</span>=<span class="string">&quot;default_group&quot;</span> <span class="attr">title</span>=<span class="string">&quot;default-group&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.2&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.3&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">server-group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">domain</span> <span class="attr">id</span>=<span class="string">&quot;cat&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.2&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.3&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">router-config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置完成后，查看<code>首页</code>的<code>系统状态</code>，集群配置已生效，如下图，监控节点只负责控制台的数据展示和告警通知，不消费客户端的数据。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/cluster-monitor-node.png" alt=""></p><p>数据消费节点会消费客户端发送的数据，根据客户端路由设置的权重策略均摊数据。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/cluster-data-node.png" alt=""></p><h1>应用集成</h1><p>为了减少客户端集成的工作，推荐您使用 <a href="https://github.com/shiyindaxiaojie/eden-architect">eden-architect</a> 框架，集成后在 log4j2 自动记录 TraceId。您只需要根据以下两步就可以完成 CAT 的集成。</p><p>引入 CAT 依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.shiyindaxiaojie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eden-cat-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>开启 CAT 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cat:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># 默认关闭，请按需开启</span></span><br><span class="line">  <span class="attr">trace-mode:</span> <span class="literal">true</span> <span class="comment"># 开启访问观测</span></span><br><span class="line">  <span class="attr">support-out-trace-id:</span> <span class="literal">false</span> <span class="comment"># 允许异构子系统间透传链路ID</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">servers:</span> <span class="string">localhost</span> <span class="comment"># CAT 地址</span></span><br><span class="line">  <span class="attr">tcp-port:</span> <span class="number">2280</span></span><br><span class="line">  <span class="attr">http-port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果您使用 Dubbo 组件，请增加对应的过滤器，确保 CAT 埋点正常工作</span></span><br><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">  <span class="attr">provider:</span></span><br><span class="line">    <span class="attr">filter:</span> <span class="string">cat-tracing</span></span><br><span class="line">  <span class="attr">consumer:</span></span><br><span class="line">    <span class="attr">filter:</span> <span class="string">cat-tracing,cat-consumer</span></span><br></pre></td></tr></table></figure><p>启动您的项目，调用接口，查看控制台输出的日志内容，红圈中就是 CAT 的链路ID。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/traceid-of-logging.png" alt=""></p><p>根据链路ID，在 CAT 中查看详细链路信息。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/tracing.png" alt=""></p><blockquote><p>当然，如果你不希望依赖 eden-architect，则可以参考<a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-integration/src/main/java/org/ylzl/eden/spring/integration/cat/integration">相关代码</a>实现自己的需求。关于相关代码的实现原理，笔者将在后面的文章中给出。</p></blockquote><h1>告警配置</h1><p>目前 CAT 经过二次开发，实现了告警通知的开箱即用，您只需要微调相关配置，即可开启告警通知功能。告警通知支持以下方式：邮件、钉钉、飞书、微信、Jira Software，配置步骤如下：</p><p>点击控制台的 <code>配置</code>，展开左侧 <code>系统配置</code> 的 <code>告警渠道</code>，如下图：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/alert-config.png" alt=""></p><p>以 <code>邮件</code>、<code>钉钉</code>、<code>Jira Software</code> 为例，内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sender-config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sender</span> <span class="attr">id</span>=<span class="string">&quot;mail&quot;</span> <span class="attr">url</span>=<span class="string">&quot;smtp.qq.com:25&quot;</span> <span class="attr">type</span>=<span class="string">&quot;post&quot;</span> <span class="attr">successCode</span>=<span class="string">&quot;200&quot;</span> <span class="attr">batchSend</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">par</span> <span class="attr">id</span>=<span class="string">&quot;username=发件人邮箱地址&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">par</span> <span class="attr">id</span>=<span class="string">&quot;password=发件人邮箱密码&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sender</span> <span class="attr">id</span>=<span class="string">&quot;dingtalk&quot;</span> <span class="attr">url</span>=<span class="string">&quot;https://oapi.dingtalk.com/robot/send?access_token=&quot;</span> <span class="attr">type</span>=<span class="string">&quot;post&quot;</span> <span class="attr">successCode</span>=<span class="string">&quot;200&quot;</span> <span class="attr">batchSend</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sender</span> <span class="attr">id</span>=<span class="string">&quot;jira&quot;</span> <span class="attr">url</span>=<span class="string">&quot;http://localhost:8080&quot;</span> <span class="attr">type</span>=<span class="string">&quot;post&quot;</span> <span class="attr">successCode</span>=<span class="string">&quot;200&quot;</span> <span class="attr">batchSend</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">par</span> <span class="attr">id</span>=<span class="string">&quot;reporter_token=凭据&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sender-config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>设置 <code>系统配置</code> 的 <code>告警策略</code>，即 CAT 埋点达到告警阈值时发送的接收对象，例如 <code>dingtalk</code>、<code>mail</code>、<code>jira</code>，如下图：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/alert-strategy.png" alt=""></p><p>内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">alert-policy</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Transaction&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Event&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Exception&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail,jira&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail,jira&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Business&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Heartbeat&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">alert-policy</span>&gt;</span></span><br></pre></td></tr></table></figure><p>设置 <code>系统配置</code> 的 <code>告警对象</code>，即告警通知接收对象，如下图：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/alert-receiver.png" alt=""></p><p>内容如下，笔者设置了 <code>Exception</code> 类型的告警：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">alert-config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Transaction&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Event&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Exception&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">email</span>&gt;</span>您的邮箱<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">jira</span>&gt;</span>reporterName=monitor<span class="symbol">&amp;amp;</span>issueType=故障<span class="symbol">&amp;amp;</span>components=架构<span class="symbol">&amp;amp;</span>fixVersionNames=待定<span class="tag">&lt;/<span class="name">jira</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dingtalk</span>&gt;</span>您的钉钉机器人Token<span class="tag">&lt;/<span class="name">dingtalk</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Heartbeat&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Business&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">alert-config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>接下来设置 <code>Server</code> 的 <code>异常告警配置</code>，如下图：<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-exception-alert-config.png" alt=""></p><p>配置界面如下，应用名称填写 <code>default</code> 表示监控所有服务，您可以指定自己的服务名称独立监控。异常名称建议填写 <code>Total</code>，表示监控所有异常，如果您需要监控某个异常，则填写该异常名称即可：<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-exception-alert-config-editable.png" alt=""></p><p>如果有些异常是不需要监控的，请在<code>异常过滤</code>列表添加。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-exception-alert-config-ignore.png" alt=""></p><p>笔者设置了所有异常出现 5 次时发送告警，10 次时发送告警。达到这个阈值时，邮件会发送到 <code>告警对象</code> 设置的接收对象，Jira Software 会创建一个故障，钉钉会发送告警通知：</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/mail.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 链路跟踪 </tag>
            
            <tag> 可观测性 </tag>
            
            <tag> 美团 </tag>
            
            <tag> 二次开发 </tag>
            
            <tag> 中间件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 存储 emoji 报错问题排查</title>
      <link href="/2023/02/10/MySQL%20%E5%AD%98%E5%82%A8%20emoji%20%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
      <url>/2023/02/10/MySQL%20%E5%AD%98%E5%82%A8%20emoji%20%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/</url>
      
        <content type="html"><![CDATA[<h1>问题描述</h1><p>我们使用 MySQL 在特定业务场景（帖子、评论、个人签名）存储 emoji 表情。Server 配置和建表语句统一使用 <code>utf8mb4</code>，仍然抛出如下错误：<br><code>java.sql.SQLException: Incorrect string value: '\xF0\x9F\x92\x94' for column 'name' at row 1</code>。</p><h1>原因分析</h1><p>MySQL 的 <code>utf8</code> 编码最多支持 3 个字节，而 emoji 表情需要占用 4 个字节，在早期的版本并没有实现真正意义上的 <code>utf8</code> 字符集。MySQL 从 <code>5.5.3</code> 版本开始支持 <code>utf8mb4</code> 字符集。</p><p>我们检查了 Server 的版本和配置，确定字符集用的是 <code>utf8mb4</code>，也检查了客户端连接 Server 的参数，也没发现其他异常。</p><p>将代码部署到自建的 MySQL 环境，可以正常存储，但是部署到云数据库 MySQL，就会报错，基本上判断是云厂商配置的问题。</p><p>因云数据库的环境不支持在 Server 端配置 <code>character-set-client-handshake</code> 或者 <code>init_connect</code> 参数，我们使用了 <code>HikariCP</code> 数据库连接池框架，在数据库连接池框架初始化连接之前传入 <code>set names utf8mb4; </code>命令处理，代码片段如下。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">connection-init-sql:</span> <span class="string">SET</span> <span class="string">NAMES</span> <span class="string">utf8mb4</span></span><br></pre></td></tr></table></figure><p>修改配置后，问题解决。</p><h1>故障复盘</h1><p>云厂商数据库通过 proxy 代理，屏蔽了客户端和服务器之间的细节，导致我们很难排查出问题的根本原因。对于 MySQL 的字符存储问题，我们通常会通过以下方式来排查问题。</p><h2 id="检查客户端代码的会话字符集">检查客户端代码的会话字符集</h2><p>例如 HikariCP 数据库连接池框架，在数据库连接池框架初始化连接之前传入 <code>set names utf8mb4; </code>命令，让客户端告知 Server，使用 <code>utf8mb4</code> 字符集。</p><h2 id="检查-MySQL-服务端的字符集">检查 MySQL 服务端的字符集</h2><p>通过以下语句查看 MySQL 服务端的字符集是否为 <code>utf8mb4</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">WHERE</span> VARIABLE_NAME <span class="keyword">LIKE</span> <span class="string">&#x27;character_set_database&#x27;</span> <span class="keyword">OR</span> VARIABLE_NAME <span class="keyword">LIKE</span> <span class="string">&#x27;collation%&#x27;</span>;</span><br></pre></td></tr></table></figure><p>如果不是，调整 MySQL 的配置文件，关键代码片段如下。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">character-set-server</span> = utf8mb4</span><br><span class="line"><span class="attr">collation-server</span> = utf8mb4_unicode_ci</span><br><span class="line"><span class="attr">init_connect</span>=<span class="string">&#x27;SET NAMES utf8mb4&#x27;</span></span><br><span class="line"><span class="attr">character-set-client-handshake</span> = <span class="literal">FALSE</span></span><br></pre></td></tr></table></figure><p>重启 MySQL Server，重新确认 MySQL 服务端的字符集是否修改成功。</p><h2 id="检查-JDBC-连接信息">检查 JDBC 连接信息</h2><p>去除 <code>characterEncoding</code> 选项，让 MySQL 连接器选择服务端的字符集。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">3306</span><span class="operator">/</span>db?useUnicode<span class="operator">=</span><span class="literal">true</span><span class="operator">&amp;&amp;</span>zeroDateTimeBehavior<span class="operator">=</span>convertToNull<span class="operator">&amp;</span>autoReconnect<span class="operator">=</span><span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="修改历史数据的字符集">修改历史数据的字符集</h2><p>对于存储了字符编码为 <code>utf8</code> 的历史数据，如果要支持 <code>utf8mb4</code> ，需要将已经存在的数据库、表、列的类型修改成 <code>utf8mb4</code>。</p><p>首先，调整数据库的默认字符集。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE <span class="operator">&lt;</span>database_name<span class="operator">&gt;</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure><p>修改表或者列的字符集。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>table_name<span class="operator">&gt;</span> <span class="keyword">CONVERT</span> <span class="keyword">TO</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure><p>如果您不希望修改整个表的字符集，可以选择指定 Column 进行调整。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>table_name<span class="operator">&gt;</span> MODIFY <span class="keyword">COLUMN</span> <span class="operator">&lt;</span>column_name<span class="operator">&gt;</span> <span class="type">VARCHAR</span>(<span class="number">512</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 线上排查 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 字符集 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 时区相差 5 小时问题排查</title>
      <link href="/2023/01/10/MySQL%20%E6%97%B6%E5%8C%BA%E7%9B%B8%E5%B7%AE%205%20%E5%B0%8F%E6%97%B6%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
      <url>/2023/01/10/MySQL%20%E6%97%B6%E5%8C%BA%E7%9B%B8%E5%B7%AE%205%20%E5%B0%8F%E6%97%B6%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>最近经业务部门反馈，我们有个 APP 升级后，在 <code>2023-01-09 22:47</code> 发现，当前账号的最近登录时间为 <code>2023-01-10 03:47</code>，相差了 5 个小时。</p><ol><li>第一轮排查：我们第一印象会认为是刚升级的代码出了问题，有可能是日期格式化没处理好，也有可能是 JSON 序列化没有指定时区，经过 Git diff 排查，我们并没有修改相关代码。</li><li>第二轮排查：可能是有人动了生产配置！排除了配置中心的改动，也检查了 K8s 的 Deployment 是否正确设置了 TZ&#x3D;Asia&#x2F;Shanghai，依然无果。</li><li>第三轮排查：提取线上部署的 jar，经过对比，我们发现 MySQL 驱动从原来的 5.1.45 升级到了 8.0.22 版本。</li></ol><h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>生产数据库的配置是 <code>time_zone=SYSTEM</code>（对应 <code>system_time_zone=CST</code>，CST 时区没有标准，我们在使用 Java 客户端连接默认会把 CST 解析为时区+3，也就是当时事故出现的 5 小时误差）。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/show_variables.png"></p><p>应用配置连接数据库的 jdbc-url 没有显示设置时区。MySQL驱动如果升级版本到 8.0.11 和 8.0.22 区间，jdbc-url 必须显式设置时区。从 8.0.23 版本开始，<a href="https://dev.mysql.com/doc/relnotes/connector-j/8.0/en/news-8-0-23.html">官网修复了这个问题，不再需要显示设置时区。</a></p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql_bug_v8.0.22.png"></p><hr><p>从下面对比 8.0.22 和 8.0.23 版本的变化，可以看到官网把 8.0.22 版本获取 MySQL 服务端的代码移除了，默认获取客户端自身的系统变量，例如，在 K8s 环境设置的 <code>TZ=Asia/Shanghai</code>变量。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql_v8.0.22_upgrade_v8.0.23.png"></p><p>为什么 5.1.45 版本没有这个问题呢？从源码可以看出，5.1.x 版本，不显示设置时区，代码逻辑会直接绕过设置。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql_v5.1.44_vs_v8.0.22.png"></p><p>在我们拿到 PreparedStatement 设置插入的字段会自动使用我们程序所在的系统时区。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql_auto_set_timezone.png"></p><p>因升级 MySQL 驱动到 8.0.23 的风险比较大，我们决定在 jdbc-url 参数加上 <code>serverTimezone=GMT%2B8</code>，问题解决。</p><h1 id="故障复盘"><a href="#故障复盘" class="headerlink" title="故障复盘"></a>故障复盘</h1><p>为避免 MySQL 驱动版本的兼容性问题，K8s 默认设置 <code>TZ=Asia/Shanghai</code>，应用层接入 MySQL 最好显示设置 <code>serverTimezone=GMT%2B8</code>。</p>]]></content>
      
      
      <categories>
          
          <category> 线上排查 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 时区 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于 Sentinel 新增规则存储和监控回看</title>
      <link href="/2022/10/20/%E5%9F%BA%E4%BA%8E%20Sentinel%20%E6%96%B0%E5%A2%9E%E8%A7%84%E5%88%99%E5%AD%98%E5%82%A8%E5%92%8C%E7%9B%91%E6%8E%A7%E5%9B%9E%E7%9C%8B/"/>
      <url>/2022/10/20/%E5%9F%BA%E4%BA%8E%20Sentinel%20%E6%96%B0%E5%A2%9E%E8%A7%84%E5%88%99%E5%AD%98%E5%82%A8%E5%92%8C%E7%9B%91%E6%8E%A7%E5%9B%9E%E7%9C%8B/</url>
      
        <content type="html"><![CDATA[<p>Sentinel 是阿里巴巴开源的流量治理平台，提供了流量控制、熔断降级、系统负载保护、黑白名单访问控制等功能。</p><p>在实际的生产应用中，我们遇到以下几个问题：</p><ol><li>Sentinel 控制台不支持流控规则持久化，需要自行扩展。</li><li>Sentinel 控制台的监控数据只保存到内存中，只能查看近 5 分钟的数据。</li></ol><p>基于上面的问题，笔者 fork 了官方最新的源码进行二次开发，并打包镜像到 Docker Hub，方便大家使用。</p><ul><li>Github 地址：<a href="https://github.com/shiyindaxiaojie/sentinel">传送门</a></li><li>Docker Hub 地址：<a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/sentinel-dashboard/tags">传送门</a></li></ul><h1>改造内容</h1><ul><li><p>新增<strong>流控规则持久化</strong>支持，适配 <code>Apollo</code>、<code>Nacos</code>、<code>Zookeeper</code> 等组件。</p></li><li><p>新增<strong>监控数据持久化</strong>机制，适配 <code>InfluxDB</code>、<code>Kafka</code>、<code>Elasticsearch</code> 等组件，您可以通过时间控制回看历史数据。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/sentinel/sentinel-dashboard-overview-custom.png" alt=""><br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/sentinel/sentinel-dashboard-overview-quick.png" alt=""></p></li></ul><h1>部署教程</h1><h2 id="配置微调">配置微调</h2><p>在实际的生产需求，Sentinel 保存的规则和监控是需要持久化落盘的，因此，您可以在 <code>sentinel-dashboard/src/main/resources/application.properties</code> 接入外部组件。</p><p>规则存储类型支持：memory（默认）、nacos（推荐）、apollo、zookeeper</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 规则存储类型，可选项：memory（默认）、nacos（推荐）、apollo、zookeeper</span></span><br><span class="line"><span class="attr">sentinel.rule.type</span>=<span class="string">nacos</span></span><br><span class="line"><span class="comment"># Nacos 存储规则，如果您设置了 sentinel.metrics.type=nacos，需要调整相关配置</span></span><br><span class="line"><span class="attr">sentinel.rule.nacos.server-addr</span>=<span class="string">localhost:8848</span></span><br><span class="line"><span class="attr">sentinel.rule.nacos.namespace</span>=<span class="string">demo</span></span><br><span class="line"><span class="attr">sentinel.rule.nacos.group-id</span>=<span class="string">sentinel</span></span><br><span class="line"><span class="attr">sentinel.rule.nacos.username</span>=<span class="string">nacos</span></span><br><span class="line"><span class="attr">sentinel.rule.nacos.password</span>=<span class="string">nacos</span></span><br><span class="line"><span class="comment"># Apollo 存储规则，如果您设置了 sentinel.metrics.type=apollo，需要调整相关配置</span></span><br><span class="line"><span class="attr">sentinel.rule.apollo.portal-url</span>=<span class="string">http://localhost:10034</span></span><br><span class="line"><span class="attr">sentinel.rule.apollo.token</span>=<span class="string"></span></span><br><span class="line"><span class="attr">sentinel.rule.apollo.env</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># Zookeeper 存储规则，如果您设置了 sentinel.metrics.type=zookeeper，需要调整相关配置</span></span><br><span class="line"><span class="attr">sentinel.rule.zookeeper.connect-string</span>=<span class="string">localhost:2181</span></span><br><span class="line"><span class="attr">sentinel.rule.zookeeper.root-path</span>=<span class="string">/sentinel_rule</span></span><br></pre></td></tr></table></figure><p>监控存储类型支持：memory（默认）、influxdb（推荐）、elasticsearch、kafka</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控存储类型，可选项：memory（默认）、influxdb（推荐）、elasticsearch</span></span><br><span class="line"><span class="attr">sentinel.metrics.type</span>=<span class="string">memory</span></span><br><span class="line"><span class="comment"># InfluxDB 存储监控数据，如果您设置了 sentinel.metrics.type=influxdb，需要调整相关配置</span></span><br><span class="line"><span class="attr">influx.url</span>=<span class="string">http://localhost:8086/</span></span><br><span class="line"><span class="attr">influx.token</span>=<span class="string">UfgaW37A93PkncmJum25G7M2QkBg6xqqjGthh-o-UIVIynC_-Q7RFWlTtEpMqhGLCuAsX64k3Isc2uN33YgElw==</span></span><br><span class="line"><span class="attr">influx.org</span>=<span class="string">sentinel</span></span><br><span class="line"><span class="attr">influx.bucket</span>=<span class="string">sentinel</span></span><br><span class="line"><span class="attr">influx.log-level</span>=<span class="string">NONE</span></span><br><span class="line"><span class="attr">influx.read-timeout</span>=<span class="string">10s</span></span><br><span class="line"><span class="attr">influx.write-timeout</span>=<span class="string">10s</span></span><br><span class="line"><span class="attr">influx.connect-timeout</span>=<span class="string">10s</span></span><br><span class="line"><span class="comment"># Elasticsearch 存储监控数据，如果您设置了 sentinel.metrics.type=elasticsearch，需要调整相关配置</span></span><br><span class="line"><span class="attr">sentinel.metrics.elasticsearch.index-name</span>=<span class="string">sentinel_metric</span></span><br><span class="line"><span class="attr">spring.elasticsearch.rest.uris</span>=<span class="string">http://localhost:9200</span></span><br><span class="line"><span class="attr">spring.elasticsearch.rest.connection-timeout</span>=<span class="string">3000</span></span><br><span class="line"><span class="attr">spring.elasticsearch.rest.read-timeout</span>=<span class="string">5000</span></span><br><span class="line"><span class="attr">spring.elasticsearch.rest.username</span>=<span class="string"></span></span><br><span class="line"><span class="attr">spring.elasticsearch.rest.password</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 监控数据存储缓冲设置，降低底层存储组件写入压力。可选项：none（默认不启用）、kafka（推荐）</span></span><br><span class="line"><span class="attr">sentinel.metrics.sender.type</span>=<span class="string">none</span></span><br><span class="line"><span class="comment"># Kafka 存储监控数据，如果您设置了 sentinel.metrics.sender.type=kafka，需要调整相关配置</span></span><br><span class="line"><span class="attr">sentinel.metrics.sender.kafka.topic</span>=<span class="string">sentinel_metric</span></span><br><span class="line"><span class="attr">spring.kafka.producer.bootstrap-servers</span>=<span class="string">localhost:9092</span></span><br><span class="line"><span class="attr">spring.kafka.producer.batch-size</span>=<span class="string">4096</span></span><br><span class="line"><span class="attr">spring.kafka.producer.buffer-memory</span>=<span class="string">40960</span></span><br><span class="line"><span class="attr">spring.kafka.producer.key-serializer</span>=<span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br><span class="line"><span class="attr">spring.kafka.producer.value-serializer</span>=<span class="string">org.apache.kafka.common.serialization.StringSerializer</span></span><br></pre></td></tr></table></figure><h2 id="FatJar-部署">FatJar 部署</h2><p>执行 <code>mvn clean package</code> 打包成一个 fat jar，参考如下命令启动编译后的控制台。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=8080 \</span><br><span class="line">-Dsentinel.rule.nacos.server-addr=localhost:8848 \</span><br><span class="line">-Dsentinel.rule.nacos.namespace=demo \</span><br><span class="line">-Dsentinel.rule.nacos.group-id=sentinel \</span><br><span class="line">-Dsentinel.metrics.type=influxdb \</span><br><span class="line">-Dinflux.url=http://localhost:8086 \</span><br><span class="line">-Dinflux.token=XXXXXX \</span><br><span class="line">-Dinflux.org=sentinel \</span><br><span class="line">-Dinflux.bucket=sentinel \</span><br><span class="line">-jar target/sentinel-dashboard.jar</span><br></pre></td></tr></table></figure><h2 id="Docker-部署">Docker 部署</h2><p>本项目已发布稳定的镜像到 <a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/sentinel/tags">Docker Hub</a>，您可以直接使用如下命令，完成部署。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8090:8090 --name=sentinel-dashboard -d shiyindaxiaojie/sentinel-dashboard</span><br></pre></td></tr></table></figure><h2 id="Kubernetes-部署">Kubernetes 部署</h2><p>建议使用 StatefulSet 部署，YAML 示例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sentinel-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PATH</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/usr/local/openjdk-11/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_HOME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/usr/local/openjdk-11</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SPRING_OUTPUT_ANSI_ENABLED</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">ALWAYS</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">sentinel-dashboard</span></span><br><span class="line">              <span class="attr">optional:</span> <span class="literal">false</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_VERSION</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">11.0</span><span class="number">.16</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_SLEEP</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LANG</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">C.UTF-8</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">512m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMX</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">512m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMN</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">256m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVER_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;8090&quot;</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">shiyindaxiaojie/sentinel-dashboard:v1.8.6</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">sentinel-dashboard</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/app/application.properties</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">application</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">application.properties</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">application.properties</span></span><br><span class="line">            <span class="attr">mode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">application.properties</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">arthas-tunnel-server</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">application</span></span><br></pre></td></tr></table></figure><p>对应的 ConfigMap 如下，用于配置账号和权限。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sentinel-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">JAVA_OPTS:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    -Dsentinel.rule.nacos.server-addr=172.28.48.54:8848 -Dsentinel.rule.nacos.namespace=sentinel</span></span><br><span class="line"><span class="string">    -Dsentinel.rule.nacos.group-id=sentinel -Dsentinel.metrics.type=influxdb -Dinflux.url=http://influxdb:8086/</span></span><br><span class="line"><span class="string">    -Dinflux.token=tt_tScUmEysrDXO4ZusSYSlLS-1ivY1oAxJO44sofbFmzoGrGgs6zmgkA3JByaWFf9N9khH0txHBcHjmPM4qOA==</span></span><br><span class="line"><span class="string">    -Dinflux.org=puyiwm -Dinflux.bucket=sentinel</span></span><br></pre></td></tr></table></figure><h1>应用集成</h1><p>为了减少客户端集成的工作，推荐您使用 <a href="https://github.com/shiyindaxiaojie/eden-architect">eden-architect</a> 框架，只需要两步就可以完成 Sentinel 的集成。</p><p>引入 Sentinel 依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.shiyindaxiaojie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eden-sentinel-spring-cloud-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>开启 Sentinel 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span> <span class="comment"># 流量治理组件</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 默认关闭，请按需开启</span></span><br><span class="line">      <span class="attr">http-method-specify:</span> <span class="literal">true</span> <span class="comment"># 兼容 RESTful</span></span><br><span class="line">      <span class="attr">eager:</span> <span class="literal">true</span> <span class="comment"># 立刻刷新到 Dashboard</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8090</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">flow:</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="string">$&#123;spring.cloud.nacos.config.server-addr&#125;</span></span><br><span class="line">            <span class="attr">namespace:</span> <span class="string">$&#123;spring.cloud.nacos.config.namespace&#125;</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">sentinel</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">$&#123;spring.application.name&#125;-flow-rule</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span></span><br><span class="line">            <span class="attr">data-type:</span> <span class="string">json</span></span><br></pre></td></tr></table></figure><blockquote><p>当然，如果你不希望依赖 eden-architect，则可以参考<a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-cloud-starters/eden-sentinel-spring-cloud-starter">相关代码</a>实现自己的需求。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 可观测性 </tag>
            
            <tag> 二次开发 </tag>
            
            <tag> 中间件 </tag>
            
            <tag> 阿里巴巴 </tag>
            
            <tag> 限流熔断 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于 Arthas 新增权限控制和服务发现</title>
      <link href="/2022/09/09/%E5%9F%BA%E4%BA%8E%20Arthas%20%E6%96%B0%E5%A2%9E%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/"/>
      <url>/2022/09/09/%E5%9F%BA%E4%BA%8E%20Arthas%20%E6%96%B0%E5%A2%9E%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<p>Arthas 是阿里巴巴开源的在线诊断工具，提供了 <code>Dashboard</code> 负载总览、<code>Thread</code> 线程占用、<code>Stack</code> 堆栈查看、<code>Watch</code> 性能观测等功能。</p><p>在实际的生产应用中，我们遇到以下几个问题：</p><ol><li>Arthas 控制台没有权限控制，一旦访问 IP 暴露，就有安全问题。</li><li>Arthas 控制台需要提前知道 AgentId 才能访问，不适合 K8s 扩容管理。</li></ol><p>基于上面的问题，笔者 fork 了官方最新的源码进行二次开发，并打包镜像到 Docker Hub，方便大家使用。</p><ul><li>Github 地址：<a href="https://github.com/shiyindaxiaojie/arthas">传送门</a></li><li>Docker Hub 地址：<a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/arthas-tunnel-server/tags">传送门</a></li></ul><h1>改造内容</h1><ul><li><p>新增<strong>服务发现</strong>支持，自动获取接入的应用列表 IP 和端口，无须手动输入 AgentId。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/arthas/arthas-dashboard-overview.png" alt=""></p></li><li><p>新增<strong>权限控制</strong>机制，授权用户输入用户密码登录后，在控制台只能操作已授权的应用。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/arthas/arthas-dashboard-login.png" alt=""></p></li></ul><h1>部署教程</h1><h2 id="FatJar-部署">FatJar 部署</h2><p>执行 <code>mvn clean package</code> 打包成一个 fat jar，参考如下命令启动编译后的控制台。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Dserver.port=8080 -jar target/arthas-tunnel-server.jar</span><br></pre></td></tr></table></figure><h2 id="Docker-部署">Docker 部署</h2><p>本项目已发布稳定的镜像到 <a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/arthas/tags">Docker Hub</a>，您可以直接使用如下命令，完成部署。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 8080:8080 --name=arthas-tunnel-server -d shiyindaxiaojie/arthas-tunnel-server</span><br></pre></td></tr></table></figure><h2 id="Kubernetes-部署">Kubernetes 部署</h2><p>建议使用 StatefulSet 部署，YAML 示例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">arthas-tunnel-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">shiyindaxiaojie/arthas-tunnel-server:v3.6.7</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cat-home</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/app/application.properties</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">application</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">application.properties</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">application.properties</span></span><br><span class="line">            <span class="attr">mode:</span> <span class="number">420</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">application.properties</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">arthas-tunnel-server</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">application</span></span><br></pre></td></tr></table></figure><p>对应的 ConfigMap 如下，用于配置账号和权限。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">arthas-tunnel-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">application.properties:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    arthas.server.host=0.0.0.0</span></span><br><span class="line"><span class="string">    arthas.server.port=7777</span></span><br><span class="line"><span class="string">    arthas.enable-detail-pages=false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="string">spring.cache.type=caffeine</span></span><br><span class="line">    <span class="string">spring.cache.cache-names=inMemoryClusterCache</span></span><br><span class="line">    <span class="string">spring.cache.caffeine.spec=maximumSize=3000,expireAfterAccess=3600s</span></span><br><span class="line"></span><br><span class="line">    <span class="string">spring.security.jwt.secret=base64码</span></span><br><span class="line">    <span class="string">spring.security.jwt.token-validity-in-seconds=604800</span></span><br><span class="line">    <span class="comment"># Administrator</span></span><br><span class="line">    <span class="string">spring.security.users[0].name=admin</span></span><br><span class="line">    <span class="string">spring.security.users[0].password=123456</span></span><br><span class="line">    <span class="string">spring.security.users[0].roles=ADMIN</span></span><br><span class="line">    <span class="comment"># Custom User</span></span><br><span class="line">    <span class="string">spring.security.users[1].name=user</span></span><br><span class="line">    <span class="string">spring.security.users[1].password=123456</span></span><br><span class="line">    <span class="string">spring.security.users[1].roles=eden-*</span></span><br></pre></td></tr></table></figure><h1>应用集成</h1><p>为了减少客户端集成的工作，推荐您使用 <a href="https://github.com/shiyindaxiaojie/eden-architect">eden-architect</a> 框架，只需要两步就可以完成 Arthas 的集成。</p><p>引入 Arthas 依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.shiyindaxiaojie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eden-arthas-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>开启 Arthas 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">arthas:</span> </span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 默认关闭，请按需开启，支持零停机开启和关闭</span></span><br><span class="line"></span><br><span class="line"><span class="attr">arthas:</span> <span class="comment"># 在线诊断工具</span></span><br><span class="line">  <span class="attr">agent-id:</span> <span class="string">$&#123;spring.application.name&#125;@$&#123;random.value&#125;</span></span><br><span class="line">  <span class="attr">tunnel-server:</span> <span class="string">ws://localhost:7777/ws</span> <span class="comment"># Arthas 地址</span></span><br><span class="line">  <span class="attr">session-timeout:</span> <span class="number">1800</span></span><br><span class="line">  <span class="attr">telnet-port:</span> <span class="number">0</span> <span class="comment"># 随机端口</span></span><br><span class="line">  <span class="attr">http-port:</span> <span class="number">0</span> <span class="comment"># 随机端口</span></span><br></pre></td></tr></table></figure><p>启动您的项目，在控制台中查看到应用列表，就可以看到您的应用了。</p><blockquote><p>当然，如果你不希望依赖 eden-architect，则可以参考<a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-boot-starters/eden-arthas-spring-boot-starter">相关代码</a>实现自己的需求。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 可观测性 </tag>
            
            <tag> 二次开发 </tag>
            
            <tag> 中间件 </tag>
            
            <tag> 在线诊断 </tag>
            
            <tag> 阿里巴巴 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>

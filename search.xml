<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>新手必看！10分钟带你解决 CAT 链路跟踪。</title>
      <link href="/2024/05/01/%E6%96%B0%E6%89%8B%E5%BF%85%E7%9C%8B%EF%BC%8110%E5%88%86%E9%92%9F%E5%B8%A6%E4%BD%A0%E8%A7%A3%E5%86%B3%20CAT%20%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98%E3%80%82/"/>
      <url>/2024/05/01/%E6%96%B0%E6%89%8B%E5%BF%85%E7%9C%8B%EF%BC%8110%E5%88%86%E9%92%9F%E5%B8%A6%E4%BD%A0%E8%A7%A3%E5%86%B3%20CAT%20%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98%E3%80%82/</url>
      
        <content type="html"><![CDATA[<h1 id="CAT-升级版改造"><a href="#CAT-升级版改造" class="headerlink" title="CAT 升级版改造"></a>CAT 升级版改造</h1><p>CAT 是美团点评开源的实时应用监控平台，提供了 <code>Tracsaction</code>、<code>Event</code>、<code>Problem</code>、<code>Business</code> 等丰富的指标项。在官方的 Issue 经常遇到以下几个问题</p><ol><li>为什么 CAT 启动不起来？</li><li>能不能支持链路跟踪？</li><li>如何配置告警？</li><li>能不能接入钉钉、飞书机器人推送？</li></ol><p>基于上面的需求，笔者 fork 了官方最新的源码进行二次开发，并打包镜像到 Docker Hub，方便大家使用。</p><ul><li>Github 地址：<a href="https://github.com/shiyindaxiaojie/cat">传送门</a></li><li>Docker Hub 地址：<a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/cat-home">传送门</a></li></ul><h2 id="改进了什么？"><a href="#改进了什么？" class="headerlink" title="改进了什么？"></a>改进了什么？</h2><ul><li><p>Docker 部署更方便，不需要额外挂载配置文件，只需要提供 JVM 参数和 MySQL 配置即可完成部署。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e MYSQL_URL=<span class="string">&quot;127.0.0.1&quot;</span> -e MYSQL_PORT=<span class="string">&quot;3306&quot;</span> -e MYSQL_SCHEMA=<span class="string">&quot;cat&quot;</span> -e MYSQL_USERNAME=<span class="string">&quot;数据库账号&quot;</span> -e MYSQL_PASSWD=<span class="string">&quot;数据库密码&quot;</span> -p 8080:8080 --name=cat-home -d shiyindaxiaojie/cat-home</span><br></pre></td></tr></table></figure></li><li><p>新增了<strong>链路跟踪</strong>支持，您可以通过日志打印的 TraceId 查找整个请求路径的 HTTP 请求耗时、RPC 调用情况、Log4j2 业务日志、SQL 和缓存执行耗时。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/tracing.png"></p></li><li><p>不需要额外实现告警接口，直接开箱即用，您可以直接在后台配置邮件、钉钉、微信、飞书机器人。如下图，触发告警后，钉钉将推送相关信息，您可以点击 <code>查看告警</code> 直达异常位置，也可以点击 <code>告警规则</code> 设置告警阈值，避免多次干扰。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/dingtalk.png"></p></li><li><p>告警流程一体化，当生产故障触发告警时，自动录入 Jira Software，便于研发内部跟进问题。</p><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/auto-create-jira-issue.png"></p></li></ul><h2 id="如何部署？"><a href="#如何部署？" class="headerlink" title="如何部署？"></a>如何部署？</h2><h3 id="运行环境建议"><a href="#运行环境建议" class="headerlink" title="运行环境建议"></a>运行环境建议</h3><ul><li>JDK 版本 &gt;&#x3D; 7</li><li>MySQL 5.7（亲测 8.0 会报错）</li><li>Tomcat 8.0+（使用容器部署时可忽略）</li><li>Linux 内核版本 &gt;&#x3D; 2.6</li></ul><h3 id="在-Tomcat-下部署"><a href="#在-Tomcat-下部署" class="headerlink" title="在 Tomcat 下部署"></a>在 Tomcat 下部署</h3><p>从 <a href="https://github.com/shiyindaxiaojie/cat/releases/tag/v3.4.0">Release</a> 下载相关文件，<br>拷贝 <code>client.xml</code> 和 <code>datasources.xml</code> 到用户目录 <code>~/.cat/appdatas/cat</code> 中，根据实际情况调整数据库配置。</p><p>将 <code>cat.war</code> 部署在目标 <code>Tomcat</code> 的 <code>webapps</code> 目录下，启动 <code>Tomcat</code>，访问 <code>http://localhost:8080/cat</code> 即可。原则上请保持 <code>Tomcat</code> 的端口为 <code>8080</code>，遇到项目启动失败的情况，建议查看 <code>~/.cat/applog/</code> 目录下的日志。</p><h3 id="在-Docker-下部署"><a href="#在-Docker-下部署" class="headerlink" title="在 Docker 下部署"></a>在 Docker 下部署</h3><p>本项目已发布稳定的镜像到 <a href="https://hub.docker.com/repository/docker/shiyindaxiaojie/cat-home/tags">Docker Hub</a>，您可以直接使用如下命令，提供 JVM 参数和 MySQL 配置，完成部署。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -e MYSQL_URL=<span class="string">&quot;127.0.0.1&quot;</span> -e MYSQL_PORT=<span class="string">&quot;3306&quot;</span> -e MYSQL_SCHEMA=<span class="string">&quot;cat&quot;</span> -e MYSQL_USERNAME=<span class="string">&quot;数据库账号&quot;</span> -e MYSQL_PASSWD=<span class="string">&quot;数据库密码&quot;</span> -p 8080:8080 --name=cat-home -d shiyindaxiaojie/cat-home</span><br></pre></td></tr></table></figure><h3 id="在-Kubernetes-下部署"><a href="#在-Kubernetes-下部署" class="headerlink" title="在 Kubernetes 下部署"></a>在 Kubernetes 下部署</h3><p>建议使用 StatefulSet 部署，YAML 示例如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cat-home</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">-Xmx1536m</span> <span class="string">-Xms1536m</span> <span class="string">-Xmn1024m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">数据库地址</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;3306&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_USERNAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">数据库账号</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">数据库密码</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_SCHEMA</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">CAT</span> <span class="string">数据库名称</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVER_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">CAT</span> <span class="string">运行地址</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">1536m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMX</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">1536m</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JVM_XMN</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">1024m</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">shiyindaxiaojie/cat-home:v3.4.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">lifecycle:</span></span><br><span class="line">          <span class="attr">preStop:</span></span><br><span class="line">            <span class="attr">exec:</span></span><br><span class="line">              <span class="attr">command:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">curl</span> <span class="string">http://localhost:8080/cat/r/home?op=checkpoint</span> <span class="string">&amp;&amp;</span> <span class="string">sleep</span> <span class="number">30</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cat-home</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/appdatas/cat/bucket</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">appdatas</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/applogs</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">applogs</span></span><br><span class="line">      <span class="attr">volumes:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">nfs:</span> <span class="comment"># 此处省略，请根据实际情况配置</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">log</span></span><br><span class="line">        <span class="attr">nfs:</span> <span class="comment"># 此处省略，请根据实际情况配置</span></span><br></pre></td></tr></table></figure><h3 id="如何部署生产集群？"><a href="#如何部署生产集群？" class="headerlink" title="如何部署生产集群？"></a>如何部署生产集群？</h3><p>推荐使用 Kubernetes 部署生产集群，假设部署三个节点，一个节点为监控节点，另外两个节点为消费节点，如下配置：</p><ul><li>监控节点：10.1.1.1</li><li>消费节点：10.1.1.2</li><li>消费节点：10.1.1.3</li></ul><ol><li>请复制上面的 YAML，将 SERVER_URL 参数调整为 <code>10.1.1.1,10.1.1.2,10.1.1.3</code>。</li></ol>  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cat-home</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitoring</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">OrderedReady</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span> &#123;&#125;</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVER_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">10.1</span><span class="number">.1</span><span class="number">.1</span><span class="string">,10.1.1.2,10.1.1.3</span></span><br></pre></td></tr></table></figure><ol start="2"><li>启动后，点击顶部导航栏 <code>配置</code>，从左侧 <code>系统配置</code> 设置 <code>服务端配置</code>。</li></ol><p>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-config.png"></p><p>  配置内容如下：</p>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server-config</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 默认不开启监控 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;local-mode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;job-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;send-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;alarm-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hdfs-enabled&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;remote-servers&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10.1.1.1:8080,10.1.1.2:8080,10.1.1.3:8080&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">storage</span> <span class="attr">local-base-dir</span>=<span class="string">&quot;/data/appdatas/cat/bucket/&quot;</span> <span class="attr">max-hdfs-storage-time</span>=<span class="string">&quot;15&quot;</span> <span class="attr">local-report-storage-time</span>=<span class="string">&quot;30&quot;</span> <span class="attr">local-logivew-storage-time</span>=<span class="string">&quot;30&quot;</span> <span class="attr">har-mode</span>=<span class="string">&quot;true&quot;</span> <span class="attr">upload-thread</span>=<span class="string">&quot;5&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hdfs</span> <span class="attr">id</span>=<span class="string">&quot;dump&quot;</span> <span class="attr">max-size</span>=<span class="string">&quot;128M&quot;</span> <span class="attr">server-uri</span>=<span class="string">&quot;hdfs://127.0.0.1/&quot;</span> <span class="attr">base-dir</span>=<span class="string">&quot;/user/cat/dump&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">harfs</span> <span class="attr">id</span>=<span class="string">&quot;dump&quot;</span> <span class="attr">max-size</span>=<span class="string">&quot;128M&quot;</span> <span class="attr">server-uri</span>=<span class="string">&quot;har://127.0.0.1/&quot;</span> <span class="attr">base-dir</span>=<span class="string">&quot;/user/cat/dump&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hadoop.security.authentication&quot;</span> <span class="attr">value</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dfs.namenode.kerberos.principal&quot;</span> <span class="attr">value</span>=<span class="string">&quot;hadoop/dev80.hadoop@testserver.com&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dfs.cat.kerberos.principal&quot;</span> <span class="attr">value</span>=<span class="string">&quot;cat@testserver.com&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dfs.cat.keytab.file&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/data/appdatas/cat/cat.keytab&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;java.security.krb5.realm&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value1&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;java.security.krb5.kdc&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">storage</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">consumer</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">long-config</span> <span class="attr">default-url-threshold</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">default-sql-threshold</span>=<span class="string">&quot;100&quot;</span> <span class="attr">default-service-threshold</span>=<span class="string">&quot;50&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">domain</span> <span class="attr">name</span>=<span class="string">&quot;cat&quot;</span> <span class="attr">url-threshold</span>=<span class="string">&quot;500&quot;</span> <span class="attr">sql-threshold</span>=<span class="string">&quot;500&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">domain</span> <span class="attr">name</span>=<span class="string">&quot;OpenPlatformWeb&quot;</span> <span class="attr">url-threshold</span>=<span class="string">&quot;100&quot;</span> <span class="attr">sql-threshold</span>=<span class="string">&quot;500&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">long-config</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">consumer</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 将 10.1.1.1 设置为监控节点，其他节点设置为消费节点 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;job-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;send-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;alarm-machine&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server-config</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>再从左侧 <code>系统配置</code> 设置 <code>客户端路由</code> 。</li></ol><p>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/client-route-config.png"></p><p>  配置内容如下：</p>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">router-config</span> <span class="attr">backup-server</span>=<span class="string">&quot;10.1.1.1&quot;</span> <span class="attr">backup-server-port</span>=<span class="string">&quot;2280&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 监控节点不开启消费，其他节点开启消费，可以根据实际情况调整 weight 权重 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">default-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.1&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">default-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.2&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">default-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.3&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">network-policy</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span> <span class="attr">title</span>=<span class="string">&quot;default&quot;</span> <span class="attr">block</span>=<span class="string">&quot;false&quot;</span> <span class="attr">server-group</span>=<span class="string">&quot;default_group&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">network-policy</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">server-group</span> <span class="attr">id</span>=<span class="string">&quot;default_group&quot;</span> <span class="attr">title</span>=<span class="string">&quot;default-group&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.2&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group-server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.3&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">server-group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">domain</span> <span class="attr">id</span>=<span class="string">&quot;cat&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.2&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">server</span> <span class="attr">id</span>=<span class="string">&quot;10.1.1.3&quot;</span> <span class="attr">port</span>=<span class="string">&quot;2280&quot;</span> <span class="attr">weight</span>=<span class="string">&quot;1.0&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">router-config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>  配置完成后，查看<code>首页</code>的<code>系统状态</code>，集群配置已生效，如下图，监控节点只负责控制台的数据展示和告警通知，不消费客户端的数据。<br>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/cluster-monitor-node.png"></p><p>  数据消费节点会消费客户端发送的数据，根据客户端路由设置的权重策略均摊数据。<br>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/cluster-data-node.png"></p><h2 id="链路跟踪怎么用？"><a href="#链路跟踪怎么用？" class="headerlink" title="链路跟踪怎么用？"></a>链路跟踪怎么用？</h2><p>为了减少客户端集成的工作，推荐您使用<a href="https://github.com/shiyindaxiaojie/eden-architect">eden-architect</a>框架，这个框架内置实现了链路ID的记录，只需要根据以下两步就可以完成 CAT 的集成。</p><ol><li><p>引入 CAT 依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.shiyindaxiaojie<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eden-cat-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>开启 CAT 配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cat:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># 默认关闭，请按需开启</span></span><br><span class="line">  <span class="attr">trace-mode:</span> <span class="literal">true</span> <span class="comment"># 开启访问观测</span></span><br><span class="line">  <span class="attr">support-out-trace-id:</span> <span class="literal">false</span> <span class="comment"># 允许异构子系统间透传链路ID</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">servers:</span> <span class="string">localhost</span> <span class="comment"># CAT 地址</span></span><br><span class="line">  <span class="attr">tcp-port:</span> <span class="number">2280</span></span><br><span class="line">  <span class="attr">http-port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果您使用 Dubbo 组件，请增加对应的过滤器，确保 CAT 埋点正常工作</span></span><br><span class="line"><span class="attr">dubbo:</span></span><br><span class="line">  <span class="attr">provider:</span></span><br><span class="line">    <span class="attr">filter:</span> <span class="string">cat-tracing</span></span><br><span class="line">  <span class="attr">consumer:</span></span><br><span class="line">    <span class="attr">filter:</span> <span class="string">cat-tracing,cat-consumer</span></span><br></pre></td></tr></table></figure></li><li><p>启动您的项目，调用接口，查看控制台输出的日志内容，红圈中就是 CAT 的链路ID。</p></li></ol><p>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/traceid-of-logging.png"></p><p>  根据链路ID，在 CAT 中查看详细链路信息。</p><p>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/tracing.png"></p><blockquote><p>当然，如果你不希望依赖 eden-architect，则可以参考<a href="https://github.com/shiyindaxiaojie/eden-architect/tree/main/eden-components/eden-spring-integration/src/main/java/org/ylzl/eden/spring/integration/cat/integration">相关代码</a>实现自己的需求。关于相关代码的实现原理，笔者将在后面的文章中给出。</p></blockquote><h2 id="如何配置告警通知？"><a href="#如何配置告警通知？" class="headerlink" title="如何配置告警通知？"></a>如何配置告警通知？</h2><p>目前 CAT 经过二次开发，实现了告警通知的开箱即用，您只需要微调相关配置，即可开启告警通知功能。</p><p>内置告警通知支持以下方式：邮件、钉钉、飞书、微信、Jira Software，配置步骤如下：</p><ol><li>进入 <code>配置</code>，点击 <code>系统配置</code> 的 <code>告警渠道</code>，如下图：</li></ol><p>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/alert-config.png"></p><p>  以 <code>邮件</code>、<code>钉钉</code>、<code>Jira Software</code> 为例，内容如下：</p>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sender-config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sender</span> <span class="attr">id</span>=<span class="string">&quot;mail&quot;</span> <span class="attr">url</span>=<span class="string">&quot;smtp.qq.com:25&quot;</span> <span class="attr">type</span>=<span class="string">&quot;post&quot;</span> <span class="attr">successCode</span>=<span class="string">&quot;200&quot;</span> <span class="attr">batchSend</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">par</span> <span class="attr">id</span>=<span class="string">&quot;username=发件人邮箱地址&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">par</span> <span class="attr">id</span>=<span class="string">&quot;password=发件人邮箱密码&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sender</span> <span class="attr">id</span>=<span class="string">&quot;dingtalk&quot;</span> <span class="attr">url</span>=<span class="string">&quot;https://oapi.dingtalk.com/robot/send?access_token=&quot;</span> <span class="attr">type</span>=<span class="string">&quot;post&quot;</span> <span class="attr">successCode</span>=<span class="string">&quot;200&quot;</span> <span class="attr">batchSend</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sender</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">sender</span> <span class="attr">id</span>=<span class="string">&quot;jira&quot;</span> <span class="attr">url</span>=<span class="string">&quot;http://localhost:8080&quot;</span> <span class="attr">type</span>=<span class="string">&quot;post&quot;</span> <span class="attr">successCode</span>=<span class="string">&quot;200&quot;</span> <span class="attr">batchSend</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">par</span> <span class="attr">id</span>=<span class="string">&quot;reporter_token=凭据&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">sender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sender-config</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>设置 <code>系统配置</code> 的 <code>告警策略</code>，即 CAT 埋点达到告警阈值时发送的接收对象，例如 <code>dingtalk</code>、<code>mail</code>、<code>jira</code>，如下图：</li></ol><p>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/alert-strategy.png"></p><p>  内容如下：</p>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">alert-policy</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Transaction&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Event&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Exception&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail,jira&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail,jira&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Business&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;Heartbeat&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">group</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;warning&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;5&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">id</span>=<span class="string">&quot;error&quot;</span> <span class="attr">send</span>=<span class="string">&quot;dingtalk,mail&quot;</span> <span class="attr">suspendMinute</span>=<span class="string">&quot;10&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">alert-policy</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>设置 <code>系统配置</code> 的 <code>告警对象</code>，即告警通知接收对象，如下图：</li></ol><p>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/alert-receiver.png"></p><p>  内容如下，笔者设置了 <code>Exception</code> 类型的告警：</p>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">alert-config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Transaction&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Event&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Exception&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">email</span>&gt;</span>您的邮箱<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">jira</span>&gt;</span>reporterName=monitor<span class="symbol">&amp;amp;</span>issueType=故障<span class="symbol">&amp;amp;</span>components=架构<span class="symbol">&amp;amp;</span>fixVersionNames=待定<span class="tag">&lt;/<span class="name">jira</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dingtalk</span>&gt;</span>您的钉钉机器人Token<span class="tag">&lt;/<span class="name">dingtalk</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Heartbeat&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;Business&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">receiver</span> <span class="attr">id</span>=<span class="string">&quot;default&quot;</span> <span class="attr">enable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">alert-config</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="4"><li>接下来设置 <code>Server</code> 的 <code>异常告警配置</code>，如下图：<br>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-exception-alert-config.png"></li></ol><p>  配置界面如下，应用名称填写 <code>default</code> 表示监控所有服务，您可以指定自己的服务名称独立监控。异常名称建议填写 <code>Total</code>，表示监控所有异常，如果您需要监控某个异常，则填写该异常名称即可：<br>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-exception-alert-config-editable.png"></p><p>  如果有些异常是不需要监控的，请在<code>异常过滤</code>列表添加。<br>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/server-exception-alert-config-ignore.png"></p><ol start="5"><li>配置完成，笔者设置了所有异常出现 5 次时发送告警，10 次时发送告警。达到这个阈值时，邮件会发送到 &#96;&#96;：</li></ol><p>  <img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cat/mail.png"></p>]]></content>
      
      
      <categories>
          
          <category> 中间件 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 链路跟踪 </tag>
            
            <tag> 可观测性 </tag>
            
            <tag> 二次开发 </tag>
            
            <tag> 中间件 </tag>
            
            <tag> 美团 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 存储 emoji 报错，怎么解决？</title>
      <link href="/2023/02/10/MySQL%20%E5%AD%98%E5%82%A8%20emoji%20%E6%8A%A5%E9%94%99%EF%BC%8C%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3%EF%BC%9F/"/>
      <url>/2023/02/10/MySQL%20%E5%AD%98%E5%82%A8%20emoji%20%E6%8A%A5%E9%94%99%EF%BC%8C%E6%80%8E%E4%B9%88%E8%A7%A3%E5%86%B3%EF%BC%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>在特定业务场景（帖子、评论、个人签名）存储 emoji 表情。如果使用 <code>utf8</code> 字符集存储，会抛出如下错误：<br><code>java.sql.SQLException: Incorrect string value: &#39;\xF0\x9F\x92\x94&#39; for column &#39;name&#39; at row 1</code></p><h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><p>MySQL 的 <code>utf8</code> 编码最多支持 3 个字节，而 emoji 表情需要占用 4 个字节，在早期的版本并没有实现真正意义上的 <code>utf8</code> 字符集。MySQL 从 <code>5.5.3</code> 版本开始支持 <code>utf8mb4</code> 字符集。</p><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><table><thead><tr><th><strong>备选方案</strong></th><th><strong>改造点</strong></th><th><strong>优缺点</strong></th></tr></thead><tbody><tr><td>把 <code>utf8</code> 编码改为 <code>utf8mb4</code></td><td>客户端修改会话字符集<br />服务端调整相关库表的字符集</td><td>更改大数据表困难</td></tr><tr><td>写入数据时编码，读取数据时解码还原</td><td>程序对每一个需要处理的字段进行修改，工作量不可控</td><td>不用修改生产数据库，DB 可读性差，额外性能消耗</td></tr></tbody></table><p>正常情况下，我们会选择前者来解决这个问题。</p><ol><li>查看 MySQL 服务端的字符集，确认是否为 <code>utf8mb4</code>。</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">WHERE</span> VARIABLE_NAME <span class="keyword">LIKE</span> <span class="string">&#x27;character_set_database&#x27;</span> <span class="keyword">OR</span> VARIABLE_NAME <span class="keyword">LIKE</span> <span class="string">&#x27;collation%&#x27;</span>;</span><br></pre></td></tr></table></figure><p>如果不是，进行调整，调整 MySQL 的配置文件，内容如下。</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">default-character-set</span> = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">character-set-server</span> = utf8mb4</span><br><span class="line"><span class="attr">collation-server</span> = utf8mb4_unicode_ci</span><br><span class="line"><span class="attr">init_connect</span>=<span class="string">&#x27;SET NAMES utf8mb4&#x27;</span></span><br><span class="line"><span class="attr">character-set-client-handshake</span> = <span class="literal">FALSE</span></span><br></pre></td></tr></table></figure><p>重启 MySQL Server，重新确认 MySQL 服务端的字符集是否修改成功。</p><ol start="2"><li>调整 JDBC 连接串，不配置 characterEncoding 选项，让 MySQL 连接器选择服务端的字符集。</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql:<span class="operator">/</span><span class="operator">/</span>localhost:<span class="number">3306</span><span class="operator">/</span>db?useUnicode<span class="operator">=</span><span class="literal">true</span><span class="operator">&amp;&amp;</span>zeroDateTimeBehavior<span class="operator">=</span>convertToNull<span class="operator">&amp;</span>autoReconnect<span class="operator">=</span><span class="literal">true</span></span><br></pre></td></tr></table></figure><ol start="3"><li>检查客户端代码的会话字符集。有些云数据库的环境并不支持配置 <code>character-set-client-handshake</code> 或者 <code>init_connect</code> 这样的参数。您可以通过 <code>set names utf8mb4; </code>命令将 <code>character_set_client</code>、<code>character_set_connection</code>、<code>character_set_results</code> 等会话字符集相设置为 <code>utf8mb4</code>，以保证写入或者读出的数据使用 <code>utf8mb4</code> 字符集进行处理。例如 HikariCP 数据库连接池框架，在应用的配置项加上相关参数。</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">connection-init-sql:</span> <span class="string">SET</span> <span class="string">NAMES</span> <span class="string">utf8mb4</span></span><br></pre></td></tr></table></figure><ol start="4"><li>修改历史数据的字符集。对于存储了字符编码为 <code>utf8</code> 的历史数据，如果要支持 <code>utf8mb4</code> ，需要将已经存在的数据库、表、列的类型修改成 <code>utf8mb4</code>。首先，我们先调整数据库的默认字符集。</li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE <span class="operator">&lt;</span>database_name<span class="operator">&gt;</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure><p>MySQL 支持您修改表或者列的字符集。修改 Table 的字符集示例如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>table_name<span class="operator">&gt;</span> <span class="keyword">CONVERT</span> <span class="keyword">TO</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure><p>如果您不希望修改整个表的字符集，可以选择指定 Column 进行调整。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="operator">&lt;</span>table_name<span class="operator">&gt;</span> MODIFY <span class="keyword">COLUMN</span> <span class="operator">&lt;</span>column_name<span class="operator">&gt;</span> <span class="type">VARCHAR</span>(<span class="number">512</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_unicode_ci;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 问题排查 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 字符集问题 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深度排查 MySQL 时区误差 5 小时问题</title>
      <link href="/2023/01/10/%E6%B7%B1%E5%BA%A6%E6%8E%92%E6%9F%A5%20MySQL%20%E6%97%B6%E5%8C%BA%E8%AF%AF%E5%B7%AE%205%20%E5%B0%8F%E6%97%B6%E9%97%AE%E9%A2%98/"/>
      <url>/2023/01/10/%E6%B7%B1%E5%BA%A6%E6%8E%92%E6%9F%A5%20MySQL%20%E6%97%B6%E5%8C%BA%E8%AF%AF%E5%B7%AE%205%20%E5%B0%8F%E6%97%B6%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>最近经业务部门反馈，我们有个 APP 升级后，在 <code>2023-01-09 22:47</code> 发现，当前账号的最近登录时间为 <code>2023-01-10 03:47</code>，相差了 5 个小时。</p><ol><li>第一轮排查：我们第一印象会认为是刚升级的代码出了问题，有可能是日期格式化没处理好，也有可能是 JSON 序列化没有指定时区，经过 Git diff 排查，我们并没有修改相关代码。</li><li>第二轮排查：可能是有人动了生产配置！排除了配置中心的改动，也检查了 K8s 的 Deployment 是否正确设置了 TZ&#x3D;Asia&#x2F;Shanghai，依然无果。</li><li>第三轮排查：提取线上部署的 jar，经过对比，我们发现 MySQL 驱动从原来的 5.1.45 升级到了 8.0.22 版本。</li></ol><h1 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h1><ol><li>生产数据库的配置是 <code>time_zone=SYSTEM</code>（对应 <code>system_time_zone=CST</code>，CST 时区没有标准，我们在使用 Java 客户端连接默认会把 CST 解析为时区+3，也就是当时事故出现的 5 小时误差）。</li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/show_variables.png"></p><ol start="2"><li>应用配置连接数据库的 jdbc-url 没有显示设置时区。MySQL驱动如果升级版本到 8.0.11 和 8.0.22 区间，jdbc-url 必须显式设置时区。从 8.0.23 版本开始，<a href="https://dev.mysql.com/doc/relnotes/connector-j/8.0/en/news-8-0-23.html">官网修复了这个问题，不再需要显示设置时区。</a></li></ol><p><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql_bug_v8.0.22.png"></p><hr><p>从下面对比 8.0.22 和 8.0.23 版本的变化，可以看到官网把 8.0.22 版本获取 MySQL 服务端的代码移除了，默认获取客户端自身的系统变量，例如，在 K8s 环境设置的 <code>TZ=Asia/Shanghai</code>变量。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql_v8.0.22_upgrade_v8.0.23.png"><br>为什么 5.1.45 版本没有这个问题呢？从源码可以看出，5.1.x 版本，不显示设置时区，代码逻辑会直接绕过设置。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql_v5.1.44_vs_v8.0.22.png"><br>在我们拿到 PreparedStatement 设置插入的字段会自动使用我们程序所在的系统时区。<br><img src="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/mysql/mysql_auto_set_timezone.png"></p><h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><table><thead><tr><th><strong>备选方案</strong></th><th><strong>优缺点</strong></th></tr></thead><tbody><tr><td>显示设置 jdbc-url 字符集：<code>serverTimezone=GMT%2B8</code></td><td>推荐，不用改动程序</td></tr><tr><td>升级 MySQL 驱动到 8.0.23 以上</td><td>变更太大，需要重新发布生产</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> 问题排查 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 时区问题 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>

<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>CODING 持续部署实践 | 梦想歌の网络日志</title><meta name="author" content="梦想歌"><meta name="copyright" content="梦想歌"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="背景CODING 是腾讯云提供的云原生应用平台，提供了可视化的编排工具，支持 GitOps、CI&#x2F;CD、Helm、Kubernetes 等云原生技术。笔者所在的公司使用 Jenkins 构建，由运维团队负责管理 CI&#x2F;CD，效率低下，腾讯云给我们推广了这个产品，趁这个机会，笔者决定研究下 CODING。 目标探索 CODING 流水线使用，验证 CI&#x2F;CD 能力。 实">
<meta property="og:type" content="article">
<meta property="og:title" content="CODING 持续部署实践">
<meta property="og:url" content="https://mengxiangge.netlify.app/2022/08/10/devops/CODING%20%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/index.html">
<meta property="og:site_name" content="梦想歌の网络日志">
<meta property="og:description" content="背景CODING 是腾讯云提供的云原生应用平台，提供了可视化的编排工具，支持 GitOps、CI&#x2F;CD、Helm、Kubernetes 等云原生技术。笔者所在的公司使用 Jenkins 构建，由运维团队负责管理 CI&#x2F;CD，效率低下，腾讯云给我们推广了这个产品，趁这个机会，笔者决定研究下 CODING。 目标探索 CODING 流水线使用，验证 CI&#x2F;CD 能力。 实">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cover/CODING.png">
<meta property="article:published_time" content="2022-08-10T08:05:01.000Z">
<meta property="article:modified_time" content="2025-05-02T15:37:33.707Z">
<meta property="article:author" content="梦想歌">
<meta property="article:tag" content="CODING">
<meta property="article:tag" content="CI&#x2F;CD">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cover/CODING.png"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/hexo/favicon.ico"><link rel="canonical" href="https://mengxiangge.netlify.app/2022/08/10/devops/CODING%20%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 梦想歌","link":"链接: ","source":"来源: 梦想歌の网络日志","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'mediumZoom',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'CODING 持续部署实践',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-05-02 23:37:33'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/hexo/avatar.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/hexo/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">51</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">79</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 目录</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cover/CODING.png')"><nav id="nav"><span id="blog-info"><a href="/" title="梦想歌の网络日志"><span class="site-name">梦想歌の网络日志</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 目录</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">CODING 持续部署实践</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-08-10T08:05:01.000Z" title="发表于 2022-08-10 16:05:01">2022-08-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-05-02T15:37:33.707Z" title="更新于 2025-05-02 23:37:33">2025-05-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B9%B3%E5%8F%B0%E5%B7%A5%E7%A8%8B/">平台工程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>27分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="CODING 持续部署实践"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>CODING 是腾讯云提供的云原生应用平台，提供了可视化的编排工具，支持 GitOps、CI&#x2F;CD、Helm、Kubernetes 等云原生技术。笔者所在的公司使用 Jenkins 构建，由运维团队负责管理 CI&#x2F;CD，效率低下，腾讯云给我们推广了这个产品，趁这个机会，笔者决定研究下 CODING。</p>
<h1 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h1><p>探索 CODING 流水线使用，验证 CI&#x2F;CD 能力。</p>
<h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><p>以 <a target="_blank" rel="noopener" href="https://github.com/shiyindaxiaojie/eden-demo-cola">演示工程</a> 为例，使用 <code>Maven</code> 构建工具，目录结构如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">eden-demo-cola</span><br><span class="line">  |_ .coding/</span><br><span class="line">    |_ Jenkinsfile <span class="comment"># CODING 流水线脚本</span></span><br><span class="line">    |_ settings.xml <span class="comment"># 自定义Maven 配置文件</span></span><br><span class="line">  |_ docker/</span><br><span class="line">    |_ Dockerfile <span class="comment"># Docker 构建文件</span></span><br><span class="line">    |_ entrypoint.sh <span class="comment"># Docker 容器启动脚本</span></span><br><span class="line">  |_ ...</span><br><span class="line">  |_ pom.xml <span class="comment"># Maven 构建文件</span></span><br></pre></td></tr></table></figure>

<h2 id="设置-Git-代码仓库"><a href="#设置-Git-代码仓库" class="headerlink" title="设置 Git 代码仓库"></a>设置 Git 代码仓库</h2><p>由于笔者的项目主要托管在 Github，使用<code>关联代码仓库</code>完成构建。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-relate-code-repo.png"> </p>
<h2 id="选择-Image-构建工具"><a href="#选择-Image-构建工具" class="headerlink" title="选择 Image 构建工具"></a>选择 Image 构建工具</h2><blockquote>
<p>目前 Java 构建镜像的主流方式有两种：</p>
<ol>
<li>使用 Google 的 <code>jib-maven-plugin</code> 插件，这种方式简单轻便，不需要在 Docker 环境下运行。</li>
<li>编写 Dockerfile 文件：自由度较高，结合 <code>spring-boot-maven-plugin</code> 插件配置分层。</li>
</ol>
</blockquote>
<h3 id="Google-Jib-插件构建"><a href="#Google-Jib-插件构建" class="headerlink" title="Google Jib 插件构建"></a>Google Jib 插件构建</h3><p>在子模块 <code>eden-demo-cola-start</code> 中引入 <code>jib-maven-plugin</code> 插件。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">		 <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">		 <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.shiyindaxiaojie.eden.demo<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eden-demo-cola<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>eden-demo-cola-start<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>eden-demo-cola-start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>启动入口<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">start-class</span>&gt;</span>org.ylzl.eden.demo.ColaApplication<span class="tag">&lt;/<span class="name">start-class</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">maven.deploy.skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">maven.deploy.skip</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">build.layers.enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">build.layers.enabled</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.name&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.cloud.tools<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jib-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">from</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">image</span>&gt;</span>openjdk:11-jdk-slim<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">to</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">image</span>&gt;</span>$&#123;docker.image&#125;<span class="tag">&lt;/<span class="name">image</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">auth</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">username</span>&gt;</span>$&#123;docker.username&#125;<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;docker.password&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">auth</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">tags</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">tag</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">tag</span>&gt;</span>latest<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">tags</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">container</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">entrypoint</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">shell</span>&gt;</span>bash<span class="tag">&lt;/<span class="name">shell</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">option</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">arg</span>&gt;</span>/entrypoint.sh<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">entrypoint</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">ports</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">port</span>&gt;</span>8080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">port</span>&gt;</span>9080<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">ports</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">environment</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">TZ</span>&gt;</span>Asia/Shanghai<span class="tag">&lt;/<span class="name">TZ</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">LANG</span>&gt;</span>C.UTF-8<span class="tag">&lt;/<span class="name">LANG</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">JVM_XMS</span>&gt;</span>1g<span class="tag">&lt;/<span class="name">JVM_XMS</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">JVM_XMX</span>&gt;</span>1g<span class="tag">&lt;/<span class="name">JVM_XMX</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">JVM_XSS</span>&gt;</span>256k<span class="tag">&lt;/<span class="name">JVM_XSS</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">GC_MODE</span>&gt;</span>G1<span class="tag">&lt;/<span class="name">GC_MODE</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">USE_GC_LOG</span>&gt;</span>Y<span class="tag">&lt;/<span class="name">USE_GC_LOG</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">USE_HEAP_DUMP</span>&gt;</span>Y<span class="tag">&lt;/<span class="name">USE_HEAP_DUMP</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">USE_LARGE_PAGES</span>&gt;</span>N<span class="tag">&lt;/<span class="name">USE_LARGE_PAGES</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">SPRING_PROFILES_ACTIVE</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">SPRING_PROFILES_ACTIVE</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">creationTime</span>&gt;</span>USE_CURRENT_TIMESTAMP<span class="tag">&lt;/<span class="name">creationTime</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>$&#123;start-class&#125;<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">container</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">extraDirectories</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">paths</span>&gt;</span>src/main/docker/jib<span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;<span class="name">permission</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">file</span>&gt;</span>/entrypoint.sh<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">								<span class="tag">&lt;<span class="name">mode</span>&gt;</span>755<span class="tag">&lt;/<span class="name">mode</span>&gt;</span></span><br><span class="line">							<span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">extraDirectories</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">allowInsecureRegistries</span>&gt;</span>true<span class="tag">&lt;/<span class="name">allowInsecureRegistries</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 Maven 构建并发布镜像，代码片段如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn -pl eden-demo-cola-start jib:build -Dimage=shiyindaxiaojie/eden-demo-cola -Djib.disableUpdateChecks=<span class="literal">true</span> -DskipTests -U -T 4C</span><br></pre></td></tr></table></figure>

<h3 id="Dockerfile-分层构建"><a href="#Dockerfile-分层构建" class="headerlink" title="Dockerfile 分层构建"></a>Dockerfile 分层构建</h3><p>如果您不希望引入 Google 第三方插件，也可以参考 <code>docker</code> 目录的 Dockerfile 文件，代码实现了镜像的分层，可以放心使用。</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> m.daocloud.io/openjdk:<span class="number">11</span>-jdk-slim AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定构建模块</span></span><br><span class="line"><span class="keyword">ARG</span> MODULE=eden-demo-cola-start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制必要文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> <span class="variable">$MODULE</span>/target/<span class="variable">$MODULE</span>.jar application.jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker/entrypoint.sh entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Spring Boot 的分层模式提取 JAR 文件的依赖项</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> java -Djarmode=layertools -jar application.jar extract</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建容器镜像</span></span><br><span class="line"><span class="keyword">FROM</span> m.daocloud.io/openjdk:<span class="number">11</span>-jdk-slim</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义元数据</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;梦想歌 &lt;shiyindaxiaojie@gmail.com&gt;&quot;</span></span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> version=<span class="string">&quot;1.0.0&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定构建参数</span></span><br><span class="line"><span class="keyword">ARG</span> <span class="keyword">USER</span>=tmpuser</span><br><span class="line"><span class="keyword">ARG</span> GROUP=tmpgroup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> HOME=<span class="string">&quot;/app&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=<span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> LANG=<span class="string">&quot;C.UTF-8&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XMS=<span class="string">&quot;1g&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XMX=<span class="string">&quot;1g&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> XSS=<span class="string">&quot;256k&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> GC_MODE=<span class="string">&quot;G1&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_GC_LOG=<span class="string">&quot;Y&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_HEAP_DUMP=<span class="string">&quot;Y&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> USE_LARGE_PAGES=<span class="string">&quot;N&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> SPRING_PROFILES_ACTIVE=<span class="string">&quot;dev&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> SERVER_PORT=<span class="string">&quot;8080&quot;</span></span><br><span class="line"><span class="keyword">ENV</span> MANAGEMENT_SERVER_PORT=<span class="string">&quot;9080&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建日志目录</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/logs \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">touch</span> <span class="variable">$HOME</span>/logs/entrypoint.out \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">ln</span> -sf /dev/stdout <span class="variable">$HOME</span>/logs/entrypoint.out \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">ln</span> -sf /dev/stderr <span class="variable">$HOME</span>/logs/entrypoint.out</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> <span class="variable">$HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从基础镜像复制应用程序依赖项和模块</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/dependencies/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/spring-boot-loader ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/organization-dependencies ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/modules-dependencies ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/snapshot-dependencies/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/application/ ./</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /app/entrypoint.sh ./</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建普通用户</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> groupadd -g 1000 <span class="variable">$GROUP</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; useradd -u 1000 -g <span class="variable">$GROUP</span> -d <span class="variable">$HOME</span> -s /bin/bash <span class="variable">$USER</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">chown</span> -R <span class="variable">$USER</span>:<span class="variable">$GROUP</span> <span class="variable">$HOME</span> \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">chmod</span> -R a+rwX <span class="variable">$HOME</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到容器用户</span></span><br><span class="line"><span class="keyword">USER</span> $<span class="keyword">USER</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露访问端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> $SERVER_PORT $MANAGEMENT_SERVER_PORT</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置启动入口</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;./entrypoint.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>在根目录执行 Docker 指令完成构建。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -f docker/Dockerfile -t shiyindaxiaojie/eden-demo-cola .</span><br><span class="line">docker push shiyindaxiaojie/eden-demo-cola</span><br></pre></td></tr></table></figure>

<h2 id="自定义-Maven-配置文件"><a href="#自定义-Maven-配置文件" class="headerlink" title="自定义 Maven 配置文件"></a>自定义 Maven 配置文件</h2><p>由于笔者直接使用 CODING 节点托管部署，无法了解服务器内部的 Maven 细节，并且，Maven 的环境变动可能会影响整个构建计划不可用，因此，建议自定义 <code>settings.xml</code> 来控制您的应用。</p>
<p>首先，使用 <code>-s</code> 选项指定项目 <code>.coding</code> 目录的 <code>settings.xml</code> 文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn package -DskipTests -T 4C -s ./.coding/settings.xml</span><br></pre></td></tr></table></figure>

<p>Maven 配置文件的内容统一使用 <code>$&#123;env.xxx&#125;</code> 变量，表示通过 CODING 的脚本传递环境变量，代码片段如下。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">servers</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">id</span>&gt;</span>coding<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">username</span>&gt;</span>$&#123;env.MAVEN_USERNAME&#125;<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">password</span>&gt;</span>$&#123;env.MAVEN_PASSWORD&#125;<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">servers</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">id</span>&gt;</span>coding<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">docker.username</span>&gt;</span>$&#123;env.DOCKER_USERNAME&#125;<span class="tag">&lt;/<span class="name">docker.username</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">docker.password</span>&gt;</span>$&#123;env.DOCKER_PASSWORD&#125;<span class="tag">&lt;/<span class="name">docker.password</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">docker.image</span>&gt;</span>$&#123;env.DOCKER_IMAGE&#125;<span class="tag">&lt;/<span class="name">docker.image</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">altReleaseDeploymentRepository</span>&gt;</span></span><br><span class="line">					coding::default::$&#123;env.MAVEN_REPO_URL&#125;</span><br><span class="line">				<span class="tag">&lt;/<span class="name">altReleaseDeploymentRepository</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">altSnapshotDeploymentRepository</span>&gt;</span></span><br><span class="line">					coding::default::$&#123;env.MAVEN_REPO_URL&#125;</span><br><span class="line">				<span class="tag">&lt;/<span class="name">altSnapshotDeploymentRepository</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">id</span>&gt;</span>coding<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">url</span>&gt;</span>$&#123;env.MAVEN_REPO_URL&#125;<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">id</span>&gt;</span>coding<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">url</span>&gt;</span>$&#123;env.MAVEN_REPO_URL&#125;<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">releases</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">releases</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">						<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">activeProfile</span>&gt;</span>coding<span class="tag">&lt;/<span class="name">activeProfile</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">activeProfiles</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>对应的 CODING 流水线传递相关变量到 <code>settings.xml</code>。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;推送到 Maven 制品库&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    withCredentials([</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">      ),</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    ]) &#123;</span><br><span class="line">      withEnv([</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">      ]) &#123;</span><br><span class="line">        sh <span class="string">&#x27;mvn -T 4C -Pcoding deploy -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="设置-Docker-和-Maven-凭据"><a href="#设置-Docker-和-Maven-凭据" class="headerlink" title="设置 Docker 和 Maven 凭据"></a>设置 Docker 和 Maven 凭据</h2><p>使用项目凭据来替换 CODING 脚本所需的 Docker&#x2F;Maven 账户信息，减少维护凭据的工作，允许多个构建计划复用同一个凭据。同时防止构建计划泄露账户信息，特别是多人协作部署。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-set-credential.png"></p>
<p>录入凭据后，在构建计划的 <code>变量与缓存</code> 选择相关凭据。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-select-credential.png"></p>
<h2 id="编排-Jenkinsfile-脚本"><a href="#编排-Jenkinsfile-脚本" class="headerlink" title="编排 Jenkinsfile 脚本"></a>编排 Jenkinsfile 脚本</h2><blockquote>
<p>由于 CODING 目前没有实现 Jenkinsfile 脚本的版本控制，为防止误删配置导致整个构建计划不可用，笔者的做法是把 Jenkinsfile 脚本保存到工程 <code>.coding</code> 目录下，使用 <code>Git</code> 完成版本控制。</p>
</blockquote>
<p>在 <code>.coding</code> 目录提供了开箱即用的 Jenkinsfile，包含编译打包、单元测试、发布私服、推送镜像等步骤，完整代码如下。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent any</span><br><span class="line">	environment &#123;</span><br><span class="line">	  MAVEN_SNAPSHOTS_NAME = <span class="string">&quot;maven-snapshots&quot;</span></span><br><span class="line">		MAVEN_SNAPSHOTS_ID = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-$&#123;PROJECT_NAME&#125;-$&#123;MAVEN_SNAPSHOTS_NAME&#125;&quot;</span></span><br><span class="line">    MAVEN_SNAPSHOTS_URL = <span class="string">&quot;$&#123;CCI_CURRENT_WEB_PROTOCOL&#125;://$&#123;CCI_CURRENT_TEAM&#125;-maven.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;/repository/$&#123;PROJECT_NAME&#125;/$&#123;MAVEN_SNAPSHOTS_NAME&#125;/&quot;</span></span><br><span class="line"></span><br><span class="line">	  MAVEN_RELEASES_NAME = <span class="string">&quot;maven-releases&quot;</span></span><br><span class="line">		MAVEN_RELEASES_ID = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-$&#123;PROJECT_NAME&#125;-$&#123;MAVEN_RELEASES_NAME&#125;&quot;</span></span><br><span class="line">    MAVEN_RELEASES_URL = <span class="string">&quot;$&#123;CCI_CURRENT_WEB_PROTOCOL&#125;://$&#123;CCI_CURRENT_TEAM&#125;-maven.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;/repository/$&#123;PROJECT_NAME&#125;/$&#123;MAVEN_RELEASES_NAME&#125;/&quot;</span></span><br><span class="line"></span><br><span class="line">	  MAVEN_SNAPSHOTS_NAME = <span class="string">&quot;maven-snapshots&quot;</span></span><br><span class="line">	  MAVEN_RELEASES_NAME = <span class="string">&quot;maven-releases&quot;</span></span><br><span class="line">	  DOCKER_REPOSITORY_NAME = <span class="string">&quot;docker&quot;</span></span><br><span class="line"></span><br><span class="line">		MAVEN_SNAPSHOTS_ID = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-$&#123;PROJECT_NAME&#125;-$&#123;MAVEN_SNAPSHOTS_NAME&#125;&quot;</span></span><br><span class="line">		MAVEN_SNAPSHOTS_URL = <span class="string">&quot;$&#123;CCI_CURRENT_WEB_PROTOCOL&#125;://$&#123;CCI_CURRENT_TEAM&#125;-maven.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;/repository/$&#123;PROJECT_NAME&#125;/$&#123;MAVEN_SNAPSHOTS_NAME&#125;/&quot;</span></span><br><span class="line">		MAVEN_RELEASES_ID = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-$&#123;PROJECT_NAME&#125;-$&#123;MAVEN_RELEASES_NAME&#125;&quot;</span></span><br><span class="line">		MAVEN_RELEASES_URL = <span class="string">&quot;$&#123;CCI_CURRENT_WEB_PROTOCOL&#125;://$&#123;CCI_CURRENT_TEAM&#125;-maven.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;/repository/$&#123;PROJECT_NAME&#125;/$&#123;MAVEN_RELEASES_NAME&#125;/&quot;</span></span><br><span class="line">	  DOCKER_REPOSITORY = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-docker.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;/$&#123;PROJECT_NAME&#125;/$&#123;DOCKER_REPOSITORY_NAME&#125;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  stages &#123;</span><br><span class="line">    stage(<span class="string">&#x27;检出&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>,</span><br><span class="line">        <span class="symbol">branches:</span> [[<span class="attr">name:</span> GIT_BUILD_REF]],</span><br><span class="line">        <span class="symbol">userRemoteConfigs:</span> [[</span><br><span class="line">          <span class="symbol">url:</span> GIT_REPO_URL,</span><br><span class="line">          <span class="symbol">credentialsId:</span> CREDENTIALS_ID</span><br><span class="line">        ]]])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;编译&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        script &#123;</span><br><span class="line">          <span class="keyword">if</span> (env.TAG_NAME ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">	          ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.TAG_NAME&#125;&quot;</span></span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (env.MR_SOURCE_BRANCH ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">	          ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.MR_RESOURCE_ID&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	          ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.BRANCH_NAME.replace(&#x27;/&#x27;, &#x27;-&#x27;)&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        withCredentials([</span><br><span class="line">            usernamePassword(</span><br><span class="line">                <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">                <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">                <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">            ),</span><br><span class="line">            usernamePassword(</span><br><span class="line">                <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">                <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">                <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">            )</span><br><span class="line">        ]) &#123;</span><br><span class="line">            withEnv([</span><br><span class="line">                <span class="string">&quot;ARTIFACT_VERSION=$&#123;ARTIFACT_VERSION&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">            ]) &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -T 4C -U -Pcoding versions:set -DnewVersion=$&#123;ARTIFACT_VERSION&#125; package -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;单元测试&#x27;</span>) &#123;</span><br><span class="line">        steps &#123;</span><br><span class="line">            withCredentials([</span><br><span class="line">                usernamePassword(</span><br><span class="line">                    <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">                    <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">                    <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">                ),</span><br><span class="line">                usernamePassword(</span><br><span class="line">                    <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">                    <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">                    <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">                )</span><br><span class="line">            ]) &#123;</span><br><span class="line">                withEnv([</span><br><span class="line">                    <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">                ]) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;mvn -T 4C -Pcoding,unit-test test -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        post &#123;</span><br><span class="line">            always &#123;</span><br><span class="line">                junit <span class="string">&#x27;**/surefire-reports/*.xml&#x27;</span></span><br><span class="line">                codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-adapter-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-adapter/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">                codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-app-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-app/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">                codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-infrastructure-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-infrastructure/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;推送到 Maven 制品库&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        withCredentials([</span><br><span class="line">            usernamePassword(</span><br><span class="line">                <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">                <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">                <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">            ),</span><br><span class="line">            usernamePassword(</span><br><span class="line">                <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">                <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">                <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">            )</span><br><span class="line">        ]) &#123;</span><br><span class="line">            withEnv([</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">            ]) &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn -T 4C -Pcoding deploy -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;推送到 Docker 制品库&#x27;</span>) &#123;</span><br><span class="line">        steps &#123;</span><br><span class="line">            withCredentials([</span><br><span class="line">                usernamePassword(</span><br><span class="line">                    <span class="symbol">credentialsId:</span> env.DOCKER_REGISTRY_CREDENTIALS_ID,</span><br><span class="line">                    <span class="symbol">usernameVariable:</span> <span class="string">&#x27;DOCKER_USERNAME&#x27;</span>,</span><br><span class="line">                    <span class="symbol">passwordVariable:</span> <span class="string">&#x27;DOCKER_PASSWORD&#x27;</span></span><br><span class="line">                )</span><br><span class="line">            ]) &#123;</span><br><span class="line">                withEnv([</span><br><span class="line">                    <span class="string">&quot;DOCKER_USERNAME=$&#123;DOCKER_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DOCKER_PASSWORD=$&#123;DOCKER_PASSWORD&#125;&quot;</span></span><br><span class="line">            ]) &#123;</span><br><span class="line">                sh <span class="string">&quot;docker login $&#123;DOCKER_REPOSITORY&#125; -u $&#123;DOCKER_USERNAME&#125; -p $&#123;DOCKER_PASSWORD&#125;&quot;</span></span><br><span class="line">                sh <span class="string">&quot;docker build -t $&#123;DOCKER_REPOSITORY&#125;/$&#123;DEPOT_NAME&#125;:$&#123;ARTIFACT_VERSION&#125; -f docker/Dockerfile .&quot;</span></span><br><span class="line">                sh <span class="string">&quot;docker push $&#123;DOCKER_REPOSITORY&#125;/$&#123;DEPOT_NAME&#125;:$&#123;ARTIFACT_VERSION&#125;&quot;</span></span><br><span class="line">                sh <span class="string">&quot;docker push $&#123;DOCKER_REPOSITORY&#125;/$&#123;DEPOT_NAME&#125;:latest&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您不熟悉 Jenkinsfile 的语法，可以复制上述代码，切换到 CODING 图形化视角，进入可视化模式调整。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-edit-visualization.png"></p>
<p>编辑好 Jenkinsfile 文件后保存，点击 <code>立即构建</code>，触发流水线即可。接下来，笔者根据 Jenkinsfile 内容中的关键代码块进行讲解。</p>
<h3 id="自定义检出-Git-代码"><a href="#自定义检出-Git-代码" class="headerlink" title="自定义检出 Git 代码"></a>自定义检出 Git 代码</h3><p>正常情况下，我们是一对一检出 Git 仓库。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;检出&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>,</span><br><span class="line">    <span class="symbol">branches:</span> [[<span class="attr">name:</span> GIT_BUILD_REF]],</span><br><span class="line">    <span class="symbol">userRemoteConfigs:</span> [[</span><br><span class="line">      <span class="symbol">url:</span> GIT_REPO_URL,</span><br><span class="line">      <span class="symbol">credentialsId:</span> CREDENTIALS_ID</span><br><span class="line">    ]]])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有些特殊场景，需要同时检出多个 Git 仓库，详见下述代码片段。不过，这样做会导致您无法有效控制 Git 自动触发。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;检出&#x27;</span>) &#123;</span><br><span class="line">  parallel &#123; <span class="comment">// 开启并行构建</span></span><br><span class="line">    stage(<span class="string">&#x27;检出 eden-gateway&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        dir(<span class="string">&#x27;eden-gateway&#x27;</span>) &#123;</span><br><span class="line">          checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>,</span><br><span class="line">          <span class="symbol">branches:</span> [[<span class="attr">name:</span> env.EDEN_GATEWAY_VERSION]],</span><br><span class="line">          <span class="symbol">userRemoteConfigs:</span> [[</span><br><span class="line">            <span class="symbol">url:</span> env.EDEN_GATEWAY_GIT_URL,</span><br><span class="line">            <span class="symbol">credentialsId:</span> CREDENTIALS_ID</span><br><span class="line">          ]]])</span><br><span class="line">          script &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">&#x27;检出 eden-uaa&#x27;</span>) &#123;</span><br><span class="line">      steps &#123;</span><br><span class="line">        dir(<span class="string">&#x27;eden-uaa&#x27;</span>) &#123;</span><br><span class="line">          checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>,</span><br><span class="line">          <span class="symbol">branches:</span> [[<span class="attr">name:</span> env.EDEN_UAA_VERSION]],</span><br><span class="line">          <span class="symbol">userRemoteConfigs:</span> [[</span><br><span class="line">            <span class="symbol">url:</span> env.EDEN_UAA_GIT_URL,</span><br><span class="line">            <span class="symbol">credentialsId:</span> CREDENTIALS_ID</span><br><span class="line">          ]]])</span><br><span class="line">          script &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;                                                                 </span><br></pre></td></tr></table></figure>

<h3 id="设置-Maven-魔法版本号"><a href="#设置-Maven-魔法版本号" class="headerlink" title="设置 Maven 魔法版本号"></a>设置 Maven 魔法版本号</h3><p>CODING 内置了一系列丰富的环境变量，您可以通过 <code>$&#123;env.TAG_NAME&#125;</code> 或者 <code>$&#123;env.BRANCH_NAME&#125;</code> 获取 Git 的版本号，使用 <code>versions-maven-plugin</code> 执行 <code>mvn versions:set -DnewVersion=$&#123;VERSION&#125;</code> 动态设置 Maven 模块的版本号。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;编译&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    script &#123;</span><br><span class="line">      <span class="keyword">if</span> (env.TAG_NAME ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">        ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.TAG_NAME&#125;&quot;</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (env.MR_SOURCE_BRANCH ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">        ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.MR_RESOURCE_ID&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.BRANCH_NAME.replace(&#x27;/&#x27;, &#x27;-&#x27;)&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    withCredentials([</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">      ),</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    ]) &#123;</span><br><span class="line">      withEnv([</span><br><span class="line">        <span class="string">&quot;ARTIFACT_VERSION=$&#123;ARTIFACT_VERSION&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">      ]) &#123;</span><br><span class="line">        sh <span class="string">&#x27;mvn -T 4C -U -Pcoding versions:set -DnewVersion=$&#123;ARTIFACT_VERSION&#125; package -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Java-测试报告可视化"><a href="#Java-测试报告可视化" class="headerlink" title="Java 测试报告可视化"></a>Java 测试报告可视化</h3><p>CODING 提供了测试报告的可视化支持，下述代码片段提供了<strong>单元测试</strong>和<strong>代码覆盖率分析</strong>的配置示例。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;单元测试&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    withCredentials([</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">      ),</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    ]) &#123;</span><br><span class="line">      withEnv([</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">      ]) &#123;</span><br><span class="line">        sh <span class="string">&#x27;mvn -T 4C -Pcoding,unit-test test -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  post &#123;</span><br><span class="line">    always &#123;</span><br><span class="line">      junit <span class="string">&#x27;**/surefire-reports/*.xml&#x27;</span> <span class="comment">// 单元测试报告</span></span><br><span class="line">      codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-adapter-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-adapter/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">      codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-app-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-app/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">      codingHtmlReport(<span class="attr">name:</span> <span class="string">&#x27;eden-demo-cola-infrastructure-jacoco-reports&#x27;</span>, <span class="attr">tag:</span> <span class="string">&#x27;代码覆盖率报告&#x27;</span>, <span class="attr">path:</span> <span class="string">&#x27;eden-demo-cola-infrastructure/target/site/jacoco&#x27;</span>, <span class="attr">entryFile:</span> <span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在构建记录中，点击 <code>测试报告</code> 页签，查看单元测试报告。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-unit-test-report.png"> </p>
<p>从 <code>通用报告</code> 查看代码覆盖率报告。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-code-coverage-report.png"> </p>
<h3 id="发布制品到-Maven-仓库"><a href="#发布制品到-Maven-仓库" class="headerlink" title="发布制品到 Maven 仓库"></a>发布制品到 Maven 仓库</h3><p>多人协同下，需要把构建生成的 API 依赖发布到私服（制品库）。在此之前我们已经配置好了 Maven 私服地址和相关凭据，具体可以参考下面的代码片段。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;推送到 Maven 制品库&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    withCredentials([</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_RELEASES,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_RELEASES_PASSWORD&#x27;</span></span><br><span class="line">      ),</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.MAVEN_SNAPSHOTS,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;MAVEN_SNAPSHOTS_PASSWORD&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    ]) &#123;</span><br><span class="line">      withEnv([</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_ID=$&#123;MAVEN_RELEASES_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_URL=$&#123;MAVEN_RELEASES_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_USERNAME=$&#123;MAVEN_RELEASES_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_RELEASES_PASSWORD=$&#123;MAVEN_RELEASES_PASSWORD&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_ID=$&#123;MAVEN_SNAPSHOTS_ID&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_URL=$&#123;MAVEN_SNAPSHOTS_URL&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_USERNAME=$&#123;MAVEN_SNAPSHOTS_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;MAVEN_SNAPSHOTS_PASSWORD=$&#123;MAVEN_SNAPSHOTS_PASSWORD&#125;&quot;</span></span><br><span class="line">      ]) &#123;</span><br><span class="line">        sh <span class="string">&#x27;mvn -T 4C -Pcoding deploy -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Maven 私服应当严格区分 <code>Releases</code> 和 <code>Snapshots</code> 仓库。</p>
<p>在开发测试阶段，需要利用 Maven 的快照更新维持 API 的变动，使用 <code>Snapshots</code> 仓库比较合适。</p>
<p>在预发布阶段，表示测试已通过，可以发布生产了，API 不允许有变动，应当严格使用 <code>Releases</code> 仓库来限制版本的发布，避免相同版本的 API 被覆盖。</p>
<p>在 CODING 制品库，您可以在 <code>Releases</code> 仓库设置版本策略为禁止覆盖版本。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-repo-deny-same-verison.png"> </p>
<h3 id="推送镜像到-Docker-仓库"><a href="#推送镜像到-Docker-仓库" class="headerlink" title="推送镜像到 Docker 仓库"></a>推送镜像到 Docker 仓库</h3><p>本文中，笔者使用 Docker Hub 托管镜像，代码中的变量，在设置凭据的小节已详细说明，您可以根据实际情况进行调整。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;推送到 Docker 制品库&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    withCredentials([</span><br><span class="line">      usernamePassword(</span><br><span class="line">        <span class="symbol">credentialsId:</span> env.DOCKER_CREDENTIALS,</span><br><span class="line">        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;DOCKER_USERNAME&#x27;</span>,</span><br><span class="line">        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;DOCKER_PASSWORD&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    ]) &#123;</span><br><span class="line">      withEnv([</span><br><span class="line">        <span class="string">&quot;DOCKER_USERNAME=$&#123;DOCKER_USERNAME&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DOCKER_PASSWORD=$&#123;DOCKER_PASSWORD&#125;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;DOCKER_IMAGE=$&#123;DOCKER_REPOSITORY&#125;:$&#123;ARTIFACT_VERSION&#125;&quot;</span></span><br><span class="line">      ]) &#123;</span><br><span class="line">        sh <span class="string">&#x27;mvn -Pcoding -pl eden-demo-cola-start jib:build -Djib.disableUpdateChecks=true -DskipTests -s ./.coding/settings.xml&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行上述代码后，在 DockerHub 查看镜像已更新，验证通过。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-upload-image-successed.png"> </p>
<h3 id="更新镜像到-K8s-集群"><a href="#更新镜像到-K8s-集群" class="headerlink" title="更新镜像到 K8s 集群"></a>更新镜像到 K8s 集群</h3><p>CODING 支持配置镜像更新到 K8s 已部署的工作负载。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">&#x27;部署到 K8s 集群&#x27;</span>) &#123;</span><br><span class="line">  steps &#123;</span><br><span class="line">    withEnv([<span class="string">&quot;DOCKER_IMAGE=$&#123;DOCKER_REPOSITORY&#125;:$&#123;ARTIFACT_VERSION&#125;&quot;</span>]) &#123;</span><br><span class="line">      cdDeploy(<span class="attr">deployType:</span> <span class="string">&#x27;PATCH_IMAGE&#x27;</span>, <span class="attr">application:</span> <span class="string">&#x27;$&#123;CCI_CURRENT_TEAM&#125;&#x27;</span>, <span class="attr">pipelineName:</span> <span class="string">&#x27;$&#123;PROJECT_NAME&#125;-$&#123;CCI_JOB_NAME&#125;-5001969&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;$&#123;DOCKER_IMAGE&#125;&#x27;</span>, <span class="attr">cloudAccountName:</span> <span class="string">&#x27;test&#x27;</span>, <span class="attr">namespace:</span> <span class="string">&#x27;test&#x27;</span>, <span class="attr">manifestType:</span> <span class="string">&#x27;Deployment&#x27;</span>, <span class="attr">manifestName:</span> <span class="string">&#x27;demo-cola&#x27;</span>, <span class="attr">containerName:</span> <span class="string">&#x27;demo-cola&#x27;</span>, <span class="attr">credentialId:</span> <span class="string">&#x27;a2954a785e1d40caa1803274a23edac9&#x27;</span>, <span class="attr">personalAccessToken:</span> <span class="string">&#x27;$&#123;CD_PERSONAL_ACCESS_TOKEN&#125;&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 CODING 的 <code>持续部署</code> &gt; <code>弹性伸缩</code> &gt; <code>配置云账号</code> 添加 K8s 凭据，绑定需要部署的 K8s 集群。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-bind-kubernetes-cluster.png"> </p>
<p>在 CODING 构建计划编排界面配置 <code>镜像更新</code>，选择上述已绑定的 K8s 集群，根据级联选择到具体的 Pod 容器。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-select-kubernetes-cluster.png"> </p>
<p>点击构建，查看镜像更新执行记录。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-deploy-kubernetes-log.png"> </p>
<p>除了控制台输出，也可以点击查看 K8s 发布详情。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-deploy-kubernetes-detail.png"> </p>
<p>查看 K8s 集群（笔者使用腾讯云 Serveless 集群部署），启动成功！</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-deploy-kubernetes-app-log.png"> </p>
<p>访问控制台输出的 External Access URL 地址，系统访问正常。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-deploy-kubernetes-app-ui.png"> </p>
<h3 id="前端项目怎么构建？"><a href="#前端项目怎么构建？" class="headerlink" title="前端项目怎么构建？"></a>前端项目怎么构建？</h3><p>以开源的若依项目（Vue）为例，在代码目录下分别创建以下目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">eden-ui</span><br><span class="line">  |_ .coding/</span><br><span class="line">    |_ Jenkinsfile <span class="comment"># CODING 流水线脚本</span></span><br><span class="line">    |_ nginx.conf <span class="comment"># Nginx 配置文件</span></span><br><span class="line">  |_ docker/</span><br><span class="line">    |_ Dockerfile <span class="comment"># Docker 构建文件</span></span><br><span class="line">  |_ ...</span><br><span class="line">  |_ .npmrc</span><br></pre></td></tr></table></figure>

<p>初始化 <code>.npmrc</code>，代理 npm 源，指向 CODING 制品库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">registry=https://xxx-npm.pkg.coding.net/xxx/npm/</span><br><span class="line">always-auth=<span class="literal">true</span></span><br><span class="line">//xxx-npm.pkg.coding.net/xxx/npm/:username=<span class="variable">$&#123;CODING_ARTIFACTS_USERNAME&#125;</span></span><br><span class="line">//xxx-npm.pkg.coding.net/xxx/npm/:_password=<span class="variable">$&#123;CODING_ARTIFACTS_PASSWORD&#125;</span></span><br><span class="line">//xxx-npm.pkg.coding.net/xxx/npm/:email=xxx@gmail.com</span><br></pre></td></tr></table></figure>

<p>为了让前端单独运行，需要依赖 Nginx 的镜像进行部署，所以，我们要把 nginx 的配置也加上，<code>nginx.conf</code> 配置如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">error_log  logs/error.log warn;</span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  logs/access.log  main;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    client_max_body_size   500m;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        charset utf-8;</span><br><span class="line"></span><br><span class="line">        gzip_static on;</span><br><span class="line">        gzip_vary on;</span><br><span class="line">        gzip_min_length 1k;</span><br><span class="line">        gzip_comp_level 9;</span><br><span class="line">        gzip_types text/css text/javascript application/javascript application/x-javascript application/xml;</span><br><span class="line">        gzip_disable <span class="string">&quot;MSIE [1-6]\.&quot;</span>;</span><br><span class="line"></span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   /usr/share/nginx/html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123; <span class="comment"># 前端</span></span><br><span class="line">            root   /usr/share/nginx/html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location ^~ /api/  &#123; <span class="comment"># 后端</span></span><br><span class="line">            proxy_pass http://xxx:8080/; </span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调整 Dockerfile 打包脚本，指定 Vue 项目打包后的静态资源到 Nginx 的静态资源目录中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx:1.15.2-alpine</span><br><span class="line"></span><br><span class="line">LABEL maintainer=<span class="string">&quot;梦想歌&quot;</span></span><br><span class="line"></span><br><span class="line">COPY dist/ /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">COPY .coding/nginx.conf /etc/nginx/conf.d/default.conf</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br></pre></td></tr></table></figure>

<p>编写 Jenkinsfile 构建脚本，参考如下内容。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment &#123;</span><br><span class="line">        CODING_DOCKER_REPO_NAME = <span class="string">&quot;docker&quot;</span></span><br><span class="line">        CODING_DOCKER_REPO_HOST = <span class="string">&quot;$&#123;CCI_CURRENT_TEAM&#125;-docker.pkg.$&#123;CCI_CURRENT_DOMAIN&#125;&quot;</span></span><br><span class="line">        CODING_DOCKER_REPO_URL = <span class="string">&quot;$&#123;CODING_DOCKER_REPO_HOST&#125;/$&#123;PROJECT_NAME&#125;/$&#123;CODING_DOCKER_REPO_NAME&#125;/$&#123;DEPOT_NAME&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">        TCR_NAMESPACE_NAME = <span class="string">&quot;xxx&quot;</span></span><br><span class="line">        TCR_DOCKER_REPO_URL = <span class="string">&quot;shjrccr.ccs.tencentyun.com/$&#123;TCR_NAMESPACE_NAME&#125;/$&#123;DEPOT_NAME&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;检出&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="attr">$class:</span> <span class="string">&#x27;GitSCM&#x27;</span>,</span><br><span class="line">                <span class="symbol">branches:</span> [[<span class="attr">name:</span> GIT_BUILD_REF]],</span><br><span class="line">                <span class="symbol">userRemoteConfigs:</span> [[</span><br><span class="line">                <span class="symbol">url:</span> GIT_REPO_URL,</span><br><span class="line">                <span class="symbol">credentialsId:</span> CREDENTIALS_ID</span><br><span class="line">                ]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;编译&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    <span class="keyword">if</span> (env.TAG_NAME ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">                        CODING_ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.TAG_NAME&#125;&quot;</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (env.MR_SOURCE_BRANCH ==~ <span class="regexp">/.*/</span> ) &#123;</span><br><span class="line">                        CODING_ARTIFACT_VERSION = <span class="string">&quot;mr-$&#123;env.MR_RESOURCE_ID&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        CODING_ARTIFACT_VERSION = <span class="string">&quot;$&#123;env.BRANCH_NAME.replace(&#x27;/&#x27;, &#x27;-&#x27;)&#125;-$&#123;env.GIT_COMMIT_SHORT&#125;&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                sh <span class="string">&#x27;rm -rf /usr/lib/node_modules/npm/&#x27;</span></span><br><span class="line">                dir (<span class="string">&#x27;/root/.cache/downloads&#x27;</span>) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;wget -nc &quot;https://coding-public-generic.pkg.coding.net/public/downloads/node-linux-x64.tar.xz?version=v16.13.0&quot; -O node-v16.13.0-linux-x64.tar.xz | true&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;tar -xf node-v16.13.0-linux-x64.tar.xz -C /usr --strip-components 1&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">                withCredentials([</span><br><span class="line">                    usernamePassword(</span><br><span class="line">                        <span class="symbol">credentialsId:</span> env.CODING_ARTIFACTS_CREDENTIALS_ID,</span><br><span class="line">                        <span class="symbol">usernameVariable:</span> <span class="string">&#x27;CODING_ARTIFACTS_USERNAME&#x27;</span>,</span><br><span class="line">                        <span class="symbol">passwordVariable:</span> <span class="string">&#x27;CODING_ARTIFACTS_PASSWORD&#x27;</span></span><br><span class="line">                    )]) &#123;</span><br><span class="line">                    script &#123;</span><br><span class="line">                        sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                        echo &quot;CODING_ARTIFACTS_USERNAME=$&#123;CODING_ARTIFACTS_USERNAME&#125;&quot; &gt;&gt; $CI_ENV_FILE</span></span><br><span class="line"><span class="string">                        echo &quot;CODING_ARTIFACTS_PASSWORD=$&#123;CODING_ARTIFACTS_PASSWORD&#125;&quot; &gt;&gt; $CI_ENV_FILE</span></span><br><span class="line"><span class="string">                        &#x27;&#x27;&#x27;</span></span><br><span class="line">                        readProperties(<span class="attr">file:</span> env.CI_ENV_FILE).each &#123;</span><br><span class="line">                            key, value -&gt; env[key] = value </span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    sh <span class="string">&#x27;npm install&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;npm run build:prod&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;推送到 Docker 制品库&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                withEnv([</span><br><span class="line">                    <span class="string">&quot;DOCKER_USERNAME=$&#123;DOCKER_USERNAME&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;DOCKER_PASSWORD=$&#123;DOCKER_PASSWORD&#125;&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;DOCKER_IMAGE=$&#123;TCR_DOCKER_REPO_URL&#125;:$&#123;CODING_ARTIFACT_VERSION&#125;&quot;</span></span><br><span class="line">                ]) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;docker login --username=$&#123;DOCKER_USERNAME&#125; --password=$&#123;DOCKER_PASSWORD&#125; shjrccr.ccs.tencentyun.com&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;docker build -t $&#123;DOCKER_IMAGE&#125; .&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;docker tag $&#123;DOCKER_IMAGE&#125; $&#123;DOCKER_IMAGE&#125;&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;docker push $&#123;DOCKER_IMAGE&#125;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;部署到 K8s 集群&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                withEnv([<span class="string">&quot;DOCKER_IMAGE=$&#123;TCR_DOCKER_REPO_URL&#125;:$&#123;CODING_ARTIFACT_VERSION&#125;&quot;</span>]) &#123;</span><br><span class="line">                    cdDeploy(<span class="attr">deployType:</span> <span class="string">&#x27;PATCH_IMAGE&#x27;</span>, <span class="attr">application:</span> <span class="string">&#x27;$&#123;CCI_CURRENT_TEAM&#125;&#x27;</span>, <span class="attr">pipelineName:</span> <span class="string">&#x27;$&#123;PROJECT_NAME&#125;-$&#123;CCI_JOB_NAME&#125;-202222222&#x27;</span>, <span class="attr">image:</span> <span class="string">&#x27;$&#123;DOCKER_IMAGE&#125;&#x27;</span>, <span class="attr">cloudAccountName:</span> <span class="string">&#x27;xxx-k8s-test&#x27;</span>, <span class="attr">namespace:</span> <span class="string">&#x27;test&#x27;</span>, <span class="attr">manifestType:</span> <span class="string">&#x27;Deployment&#x27;</span>, <span class="attr">manifestName:</span> <span class="string">&#x27;xxx-client&#x27;</span>, <span class="attr">containerName:</span> <span class="string">&#x27;xxx-client&#x27;</span>, <span class="attr">credentialId:</span> <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>, <span class="attr">personalAccessToken:</span> <span class="string">&#x27;$&#123;CD_PERSONAL_ACCESS_TOKEN&#125;&#x27;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构建成功的效果图如下。</p>
<p><img src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/coding/coding-pipeline-deploy-vue-successed.png"> </p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在公司引入 CODING 后，研发团队和运维团队的工作都发生了很大的变化。研发团队负责 DevOps 的全生命周期管理，不再依赖运维团队，效率提升明显。而运维团队专注于基础设施，如云原生、网络、操作系统的优化，能更有效地处理线上故障。从整体的收益来看，至少节省了两个员工的成本。</p>
<p>CODING 流水线存在一些不足，只提供了单一镜像的更新功能，只能用于已部署的目标，并且不适合多服务批量部署，除非手动写脚本，基于 <code>kubectl apply</code> 实现。和腾讯方沟通后，他们告诉笔者，目前有个 <strong>Orbit 云原生应用交付</strong>正在内测，即将上线，可以开放白名单给我们尝试下。</p>
<p>下一期，笔者将介绍 CODING Orbit 云原生应用交付。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/shiyindaxiaojie">梦想歌</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://mengxiangge.netlify.app/2022/08/10/devops/CODING%20%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/">https://mengxiangge.netlify.app/2022/08/10/devops/CODING 持续部署实践/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://www.apache.org/licenses/LICENSE-2.0.html" target="_blank">Apache 2.0 License</a> 许可协议。转载请注明来自 <a href="https://mengxiangge.netlify.app" target="_blank">梦想歌の网络日志</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CODING/">CODING</a><a class="post-meta__tags" href="/tags/CI-CD/">CI/CD</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cover/CODING.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/hexo/wechat.jpg" target="_blank"><img class="post-qr-code-img" src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/hexo/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/hexo/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/hexo/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/08/16/devops/NGINX%20Ingress%20%E9%87%91%E4%B8%9D%E9%9B%80%E5%8F%91%E5%B8%83%E5%AE%9E%E8%B7%B5/" title="NGINX Ingress 金丝雀发布实践"><img class="cover" src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cover/APISIX.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/hexo/404.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">NGINX Ingress 金丝雀发布实践</div></div></a></div><div class="next-post pull-right"><a href="/2022/06/25/mysql/%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%20MySQL%EF%BC%9ABuffer%20Pool%20%E7%BC%93%E5%86%B2%E6%B1%A0/" title="深入浅出 MySQL：Buffer Pool 缓冲池"><img class="cover" src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cover/MySQL.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/hexo/404.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">深入浅出 MySQL：Buffer Pool 缓冲池</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2023/08/10/devops/CODING%20%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E5%AE%9E%E8%B7%B5/" title="CODING 云原生应用交付实践"><img class="cover" src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cover/CODING.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-10</div><div class="title">CODING 云原生应用交付实践</div></div></a></div><div><a href="/2025/01/03/devops/KubeVela%20%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E5%AE%9E%E8%B7%B5/" title="KubeVela 云原生应用交付实践"><img class="cover" src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cover/KubeVela.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-03</div><div class="title">KubeVela 云原生应用交付实践</div></div></a></div><div><a href="/2024/08/10/devops/KubeSphere%20%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E5%AE%9E%E8%B7%B5/" title="KubeSphere 持续集成实践"><img class="cover" src= "/loading..." data-lazy-src="/img/loading.gif" data-original="https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cover/KubeSphere.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-10</div><div class="title">KubeSphere 持续集成实践</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87"><span class="toc-number">2.</span> <span class="toc-text">目标</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">3.</span> <span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-Git-%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93"><span class="toc-number">3.1.</span> <span class="toc-text">设置 Git 代码仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%89%E6%8B%A9-Image-%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7"><span class="toc-number">3.2.</span> <span class="toc-text">选择 Image 构建工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Google-Jib-%E6%8F%92%E4%BB%B6%E6%9E%84%E5%BB%BA"><span class="toc-number">3.2.1.</span> <span class="toc-text">Google Jib 插件构建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dockerfile-%E5%88%86%E5%B1%82%E6%9E%84%E5%BB%BA"><span class="toc-number">3.2.2.</span> <span class="toc-text">Dockerfile 分层构建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-Maven-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">自定义 Maven 配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-Docker-%E5%92%8C-Maven-%E5%87%AD%E6%8D%AE"><span class="toc-number">3.4.</span> <span class="toc-text">设置 Docker 和 Maven 凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E6%8E%92-Jenkinsfile-%E8%84%9A%E6%9C%AC"><span class="toc-number">3.5.</span> <span class="toc-text">编排 Jenkinsfile 脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A3%80%E5%87%BA-Git-%E4%BB%A3%E7%A0%81"><span class="toc-number">3.5.1.</span> <span class="toc-text">自定义检出 Git 代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-Maven-%E9%AD%94%E6%B3%95%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-number">3.5.2.</span> <span class="toc-text">设置 Maven 魔法版本号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-%E6%B5%8B%E8%AF%95%E6%8A%A5%E5%91%8A%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-number">3.5.3.</span> <span class="toc-text">Java 测试报告可视化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E5%88%B6%E5%93%81%E5%88%B0-Maven-%E4%BB%93%E5%BA%93"><span class="toc-number">3.5.4.</span> <span class="toc-text">发布制品到 Maven 仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A8%E9%80%81%E9%95%9C%E5%83%8F%E5%88%B0-Docker-%E4%BB%93%E5%BA%93"><span class="toc-number">3.5.5.</span> <span class="toc-text">推送镜像到 Docker 仓库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E9%95%9C%E5%83%8F%E5%88%B0-K8s-%E9%9B%86%E7%BE%A4"><span class="toc-number">3.5.6.</span> <span class="toc-text">更新镜像到 K8s 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%80%8E%E4%B9%88%E6%9E%84%E5%BB%BA%EF%BC%9F"><span class="toc-number">3.5.7.</span> <span class="toc-text">前端项目怎么构建？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.jsdelivr.net/gh/shiyindaxiaojie/images/cover/CODING.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By 梦想歌</div><div class="footer_custom_text">下一次相逢会在何时，天空必将见证。</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div>
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(a){a.imageLazyLoadSetting.processImages=t;var i=a.imageLazyLoadSetting.isSPA,o=a.imageLazyLoadSetting.preloadRatio||1,r=c();function c(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){i&&(r=c());for(var t,e,n=0;n<r.length;n++)t=r[n],e=void 0,0<=(e=t.getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(a.innerHeight*o||document.documentElement.clientHeight*o)&&function(){var e=r[n];!function(t,e){if(t.hasAttribute("bg-lazy"))return t.removeAttribute("bg-lazy"),e&&e();var n=new Image,a=t.getAttribute("data-original");n.onload=function(){t.src=a,t.removeAttribute("data-original"),e&&e()},t.src!==a&&(n.src=a)}(e,function(){r=r.filter(function(t){return e!==t}),a.imageLazyLoadSetting.onImageLoaded&&a.imageLazyLoadSetting.onImageLoaded(e)})}()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),a.addEventListener("resize",e),a.addEventListener("orientationchange",e)}(this);</script></body></html>